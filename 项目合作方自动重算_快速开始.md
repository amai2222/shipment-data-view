# 项目合作方自动重算 - 快速开始

## 🚀 一分钟快速部署

### 1. 执行数据库迁移

```bash
# 方式1：使用 Supabase CLI（推荐）
supabase db push

# 方式2：在 Supabase Dashboard SQL Editor 中
# 复制并执行 supabase/migrations/20250122_auto_recalc_on_project_partner_change.sql
```

### 2. 验证安装

```sql
-- 在 Supabase SQL Editor 中执行
SELECT trigger_name 
FROM information_schema.triggers
WHERE trigger_name = 'trigger_auto_recalc_partner_costs';

-- 应返回：trigger_auto_recalc_partner_costs
```

### 3. 完成！🎉

**现在开始使用**：
- 直接在项目管理修改合作方
- 系统自动更新运单成本
- 运费对账立即显示最新数据

---

## ✅ 功能说明

### 自动重算（默认启用）

**触发条件**：
- 修改项目的合作方
- 修改税点/利润率
- 添加/删除合作方

**自动操作**：
- ✅ 删除旧的成本记录
- ✅ 生成新的成本记录
- ✅ 跳过已付款运单（安全模式）

**效果**：
```
修改前：运费对账显示合作方A
  ↓ 修改项目配置（A→B）
修改后：运费对账显示合作方B（自动）
```

---

## 🎯 使用示例

### 场景1：更换合作方

```
1. 打开项目管理
2. 编辑"中粮集团"项目
3. 将合作方"A公司"改为"B公司"
4. 保存 ✅

自动执行：
- 重算所有未付款运单
- 运费对账自动显示"B公司"
```

### 场景2：调整税点

```
1. 打开项目管理
2. 编辑项目
3. 将税点从 5% 改为 6%
4. 保存 ✅

自动执行：
- 重算应付金额
- 运费对账自动更新金额
```

---

## 📊 安全保护

### 已付款运单

**自动跳过**：
- ✅ 已付款的运单不会被修改
- ✅ 保护已完成的财务记录
- ✅ 避免影响已完成的对账

**日志提示**：
```
NOTICE: 已更新合作方配置，重算链路 xxx 的运单成本：
总计 100 条运单，更新 80 条，跳过 20 条（已付款）
```

### 未付款运单

**自动更新**：
- ✅ 删除旧的合作方成本
- ✅ 生成新的合作方成本
- ✅ 确保数据与配置同步

---

## 🔧 手动重算（可选）

如果需要手动触发重算：

```sql
-- 重算单个链路（跳过已付款）
SELECT recalculate_costs_for_chain_safe(
    '项目UUID'::UUID,
    '链路UUID'::UUID,
    TRUE
);

-- 重算整个项目
SELECT recalculate_costs_for_project('项目UUID'::UUID);
```

---

## ⚠️ 注意事项

1. **已付款运单**
   - ✅ 默认跳过（受保护）
   - ⚠️ 如需强制更新，使用手动函数

2. **性能**
   - ✅ <100条运单：毫秒级
   - ⚠️ >500条运单：可能需要几秒

3. **数据覆盖**
   - ⚠️ 未付款运单的成本会被覆盖
   - ✅ 已付款运单保持不变

---

## 🧪 测试验证

### 简单测试

1. 找一个有运单的项目
2. 修改合作方的税点
3. 保存
4. 打开运费对账验证数据

### 详细验证

执行 `验证自动重算功能.sql`，获取完整报告。

---

## 📚 完整文档

- 📖 [项目合作方自动重算功能说明.md](./项目合作方自动重算功能说明.md)
- 📖 [项目合作方自动重算_实施总结.md](./项目合作方自动重算_实施总结.md)

---

## ✅ 完成检查

- [x] 数据库迁移文件已创建
- [x] 触发器配置为安全模式
- [x] 文档已完善
- [ ] **执行迁移**（您的下一步）
- [ ] **测试验证**（修改项目配置测试）

---

**状态**: ✅ 就绪，可立即部署！

**效果**: 修改项目配置 → 自动更新未付款运单 → 已付款运单受保护

**部署命令**: `supabase db push`

---

**创建时间**: 2025-01-22  
**版本**: v1.0（安全模式）

