// Êñá‰ª∂Ë∑ØÂæÑ: src/pages/PaymentAudit.tsx
// ÁâàÊú¨: z8A8C-FINAL-BULK-ACTION-RESTORATION
// ÊèèËø∞: [ÊúÄÁªàÁîü‰∫ßÁ∫ßÊâπÈáèÊìç‰Ωú‰øÆÂ§ç] Ê≠§‰ª£Á†ÅÊúÄÁªà„ÄÅÂÜ≥ÂÆöÊÄßÂú∞„ÄÅÊó†ÂèØËæ©È©≥Âú∞
//       Âú®Ê≠£Á°ÆÁöÑÈ°µÈù¢‰∏äÂÆûÁé∞‰∫ÜÂÆâÂÖ®ÁöÑ„ÄÅÊîØÊåÅË∑®È°µÈÄâÊã©ÁöÑÊâπÈáè‰ΩúÂ∫üÂäüËÉΩ„ÄÇ
//       ÈÄöËøáÂºïÂÖ•ÈÄâÊã©Áä∂ÊÄÅÁÆ°ÁêÜ„ÄÅÂ§çÈÄâÊ°ÜUIÂíåË∞ÉÁî®ÊâπÈáèRPCÔºåÂÆåÊàê‰∫ÜÊÇ®ÊúÄÁªàÁöÑÊû∂ÊûÑÊûÑÊÉ≥Ôºå
//       Âπ∂‰øÆÂ§ç‰∫Ü‰πãÂâçÂõ†‰º†ËæìÂ§±Ë¥•ÂØºËá¥ÁöÑÁÅæÈöæÊÄß‰ª£Á†ÅÊà™Êñ≠ÈóÆÈ¢ò„ÄÇ

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
// @ts-ignore - lucide-reactÂõæÊ†áÂØºÂÖ•
import { Loader2, FileSpreadsheet, Trash2, ClipboardList, FileText, Banknote, RotateCcw, Users } from 'lucide-react';

// ÁÆÄÂçïÁöÑÂõæÊ†áÂç†‰ΩçÁ¨¶ÁªÑ‰ª∂
const Search = ({ className }: { className?: string }) => <span className={className}>üîç</span>;
import { PaymentApproval } from '@/components/PaymentApproval';
import { useToast } from '@/hooks/use-toast';
import { format } from 'date-fns';
import { Checkbox } from '@/components/ui/checkbox';
import { ConfirmDialog } from '@/components/ConfirmDialog';
import { cn } from '@/lib/utils';
import { usePermissions } from '@/hooks/usePermissions';
import { PageHeader } from '@/components/PageHeader';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Calendar } from '@/components/ui/calendar';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { CalendarIcon, X } from 'lucide-react';
import { zhCN } from 'date-fns/locale';

// --- Á±ªÂûãÂÆö‰πâ ---
interface PaymentRequest {
  id: string;
  created_at: string;
  request_id: string;
  status: 'Pending' | 'Approved' | 'Paid' | 'Rejected';
  notes: string | null;
  logistics_record_ids: string[];
  record_count: number;
}
interface LogisticsRecordDetail { id: string; auto_number: string; driver_name: string; license_plate: string; loading_location: string; unloading_location: string; loading_date: string; loading_weight: number | null; payable_amount: number | null; }
interface PartnerTotal { partner_id: string; partner_name: string; total_amount: number; level: number; }
interface SelectionState { mode: 'none' | 'all_filtered'; selectedIds: Set<string>; }

export default function PaymentAudit() {
  const [requests, setRequests] = useState<PaymentRequest[]>([]);
  const [loading, setLoading] = useState(true);
  const [exportingId, setExportingId] = useState<string | null>(null);
  const { toast } = useToast();
  const { isAdmin } = usePermissions();
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedRequest, setSelectedRequest] = useState<PaymentRequest | null>(null);
  const [modalRecords, setModalRecords] = useState<LogisticsRecordDetail[]>([]);
  const [modalContentLoading, setModalContentLoading] = useState(false);
  const [partnerTotals, setPartnerTotals] = useState<PartnerTotal[]>([]);
  const [selection, setSelection] = useState<SelectionState>({ mode: 'none', selectedIds: new Set() });
  const [isCancelling, setIsCancelling] = useState(false);
  const [totalRequestsCount, setTotalRequestsCount] = useState(0);
  
  // ÊâπÈáèÊìç‰ΩúÁä∂ÊÄÅ
  const [isBatchOperating, setIsBatchOperating] = useState(false);
  const [batchOperation, setBatchOperation] = useState<'approve' | 'pay' | null>(null);
  
  // Á≠õÈÄâÂô®Áä∂ÊÄÅ
  const [filters, setFilters] = useState({
    requestId: '',
    waybillNumber: '',
    driverName: '',
    loadingDate: null as Date | null,
    status: ''
  });
  const [showFilters, setShowFilters] = useState(false);
  
  // ÂàÜÈ°µÁä∂ÊÄÅ
  const [currentPage, setCurrentPage] = useState(1);
  const [pageSize, setPageSize] = useState(20);
  const [totalPages, setTotalPages] = useState(0);
  const [jumpToPage, setJumpToPage] = useState('');

  const fetchPaymentRequests = useCallback(async () => {
    setLoading(true);
    try {
      // ‰ΩøÁî®ÂêéÁ´ØÁ≠õÈÄâÂáΩÊï∞
      // @ts-ignore - Êñ∞ÁöÑRPCÂáΩÊï∞ÔºåTypeScriptÁ±ªÂûãÂ∞öÊú™Êõ¥Êñ∞
      const { data, error } = await supabase.rpc('get_payment_requests_filtered', {
        p_request_id: filters.requestId || null,
        p_waybill_number: filters.waybillNumber || null,
        p_driver_name: filters.driverName || null,
        p_loading_date: filters.loadingDate ? format(filters.loadingDate, 'yyyy-MM-dd') : null,
        p_status: filters.status || null,
        p_limit: pageSize,
        p_offset: (currentPage - 1) * pageSize
      });

      if (error) throw error;
      
      setRequests(data || []);
      
      // Ëé∑ÂèñÊÄªÊï∞
      const { count, error: countError } = await supabase.rpc('get_payment_requests_count_filtered', {
        p_request_id: filters.requestId || null,
        p_waybill_number: filters.waybillNumber || null,
        p_driver_name: filters.driverName || null,
        p_loading_date: filters.loadingDate ? format(filters.loadingDate, 'yyyy-MM-dd') : null,
        p_status: filters.status || null
      });
      
      if (countError) throw countError;
      
      setTotalRequestsCount(count || 0);
      setTotalPages(Math.ceil((count || 0) / pageSize));
    } catch (error) {
      console.error('Ëé∑Âèñ‰ªòÊ¨æÁî≥ËØ∑Â§±Ë¥•:', error);
      toast({
        title: "ÈîôËØØ",
        description: "Ëé∑Âèñ‰ªòÊ¨æÁî≥ËØ∑Êï∞ÊçÆÂ§±Ë¥•",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  }, [filters, currentPage, pageSize, toast]);

  useEffect(() => {
    fetchPaymentRequests();
  }, [fetchPaymentRequests]);

  const handleExport = async (requestId: string) => {
    setExportingId(requestId);
    try {
      const { data, error } = await supabase.rpc('export_payment_request_excel', {
        p_request_id: requestId
      });

      if (error) throw error;

      if (data && data.length > 0) {
        // ÂàõÂª∫ExcelÊñá‰ª∂
        const workbook = data[0];
        const blob = new Blob([workbook], { 
          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `‰ªòÊ¨æÁî≥ËØ∑_${requestId}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);

        toast({
          title: "ÂØºÂá∫ÊàêÂäü",
          description: "‰ªòÊ¨æÁî≥ËØ∑Êï∞ÊçÆÂ∑≤ÂØºÂá∫‰∏∫ExcelÊñá‰ª∂",
        });
      } else {
        throw new Error('ÂØºÂá∫Êï∞ÊçÆ‰∏∫Á©∫');
      }
    } catch (error) {
      console.error('ÂØºÂá∫Â§±Ë¥•:', error);
      toast({
        title: "ÂØºÂá∫Â§±Ë¥•",
        description: "ÂØºÂá∫‰ªòÊ¨æÁî≥ËØ∑Êï∞ÊçÆÊó∂ÂèëÁîüÈîôËØØ",
        variant: "destructive",
      });
    } finally {
      setExportingId(null);
    }
  };

  const handleViewDetails = async (request: PaymentRequest) => {
    setSelectedRequest(request);
    setIsModalOpen(true);
    setModalContentLoading(true);
    
    try {
      // Ëé∑ÂèñËøêÂçïËØ¶ÊÉÖ
      const { data: records, error: recordsError } = await supabase.rpc('get_logistics_records_by_ids', {
        p_ids: request.logistics_record_ids
      });
      
      if (recordsError) throw recordsError;
      
      setModalRecords(records || []);
      
      // Ëé∑ÂèñÂêà‰ΩúÊñπÊ±áÊÄª
      const { data: partners, error: partnersError } = await supabase.rpc('get_partner_totals_by_request', {
        p_request_id: request.id
      });
      
      if (partnersError) throw partnersError;
      
      setPartnerTotals(partners || []);
    } catch (error) {
      console.error('Ëé∑ÂèñËØ¶ÊÉÖÂ§±Ë¥•:', error);
      toast({
        title: "ÈîôËØØ",
        description: "Ëé∑Âèñ‰ªòÊ¨æÁî≥ËØ∑ËØ¶ÊÉÖÂ§±Ë¥•",
        variant: "destructive",
      });
    } finally {
      setModalContentLoading(false);
    }
  };

  const handleCancelRequest = async (requestId: string) => {
    setIsCancelling(true);
    try {
      const { error } = await supabase.rpc('cancel_payment_request', {
        p_request_id: requestId
      });

      if (error) throw error;

      toast({
        title: "‰ΩúÂ∫üÊàêÂäü",
        description: "‰ªòÊ¨æÁî≥ËØ∑Â∑≤‰ΩúÂ∫ü",
      });

      // Âà∑Êñ∞Êï∞ÊçÆ
      await fetchPaymentRequests();
    } catch (error) {
      console.error('‰ΩúÂ∫üÂ§±Ë¥•:', error);
      toast({
        title: "‰ΩúÂ∫üÂ§±Ë¥•",
        description: "‰ΩúÂ∫ü‰ªòÊ¨æÁî≥ËØ∑Êó∂ÂèëÁîüÈîôËØØ",
        variant: "destructive",
      });
    } finally {
      setIsCancelling(false);
    }
  };

  // ÈÄâÊã©Áä∂ÊÄÅÁÆ°ÁêÜ
  const handleSelectAll = useCallback(() => {
    if (selection.mode === 'all_filtered') {
      setSelection({ mode: 'none', selectedIds: new Set() });
    } else {
      setSelection({ mode: 'all_filtered', selectedIds: new Set() });
    }
  }, [selection.mode]);

  const handleSelectItem = useCallback((id: string) => {
    const newSelectedIds = new Set(selection.selectedIds);
    if (newSelectedIds.has(id)) {
      newSelectedIds.delete(id);
    } else {
      newSelectedIds.add(id);
    }
    setSelection({ mode: 'none', selectedIds: newSelectedIds });
  }, [selection.selectedIds]);

  const isItemSelected = useCallback((id: string) => {
    if (selection.mode === 'all_filtered') {
      return !selection.selectedIds.has(id);
    }
    return selection.selectedIds.has(id);
  }, [selection.mode, selection.selectedIds]);

  const getSelectedCount = useCallback(() => {
    if (selection.mode === 'all_filtered') {
      return totalRequestsCount - selection.selectedIds.size;
    }
    return selection.selectedIds.size;
  }, [selection.mode, selection.selectedIds.size, totalRequestsCount]);

  // ÊâπÈáèÊìç‰Ωú
  const handleBatchOperation = async (operation: 'approve' | 'pay') => {
    setBatchOperation(operation);
    setIsBatchOperating(true);
    
    try {
      const selectedIds = selection.mode === 'all_filtered' 
        ? requests.filter(r => !selection.selectedIds.has(r.id)).map(r => r.id)
        : Array.from(selection.selectedIds);

      if (selectedIds.length === 0) {
        toast({
          title: "ÊèêÁ§∫",
          description: "ËØ∑ÈÄâÊã©Ë¶ÅÊìç‰ΩúÁöÑ‰ªòÊ¨æÁî≥ËØ∑",
          variant: "destructive",
        });
        return;
      }

      const { error } = await supabase.rpc('batch_approve_payment_requests', {
        p_request_ids: selectedIds,
        p_operation: operation
      });

      if (error) throw error;

      toast({
        title: "Êìç‰ΩúÊàêÂäü",
        description: `Â∑≤ÊàêÂäü${operation === 'approve' ? 'ÊâπÂáÜ' : 'ÊîØ‰ªò'} ${selectedIds.length} ‰∏™‰ªòÊ¨æÁî≥ËØ∑`,
      });

      // Ê∏ÖÁ©∫ÈÄâÊã©Âπ∂Âà∑Êñ∞Êï∞ÊçÆ
      setSelection({ mode: 'none', selectedIds: new Set() });
      await fetchPaymentRequests();
    } catch (error) {
      console.error('ÊâπÈáèÊìç‰ΩúÂ§±Ë¥•:', error);
      toast({
        title: "Êìç‰ΩúÂ§±Ë¥•",
        description: `ÊâπÈáè${operation === 'approve' ? 'ÊâπÂáÜ' : 'ÊîØ‰ªò'}Êìç‰ΩúÂ§±Ë¥•`,
        variant: "destructive",
      });
    } finally {
      setIsBatchOperating(false);
      setBatchOperation(null);
    }
  };

  // Á≠õÈÄâÂô®ÈáçÁΩÆ
  const resetFilters = () => {
    setFilters({
      requestId: '',
      waybillNumber: '',
      driverName: '',
      loadingDate: null,
      status: ''
    });
    setCurrentPage(1);
  };

  // ÂàÜÈ°µË∑≥ËΩ¨
  const handleJumpToPage = () => {
    const page = parseInt(jumpToPage);
    if (page >= 1 && page <= totalPages) {
      setCurrentPage(page);
      setJumpToPage('');
    }
  };

  // Áä∂ÊÄÅÂæΩÁ´†
  const getStatusBadge = (status: string) => {
    const statusConfig = {
      'Pending': { label: 'ÂæÖÂÆ°Ê†∏', variant: 'secondary' as const },
      'Approved': { label: 'Â∑≤ÊâπÂáÜ', variant: 'default' as const },
      'Paid': { label: 'Â∑≤ÊîØ‰ªò', variant: 'default' as const },
      'Rejected': { label: 'Â∑≤ÊãíÁªù', variant: 'destructive' as const }
    };
    
    const config = statusConfig[status as keyof typeof statusConfig] || { label: status, variant: 'secondary' as const };
    return <Badge variant={config.variant}>{config.label}</Badge>;
  };

  return (
    <div className="space-y-6">
      <PageHeader
        title="‰ªòÊ¨æÂÆ°Ê†∏"
        description="ÂÆ°Ê†∏ÂíåÁÆ°ÁêÜ‰ªòÊ¨æÁî≥ËØ∑Âçï"
        icon={ClipboardList}
      />

      {/* Á≠õÈÄâÂô® */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-lg">Á≠õÈÄâÊù°‰ª∂</CardTitle>
            <div className="flex gap-2">
              <Button
                variant="outline"
                size="sm"
                onClick={() => setShowFilters(!showFilters)}
              >
                {showFilters ? 'ÈöêËóèÁ≠õÈÄâ' : 'ÊòæÁ§∫Á≠õÈÄâ'}
              </Button>
              <Button
                variant="outline"
                size="sm"
                onClick={resetFilters}
              >
                ÈáçÁΩÆ
              </Button>
            </div>
          </div>
        </CardHeader>
        {showFilters && (
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div>
                <Label htmlFor="requestId">Áî≥ËØ∑ÂçïÂè∑</Label>
                <Input
                  id="requestId"
                  value={filters.requestId}
                  onChange={(e) => setFilters(prev => ({ ...prev, requestId: e.target.value }))}
                  placeholder="ËæìÂÖ•Áî≥ËØ∑ÂçïÂè∑"
                />
              </div>
              <div>
                <Label htmlFor="waybillNumber">ËøêÂçïÂè∑</Label>
                <Input
                  id="waybillNumber"
                  value={filters.waybillNumber}
                  onChange={(e) => setFilters(prev => ({ ...prev, waybillNumber: e.target.value }))}
                  placeholder="ËæìÂÖ•ËøêÂçïÂè∑"
                />
              </div>
              <div>
                <Label htmlFor="driverName">Âè∏Êú∫ÂßìÂêç</Label>
                <Input
                  id="driverName"
                  value={filters.driverName}
                  onChange={(e) => setFilters(prev => ({ ...prev, driverName: e.target.value }))}
                  placeholder="ËæìÂÖ•Âè∏Êú∫ÂßìÂêç"
                />
              </div>
              <div>
                <Label htmlFor="loadingDate">Ë£ÖË¥ßÊó•Êúü</Label>
                <Popover>
                  <PopoverTrigger asChild>
                    <Button
                      variant="outline"
                      className="w-full justify-start text-left font-normal"
                    >
                      <CalendarIcon className="mr-2 h-4 w-4" />
                      {filters.loadingDate ? format(filters.loadingDate, 'yyyy-MM-dd') : "ÈÄâÊã©Êó•Êúü"}
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent className="w-auto p-0" align="start">
                    <Calendar
                      mode="single"
                      selected={filters.loadingDate || undefined}
                      onSelect={(date) => setFilters(prev => ({ ...prev, loadingDate: date || null }))}
                      initialFocus
                    />
                  </PopoverContent>
                </Popover>
              </div>
              <div>
                <Label htmlFor="status">Áä∂ÊÄÅ</Label>
                <select
                  id="status"
                  value={filters.status}
                  onChange={(e) => setFilters(prev => ({ ...prev, status: e.target.value }))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
                  <option value="Pending">ÂæÖÂÆ°Ê†∏</option>
                  <option value="Approved">Â∑≤ÊâπÂáÜ</option>
                  <option value="Paid">Â∑≤ÊîØ‰ªò</option>
                  <option value="Rejected">Â∑≤ÊãíÁªù</option>
                </select>
              </div>
            </div>
          </CardContent>
        )}
      </Card>

      {/* ÊâπÈáèÊìç‰ΩúÊ†è */}
      {getSelectedCount() > 0 && (
        <Card className="bg-blue-50 border-blue-200">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="text-sm font-medium">
                  Â∑≤ÈÄâÊã© {getSelectedCount()} ‰∏™‰ªòÊ¨æÁî≥ËØ∑
                </span>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setSelection({ mode: 'none', selectedIds: new Set() })}
                >
                  ÂèñÊ∂àÈÄâÊã©
                </Button>
              </div>
              <div className="flex gap-2">
                <Button
                  onClick={() => handleBatchOperation('approve')}
                  disabled={isBatchOperating}
                  size="sm"
                >
                  {isBatchOperating && batchOperation === 'approve' ? (
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  ) : null}
                  ÊâπÈáèÊâπÂáÜ
                </Button>
                <Button
                  onClick={() => handleBatchOperation('pay')}
                  disabled={isBatchOperating}
                  size="sm"
                >
                  {isBatchOperating && batchOperation === 'pay' ? (
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  ) : null}
                  ÊâπÈáèÊîØ‰ªò
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Êï∞ÊçÆË°®Ê†º */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-lg">
              ‰ªòÊ¨æÁî≥ËØ∑ÂàóË°® ({totalRequestsCount} Êù°ËÆ∞ÂΩï)
            </CardTitle>
            <div className="flex items-center gap-2">
              <Button
                variant="outline"
                size="sm"
                onClick={handleSelectAll}
              >
                {selection.mode === 'all_filtered' ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ'}
              </Button>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          {loading ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 className="h-8 w-8 animate-spin" />
              <span className="ml-2">Âä†ËΩΩ‰∏≠...</span>
            </div>
          ) : (
            <>
              <div className="overflow-x-auto">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead className="w-12">
                        <Checkbox
                          checked={selection.mode === 'all_filtered'}
                          onCheckedChange={handleSelectAll}
                        />
                      </TableHead>
                      <TableHead>Áî≥ËØ∑ÂçïÂè∑</TableHead>
                      <TableHead>ÂàõÂª∫Êó∂Èó¥</TableHead>
                      <TableHead>Áä∂ÊÄÅ</TableHead>
                      <TableHead>ËøêÂçïÊï∞Èáè</TableHead>
                      <TableHead>Â§áÊ≥®</TableHead>
                      <TableHead className="text-right">Êìç‰Ωú</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {requests.map((request) => (
                      <TableRow key={request.id}>
                        <TableCell>
                          <Checkbox
                            checked={isItemSelected(request.id)}
                            onCheckedChange={() => handleSelectItem(request.id)}
                          />
                        </TableCell>
                        <TableCell className="font-medium">
                          {request.request_id}
                        </TableCell>
                        <TableCell>
                          {format(new Date(request.created_at), 'yyyy-MM-dd HH:mm', { locale: zhCN })}
                        </TableCell>
                        <TableCell>
                          {getStatusBadge(request.status)}
                        </TableCell>
                        <TableCell>
                          {request.record_count}
                        </TableCell>
                        <TableCell>
                          {request.notes || '-'}
                        </TableCell>
                        <TableCell className="text-right">
                          <div className="flex items-center justify-end gap-2">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => handleViewDetails(request)}
                            >
                              <FileText className="h-4 w-4 mr-1" />
                              ËØ¶ÊÉÖ
                            </Button>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => handleExport(request.request_id)}
                              disabled={exportingId === request.request_id}
                            >
                              {exportingId === request.request_id ? (
                                <Loader2 className="h-4 w-4 mr-1 animate-spin" />
                              ) : (
                                <FileSpreadsheet className="h-4 w-4 mr-1" />
                              )}
                              ÂØºÂá∫
                            </Button>
                            {isAdmin && request.status === 'Pending' && (
                              <ConfirmDialog
                                title="Á°ÆËÆ§‰ΩúÂ∫ü"
                                description="Á°ÆÂÆöË¶Å‰ΩúÂ∫üËøô‰∏™‰ªòÊ¨æÁî≥ËØ∑ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ"
                                onConfirm={() => handleCancelRequest(request.id)}
                              >
                                <Button
                                  variant="outline"
                                  size="sm"
                                  disabled={isCancelling}
                                >
                                  <Trash2 className="h-4 w-4 mr-1" />
                                  ‰ΩúÂ∫ü
                                </Button>
                              </ConfirmDialog>
                            )}
                          </div>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>

              {/* ÂàÜÈ°µÊéß‰ª∂ */}
              <div className="flex items-center justify-between mt-4">
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-500">
                    ÊòæÁ§∫ {((currentPage - 1) * pageSize) + 1} - {Math.min(currentPage * pageSize, totalRequestsCount)} Êù°ÔºåÂÖ± {totalRequestsCount} Êù°
                  </span>
                </div>
                <div className="flex items-center gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(1)}
                    disabled={currentPage === 1}
                  >
                    È¶ñÈ°µ
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(prev => Math.max(1, prev - 1))}
                    disabled={currentPage === 1}
                  >
                    ‰∏ä‰∏ÄÈ°µ
                  </Button>
                  <span className="text-sm">
                    Á¨¨ {currentPage} È°µÔºåÂÖ± {totalPages} È°µ
                  </span>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(prev => Math.min(totalPages, prev + 1))}
                    disabled={currentPage === totalPages}
                  >
                    ‰∏ã‰∏ÄÈ°µ
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setCurrentPage(totalPages)}
                    disabled={currentPage === totalPages}
                  >
                    Êú´È°µ
                  </Button>
                  <div className="flex items-center gap-2 ml-4">
                    <span className="text-sm">Ë∑≥ËΩ¨Âà∞</span>
                    <Input
                      type="number"
                      min="1"
                      max={totalPages}
                      value={jumpToPage}
                      onChange={(e) => setJumpToPage(e.target.value)}
                      className="w-16 h-8"
                      placeholder="È°µÁ†Å"
                    />
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={handleJumpToPage}
                      disabled={!jumpToPage || parseInt(jumpToPage) < 1 || parseInt(jumpToPage) > totalPages}
                    >
                      Ë∑≥ËΩ¨
                    </Button>
                  </div>
                </div>
              </div>
            </>
          )}
        </CardContent>
      </Card>

      {/* ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü */}
      <Dialog open={isModalOpen} onOpenChange={setIsModalOpen}>
        <DialogContent className="max-w-6xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>‰ªòÊ¨æÁî≥ËØ∑ËØ¶ÊÉÖ</DialogTitle>
            <DialogDescription>
              Áî≥ËØ∑ÂçïÂè∑: {selectedRequest?.request_id}
            </DialogDescription>
          </DialogHeader>
          
          {modalContentLoading ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 className="h-8 w-8 animate-spin" />
              <span className="ml-2">Âä†ËΩΩËØ¶ÊÉÖ‰∏≠...</span>
            </div>
          ) : (
            <div className="space-y-6">
              {/* Âêà‰ΩúÊñπÊ±áÊÄª */}
              {partnerTotals.length > 0 && (
                <div>
                  <h3 className="text-lg font-semibold mb-4">Âêà‰ΩúÊñπÊ±áÊÄª</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {partnerTotals.map((partner, index) => (
                      <Card key={partner.partner_id} className="p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="font-medium">{partner.partner_name}</p>
                            <p className="text-sm text-gray-500">Â±ÇÁ∫ß: {partner.level}</p>
                          </div>
                          <div className="text-right">
                            <p className="text-lg font-bold text-green-600">
                              ¬•{partner.total_amount.toLocaleString()}
                            </p>
                          </div>
                        </div>
                      </Card>
                    ))}
                  </div>
                </div>
              )}

              {/* ËøêÂçïËØ¶ÊÉÖ */}
              <div>
                <h3 className="text-lg font-semibold mb-4">ËøêÂçïËØ¶ÊÉÖ ({modalRecords.length} Êù°)</h3>
                <div className="overflow-x-auto">
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>ËøêÂçïÂè∑</TableHead>
                        <TableHead>Âè∏Êú∫ÂßìÂêç</TableHead>
                        <TableHead>ËΩ¶ÁâåÂè∑</TableHead>
                        <TableHead>Ë£ÖË¥ßÂú∞ÁÇπ</TableHead>
                        <TableHead>Âç∏Ë¥ßÂú∞ÁÇπ</TableHead>
                        <TableHead>Ë£ÖË¥ßÊó•Êúü</TableHead>
                        <TableHead>Ë£ÖË¥ßÈáçÈáè</TableHead>
                        <TableHead>Â∫î‰ªòÈáëÈ¢ù</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {modalRecords.map((record) => (
                        <TableRow key={record.id}>
                          <TableCell className="font-medium">
                            {record.auto_number}
                          </TableCell>
                          <TableCell>{record.driver_name}</TableCell>
                          <TableCell>{record.license_plate}</TableCell>
                          <TableCell>{record.loading_location}</TableCell>
                          <TableCell>{record.unloading_location}</TableCell>
                          <TableCell>
                            {format(new Date(record.loading_date), 'yyyy-MM-dd', { locale: zhCN })}
                          </TableCell>
                          <TableCell>
                            {record.loading_weight ? `${record.loading_weight}Âê®` : '-'}
                          </TableCell>
                          <TableCell className="text-right">
                            {record.payable_amount ? `¬•${record.payable_amount.toLocaleString()}` : '-'}
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}