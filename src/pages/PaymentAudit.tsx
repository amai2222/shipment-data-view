// Êñá‰ª∂Ë∑ØÂæÑ: src/pages/PaymentAudit.tsx
// ÁâàÊú¨: ‰ªòÊ¨æÂÆ°Ê†∏È°µÈù¢
// ÊèèËø∞: Â§çÂà∂‰ªòÊ¨æÁî≥ËØ∑ÂçïÁÆ°ÁêÜÈ°µÈù¢ÁöÑ‰ª£Á†ÅÔºåÁî®‰∫é‰ªòÊ¨æÂÆ°Ê†∏ÂäüËÉΩ

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
// @ts-ignore - lucide-reactÂõæÊ†áÂØºÂÖ•
import { Loader2, FileSpreadsheet, Trash2, ClipboardList, FileText, Banknote, RotateCcw, Users } from 'lucide-react';

// ÁÆÄÂçïÁöÑÂõæÊ†áÂç†‰ΩçÁ¨¶ÁªÑ‰ª∂
const Search = ({ className }: { className?: string }) => <span className={className}>üîç</span>;
import { PaymentApproval } from '@/components/PaymentApproval';
import { useToast } from '@/hooks/use-toast';
import { format } from 'date-fns';
import { Checkbox } from '@/components/ui/checkbox';
import { ConfirmDialog } from '@/components/ConfirmDialog';
import { cn } from '@/lib/utils';
import { usePermissions } from '@/hooks/usePermissions';
import { PageHeader } from '@/components/PageHeader';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Calendar } from '@/components/ui/calendar';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { CalendarIcon, X } from 'lucide-react';
import { zhCN } from 'date-fns/locale';

// --- Á±ªÂûãÂÆö‰πâ ---
interface PaymentRequest {
  id: string;
  created_at: string;
  request_id: string;
  status: 'Pending' | 'Approved' | 'Paid' | 'Rejected';
  notes: string | null;
  logistics_record_ids: string[];
  record_count: number;
}
interface LogisticsRecordDetail { id: string; auto_number: string; driver_name: string; license_plate: string; loading_location: string; unloading_location: string; loading_date: string; loading_weight: number | null; payable_amount: number | null; }
interface PartnerTotal { partner_id: string; partner_name: string; total_amount: number; level: number; }
interface SelectionState { mode: 'none' | 'all_filtered'; selectedIds: Set<string>; }

export default function PaymentAudit() {
  const [requests, setRequests] = useState<PaymentRequest[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedRequest, setSelectedRequest] = useState<PaymentRequest | null>(null);
  const [isDetailDialogOpen, setIsDetailDialogOpen] = useState(false);
  const [isApprovalDialogOpen, setIsApprovalDialogOpen] = useState(false);
  const [isVoidDialogOpen, setIsVoidDialogOpen] = useState(false);
  const [recordDetails, setRecordDetails] = useState<LogisticsRecordDetail[]>([]);
  const [partnerTotals, setPartnerTotals] = useState<PartnerTotal[]>([]);
  const [loadingDetails, setLoadingDetails] = useState(false);
  const [selection, setSelection] = useState<SelectionState>({ mode: 'none', selectedIds: new Set() });
  const [isVoiding, setIsVoiding] = useState(false);
  const [isApproving, setIsApproving] = useState(false);
  const [isRejecting, setIsRejecting] = useState(false);
  const [isBulkVoiding, setIsBulkVoiding] = useState(false);
  const [showFilters, setShowFilters] = useState(false);
  const [filters, setFilters] = useState({
    requestId: '',
    waybillNumber: '',
    driverName: '',
    loadingDate: null as Date | null,
    status: 'all'
  });
  const [filteredRequests, setFilteredRequests] = useState<PaymentRequest[]>([]);
  const [isExporting, setIsExporting] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  const [paymentPreviewData, setPaymentPreviewData] = useState<any>(null);
  const [isPreviewModalOpen, setIsPreviewModalOpen] = useState(false);
  const [finalPaymentData, setFinalPaymentData] = useState<any>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [isDriverBatchOpen, setIsDriverBatchOpen] = useState(false);

  const { toast } = useToast();
  const { isAdmin, isFinance } = usePermissions();

  // Ëé∑Âèñ‰ªòÊ¨æÁî≥ËØ∑ÂàóË°®
  const fetchRequests = useCallback(async () => {
    try {
      setLoading(true);
      const { data, error } = await supabase
        .from('payment_requests')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;
      setRequests(data || []);
    } catch (error) {
      console.error('Ëé∑Âèñ‰ªòÊ¨æÁî≥ËØ∑ÂàóË°®Â§±Ë¥•:', error);
      toast({ title: "ÈîôËØØ", description: "Ëé∑Âèñ‰ªòÊ¨æÁî≥ËØ∑ÂàóË°®Â§±Ë¥•", variant: "destructive" });
    } finally {
      setLoading(false);
    }
  }, [toast]);

  // Ëé∑ÂèñÁî≥ËØ∑ËØ¶ÊÉÖ
  const fetchRequestDetails = useCallback(async (request: PaymentRequest) => {
    try {
      setLoadingDetails(true);
      
      // Ëé∑ÂèñËøêÂçïËØ¶ÊÉÖ
      const { data: recordsData, error: recordsError } = await supabase
        .from('logistics_records')
        .select(`
          id, auto_number, driver_name, license_plate, 
          loading_location, unloading_location, loading_date, 
          loading_weight, payable_cost
        `)
        .in('id', request.logistics_record_ids);

      if (recordsError) throw recordsError;

      // Ëé∑ÂèñÂêà‰ΩúÊñπÊ±áÊÄª
      const { data: partnersData, error: partnersError } = await supabase
        .rpc('get_payment_request_partner_totals', {
          p_request_id: request.id
        });

      if (partnersError) throw partnersError;

      setRecordDetails(recordsData || []);
      setPartnerTotals(partnersData || []);
    } catch (error) {
      console.error('Ëé∑ÂèñÁî≥ËØ∑ËØ¶ÊÉÖÂ§±Ë¥•:', error);
      toast({ title: "ÈîôËØØ", description: "Ëé∑ÂèñÁî≥ËØ∑ËØ¶ÊÉÖÂ§±Ë¥•", variant: "destructive" });
    } finally {
      setLoadingDetails(false);
    }
  }, [toast]);

  // Â§ÑÁêÜÁî≥ËØ∑Áä∂ÊÄÅÊõ¥Êñ∞
  const handleStatusUpdate = useCallback(async (requestId: string, newStatus: string, notes?: string) => {
    try {
      const { error } = await supabase
        .from('payment_requests')
        .update({ 
          status: newStatus,
          notes: notes || null,
          updated_at: new Date().toISOString()
        })
        .eq('id', requestId);

      if (error) throw error;

      toast({ 
        title: "Áä∂ÊÄÅÊõ¥Êñ∞ÊàêÂäü", 
        description: `Áî≥ËØ∑Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫${newStatus}` 
      });

      await fetchRequests();
    } catch (error) {
      console.error('Êõ¥Êñ∞Áä∂ÊÄÅÂ§±Ë¥•:', error);
      toast({ title: "ÈîôËØØ", description: "Êõ¥Êñ∞Áä∂ÊÄÅÂ§±Ë¥•", variant: "destructive" });
    }
  }, [fetchRequests, toast]);

  // ÊâπÈáè‰ΩúÂ∫ü
  const handleBulkVoid = useCallback(async () => {
    if (selection.selectedIds.size === 0) {
      toast({ title: "ÊèêÁ§∫", description: "ËØ∑ÈÄâÊã©Ë¶Å‰ΩúÂ∫üÁöÑÁî≥ËØ∑", variant: "default" });
      return;
    }

    try {
      setIsBulkVoiding(true);
      const { error } = await supabase
        .from('payment_requests')
        .update({ status: 'Rejected' })
        .in('id', Array.from(selection.selectedIds));

      if (error) throw error;

      toast({ 
        title: "ÊâπÈáè‰ΩúÂ∫üÊàêÂäü", 
        description: `Â∑≤‰ΩúÂ∫ü ${selection.selectedIds.size} ‰∏™Áî≥ËØ∑` 
      });

      setSelection({ mode: 'none', selectedIds: new Set() });
      await fetchRequests();
    } catch (error) {
      console.error('ÊâπÈáè‰ΩúÂ∫üÂ§±Ë¥•:', error);
      toast({ title: "ÈîôËØØ", description: "ÊâπÈáè‰ΩúÂ∫üÂ§±Ë¥•", variant: "destructive" });
    } finally {
      setIsBulkVoiding(false);
    }
  }, [selection, fetchRequests, toast]);

  // ÂØºÂá∫Excel
  const handleExportExcel = useCallback(async () => {
    try {
      setIsExporting(true);
      const { data, error } = await supabase.functions.invoke('export-excel', {
        body: { 
          type: 'payment_requests',
          request_ids: filteredRequests.map(r => r.id)
        }
      });

      if (error) throw error;

      // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
      const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `‰ªòÊ¨æÁî≥ËØ∑ÂÆ°Ê†∏_${format(new Date(), 'yyyy-MM-dd')}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      toast({ title: "ÂØºÂá∫ÊàêÂäü", description: "ExcelÊñá‰ª∂Â∑≤‰∏ãËΩΩ" });
    } catch (error) {
      console.error('ÂØºÂá∫Â§±Ë¥•:', error);
      toast({ title: "ÈîôËØØ", description: "ÂØºÂá∫Â§±Ë¥•", variant: "destructive" });
    } finally {
      setIsExporting(false);
    }
  }, [filteredRequests, toast]);

  // Â∫îÁî®Á≠õÈÄâ
  const applyFilters = useCallback(() => {
    let filtered = requests;

    if (filters.requestId) {
      filtered = filtered.filter(r => r.request_id.toLowerCase().includes(filters.requestId.toLowerCase()));
    }
    if (filters.status !== 'all') {
      filtered = filtered.filter(r => r.status === filters.status);
    }

    setFilteredRequests(filtered);
  }, [requests, filters]);

  // ÈáçÁΩÆÁ≠õÈÄâ
  const resetFilters = useCallback(() => {
    setFilters({
      requestId: '',
      waybillNumber: '',
      driverName: '',
      loadingDate: null,
      status: 'all'
    });
    setFilteredRequests(requests);
  }, [requests]);

  // Ëé∑ÂèñÁä∂ÊÄÅÂæΩÁ´†
  const getStatusBadge = (status: string) => {
    const statusConfig = {
      'Pending': { label: 'ÂæÖÂÆ°Ê†∏', variant: 'secondary' as const },
      'Approved': { label: 'Â∑≤ÈÄöËøá', variant: 'default' as const },
      'Paid': { label: 'Â∑≤‰ªòÊ¨æ', variant: 'default' as const },
      'Rejected': { label: 'Â∑≤ÊãíÁªù', variant: 'destructive' as const }
    };
    
    const config = statusConfig[status as keyof typeof statusConfig] || { label: status, variant: 'secondary' as const };
    return <Badge variant={config.variant}>{config.label}</Badge>;
  };

  // ÂàùÂßãÂåñÊï∞ÊçÆ
  useEffect(() => {
    fetchRequests();
  }, [fetchRequests]);

  // Â∫îÁî®Á≠õÈÄâ
  useEffect(() => {
    applyFilters();
  }, [applyFilters]);

  // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
  const handleSelectAll = useCallback(() => {
    if (selection.mode === 'all_filtered') {
      setSelection({ mode: 'none', selectedIds: new Set() });
    } else {
      setSelection({ mode: 'all_filtered', selectedIds: new Set() });
    }
  }, [selection]);

  // ÈÄâÊã©Âçï‰∏™È°πÁõÆ
  const handleSelectItem = useCallback((requestId: string) => {
    const newSelectedIds = new Set(selection.selectedIds);
    if (newSelectedIds.has(requestId)) {
      newSelectedIds.delete(requestId);
    } else {
      newSelectedIds.add(requestId);
    }
    setSelection({ mode: 'none', selectedIds: newSelectedIds });
  }, [selection]);

  // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÈÄâÊã©
  const isSelected = useCallback((requestId: string) => {
    return selection.mode === 'all_filtered' || selection.selectedIds.has(requestId);
  }, [selection]);

  return (
    <div className="space-y-6">
      <PageHeader 
        title="‰ªòÊ¨æÂÆ°Ê†∏" 
        description="ÂÆ°Ê†∏ÂíåÁÆ°ÁêÜ‰ªòÊ¨æÁî≥ËØ∑Âçï"
      />

      {/* Á≠õÈÄâÂô® */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="flex items-center gap-2">
              <Search className="h-5 w-5" />
              Á≠õÈÄâÊù°‰ª∂
            </CardTitle>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setShowFilters(!showFilters)}
            >
              {showFilters ? 'ÈöêËóèÁ≠õÈÄâ' : 'ÊòæÁ§∫Á≠õÈÄâ'}
            </Button>
          </div>
        </CardHeader>
        {showFilters && (
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <Label htmlFor="requestId">Áî≥ËØ∑ÂçïÂè∑</Label>
                <Input
                  id="requestId"
                  value={filters.requestId}
                  onChange={(e) => setFilters(prev => ({ ...prev, requestId: e.target.value }))}
                  placeholder="ËæìÂÖ•Áî≥ËØ∑ÂçïÂè∑"
                />
              </div>
              <div>
                <Label htmlFor="status">Áä∂ÊÄÅ</Label>
                <select
                  id="status"
                  value={filters.status}
                  onChange={(e) => setFilters(prev => ({ ...prev, status: e.target.value }))}
                  className="w-full p-2 border rounded-md"
                >
                  <option value="all">ÂÖ®ÈÉ®</option>
                  <option value="Pending">ÂæÖÂÆ°Ê†∏</option>
                  <option value="Approved">Â∑≤ÈÄöËøá</option>
                  <option value="Paid">Â∑≤‰ªòÊ¨æ</option>
                  <option value="Rejected">Â∑≤ÊãíÁªù</option>
                </select>
              </div>
              <div className="flex items-end gap-2">
                <Button onClick={applyFilters} size="sm">
                  Â∫îÁî®Á≠õÈÄâ
                </Button>
                <Button onClick={resetFilters} variant="outline" size="sm">
                  ÈáçÁΩÆ
                </Button>
              </div>
            </div>
          </CardContent>
        )}
      </Card>

      {/* Êìç‰ΩúÊ†è */}
      <Card>
        <CardContent className="p-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Checkbox
                checked={selection.mode === 'all_filtered'}
                onCheckedChange={handleSelectAll}
              />
              <span className="text-sm text-muted-foreground">
                ÂÖ®ÈÄâ ({filteredRequests.length} È°π)
              </span>
            </div>
            <div className="flex items-center gap-2">
              <Button
                variant="outline"
                size="sm"
                onClick={handleExportExcel}
                disabled={isExporting || filteredRequests.length === 0}
              >
                {isExporting ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : <FileSpreadsheet className="h-4 w-4 mr-2" />}
                ÂØºÂá∫Excel
              </Button>
              {selection.mode === 'all_filtered' || selection.selectedIds.size > 0 ? (
                <Button
                  variant="destructive"
                  size="sm"
                  onClick={handleBulkVoid}
                  disabled={isBulkVoiding}
                >
                  {isBulkVoiding ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : <Trash2 className="h-4 w-4 mr-2" />}
                  ÊâπÈáè‰ΩúÂ∫ü ({selection.mode === 'all_filtered' ? filteredRequests.length : selection.selectedIds.size})
                </Button>
              ) : null}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Áî≥ËØ∑ÂàóË°® */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <ClipboardList className="h-5 w-5" />
            ‰ªòÊ¨æÁî≥ËØ∑ÂàóË°®
          </CardTitle>
        </CardHeader>
        <CardContent>
          {loading ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 className="h-8 w-8 animate-spin" />
              <span className="ml-2">Âä†ËΩΩ‰∏≠...</span>
            </div>
          ) : (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="w-12">
                    <Checkbox
                      checked={selection.mode === 'all_filtered'}
                      onCheckedChange={handleSelectAll}
                    />
                  </TableHead>
                  <TableHead>Áî≥ËØ∑ÂçïÂè∑</TableHead>
                  <TableHead>ÂàõÂª∫Êó∂Èó¥</TableHead>
                  <TableHead>ËøêÂçïÊï∞Èáè</TableHead>
                  <TableHead>Áä∂ÊÄÅ</TableHead>
                  <TableHead>Â§áÊ≥®</TableHead>
                  <TableHead className="text-right">Êìç‰Ωú</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {filteredRequests.map((request) => (
                  <TableRow key={request.id}>
                    <TableCell>
                      <Checkbox
                        checked={isSelected(request.id)}
                        onCheckedChange={() => handleSelectItem(request.id)}
                      />
                    </TableCell>
                    <TableCell className="font-medium">{request.request_id}</TableCell>
                    <TableCell>{format(new Date(request.created_at), 'yyyy-MM-dd HH:mm')}</TableCell>
                    <TableCell>{request.record_count}</TableCell>
                    <TableCell>{getStatusBadge(request.status)}</TableCell>
                    <TableCell>{request.notes || '-'}</TableCell>
                    <TableCell className="text-right">
                      <div className="flex items-center justify-end gap-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            setSelectedRequest(request);
                            setIsDetailDialogOpen(true);
                            fetchRequestDetails(request);
                          }}
                        >
                          <FileText className="h-4 w-4 mr-1" />
                          ËØ¶ÊÉÖ
                        </Button>
                        {request.status === 'Pending' && (isAdmin || isFinance) && (
                          <>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => {
                                setSelectedRequest(request);
                                setIsApprovalDialogOpen(true);
                              }}
                            >
                              <Banknote className="h-4 w-4 mr-1" />
                              ÂÆ°Ê†∏
                            </Button>
                            <Button
                              variant="destructive"
                              size="sm"
                              onClick={() => {
                                setSelectedRequest(request);
                                setIsVoidDialogOpen(true);
                              }}
                            >
                              <Trash2 className="h-4 w-4 mr-1" />
                              ‰ΩúÂ∫ü
                            </Button>
                          </>
                        )}
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>

      {/* ËØ¶ÊÉÖÂØπËØùÊ°Ü */}
      <Dialog open={isDetailDialogOpen} onOpenChange={setIsDetailDialogOpen}>
        <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Áî≥ËØ∑ËØ¶ÊÉÖ - {selectedRequest?.request_id}</DialogTitle>
          </DialogHeader>
          {loadingDetails ? (
            <div className="flex items-center justify-center py-8">
              <Loader2 className="h-8 w-8 animate-spin" />
              <span className="ml-2">Âä†ËΩΩËØ¶ÊÉÖ‰∏≠...</span>
            </div>
          ) : (
            <div className="space-y-6">
              {/* ËøêÂçïËØ¶ÊÉÖ */}
              <div>
                <h3 className="text-lg font-semibold mb-4">ËøêÂçïËØ¶ÊÉÖ</h3>
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>ËøêÂçïÂè∑</TableHead>
                      <TableHead>Âè∏Êú∫</TableHead>
                      <TableHead>ËΩ¶ÁâåÂè∑</TableHead>
                      <TableHead>Ë∑ØÁ∫ø</TableHead>
                      <TableHead>Ë£ÖË¥ßÊó•Êúü</TableHead>
                      <TableHead>Ë£ÖË¥ßÈáçÈáè</TableHead>
                      <TableHead>Â∫î‰ªòÈáëÈ¢ù</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {recordDetails.map((record) => (
                      <TableRow key={record.id}>
                        <TableCell>{record.auto_number}</TableCell>
                        <TableCell>{record.driver_name}</TableCell>
                        <TableCell>{record.license_plate}</TableCell>
                        <TableCell>{record.loading_location} ‚Üí {record.unloading_location}</TableCell>
                        <TableCell>{format(new Date(record.loading_date), 'yyyy-MM-dd')}</TableCell>
                        <TableCell>{record.loading_weight ? `${record.loading_weight}Âê®` : '-'}</TableCell>
                        <TableCell>¬•{record.payable_amount?.toFixed(2) || '0.00'}</TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>

              {/* Âêà‰ΩúÊñπÊ±áÊÄª */}
              {partnerTotals.length > 0 && (
                <div>
                  <h3 className="text-lg font-semibold mb-4">Âêà‰ΩúÊñπÊ±áÊÄª</h3>
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>Âêà‰ΩúÊñπ</TableHead>
                        <TableHead>Á∫ßÂà´</TableHead>
                        <TableHead>Â∫î‰ªòÈáëÈ¢ù</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {partnerTotals.map((partner) => (
                        <TableRow key={partner.partner_id}>
                          <TableCell>{partner.partner_name}</TableCell>
                          <TableCell>{partner.level}Á∫ß</TableCell>
                          <TableCell>¬•{partner.total_amount.toFixed(2)}</TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÂÆ°Ê†∏ÂØπËØùÊ°Ü */}
      <Dialog open={isApprovalDialogOpen} onOpenChange={setIsApprovalDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>ÂÆ°Ê†∏Áî≥ËØ∑ - {selectedRequest?.request_id}</DialogTitle>
          </DialogHeader>
          <PaymentApproval
            request={selectedRequest}
            onApprove={async (notes) => {
              if (selectedRequest) {
                await handleStatusUpdate(selectedRequest.id, 'Approved', notes);
                setIsApprovalDialogOpen(false);
              }
            }}
            onReject={async (notes) => {
              if (selectedRequest) {
                await handleStatusUpdate(selectedRequest.id, 'Rejected', notes);
                setIsApprovalDialogOpen(false);
              }
            }}
            onCancel={() => setIsApprovalDialogOpen(false)}
          />
        </DialogContent>
      </Dialog>

      {/* ‰ΩúÂ∫üÁ°ÆËÆ§ÂØπËØùÊ°Ü */}
      <ConfirmDialog
        open={isVoidDialogOpen}
        onOpenChange={setIsVoidDialogOpen}
        title="Á°ÆËÆ§‰ΩúÂ∫ü"
        description={`Á°ÆÂÆöË¶Å‰ΩúÂ∫üÁî≥ËØ∑Âçï ${selectedRequest?.request_id} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`}
        onConfirm={async () => {
          if (selectedRequest) {
            await handleStatusUpdate(selectedRequest.id, 'Rejected', 'Â∑≤‰ΩúÂ∫ü');
            setIsVoidDialogOpen(false);
          }
        }}
        confirmText="Á°ÆËÆ§‰ΩúÂ∫ü"
        cancelText="ÂèñÊ∂à"
        variant="destructive"
      />
    </div>
  );
}
