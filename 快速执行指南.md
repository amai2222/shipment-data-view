# å®šä»·æ³•åŠŸèƒ½ - å¿«é€Ÿæ‰§è¡ŒæŒ‡å— âš¡

## âœ… æ›´æ–°çŠ¶æ€

- âœ… **æ•°æ®åº“è¿ç§»æ–‡ä»¶**ï¼š5 ä¸ª SQL æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª
- âœ… **å‰ç«¯å‡½æ•°è°ƒç”¨**ï¼š21 ä¸ªæ–‡ä»¶å·²å…¨éƒ¨æ›´æ–°ä¸º `_1120` åç¼€
- âœ… **ç±»å‹å®šä¹‰**ï¼šå·²æ·»åŠ  `unitPrice` å’Œ `fixed_price` æ”¯æŒ
- âœ… **ç•Œé¢ç»„ä»¶**ï¼šå·²æ·»åŠ å®šä»·æ³•é€‰é¡¹å’Œå•ä½æ˜¾ç¤º

---

## ğŸ¯ éœ€è¦æ‰§è¡Œçš„ SQL æ–‡ä»¶ï¼ˆ8ä¸ªï¼ŒæŒ‰é¡ºåºï¼‰

### âœ… æ–¹å¼ä¸€ï¼šSupabase CLIï¼ˆæœ€ç®€å•ï¼‰

```bash
cd C:\Users\admin\Desktop\ä¸­ç§‘ç‰©æµè·Ÿè¸ªç³»ç»Ÿé€»è¾‘\github\shipment-data-view
supabase db push
```

**è¯´æ˜**ï¼šè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æœªåº”ç”¨çš„è¿ç§»æ–‡ä»¶ï¼Œæ¨èï¼

---

### âœ… æ–¹å¼äºŒï¼šæ‰‹åŠ¨æ‰§è¡Œï¼ˆSupabase SQL Editorï¼‰

åœ¨ Supabase Dashboard â†’ SQL Editor ä¸­ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œï¼š

#### 1ï¸âƒ£ åŸºç¡€å­—æ®µ
```
supabase/migrations/20251120_add_fixed_price_calculation_method.sql
```
**ä½œç”¨**ï¼šæ·»åŠ  `unit_price` å­—æ®µï¼Œæ›´æ–°çº¦æŸ

---

#### 2ï¸âƒ£ æ ¸å¿ƒé‡ç®—å‡½æ•°
```
supabase/migrations/20251120_update_recalculate_functions_support_fixed_price.sql
```
**ä½œç”¨**ï¼šæ›´æ–° `batch_recalculate_partner_costs` å’Œ `auto_recalc_on_payable_cost_change`

---

#### 3ï¸âƒ£ æœ‰æ•ˆæ•°é‡è§¦å‘å™¨
```
supabase/migrations/20251120_add_trigger_recalc_on_effective_quantity_change.sql
```
**ä½œç”¨**ï¼šåˆ›å»ºæœ‰æ•ˆæ•°é‡å˜åŒ–æ—¶çš„è‡ªåŠ¨é‡ç®—è§¦å‘å™¨

---

#### 4ï¸âƒ£ é“¾è·¯é‡ç®—å‡½æ•°
```
supabase/migrations/20251120_update_all_recalc_functions_to_1120_with_fixed_price.sql
```
**ä½œç”¨**ï¼šåˆ›å»ºæ‰€æœ‰ `_1120` ç‰ˆæœ¬çš„é“¾è·¯é‡ç®—å‡½æ•°

---

#### 5ï¸âƒ£ ç‰¹æ®Šæ“ä½œå‡½æ•°
```
supabase/migrations/20251120_update_modify_and_batch_filter_to_1120.sql
```
**ä½œç”¨**ï¼šåˆ›å»º `modify_logistics_record_chain_with_recalc_1120` å’Œ `batch_recalculate_by_filter_1120`

---

#### 6ï¸âƒ£ ç­›é€‰å‡½æ•°ï¼ˆä¿®å¤é¡µé¢æŠ¥é”™ï¼‰
```
supabase/migrations/20251120_create_filtered_functions_1120.sql
```
**ä½œç”¨**ï¼šåˆ›å»º `get_payment_requests_filtered_1120` å’Œ `get_invoice_requests_filtered_1120`ï¼Œä¿®å¤å‰ç«¯é¡µé¢æŠ¥é”™

---

#### 7ï¸âƒ£ æ”¶æ¬¾å‡½æ•°ï¼ˆä¿®å¤æ”¶æ¬¾æŠ¥è¡¨æŠ¥é”™ï¼‰
```
supabase/migrations/20251120_create_receipt_functions_1120.sql
```
**ä½œç”¨**ï¼šåˆ›å»º `get_receipt_statistics_1120` å’Œ `get_receipt_details_report_1120`ï¼Œä¿®å¤æ”¶æ¬¾æŠ¥è¡¨é¡µé¢æŠ¥é”™

---

#### 8ï¸âƒ£ è´¢åŠ¡å¯¹è´¦å‡½æ•°ï¼ˆä¿®å¤å¯¹è´¦ç®¡ç†é¡µé¢æŠ¥é”™ï¼‰
```
supabase/migrations/20251120_create_finance_reconciliation_function_1120.sql
```
**ä½œç”¨**ï¼šåˆ›å»º `get_finance_reconciliation_by_partner_1120`ï¼Œä¿®å¤å¯¹è´¦ç®¡ç†é¡µé¢æŠ¥é”™

---

## ğŸ›¡ï¸ ä¿æŠ¤é€»è¾‘è¯´æ˜ï¼ˆé‡è¦ï¼ï¼‰

### âœ… æ­£ç¡®ç†è§£

**åªæœ‰åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶çš„è¿å•æ‰ä¼šè¢«é‡ç®—**ï¼š

1. âœ… `payment_status = 'Unpaid'`ï¼ˆæœªä»˜æ¬¾ï¼‰
2. âœ… `invoice_status = 'Uninvoiced'`ï¼ˆæœªå¼€ç¥¨ï¼‰
3. âœ… `receipt_status = 'Unreceived'`ï¼ˆæœªæ”¶æ¬¾ï¼‰

### ğŸ” SQL é€»è¾‘è§£é‡Š

```sql
-- æ£€æŸ¥æ¡ä»¶
IF payment_status != 'Unpaid'               -- å·²ä»˜æ¬¾ï¼Ÿ
   OR invoice_status != 'Uninvoiced'        -- æˆ– å·²å¼€ç¥¨ï¼Ÿ
   OR receipt_status = 'Received' THEN      -- æˆ– å·²æ”¶æ¬¾ï¼Ÿ
    -- åªè¦æœ‰ä¸€ä¸ªæ˜¯"æ˜¯"ï¼Œå°±è·³è¿‡é‡ç®—
    CONTINUE;
END IF;

-- å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ï¼š
-- payment_status = 'Unpaid' AND 
-- invoice_status = 'Uninvoiced' AND 
-- receipt_status = 'Unreceived'
-- â†’ å…è®¸é‡ç®— âœ…
```

### ğŸ“Š å„ç§çŠ¶æ€å¯¹ç…§è¡¨

| ä»˜æ¬¾çŠ¶æ€ | å¼€ç¥¨çŠ¶æ€ | æ”¶æ¬¾çŠ¶æ€ | æ˜¯å¦é‡ç®— |
|---------|---------|---------|---------|
| æœªä»˜æ¬¾ | æœªå¼€ç¥¨ | æœªæ”¶æ¬¾ | âœ… **å…è®¸** |
| **å·²ä»˜æ¬¾** | æœªå¼€ç¥¨ | æœªæ”¶æ¬¾ | âŒ è·³è¿‡ |
| æœªä»˜æ¬¾ | **å·²å¼€ç¥¨** | æœªæ”¶æ¬¾ | âŒ è·³è¿‡ |
| æœªä»˜æ¬¾ | æœªå¼€ç¥¨ | **å·²æ”¶æ¬¾** | âŒ è·³è¿‡ |
| **å·²ä»˜æ¬¾** | **å·²å¼€ç¥¨** | æœªæ”¶æ¬¾ | âŒ è·³è¿‡ |
| æœªä»˜æ¬¾ | **å·²å¼€ç¥¨** | **å·²æ”¶æ¬¾** | âŒ è·³è¿‡ |
| **å·²ä»˜æ¬¾** | æœªå¼€ç¥¨ | **å·²æ”¶æ¬¾** | âŒ è·³è¿‡ |
| **å·²ä»˜æ¬¾** | **å·²å¼€ç¥¨** | **å·²æ”¶æ¬¾** | âŒ è·³è¿‡ |

**ç»“è®º**ï¼šåªæœ‰ç¬¬ä¸€è¡Œï¼ˆå…¨éƒ¨æœªXï¼‰æ‰ä¼šé‡ç®—ï¼

---

## âœ… éªŒè¯ï¼ˆæ‰§è¡Œå®Œåè¿è¡Œï¼‰

```sql
-- 1. æ£€æŸ¥å­—æ®µ
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'project_partners' AND column_name = 'unit_price';
-- åº”è¿”å› 1 è¡Œ

-- 2. æ£€æŸ¥å‡½æ•°ï¼ˆåº”è¿”å› 14 è¡Œï¼‰
SELECT proname FROM pg_proc 
WHERE proname IN (
    'batch_recalculate_partner_costs',
    'auto_recalc_on_payable_cost_change',
    'auto_recalc_on_effective_quantity_or_cost_change',
    'recalculate_costs_for_chain_1120',
    'recalculate_costs_for_chain_safe_1120',
    'recalculate_costs_for_project_1120',
    'auto_recalc_on_project_partner_change_1120',
    'modify_logistics_record_chain_with_recalc_1120',
    'batch_recalculate_by_filter_1120',
    'get_payment_requests_filtered_1120',
    'get_invoice_requests_filtered_1120',
    'get_receipt_statistics_1120',
    'get_receipt_details_report_1120',
    'get_finance_reconciliation_by_partner_1120'
);

-- 3. æ£€æŸ¥è§¦å‘å™¨ï¼ˆåº”è¿”å› 3 è¡Œï¼‰
SELECT tgname FROM pg_trigger WHERE tgname LIKE '%recalc%';
```

---

## ğŸ‰ å®Œæˆï¼

æ‰§è¡Œå®Œæˆåï¼Œå‰ç«¯å³å¯ä½¿ç”¨å®šä»·æ³•åŠŸèƒ½ï¼š

1. æ‰“å¼€é¡¹ç›®ç®¡ç†é¡µé¢
2. åˆ›å»º/ç¼–è¾‘é¡¹ç›®
3. é€‰æ‹©"å®šä»·"è®¡ç®—æ–¹æ³•
4. è¾“å…¥å•ä»·ï¼ˆå•ä½ä¼šæ ¹æ®è®¡è´¹æ¨¡å¼è‡ªåŠ¨æ˜¾ç¤ºï¼šå…ƒ/å¨ã€å…ƒ/è½¦ã€å…ƒ/æ–¹ã€å…ƒ/ä»¶ï¼‰
5. ä¿å­˜

---

## ğŸ“ é‡åˆ°é—®é¢˜ï¼Ÿ

### å¸¸è§é”™è¯¯

**"column already exists"**
- è¯´æ˜è¯¥è¿ç§»å·²æ‰§è¡Œï¼Œè·³è¿‡å³å¯

**"function does not exist"**
- è¯´æ˜å‰é¢çš„æ–‡ä»¶æœªæ‰§è¡Œï¼Œè¯·æŒ‰é¡ºåºæ‰§è¡Œ

**é‡ç®—æ²¡æœ‰è§¦å‘**
- æ£€æŸ¥è¿å•çŠ¶æ€ï¼šå¿…é¡»æ˜¯æœªä»˜æ¬¾ AND æœªå¼€ç¥¨ AND æœªæ”¶æ¬¾

---

**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-20  
**æœ€åæ›´æ–°**ï¼š2025-11-20

