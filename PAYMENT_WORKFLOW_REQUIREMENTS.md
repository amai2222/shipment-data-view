# 付款流程需求文档

## 正确的付款流程

### 步骤1：创建付款申请
**操作位置**：运单管理页面
- **操作**：未支付运单 → 点击"付款申请"按钮
- **运单状态变化**：`未支付` → `已申请支付`
- **付款申请单状态**：`待审核`（Pending）

### 步骤2：审核付款申请
**操作位置**：付款审核页面（审核管理 → 付款审核）
- **操作**：点击"审核"或"一键审核"按钮
- **运单状态变化**：`已申请支付` → `支付审核通过`
- **付款申请单状态**：`待审核`（Pending）→ `待支付`（Approved）

### 步骤3：执行付款
**操作位置**：财务付款页面（财务管理 → 财务付款）
- **操作**：点击"付款"或"一键付款"按钮
- **运单状态变化**：`支付审核通过` → `已支付`
- **付款申请单状态**：`待支付`（Approved）→ `已支付`（Paid）

---

## 状态流转图

### 运单付款状态（payment_status）
```
未支付 
  ↓ [步骤1：付款申请]
已申请支付
  ↓ [步骤2：付款审核]
支付审核通过
  ↓ [步骤3：执行付款]
已支付
```

### 付款申请单状态（status）
```
待审核 (Pending)
  ↓ [步骤2：付款审核]
待支付 (Approved)
  ↓ [步骤3：执行付款]
已支付 (Paid)
```

---

## 需要修复的地方

1. ✅ 创建付款申请时的状态设置
2. ✅ 审核按钮的状态流转逻辑
3. ✅ 付款按钮的状态流转逻辑
4. ✅ 运单状态和申请单状态的同步

---

## 涉及的文件

1. **前端页面**：
   - PaymentRequest.tsx（付款申请）
   - PaymentAudit.tsx（付款审核）
   - PaymentRequestsList.tsx（财务付款）

2. **后端函数**：
   - 创建付款申请的RPC函数
   - 审核付款申请的RPC函数
   - 执行付款的RPC函数

---

**我现在开始检查和修复这个流程！**

