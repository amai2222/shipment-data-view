# 审核管理权限配置指南

## 🎯 问题说明
新增的"审核管理"菜单在权限配置中需要为相关角色分配权限，否则管理员看不到菜单。

## ✅ 解决方案

### 1. **代码层面已更新**
- ✅ 更新了 `src/config/permissions.ts` 中的默认角色权限
- ✅ 为管理员、财务、操作员角色添加了审核管理权限
- ✅ 权限项：`audit`, `audit.invoice`, `audit.payment`

### 2. **数据库权限更新**

#### 方法1：使用SQL脚本（推荐）
执行 `审核管理权限快速更新.sql` 脚本：

```sql
-- 更新管理员角色权限
UPDATE role_templates 
SET 
  menu_permissions = array_cat(COALESCE(menu_permissions, '{}'), ARRAY['audit', 'audit.invoice', 'audit.payment']),
  updated_at = NOW()
WHERE role = 'admin';

-- 更新财务角色权限
UPDATE role_templates 
SET 
  menu_permissions = array_cat(COALESCE(menu_permissions, '{}'), ARRAY['audit', 'audit.invoice', 'audit.payment']),
  updated_at = NOW()
WHERE role = 'finance';

-- 更新操作员角色权限
UPDATE role_templates 
SET 
  menu_permissions = array_cat(COALESCE(menu_permissions, '{}'), ARRAY['audit', 'audit.invoice', 'audit.payment']),
  updated_at = NOW()
WHERE role = 'operator';
```

#### 方法2：通过权限配置页面
1. 登录系统（管理员账户）
2. 进入 **设置 → 权限配置**
3. 选择需要配置的用户
4. 在菜单权限中找到"审核管理"
5. 勾选相关权限项
6. 保存配置

### 3. **权限配置说明**

#### 审核管理权限项：
- **`audit`** - 审核管理主菜单权限
- **`audit.invoice`** - 开票审核权限
- **`audit.payment`** - 付款审核权限

#### 角色权限分配：
- **管理员 (admin)**：拥有所有审核管理权限
- **财务 (finance)**：拥有所有审核管理权限
- **操作员 (operator)**：拥有所有审核管理权限
- **业务 (business)**：无审核管理权限
- **查看者 (viewer)**：无审核管理权限
- **合作方 (partner)**：无审核管理权限

## 🔧 技术实现

### 1. **权限系统架构**
```
用户权限 = 用户自定义权限 || 角色模板权限 || 默认角色权限
```

### 2. **权限检查流程**
1. 检查用户是否有自定义权限
2. 如果没有，使用角色模板权限
3. 如果角色模板没有，使用默认角色权限

### 3. **菜单显示逻辑**
- 菜单项根据用户权限动态显示
- 只有拥有相应权限的用户才能看到菜单
- 权限检查在 `AppSidebar.tsx` 中实现

## 📋 验证步骤

### 1. **检查角色模板权限**
```sql
SELECT role, menu_permissions FROM role_templates 
WHERE role IN ('admin', 'finance', 'operator');
```

### 2. **检查用户权限**
```sql
SELECT 
  u.email,
  u.role,
  up.menu_permissions
FROM users u
LEFT JOIN user_permissions up ON u.id = up.user_id
WHERE u.role IN ('admin', 'finance', 'operator');
```

### 3. **前端验证**
1. 登录管理员账户
2. 检查左侧菜单是否显示"审核管理"
3. 点击菜单项，确认可以正常访问
4. 测试权限控制是否正常

## 🚀 使用说明

### 1. **管理员使用**
- 可以访问所有审核管理功能
- 可以配置其他用户的审核权限
- 可以查看审核日志和统计

### 2. **财务人员使用**
- 可以访问付款审核功能
- 可以审核付款申请
- 可以查看开票审核（开发中）

### 3. **操作员使用**
- 可以访问付款审核功能
- 可以协助审核付款申请
- 可以查看开票审核（开发中）

## ⚠️ 注意事项

### 1. **权限继承**
- 如果用户有自定义权限，会覆盖角色模板权限
- 建议先更新角色模板，再检查用户自定义权限

### 2. **权限缓存**
- 权限更新后可能需要刷新页面
- 建议清除浏览器缓存后重新登录

### 3. **数据库备份**
- 执行SQL脚本前建议备份数据库
- 特别是 `role_templates` 和 `user_permissions` 表

## 🎉 完成验证

执行以下步骤验证配置是否成功：

1. **执行SQL脚本**：运行 `审核管理权限快速更新.sql`
2. **刷新页面**：清除缓存并重新登录
3. **检查菜单**：确认"审核管理"菜单显示
4. **测试功能**：访问付款审核和开票审核页面
5. **权限验证**：确认只有有权限的用户才能访问

**配置完成后，管理员、财务和操作员用户应该能够看到并使用审核管理功能！** 🚀
