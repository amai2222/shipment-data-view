# 付款申请页面动态显示合作方层级功能完成

## ✅ 功能说明

**需求**：付款申请页面默认只显示最高级合作方列，提供"展示全部"按钮来显示其他层级。

## 🎯 实现效果

### 默认状态（仅显示最高级）

```
表头：
┌─────────┬─────┬────┬────┬─────┬────┬─────┬────────┬─────────┬──────┬────────┬────────┐
│ 选择框  │运单 │项目│司机│路线 │数量│日期 │司机应收│中粮可乐│合作链路│支付状态│
│         │编号 │    │    │     │    │     │        │(3级)   │        │        │
└─────────┴─────┴────┴────┴─────┴────┴─────┴────────┴─────────┴──────┴────────┴────────┘

说明：只显示最高级（3级）合作方的列
```

### 展示全部状态

```
表头：
┌─────────┬─────┬────┬────┬─────┬────┬─────┬────────┬────────┬────────┬────────┬─────────┬──────┬────────┬────────┐
│ 选择框  │运单 │项目│司机│路线 │数量│日期 │司机应收│山西成丰│张海宽  │数创    │中粮可乐│合作链路│支付状态│
│         │编号 │    │    │     │    │     │        │(1级)   │(1级)   │(2级)   │(3级)   │        │        │
└─────────┴─────┴────┴────┴─────┴────┴─────┴────────┴────────┴────────┴────────┴─────────┴──────┴────────┴────────┘

说明：显示所有层级的合作方列
```

## 🔧 实现细节

### 1. 添加状态控制

```typescript
const [showAllLevels, setShowAllLevels] = useState(false);
```

**默认值**：`false` - 默认只显示最高级

### 2. 修改动态列计算逻辑

```typescript
const displayedPartners = useMemo(() => {
  // 如果筛选了特定合作方，只显示该合作方
  if (uiFilters.partnerId !== "all") {
    const selected = allPartners.find(p => p.id === uiFilters.partnerId);
    return selected ? [selected] : [];
  }
  
  if (!reportData || !Array.isArray(reportData.records)) return [];
  
  // 计算相关的合作方和最高级别
  const relevantPartnerIds = new Set<string>();
  let maxLevel = 0;
  reportData.records.forEach((record: any) => {
    if (record && Array.isArray(record.partner_costs)) {
      record.partner_costs.forEach((cost: any) => {
        relevantPartnerIds.add(cost.partner_id);
        if (cost.level > maxLevel) {
          maxLevel = cost.level;
        }
      });
    }
  });
  
  const filteredPartners = allPartners
    .filter(partner => relevantPartnerIds.has(partner.id))
    .sort((a, b) => a.level - b.level);
  
  // ✅ 根据 showAllLevels 决定是否只显示最高级
  if (!showAllLevels && maxLevel > 0) {
    return filteredPartners.filter(p => p.level === maxLevel);
  }
  return filteredPartners;
}, [reportData, allPartners, uiFilters.partnerId, showAllLevels]);
```

**关键逻辑**：
- 计算当前数据中的最高级别 `maxLevel`
- 如果 `!showAllLevels`：只显示 `level === maxLevel` 的合作方
- 如果 `showAllLevels`：显示所有级别的合作方

### 3. 添加切换按钮

```tsx
<CardHeader className="flex flex-row items-center justify-between">
  <div>
    <CardTitle>运单财务明细</CardTitle>
    <p className="text-sm text-muted-foreground">
      {showAllLevels ? '显示所有层级的合作方' : '仅显示最高级合作方'}
    </p>
  </div>
  <Button 
    variant="outline" 
    size="sm" 
    onClick={() => setShowAllLevels(!showAllLevels)}
  >
    {showAllLevels ? '仅显示最高级' : '展示全部级别'}
  </Button>
</CardHeader>
```

**按钮位置**：表格标题右侧（符合现有设计风格）

## 📊 使用场景

### 场景1：快速查看最终付款方

**默认状态**（仅显示最高级）：
- ✅ 快速了解最终需要付款的合作方
- ✅ 表格更简洁，易于阅读
- ✅ 适合日常财务操作

### 场景2：查看完整的成本结构

**展示全部状态**：
- ✅ 查看所有层级的合作方
- ✅ 了解完整的成本分摊
- ✅ 适合审计和详细分析

## 🎨 交互设计

### 按钮状态

- **默认**：显示"展示全部级别"按钮
  - 点击后 → 显示所有层级
  - 按钮文字变为"仅显示最高级"

- **展示全部**：显示"仅显示最高级"按钮
  - 点击后 → 只显示最高级
  - 按钮文字变为"展示全部级别"

### 描述文字动态更新

- 默认：`仅显示最高级合作方`
- 展示全部：`显示所有层级的合作方`

## 🔍 特殊处理

### 筛选特定合作方时

当用户在筛选器中选择特定合作方时：
```typescript
if (uiFilters.partnerId !== "all") {
  const selected = allPartners.find(p => p.id === uiFilters.partnerId);
  return selected ? [selected] : [];
}
```

**行为**：
- ✅ 始终只显示被筛选的合作方
- ✅ 忽略"展示全部"按钮的状态
- ✅ 符合筛选逻辑的优先级

### 无数据时

```typescript
if (!reportData || !Array.isArray(reportData.records)) return [];
```

**行为**：
- ✅ 返回空数组
- ✅ 不显示任何合作方列
- ✅ 避免空指针错误

## 🧪 测试验证

### 测试用例1：默认显示

1. 打开付款申请页面
2. 搜索运单数据
3. ✅ **验证**：只显示最高级合作方列（如：中粮可乐 3级）

### 测试用例2：展示全部

1. 点击"展示全部级别"按钮
2. ✅ **验证**：显示所有层级的合作方列（如：山西成丰 1级、张海宽 1级、数创 2级、中粮可乐 3级）

### 测试用例3：切换回仅显示最高级

1. 在展示全部状态下
2. 点击"仅显示最高级"按钮
3. ✅ **验证**：只显示最高级合作方列

### 测试用例4：筛选特定合作方

1. 在筛选器中选择"山西成丰"
2. 点击搜索
3. ✅ **验证**：只显示山西成丰列（忽略展示全部按钮）

### 测试用例5：切换状态保持

1. 点击"展示全部级别"
2. 切换到其他页码
3. ✅ **验证**：仍然显示所有层级（状态保持）

## 📱 响应式设计

按钮会在小屏幕上自动适应：
- 桌面端：完整按钮文字
- 小屏幕：`size="sm"` 保持紧凑

## 🎯 符合现有设计原则

1. ✅ **动态列显示** - 使用 `displayedPartners` 动态计算
2. ✅ **状态管理** - 使用 `useState` 和 `useMemo`
3. ✅ **用户体验** - 默认简洁，按需展开
4. ✅ **性能优化** - `useMemo` 避免不必要的重新计算
5. ✅ **UI一致性** - 按钮样式和位置符合现有设计

## 📋 修改文件

- ✅ `src/pages/PaymentRequest.tsx`

## 🎉 功能特点

1. **默认简洁** - 只显示最重要的信息（最高级合作方）
2. **按需展开** - 需要详细信息时展示全部
3. **状态记忆** - 切换状态在当前会话中保持
4. **智能筛选** - 与现有筛选器配合良好

---

**功能已完成**！现在付款申请页面默认只显示最高级合作方，用户可以点击按钮展示全部层级。✅

