# 开票申请和审核页面运单详情查询修复说明

## 问题描述

在开票申请单管理页面和开票审核页面，点击运单记录查看详情时报错：

```
获取详情失败
Could not embed because more than one relationship was found for 'invoice_request_details' and 'logistics_record_id'
```

## 问题原因

在 `src/integrations/supabase/types.ts` 文件中，`invoice_request_details` 表的 `logistics_record_id` 字段存在多个外键关系定义：

1. `logistics_records` (主表)
2. `logistics_records_status_summary` (视图)
3. `logistics_records_view` (视图)

这三个关系都使用了同一个外键名 `invoice_request_details_logistics_record_id_fkey`，导致当使用 Supabase 的嵌套查询（如 `projects (id, name), drivers (id, name)`）时，系统无法确定应该使用哪个关系进行数据关联。

## 修复方案

修改以下文件中的查询函数，将原来的嵌套查询改为分步查询：

### 开票申请单管理页面

1. **桌面端页面**：`src/pages/InvoiceRequestManagement.tsx`
   - 修改 `fetchFullLogisticsRecord` 函数（第600-675行）

2. **移动端页面**：`src/pages/mobile/MobileInvoiceRequestManagement.tsx`
   - 修改 `fetchFullLogisticsRecord` 函数（第640-715行）

### 开票审核页面

3. **开票审核页面**：`src/pages/InvoiceAudit.tsx`
   - 修改 `handleViewDetails` 函数（第402-482行）

### 修改前（有问题的代码）

**方式1：直接嵌套查询项目和司机**
```typescript
const { data, error } = await supabase
  .from('logistics_records')
  .select(`
    id,
    auto_number,
    ...
    projects (id, name, auto_code),
    drivers (id, name, license_plate, phone, ...)
  `)
  .eq('id', recordId)
  .single();
```

**方式2：通过外键关系嵌套查询运单**
```typescript
const { data, error } = await supabase
  .from('invoice_request_details')
  .select(`
    *,
    logistics_records:logistics_record_id (
      id,
      auto_number,
      driver_name,
      ...
    )
  `)
  .eq('invoice_request_id', request.id);
```

### 修改后（正确的代码）

**方式1：查询单个运单详情（用于开票申请单管理）**
```typescript
// 1. 先查询运单基本信息
const { data: logisticsData, error: logisticsError } = await supabase
  .from('logistics_records')
  .select('*')
  .eq('id', recordId)
  .single();

// 2. 分别查询项目信息
if (logisticsData.project_id) {
  const { data: projectData } = await supabase
    .from('projects')
    .select('id, name, auto_code')
    .eq('id', logisticsData.project_id)
    .single();
  projectName = projectData?.name || '';
}

// 3. 分别查询司机信息
if (logisticsData.driver_id) {
  const { data: driverData } = await supabase
    .from('drivers')
    .select('id, name, license_plate, phone, ...')
    .eq('id', logisticsData.driver_id)
    .single();
  driverInfo = driverData || {};
}
```

**方式2：批量查询多个运单（用于开票审核页面）**
```typescript
// 1. 先查询开票申请详情
const { data: detailsData } = await supabase
  .from('invoice_request_details')
  .select('*')
  .eq('invoice_request_id', request.id);

// 2. 获取所有运单ID
const logisticsRecordIds = detailsData.map(d => d.logistics_record_id);

// 3. 批量查询运单信息
const { data: logisticsData } = await supabase
  .from('logistics_records')
  .select('id, auto_number, driver_name, ...')
  .in('id', logisticsRecordIds);

// 4. 创建映射并组合数据
const logisticsMap = new Map(logisticsData?.map(l => [l.id, l]) || []);
const detailedRecords = detailsData.map(detail => {
  const record = logisticsMap.get(detail.logistics_record_id);
  return { ...record, /* 其他字段 */ };
});
```

## 修复效果

- ✅ 开票申请单管理页面（桌面端）运单详情查询不再报错
- ✅ 开票申请单管理页面（移动端）运单详情查询不再报错
- ✅ 开票审核页面运单详情查询不再报错
- ✅ 能够正常打开运单详情对话框
- ✅ 所有相关信息（项目、司机、运单数据）正常显示
- ✅ 代码更清晰，易于维护
- ✅ 使用批量查询优化性能（开票审核页面）

## 其他影响

检查了以下页面，确认没有类似问题：
- ✅ 付款申请页面 (`PaymentRequest.tsx`)
- ✅ 付款申请列表页面 (`PaymentRequestsList.tsx`)
- ✅ 付款审核页面 (`PaymentAudit.tsx`)

## 测试建议

### 开票申请单管理页面（桌面端）

1. 打开开票申请单管理页面
2. 点击任意申请单，查看详情对话框
3. 在详情对话框的运单明细列表中，点击任意运单记录
4. 确认运单详情对话框正常打开，所有信息正常显示

### 开票申请单管理页面（移动端）

1. 打开移动端开票申请单管理页面
2. 点击任意申请单，查看详情
3. 在详情页面的运单明细列表中，点击任意运单记录
4. 确认运单详情对话框正常打开，所有信息正常显示

### 开票审核页面

1. 打开开票审核页面
2. 点击任意开票申请单，查看详情对话框
3. 确认运单明细列表正常显示，包含运单号、司机、车牌、路线等信息
4. 确认汇总金额显示正确

## 注意事项

如果将来在其他页面遇到类似的 "more than one relationship was found" 错误，可以参考本次修复方案：
- 避免使用 Supabase 的嵌套查询语法
- 改用分步查询的方式
- 分别查询各个关联表的数据
- 手动组合查询结果

---

修复日期：2025-10-27

修复文件：
- `src/pages/InvoiceRequestManagement.tsx`（开票申请单管理-桌面端）
- `src/pages/mobile/MobileInvoiceRequestManagement.tsx`（开票申请单管理-移动端）
- `src/pages/InvoiceAudit.tsx`（开票审核页面）

