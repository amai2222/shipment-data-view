# 批量修改应收和链路功能实现完成

## ✅ 完成内容

### 后端功能
1. ✅ 创建批量修改应收的RPC函数（`batch_modify_partner_cost`）
2. ✅ 创建批量修改链路的RPC函数（`batch_modify_chain`）
3. ✅ 修复单个链路修改的重算逻辑（使用标准算法）

### 前端功能
1. ✅ 添加批量修改的状态管理
2. ✅ 添加批量修改应收的处理函数
3. ✅ 添加批量修改链路的处理函数
4. ✅ 在UI中添加批量操作按钮
5. ✅ 创建批量修改应收的对话框
6. ✅ 创建批量修改链路的对话框

---

## 📦 需要部署的文件

### 必须按顺序执行以下两个SQL：

#### 1️⃣ 先执行（修复单个链路修改）
**文件**：`合作链路修改-使用正确重算逻辑.sql`

**作用**：
- 修复权限检查函数（使用英文角色枚举）
- 修复链路修改函数（使用正确的重算逻辑）
- 修正基础金额计算（current_cost + extra_cost）
- 修正计算方法名称（英文枚举）

#### 2️⃣ 再执行（添加批量操作功能）
**文件**：`supabase/migrations/20251025_add_batch_modify_functions.sql`

**作用**：
- 创建批量修改应收函数
- 创建批量修改链路函数

---

## 🎯 使用方法

### 批量修改应收

1. 在付款审核页面勾选要修改的运单
2. 点击**"批量修改应收"**按钮
3. 输入新的应付金额
4. 点击**"确认修改"**

**示例**：
- 选中5条运单
- 输入金额：3500
- 系统会将这5条运单的最高级合作方应付金额都改为3500元

### 批量修改合作链路

1. 在付款审核页面勾选要修改的运单（必须是同一项目）
2. 点击**"批量修改链路"**按钮
3. 从下拉列表选择新的合作链路
4. 点击**"确认修改"**

**示例**：
- 选中3条运单（都属于"中粮可乐"项目）
- 选择链路："线下张海宽"
- 系统会：
  - 删除旧的合作方成本记录
  - 更新运单的链路ID
  - 根据新链路配置重新计算所有合作方成本

---

## 🔐 权限要求

所有修改操作都需要以下角色之一：
- 管理员 (admin)
- 财务 (finance)
- 操作员 (operator)

---

## 📊 功能对比

| 功能 | 单个操作 | 批量操作 |
|------|----------|----------|
| **修改应收** | ✅ 支持 | ✅ 支持 |
| **修改链路** | ✅ 支持 | ✅ 支持 |
| **自动重算成本** | ✅ 支持 | ✅ 支持 |
| **状态检查** | ✅ 支持 | ✅ 支持 |
| **权限检查** | ✅ 支持 | ✅ 支持 |
| **错误处理** | ✅ 单条提示 | ✅ 汇总统计 |
| **失败详情** | ✅ 直接显示 | ✅ 控制台输出 |

---

## 🎨 UI界面

### 批量操作按钮
选择运单后，在筛选器下方显示：

```
┌──────────────────────────────────────────────────────┐
│ 已选择 3 条记录  [清除选择]                          │
│                    [批量修改应收] [批量修改链路]      │
└──────────────────────────────────────────────────────┘
```

### 批量修改应收对话框
```
┌─────────────────────────────┐
│ 🟢 批量修改应收              │
│ 已选择 3 条运单              │
├─────────────────────────────┤
│ 新的最高级应付金额 (¥)       │
│ [    3500.00    ]           │
│                             │
│ ⚠️ 注意：                   │
│ • 只会修改最高级合作方       │
│ • 只能修改未支付且未开票     │
│ • 已申请付款的将被跳过       │
├─────────────────────────────┤
│        [取消] [确认修改]     │
└─────────────────────────────┘
```

### 批量修改链路对话框
```
┌─────────────────────────────┐
│ 🟣 批量修改合作链路          │
│ 已选择 3 条运单              │
├─────────────────────────────┤
│ 选择合作链路                │
│ [线下张海宽 ▼]             │
│                             │
│ 💡 提示：                   │
│ • 修改后将自动重新计算成本   │
│ • 只能修改未支付且未开票     │
│ • 必须属于同一个项目         │
├─────────────────────────────┤
│        [取消] [确认修改]     │
└─────────────────────────────┘
```

---

## ⚠️ 注意事项

### 1. 批量修改链路的项目限制
所选运单必须属于同一个项目，因为：
- 不同项目的合作链路配置不同
- 系统会读取第一条运单的项目，加载该项目的链路列表

**如果需要修改不同项目的运单**：
- 分批操作，每次只选择同一项目的运单

### 2. 失败运单的处理
批量操作会跳过以下运单：
- 已申请付款的运单
- 已完成付款的运单
- 已申请开票的运单
- 已完成开票的运单
- 链路不存在的运单（修改链路时）
- 无合作方的运单（修改应收时）

失败的运单详细信息会在浏览器控制台输出（按F12查看）。

### 3. 重算逻辑说明
所有成本重算都使用统一的标准逻辑：
- 基础金额 = `current_cost + extra_cost`
- 从低层级到高层级遍历（ORDER BY level ASC）
- 所有层级使用同一个基础金额
- 根据计算方法（profit/tax）计算各自的应付金额

---

## 🔄 与现有功能的关系

### 单个修改功能（保留）
- ✅ 单个修改应收 - 仍然可用
- ✅ 单个修改链路 - 仍然可用

### 批量修改功能（新增）
- ✅ 批量修改应收 - 新增
- ✅ 批量修改链路 - 新增

两种方式互补：
- **单个操作**：适合精细调整
- **批量操作**：适合大量处理

---

## 📈 性能说明

### 批量修改应收
- 性能：快速（直接UPDATE）
- 每条运单约需 10-50ms
- 100条运单约需 1-5秒

### 批量修改链路
- 性能：较慢（需要重新计算成本）
- 每条运单约需 50-200ms
- 100条运单约需 5-20秒

**建议**：
- 批量修改建议每次不超过100条
- 大批量操作可分批进行

---

## ✅ 验证清单

部署后请验证：

- [ ] 执行了两个SQL文件（按顺序）
- [ ] 刷新了浏览器
- [ ] 选择运单后能看到批量操作按钮
- [ ] 批量修改应收功能正常
- [ ] 批量修改链路功能正常
- [ ] 成功/失败统计正确显示
- [ ] 失败运单在控制台有详细信息

---

## 🎉 总结

本次更新为付款审核页面添加了强大的批量操作功能，极大提升了财务人员的工作效率：

- ✅ 批量修改应收 - 快速调整多条运单的应收金额
- ✅ 批量修改链路 - 快速更换多条运单的合作链路
- ✅ 自动重算成本 - 确保数据准确性
- ✅ 智能跳过 - 自动跳过不符合条件的运单
- ✅ 详细反馈 - 成功/失败统计和详细日志

**功能状态**：✅ 开发完成，待部署测试

