# ç”¨æˆ·åŒæ­¥åˆ é™¤ - å®Œæ•´è§£å†³æ–¹æ¡ˆ

> **æœ€åæ›´æ–°**: 2025-11-01  
> **çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éƒ¨ç½²  
> **é—®é¢˜**: ä¿®å¤ auth.users å’Œ profiles è¡¨ä¸åŒæ­¥çš„é—®é¢˜

---

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜æè¿°](#é—®é¢˜æè¿°)
2. [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
3. [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
4. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
5. [é˜²æ­¢å°†æ¥é—®é¢˜](#é˜²æ­¢å°†æ¥é—®é¢˜)

---

## é—®é¢˜æè¿°

### ğŸš¨ ç°è±¡

æ³¨å†Œç”¨æˆ·æ—¶æŠ¥é”™ï¼š
```
AuthApiError: A user with this email address has already been registered
```

ä½†åœ¨ç”¨æˆ·ç®¡ç†ç•Œé¢ï¼ˆprofiles è¡¨ï¼‰ä¸­çœ‹ä¸åˆ°è¯¥ç”¨æˆ·ã€‚

### ğŸ” åŸå› 

Supabase æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„ç”¨æˆ·è¡¨ï¼š

| è¡¨å | ä½œç”¨ | å¯è§æ€§ |
|------|------|--------|
| `auth.users` | è®¤è¯ç³»ç»Ÿè¡¨ | âŒ æ‚¨çœ‹ä¸åˆ° |
| `public.profiles` | ä¸šåŠ¡ä¿¡æ¯è¡¨ | âœ… æ‚¨èƒ½çœ‹åˆ° |

**é—®é¢˜æ ¹æº**ï¼š
- æ—§ä»£ç åˆ é™¤ç”¨æˆ·æ—¶åªåˆ é™¤äº† `profiles`
- æ²¡æœ‰åˆ é™¤ `auth.users`
- å¯¼è‡´ 11 ä¸ªç”¨æˆ·æˆä¸º"å­¤ç«‹ç”¨æˆ·"

---

## è§£å†³æ–¹æ¡ˆ

### âœ… å·²å®Œæˆçš„ä¿®å¤

#### 1. æ¸…ç†äº†ç°æœ‰çš„å­¤ç«‹ç”¨æˆ·
- ä½¿ç”¨æ™ºèƒ½è„šæœ¬æ¸…ç†äº† 11 ä¸ªå­¤ç«‹ç”¨æˆ·
- å°†å…³è”æ•°æ®è½¬ç§»ç»™ admin@example.com
- ç°åœ¨ auth.users å’Œ profiles å®Œå…¨åŒæ­¥ï¼ˆå„ 3 ä¸ªç”¨æˆ·ï¼‰

#### 2. ä¿®å¤äº†å‰ç«¯åˆ é™¤ä»£ç 
- **æ–‡ä»¶**: `src/components/permissions/UserManagement.tsx`
- **ä¿®æ”¹**: æ”¹ä¸ºè°ƒç”¨ Edge Functionï¼Œä¸å†ç›´æ¥åˆ é™¤ profiles

#### 3. æ›´æ–°äº† Edge Function
- **æ–‡ä»¶**: `supabase/functions/delete-user/index.ts`
- **æ–°åŠŸèƒ½**:
  - âœ… è‡ªåŠ¨è½¬ç§»å…³è”æ•°æ®åˆ°ç®¡ç†å‘˜
  - âœ… åŒæ—¶åˆ é™¤ auth.users å’Œ profiles
  - âœ… é˜²æ­¢å¤–é”®çº¦æŸé”™è¯¯
  - âœ… æ”¯æŒè½¯åˆ é™¤ï¼ˆä»…åœç”¨ï¼‰

#### 4. åˆ›å»ºäº†æ™ºèƒ½æ¸…ç†å·¥å…·
- **æ–‡ä»¶**: `scripts/delete_all_orphaned_users_auto.sql`
- **åŠŸèƒ½**: è‡ªåŠ¨å‘ç°æ‰€æœ‰ç›¸å…³è¡¨ï¼Œæ¸…ç†å­¤ç«‹ç”¨æˆ·

---

## éƒ¨ç½²æ­¥éª¤

### ğŸš€ åœ¨ Supabase Dashboard éƒ¨ç½² Edge Function

#### Step 1: ç™»å½•
```
è®¿é—®: https://app.supabase.com
ç™»å½• â†’ é€‰æ‹©é¡¹ç›®
```

#### Step 2: è¿›å…¥ Edge Functions
```
å·¦ä¾§èœå• â†’ Edge Functions â†’ ç‚¹å‡» delete-user
```

#### Step 3: æ›¿æ¢ä»£ç 
```
1. æ‰“å¼€æœ¬åœ°æ–‡ä»¶: supabase/functions/delete-user/index.ts
2. Ctrl+A å…¨é€‰ â†’ Ctrl+C å¤åˆ¶
3. åœ¨ Dashboard ä»£ç ç¼–è¾‘å™¨ä¸­ç²˜è´´ï¼ˆè¦†ç›–åŸä»£ç ï¼‰
4. ç‚¹å‡» "Deploy" æŒ‰é’®
5. ç­‰å¾… 10-30 ç§’éƒ¨ç½²å®Œæˆ
```

#### Step 4: éªŒè¯
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
const { data, error } = await supabase.functions.invoke('delete-user', {
  body: { userId: 'æµ‹è¯•ç”¨æˆ·ID', hardDelete: false }
});
console.log(data);
```

### âœ… éƒ¨ç½²å®Œæˆæ ‡å¿—

- Edge Functions åˆ—è¡¨ä¸­ `delete-user` æ˜¾ç¤º "Active"
- åˆ é™¤ç”¨æˆ·ä¸å†æŠ¥å¤–é”®é”™è¯¯
- auth.users å’Œ profiles åŒæ—¶è¢«åˆ é™¤

---

## ä½¿ç”¨æŒ‡å—

### ğŸ“– æ—¥å¸¸ä½¿ç”¨

#### åˆ é™¤ç”¨æˆ·ï¼ˆç•Œé¢æ“ä½œï¼‰
1. è¿›å…¥ è®¾ç½® â†’ ç”¨æˆ·ç®¡ç†
2. ç‚¹å‡»ç”¨æˆ·æ—è¾¹çš„åˆ é™¤æŒ‰é’®
3. ç¡®è®¤åˆ é™¤
4. âœ… è‡ªåŠ¨è½¬ç§»æ•°æ®ï¼ŒåŒæ—¶åˆ é™¤ä¸¤ä¸ªè¡¨

#### æ£€æŸ¥å­¤ç«‹ç”¨æˆ·ï¼ˆSQLï¼‰
```sql
-- æ¯å‘¨æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼ˆåº”è¯¥è¿”å› 0ï¼‰
SELECT COUNT(*) as orphaned_count
FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

#### æ¸…ç†å­¤ç«‹ç”¨æˆ·ï¼ˆå¦‚æœå‡ºç°ï¼‰
```sql
-- æ‰§è¡Œæ™ºèƒ½æ¸…ç†è„šæœ¬
-- æ–‡ä»¶: scripts/delete_all_orphaned_users_auto.sql
```

---

## é˜²æ­¢å°†æ¥é—®é¢˜

### âœ… å·²å®æ–½çš„é˜²æŠ¤

1. **å‰ç«¯ä»£ç è§„èŒƒ**
   - âœ… ç»Ÿä¸€ä½¿ç”¨ Edge Function åˆ é™¤ç”¨æˆ·
   - âŒ ç¦æ­¢ç›´æ¥åˆ é™¤ profiles æˆ– auth.users

2. **Edge Function è‡ªåŠ¨åŒ–**
   - âœ… è‡ªåŠ¨è½¬ç§»å…³è”æ•°æ®
   - âœ… åŒæ—¶åˆ é™¤ä¸¤ä¸ªè¡¨
   - âœ… é˜²æ­¢å¤–é”®é”™è¯¯

3. **æ™ºèƒ½æ¸…ç†å·¥å…·**
   - âœ… è‡ªåŠ¨å‘ç°æ‰€æœ‰ç›¸å…³è¡¨
   - âœ… å¯ä»¥éšæ—¶æ¸…ç†å­¤ç«‹ç”¨æˆ·

### ğŸ“‹ æœ€ä½³å®è·µ

#### âœ… æ­£ç¡®åšæ³•

**åˆ›å»ºç”¨æˆ·ï¼š**
```typescript
await supabase.functions.invoke('create-user', {
  body: { email, password, full_name, role }
});
```

**åˆ é™¤ç”¨æˆ·ï¼š**
```typescript
await supabase.functions.invoke('delete-user', {
  body: { userId, hardDelete: true }
});
```

#### âŒ ç¦æ­¢æ“ä½œ

**ä¸è¦ç›´æ¥åˆ é™¤ï¼š**
```typescript
// âŒ é”™è¯¯ï¼ä¼šå¯¼è‡´ä¸åŒæ­¥
await supabase.from('profiles').delete().eq('id', userId);
```

**ä¸è¦ç›´æ¥åˆ›å»ºï¼š**
```typescript
// âŒ é”™è¯¯ï¼å¯èƒ½å¯¼è‡´ä¸åŒæ­¥
await supabase.auth.signUp({...});
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ›´æ–°åçš„ delete-user å‡½æ•°ç‰¹æ€§

1. **æ™ºèƒ½æ•°æ®è½¬ç§»**
   - è‡ªåŠ¨è½¬ç§»ä»¥ä¸‹è¡¨çš„æ•°æ®ï¼š
     - drivers, location_projects
     - logistics_records, logistics_partner_costs
     - payment_requests, invoice_requests
     - scale_records, notifications, operation_logs

2. **å¤„ç†å”¯ä¸€çº¦æŸ**
   - user_permissions - ç›´æ¥åˆ é™¤
   - user_roles - ç›´æ¥åˆ é™¤

3. **æ”¯æŒè½¯åˆ é™¤**
   ```typescript
   hardDelete: false  // ä»…åœç”¨ï¼Œä¸åˆ é™¤
   ```

4. **è‡ªå®šä¹‰æ¥ç®¡è´¦æˆ·**
   ```typescript
   transferToUserId: 'æŒ‡å®šçš„ç®¡ç†å‘˜ID'  // å¯é€‰
   ```

### æ™ºèƒ½æ¸…ç†è„šæœ¬ç‰¹æ€§

**æ–‡ä»¶**: `scripts/delete_all_orphaned_users_auto.sql`

- âœ… è‡ªåŠ¨æ‰«ææ‰€æœ‰è¡¨å’Œå­—æ®µ
- âœ… è‡ªåŠ¨è½¬ç§»å…³è”æ•°æ®
- âœ… è‡ªåŠ¨å¤‡ä»½
- âœ… è¯¦ç»†çš„å¤„ç†æ—¥å¿—

---

## ğŸ“Š æ¸…ç†ç»“æœ

### æ‰§è¡Œå‰
- auth.users: 14 ä¸ªç”¨æˆ·
- profiles: 3 ä¸ªç”¨æˆ·
- å­¤ç«‹ç”¨æˆ·: 11 ä¸ª âŒ

### æ‰§è¡Œå
- auth.users: 3 ä¸ªç”¨æˆ· âœ…
- profiles: 3 ä¸ªç”¨æˆ· âœ…
- å­¤ç«‹ç”¨æˆ·: 0 ä¸ª âœ…

### ä¿ç•™çš„ç”¨æˆ·
1. admin@example.com - Administrator
2. dmuxue@gmail.com - szf
3. LaoShen@company.local - æ²ˆæœ±å³°

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### Q: åˆ é™¤ç”¨æˆ·æ—¶æŠ¥å¤–é”®é”™è¯¯

**A**: ç¡®ä¿å·²éƒ¨ç½²æœ€æ–°çš„ delete-user å‡½æ•°

### Q: å¦‚ä½•éªŒè¯éƒ¨ç½²æˆåŠŸ

**A**: 
```sql
-- æ£€æŸ¥æ˜¯å¦æœ‰å­¤ç«‹ç”¨æˆ·ï¼ˆåº”è¿”å› 0ï¼‰
SELECT COUNT(*) FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

### Q: ä¼ä¸šå¾®ä¿¡ç™»å½•æ˜¯å¦å—å½±å“

**A**: ä¸å—å½±å“ï¼ä¼ä¸šå¾®ä¿¡ç”¨æˆ·ä¼šï¼š
- é¦–æ¬¡ç™»å½•ï¼šè‡ªåŠ¨åˆ›å»º auth.users å’Œ profiles
- åç»­ç™»å½•ï¼šupsert æ›´æ–° profiles
- åˆ é™¤ç”¨æˆ·ï¼šå…³è”æ•°æ®ä¼šè¢«è½¬ç§»

### Q: å¦‚ä½•æ¢å¤è¯¯åˆ çš„ç”¨æˆ·

**A**: 
```sql
-- ä»å¤‡ä»½æ¢å¤
SELECT * FROM auth_users_backup_20251101
WHERE email = 'è¦æ¢å¤çš„é‚®ç®±';

INSERT INTO auth.users 
SELECT * FROM auth_users_backup_20251101 
WHERE id = 'è¦æ¢å¤çš„ç”¨æˆ·ID';
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒä»£ç 
- `supabase/functions/delete-user/index.ts` - æ›´æ–°åçš„åˆ é™¤å‡½æ•°
- `src/components/permissions/UserManagement.tsx` - å‰ç«¯ç”¨æˆ·ç®¡ç†

### å·¥å…·è„šæœ¬
- `scripts/delete_all_orphaned_users_auto.sql` - æ™ºèƒ½æ¸…ç†è„šæœ¬

### æŠ€æœ¯æ–‡æ¡£
- `docs/é˜²æ­¢ç”¨æˆ·ä¸åŒæ­¥æœ€ä½³å®è·µ.md` - æœ€ä½³å®è·µ
- `docs/Supabaseåå°éƒ¨ç½²Edge-FunctionæŒ‡å—.md` - éƒ¨ç½²æŒ‡å—

---

## âš¡ å¿«é€Ÿå‚è€ƒ

### æ£€æŸ¥å­¤ç«‹ç”¨æˆ·
```sql
SELECT * FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

### æ¸…ç†å­¤ç«‹ç”¨æˆ·
```sql
-- æ‰§è¡Œ scripts/delete_all_orphaned_users_auto.sql
```

### éªŒè¯åŒæ­¥çŠ¶æ€
```sql
SELECT 
    (SELECT COUNT(*) FROM auth.users) as auth_count,
    (SELECT COUNT(*) FROM public.profiles) as profile_count,
    CASE 
        WHEN (SELECT COUNT(*) FROM auth.users) = (SELECT COUNT(*) FROM public.profiles)
        THEN 'âœ… åŒæ­¥'
        ELSE 'âŒ ä¸åŒæ­¥'
    END as status;
```

---

## ğŸ¯ ç»´æŠ¤å»ºè®®

### æ¯å‘¨æ£€æŸ¥
```sql
-- åº”è¯¥è¿”å› 0
SELECT COUNT(*) FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

### å¦‚æœå‘ç°é—®é¢˜
1. æ‰§è¡Œæ™ºèƒ½æ¸…ç†è„šæœ¬
2. æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç ç›´æ¥æ“ä½œ profiles
3. ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„ Edge Function

---

## ğŸ‰ å®Œæˆæ ‡å¿—

- âœ… 11 ä¸ªå­¤ç«‹ç”¨æˆ·å·²æ¸…ç†
- âœ… å‰ç«¯ä»£ç å·²ä¿®å¤
- âœ… Edge Function å·²æ›´æ–°
- âœ… æœ‰æ™ºèƒ½æ¸…ç†å·¥å…·
- âœ… auth.users å’Œ profiles å®Œå…¨åŒæ­¥
- âœ… ä¼ä¸šå¾®ä¿¡ç™»å½•æ­£å¸¸
- âœ… ä¸ä¼šå†å‡ºç°"é‚®ç®±å·²æ³¨å†Œ"é”™è¯¯

---

**é—®é¢˜å·²å½»åº•è§£å†³ï¼** ğŸš€

