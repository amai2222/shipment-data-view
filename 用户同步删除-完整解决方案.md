# 用户同步删除 - 完整解决方案

> **最后更新**: 2025-11-01  
> **状态**: ✅ 已完成并部署  
> **问题**: 修复 auth.users 和 profiles 表不同步的问题

---

## 📋 目录

1. [问题描述](#问题描述)
2. [解决方案](#解决方案)
3. [部署步骤](#部署步骤)
4. [使用指南](#使用指南)
5. [防止将来问题](#防止将来问题)

---

## 问题描述

### 🚨 现象

注册用户时报错：
```
AuthApiError: A user with this email address has already been registered
```

但在用户管理界面（profiles 表）中看不到该用户。

### 🔍 原因

Supabase 有两个独立的用户表：

| 表名 | 作用 | 可见性 |
|------|------|--------|
| `auth.users` | 认证系统表 | ❌ 您看不到 |
| `public.profiles` | 业务信息表 | ✅ 您能看到 |

**问题根源**：
- 旧代码删除用户时只删除了 `profiles`
- 没有删除 `auth.users`
- 导致 11 个用户成为"孤立用户"

---

## 解决方案

### ✅ 已完成的修复

#### 1. 清理了现有的孤立用户
- 使用智能脚本清理了 11 个孤立用户
- 将关联数据转移给 admin@example.com
- 现在 auth.users 和 profiles 完全同步（各 3 个用户）

#### 2. 修复了前端删除代码
- **文件**: `src/components/permissions/UserManagement.tsx`
- **修改**: 改为调用 Edge Function，不再直接删除 profiles

#### 3. 更新了 Edge Function
- **文件**: `supabase/functions/delete-user/index.ts`
- **新功能**:
  - ✅ 自动转移关联数据到管理员
  - ✅ 同时删除 auth.users 和 profiles
  - ✅ 防止外键约束错误
  - ✅ 支持软删除（仅停用）

#### 4. 创建了智能清理工具
- **文件**: `scripts/delete_all_orphaned_users_auto.sql`
- **功能**: 自动发现所有相关表，清理孤立用户

---

## 部署步骤

### 🚀 在 Supabase Dashboard 部署 Edge Function

#### Step 1: 登录
```
访问: https://app.supabase.com
登录 → 选择项目
```

#### Step 2: 进入 Edge Functions
```
左侧菜单 → Edge Functions → 点击 delete-user
```

#### Step 3: 替换代码
```
1. 打开本地文件: supabase/functions/delete-user/index.ts
2. Ctrl+A 全选 → Ctrl+C 复制
3. 在 Dashboard 代码编辑器中粘贴（覆盖原代码）
4. 点击 "Deploy" 按钮
5. 等待 10-30 秒部署完成
```

#### Step 4: 验证
```javascript
// 在浏览器控制台测试
const { data, error } = await supabase.functions.invoke('delete-user', {
  body: { userId: '测试用户ID', hardDelete: false }
});
console.log(data);
```

### ✅ 部署完成标志

- Edge Functions 列表中 `delete-user` 显示 "Active"
- 删除用户不再报外键错误
- auth.users 和 profiles 同时被删除

---

## 使用指南

### 📖 日常使用

#### 删除用户（界面操作）
1. 进入 设置 → 用户管理
2. 点击用户旁边的删除按钮
3. 确认删除
4. ✅ 自动转移数据，同时删除两个表

#### 检查孤立用户（SQL）
```sql
-- 每周执行一次检查（应该返回 0）
SELECT COUNT(*) as orphaned_count
FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

#### 清理孤立用户（如果出现）
```sql
-- 执行智能清理脚本
-- 文件: scripts/delete_all_orphaned_users_auto.sql
```

---

## 防止将来问题

### ✅ 已实施的防护

1. **前端代码规范**
   - ✅ 统一使用 Edge Function 删除用户
   - ❌ 禁止直接删除 profiles 或 auth.users

2. **Edge Function 自动化**
   - ✅ 自动转移关联数据
   - ✅ 同时删除两个表
   - ✅ 防止外键错误

3. **智能清理工具**
   - ✅ 自动发现所有相关表
   - ✅ 可以随时清理孤立用户

### 📋 最佳实践

#### ✅ 正确做法

**创建用户：**
```typescript
await supabase.functions.invoke('create-user', {
  body: { email, password, full_name, role }
});
```

**删除用户：**
```typescript
await supabase.functions.invoke('delete-user', {
  body: { userId, hardDelete: true }
});
```

#### ❌ 禁止操作

**不要直接删除：**
```typescript
// ❌ 错误！会导致不同步
await supabase.from('profiles').delete().eq('id', userId);
```

**不要直接创建：**
```typescript
// ❌ 错误！可能导致不同步
await supabase.auth.signUp({...});
```

---

## 🔧 技术细节

### 更新后的 delete-user 函数特性

1. **智能数据转移**
   - 自动转移以下表的数据：
     - drivers, location_projects
     - logistics_records, logistics_partner_costs
     - payment_requests, invoice_requests
     - scale_records, notifications, operation_logs

2. **处理唯一约束**
   - user_permissions - 直接删除
   - user_roles - 直接删除

3. **支持软删除**
   ```typescript
   hardDelete: false  // 仅停用，不删除
   ```

4. **自定义接管账户**
   ```typescript
   transferToUserId: '指定的管理员ID'  // 可选
   ```

### 智能清理脚本特性

**文件**: `scripts/delete_all_orphaned_users_auto.sql`

- ✅ 自动扫描所有表和字段
- ✅ 自动转移关联数据
- ✅ 自动备份
- ✅ 详细的处理日志

---

## 📊 清理结果

### 执行前
- auth.users: 14 个用户
- profiles: 3 个用户
- 孤立用户: 11 个 ❌

### 执行后
- auth.users: 3 个用户 ✅
- profiles: 3 个用户 ✅
- 孤立用户: 0 个 ✅

### 保留的用户
1. admin@example.com - Administrator
2. dmuxue@gmail.com - szf
3. LaoShen@company.local - 沈朱峰

---

## 🆘 故障排查

### Q: 删除用户时报外键错误

**A**: 确保已部署最新的 delete-user 函数

### Q: 如何验证部署成功

**A**: 
```sql
-- 检查是否有孤立用户（应返回 0）
SELECT COUNT(*) FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

### Q: 企业微信登录是否受影响

**A**: 不受影响！企业微信用户会：
- 首次登录：自动创建 auth.users 和 profiles
- 后续登录：upsert 更新 profiles
- 删除用户：关联数据会被转移

### Q: 如何恢复误删的用户

**A**: 
```sql
-- 从备份恢复
SELECT * FROM auth_users_backup_20251101
WHERE email = '要恢复的邮箱';

INSERT INTO auth.users 
SELECT * FROM auth_users_backup_20251101 
WHERE id = '要恢复的用户ID';
```

---

## 📁 相关文件

### 核心代码
- `supabase/functions/delete-user/index.ts` - 更新后的删除函数
- `src/components/permissions/UserManagement.tsx` - 前端用户管理

### 工具脚本
- `scripts/delete_all_orphaned_users_auto.sql` - 智能清理脚本

### 技术文档
- `docs/防止用户不同步最佳实践.md` - 最佳实践
- `docs/Supabase后台部署Edge-Function指南.md` - 部署指南

---

## ⚡ 快速参考

### 检查孤立用户
```sql
SELECT * FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

### 清理孤立用户
```sql
-- 执行 scripts/delete_all_orphaned_users_auto.sql
```

### 验证同步状态
```sql
SELECT 
    (SELECT COUNT(*) FROM auth.users) as auth_count,
    (SELECT COUNT(*) FROM public.profiles) as profile_count,
    CASE 
        WHEN (SELECT COUNT(*) FROM auth.users) = (SELECT COUNT(*) FROM public.profiles)
        THEN '✅ 同步'
        ELSE '❌ 不同步'
    END as status;
```

---

## 🎯 维护建议

### 每周检查
```sql
-- 应该返回 0
SELECT COUNT(*) FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

### 如果发现问题
1. 执行智能清理脚本
2. 检查是否有代码直接操作 profiles
3. 确保使用最新的 Edge Function

---

## 🎉 完成标志

- ✅ 11 个孤立用户已清理
- ✅ 前端代码已修复
- ✅ Edge Function 已更新
- ✅ 有智能清理工具
- ✅ auth.users 和 profiles 完全同步
- ✅ 企业微信登录正常
- ✅ 不会再出现"邮箱已注册"错误

---

**问题已彻底解决！** 🚀

