# ä»˜æ¬¾å®¡æ ¸å’Œè´¢åŠ¡ä»˜æ¬¾ç­›é€‰å™¨å‡çº§æ–¹æ¡ˆ

## ğŸ¯ å‡çº§ç›®æ ‡

å‚è€ƒä»˜æ¬¾ç”³è¯·é¡µé¢ï¼ˆPaymentRequest.tsxï¼‰çš„ç­›é€‰å™¨è®¾è®¡ï¼Œå‡çº§ä»¥ä¸‹ä¸¤ä¸ªé¡µé¢ï¼š

1. **ä»˜æ¬¾å®¡æ ¸** - `src/pages/PaymentAudit.tsx`
2. **è´¢åŠ¡ä»˜æ¬¾** - `src/pages/PaymentRequestsList.tsx`

---

## ğŸ“‹ å‚è€ƒè®¾è®¡ï¼ˆä»˜æ¬¾ç”³è¯·é¡µé¢ï¼‰

### å¸¸è§„ç­›é€‰åŒºåŸŸï¼ˆå§‹ç»ˆå¯è§ï¼‰
- é¡¹ç›®
- æ—¥æœŸèŒƒå›´
- **ç”³è¯·å•çŠ¶æ€**ï¼ˆæ›¿æ¢æ”¯ä»˜çŠ¶æ€ï¼‰
- æœç´¢/æ¸…é™¤æŒ‰é’®
- å±•å¼€é«˜çº§ç­›é€‰æŒ‰é’®

### é«˜çº§ç­›é€‰åŒºåŸŸï¼ˆå¯å±•å¼€/æ”¶èµ·ï¼‰
- ç”³è¯·å•å·
- è¿å•ç¼–å·ï¼ˆæ‰¹é‡è¾“å…¥ [+]ï¼‰
- å¸æœºï¼ˆæ‰¹é‡è¾“å…¥ [+]ï¼‰
- è½¦ç‰Œå·ï¼ˆæ‰¹é‡è¾“å…¥ [+]ï¼‰
- ç”µè¯ï¼ˆæ‰¹é‡è¾“å…¥ [+]ï¼‰
- å…¶ä»–å¹³å°åç§°ï¼ˆåŠ¨æ€åŠ è½½ï¼‰

---

## ğŸ”„ å…³é”®å·®å¼‚

| å­—æ®µ | ä»˜æ¬¾ç”³è¯·é¡µé¢ | ä»˜æ¬¾å®¡æ ¸/è´¢åŠ¡ä»˜æ¬¾é¡µé¢ |
|-----|------------|-------------------|
| çŠ¶æ€ç­›é€‰ | æ”¯ä»˜çŠ¶æ€ | **ç”³è¯·å•çŠ¶æ€** âš ï¸ |
| åˆä½œæ–¹ç­›é€‰ | éœ€è¦ | âŒ ä¸éœ€è¦ |
| å…¶ä»– | ç›¸åŒ | ç›¸åŒ |

---

## ğŸ“Š å½“å‰çŠ¶æ€åˆ†æ

### PaymentAudit.tsxï¼ˆä»˜æ¬¾å®¡æ ¸ï¼‰

**å½“å‰ç­›é€‰é¡¹**ï¼š
```typescript
{
  requestId: '',      // ç”³è¯·å•å·
  waybillNumber: '',  // è¿å•å·
  driverName: '',     // å¸æœº
  loadingDate: null,  // è£…è´§æ—¥æœŸ
  status: '',         // ç”³è¯·å•çŠ¶æ€ âœ…
  projectId: ''       // é¡¹ç›®
}
```

**é—®é¢˜**ï¼š
- âŒ è¿å•å·ä¸æ”¯æŒæ‰¹é‡ORæœç´¢
- âŒ å¸æœºä¸æ”¯æŒæ‰¹é‡ORæœç´¢
- âŒ ç¼ºå°‘è½¦ç‰Œå·ç­›é€‰
- âŒ ç¼ºå°‘ç”µè¯ç­›é€‰
- âŒ ç¼ºå°‘å¹³å°åç§°ç­›é€‰
- âŒ æ²¡æœ‰é«˜çº§ç­›é€‰æŠ˜å åŠŸèƒ½

---

### PaymentRequestsList.tsxï¼ˆè´¢åŠ¡ä»˜æ¬¾ï¼‰

**å½“å‰ç­›é€‰é¡¹**ï¼š
```typescript
{
  requestId: '',      // ç”³è¯·å•å·
  waybillNumber: '',  // è¿å•å·
  driverName: '',     // å¸æœº
  loadingDate: null,  // è£…è´§æ—¥æœŸ
  status: '',         // ç”³è¯·å•çŠ¶æ€ âœ…
  projectId: ''       // é¡¹ç›®
}
```

**é—®é¢˜**ï¼šä¸ä»˜æ¬¾å®¡æ ¸é¡µé¢å®Œå…¨ç›¸åŒ

---

## ğŸ¯ å‡çº§æ–¹æ¡ˆ

### å‰ç«¯ä¿®æ”¹

#### 1. æ‰©å±•ç­›é€‰å™¨æ•°æ®ç»“æ„

**ä¿®æ”¹å‰**ï¼š
```typescript
{
  requestId: '',
  waybillNumber: '',
  driverName: '',
  loadingDate: null,
  status: '',
  projectId: ''
}
```

**ä¿®æ”¹å**ï¼š
```typescript
{
  // å¸¸è§„ç­›é€‰
  projectId: '',
  startDate: '',
  endDate: '',
  status: '',           // ç”³è¯·å•çŠ¶æ€
  
  // é«˜çº§ç­›é€‰
  requestId: '',
  waybillNumbers: '',   // æ”¹ä¸ºå¤æ•°ï¼Œæ”¯æŒæ‰¹é‡
  driverName: '',       // æ”¯æŒæ‰¹é‡
  licensePlate: '',     // ğŸ†• è½¦ç‰Œå·
  driverPhone: '',      // ğŸ†• ç”µè¯
  otherPlatformName: '' // ğŸ†• å¹³å°åç§°
}
```

#### 2. æ·»åŠ çŠ¶æ€ç®¡ç†

```typescript
const [showAdvanced, setShowAdvanced] = useState(false);
const [platformOptions, setPlatformOptions] = useState<...>([]);
const [batchDialog, setBatchDialog] = useState<...>({ isOpen: false, type: null });
```

#### 3. UIå¸ƒå±€é‡æ„

**å¸¸è§„ç­›é€‰**ï¼š
```
[é¡¹ç›®] [æ—¥æœŸèŒƒå›´] [ç”³è¯·å•çŠ¶æ€] [æœç´¢] [æ¸…é™¤]
                               â–¼ å±•å¼€é«˜çº§ç­›é€‰
```

**é«˜çº§ç­›é€‰**ï¼ˆå±•å¼€åï¼‰ï¼š
```
â”€â”€â”€ é«˜çº§ç­›é€‰ â”€â”€â”€                â–² æ”¶èµ·é«˜çº§ç­›é€‰
[ç”³è¯·å•å·] [è¿å•å· +] [å¸æœº +] [è½¦ç‰Œå· +] [ç”µè¯ +] [å¹³å°åç§°]
```

---

### åç«¯ä¿®æ”¹

#### éœ€è¦ä¿®æ”¹çš„SQLå‡½æ•°

**å‡½æ•°**ï¼š`get_payment_requests_filtered`

**å½“å‰å‚æ•°**ï¼š
```sql
p_request_id TEXT,
p_waybill_number TEXT,
p_driver_name TEXT,
p_loading_date DATE,
p_status TEXT,
p_project_id UUID
```

**éœ€è¦æ·»åŠ çš„å‚æ•°**ï¼š
```sql
-- æ—¥æœŸèŒƒå›´ï¼ˆæ›¿æ¢å•ä¸ªæ—¥æœŸï¼‰
p_start_date DATE DEFAULT NULL,
p_end_date DATE DEFAULT NULL,

-- æ‰¹é‡æœç´¢å‚æ•°
p_waybill_numbers TEXT DEFAULT NULL,  -- æ”¹ä¸ºå¤æ•°
p_license_plate TEXT DEFAULT NULL,
p_driver_phone TEXT DEFAULT NULL,
p_other_platform_name TEXT DEFAULT NULL
```

**éœ€è¦æ·»åŠ çš„ç­›é€‰é€»è¾‘**ï¼š
```sql
-- å¸æœºæ‰¹é‡ORæœç´¢
EXISTS (
    SELECT 1 FROM unnest(v_driver_array) AS driver_name
    WHERE lr.driver_name ILIKE '%' || driver_name || '%'
)

-- è½¦ç‰Œå·æ‰¹é‡ORæœç´¢
EXISTS (
    SELECT 1 FROM unnest(v_license_array) AS plate
    WHERE lr.license_plate ILIKE '%' || plate || '%'
)

-- ç”µè¯æ‰¹é‡ORæœç´¢
EXISTS (
    SELECT 1 FROM unnest(v_phone_array) AS phone
    WHERE lr.driver_phone ILIKE '%' || phone || '%'
)

-- è¿å•å·æ‰¹é‡ORæœç´¢ï¼ˆåŒ…æ‹¬å…¶ä»–å¹³å°ï¼‰
lr.auto_number = ANY(v_waybill_array) OR
(lr.external_tracking_numbers IS NOT NULL AND 
 lr.external_tracking_numbers && v_waybill_array)

-- å¹³å°åç§°ç­›é€‰
-- ï¼ˆåŒä»˜æ¬¾ç”³è¯·é¡µé¢é€»è¾‘ï¼‰
```

---

## ğŸ“Š ç”³è¯·å•çŠ¶æ€é€‰é¡¹

### ä»˜æ¬¾å®¡æ ¸é¡µé¢ï¼ˆPaymentAuditï¼‰

```typescript
const STATUS_OPTIONS = [
  { value: 'all', label: 'æ‰€æœ‰çŠ¶æ€' },
  { value: 'Pending', label: 'å¾…å®¡æ ¸' },
  { value: 'Approved', label: 'å·²å®¡æ ¸' },
  { value: 'Rejected', label: 'å·²æ‹’ç»' },
  { value: 'Paid', label: 'å·²ä»˜æ¬¾' }
];
```

### è´¢åŠ¡ä»˜æ¬¾é¡µé¢ï¼ˆPaymentRequestsListï¼‰

```typescript
const STATUS_OPTIONS = [
  { value: 'all', label: 'æ‰€æœ‰çŠ¶æ€' },
  { value: 'Pending', label: 'å¾…å¤„ç†' },
  { value: 'Approved', label: 'å·²å®¡æ ¸' },
  { value: 'Paid', label: 'å·²ä»˜æ¬¾' },
  { value: 'Rejected', label: 'å·²æ‹’ç»' }
];
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹åç«¯SQLå‡½æ•°

1. å¤‡ä»½ `get_payment_requests_filtered` å‡½æ•°
2. æ·»åŠ æ–°å‚æ•°
3. æ·»åŠ æ‰¹é‡ORæœç´¢é€»è¾‘
4. æµ‹è¯•éªŒè¯

### ç¬¬äºŒæ­¥ï¼šä¿®æ”¹å‰ç«¯é¡µé¢

#### PaymentAudit.tsx
1. æ‰©å±•ç­›é€‰å™¨æ•°æ®ç»“æ„
2. æ·»åŠ çŠ¶æ€ç®¡ç†
3. é‡æ„UIå¸ƒå±€ï¼ˆå¸¸è§„+é«˜çº§ï¼‰
4. æ·»åŠ æ‰¹é‡è¾“å…¥å¯¹è¯æ¡†
5. æ›´æ–°RPCè°ƒç”¨å‚æ•°

#### PaymentRequestsList.tsx
1. åŒæ ·çš„ä¿®æ”¹
2. ä¿æŒä¸¤ä¸ªé¡µé¢ä¸€è‡´æ€§

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•

1. æµ‹è¯•æ‰¹é‡è¿å•å·æœç´¢
2. æµ‹è¯•æ‰¹é‡å¸æœºæœç´¢
3. æµ‹è¯•æ‰¹é‡è½¦ç‰Œ/ç”µè¯æœç´¢
4. æµ‹è¯•ç”³è¯·å•çŠ¶æ€ç­›é€‰
5. æµ‹è¯•é«˜çº§ç­›é€‰å±•å¼€/æ”¶èµ·

---

## ğŸ“ å®æ–½ä¼˜å…ˆçº§

### å¿…é¡»å®ç°
- âœ… è¿å•å·æ‰¹é‡ORæœç´¢
- âœ… å¸æœºæ‰¹é‡ORæœç´¢
- âœ… é«˜çº§ç­›é€‰å±•å¼€/æ”¶èµ·
- âœ… ç”³è¯·å•çŠ¶æ€ç­›é€‰ï¼ˆä¿ç•™ï¼‰

### å¯é€‰å®ç°
- â­ è½¦ç‰Œå·æ‰¹é‡æœç´¢
- â­ ç”µè¯æ‰¹é‡æœç´¢
- â­ å¹³å°åç§°ç­›é€‰

---

## â±ï¸ é¢„è®¡æ—¶é—´

| ä»»åŠ¡ | æ—¶é—´ |
|-----|------|
| åç«¯SQLå‡½æ•°ä¿®æ”¹ | 1å°æ—¶ |
| PaymentAuditå‰ç«¯ä¿®æ”¹ | 1å°æ—¶ |
| PaymentRequestsListå‰ç«¯ä¿®æ”¹ | 1å°æ—¶ |
| æµ‹è¯•éªŒè¯ | 0.5å°æ—¶ |
| **æ€»è®¡** | **3.5å°æ—¶** |

---

**å‡†å¤‡å¼€å§‹å®æ–½å—ï¼Ÿ** ğŸš€

