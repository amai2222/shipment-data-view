# 付款审核和财务付款筛选器升级方案

## 🎯 升级目标

参考付款申请页面（PaymentRequest.tsx）的筛选器设计，升级以下两个页面：

1. **付款审核** - `src/pages/PaymentAudit.tsx`
2. **财务付款** - `src/pages/PaymentRequestsList.tsx`

---

## 📋 参考设计（付款申请页面）

### 常规筛选区域（始终可见）
- 项目
- 日期范围
- **申请单状态**（替换支付状态）
- 搜索/清除按钮
- 展开高级筛选按钮

### 高级筛选区域（可展开/收起）
- 申请单号
- 运单编号（批量输入 [+]）
- 司机（批量输入 [+]）
- 车牌号（批量输入 [+]）
- 电话（批量输入 [+]）
- 其他平台名称（动态加载）

---

## 🔄 关键差异

| 字段 | 付款申请页面 | 付款审核/财务付款页面 |
|-----|------------|-------------------|
| 状态筛选 | 支付状态 | **申请单状态** ⚠️ |
| 合作方筛选 | 需要 | ❌ 不需要 |
| 其他 | 相同 | 相同 |

---

## 📊 当前状态分析

### PaymentAudit.tsx（付款审核）

**当前筛选项**：
```typescript
{
  requestId: '',      // 申请单号
  waybillNumber: '',  // 运单号
  driverName: '',     // 司机
  loadingDate: null,  // 装货日期
  status: '',         // 申请单状态 ✅
  projectId: ''       // 项目
}
```

**问题**：
- ❌ 运单号不支持批量OR搜索
- ❌ 司机不支持批量OR搜索
- ❌ 缺少车牌号筛选
- ❌ 缺少电话筛选
- ❌ 缺少平台名称筛选
- ❌ 没有高级筛选折叠功能

---

### PaymentRequestsList.tsx（财务付款）

**当前筛选项**：
```typescript
{
  requestId: '',      // 申请单号
  waybillNumber: '',  // 运单号
  driverName: '',     // 司机
  loadingDate: null,  // 装货日期
  status: '',         // 申请单状态 ✅
  projectId: ''       // 项目
}
```

**问题**：与付款审核页面完全相同

---

## 🎯 升级方案

### 前端修改

#### 1. 扩展筛选器数据结构

**修改前**：
```typescript
{
  requestId: '',
  waybillNumber: '',
  driverName: '',
  loadingDate: null,
  status: '',
  projectId: ''
}
```

**修改后**：
```typescript
{
  // 常规筛选
  projectId: '',
  startDate: '',
  endDate: '',
  status: '',           // 申请单状态
  
  // 高级筛选
  requestId: '',
  waybillNumbers: '',   // 改为复数，支持批量
  driverName: '',       // 支持批量
  licensePlate: '',     // 🆕 车牌号
  driverPhone: '',      // 🆕 电话
  otherPlatformName: '' // 🆕 平台名称
}
```

#### 2. 添加状态管理

```typescript
const [showAdvanced, setShowAdvanced] = useState(false);
const [platformOptions, setPlatformOptions] = useState<...>([]);
const [batchDialog, setBatchDialog] = useState<...>({ isOpen: false, type: null });
```

#### 3. UI布局重构

**常规筛选**：
```
[项目] [日期范围] [申请单状态] [搜索] [清除]
                               ▼ 展开高级筛选
```

**高级筛选**（展开后）：
```
─── 高级筛选 ───                ▲ 收起高级筛选
[申请单号] [运单号 +] [司机 +] [车牌号 +] [电话 +] [平台名称]
```

---

### 后端修改

#### 需要修改的SQL函数

**函数**：`get_payment_requests_filtered`

**当前参数**：
```sql
p_request_id TEXT,
p_waybill_number TEXT,
p_driver_name TEXT,
p_loading_date DATE,
p_status TEXT,
p_project_id UUID
```

**需要添加的参数**：
```sql
-- 日期范围（替换单个日期）
p_start_date DATE DEFAULT NULL,
p_end_date DATE DEFAULT NULL,

-- 批量搜索参数
p_waybill_numbers TEXT DEFAULT NULL,  -- 改为复数
p_license_plate TEXT DEFAULT NULL,
p_driver_phone TEXT DEFAULT NULL,
p_other_platform_name TEXT DEFAULT NULL
```

**需要添加的筛选逻辑**：
```sql
-- 司机批量OR搜索
EXISTS (
    SELECT 1 FROM unnest(v_driver_array) AS driver_name
    WHERE lr.driver_name ILIKE '%' || driver_name || '%'
)

-- 车牌号批量OR搜索
EXISTS (
    SELECT 1 FROM unnest(v_license_array) AS plate
    WHERE lr.license_plate ILIKE '%' || plate || '%'
)

-- 电话批量OR搜索
EXISTS (
    SELECT 1 FROM unnest(v_phone_array) AS phone
    WHERE lr.driver_phone ILIKE '%' || phone || '%'
)

-- 运单号批量OR搜索（包括其他平台）
lr.auto_number = ANY(v_waybill_array) OR
(lr.external_tracking_numbers IS NOT NULL AND 
 lr.external_tracking_numbers && v_waybill_array)

-- 平台名称筛选
-- （同付款申请页面逻辑）
```

---

## 📊 申请单状态选项

### 付款审核页面（PaymentAudit）

```typescript
const STATUS_OPTIONS = [
  { value: 'all', label: '所有状态' },
  { value: 'Pending', label: '待审核' },
  { value: 'Approved', label: '已审核' },
  { value: 'Rejected', label: '已拒绝' },
  { value: 'Paid', label: '已付款' }
];
```

### 财务付款页面（PaymentRequestsList）

```typescript
const STATUS_OPTIONS = [
  { value: 'all', label: '所有状态' },
  { value: 'Pending', label: '待处理' },
  { value: 'Approved', label: '已审核' },
  { value: 'Paid', label: '已付款' },
  { value: 'Rejected', label: '已拒绝' }
];
```

---

## 🚀 实施步骤

### 第一步：修改后端SQL函数

1. 备份 `get_payment_requests_filtered` 函数
2. 添加新参数
3. 添加批量OR搜索逻辑
4. 测试验证

### 第二步：修改前端页面

#### PaymentAudit.tsx
1. 扩展筛选器数据结构
2. 添加状态管理
3. 重构UI布局（常规+高级）
4. 添加批量输入对话框
5. 更新RPC调用参数

#### PaymentRequestsList.tsx
1. 同样的修改
2. 保持两个页面一致性

### 第三步：测试

1. 测试批量运单号搜索
2. 测试批量司机搜索
3. 测试批量车牌/电话搜索
4. 测试申请单状态筛选
5. 测试高级筛选展开/收起

---

## 📝 实施优先级

### 必须实现
- ✅ 运单号批量OR搜索
- ✅ 司机批量OR搜索
- ✅ 高级筛选展开/收起
- ✅ 申请单状态筛选（保留）

### 可选实现
- ⭐ 车牌号批量搜索
- ⭐ 电话批量搜索
- ⭐ 平台名称筛选

---

## ⏱️ 预计时间

| 任务 | 时间 |
|-----|------|
| 后端SQL函数修改 | 1小时 |
| PaymentAudit前端修改 | 1小时 |
| PaymentRequestsList前端修改 | 1小时 |
| 测试验证 | 0.5小时 |
| **总计** | **3.5小时** |

---

**准备开始实施吗？** 🚀

