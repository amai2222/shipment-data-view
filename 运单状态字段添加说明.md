# 运单状态字段添加说明

## 🎯 **需求说明**

为`logistics_records`表添加开票和付款状态字段，并在运单创建时设置初始值：
- `invoice_status` 初始值: `'Uninvoiced'` (未开票)
- `payment_status` 初始值: `'Uninvoiced'` (未开票)

## 📊 **新增字段列表**

### 1. 状态字段
| 字段名 | 类型 | 默认值 | 约束 | 说明 |
|--------|------|--------|------|------|
| `invoice_status` | TEXT | 'Uninvoiced' | CHECK约束 | 开票状态 |
| `payment_status` | TEXT | 'Uninvoiced' | CHECK约束 | 付款状态 |

### 2. 时间戳字段
| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `invoice_applied_at` | TIMESTAMPTZ | NULL | 开票申请时间 |
| `invoice_completed_at` | TIMESTAMPTZ | NULL | 开票完成时间 |
| `payment_applied_at` | TIMESTAMPTZ | NULL | 付款申请时间 |
| `payment_completed_at` | TIMESTAMPTZ | NULL | 付款完成时间 |

### 3. 关联字段
| 字段名 | 类型 | 默认值 | 外键 | 说明 |
|--------|------|--------|------|------|
| `invoice_request_id` | UUID | NULL | invoice_requests(id) | 关联的开票申请ID |
| `invoice_number` | TEXT | NULL | - | 发票号码 |
| `payment_request_id` | UUID | NULL | - | 关联的付款申请ID |
| `payment_reference` | TEXT | NULL | - | 付款参考号 |

## 🔧 **技术实现**

### 1. 字段约束
```sql
-- 开票状态约束
CHECK (invoice_status IN ('Uninvoiced', 'Processing', 'Invoiced'))

-- 付款状态约束  
CHECK (payment_status IN ('Uninvoiced', 'Processing', 'Paid'))
```

### 2. 默认值设置
```sql
-- 运单创建时自动设置默认值
CREATE OR REPLACE FUNCTION public.set_logistics_records_default_status()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.invoice_status IS NULL THEN
        NEW.invoice_status = 'Uninvoiced';
    END IF;
    
    IF NEW.payment_status IS NULL THEN
        NEW.payment_status = 'Uninvoiced';
    END IF;
    
    RETURN NEW;
END;
$$;
```

### 3. 自动时间戳更新
```sql
-- 状态变化时自动更新时间戳
CREATE OR REPLACE FUNCTION public.update_logistics_records_timestamps()
RETURNS TRIGGER AS $$
BEGIN
    -- 开票状态变化时更新时间戳
    IF OLD.invoice_status IS DISTINCT FROM NEW.invoice_status THEN
        IF NEW.invoice_status = 'Processing' AND OLD.invoice_status = 'Uninvoiced' THEN
            NEW.invoice_applied_at = NOW();
        ELSIF NEW.invoice_status = 'Invoiced' AND OLD.invoice_status = 'Processing' THEN
            NEW.invoice_completed_at = NOW();
        END IF;
    END IF;
    
    -- 付款状态变化时更新时间戳
    IF OLD.payment_status IS DISTINCT FROM NEW.payment_status THEN
        IF NEW.payment_status = 'Processing' AND OLD.payment_status = 'Uninvoiced' THEN
            NEW.payment_applied_at = NOW();
        ELSIF NEW.payment_status = 'Paid' AND OLD.payment_status = 'Processing' THEN
            NEW.payment_completed_at = NOW();
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$;
```

## 🔄 **状态流转过程**

### 开票状态流转
```
运单创建
    ↓
invoice_status = 'Uninvoiced' (未开票)
    ↓
创建开票申请
    ↓
invoice_status = 'Processing' (开票中)
invoice_applied_at = NOW()
    ↓
完成开票
    ↓
invoice_status = 'Invoiced' (已开票)
invoice_completed_at = NOW()
invoice_number = [发票号码]
```

### 付款状态流转
```
运单创建
    ↓
payment_status = 'Uninvoiced' (未付款)
    ↓
创建付款申请
    ↓
payment_status = 'Processing' (付款中)
payment_applied_at = NOW()
    ↓
完成付款
    ↓
payment_status = 'Paid' (已付款)
payment_completed_at = NOW()
payment_reference = [付款参考号]
```

## 📈 **新增功能**

### 1. 状态汇总视图
```sql
CREATE OR REPLACE VIEW public.logistics_records_status_summary AS
SELECT 
    lr.id,
    lr.auto_number,
    lr.project_name,
    lr.driver_name,
    -- 开票状态信息
    lr.invoice_status,
    lr.invoice_applied_at,
    lr.invoice_completed_at,
    lr.invoice_request_id,
    lr.invoice_number,
    -- 付款状态信息
    lr.payment_status,
    lr.payment_applied_at,
    lr.payment_completed_at,
    lr.payment_request_id,
    lr.payment_reference,
    -- 状态文本
    CASE 
        WHEN lr.invoice_status = 'Invoiced' THEN '已开票'
        WHEN lr.invoice_status = 'Processing' THEN '开票中'
        ELSE '未开票'
    END as invoice_status_text,
    CASE 
        WHEN lr.payment_status = 'Paid' THEN '已付款'
        WHEN lr.payment_status = 'Processing' THEN '付款中'
        ELSE '未付款'
    END as payment_status_text
FROM public.logistics_records lr;
```

### 2. 性能优化索引
```sql
-- 状态字段索引
CREATE INDEX idx_logistics_records_invoice_status ON public.logistics_records(invoice_status);
CREATE INDEX idx_logistics_records_payment_status ON public.logistics_records(payment_status);

-- 关联字段索引
CREATE INDEX idx_logistics_records_invoice_request_id ON public.logistics_records(invoice_request_id);
CREATE INDEX idx_logistics_records_payment_request_id ON public.logistics_records(payment_request_id);
```

## 🎯 **使用示例**

### 1. 运单创建后的初始状态
```sql
-- 运单创建后自动设置默认值
INSERT INTO logistics_records (auto_number, project_name, ...) 
VALUES ('20250116-001', '测试项目', ...);

-- 结果：
-- invoice_status = 'Uninvoiced'
-- payment_status = 'Uninvoiced'
-- invoice_applied_at = NULL
-- invoice_completed_at = NULL
-- payment_applied_at = NULL
-- payment_completed_at = NULL
-- invoice_request_id = NULL
-- invoice_number = NULL
-- payment_request_id = NULL
-- payment_reference = NULL
```

### 2. 创建开票申请
```sql
-- 更新运单状态为开票中
UPDATE logistics_records 
SET 
    invoice_status = 'Processing',
    invoice_request_id = 'uuid-1234-5678-9abc'
WHERE id = 'waybill-id';

-- 结果：
-- invoice_status = 'Processing'
-- invoice_applied_at = NOW() (自动设置)
-- 其他字段保持不变
```

### 3. 完成开票
```sql
-- 更新运单状态为已开票
UPDATE logistics_records 
SET 
    invoice_status = 'Invoiced',
    invoice_number = 'INV-2025-001'
WHERE id = 'waybill-id';

-- 结果：
-- invoice_status = 'Invoiced'
-- invoice_completed_at = NOW() (自动设置)
-- invoice_number = 'INV-2025-001'
```

## 📋 **总结**

### 新增功能
- ✅ 运单开票状态管理
- ✅ 运单付款状态管理
- ✅ 自动时间戳记录
- ✅ 状态流转控制
- ✅ 性能优化索引
- ✅ 状态汇总视图

### 技术特点
- ✅ **自动化**: 默认值和时间戳自动设置
- ✅ **一致性**: 通过触发器确保数据一致性
- ✅ **可追溯**: 完整的时间戳记录
- ✅ **性能优化**: 合理的索引设计
- ✅ **易于查询**: 状态汇总视图

现在运单创建时会自动设置正确的初始状态值！🎉
