# è¿å•çŠ¶æ€å­—æ®µæ·»åŠ è¯´æ˜

## ğŸ¯ **éœ€æ±‚è¯´æ˜**

ä¸º`logistics_records`è¡¨æ·»åŠ å¼€ç¥¨å’Œä»˜æ¬¾çŠ¶æ€å­—æ®µï¼Œå¹¶åœ¨è¿å•åˆ›å»ºæ—¶è®¾ç½®åˆå§‹å€¼ï¼š
- `invoice_status` åˆå§‹å€¼: `'Uninvoiced'` (æœªå¼€ç¥¨)
- `payment_status` åˆå§‹å€¼: `'Uninvoiced'` (æœªå¼€ç¥¨)

## ğŸ“Š **æ–°å¢å­—æ®µåˆ—è¡¨**

### 1. çŠ¶æ€å­—æ®µ
| å­—æ®µå | ç±»å‹ | é»˜è®¤å€¼ | çº¦æŸ | è¯´æ˜ |
|--------|------|--------|------|------|
| `invoice_status` | TEXT | 'Uninvoiced' | CHECKçº¦æŸ | å¼€ç¥¨çŠ¶æ€ |
| `payment_status` | TEXT | 'Uninvoiced' | CHECKçº¦æŸ | ä»˜æ¬¾çŠ¶æ€ |

### 2. æ—¶é—´æˆ³å­—æ®µ
| å­—æ®µå | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `invoice_applied_at` | TIMESTAMPTZ | NULL | å¼€ç¥¨ç”³è¯·æ—¶é—´ |
| `invoice_completed_at` | TIMESTAMPTZ | NULL | å¼€ç¥¨å®Œæˆæ—¶é—´ |
| `payment_applied_at` | TIMESTAMPTZ | NULL | ä»˜æ¬¾ç”³è¯·æ—¶é—´ |
| `payment_completed_at` | TIMESTAMPTZ | NULL | ä»˜æ¬¾å®Œæˆæ—¶é—´ |

### 3. å…³è”å­—æ®µ
| å­—æ®µå | ç±»å‹ | é»˜è®¤å€¼ | å¤–é”® | è¯´æ˜ |
|--------|------|--------|------|------|
| `invoice_request_id` | UUID | NULL | invoice_requests(id) | å…³è”çš„å¼€ç¥¨ç”³è¯·ID |
| `invoice_number` | TEXT | NULL | - | å‘ç¥¨å·ç  |
| `payment_request_id` | UUID | NULL | - | å…³è”çš„ä»˜æ¬¾ç”³è¯·ID |
| `payment_reference` | TEXT | NULL | - | ä»˜æ¬¾å‚è€ƒå· |

## ğŸ”§ **æŠ€æœ¯å®ç°**

### 1. å­—æ®µçº¦æŸ
```sql
-- å¼€ç¥¨çŠ¶æ€çº¦æŸ
CHECK (invoice_status IN ('Uninvoiced', 'Processing', 'Invoiced'))

-- ä»˜æ¬¾çŠ¶æ€çº¦æŸ  
CHECK (payment_status IN ('Uninvoiced', 'Processing', 'Paid'))
```

### 2. é»˜è®¤å€¼è®¾ç½®
```sql
-- è¿å•åˆ›å»ºæ—¶è‡ªåŠ¨è®¾ç½®é»˜è®¤å€¼
CREATE OR REPLACE FUNCTION public.set_logistics_records_default_status()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.invoice_status IS NULL THEN
        NEW.invoice_status = 'Uninvoiced';
    END IF;
    
    IF NEW.payment_status IS NULL THEN
        NEW.payment_status = 'Uninvoiced';
    END IF;
    
    RETURN NEW;
END;
$$;
```

### 3. è‡ªåŠ¨æ—¶é—´æˆ³æ›´æ–°
```sql
-- çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³
CREATE OR REPLACE FUNCTION public.update_logistics_records_timestamps()
RETURNS TRIGGER AS $$
BEGIN
    -- å¼€ç¥¨çŠ¶æ€å˜åŒ–æ—¶æ›´æ–°æ—¶é—´æˆ³
    IF OLD.invoice_status IS DISTINCT FROM NEW.invoice_status THEN
        IF NEW.invoice_status = 'Processing' AND OLD.invoice_status = 'Uninvoiced' THEN
            NEW.invoice_applied_at = NOW();
        ELSIF NEW.invoice_status = 'Invoiced' AND OLD.invoice_status = 'Processing' THEN
            NEW.invoice_completed_at = NOW();
        END IF;
    END IF;
    
    -- ä»˜æ¬¾çŠ¶æ€å˜åŒ–æ—¶æ›´æ–°æ—¶é—´æˆ³
    IF OLD.payment_status IS DISTINCT FROM NEW.payment_status THEN
        IF NEW.payment_status = 'Processing' AND OLD.payment_status = 'Uninvoiced' THEN
            NEW.payment_applied_at = NOW();
        ELSIF NEW.payment_status = 'Paid' AND OLD.payment_status = 'Processing' THEN
            NEW.payment_completed_at = NOW();
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$;
```

## ğŸ”„ **çŠ¶æ€æµè½¬è¿‡ç¨‹**

### å¼€ç¥¨çŠ¶æ€æµè½¬
```
è¿å•åˆ›å»º
    â†“
invoice_status = 'Uninvoiced' (æœªå¼€ç¥¨)
    â†“
åˆ›å»ºå¼€ç¥¨ç”³è¯·
    â†“
invoice_status = 'Processing' (å¼€ç¥¨ä¸­)
invoice_applied_at = NOW()
    â†“
å®Œæˆå¼€ç¥¨
    â†“
invoice_status = 'Invoiced' (å·²å¼€ç¥¨)
invoice_completed_at = NOW()
invoice_number = [å‘ç¥¨å·ç ]
```

### ä»˜æ¬¾çŠ¶æ€æµè½¬
```
è¿å•åˆ›å»º
    â†“
payment_status = 'Uninvoiced' (æœªä»˜æ¬¾)
    â†“
åˆ›å»ºä»˜æ¬¾ç”³è¯·
    â†“
payment_status = 'Processing' (ä»˜æ¬¾ä¸­)
payment_applied_at = NOW()
    â†“
å®Œæˆä»˜æ¬¾
    â†“
payment_status = 'Paid' (å·²ä»˜æ¬¾)
payment_completed_at = NOW()
payment_reference = [ä»˜æ¬¾å‚è€ƒå·]
```

## ğŸ“ˆ **æ–°å¢åŠŸèƒ½**

### 1. çŠ¶æ€æ±‡æ€»è§†å›¾
```sql
CREATE OR REPLACE VIEW public.logistics_records_status_summary AS
SELECT 
    lr.id,
    lr.auto_number,
    lr.project_name,
    lr.driver_name,
    -- å¼€ç¥¨çŠ¶æ€ä¿¡æ¯
    lr.invoice_status,
    lr.invoice_applied_at,
    lr.invoice_completed_at,
    lr.invoice_request_id,
    lr.invoice_number,
    -- ä»˜æ¬¾çŠ¶æ€ä¿¡æ¯
    lr.payment_status,
    lr.payment_applied_at,
    lr.payment_completed_at,
    lr.payment_request_id,
    lr.payment_reference,
    -- çŠ¶æ€æ–‡æœ¬
    CASE 
        WHEN lr.invoice_status = 'Invoiced' THEN 'å·²å¼€ç¥¨'
        WHEN lr.invoice_status = 'Processing' THEN 'å¼€ç¥¨ä¸­'
        ELSE 'æœªå¼€ç¥¨'
    END as invoice_status_text,
    CASE 
        WHEN lr.payment_status = 'Paid' THEN 'å·²ä»˜æ¬¾'
        WHEN lr.payment_status = 'Processing' THEN 'ä»˜æ¬¾ä¸­'
        ELSE 'æœªä»˜æ¬¾'
    END as payment_status_text
FROM public.logistics_records lr;
```

### 2. æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
```sql
-- çŠ¶æ€å­—æ®µç´¢å¼•
CREATE INDEX idx_logistics_records_invoice_status ON public.logistics_records(invoice_status);
CREATE INDEX idx_logistics_records_payment_status ON public.logistics_records(payment_status);

-- å…³è”å­—æ®µç´¢å¼•
CREATE INDEX idx_logistics_records_invoice_request_id ON public.logistics_records(invoice_request_id);
CREATE INDEX idx_logistics_records_payment_request_id ON public.logistics_records(payment_request_id);
```

## ğŸ¯ **ä½¿ç”¨ç¤ºä¾‹**

### 1. è¿å•åˆ›å»ºåçš„åˆå§‹çŠ¶æ€
```sql
-- è¿å•åˆ›å»ºåè‡ªåŠ¨è®¾ç½®é»˜è®¤å€¼
INSERT INTO logistics_records (auto_number, project_name, ...) 
VALUES ('20250116-001', 'æµ‹è¯•é¡¹ç›®', ...);

-- ç»“æœï¼š
-- invoice_status = 'Uninvoiced'
-- payment_status = 'Uninvoiced'
-- invoice_applied_at = NULL
-- invoice_completed_at = NULL
-- payment_applied_at = NULL
-- payment_completed_at = NULL
-- invoice_request_id = NULL
-- invoice_number = NULL
-- payment_request_id = NULL
-- payment_reference = NULL
```

### 2. åˆ›å»ºå¼€ç¥¨ç”³è¯·
```sql
-- æ›´æ–°è¿å•çŠ¶æ€ä¸ºå¼€ç¥¨ä¸­
UPDATE logistics_records 
SET 
    invoice_status = 'Processing',
    invoice_request_id = 'uuid-1234-5678-9abc'
WHERE id = 'waybill-id';

-- ç»“æœï¼š
-- invoice_status = 'Processing'
-- invoice_applied_at = NOW() (è‡ªåŠ¨è®¾ç½®)
-- å…¶ä»–å­—æ®µä¿æŒä¸å˜
```

### 3. å®Œæˆå¼€ç¥¨
```sql
-- æ›´æ–°è¿å•çŠ¶æ€ä¸ºå·²å¼€ç¥¨
UPDATE logistics_records 
SET 
    invoice_status = 'Invoiced',
    invoice_number = 'INV-2025-001'
WHERE id = 'waybill-id';

-- ç»“æœï¼š
-- invoice_status = 'Invoiced'
-- invoice_completed_at = NOW() (è‡ªåŠ¨è®¾ç½®)
-- invoice_number = 'INV-2025-001'
```

## ğŸ“‹ **æ€»ç»“**

### æ–°å¢åŠŸèƒ½
- âœ… è¿å•å¼€ç¥¨çŠ¶æ€ç®¡ç†
- âœ… è¿å•ä»˜æ¬¾çŠ¶æ€ç®¡ç†
- âœ… è‡ªåŠ¨æ—¶é—´æˆ³è®°å½•
- âœ… çŠ¶æ€æµè½¬æ§åˆ¶
- âœ… æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
- âœ… çŠ¶æ€æ±‡æ€»è§†å›¾

### æŠ€æœ¯ç‰¹ç‚¹
- âœ… **è‡ªåŠ¨åŒ–**: é»˜è®¤å€¼å’Œæ—¶é—´æˆ³è‡ªåŠ¨è®¾ç½®
- âœ… **ä¸€è‡´æ€§**: é€šè¿‡è§¦å‘å™¨ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- âœ… **å¯è¿½æº¯**: å®Œæ•´çš„æ—¶é—´æˆ³è®°å½•
- âœ… **æ€§èƒ½ä¼˜åŒ–**: åˆç†çš„ç´¢å¼•è®¾è®¡
- âœ… **æ˜“äºæŸ¥è¯¢**: çŠ¶æ€æ±‡æ€»è§†å›¾

ç°åœ¨è¿å•åˆ›å»ºæ—¶ä¼šè‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„åˆå§‹çŠ¶æ€å€¼ï¼ğŸ‰
