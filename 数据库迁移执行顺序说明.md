# 数据库迁移执行顺序说明

## 📅 更新日期
2025-01-22

## ⚠️ 重要说明

由于 PostgreSQL 枚举类型的限制，必须**按照特定顺序**执行迁移文件。

---

## 📋 正确的执行顺序

### 1️⃣ 第一步：创建枚举类型和基础字段

**文件**：`supabase/migrations/20250122_add_partner_type.sql`

**功能**：
- 创建 `partner_type_enum` 枚举类型（包含：货主、合作商）
- 添加 `partner_type` 字段到 `partners` 表
- 设置默认值为 '货主'
- 创建索引

**执行命令**：
```bash
# 使用 Supabase CLI
supabase db push

# 或在 Supabase Dashboard SQL Editor 中执行该文件内容
```

**预期结果**：
```
✅ 枚举类型 partner_type_enum 已创建（货主, 合作商）
✅ partner_type 字段已添加
✅ 索引已创建
```

---

### 2️⃣ 第二步：添加新的枚举值

**文件**：`supabase/migrations/20250122_add_partner_type_values.sql`

**功能**：
- 添加 '资方' 枚举值
- 添加 '本公司' 枚举值

**执行命令**：
```bash
# 使用 Supabase CLI
supabase db push

# 或在 Supabase Dashboard SQL Editor 中执行该文件内容
```

**预期结果**：
```
✅ 已添加枚举值: 资方
✅ 已添加枚举值: 本公司
✅ 当前枚举值: 货主, 合作商, 资方, 本公司
```

---

### 3️⃣ 第三步：更新层级管理功能

**文件**：`supabase/migrations/20250122_update_hierarchy_to_owner_only.sql`

**功能**：
- 清理非货主类型的层级信息
- 更新触发器（只处理货主）
- 更新查询函数（只返回货主）
- 更新视图（只显示货主）

**执行命令**：
```bash
# 使用 Supabase CLI
supabase db push

# 或在 Supabase Dashboard SQL Editor 中执行该文件内容
```

**预期结果**：
```
✅ 非货主类型的层级字段已清空
✅ 触发器已更新
✅ 查询函数已更新
✅ 视图已更新
```

---

## 🎯 一键执行（推荐）

如果使用 Supabase CLI，可以一次性执行所有迁移：

```bash
cd /path/to/your/project
supabase db push
```

Supabase CLI 会自动按照文件名顺序执行：
1. `20250122_add_partner_type.sql`
2. `20250122_add_partner_type_values.sql`
3. `20250122_update_hierarchy_to_owner_only.sql`

---

## 🔍 验证迁移结果

### 1. 验证枚举类型

```sql
-- 查看所有枚举值
SELECT enumlabel 
FROM pg_enum 
WHERE enumtypid = 'partner_type_enum'::regtype
ORDER BY enumsortorder;

-- 预期结果：
-- 货主
-- 合作商
-- 资方
-- 本公司
```

### 2. 验证字段和索引

```sql
-- 查看字段信息
SELECT 
    column_name,
    data_type,
    column_default,
    is_nullable
FROM information_schema.columns
WHERE table_name = 'partners' 
  AND column_name = 'partner_type';

-- 查看索引
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'partners' 
  AND indexname LIKE '%partner_type%';
```

### 3. 验证层级功能

```sql
-- 查看货主统计
SELECT 
    partner_type,
    COUNT(*) as total,
    COUNT(CASE WHEN is_root = TRUE THEN 1 END) as root_count,
    COUNT(CASE WHEN parent_partner_id IS NOT NULL THEN 1 END) as has_parent
FROM partners
GROUP BY partner_type;
```

---

## ❌ 常见错误及解决方案

### 错误 1：枚举值不存在

**错误信息**：
```
ERROR: 22P02: invalid input value for enum partner_type_enum: "资方"
```

**原因**：没有执行第二步的迁移文件

**解决方案**：
```bash
# 执行添加枚举值的迁移
supabase db push

# 或手动执行
# supabase/migrations/20250122_add_partner_type_values.sql
```

### 错误 2：枚举类型已存在

**错误信息**：
```
ERROR: type "partner_type_enum" already exists
```

**原因**：重复执行了第一步的迁移

**解决方案**：
这是正常的，迁移脚本中有判断，会自动跳过。如果想重新创建：

```sql
-- 1. 删除使用该枚举的字段
ALTER TABLE partners DROP COLUMN IF EXISTS partner_type;

-- 2. 删除枚举类型
DROP TYPE IF EXISTS partner_type_enum;

-- 3. 重新执行迁移
```

### 错误 3：ALTER TYPE ADD VALUE 在事务中执行

**错误信息**：
```
ERROR: ALTER TYPE ... ADD VALUE cannot run inside a transaction block
```

**原因**：在事务块（BEGIN/COMMIT）中执行了 ALTER TYPE ADD VALUE

**解决方案**：
我们的迁移文件已经使用 DO $$ 块来避免这个问题。如果仍然出现：

1. 确保不是在显式的事务块中执行
2. 分别执行每个迁移文件

---

## 🔄 回滚方案

如果需要回滚迁移：

```sql
BEGIN;

-- 删除索引
DROP INDEX IF EXISTS idx_partners_type_created;
DROP INDEX IF EXISTS idx_partners_partner_type;

-- 删除字段
ALTER TABLE partners DROP COLUMN IF EXISTS partner_type;

-- 删除枚举类型
DROP TYPE IF EXISTS partner_type_enum;

COMMIT;
```

---

## 📝 迁移文件说明

| 文件名 | 功能 | 依赖 | 必需 |
|--------|------|------|------|
| `20250122_add_partner_type.sql` | 创建枚举和字段 | 无 | ✅ 是 |
| `20250122_add_partner_type_values.sql` | 添加新枚举值 | 第1个文件 | ✅ 是 |
| `20250122_update_hierarchy_to_owner_only.sql` | 更新层级管理 | 前2个文件 | ✅ 是 |

---

## ✅ 完成检查清单

执行完所有迁移后，请确认：

- [ ] 枚举类型包含 4 个值（货主、合作商、资方、本公司）
- [ ] `partners` 表有 `partner_type` 字段
- [ ] 默认值为 '货主'
- [ ] 索引已创建
- [ ] 非货主类型的层级字段为 NULL
- [ ] 触发器正常工作（测试创建货主和合作商）
- [ ] 视图只显示货主
- [ ] 统计函数只统计货主

---

## 📞 技术支持

如果遇到问题，请检查：
1. ✅ 迁移文件执行顺序是否正确
2. ✅ 数据库连接是否正常
3. ✅ 是否有足够的权限执行 DDL 操作
4. ✅ 是否在事务块外执行（对于 ALTER TYPE ADD VALUE）

---

**更新时间**: 2025-01-22
**版本**: v1.0

