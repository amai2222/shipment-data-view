# 司机项目关联修复 - 回滚指南

## 📋 备份信息

### 备份文件
- **文件名**: `supabase/migrations/BACKUP_20250816_import_logistics_data_before_fix.sql`
- **备份时间**: 2025-01-16
- **原始版本**: 20250815002507_52f1c75f-1307-43c6-bdd6-77dcdaff472d.sql

### 备份内容
✅ `import_logistics_data` 函数（完整版本）  
✅ `recalculate_and_update_costs_for_records` 函数（辅助函数）

## 🔄 回滚步骤

### 方法1：使用Supabase控制台（推荐）

1. **登录Supabase控制台**
   - 打开项目的Supabase控制台
   - 进入 SQL Editor

2. **运行备份文件**
   - 点击 "New query"
   - 复制备份文件内容
   - 粘贴到编辑器
   - 点击 "Run" 执行

3. **验证回滚成功**
   ```sql
   -- 检查函数是否已恢复
   SELECT 
       proname AS 函数名,
       pg_get_functiondef(oid) AS 函数定义
   FROM pg_proc 
   WHERE proname = 'import_logistics_data';
   ```

### 方法2：使用命令行

```bash
# 1. 连接到数据库
psql -h [your-host].supabase.co -U postgres -d postgres

# 2. 运行备份文件
\i supabase/migrations/BACKUP_20250816_import_logistics_data_before_fix.sql

# 3. 验证
SELECT proname FROM pg_proc WHERE proname = 'import_logistics_data';
```

### 方法3：使用Supabase CLI

```bash
# 1. 重置到特定迁移之前
supabase db reset

# 2. 或者手动应用备份
supabase db execute -f supabase/migrations/BACKUP_20250816_import_logistics_data_before_fix.sql
```

## ⚠️ 回滚注意事项

### 数据影响

**回滚后的行为：**
- ✅ 新建的司机会关联到项目（正常）
- ❌ 已存在的司机不会关联到项目（BUG恢复）

### 什么时候需要回滚？

1. **新版本导致导入失败**
   - 如果运行新的迁移后，Excel导入出现错误
   - 导入成功率明显下降

2. **数据关联异常**
   - 司机关联了错误的项目
   - 出现重复的关联记录

3. **性能问题**
   - 导入速度明显变慢
   - 数据库负载异常增加

### 回滚前检查

在回滚之前，建议先检查：

1. **查看错误日志**
   ```sql
   -- 查看最近的导入错误
   SELECT * FROM logs 
   WHERE event_type = 'import_error' 
   ORDER BY created_at DESC 
   LIMIT 10;
   ```

2. **检查司机关联情况**
   ```sql
   -- 统计司机项目关联数量
   SELECT 
       d.name AS 司机姓名,
       COUNT(dp.project_id) AS 关联项目数
   FROM drivers d
   LEFT JOIN driver_projects dp ON d.id = dp.driver_id
   GROUP BY d.id, d.name
   ORDER BY COUNT(dp.project_id) DESC;
   ```

3. **验证导入记录**
   ```sql
   -- 查看最近的导入记录
   SELECT * FROM logistics_records 
   WHERE created_at > NOW() - INTERVAL '1 hour'
   ORDER BY created_at DESC;
   ```

## 🔍 故障排查

### 问题1：回滚后仍有问题

**解决方案：**
1. 清除缓存
   ```sql
   -- 清除函数缓存
   DISCARD ALL;
   ```

2. 重启数据库连接
   - 断开所有客户端连接
   - 重新连接

### 问题2：备份文件找不到

**解决方案：**
1. 在版本控制中查找：
   ```bash
   git show HEAD:supabase/migrations/BACKUP_20250816_import_logistics_data_before_fix.sql
   ```

2. 从原始迁移文件恢复：
   ```bash
   git show HEAD:supabase/migrations/20250815002507_52f1c75f-1307-43c6-bdd6-77dcdaff472d.sql
   ```

### 问题3：回滚后数据不一致

**解决方案：**

1. **检查孤立的司机**（有运单但没有项目关联）
   ```sql
   SELECT DISTINCT 
       lr.driver_id,
       lr.driver_name,
       lr.project_id,
       lr.project_name
   FROM logistics_records lr
   LEFT JOIN driver_projects dp ON lr.driver_id = dp.driver_id AND lr.project_id = dp.project_id
   WHERE dp.driver_id IS NULL;
   ```

2. **手动修复关联**
   ```sql
   -- 为孤立的司机创建项目关联
   INSERT INTO driver_projects (driver_id, project_id, user_id)
   SELECT DISTINCT 
       lr.driver_id,
       lr.project_id,
       lr.user_id
   FROM logistics_records lr
   LEFT JOIN driver_projects dp ON lr.driver_id = dp.driver_id AND lr.project_id = dp.project_id
   WHERE dp.driver_id IS NULL
   ON CONFLICT (driver_id, project_id) DO NOTHING;
   ```

## 📞 获取帮助

### 联系方式

如果回滚过程中遇到问题：

1. **查看文档**
   - [Excel导入司机项目关联修复说明.md](./Excel导入司机项目关联修复说明.md)
   - [司机自动关联项目功能使用说明.md](./司机自动关联项目功能使用说明.md)

2. **检查日志**
   ```sql
   -- 查看系统日志
   SELECT * FROM pg_stat_activity WHERE state = 'active';
   ```

3. **数据库健康检查**
   ```sql
   -- 检查表大小
   SELECT 
       schemaname,
       tablename,
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
   FROM pg_tables
   WHERE schemaname = 'public'
   ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
   ```

## ✅ 验证清单

回滚完成后，请验证以下内容：

- [ ] 函数已恢复到备份版本
- [ ] Excel导入功能正常工作
- [ ] 新建司机能正确关联到项目
- [ ] 现有运单数据完整
- [ ] 没有报错或异常日志
- [ ] 业务录入功能正常
- [ ] 运单维护功能正常

## 📝 回滚记录

如果执行了回滚，请记录：

- **回滚时间**: ___________
- **执行人**: ___________
- **回滚原因**: ___________
- **验证结果**: ___________
- **后续计划**: ___________

---

**重要提示**: 
- 回滚是安全的，不会丢失数据
- 只会恢复函数定义到修改前的状态
- 已导入的运单数据不会受影响

