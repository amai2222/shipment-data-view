# 快速开始 - 清理孤立用户

## 🎯 5分钟解决用户不同步问题

### 问题现象

```
❌ 错误: A user with this email address has already been registered
✅ 但是在用户管理界面看不到这个用户
```

---

## 🚀 快速解决方案

### 方法 1: 使用前端界面（最简单）

1. **打开用户管理**
   ```
   登录系统 → 设置 → 用户管理
   ```

2. **找到"孤立用户清理工具"卡片**
   - 在用户列表上方
   - 带有黄色警告图标

3. **点击"清理"按钮**
   - 系统会显示所有孤立用户
   - 点击要删除的用户旁边的"清理"按钮
   - 确认删除
   - 完成！✅

4. **重新注册用户**
   - 现在可以重新使用该邮箱注册了

---

### 方法 2: 使用 SQL（最快速）

1. **打开 Supabase Dashboard**
   ```
   https://app.supabase.com
   ```

2. **进入 SQL Editor**
   ```
   左侧菜单 → SQL Editor → New Query
   ```

3. **查看孤立用户**
   ```sql
   SELECT * FROM public.cleanup_orphaned_auth_users();
   ```

4. **删除孤立用户**
   ```sql
   -- 替换成实际邮箱地址
   SELECT public.delete_auth_user_by_email('drnuxue@gmail.com');
   ```

5. **验证结果**
   ```sql
   -- 应该返回空结果
   SELECT * FROM public.cleanup_orphaned_auth_users();
   ```

---

## 📋 部署清单

### 必须执行（首次使用）

#### 1️⃣ 部署数据库迁移

**方式 A: 在 Supabase Dashboard 执行**

1. 打开 Supabase Dashboard → SQL Editor
2. 新建查询
3. 复制并执行文件内容：
   ```
   supabase/migrations/20251101_auto_sync_user_deletion.sql
   ```
4. 点击 Run

**方式 B: 使用 CLI**

```bash
cd supabase
supabase db push
```

#### 2️⃣ 部署 Edge Function

```bash
supabase functions deploy delete-user
```

#### 3️⃣ 刷新前端（如果已经在运行）

```bash
# 重启开发服务器
npm run dev
```

---

## ✅ 验证清单

执行以下检查确保部署成功：

### 1. 检查数据库函数

```sql
-- 应该返回函数信息，不报错
SELECT proname, prosrc 
FROM pg_proc 
WHERE proname IN ('cleanup_orphaned_auth_users', 'delete_auth_user_by_email');
```

### 2. 检查触发器

```sql
-- 应该返回触发器信息
SELECT * FROM pg_trigger 
WHERE tgname = 'auto_cleanup_auth_user_trigger';
```

### 3. 测试查询孤立用户

```sql
-- 应该返回结果（可能为空）
SELECT * FROM public.cleanup_orphaned_auth_users();
```

### 4. 检查前端界面

- 打开用户管理页面
- 应该能看到"孤立用户清理工具"卡片
- 如果没有孤立用户，显示"没有发现孤立用户"

---

## 🔧 常见问题快速修复

### Q: 执行 SQL 时报错 "function does not exist"

**解决:**
```sql
-- 重新创建函数（执行完整的迁移文件）
-- 文件: supabase/migrations/20251101_auto_sync_user_deletion.sql
```

### Q: 前端看不到清理工具

**解决:**
1. 清除浏览器缓存
2. 重启开发服务器
3. 检查是否是管理员账户登录

### Q: 删除孤立用户时报"权限不足"

**解决:**
```sql
-- 检查您的角色
SELECT role FROM profiles WHERE id = auth.uid();

-- 应该返回 'admin' 或 'super_admin'
```

### Q: 触发器不工作

**临时解决方案（手动清理）:**

1. 使用前端清理工具
2. 或使用 SQL 函数手动清理
3. 触发器是额外保护，不是必需的

---

## 📊 操作示例

### 完整操作流程示例

假设您要清理邮箱 `drnuxue@gmail.com`：

```sql
-- 1. 确认该用户确实是孤立的
SELECT * FROM public.cleanup_orphaned_auth_users()
WHERE email = 'drnuxue@gmail.com';

-- 应该返回:
-- auth_user_id | email              | created_at | action
-- -------------|-------------------|------------|--------
-- xxx-xxx-xxx  | drnuxue@gmail.com | 2025-11-01 | 发现孤立用户

-- 2. 删除孤立用户
SELECT public.delete_auth_user_by_email('drnuxue@gmail.com');

-- 应该返回:
-- {"success": true, "message": "已成功删除孤立的认证用户", ...}

-- 3. 验证删除成功
SELECT * FROM public.cleanup_orphaned_auth_users()
WHERE email = 'drnuxue@gmail.com';

-- 应该返回空结果

-- 4. 验证可以重新注册
-- 现在可以使用该邮箱创建新用户了
```

---

## 🎓 预防措施

### 以后创建/删除用户时：

1. **统一使用 Edge Function**
   - 创建: 调用 `create-user` Edge Function
   - 删除: 调用 `delete-user` Edge Function

2. **不要直接操作数据库**
   - ❌ 不要直接 DELETE FROM profiles
   - ✅ 使用系统提供的删除功能

3. **定期检查**
   ```sql
   -- 每周执行一次
   SELECT COUNT(*) FROM public.cleanup_orphaned_auth_users();
   -- 结果应该是 0
   ```

---

## 📞 需要帮助？

如果以上步骤无法解决您的问题：

1. 检查完整文档: `docs/用户同步删除系统说明.md`
2. 查看 Supabase 日志
3. 检查 Edge Function 日志

---

## 🎉 完成！

现在您的系统已经：

- ✅ 可以清理孤立用户
- ✅ 自动防止将来出现不同步
- ✅ 可以重新使用之前"被占用"的邮箱

**祝您使用愉快！** 🚀

