# å¿«é€Ÿå¼€å§‹ - æ¸…ç†å­¤ç«‹ç”¨æˆ·

## ğŸ¯ 5åˆ†é’Ÿè§£å†³ç”¨æˆ·ä¸åŒæ­¥é—®é¢˜

### é—®é¢˜ç°è±¡

```
âŒ é”™è¯¯: A user with this email address has already been registered
âœ… ä½†æ˜¯åœ¨ç”¨æˆ·ç®¡ç†ç•Œé¢çœ‹ä¸åˆ°è¿™ä¸ªç”¨æˆ·
```

---

## ğŸš€ å¿«é€Ÿè§£å†³æ–¹æ¡ˆ

### æ–¹æ³• 1: ä½¿ç”¨å‰ç«¯ç•Œé¢ï¼ˆæœ€ç®€å•ï¼‰

1. **æ‰“å¼€ç”¨æˆ·ç®¡ç†**
   ```
   ç™»å½•ç³»ç»Ÿ â†’ è®¾ç½® â†’ ç”¨æˆ·ç®¡ç†
   ```

2. **æ‰¾åˆ°"å­¤ç«‹ç”¨æˆ·æ¸…ç†å·¥å…·"å¡ç‰‡**
   - åœ¨ç”¨æˆ·åˆ—è¡¨ä¸Šæ–¹
   - å¸¦æœ‰é»„è‰²è­¦å‘Šå›¾æ ‡

3. **ç‚¹å‡»"æ¸…ç†"æŒ‰é’®**
   - ç³»ç»Ÿä¼šæ˜¾ç¤ºæ‰€æœ‰å­¤ç«‹ç”¨æˆ·
   - ç‚¹å‡»è¦åˆ é™¤çš„ç”¨æˆ·æ—è¾¹çš„"æ¸…ç†"æŒ‰é’®
   - ç¡®è®¤åˆ é™¤
   - å®Œæˆï¼âœ…

4. **é‡æ–°æ³¨å†Œç”¨æˆ·**
   - ç°åœ¨å¯ä»¥é‡æ–°ä½¿ç”¨è¯¥é‚®ç®±æ³¨å†Œäº†

---

### æ–¹æ³• 2: ä½¿ç”¨ SQLï¼ˆæœ€å¿«é€Ÿï¼‰

1. **æ‰“å¼€ Supabase Dashboard**
   ```
   https://app.supabase.com
   ```

2. **è¿›å…¥ SQL Editor**
   ```
   å·¦ä¾§èœå• â†’ SQL Editor â†’ New Query
   ```

3. **æŸ¥çœ‹å­¤ç«‹ç”¨æˆ·**
   ```sql
   SELECT * FROM public.cleanup_orphaned_auth_users();
   ```

4. **åˆ é™¤å­¤ç«‹ç”¨æˆ·**
   ```sql
   -- æ›¿æ¢æˆå®é™…é‚®ç®±åœ°å€
   SELECT public.delete_auth_user_by_email('drnuxue@gmail.com');
   ```

5. **éªŒè¯ç»“æœ**
   ```sql
   -- åº”è¯¥è¿”å›ç©ºç»“æœ
   SELECT * FROM public.cleanup_orphaned_auth_users();
   ```

---

## ğŸ“‹ éƒ¨ç½²æ¸…å•

### å¿…é¡»æ‰§è¡Œï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰

#### 1ï¸âƒ£ éƒ¨ç½²æ•°æ®åº“è¿ç§»

**æ–¹å¼ A: åœ¨ Supabase Dashboard æ‰§è¡Œ**

1. æ‰“å¼€ Supabase Dashboard â†’ SQL Editor
2. æ–°å»ºæŸ¥è¯¢
3. å¤åˆ¶å¹¶æ‰§è¡Œæ–‡ä»¶å†…å®¹ï¼š
   ```
   supabase/migrations/20251101_auto_sync_user_deletion.sql
   ```
4. ç‚¹å‡» Run

**æ–¹å¼ B: ä½¿ç”¨ CLI**

```bash
cd supabase
supabase db push
```

#### 2ï¸âƒ£ éƒ¨ç½² Edge Function

```bash
supabase functions deploy delete-user
```

#### 3ï¸âƒ£ åˆ·æ–°å‰ç«¯ï¼ˆå¦‚æœå·²ç»åœ¨è¿è¡Œï¼‰

```bash
# é‡å¯å¼€å‘æœåŠ¡å™¨
npm run dev
```

---

## âœ… éªŒè¯æ¸…å•

æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ç¡®ä¿éƒ¨ç½²æˆåŠŸï¼š

### 1. æ£€æŸ¥æ•°æ®åº“å‡½æ•°

```sql
-- åº”è¯¥è¿”å›å‡½æ•°ä¿¡æ¯ï¼Œä¸æŠ¥é”™
SELECT proname, prosrc 
FROM pg_proc 
WHERE proname IN ('cleanup_orphaned_auth_users', 'delete_auth_user_by_email');
```

### 2. æ£€æŸ¥è§¦å‘å™¨

```sql
-- åº”è¯¥è¿”å›è§¦å‘å™¨ä¿¡æ¯
SELECT * FROM pg_trigger 
WHERE tgname = 'auto_cleanup_auth_user_trigger';
```

### 3. æµ‹è¯•æŸ¥è¯¢å­¤ç«‹ç”¨æˆ·

```sql
-- åº”è¯¥è¿”å›ç»“æœï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
SELECT * FROM public.cleanup_orphaned_auth_users();
```

### 4. æ£€æŸ¥å‰ç«¯ç•Œé¢

- æ‰“å¼€ç”¨æˆ·ç®¡ç†é¡µé¢
- åº”è¯¥èƒ½çœ‹åˆ°"å­¤ç«‹ç”¨æˆ·æ¸…ç†å·¥å…·"å¡ç‰‡
- å¦‚æœæ²¡æœ‰å­¤ç«‹ç”¨æˆ·ï¼Œæ˜¾ç¤º"æ²¡æœ‰å‘ç°å­¤ç«‹ç”¨æˆ·"

---

## ğŸ”§ å¸¸è§é—®é¢˜å¿«é€Ÿä¿®å¤

### Q: æ‰§è¡Œ SQL æ—¶æŠ¥é”™ "function does not exist"

**è§£å†³:**
```sql
-- é‡æ–°åˆ›å»ºå‡½æ•°ï¼ˆæ‰§è¡Œå®Œæ•´çš„è¿ç§»æ–‡ä»¶ï¼‰
-- æ–‡ä»¶: supabase/migrations/20251101_auto_sync_user_deletion.sql
```

### Q: å‰ç«¯çœ‹ä¸åˆ°æ¸…ç†å·¥å…·

**è§£å†³:**
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
2. é‡å¯å¼€å‘æœåŠ¡å™¨
3. æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜è´¦æˆ·ç™»å½•

### Q: åˆ é™¤å­¤ç«‹ç”¨æˆ·æ—¶æŠ¥"æƒé™ä¸è¶³"

**è§£å†³:**
```sql
-- æ£€æŸ¥æ‚¨çš„è§’è‰²
SELECT role FROM profiles WHERE id = auth.uid();

-- åº”è¯¥è¿”å› 'admin' æˆ– 'super_admin'
```

### Q: è§¦å‘å™¨ä¸å·¥ä½œ

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼ˆæ‰‹åŠ¨æ¸…ç†ï¼‰:**

1. ä½¿ç”¨å‰ç«¯æ¸…ç†å·¥å…·
2. æˆ–ä½¿ç”¨ SQL å‡½æ•°æ‰‹åŠ¨æ¸…ç†
3. è§¦å‘å™¨æ˜¯é¢å¤–ä¿æŠ¤ï¼Œä¸æ˜¯å¿…éœ€çš„

---

## ğŸ“Š æ“ä½œç¤ºä¾‹

### å®Œæ•´æ“ä½œæµç¨‹ç¤ºä¾‹

å‡è®¾æ‚¨è¦æ¸…ç†é‚®ç®± `drnuxue@gmail.com`ï¼š

```sql
-- 1. ç¡®è®¤è¯¥ç”¨æˆ·ç¡®å®æ˜¯å­¤ç«‹çš„
SELECT * FROM public.cleanup_orphaned_auth_users()
WHERE email = 'drnuxue@gmail.com';

-- åº”è¯¥è¿”å›:
-- auth_user_id | email              | created_at | action
-- -------------|-------------------|------------|--------
-- xxx-xxx-xxx  | drnuxue@gmail.com | 2025-11-01 | å‘ç°å­¤ç«‹ç”¨æˆ·

-- 2. åˆ é™¤å­¤ç«‹ç”¨æˆ·
SELECT public.delete_auth_user_by_email('drnuxue@gmail.com');

-- åº”è¯¥è¿”å›:
-- {"success": true, "message": "å·²æˆåŠŸåˆ é™¤å­¤ç«‹çš„è®¤è¯ç”¨æˆ·", ...}

-- 3. éªŒè¯åˆ é™¤æˆåŠŸ
SELECT * FROM public.cleanup_orphaned_auth_users()
WHERE email = 'drnuxue@gmail.com';

-- åº”è¯¥è¿”å›ç©ºç»“æœ

-- 4. éªŒè¯å¯ä»¥é‡æ–°æ³¨å†Œ
-- ç°åœ¨å¯ä»¥ä½¿ç”¨è¯¥é‚®ç®±åˆ›å»ºæ–°ç”¨æˆ·äº†
```

---

## ğŸ“ é¢„é˜²æªæ–½

### ä»¥ååˆ›å»º/åˆ é™¤ç”¨æˆ·æ—¶ï¼š

1. **ç»Ÿä¸€ä½¿ç”¨ Edge Function**
   - åˆ›å»º: è°ƒç”¨ `create-user` Edge Function
   - åˆ é™¤: è°ƒç”¨ `delete-user` Edge Function

2. **ä¸è¦ç›´æ¥æ“ä½œæ•°æ®åº“**
   - âŒ ä¸è¦ç›´æ¥ DELETE FROM profiles
   - âœ… ä½¿ç”¨ç³»ç»Ÿæä¾›çš„åˆ é™¤åŠŸèƒ½

3. **å®šæœŸæ£€æŸ¥**
   ```sql
   -- æ¯å‘¨æ‰§è¡Œä¸€æ¬¡
   SELECT COUNT(*) FROM public.cleanup_orphaned_auth_users();
   -- ç»“æœåº”è¯¥æ˜¯ 0
   ```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœä»¥ä¸Šæ­¥éª¤æ— æ³•è§£å†³æ‚¨çš„é—®é¢˜ï¼š

1. æ£€æŸ¥å®Œæ•´æ–‡æ¡£: `docs/ç”¨æˆ·åŒæ­¥åˆ é™¤ç³»ç»Ÿè¯´æ˜.md`
2. æŸ¥çœ‹ Supabase æ—¥å¿—
3. æ£€æŸ¥ Edge Function æ—¥å¿—

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨æ‚¨çš„ç³»ç»Ÿå·²ç»ï¼š

- âœ… å¯ä»¥æ¸…ç†å­¤ç«‹ç”¨æˆ·
- âœ… è‡ªåŠ¨é˜²æ­¢å°†æ¥å‡ºç°ä¸åŒæ­¥
- âœ… å¯ä»¥é‡æ–°ä½¿ç”¨ä¹‹å‰"è¢«å ç”¨"çš„é‚®ç®±

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼** ğŸš€

