# 平台字段导入测试修复说明

## 问题分析

测试脚本 `scripts/test-platform-fields-import.sql` 执行失败，错误信息：

```
ERROR: 23503: insert or update on table "projects" violates foreign key constraint "projects_user_id_fkey"
DETAIL: Key (user_id) = (7136e5fd-08ae-47ea-a22b-34c1a1475206) is not present in table "users".
```

## 问题原因

1. **外键约束**：`projects` 表的 `user_id` 字段有外键约束，必须引用 `auth.users` 表中存在的用户
2. **测试用户不存在**：硬编码的测试用户ID `7136e5fd-08ae-47ea-a22b-34c1a1475206` 在数据库中不存在
3. **权限问题**：在 Supabase SQL 编辑器中执行时，可能没有有效的用户会话

## 修复方案

### 1. 修复原测试脚本

**文件**: `scripts/test-platform-fields-import.sql`

**修复内容**：
- 动态获取当前用户ID：`SELECT auth.uid() INTO test_user_id`
- 如果获取不到用户ID，使用默认值：`'00000000-0000-0000-0000-000000000000'::uuid`
- 避免硬编码不存在的用户ID

**修复后的逻辑**：
```sql
-- 获取当前用户ID，如果不存在则使用默认值
SELECT auth.uid() INTO test_user_id;
IF test_user_id IS NULL THEN
    test_user_id := '00000000-0000-0000-0000-000000000000'::uuid;
END IF;
```

### 2. 创建简化版测试脚本

**文件**: `scripts/test-platform-fields-import-simple.sql`

**特点**：
- 不创建需要外键约束的测试数据
- 只测试数据库函数的存在性和基本功能
- 检查表结构是否包含平台字段
- 避免外键约束问题

**测试内容**：
1. 测试 `preview_import_with_duplicates_check` 函数
2. 测试 `batch_import_logistics_records` 函数存在性
3. 检查 `logistics_records` 表结构
4. 验证平台字段是否存在

## 执行建议

### 方案1：使用修复后的原脚本
```sql
-- 在 Supabase SQL 编辑器中执行
\i scripts/test-platform-fields-import.sql
```

**前提条件**：
- 需要有效的用户会话
- 或者确保测试用户ID在数据库中存在

### 方案2：使用简化版脚本（推荐）
```sql
-- 在 Supabase SQL 编辑器中执行
\i scripts/test-platform-fields-import-simple.sql
```

**优势**：
- 不依赖用户会话
- 不创建测试数据
- 只验证功能存在性
- 更安全，不会影响现有数据

## 测试结果验证

### 成功标志
如果看到以下输出，说明测试成功：
```
✅ preview_import_with_duplicates_check 函数支持平台字段
✅ batch_import_logistics_records 函数存在
✅ logistics_records 表包含 external_tracking_numbers 字段
✅ logistics_records 表包含 other_platform_names 字段
```

### 失败标志
如果看到以下输出，说明需要进一步修复：
```
❌ preview_import_with_duplicates_check 函数不支持平台字段
❌ batch_import_logistics_records 函数不存在
❌ logistics_records 表缺少 external_tracking_numbers 字段
❌ logistics_records 表缺少 other_platform_names 字段
```

## 后续步骤

### 1. 如果测试成功
- 平台字段导入功能已修复
- 可以正常使用数据维护和运单管理的Excel导入功能
- 平台字段会被正确导入到数据库

### 2. 如果测试失败
- 需要执行 `scripts/fix-platform-fields-in-import.sql` 修复数据库函数
- 检查数据库表结构是否包含平台字段
- 确认前端代码是否正确处理平台字段

## 注意事项

### 1. 用户权限
- 在 Supabase 中执行SQL时，确保有足够的权限
- 如果使用默认用户ID，某些操作可能受限

### 2. 数据安全
- 测试脚本会清理测试数据
- 不会影响现有的业务数据
- 建议在测试环境中先验证

### 3. 函数依赖
- 确保 `preview_import_with_duplicates_check` 函数已更新
- 确保 `batch_import_logistics_records` 函数已更新
- 确保数据库表结构包含平台字段

## 总结

通过修复测试脚本中的外键约束问题，现在可以安全地测试平台字段导入功能。建议使用简化版测试脚本，它更安全且不依赖用户会话，能够有效验证功能是否正常工作。
