# åŽå°å‡½æ•°æ—¶åŒºé—®é¢˜åˆ†æžæŠ¥å‘Š

## ðŸ“‹ åˆ†æžèŒƒå›´

æ£€æŸ¥æ‰€æœ‰åŽç«¯RPCå‡½æ•°ä¸­æ¶‰åŠæ—¥æœŸå‚æ•°çš„å¤„ç†ï¼Œç¡®ä¿æ—¶åŒºå¤„ç†æ­£ç¡®ã€‚

---

## ðŸ” å‘çŽ°çš„é—®é¢˜

### 1. æ—¥æœŸèŒƒå›´æŸ¥è¯¢å‡½æ•° - æ½œåœ¨æ—¶åŒºé—®é¢˜ âš ï¸

#### é—®é¢˜å‡½æ•°
- `get_logistics_summary_and_records_enhanced`
- `get_all_filtered_record_ids`
- `get_payment_request_data`
- `get_invoice_request_data`

#### é—®é¢˜ä»£ç 
```sql
-- é—®é¢˜ï¼šå°†timestamptzè½¬æ¢ä¸ºdateè¿›è¡Œæ¯”è¾ƒ
WHERE lr.loading_date >= p_start_date::date
  AND lr.loading_date <= p_end_date::date
```

#### é—®é¢˜åˆ†æž
1. **`lr.loading_date`** æ˜¯ `timestamptz` ç±»åž‹ï¼ˆUTCå­˜å‚¨ï¼‰
2. **`p_start_date::date`** å°†æ–‡æœ¬è½¬æ¢ä¸º `date` ç±»åž‹
3. **æ¯”è¾ƒæ—¶**ï¼šPostgreSQLä¼šå°† `timestamptz` è½¬æ¢ä¸ºå½“å‰ä¼šè¯æ—¶åŒºè¿›è¡Œæ¯”è¾ƒ
4. **é£Žé™©**ï¼šå¦‚æžœå‰ç«¯ä¼ é€’çš„æ˜¯UTCæ—¥æœŸå­—ç¬¦ä¸²ï¼ˆå¦‚ "2025-11-09"ï¼‰ï¼Œè€Œæ•°æ®åº“ä¸­çš„ `loading_date` æ˜¯UTCæ—¶é—´ï¼ˆå¦‚ "2025-11-09 16:00:00+00"ï¼‰ï¼Œè½¬æ¢ä¸ºdateåŽå¯èƒ½ä¸åŒ¹é…

#### å½“å‰å‰ç«¯å¤„ç†
å‰ç«¯å·²ç»ä½¿ç”¨ `convertChinaDateToUTCDate()` å°†ä¸­å›½æ—¶åŒºæ—¥æœŸè½¬æ¢ä¸ºUTCæ—¥æœŸå­—ç¬¦ä¸²ä¼ é€’ç»™åŽç«¯ï¼Œæ‰€ä»¥ï¼š
- å‰ç«¯é€‰æ‹©ï¼š2025-11-10ï¼ˆä¸­å›½æ—¶åŒºï¼‰
- å‰ç«¯ä¼ é€’ï¼š2025-11-09ï¼ˆUTCæ—¥æœŸå­—ç¬¦ä¸²ï¼‰
- æ•°æ®åº“å­˜å‚¨ï¼š2025-11-09 16:00:00+00ï¼ˆUTCï¼Œä»£è¡¨ä¸­å›½æ—¶åŒºçš„2025-11-10 00:00:00+08ï¼‰
- æ¯”è¾ƒï¼š`lr.loading_date >= '2025-11-09'::date` âœ… åº”è¯¥èƒ½åŒ¹é…

#### ç»“è®º
âœ… **å½“å‰å®žçŽ°æ˜¯æ­£ç¡®çš„**ï¼Œå› ä¸ºå‰ç«¯å·²ç»å°†æ—¥æœŸè½¬æ¢ä¸ºUTCæ—¥æœŸå­—ç¬¦ä¸²ã€‚

---

### 2. å•æ—¥æŸ¥è¯¢å‡½æ•° - æ½œåœ¨æ—¶åŒºé—®é¢˜ âš ï¸

#### é—®é¢˜å‡½æ•°
- `get_payment_requests_filtered`
- `get_invoice_requests_filtered`

#### é—®é¢˜ä»£ç 
```sql
-- é—®é¢˜ï¼šç›´æŽ¥æ¯”è¾ƒtimestamptzå’ŒDATE
WHERE (p_loading_date IS NULL OR lr.loading_date = p_loading_date)
```

#### é—®é¢˜åˆ†æž
1. **`lr.loading_date`** æ˜¯ `timestamptz` ç±»åž‹ï¼ˆUTCå­˜å‚¨ï¼‰
2. **`p_loading_date`** æ˜¯ `DATE` ç±»åž‹å‚æ•°
3. **æ¯”è¾ƒæ—¶**ï¼šPostgreSQLä¼šå°† `timestamptz` è½¬æ¢ä¸ºå½“å‰ä¼šè¯æ—¶åŒºè¿›è¡Œæ¯”è¾ƒ
4. **é£Žé™©**ï¼šå¦‚æžœå‰ç«¯ä¼ é€’çš„æ˜¯UTCæ—¥æœŸï¼ˆå¦‚ "2025-11-09"ï¼‰ï¼Œè€Œæ•°æ®åº“ä¸­çš„ `loading_date` æ˜¯UTCæ—¶é—´ï¼ˆå¦‚ "2025-11-09 16:00:00+00"ï¼‰ï¼Œç›´æŽ¥æ¯”è¾ƒå¯èƒ½ä¸åŒ¹é…

#### å½“å‰å‰ç«¯å¤„ç†
å‰ç«¯å·²ç»ä½¿ç”¨ `convertSingleDateToDateRange()` å°†å•æ—¥æŸ¥è¯¢è½¬æ¢ä¸ºæ—¥æœŸèŒƒå›´ï¼Œç„¶åŽä¼ é€’ `startDate`ï¼ˆUTCæ—¥æœŸå­—ç¬¦ä¸²ï¼‰ç»™åŽç«¯ï¼Œæ‰€ä»¥ï¼š
- å‰ç«¯é€‰æ‹©ï¼š2025-11-10ï¼ˆä¸­å›½æ—¶åŒºï¼‰
- å‰ç«¯ä¼ é€’ï¼š2025-11-09ï¼ˆUTCæ—¥æœŸå­—ç¬¦ä¸²ï¼Œä½œä¸º `p_loading_date`ï¼‰
- æ•°æ®åº“å­˜å‚¨ï¼š2025-11-09 16:00:00+00ï¼ˆUTCï¼Œä»£è¡¨ä¸­å›½æ—¶åŒºçš„2025-11-10 00:00:00+08ï¼‰
- æ¯”è¾ƒï¼š`lr.loading_date = '2025-11-09'::date` 
  - PostgreSQLä¼šå°† `lr.loading_date` è½¬æ¢ä¸ºå½“å‰ä¼šè¯æ—¶åŒºçš„date
  - å¦‚æžœä¼šè¯æ—¶åŒºæ˜¯UTCï¼Œåˆ™æ¯”è¾ƒ `2025-11-09 16:00:00+00` çš„dateéƒ¨åˆ† = `2025-11-09` âœ… åº”è¯¥èƒ½åŒ¹é…
  - å¦‚æžœä¼šè¯æ—¶åŒºæ˜¯Asia/Shanghaiï¼Œåˆ™æ¯”è¾ƒ `2025-11-10 00:00:00+08` çš„dateéƒ¨åˆ† = `2025-11-10` âŒ ä¸åŒ¹é…

#### ç»“è®º
âš ï¸ **å­˜åœ¨æ½œåœ¨é£Žé™©**ï¼Œå–å†³äºŽPostgreSQLçš„ä¼šè¯æ—¶åŒºè®¾ç½®ã€‚

---

### 3. æ—¥æœŸå­˜å‚¨å‡½æ•° - æ—¶åŒºå¤„ç† âœ…

#### é—®é¢˜å‡½æ•°
- `driver_quick_create_waybill`
- `driver_manual_create_waybill`

#### é—®é¢˜ä»£ç 
```sql
-- é—®é¢˜ï¼šæ²¡æœ‰æŒ‡å®šæ—¶åŒº
(p_loading_date::text || ' 00:00:00')::timestamp with time zone
```

#### é—®é¢˜åˆ†æž
1. **`p_loading_date`** æ˜¯ `DATE` ç±»åž‹å‚æ•°
2. **è½¬æ¢**ï¼š`p_loading_date::text || ' 00:00:00'` ç”Ÿæˆ "2025-11-10 00:00:00"
3. **æ—¶åŒº**ï¼šPostgreSQLä¼šå°†è¿™ä¸ªå­—ç¬¦ä¸²è§£æžä¸ºå½“å‰ä¼šè¯æ—¶åŒºçš„ `timestamptz`
4. **é£Žé™©**ï¼šå¦‚æžœä¼šè¯æ—¶åŒºä¸æ˜¯UTCï¼Œå¯èƒ½å¯¼è‡´å­˜å‚¨çš„æ—¶åŒºä¸æ­£ç¡®

#### å½“å‰å‰ç«¯å¤„ç†
å‰ç«¯ä¼ é€’çš„æ˜¯ä¸­å›½æ—¶åŒºçš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆå¦‚ "2025-11-10"ï¼‰ï¼Œä½†åŽç«¯åº”è¯¥å°†å…¶ç†è§£ä¸ºUTCæ—¥æœŸã€‚å®žé™…ä¸Šï¼š
- å‰ç«¯ä¼ é€’ï¼š`formatChinaDateString(new Date())` â†’ "2025-11-10"ï¼ˆä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²ï¼‰
- åŽç«¯æŽ¥æ”¶ï¼š`p_loading_date` = DATE '2025-11-10'
- åŽç«¯è½¬æ¢ï¼š`'2025-11-10 00:00:00'::timestamptz`
  - å¦‚æžœä¼šè¯æ—¶åŒºæ˜¯UTCï¼šå­˜å‚¨ä¸º `2025-11-10 00:00:00+00` âœ…
  - å¦‚æžœä¼šè¯æ—¶åŒºæ˜¯Asia/Shanghaiï¼šå­˜å‚¨ä¸º `2025-11-10 00:00:00+08` âŒ

#### ç»“è®º
âš ï¸ **å­˜åœ¨æ½œåœ¨é£Žé™©**ï¼Œå–å†³äºŽPostgreSQLçš„ä¼šè¯æ—¶åŒºè®¾ç½®ã€‚

---

### 4. æ‰¹é‡å¯¼å…¥å‡½æ•° - æ—¶åŒºå¤„ç† âœ…

#### é—®é¢˜å‡½æ•°
- `batch_import_logistics_records`
- `batch_import_logistics_records_with_update`

#### å½“å‰å®žçŽ°
```sql
-- âœ… æ­£ç¡®ï¼šæ˜Žç¡®æŒ‡å®šä¸­å›½æ—¶åŒº
((rec->>'loading_date')::text || ' 00:00:00+08:00')::timestamptz AS loading_date
```

#### ç»“è®º
âœ… **å®žçŽ°æ­£ç¡®**ï¼Œæ˜Žç¡®æŒ‡å®šäº† `+08:00` æ—¶åŒºã€‚

---

## ðŸŽ¯ é—®é¢˜æ€»ç»“

### âœ… å·²æ­£ç¡®å¤„ç†
1. **æ‰¹é‡å¯¼å…¥å‡½æ•°** - æ˜Žç¡®æŒ‡å®š `+08:00` æ—¶åŒº âœ…
2. **æ—¥æœŸèŒƒå›´æŸ¥è¯¢** - å‰ç«¯å·²è½¬æ¢ä¸ºUTCæ—¥æœŸå­—ç¬¦ä¸² âœ…

### âš ï¸ æ½œåœ¨é£Žé™©
1. **å•æ—¥æŸ¥è¯¢å‡½æ•°** - ä¾èµ–PostgreSQLä¼šè¯æ—¶åŒºè®¾ç½®
2. **æ—¥æœŸå­˜å‚¨å‡½æ•°** - ä¾èµ–PostgreSQLä¼šè¯æ—¶åŒºè®¾ç½®

---

## ðŸ”§ å»ºè®®ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤å•æ—¥æŸ¥è¯¢å‡½æ•°ï¼ˆæŽ¨èï¼‰

å°†å•æ—¥æŸ¥è¯¢æ”¹ä¸ºä½¿ç”¨æ—¥æœŸèŒƒå›´æŸ¥è¯¢ï¼š

```sql
-- ä¿®å¤å‰
WHERE (p_loading_date IS NULL OR lr.loading_date = p_loading_date)

-- ä¿®å¤åŽï¼ˆä½¿ç”¨UTCæ—¥æœŸèŒƒå›´ï¼‰
WHERE (p_loading_date IS NULL OR 
       (lr.loading_date >= (p_loading_date::text || ' 00:00:00+00:00')::timestamptz
        AND lr.loading_date < ((p_loading_date + INTERVAL '1 day')::text || ' 00:00:00+00:00')::timestamptz))
```

### æ–¹æ¡ˆ2ï¼šä¿®å¤æ—¥æœŸå­˜å‚¨å‡½æ•°ï¼ˆæŽ¨èï¼‰

æ˜Žç¡®æŒ‡å®šUTCæ—¶åŒºï¼š

```sql
-- ä¿®å¤å‰
(p_loading_date::text || ' 00:00:00')::timestamp with time zone

-- ä¿®å¤åŽï¼ˆæ˜Žç¡®æŒ‡å®šUTCæ—¶åŒºï¼‰
(p_loading_date::text || ' 00:00:00+00:00')::timestamptz
```

æˆ–è€…ï¼Œå¦‚æžœå‰ç«¯ä¼ é€’çš„æ˜¯ä¸­å›½æ—¶åŒºæ—¥æœŸï¼Œåº”è¯¥è½¬æ¢ä¸ºUTCï¼š

```sql
-- ä¿®å¤åŽï¼ˆå°†ä¸­å›½æ—¶åŒºæ—¥æœŸè½¬æ¢ä¸ºUTCï¼‰
((p_loading_date::text || ' 00:00:00+08:00')::timestamptz AT TIME ZONE 'UTC')::timestamptz
```

---

## ðŸ“Š é£Žé™©è¯„ä¼°

### é«˜é£Žé™©
- âŒ æ— 

### ä¸­é£Žé™©
- âš ï¸ å•æ—¥æŸ¥è¯¢å‡½æ•°ï¼ˆå¦‚æžœPostgreSQLä¼šè¯æ—¶åŒºä¸æ˜¯UTCï¼‰
- âš ï¸ æ—¥æœŸå­˜å‚¨å‡½æ•°ï¼ˆå¦‚æžœPostgreSQLä¼šè¯æ—¶åŒºä¸æ˜¯UTCï¼‰

### ä½Žé£Žé™©
- âœ… æ—¥æœŸèŒƒå›´æŸ¥è¯¢ï¼ˆå‰ç«¯å·²æ­£ç¡®å¤„ç†ï¼‰
- âœ… æ‰¹é‡å¯¼å…¥å‡½æ•°ï¼ˆå·²æ˜Žç¡®æŒ‡å®šæ—¶åŒºï¼‰

---

## âœ… ç»“è®º

1. **å¤§éƒ¨åˆ†å‡½æ•°å·²æ­£ç¡®å¤„ç†æ—¶åŒº** âœ…
2. **å•æ—¥æŸ¥è¯¢å’Œæ—¥æœŸå­˜å‚¨å‡½æ•°å­˜åœ¨æ½œåœ¨é£Žé™©** âš ï¸
3. **å»ºè®®ä¿®å¤å•æ—¥æŸ¥è¯¢å’Œæ—¥æœŸå­˜å‚¨å‡½æ•°**ï¼Œæ˜Žç¡®æŒ‡å®šæ—¶åŒºï¼Œé¿å…ä¾èµ–PostgreSQLä¼šè¯æ—¶åŒºè®¾ç½®

---

**åˆ†æžæ—¥æœŸ**: 2025-01-XX  
**åˆ†æžçŠ¶æ€**: âš ï¸ éœ€è¦ä¿®å¤éƒ¨åˆ†å‡½æ•°

