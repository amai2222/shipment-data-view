# 资源加载问题彻底解决方案

## 🎯 问题根源

当使用内容哈希方案时，经常出现 `Unexpected token '<'` 错误，原因是：

1. **服务器返回 HTML 而不是 JavaScript**
   - 浏览器请求 JS 文件（如 `MobileInternalWaybillDetail-CEHmnQa7.js`）
   - 服务器返回 HTML 错误页面（404 或错误页）
   - 导致 MIME 类型不匹配

2. **`_redirects` 配置问题**
   - 所有请求（包括静态资源）被重定向到 `index.html`
   - 静态资源路径没有被正确排除

3. **构建配置不一致**
   - 文件名哈希长度不固定
   - 资源路径格式不统一

## ✅ 彻底解决方案

### 1. 优化 `_redirects` 文件

**文件：** `public/_redirects`

```redirects
# ✅ 明确排除静态资源，确保不会被重定向
/assets/*    200

# ✅ 排除其他静态资源路径
/favicon.ico    200
/robots.txt     200
/sitemap.xml    200

# SPA 路由支持：将所有不存在的路由重定向到 index.html
/*    /index.html   200
```

**关键点：**
- 静态资源路径（`/assets/*`）明确返回 200，不会被重定向
- 其他静态文件（favicon、robots.txt 等）也被排除
- SPA 路由规则放在最后，只匹配不存在的文件

### 2. 添加 `_headers` 文件

**文件：** `public/_headers`

```headers
# JavaScript 文件
/assets/*.js
  Content-Type: application/javascript; charset=utf-8
  Cache-Control: public, max-age=31536000, immutable

# CSS 文件
/assets/*.css
  Content-Type: text/css; charset=utf-8
  Cache-Control: public, max-age=31536000, immutable

# HTML 文件（不缓存）
/*.html
  Cache-Control: no-cache, no-store, must-revalidate
```

**作用：**
- 明确指定静态资源的 MIME 类型
- 确保 Cloudflare Pages 正确识别文件类型
- 设置合理的缓存策略

### 3. 优化 Vite 构建配置

**文件：** `vite.config.ts`

```typescript
build: {
  assetsDir: 'assets',
  outDir: 'dist',
  base: '/',
  rollupOptions: {
    output: {
      format: 'es',
      // ✅ 使用固定长度的哈希（8位），确保文件名可预测且稳定
      chunkFileNames: 'assets/[name]-[hash:8].js',
      entryFileNames: 'assets/[name]-[hash:8].js',
      assetFileNames: 'assets/[name]-[hash:8].[ext]',
    },
  },
}
```

**关键改进：**
- 使用 `[hash:8]` 固定哈希长度，避免文件名过长
- 所有资源使用统一的命名格式
- 确保资源路径一致

### 4. 添加资源路径验证

**文件：** `scripts/verify-resource-paths.js`

在构建后自动验证：
- ✅ 所有资源文件是否存在
- ✅ 资源路径是否正确
- ✅ 是否有未引用的资源文件

**使用：**
```bash
npm run verify-resources
```

## 🔧 部署检查清单

### 部署前

1. ✅ 运行构建验证
   ```bash
   npm run build
   ```

2. ✅ 检查构建输出
   - 确认所有 JS 文件都在 `dist/assets/` 目录
   - 确认文件名格式统一（`[name]-[hash:8].js`）
   - 确认 `index.html` 中的资源路径正确

3. ✅ 验证配置文件
   - `public/_redirects` 文件存在且内容正确
   - `public/_headers` 文件存在且内容正确

### 部署后

1. ✅ 检查部署日志
   - 确认所有文件都上传成功
   - 确认没有错误或警告

2. ✅ 测试资源加载
   - 直接访问 JS 文件 URL（如 `https://your-domain.com/assets/index-xxxxx.js`）
   - 确认返回 JavaScript 代码，不是 HTML
   - 确认响应头 `Content-Type: application/javascript`

3. ✅ 清除缓存
   - Cloudflare Dashboard → Caching → Purge Everything
   - 浏览器硬刷新（Ctrl+Shift+R）

## 🚨 故障排查

### 问题 1: 资源文件返回 HTML

**症状：** 浏览器控制台显示 `Unexpected token '<'`

**排查步骤：**
1. 直接访问资源 URL，检查返回内容
2. 检查 `_redirects` 文件是否正确配置
3. 检查 Cloudflare Pages 部署日志

**解决方案：**
- 确保 `_redirects` 文件中 `/assets/*` 规则在 `/*` 规则之前
- 确保 `_headers` 文件存在且配置正确
- 清除 Cloudflare 缓存并重新部署

### 问题 2: 资源文件 404

**症状：** 浏览器控制台显示 `Failed to fetch`

**排查步骤：**
1. 检查构建输出，确认文件存在
2. 检查 `index.html` 中的资源路径
3. 运行 `npm run verify-resources` 验证

**解决方案：**
- 检查构建配置，确保资源路径正确
- 检查部署配置，确保所有文件都上传
- 重新构建并部署

### 问题 3: 文件名不匹配

**症状：** 构建后的文件名与 `index.html` 中的引用不一致

**排查步骤：**
1. 检查 `vite.config.ts` 中的文件名配置
2. 检查是否有多个构建配置冲突
3. 运行验证脚本检查

**解决方案：**
- 统一使用 `[hash:8]` 固定长度哈希
- 确保所有资源使用相同的命名格式
- 清理构建缓存后重新构建

## 📝 最佳实践

1. **每次部署前验证**
   - 运行 `npm run build` 确保构建成功
   - 运行 `npm run verify-resources` 验证资源路径

2. **版本控制**
   - 确保 `_redirects` 和 `_headers` 文件都提交到 Git
   - 不要忽略构建配置文件

3. **监控部署**
   - 定期检查 Cloudflare Pages 部署日志
   - 关注资源加载错误

4. **缓存策略**
   - 静态资源使用长期缓存（immutable）
   - HTML 文件不缓存，确保总是获取最新版本

## ✅ 验证成功标志

部署成功后，应该看到：

1. ✅ 所有资源文件直接访问返回正确内容（不是 HTML）
2. ✅ 浏览器控制台没有资源加载错误
3. ✅ 页面正常加载，所有功能正常
4. ✅ 响应头包含正确的 `Content-Type`

## 🎉 总结

通过以上配置，从根本上解决了资源加载问题：

- ✅ **`_redirects`** 明确排除静态资源
- ✅ **`_headers`** 确保正确的 MIME 类型
- ✅ **Vite 配置** 统一文件名格式
- ✅ **验证脚本** 确保构建正确

**不再需要自动重试机制**，问题在构建和部署阶段就被彻底解决！

