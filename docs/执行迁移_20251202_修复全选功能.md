# 执行迁移：修复全选功能

## 📋 问题说明

错误信息：`get_all_filtered_record_ids_1201` 函数返回 404

**原因**：迁移文件已创建但尚未在数据库中执行

## 🚀 执行步骤

### 方式一：使用 Supabase CLI（推荐）

```bash
# 1. 进入项目目录
cd C:\Users\admin\Desktop\中科物流跟踪系统逻辑\github\shipment-data-view

# 2. 执行迁移
supabase db push
```

### 方式二：手动执行（Supabase Dashboard）

#### 步骤1：登录 Supabase Dashboard

1. 打开 https://app.supabase.com
2. 选择你的项目
3. 进入 **SQL Editor**

#### 步骤2：执行迁移文件

1. 打开文件：`supabase/migrations/20251202_fix_get_all_filtered_record_ids_1120.sql`
2. 复制全部内容
3. 粘贴到 SQL Editor
4. 点击 **Run** 执行

#### 步骤3：验证执行结果

执行以下 SQL 验证函数是否创建成功：

```sql
-- 检查函数是否存在
SELECT 
    routine_name,
    routine_type,
    routine_definition
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_name = 'get_all_filtered_record_ids_1201';
```

**预期结果**：应该返回一行记录，显示函数已创建

## ✅ 修复内容

本次迁移文件会：

1. ✅ 创建 `get_all_filtered_record_ids_1201` 函数
2. ✅ 修复不存在的列引用（`loading_weighbridge_image_url`）
3. ✅ 使用 `scale_records` 表判断是否有磅单记录
4. ✅ 支持磅单筛选参数（`p_has_scale_record`）
5. ✅ **修复返回格式**：返回格式与前端期望的格式完全匹配
   - `recordIds`（驼峰命名，而不是 `record_ids`）
   - `totalCount`（总记录数）
   - `summary.projectNames`（项目名称数组）
   - `summary.driverNames`（司机名称数组）
   - `summary.dateRange`（日期范围）

## 🔍 验证功能

执行迁移后，测试以下功能：

1. **运单管理页面**
   - 打开运单管理页面
   - 点击"全选"按钮
   - 应该能正常选择所有筛选记录

2. **磅单筛选**
   - 在筛选条件中选择"有磅单"或"无磅单"
   - 应该能正常筛选

## ❌ 如果仍然报错

如果执行迁移后仍然报错，请检查：

1. **函数是否创建成功**
   ```sql
   SELECT routine_name 
   FROM information_schema.routines 
   WHERE routine_name = 'get_all_filtered_record_ids_1201';
   ```

2. **检查错误日志**
   - 打开浏览器控制台（F12）
   - 查看 Network 标签页
   - 找到失败的请求，查看详细错误信息

3. **重新执行迁移**
   - 如果函数已存在，迁移文件会使用 `CREATE OR REPLACE` 自动替换
   - 可以安全地重复执行

## 📝 注意事项

- 迁移文件使用 `CREATE OR REPLACE`，可以安全地重复执行
- 不会影响现有数据
- 不会影响其他功能

