# 运单维护更新模式导入修复说明

## 📋 问题描述

用户反馈：**"运单维护，导入的时候，我选择了全部更新现有记录（保留运单号，更新其他字段），但实际却给我生成了新的55条记录"**

## 🔍 问题分析

经过分析发现，运单维护页面使用的 `useExcelImport` hook 只支持创建新记录，不支持更新现有记录。虽然界面显示"全部更新现有记录"，但实际调用的数据库函数 `import_logistics_data` 只执行创建操作，导致用户期望与实际行为不一致。

## 🔧 修复方案

### 1. 数据库层面

#### 1.1 创建新的预览函数
- **文件**: `scripts/create-update-import-function.sql`
- **函数**: `preview_import_with_update_mode(p_records jsonb)`
- **功能**: 预览导入数据，将记录分类为：
  - `new_records`: 新记录（数据库中不存在）
  - `update_records`: 重复记录（数据库中已存在，需要更新）
  - `error_records`: 错误记录（数据验证失败）

#### 1.2 创建新的导入函数
- **函数**: `batch_import_logistics_records_with_update(p_records jsonb, p_update_mode boolean)`
- **功能**: 支持两种模式：
  - `p_update_mode = false`: 创建模式（生成新运单号）
  - `p_update_mode = true`: 更新模式（保留现有运单号，更新其他字段）

#### 1.3 更新模式逻辑
```sql
IF existing_record_id IS NOT NULL AND p_update_mode THEN
    -- 更新现有记录
    UPDATE public.logistics_records SET
        project_id = project_id_val,
        project_name = TRIM(record_data->>'project_name'),
        -- ... 更新其他字段
        external_tracking_numbers = CASE WHEN record_data->'external_tracking_numbers' IS NOT NULL 
                                         THEN record_data->'external_tracking_numbers' ELSE '[]'::jsonb END,
        other_platform_names = CASE WHEN record_data->'other_platform_names' IS NOT NULL 
                                   THEN (record_data->'other_platform_names')::text[] ELSE '{}'::text[] END
    WHERE id = existing_record_id;
ELSE
    -- 创建新记录
    INSERT INTO public.logistics_records (...);
END IF;
```

### 2. 前端层面

#### 2.1 创建新的Hook
- **文件**: `src/pages/BusinessEntry/hooks/useExcelImportWithUpdate.ts`
- **功能**: 支持更新模式的Excel导入
- **特性**:
  - 支持导入模式选择（创建/更新）
  - 调用新的数据库函数
  - 提供详细的导入日志

#### 2.2 创建新的导入对话框
- **文件**: `src/pages/BusinessEntry/components/UpdateModeImportDialog.tsx`
- **功能**: 专门用于运单维护的导入对话框
- **特性**:
  - 导入模式选择（单选按钮）
  - 重复记录详情显示
  - 导入摘要统计
  - 实时导入日志

#### 2.3 更新运单维护页面
- **文件**: `src/pages/DataMaintenance/WaybillMaintenance.tsx`
- **更改**:
  - 使用 `useExcelImportWithUpdate` 替代 `useExcelImport`
  - 使用 `UpdateModeImportDialog` 替代 `EnhancedImportDialog`
  - 支持真正的更新模式

## 📊 功能对比

| 功能 | 修复前 | 修复后 |
|------|--------|--------|
| 导入模式选择 | ❌ 仅显示，不生效 | ✅ 真正支持创建/更新模式 |
| 重复记录处理 | ❌ 强制创建新记录 | ✅ 根据模式选择处理 |
| 运单号保留 | ❌ 总是生成新运单号 | ✅ 更新模式保留现有运单号 |
| 字段更新 | ❌ 不支持 | ✅ 支持更新所有字段 |
| 平台字段 | ❌ 部分支持 | ✅ 完整支持 |
| 用户反馈 | ❌ 期望与实际不符 | ✅ 完全符合用户期望 |

## 🚀 部署步骤

### 1. 数据库更新
```sql
-- 执行数据库函数创建脚本
\i scripts/create-update-import-function.sql
```

### 2. 前端更新
- 所有相关文件已更新
- 无需额外配置
- 重启应用即可生效

### 3. 测试验证
```sql
-- 执行测试脚本
\i scripts/test-update-mode-import.sql
```

## 📝 使用说明

### 1. 导入模式选择

#### 创建模式
- **选择**: "全部创建新记录 (生成新运单号)"
- **行为**: 为所有记录创建新的运单，即使存在重复记录也会强制创建
- **适用场景**: 需要保留所有历史记录

#### 更新模式
- **选择**: "全部更新现有记录 (保留运单号,更新其他字段)"
- **行为**: 对于重复记录，更新现有记录的其他字段，保留原有运单号
- **适用场景**: 需要修正现有记录的数据

### 2. 重复记录判断

基于以下8个关键字段判断重复：
1. 项目名称
2. 司机姓名
3. 车牌号
4. 装货地点
5. 卸货地点
6. 装货日期
7. 装货重量
8. 合作链路（如果提供）

### 3. 更新字段

更新模式会更新以下字段：
- 基本信息：运费金额、额外费用、备注等
- 平台信息：其他平台名称、外部运单号
- 时间信息：卸货日期、卸货重量
- 其他信息：运输类型、司机电话等

**保留字段**：
- 运单号（auto_number）
- 创建时间（created_at）
- 创建用户（created_by_user_id）

## ✅ 测试建议

### 1. 功能测试
- [ ] 测试创建模式导入
- [ ] 测试更新模式导入
- [ ] 测试混合模式（部分新记录，部分重复记录）
- [ ] 测试错误记录处理

### 2. 数据验证
- [ ] 确认更新模式保留运单号
- [ ] 确认创建模式生成新运单号
- [ ] 确认平台字段正确更新
- [ ] 确认成本重新计算

### 3. 用户体验
- [ ] 确认界面显示与实际行为一致
- [ ] 确认导入日志清晰易懂
- [ ] 确认错误提示准确

## 📊 影响范围

- ✅ 运单维护页面导入功能
- ✅ 数据库导入函数
- ✅ 前端导入组件
- ✅ 用户界面体验

所有更新都向后兼容，不会影响现有数据的正常使用。

## 🎯 预期效果

修复后，用户选择"全部更新现有记录"时：
1. 系统会正确识别重复记录
2. 更新现有记录的其他字段
3. 保留原有的运单号
4. 不会创建新的重复记录
5. 用户界面显示与实际行为完全一致

这样就解决了用户反馈的问题，确保运单维护导入功能按预期工作。
