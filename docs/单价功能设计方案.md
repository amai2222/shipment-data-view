# å•ä»·åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚åˆ†æ

### å½“å‰é€»è¾‘
```
current_costï¼šç›´æ¥è¾“å…¥çš„è¿è´¹é‡‘é¢
payable_cost = current_cost + extra_cost
```

### æ–°é€»è¾‘
```
å•ä»·ï¼šæ¯å¨çš„è¿è´¹ä»·æ ¼
æœ‰æ•ˆæ•°é‡ï¼šç”¨äºè®¡ç®—è¿è´¹çš„é‡é‡
current_cost = å•ä»· Ã— æœ‰æ•ˆæ•°é‡
payable_cost = current_cost + extra_cost
```

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡

### 1. æ–°å¢å­—æ®µ

åœ¨ `logistics_records` è¡¨ä¸­æ–°å¢ï¼š

| å­—æ®µå | ç±»å‹ | å…è®¸NULL | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|----------|--------|------|
| `unit_price` | NUMERIC(10,2) | YES | NULL | å•ä»·ï¼ˆå…ƒ/å¨ï¼‰ |
| `effective_quantity` | NUMERIC(10,3) | YES | NULL | æœ‰æ•ˆæ•°é‡ï¼ˆå¨ï¼‰|
| `calculation_mode` | TEXT | YES | 'manual' | è®¡ç®—æ¨¡å¼ï¼š'manual'(æ‰‹åŠ¨) / 'auto'(è‡ªåŠ¨) |

### 2. æœ‰æ•ˆæ•°é‡çš„ç¡®å®šé€»è¾‘

**æ ¹æ®é¡¹ç›®é…ç½®è‡ªåŠ¨ç¡®å®š**ï¼š

ç³»ç»Ÿå·²æœ‰ `projects.effective_quantity_type` å­—æ®µï¼Œæ”¯æŒä¸‰ç§è®¡ç®—æ–¹å¼ï¼š

| è®¡ç®—æ–¹å¼ | æšä¸¾å€¼ | è¯´æ˜ | è®¡ç®—å…¬å¼ |
|---------|--------|------|---------|
| å–è¾ƒå°å€¼ | `min_value` | è£…è´§å’Œå¸è´§å–è¾ƒå°å€¼ | `LEAST(loading_weight, unloading_weight)` |
| å–è£…è´§æ•°é‡ | `loading` | ä½¿ç”¨è£…è´§é‡é‡ | `loading_weight` |
| å–å¸è´§æ•°é‡ | `unloading` | ä½¿ç”¨å¸è´§é‡é‡ | `unloading_weight` |

**SQL å®ç°**ï¼ˆè°ƒç”¨ç°æœ‰å‡½æ•°ï¼‰ï¼š
```sql
-- ä½¿ç”¨é¡¹ç›®é…ç½®çš„è®¡ç®—æ–¹å¼
SELECT effective_quantity_type 
INTO v_quantity_type
FROM projects 
WHERE id = NEW.project_id;

-- è°ƒç”¨ç°æœ‰çš„è®¡ç®—å‡½æ•°
effective_quantity := public.calculate_effective_quantity(
    NEW.loading_weight, 
    NEW.unloading_weight, 
    v_quantity_type
);
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¤ç”¨ç°æœ‰çš„é¡¹ç›®é…ç½®
- âœ… çµæ´»ï¼Œä¸åŒé¡¹ç›®å¯ä»¥æœ‰ä¸åŒçš„è®¡ç®—è§„åˆ™
- âœ… ç»Ÿä¸€ï¼Œä¸ç°æœ‰çš„"æœ‰æ•ˆæ•°é‡"é€»è¾‘ä¸€è‡´

### 3. è®¡ç®—æ¨¡å¼ï¼ˆcalculation_modeï¼‰

æ”¯æŒä¸¤ç§æ¨¡å¼ï¼Œä»¥ä¿æŒçµæ´»æ€§å’Œå‘åå…¼å®¹ï¼š

#### æ¨¡å¼1ï¼šè‡ªåŠ¨è®¡ç®—ï¼ˆ'auto'ï¼‰

```
current_cost = unit_price Ã— effective_quantity
```

- ç”¨æˆ·åªéœ€è¾“å…¥**å•ä»·**
- ç³»ç»Ÿè‡ªåŠ¨è®¡ç®— **current_cost**
- é€‚åˆæŒ‰å¨ä½è®¡è´¹çš„åœºæ™¯

#### æ¨¡å¼2ï¼šæ‰‹åŠ¨è¾“å…¥ï¼ˆ'manual'ï¼‰- é»˜è®¤æ¨¡å¼

```
current_cost = ç”¨æˆ·ç›´æ¥è¾“å…¥çš„é‡‘é¢
```

- ä¿æŒåŸæœ‰é€»è¾‘ï¼Œå‘åå…¼å®¹
- ç”¨æˆ·ç›´æ¥è¾“å…¥ **current_cost**
- å•ä»·å’Œæœ‰æ•ˆæ•°é‡å¯é€‰ï¼ˆç”¨äºè®°å½•ï¼‰

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“è¿ç§»ï¼ˆMigrationï¼‰

```sql
-- ============================================================================
-- æ·»åŠ å•ä»·åŠŸèƒ½å­—æ®µ
-- æ—¥æœŸï¼š2025-11-16
-- ============================================================================

-- æ–°å¢å­—æ®µ
ALTER TABLE public.logistics_records 
ADD COLUMN IF NOT EXISTS unit_price NUMERIC(10,2),
ADD COLUMN IF NOT EXISTS effective_quantity NUMERIC(10,3),
ADD COLUMN IF NOT EXISTS calculation_mode TEXT DEFAULT 'manual';

-- æ·»åŠ å­—æ®µæ³¨é‡Š
COMMENT ON COLUMN public.logistics_records.unit_price IS 'å•ä»·ï¼ˆå…ƒ/å¨ï¼‰';
COMMENT ON COLUMN public.logistics_records.effective_quantity IS 'æœ‰æ•ˆæ•°é‡ï¼ˆå¨ï¼‰ï¼Œä¼˜å…ˆä½¿ç”¨å¸è´§é‡é‡ï¼Œå¦åˆ™ä½¿ç”¨è£…è´§é‡é‡';
COMMENT ON COLUMN public.logistics_records.calculation_mode IS 'è®¡ç®—æ¨¡å¼ï¼šmanual(æ‰‹åŠ¨è¾“å…¥) / auto(è‡ªåŠ¨è®¡ç®—)';

-- æ·»åŠ çº¦æŸ
ALTER TABLE public.logistics_records
ADD CONSTRAINT check_calculation_mode 
CHECK (calculation_mode IN ('manual', 'auto'));

-- åˆ›å»ºç´¢å¼•ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦æŒ‰å•ä»·æŸ¥è¯¢ï¼‰
CREATE INDEX IF NOT EXISTS idx_logistics_records_unit_price 
ON public.logistics_records(unit_price) 
WHERE unit_price IS NOT NULL;
```

### 2. è‡ªåŠ¨è®¡ç®—è§¦å‘å™¨

åˆ›å»ºè§¦å‘å™¨ï¼Œåœ¨ **calculation_mode = 'auto'** æ—¶è‡ªåŠ¨è®¡ç®— `current_cost` å’Œ `effective_quantity`ï¼š

```sql
-- ============================================================================
-- è‡ªåŠ¨è®¡ç®— current_cost è§¦å‘å™¨
-- ============================================================================

CREATE OR REPLACE FUNCTION auto_calculate_current_cost()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
    v_quantity_type public.effective_quantity_type;
BEGIN
    -- åªåœ¨ calculation_mode = 'auto' æ—¶è‡ªåŠ¨è®¡ç®—
    IF NEW.calculation_mode = 'auto' THEN
        -- ç¬¬ä¸€æ­¥ï¼šè·å–é¡¹ç›®çš„æœ‰æ•ˆæ•°é‡è®¡ç®—æ–¹å¼
        SELECT effective_quantity_type 
        INTO v_quantity_type
        FROM public.projects 
        WHERE id = NEW.project_id;
        
        -- å¦‚æœé¡¹ç›®æ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼ 'min_value'
        v_quantity_type := COALESCE(v_quantity_type, 'min_value');
        
        -- ç¬¬äºŒæ­¥ï¼šæ ¹æ®é¡¹ç›®é…ç½®è®¡ç®—æœ‰æ•ˆæ•°é‡
        NEW.effective_quantity := public.calculate_effective_quantity(
            NEW.loading_weight, 
            NEW.unloading_weight, 
            v_quantity_type
        );
        
        -- ç¬¬ä¸‰æ­¥ï¼šè®¡ç®— current_cost
        IF NEW.unit_price IS NOT NULL AND NEW.effective_quantity > 0 THEN
            NEW.current_cost := ROUND(NEW.unit_price * NEW.effective_quantity, 2);
        ELSE
            -- å¦‚æœå•ä»·ä¸ºç©ºæˆ–æœ‰æ•ˆæ•°é‡ä¸º0ï¼Œcurrent_cost = 0
            NEW.current_cost := 0;
        END IF;
        
        -- ç¬¬å››æ­¥ï¼šè‡ªåŠ¨è®¡ç®— payable_cost
        NEW.payable_cost := COALESCE(NEW.current_cost, 0) + COALESCE(NEW.extra_cost, 0);
        
        RAISE NOTICE 'è‡ªåŠ¨è®¡ç®—[é¡¹ç›®é…ç½®=%]: å•ä»·=%, è£…è´§=%, å¸è´§=%, æœ‰æ•ˆæ•°é‡=%, è¿è´¹=%, åº”ä»˜=%', 
            v_quantity_type, NEW.unit_price, NEW.loading_weight, NEW.unloading_weight, 
            NEW.effective_quantity, NEW.current_cost, NEW.payable_cost;
    ELSE
        -- manual æ¨¡å¼ï¼šä¸è‡ªåŠ¨è®¡ç®— current_costï¼Œä½†ä»ç„¶è®¡ç®— payable_cost
        NEW.payable_cost := COALESCE(NEW.current_cost, 0) + COALESCE(NEW.extra_cost, 0);
    END IF;
    
    RETURN NEW;
END;
$$;

-- åˆ é™¤æ—§è§¦å‘å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DROP TRIGGER IF EXISTS trigger_auto_calculate_current_cost ON logistics_records;

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER trigger_auto_calculate_current_cost
    BEFORE INSERT OR UPDATE OF unit_price, loading_weight, unloading_weight, extra_cost, calculation_mode
    ON logistics_records
    FOR EACH ROW
    EXECUTE FUNCTION auto_calculate_current_cost();

COMMENT ON FUNCTION auto_calculate_current_cost IS 'è‡ªåŠ¨è®¡ç®—è¿è´¹ï¼šå½“ calculation_mode=auto æ—¶ï¼Œæ ¹æ®å•ä»·å’Œæœ‰æ•ˆæ•°é‡è®¡ç®— current_cost';
```

### 3. å‰ç«¯ç±»å‹å®šä¹‰ï¼ˆTypeScriptï¼‰

```typescript
// src/types/index.ts

export interface LogisticsRecord {
  id: string;
  auto_number: string;
  project_id: string;
  project_name: string;
  chain_id?: string;
  loading_date: string;
  loading_location: string;
  unloading_location: string;
  driver_id: string;
  driver_name: string;
  license_plate: string;
  driver_phone: string;
  loading_weight: number;
  unloading_date?: string;
  unloading_weight?: number;
  transport_type: "å®é™…è¿è¾“" | "é€€è´§";
  
  // === å•ä»·åŠŸèƒ½æ–°å¢å­—æ®µ ===
  unit_price?: number;                              // å•ä»·ï¼ˆå…ƒ/å¨ï¼‰
  effective_quantity?: number;                      // æœ‰æ•ˆæ•°é‡ï¼ˆå¨ï¼‰
  calculation_mode?: 'manual' | 'auto';            // è®¡ç®—æ¨¡å¼
  // === åŸæœ‰å­—æ®µ ===
  current_cost?: number;                           // è¿è´¹é‡‘é¢ï¼ˆå¦‚æœæ˜¯ auto æ¨¡å¼åˆ™è‡ªåŠ¨è®¡ç®—ï¼‰
  extra_cost?: number;
  payable_cost?: number;
  
  remarks?: string;
  created_at: string;
  created_by_user_id: string;
  // ... å…¶ä»–å­—æ®µ
}
```

### 4. å‰ç«¯è¡¨å•ç»„ä»¶

```tsx
// è¡¨å•æ•°æ®æ¥å£
interface FormData {
  // ... å…¶ä»–å­—æ®µ
  calculation_mode: 'manual' | 'auto';
  unit_price?: string;
  effective_quantity?: string;
  current_cost?: string;
  loading_weight: string;
  unloading_weight: string;
  extra_cost: string;
}

// åœ¨è¡¨å•ä¸­æ·»åŠ åˆ‡æ¢å¼€å…³
<div className="space-y-4">
  {/* è®¡ç®—æ¨¡å¼é€‰æ‹© */}
  <div className="flex items-center space-x-4">
    <Label>è¿è´¹è®¡ç®—æ–¹å¼ï¼š</Label>
    <RadioGroup
      value={formData.calculation_mode}
      onValueChange={(value) => setFormData({...formData, calculation_mode: value})}
    >
      <div className="flex items-center space-x-2">
        <RadioGroupItem value="manual" id="manual" />
        <Label htmlFor="manual">æ‰‹åŠ¨è¾“å…¥</Label>
      </div>
      <div className="flex items-center space-x-2">
        <RadioGroupItem value="auto" id="auto" />
        <Label htmlFor="auto">æŒ‰å•ä»·è®¡ç®—</Label>
      </div>
    </RadioGroup>
  </div>

  {/* æ ¹æ®è®¡ç®—æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„è¾“å…¥æ¡† */}
  {formData.calculation_mode === 'auto' ? (
    <>
      {/* è‡ªåŠ¨è®¡ç®—æ¨¡å¼ */}
      <div>
        <Label htmlFor="unit_price">å•ä»·ï¼ˆå…ƒ/å¨ï¼‰<span className="text-red-500">*</span></Label>
        <Input
          id="unit_price"
          type="number"
          step="0.01"
          value={formData.unit_price}
          onChange={(e) => {
            setFormData({...formData, unit_price: e.target.value});
            // å®æ—¶è®¡ç®— current_cost
            const unitPrice = parseFloat(e.target.value) || 0;
            const effectiveQty = parseFloat(formData.unloading_weight || formData.loading_weight) || 0;
            const calculatedCost = (unitPrice * effectiveQty).toFixed(2);
            setFormData(prev => ({...prev, current_cost: calculatedCost}));
          }}
          placeholder="è¯·è¾“å…¥å•ä»·"
        />
      </div>
      
      <div>
        <Label>æœ‰æ•ˆæ•°é‡ï¼ˆå¨ï¼‰</Label>
        <Input
          type="text"
          value={formData.unloading_weight || formData.loading_weight || '0'}
          disabled
          className="bg-gray-100"
        />
        <p className="text-sm text-gray-500 mt-1">
          ä¼˜å…ˆä½¿ç”¨å¸è´§é‡é‡ï¼Œå¦åˆ™ä½¿ç”¨è£…è´§é‡é‡
        </p>
      </div>
      
      <div>
        <Label>è¿è´¹é‡‘é¢ï¼ˆå…ƒï¼‰</Label>
        <Input
          type="text"
          value={formData.current_cost || '0.00'}
          disabled
          className="bg-gray-100 font-semibold"
        />
        <p className="text-sm text-gray-500 mt-1">
          è‡ªåŠ¨è®¡ç®—ï¼šå•ä»· Ã— æœ‰æ•ˆæ•°é‡ = {formData.current_cost || '0.00'} å…ƒ
        </p>
      </div>
    </>
  ) : (
    <>
      {/* æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ */}
      <div>
        <Label htmlFor="current_cost">è¿è´¹é‡‘é¢ï¼ˆå…ƒï¼‰<span className="text-red-500">*</span></Label>
        <Input
          id="current_cost"
          type="number"
          step="0.01"
          value={formData.current_cost}
          onChange={(e) => setFormData({...formData, current_cost: e.target.value})}
          placeholder="è¯·è¾“å…¥è¿è´¹é‡‘é¢"
        />
      </div>
      
      {/* å¯é€‰ï¼šæ˜¾ç¤ºå•ä»·ï¼ˆä»…ä¾›å‚è€ƒï¼‰ */}
      <div>
        <Label htmlFor="unit_price">å•ä»·ï¼ˆå…ƒ/å¨ï¼Œå¯é€‰ï¼‰</Label>
        <Input
          id="unit_price"
          type="number"
          step="0.01"
          value={formData.unit_price}
          onChange={(e) => setFormData({...formData, unit_price: e.target.value})}
          placeholder="å¯é€‰ï¼Œç”¨äºè®°å½•"
        />
        <p className="text-sm text-gray-500 mt-1">
          å¯é€‰å­—æ®µï¼Œä»…ç”¨äºè®°å½•å•ä»·ä¿¡æ¯
        </p>
      </div>
    </>
  )}

  {/* é¢å¤–è´¹ç”¨ï¼ˆä¸¤ç§æ¨¡å¼éƒ½æ˜¾ç¤ºï¼‰ */}
  <div>
    <Label htmlFor="extra_cost">é¢å¤–è´¹ç”¨ï¼ˆå…ƒï¼‰</Label>
    <Input
      id="extra_cost"
      type="number"
      step="0.01"
      value={formData.extra_cost}
      onChange={(e) => setFormData({...formData, extra_cost: e.target.value})}
      placeholder="0.00"
    />
  </div>

  {/* åº”ä»˜é‡‘é¢ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰ */}
  <div className="bg-blue-50 p-4 rounded-lg">
    <Label>å¸æœºåº”æ”¶ï¼ˆå…ƒï¼‰</Label>
    <div className="text-2xl font-bold text-blue-600 mt-2">
      Â¥ {(
        (parseFloat(formData.current_cost) || 0) + 
        (parseFloat(formData.extra_cost) || 0)
      ).toFixed(2)}
    </div>
    <p className="text-sm text-gray-500 mt-1">
      è¿è´¹ + é¢å¤–è´¹ç”¨
    </p>
  </div>
</div>
```

---

## ğŸ“Š æ•°æ®è¿ç§»å’Œå‘åå…¼å®¹

### 1. æ—§æ•°æ®å¤„ç†

**æ–¹æ¡ˆ**ï¼šä¸ºæ—§æ•°æ®å¡«å……é»˜è®¤å€¼

```sql
-- ä¸ºæ—§æ•°æ®è®¾ç½®é»˜è®¤çš„è®¡ç®—æ¨¡å¼ä¸º 'manual'
UPDATE logistics_records
SET 
    calculation_mode = 'manual',
    effective_quantity = COALESCE(unloading_weight, loading_weight)
WHERE calculation_mode IS NULL;

-- ä¸ºå·²æœ‰ current_cost çš„è®°å½•åæ¨å•ä»·ï¼ˆå¯é€‰ï¼‰
UPDATE logistics_records
SET unit_price = CASE 
    WHEN COALESCE(unloading_weight, loading_weight, 0) > 0 
    THEN ROUND(current_cost / COALESCE(unloading_weight, loading_weight), 2)
    ELSE NULL
END
WHERE calculation_mode = 'manual' 
  AND current_cost IS NOT NULL 
  AND unit_price IS NULL;
```

### 2. å‘åå…¼å®¹æ€§

| åœºæ™¯ | è¡Œä¸º |
|------|------|
| æ—§æ•°æ®ï¼ˆæ²¡æœ‰ unit_priceï¼‰ | calculation_mode = 'manual'ï¼Œæ­£å¸¸æ˜¾ç¤º current_cost |
| æ–°å»ºè¿å•ï¼ˆé€‰æ‹©æ‰‹åŠ¨æ¨¡å¼ï¼‰ | ç›´æ¥è¾“å…¥ current_costï¼Œå•ä»·å¯é€‰ |
| æ–°å»ºè¿å•ï¼ˆé€‰æ‹©è‡ªåŠ¨æ¨¡å¼ï¼‰ | è¾“å…¥ unit_priceï¼Œç³»ç»Ÿè‡ªåŠ¨è®¡ç®— current_cost |
| å¯¼å…¥æ•°æ® | æ”¯æŒä¸¤ç§æ¨¡å¼ï¼Œæ ¹æ®æ˜¯å¦æä¾› unit_price è‡ªåŠ¨åˆ¤æ–­ |

---

## ğŸ”„ è®¡ç®—é“¾è·¯

### å®Œæ•´çš„è®¡ç®—æµç¨‹

```
1. ç”¨æˆ·é€‰æ‹©è®¡ç®—æ¨¡å¼
   â”œâ”€ manual: ç›´æ¥è¾“å…¥ current_cost
   â””â”€ auto: è¾“å…¥ unit_price
       â†“
2. ç³»ç»Ÿè®¡ç®— effective_quantity
   effective_quantity = COALESCE(unloading_weight, loading_weight, 0)
       â†“
3. ç³»ç»Ÿè®¡ç®— current_costï¼ˆä»… auto æ¨¡å¼ï¼‰
   current_cost = unit_price Ã— effective_quantity
       â†“
4. ç³»ç»Ÿè®¡ç®— payable_cost
   payable_cost = current_cost + extra_cost
       â†“
5. ç³»ç»Ÿé‡ç®—åˆä½œæ–¹æˆæœ¬
   base_amount = payable_cost
   éå†å„çº§åˆä½œæ–¹ï¼ŒæŒ‰ç¨ç‚¹æ³•æˆ–åˆ©æ¶¦æ³•è®¡ç®—åº”ä»˜é‡‘é¢
```

### è§¦å‘é‡ç®—çš„æ—¶æœº

**è‡ªåŠ¨è§¦å‘**ï¼š
1. åˆ›å»ºæ–°è¿å•æ—¶
2. ä¿®æ”¹ `unit_price` æ—¶ï¼ˆauto æ¨¡å¼ï¼‰
3. ä¿®æ”¹ `loading_weight` æ—¶ï¼ˆauto æ¨¡å¼ï¼‰
4. ä¿®æ”¹ `unloading_weight` æ—¶ï¼ˆauto æ¨¡å¼ï¼‰
5. ä¿®æ”¹ `extra_cost` æ—¶
6. åˆ‡æ¢ `calculation_mode` æ—¶

**æ³¨æ„**ï¼š
- è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° `current_cost` â†’ è‡ªåŠ¨æ›´æ–° `payable_cost`
- `payable_cost` æ”¹å˜è§¦å‘åˆä½œæ–¹æˆæœ¬é‡ç®—

---

## ğŸ“ˆ å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šè‡ªåŠ¨è®¡ç®—æ¨¡å¼

**è¾“å…¥**ï¼š
- calculation_mode: 'auto'
- unit_price: 350 å…ƒ/å¨
- loading_weight: 20 å¨
- unloading_weight: 19.8 å¨ï¼ˆå¸è´§åå®é™…é‡é‡ï¼‰
- extra_cost: 100 å…ƒ

**è®¡ç®—è¿‡ç¨‹**ï¼š
```
1. effective_quantity = COALESCE(19.8, 20) = 19.8 å¨
2. current_cost = 350 Ã— 19.8 = 6930.00 å…ƒ
3. payable_cost = 6930.00 + 100 = 7030.00 å…ƒ
```

**ç»“æœ**ï¼š
```
å•ä»·ï¼š350 å…ƒ/å¨
æœ‰æ•ˆæ•°é‡ï¼š19.8 å¨
è¿è´¹ï¼š6930.00 å…ƒ
é¢å¤–è´¹ç”¨ï¼š100 å…ƒ
å¸æœºåº”æ”¶ï¼š7030.00 å…ƒ
```

### æ¡ˆä¾‹2ï¼šæ‰‹åŠ¨è¾“å…¥æ¨¡å¼

**è¾“å…¥**ï¼š
- calculation_mode: 'manual'
- current_cost: 7000 å…ƒï¼ˆç›´æ¥è¾“å…¥ï¼‰
- unit_price: 350 å…ƒ/å¨ï¼ˆå¯é€‰ï¼Œç”¨äºè®°å½•ï¼‰
- extra_cost: 100 å…ƒ

**è®¡ç®—è¿‡ç¨‹**ï¼š
```
1. effective_quantity = COALESCE(19.8, 20) = 19.8 å¨ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
2. current_cost = 7000 å…ƒï¼ˆç”¨æˆ·è¾“å…¥ï¼Œä¸è‡ªåŠ¨è®¡ç®—ï¼‰
3. payable_cost = 7000 + 100 = 7100 å…ƒ
```

**ç»“æœ**ï¼š
```
è¿è´¹ï¼š7000.00 å…ƒï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰
é¢å¤–è´¹ç”¨ï¼š100 å…ƒ
å¸æœºåº”æ”¶ï¼š7100.00 å…ƒ
```

### æ¡ˆä¾‹3ï¼šä¿®æ”¹å¸è´§é‡é‡ï¼ˆauto æ¨¡å¼ï¼‰

**åœºæ™¯**ï¼šè¿å•åˆ›å»ºæ—¶æ²¡æœ‰å¸è´§é‡é‡ï¼Œåç»­æ›´æ–°

**åˆå§‹çŠ¶æ€**ï¼ˆåªæœ‰è£…è´§é‡é‡ï¼‰ï¼š
- loading_weight: 20 å¨
- unloading_weight: NULL
- effective_quantity: 20 å¨
- current_cost: 350 Ã— 20 = 7000 å…ƒ

**æ›´æ–°å¸è´§é‡é‡å**ï¼š
- loading_weight: 20 å¨
- unloading_weight: 19.5 å¨ï¼ˆæ›´æ–°ï¼‰
- effective_quantity: 19.5 å¨ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
- current_cost: 350 Ã— 19.5 = 6825 å…ƒï¼ˆè‡ªåŠ¨é‡ç®—ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§

**é—®é¢˜**ï¼šå¦‚æœç”¨æˆ·åœ¨ auto æ¨¡å¼ä¸‹æ‰‹åŠ¨ä¿®æ”¹äº† current_cost æ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è§¦å‘å™¨å§‹ç»ˆæ ¹æ® `unit_price Ã— effective_quantity` è®¡ç®—
- å¦‚æœç”¨æˆ·éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ï¼Œåº”å…ˆåˆ‡æ¢åˆ° manual æ¨¡å¼

### 2. å¯¼å…¥æ•°æ®

**Excel å¯¼å…¥æ—¶çš„é€»è¾‘**ï¼š

```typescript
// åˆ¤æ–­è®¡ç®—æ¨¡å¼
if (row['å•ä»·'] && !row['è¿è´¹']) {
  // æœ‰å•ä»·ï¼Œæ²¡æœ‰è¿è´¹ â†’ auto æ¨¡å¼
  record.calculation_mode = 'auto';
  record.unit_price = parseFloat(row['å•ä»·']);
  // current_cost ç”±è§¦å‘å™¨è‡ªåŠ¨è®¡ç®—
} else if (row['è¿è´¹']) {
  // æœ‰è¿è´¹ â†’ manual æ¨¡å¼
  record.calculation_mode = 'manual';
  record.current_cost = parseFloat(row['è¿è´¹']);
  record.unit_price = parseFloat(row['å•ä»·']) || null; // å¯é€‰
} else {
  // éƒ½æ²¡æœ‰ â†’ manual æ¨¡å¼ï¼Œè¿è´¹ä¸º 0
  record.calculation_mode = 'manual';
  record.current_cost = 0;
}
```

### 3. æŠ¥è¡¨æ˜¾ç¤º

**åˆ—è¡¨æ˜¾ç¤ºå»ºè®®**ï¼š

| è¿å•å· | å•ä»· | æ•°é‡ | è¿è´¹ | é¢å¤–è´¹ç”¨ | å¸æœºåº”æ”¶ |
|--------|------|------|------|----------|----------|
| YDN20251116-001 | 350å…ƒ/å¨ | 19.8å¨ | 6930å…ƒ | 100å…ƒ | 7030å…ƒ |
| YDN20251116-002 | - | 20å¨ | 7000å…ƒ | 0å…ƒ | 7000å…ƒ |

**è¯´æ˜**ï¼š
- auto æ¨¡å¼ï¼šæ˜¾ç¤ºå•ä»·å’Œæ•°é‡
- manual æ¨¡å¼ï¼šå•ä»·åˆ—æ˜¾ç¤º "-"

---

## âœ… ä¼˜ç‚¹

1. **å‘åå…¼å®¹**ï¼šæ—§æ•°æ®å’Œæ‰‹åŠ¨è¾“å…¥æ¨¡å¼ä¿æŒä¸å˜
2. **çµæ´»æ€§**ï¼šæ”¯æŒä¸¤ç§è®¡ç®—æ¨¡å¼ï¼Œé€‚åº”ä¸åŒä¸šåŠ¡åœºæ™¯
3. **è‡ªåŠ¨åŒ–**ï¼šauto æ¨¡å¼å‡å°‘æ‰‹åŠ¨è®¡ç®—é”™è¯¯
4. **é€æ˜æ€§**ï¼šæ¸…æ™°æ˜¾ç¤ºå•ä»·ã€æ•°é‡ã€è¿è´¹çš„å…³ç³»
5. **å¯å®¡è®¡**ï¼šä¿ç•™å•ä»·ä¿¡æ¯ï¼Œä¾¿äºåç»­æ ¸å¯¹

---

## ğŸš€ å®æ–½æ­¥éª¤

### é˜¶æ®µ1ï¼šæ•°æ®åº“ï¼ˆç¬¬1å‘¨ï¼‰

1. âœ… åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶
2. âœ… æ·»åŠ å­—æ®µå’Œçº¦æŸ
3. âœ… åˆ›å»ºè‡ªåŠ¨è®¡ç®—è§¦å‘å™¨
4. âœ… æµ‹è¯•è§¦å‘å™¨åŠŸèƒ½
5. âœ… è¿ç§»æ—§æ•°æ®

### é˜¶æ®µ2ï¼šåç«¯ï¼ˆç¬¬2å‘¨ï¼‰

1. âœ… æ›´æ–° RPC å‡½æ•°ï¼Œæ”¯æŒæ–°å­—æ®µ
2. âœ… ä¿®æ”¹å¯¼å…¥å‡½æ•°ï¼Œæ”¯æŒå•ä»·æ¨¡å¼
3. âœ… æ›´æ–°ç±»å‹å®šä¹‰

### é˜¶æ®µ3ï¼šå‰ç«¯ï¼ˆç¬¬3å‘¨ï¼‰

1. âœ… æ›´æ–° TypeScript ç±»å‹
2. âœ… ä¿®æ”¹è¿å•è¡¨å•ï¼Œæ·»åŠ è®¡ç®—æ¨¡å¼é€‰æ‹©
3. âœ… å®ç°å‰ç«¯å®æ—¶è®¡ç®—é¢„è§ˆ
4. âœ… æ›´æ–°è¿å•åˆ—è¡¨æ˜¾ç¤º
5. âœ… æ›´æ–°å¯¼å…¥æ¨¡æ¿

### é˜¶æ®µ4ï¼šæµ‹è¯•å’Œéƒ¨ç½²ï¼ˆç¬¬4å‘¨ï¼‰

1. âœ… å•å…ƒæµ‹è¯•
2. âœ… é›†æˆæµ‹è¯•
3. âœ… ç”¨æˆ·éªŒæ”¶æµ‹è¯•
4. âœ… ç°åº¦å‘å¸ƒ
5. âœ… æ­£å¼éƒ¨ç½²

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒé€»è¾‘

```
è®¡ç®—æ¨¡å¼é€‰æ‹©ï¼ˆcalculation_modeï¼‰
â”œâ”€ manualï¼ˆæ‰‹åŠ¨ï¼‰: current_cost = ç”¨æˆ·è¾“å…¥
â””â”€ autoï¼ˆè‡ªåŠ¨ï¼‰:   current_cost = unit_price Ã— effective_quantity

æœ‰æ•ˆæ•°é‡ï¼ˆeffective_quantityï¼‰
â””â”€ COALESCE(unloading_weight, loading_weight, 0)

å¸æœºåº”æ”¶ï¼ˆpayable_costï¼‰
â””â”€ current_cost + extra_cost

åˆä½œæ–¹æˆæœ¬
â””â”€ åŸºäº payable_cost æŒ‰é“¾è·¯è§„åˆ™è®¡ç®—
```

---

**æ–‡æ¡£åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-16  
**æœ€åæ›´æ–°**ï¼š2025-11-16

