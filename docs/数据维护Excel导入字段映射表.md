# 数据维护 Excel 导入字段映射表

## 📋 概述

本文档列出了数据维护功能中 Excel 导入支持的所有字段，以及它们对应的数据库表字段。

**目标表**：`public.logistics_records`

**适用范围**：
- ✅ 标准导入（运单维护）
- ✅ 标准导入（运单维护增强版）
- ✅ 增强版标准导入（运单维护增强版）
- ✅ 模板导入（运单维护增强版）
- ✅ 选择性更新（运单维护增强版）

**注意**：所有导入功能使用相同的字段映射，只是处理方式和功能特性不同。

---

## ✅ 可导入字段列表

### 1. 项目相关字段

| Excel字段名（示例） | 系统字段名 | 数据库字段 | 数据类型 | 是否必填 | 说明 |
|-------------------|-----------|-----------|---------|---------|------|
| 项目名称* | `project_name` | `logistics_records.project_name` | TEXT | ✅ 必填 | 用于验重，系统会根据项目名称查找或创建项目 |
| 合作链路(可选) | `chain_name` | `logistics_records.chain_id` | UUID | ❌ 可选 | 通过链路名称查找对应的 `chain_id` |

### 2. 司机相关字段

| Excel字段名（示例） | 系统字段名 | 数据库字段 | 数据类型 | 是否必填 | 说明 |
|-------------------|-----------|-----------|---------|---------|------|
| 司机姓名* | `driver_name` | `logistics_records.driver_name` | TEXT | ✅ 必填 | 用于验重，系统会根据司机姓名和车牌号查找或创建司机 |
| 车牌号* | `license_plate` | `logistics_records.license_plate` | TEXT | ✅ 必填 | 用于验重 |
| 司机电话(可选) | `driver_phone` | `logistics_records.driver_phone` | TEXT | ❌ 可选 | 如果司机不存在，会创建新司机记录 |

### 3. 地点相关字段

| Excel字段名（示例） | 系统字段名 | 数据库字段 | 数据类型 | 是否必填 | 说明 |
|-------------------|-----------|-----------|---------|---------|------|
| 装货地点* | `loading_location` | `logistics_records.loading_location` | TEXT | ✅ 必填 | 用于验重 |
| 卸货地点* | `unloading_location` | `logistics_records.unloading_location` | TEXT | ✅ 必填 | 用于验重 |

### 4. 日期相关字段

| Excel字段名（示例） | 系统字段名 | 数据库字段 | 数据类型 | 是否必填 | 说明 |
|-------------------|-----------|-----------|---------|---------|------|
| 装货日期* | `loading_date` | `logistics_records.loading_date` | TIMESTAMPTZ | ✅ 必填 | 用于验重，支持多种日期格式（见下方说明） |
| 卸货日期(可选) | `unloading_date` | `logistics_records.unloading_date` | TIMESTAMPTZ | ❌ 可选 | 如果为空，系统会使用装货日期 |

**日期格式支持**：
- `YYYY-MM-DD`（如：`2025-01-15`）
- `YYYY/M/D`（如：`2025/1/15`）
- `YYYY年M月D日`（如：`2025年1月15日`）
- `M月D日`（如：`5月20日`，自动补充当前年份）
- `M/D`（如：`3/15`，自动补充当前年份）
- Excel 数字格式（如：`44927`，Excel 日期序列号）

**时区处理**：
- Excel 中的日期按中国时区（UTC+8）解析
- 存储到数据库时自动转换为 UTC

### 5. 数量相关字段

| Excel字段名（示例） | 系统字段名 | 数据库字段 | 数据类型 | 是否必填 | 说明 |
|-------------------|-----------|-----------|---------|---------|------|
| 装货数量* | `loading_weight` | `logistics_records.loading_weight` | NUMERIC | ✅ 必填 | 用于验重，根据合作链路计费类型可能是重量(吨)/发车次数/体积(立方) |
| 卸货数量(可选) | `unloading_weight` | `logistics_records.unloading_weight` | NUMERIC | ❌ 可选 | 根据合作链路计费类型可能是重量(吨)/发车次数/体积(立方) |

### 6. 费用相关字段

| Excel字段名（示例） | 系统字段名 | 数据库字段 | 数据类型 | 是否必填 | 说明 |
|-------------------|-----------|-----------|---------|---------|------|
| 运费金额(可选) | `current_cost` | `logistics_records.current_cost` | NUMERIC | ❌ 可选 | 默认为 0，会触发 `payable_cost` 自动计算 |
| 额外费用(可选) | `extra_cost` | `logistics_records.extra_cost` | NUMERIC | ❌ 可选 | 默认为 0，会触发 `payable_cost` 自动计算 |

**自动计算**：
- `payable_cost`（司机应收合计）由触发器自动计算：`payable_cost = current_cost + extra_cost`
- 当 `payable_cost` 变化时，会自动重新计算合作方成本（`logistics_partner_costs`）

### 7. 其他字段

| Excel字段名（示例） | 系统字段名 | 数据库字段 | 数据类型 | 是否必填 | 说明 |
|-------------------|-----------|-----------|---------|---------|------|
| 运输类型(可选) | `transport_type` | `logistics_records.transport_type` | TEXT | ❌ 可选 | 默认为 `'实际运输'`，可选值：`'实际运输'`、`'退货'` 等 |
| 货物类型(可选) | `cargo_type` | `logistics_records.cargo_type` | TEXT | ❌ 可选 | 货物类型描述（仅在模板导入中支持） |
| 备注(可选) | `remarks` | `logistics_records.remarks` | TEXT | ❌ 可选 | 备注信息 |
| 其他平台名称(可选) | `other_platform_names` | `logistics_records.other_platform_names` | TEXT[] | ❌ 可选 | 多个平台用逗号分隔，如：`平台A,平台B` |
| 其他平台运单号(可选) | `external_tracking_numbers` | `logistics_records.external_tracking_numbers` | JSONB | ❌ 可选 | 格式：`运单1\|运单2,运单3\|运单4`（每个平台的运单号用\|分隔，多个平台用逗号分隔） |

**其他平台运单号格式说明**：
- 单个平台单个运单号：`运单1`
- 单个平台多个运单号：`运单1|运单2|运单3`
- 多个平台：`运单1|运单2,运单3|运单4`（平台A：运单1、运单2；平台B：运单3、运单4）
- 存储格式：`[["运单1", "运单2"], ["运单3", "运单4"]]`（JSONB 数组）

---

## 🔍 验重字段（重复检测）

以下 8 个字段组合用于检测重复记录：

1. ✅ `project_name` - 项目名称
2. ✅ `chain_id` - 合作链路ID（通过 `chain_name` 查找）
3. ✅ `driver_name` - 司机姓名
4. ✅ `license_plate` - 车牌号
5. ✅ `loading_location` - 装货地点
6. ✅ `unloading_location` - 卸货地点
7. ✅ `loading_date` - 装货日期（按日期部分比较，忽略时间）
8. ✅ `loading_weight` - 装货数量

**验重逻辑**：
- 如果这 8 个字段完全匹配，则认为是重复记录
- 在更新模式下，会更新已存在的记录
- 在创建模式下，会跳过重复记录

---

## 📊 字段类型说明

### 文本类型（TEXT）
- Excel 中的文本直接存储
- 会自动去除首尾空格（`TRIM`）
- 空字符串会被转换为 `NULL`

### 数字类型（NUMERIC）
- Excel 中的数字直接存储
- 空值或空字符串会被转换为 `0`（对于费用字段）或 `NULL`（对于数量字段）

### 日期类型（TIMESTAMPTZ）
- 支持多种日期格式（见上方说明）
- Excel 中的日期按中国时区解析
- 存储时自动转换为 UTC

### 数组类型（TEXT[]）
- `other_platform_names`：文本数组
- 多个值用逗号分隔：`平台A,平台B` → `['平台A', '平台B']`

### JSONB 类型
- `external_tracking_numbers`：JSONB 数组
- 格式：`[["运单1", "运单2"], ["运单3"]]`

---

## 🔄 自动处理逻辑

### 1. 项目处理
- 如果项目不存在，系统会自动创建新项目
- 通过 `project_name` 查找或创建项目
- 自动关联 `project_id`

### 2. 司机处理
- 如果司机不存在，系统会自动创建新司机
- 通过 `driver_name` + `license_plate` 查找或创建司机
- 自动关联 `driver_id`

### 3. 合作链路处理
- 如果提供了 `chain_name`，系统会查找对应的合作链路
- 如果链路不存在，会使用项目的默认链路
- 自动关联 `chain_id`

### 4. 费用自动计算
- `payable_cost` 由触发器自动计算：`payable_cost = current_cost + extra_cost`
- 当 `payable_cost` 变化时，会自动重新计算合作方成本

### 5. 运单号生成
- `auto_number` 由系统自动生成
- 格式：`YDN + 日期 + 序号`（如：`YDN20250115001`）
- 不需要从 Excel 导入

---

## 📝 导入模式

### 创建模式
- 只创建新记录
- 如果检测到重复记录，会跳过并标记为重复

### 更新模式
- 如果检测到重复记录，会更新已存在的记录
- 如果不存在，会创建新记录

---

## 🎯 模板导入 vs 标准导入

### 标准导入
- Excel 列名必须与系统字段名匹配（支持模糊匹配）
- 不支持值转换规则
- 不支持默认值设置

### 模板导入
- Excel 列名可以任意命名
- 通过字段映射关联到系统字段
- 支持值转换规则（如：`"是"` → `"true"`）
- 支持默认值设置
- 支持固定值映射（如：所有记录都设置 `transport_type = "实际运输"`）

---

## 📌 注意事项

1. **必填字段**：标有 `*` 的字段为必填字段，用于验重
2. **日期格式**：支持多种日期格式，但建议使用 `YYYY-MM-DD` 格式
3. **数量字段**：根据合作链路的计费类型，可能是重量、发车次数或体积
4. **费用字段**：`payable_cost` 由触发器自动计算，不需要手动设置
5. **平台字段**：`other_platform_names` 和 `external_tracking_numbers` 需要按照特定格式填写
6. **验重字段**：8 个验重字段的组合必须唯一，否则会被识别为重复记录

---

## 🔄 增强版与标准版的区别

### 字段映射
- ✅ **完全相同**：所有导入功能使用相同的字段映射
- ✅ **相同的必填字段**：7个必填字段（项目名称、司机姓名、车牌号、装货地点、卸货地点、装货日期、装货数量）
- ✅ **相同的可选字段**：8个可选字段

### 功能差异

| 功能特性 | 标准导入 | 增强版标准导入 | 模板导入 |
|---------|---------|--------------|---------|
| **字段映射** | ✅ 硬编码匹配 | ✅ 硬编码匹配 | ✅ 模板映射 |
| **Excel列名** | 固定列名 | 固定列名 | 可自定义列名 |
| **日期格式支持** | 4种格式 | 6种格式（增强） | 6种格式（增强） |
| **日志系统** | 简单日志 | 4级日志系统（增强） | 简单日志 |
| **进度显示** | ❌ 无 | ✅ 实时进度（增强） | ❌ 无 |
| **模板生成** | 基础模板 | 增强模板（含示例）（增强） | 基础模板 |
| **创建/更新模式** | ✅ 支持 | ❌ 仅创建模式 | ✅ 支持 |
| **重复数据预览** | ✅ 支持 | ❌ 不支持 | ✅ 支持 |
| **模板映射** | ❌ 不支持 | ❌ 不支持 | ✅ 支持 |
| **值转换规则** | ❌ 不支持 | ❌ 不支持 | ✅ 支持 |
| **默认值设置** | ❌ 不支持 | ❌ 不支持 | ✅ 支持 |
| **固定值映射** | ❌ 不支持 | ❌ 不支持 | ✅ 支持 |

### 各功能详细说明

1. **标准导入**（运单维护 / 运单维护增强版）：
   - 使用硬编码字段名匹配（如：`项目名称`、`司机姓名`等）
   - 支持创建/更新模式
   - 支持重复数据预览和选择
   - Excel列名必须与系统字段名匹配

2. **增强版标准导入**（运单维护增强版）：
   - 使用硬编码字段名匹配（与标准导入相同）
   - 仅支持创建模式（不支持更新）
   - 不支持重复数据预览
   - 增强的日期解析（6种格式）
   - 4级日志系统和实时进度显示
   - Excel列名必须与系统字段名匹配

3. **模板导入**（运单维护增强版）：
   - ✅ **支持模板映射**：Excel列名可以任意命名
   - ✅ **支持值转换规则**：如"是"→"true"
   - ✅ **支持默认值设置**：Excel中为空时使用默认值
   - ✅ **支持固定值映射**：所有记录都设置固定值
   - 支持创建/更新模式
   - 支持重复数据预览

4. **选择性更新**（运单维护增强版）：
   - 用户可选择要更新的字段
   - 支持模板映射（可选）
   - 支持值转换规则（如果使用模板）

---

## 📅 文档更新日期

**最后更新**：2025-11-16

**版本**：v1.2

**修正说明**：
- v1.2：修正了增强版标准导入不支持模板映射的错误说明
- v1.1：添加了增强版与标准版的对比说明
- v1.0：初始版本

