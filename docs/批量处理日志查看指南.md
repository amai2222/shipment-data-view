# 批量处理日志查看指南

## 📋 使用的函数

批量处理功能使用的是 **`process-vehicles-batch`** Edge Function。

**函数路径**：`supabase/functions/process-vehicles-batch/index.ts`

## 🔍 查看日志的方法

### 方法 1：Supabase Dashboard（推荐）

1. **登录 Supabase Dashboard**
   - 访问：https://supabase.com/dashboard
   - 选择项目：`mnwzvtvyauyxwowjjsmf`

2. **进入 Edge Functions 日志**
   - 点击左侧菜单的 **Edge Functions**
   - 找到并点击 **`process-vehicles-batch`** 函数
   - 在函数详情页面，点击 **Logs** 选项卡

3. **查看实时日志**
   - 日志会实时显示函数执行情况
   - 可以看到每个车牌号的处理结果
   - 错误信息会以红色显示

**日志示例**：
```
🚀 [批量处理] 开始处理 8 个车辆
📋 [批量处理] 处理进度: 1/8 - 车牌号: 云F97112
✅ [批量处理] [1/8] 云F97112 - 处理成功
❌ [批量处理] [2/8] 云F97404 - 处理失败: 添加车辆失败: The signal has been aborted
```

### 方法 2：Supabase CLI

在项目根目录运行以下命令：

```bash
# 查看 process-vehicles-batch 函数的实时日志
supabase functions logs process-vehicles-batch --follow

# 查看最近的日志（默认显示最近 100 条）
supabase functions logs process-vehicles-batch

# 查看指定数量的日志
supabase functions logs process-vehicles-batch --limit 200

# 查看指定时间范围的日志
supabase functions logs process-vehicles-batch --since 1h
```

**参数说明**：
- `--follow` 或 `-f`：实时跟踪日志（类似 `tail -f`）
- `--limit` 或 `-n`：显示最近 N 条日志
- `--since`：显示指定时间范围内的日志（如 `1h`, `30m`, `2d`）

### 方法 3：浏览器控制台（前端日志）

1. **打开浏览器开发者工具**
   - 按 `F12` 或 `Ctrl + Shift + I`（Windows）
   - 或 `Cmd + Option + I`（Mac）

2. **切换到 Console 选项卡**

3. **查看批量处理日志**
   - 前端会输出详细的处理进度日志
   - 格式：`📋 [批量处理] 处理进度: X/Y - 车牌号: XXX`
   - 成功：`✅ [批量处理] [X/Y] XXX - 处理成功`
   - 失败：`❌ [批量处理] [X/Y] XXX - 处理失败: 错误信息`

**前端日志示例**：
```javascript
🔍 [批量处理] 第一步：开始并行查询本地数据库，车牌号数量: 8
✅ [批量处理] 第一步完成 - 本地数据库检查结果: {...}
🚀 [批量处理] 第二步：开始逐个处理本地没有的车牌，数量: 8
📋 [批量处理] 处理进度: 1/8 - 车牌号: 云F97112
✅ [批量处理] [1/8] 云F97112 - 处理成功
❌ [批量处理] [2/8] 云F97404 - 处理失败: 添加车辆失败: The signal has been aborted
📊 [批量处理] 处理完成 - 总数: 8, 成功: 6, 失败: 2
```

## 📊 日志内容说明

### 前端日志（浏览器控制台）

- **🔍 [批量处理] 第一步**：开始查询本地数据库
- **✅ [批量处理] 第一步完成**：本地数据库检查完成
- **🚀 [批量处理] 第二步**：开始处理车辆
- **📋 [批量处理] 处理进度**：当前处理进度
- **✅ [批量处理] [X/Y] XXX - 处理成功**：单个车辆处理成功
- **❌ [批量处理] [X/Y] XXX - 处理失败**：单个车辆处理失败
- **📊 [批量处理] 处理完成**：批量处理完成统计

### 后端日志（Supabase Dashboard / CLI）

- **🚀 [批量处理] 开始处理 N 个车辆**：开始批量处理
- **📋 [批量处理] 处理进度: X/Y - 车牌号: XXX**：当前处理进度
- **✅ [批量处理] [X/Y] XXX - 处理成功**：单个车辆处理成功
- **❌ [批量处理] [X/Y] XXX - 处理失败**：单个车辆处理失败
- **📊 [批量处理] 处理完成**：批量处理完成统计

## 🐛 常见错误排查

### 1. "The signal has been aborted" 错误

**原因**：请求超时或被取消

**解决方法**：
- 检查网络连接
- 增加超时时间（已在代码中设置为 60 秒）
- 查看 Supabase Dashboard 中的函数日志，确认具体错误

### 2. CORS 错误

**原因**：跨域请求被阻止

**解决方法**：
- 确认 `process-vehicles-batch` 函数的 CORS 配置正确
- 检查 Supabase Dashboard 中的函数配置

### 3. 网络请求失败

**原因**：网络问题或 Supabase 服务不可用

**解决方法**：
- 检查 Supabase 服务状态
- 查看浏览器 Network 选项卡，确认请求状态码

## 🔧 调试技巧

1. **过滤日志**：在浏览器控制台中使用过滤器，输入 `批量处理` 可以只显示批量处理相关的日志

2. **查看网络请求**：
   - 打开浏览器开发者工具的 **Network** 选项卡
   - 筛选 `process-vehicles-batch`
   - 查看每个请求的详细信息（请求头、响应体、状态码）

3. **查看函数代码**：
   - 函数位置：`supabase/functions/process-vehicles-batch/index.ts`
   - 可以查看具体的处理逻辑和错误处理

## 📝 日志级别

- **console.log**：一般信息（处理进度、成功消息）
- **console.error**：错误信息（处理失败、异常）
- **console.warn**：警告信息（跳过检查、降级处理）

---

**最后更新**：2025-12-05  
**函数名称**：`process-vehicles-batch`  
**函数路径**：`supabase/functions/process-vehicles-batch/index.ts`

