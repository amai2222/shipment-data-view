# è½¦è¾†è½¨è¿¹æŸ¥è¯¢ Edge Function ç¯å¢ƒå˜é‡é…ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

è½¦è¾†è½¨è¿¹æŸ¥è¯¢åŠŸèƒ½éœ€è¦åœ¨ Supabase Edge Function ä¸­é…ç½® `TRACKING_AUTH_SESSION` ç¯å¢ƒå˜é‡ï¼Œç”¨äºè®¿é—®ç¬¬ä¸‰æ–¹è½¨è¿¹ APIã€‚

## ğŸ”§ é…ç½®æ­¥éª¤

### æ–¹æ³• 1: é€šè¿‡ Supabase Dashboard é…ç½®ï¼ˆæ¨èï¼‰

1. **ç™»å½• Supabase Dashboard**
   - è®¿é—®ï¼šhttps://app.supabase.com
   - é€‰æ‹©æ‚¨çš„é¡¹ç›®

2. **è¿›å…¥ Edge Functions è®¾ç½®**
   - ç‚¹å‡»å·¦ä¾§èœå• **Edge Functions**
   - é€‰æ‹© **vehicle-tracking** å‡½æ•°
   - ç‚¹å‡» **Settings** æˆ– **Environment Variables**

3. **æ·»åŠ ç¯å¢ƒå˜é‡**
   - ç‚¹å‡» **Add new variable** æˆ– **+ Add**
   - å˜é‡åï¼š`TRACKING_AUTH_SESSION`
   - å˜é‡å€¼ï¼š`#13:206-dde3b628224190a02a6908b5-cladmin-ZKZY`ï¼ˆæˆ–æ‚¨çš„æœ€æ–° Tokenï¼‰
   - ç‚¹å‡» **Save**

4. **é‡æ–°éƒ¨ç½² Edge Function**
   - è¿”å› **Edge Functions** åˆ—è¡¨
   - æ‰¾åˆ° **vehicle-tracking** å‡½æ•°
   - ç‚¹å‡» **Deploy** æˆ–ä½¿ç”¨ CLI é‡æ–°éƒ¨ç½²

### æ–¹æ³• 2: ä½¿ç”¨ Supabase CLI é…ç½®

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
supabase secrets set TRACKING_AUTH_SESSION="#13:206-dde3b628224190a02a6908b5-cladmin-ZKZY"

# éƒ¨ç½² Edge Function
supabase functions deploy vehicle-tracking
```

### æ–¹æ³• 3: ä½¿ç”¨é»˜è®¤å€¼ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æœæœªé…ç½®ç¯å¢ƒå˜é‡ï¼Œç³»ç»Ÿä¼šä½¿ç”¨é»˜è®¤å€¼ï¼ˆå·²ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼‰ã€‚**âš ï¸ è­¦å‘Šï¼šé»˜è®¤ Token å¯èƒ½ä¼šè¿‡æœŸï¼Œå»ºè®®å°½å¿«é…ç½®ç¯å¢ƒå˜é‡ã€‚**

## âš ï¸ é‡è¦æç¤º

### Token è¿‡æœŸé—®é¢˜

- **é»˜è®¤ Token ä¼šè¿‡æœŸ**ï¼šå¦‚æœ Token è¿‡æœŸï¼Œéœ€è¦æ›´æ–°ç¯å¢ƒå˜é‡
- **å¦‚ä½•è·å–æ–° Token**ï¼š
  1. ç™»å½•ç¬¬ä¸‰æ–¹è½¨è¿¹ç³»ç»Ÿ
  2. åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­æŸ¥çœ‹ Cookie ä¸­çš„ `Auth-Session` å€¼
  3. æ›´æ–° Supabase ç¯å¢ƒå˜é‡
  4. é‡æ–°éƒ¨ç½² Edge Function

### å®‰å…¨å»ºè®®

- âœ… **ä½¿ç”¨ç¯å¢ƒå˜é‡**ï¼šä¸è¦å°† Token ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
- âœ… **å®šæœŸæ›´æ–° Token**ï¼šToken è¿‡æœŸååŠæ—¶æ›´æ–°
- âœ… **é™åˆ¶è®¿é—®æƒé™**ï¼šç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½

## ğŸ” éªŒè¯é…ç½®

é…ç½®å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯ï¼š

1. **æŸ¥çœ‹ Edge Function æ—¥å¿—**
   - åœ¨ Supabase Dashboard ä¸­æŸ¥çœ‹ Edge Functions çš„æ—¥å¿—
   - å¦‚æœçœ‹åˆ°è­¦å‘Šä¿¡æ¯ï¼Œè¯´æ˜æ­£åœ¨ä½¿ç”¨é»˜è®¤å€¼

2. **æµ‹è¯•è½¨è¿¹æŸ¥è¯¢**
   - åœ¨å‰ç«¯é¡µé¢å°è¯•æŸ¥è¯¢è½¦è¾†è½¨è¿¹
   - å¦‚æœæŸ¥è¯¢æˆåŠŸï¼Œè¯´æ˜é…ç½®æ­£ç¡®

## ğŸ“ ç›¸å…³æ–‡ä»¶

- Edge Function ä»£ç ï¼š`supabase/functions/vehicle-tracking/index.ts`
- åŒæ­¥è½¦è¾† ID å‡½æ•°ï¼š`supabase/functions/sync-vehicle-tracking-ids/index.ts`

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1: Missing TRACKING_AUTH_SESSION

**é”™è¯¯ä¿¡æ¯**ï¼š`Missing TRACKING_AUTH_SESSION`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦å·²é…ç½®
2. ç¡®è®¤ç¯å¢ƒå˜é‡åç§°æ­£ç¡®ï¼ˆå¤§å°å†™æ•æ„Ÿï¼‰
3. é‡æ–°éƒ¨ç½² Edge Function

### é—®é¢˜ 2: Token è¿‡æœŸ

**é”™è¯¯ä¿¡æ¯**ï¼šAPI è¿”å› 401 æˆ– 403 é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è·å–æœ€æ–°çš„ `Auth-Session` Token
2. æ›´æ–° Supabase ç¯å¢ƒå˜é‡
3. é‡æ–°éƒ¨ç½² Edge Function

### é—®é¢˜ 3: ç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿ç¯å¢ƒå˜é‡åç§°å®Œå…¨åŒ¹é…ï¼ˆåŒ…æ‹¬å¤§å°å†™ï¼‰
2. é‡æ–°éƒ¨ç½² Edge Functionï¼ˆç¯å¢ƒå˜é‡æ›´æ”¹éœ€è¦é‡æ–°éƒ¨ç½²æ‰èƒ½ç”Ÿæ•ˆï¼‰
3. æ¸…é™¤ Edge Function ç¼“å­˜ï¼ˆå¦‚æœæœ‰ï¼‰

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [Supabase Edge Functions æ–‡æ¡£](https://supabase.com/docs/guides/functions)
- [Supabase ç¯å¢ƒå˜é‡é…ç½®](https://supabase.com/docs/guides/functions/secrets)

---

**æœ€åæ›´æ–°**ï¼š2025-01-04  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ

