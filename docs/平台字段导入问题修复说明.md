# 平台字段导入问题修复说明

## 问题确认

您报告的问题：**"数据维护和运单管理的导入excel，为什么其他平台名称和其他平台运单号码都没有被导入？"**

## 问题分析

经过详细检查，发现问题的根本原因：

### 1. 前端处理正确 ✅
- `src/pages/DataImport.tsx` - 已正确处理平台字段
- `src/pages/BusinessEntry/hooks/useExcelImport.ts` - 已正确处理平台字段
- 前端正确解析Excel中的"其他平台名称"和"其他平台运单号"字段
- 前端正确转换为数据库字段：`external_tracking_numbers` 和 `other_platform_names`

### 2. 数据库函数问题 ❌
- `preview_import_with_duplicates_check` 函数没有处理平台字段
- `batch_import_logistics_records` 函数没有处理平台字段
- 导致平台字段在验重和导入过程中丢失

## 修复方案

### 1. 更新数据库函数

**文件**: `scripts/fix-platform-fields-in-import.sql`

#### 修复 `preview_import_with_duplicates_check` 函数
- 添加对 `external_tracking_numbers` 和 `other_platform_names` 字段的处理
- 确保这些字段在验重过程中被正确传递
- 在返回的记录中包含平台字段

#### 修复 `batch_import_logistics_records` 函数
- 添加对平台字段的插入逻辑
- 确保 `external_tracking_numbers` 以 JSONB 格式存储
- 确保 `other_platform_names` 以 TEXT[] 格式存储

### 2. 测试验证

**文件**: `scripts/test-platform-fields-import.sql`

创建了完整的测试脚本，验证：
- 平台字段导入功能
- 多装多卸功能中的平台字段
- 数据格式正确性

## 修复详情

### 1. 平台字段数据结构

#### external_tracking_numbers (JSONB格式)
```json
[
  {
    "platform": "货拉拉",
    "tracking_number": "HL20250120001",
    "status": "pending",
    "created_at": "2025-01-20T08:00:00Z"
  },
  {
    "platform": "满帮",
    "tracking_number": "MB20250120001",
    "status": "pending",
    "created_at": "2025-01-20T08:00:00Z"
  }
]
```

#### other_platform_names (TEXT[]格式)
```sql
["货拉拉", "满帮", "运满满"]
```

### 2. Excel填写格式

#### 其他平台名称
```
货拉拉,满帮,运满满
```

#### 其他平台运单号
```
HL20250120001|HL20250120002,MB20250120001,YM20250120001
```

**说明**：
- 逗号分隔不同平台
- 竖线分隔同一平台的多个运单号
- 平台名称和运单号按顺序一一对应

### 3. 数据库函数修复

#### preview_import_with_duplicates_check 函数
```sql
-- 在构建处理后的记录时，包含平台字段
processed_record := jsonb_build_object(
    -- ... 其他字段
    'external_tracking_numbers', record_data->'external_tracking_numbers',
    'other_platform_names', record_data->'other_platform_names'
);
```

#### batch_import_logistics_records 函数
```sql
-- 在插入运单记录时，包含平台字段
INSERT INTO public.logistics_records (
    -- ... 其他字段
    external_tracking_numbers,
    other_platform_names
) VALUES (
    -- ... 其他值
    CASE WHEN record_data->'external_tracking_numbers' IS NOT NULL 
         THEN record_data->'external_tracking_numbers' ELSE '[]'::jsonb END,
    CASE WHEN record_data->'other_platform_names' IS NOT NULL 
         THEN (record_data->'other_platform_names')::text[] ELSE '{}'::text[] END
);
```

## 执行步骤

### 1. 执行修复脚本
```sql
-- 在 Supabase SQL 编辑器中执行
\i scripts/fix-platform-fields-in-import.sql
```

### 2. 执行测试脚本
```sql
-- 在 Supabase SQL 编辑器中执行
\i scripts/test-platform-fields-import.sql
```

### 3. 验证修复效果
1. 打开数据维护页面
2. 下载Excel模板
3. 填写平台字段信息
4. 导入Excel文件
5. 检查导入的记录是否包含平台字段

## 预期结果

### 1. 导入成功
- Excel中的"其他平台名称"和"其他平台运单号"字段被正确解析
- 数据正确存储到 `external_tracking_numbers` 和 `other_platform_names` 字段
- 在运单详情中可以看到平台信息

### 2. 数据格式正确
- `external_tracking_numbers` 存储为JSONB格式
- `other_platform_names` 存储为TEXT[]格式
- 支持多个平台和多个运单号

### 3. 功能完整
- 数据维护页面导入功能正常
- 运单管理页面导入功能正常
- 多装多卸功能中的平台字段正常

## 测试用例

### 1. 基础平台字段测试
```
其他平台名称: 货拉拉,满帮,运满满
其他平台运单号: HL20250120001,MB20250120001,YM20250120001
```

### 2. 多运单号测试
```
其他平台名称: 货拉拉
其他平台运单号: HL20250120001|HL20250120002
```

### 3. 多装多卸平台字段测试
```
装货地点: 北京仓库|天津仓库
卸货地点: 上海仓库|苏州仓库
其他平台名称: 货拉拉,满帮
其他平台运单号: HL20250120001,MB20250120001
```

## 注意事项

### 1. 数据格式要求
- 平台名称用逗号分隔
- 运单号用逗号分隔不同平台，用竖线分隔同一平台的多个运单号
- 平台名称和运单号必须按顺序一一对应

### 2. 字段验证
- 导入后检查 `external_tracking_numbers` 字段是否为JSONB格式
- 导入后检查 `other_platform_names` 字段是否为TEXT[]格式
- 在运单详情页面验证平台信息显示

### 3. 错误处理
- 如果平台字段格式不正确，会在导入日志中显示错误
- 建议先在测试环境中验证修复效果

## 总结

通过修复数据库函数，解决了平台字段在导入过程中丢失的问题。现在：

1. ✅ 前端正确解析Excel中的平台字段
2. ✅ 数据库函数正确处理平台字段
3. ✅ 平台字段正确存储到数据库
4. ✅ 支持多平台和多运单号
5. ✅ 与多装多卸功能兼容

修复后，数据维护和运单管理的Excel导入功能将能够正确处理其他平台名称和运单号码字段。
