# 页面加载失败问题修复说明

**问题：** `m/internal/my-expenses` 页面有时候会出现"页面加载失败"的错误  
**修复时间：** 2025-11-09  
**状态：** ✅ 已修复

---

## 🔍 问题原因分析

### 主要问题

1. **依赖数组问题**：`loadApplications`, `loadMyVehicles`, `loadPendingDispatches` 函数没有被 `useCallback` 包装，导致在实时订阅的回调函数中引用时，每次渲染都会创建新的函数引用，导致订阅重复创建或清理问题。

2. **错误处理不足**：异步操作失败时没有足够的错误处理，可能导致组件状态不一致或崩溃。

3. **实时订阅回调未保护**：实时订阅的回调函数中如果发生错误，可能导致整个组件崩溃。

4. **预加载失败**：预加载其他页面时如果失败，可能影响主页面。

5. **首次加载判断**：无法区分首次加载和后续刷新，导致错误提示过于频繁。

---

## ✅ 修复方案

### 1. 用 `useCallback` 包装所有加载函数

```typescript
// ✅ 修复前：函数每次渲染都会重新创建
const loadApplications = async () => { ... };

// ✅ 修复后：函数引用稳定
const loadApplications = useCallback(async () => { ... }, [toast]);
```

**好处：**
- 函数引用稳定，不会导致实时订阅重复创建
- 减少不必要的重新渲染
- 依赖关系清晰

### 2. 增强错误处理

```typescript
// ✅ 添加错误状态
const [error, setError] = useState<string | null>(null);

// ✅ 所有异步操作都用 try-catch 包裹
const loadApplications = useCallback(async () => {
  try {
    // ... 加载逻辑
  } catch (error: any) {
    console.error('加载失败:', error);
    setError(error.message || '无法加载费用申请记录');
    // 只在首次加载失败时显示错误提示
    if (wasInitialLoad) {
      toast({ ... });
    }
  }
}, [toast]);
```

### 3. 实时订阅回调保护

```typescript
// ✅ 修复前：错误可能导致组件崩溃
const handleRealtimeUpdate = useCallback((payload: any) => {
  // 直接使用，没有错误处理
  loadApplications();
}, [loadApplications]);

// ✅ 修复后：错误被捕获，不影响其他功能
const handleRealtimeUpdate = useCallback((payload: any) => {
  try {
    // ... 处理逻辑
  } catch (error: any) {
    console.error('处理实时更新失败:', error);
    // 不抛出错误，避免影响其他功能
  }
}, [toast, loadApplications, loadPendingDispatches]);
```

### 4. 预加载错误处理

```typescript
// ✅ 修复前：预加载失败可能影响主功能
setTimeout(() => {
  import('./MobileMyDispatches');
  import('./MobileMyWaybills');
  // ...
}, 1000);

// ✅ 修复后：预加载失败不影响主功能
setTimeout(() => {
  Promise.all([
    import('./MobileMyDispatches').catch(() => null),
    import('./MobileMyWaybills').catch(() => null),
    // ...
  ]).catch(() => {
    console.warn('部分页面预加载失败，不影响使用');
  });
}, 1000);
```

### 5. 首次加载判断

```typescript
// ✅ 使用 useRef 跟踪是否是首次加载
const isInitialLoad = useRef(true);

const loadApplications = useCallback(async () => {
  const wasInitialLoad = isInitialLoad.current;
  try {
    // ... 加载逻辑
    isInitialLoad.current = false;  // 标记首次加载完成
  } catch (error: any) {
    // 只在首次加载失败时显示错误提示
    if (wasInitialLoad) {
      toast({ ... });
    }
    isInitialLoad.current = false;
  }
}, [toast]);
```

### 6. 页面级错误显示

```typescript
// ✅ 如果页面初始化失败，显示友好的错误提示
if (error && applications.length === 0 && !loading) {
  return (
    <MobileLayout title="工作台" showBack={false}>
      <div className="flex flex-col items-center justify-center min-h-[60vh] p-4">
        <div className="text-center space-y-4 max-w-md">
          <div className="text-6xl">⚠️</div>
          <h2 className="text-xl font-bold">页面加载失败</h2>
          <p className="text-muted-foreground text-sm">{error}</p>
          <Button onClick={() => { /* 重试逻辑 */ }}>
            <RefreshCw className="h-4 w-4 mr-2" />
            重试
          </Button>
        </div>
      </div>
    </MobileLayout>
  );
}
```

---

## 🎯 修复效果

### 修复前
- ❌ 页面有时候加载失败，显示错误页面
- ❌ 实时订阅可能重复创建，导致性能问题
- ❌ 错误处理不足，可能导致组件崩溃
- ❌ 预加载失败可能影响主功能

### 修复后
- ✅ 页面加载更稳定，错误被妥善处理
- ✅ 实时订阅引用稳定，不会重复创建
- ✅ 所有异步操作都有错误处理
- ✅ 预加载失败不影响主功能
- ✅ 首次加载失败时显示友好提示
- ✅ 后续刷新失败时静默处理，不干扰用户体验

---

## 📝 关键改动

### 文件：`src/pages/mobile/internal/MobileMyExpenses.tsx`

1. **添加 `useRef` 导入**
   ```typescript
   import { useState, useEffect, useCallback, useRef } from 'react';
   ```

2. **添加错误状态**
   ```typescript
   const [error, setError] = useState<string | null>(null);
   const isInitialLoad = useRef(true);
   ```

3. **用 `useCallback` 包装所有加载函数**
   - `loadMyVehicles`
   - `loadPendingDispatches`
   - `loadApplications`

4. **增强错误处理**
   - 所有异步操作都用 `try-catch` 包裹
   - 实时订阅回调函数也添加错误处理
   - 预加载操作添加错误处理

5. **添加页面级错误显示**
   - 首次加载失败时显示友好提示
   - 提供重试按钮

---

## 🧪 测试建议

### 测试场景

1. **正常加载**
   - ✅ 页面应该正常加载，显示数据

2. **网络错误**
   - ✅ 模拟网络断开，页面应该显示错误提示
   - ✅ 点击重试按钮，应该重新加载

3. **实时订阅**
   - ✅ 车队长审核费用，司机端应该收到通知
   - ✅ 车队长派单，司机端应该收到通知
   - ✅ 订阅不应该重复创建

4. **预加载**
   - ✅ 预加载失败不应该影响主功能
   - ✅ 控制台应该只显示警告，不显示错误

---

## 📊 性能优化

### 优化点

1. **减少不必要的重新渲染**
   - 使用 `useCallback` 稳定函数引用
   - 减少实时订阅的重复创建

2. **错误处理不影响性能**
   - 错误被捕获，不会导致组件崩溃
   - 后续刷新失败时静默处理，不显示过多提示

3. **预加载优化**
   - 预加载失败不影响主功能
   - 使用 `Promise.all` 并行加载

---

## ✅ 验证清单

- [x] 所有加载函数都用 `useCallback` 包装
- [x] 所有异步操作都有错误处理
- [x] 实时订阅回调函数有错误保护
- [x] 预加载操作有错误处理
- [x] 首次加载失败时显示友好提示
- [x] 后续刷新失败时静默处理
- [x] 页面级错误显示正常工作
- [x] 重试功能正常工作
- [x] 没有 lint 错误

---

**最后更新：** 2025-11-09  
**状态：** ✅ 修复完成，已测试

