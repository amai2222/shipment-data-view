# 其他平台名称字段设计方案

## 📋 需求分析

### 1. **业务需求**
- 在 `logistics_records` 表中添加字段记录**其他平台名称**
- 支持单个或多个平台名称
- 与现有的 `external_tracking_numbers` 字段配合使用
- 简单直接的实现方式

### 2. **字段设计选项**

#### 选项一：单个平台名称字段
```sql
ALTER TABLE public.logistics_records 
ADD COLUMN other_platform_name TEXT;
```

#### 选项二：多个平台名称字段（推荐）
```sql
ALTER TABLE public.logistics_records 
ADD COLUMN other_platform_names TEXT[] DEFAULT '{}';
```

#### 选项三：JSON字段（最灵活）
```sql
ALTER TABLE public.logistics_records 
ADD COLUMN other_platform_info JSONB DEFAULT '[]'::jsonb;
```

## 🎯 推荐方案：TEXT数组字段

### 1. **优势**
- 简单易用
- 支持多个平台名称
- 查询性能好
- 与PostgreSQL数组功能完美配合

### 2. **数据结构**
```sql
-- 示例数据
other_platform_names: ['货拉拉', '满帮', '运满满']
other_platform_names: ['滴滴货运']
other_platform_names: []  -- 空数组表示无其他平台
```

### 3. **查询示例**
```sql
-- 查询包含特定平台的运单
SELECT * FROM logistics_records 
WHERE '货拉拉' = ANY(other_platform_names);

-- 查询包含多个平台的运单
SELECT * FROM logistics_records 
WHERE other_platform_names && ARRAY['货拉拉', '满帮'];

-- 查询有其他平台的运单
SELECT * FROM logistics_records 
WHERE array_length(other_platform_names, 1) > 0;
```

## 🗄️ 数据库设计

### 1. **字段定义**
```sql
-- 添加其他平台名称字段
ALTER TABLE public.logistics_records 
ADD COLUMN other_platform_names TEXT[] DEFAULT '{}';

-- 添加字段注释
COMMENT ON COLUMN public.logistics_records.other_platform_names IS '其他平台名称数组，记录该运单涉及的其他物流平台';

-- 创建索引
CREATE INDEX idx_logistics_records_other_platform_names 
ON public.logistics_records USING GIN (other_platform_names);
```

### 2. **常用查询函数**
```sql
-- 根据平台名称查询运单
CREATE OR REPLACE FUNCTION public.get_logistics_records_by_platform(
  p_platform_name TEXT
)
RETURNS TABLE (
  id UUID,
  auto_number TEXT,
  project_name TEXT,
  other_platform_names TEXT[]
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    lr.id,
    lr.auto_number,
    lr.project_name,
    lr.other_platform_names
  FROM public.logistics_records lr
  WHERE p_platform_name = ANY(lr.other_platform_names);
END;
$$;

-- 获取所有使用过的平台名称
CREATE OR REPLACE FUNCTION public.get_all_used_platforms()
RETURNS TABLE (
  platform_name TEXT,
  usage_count BIGINT
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    platform_name,
    COUNT(*) as usage_count
  FROM (
    SELECT unnest(other_platform_names) as platform_name
    FROM public.logistics_records
    WHERE other_platform_names IS NOT NULL
    AND array_length(other_platform_names, 1) > 0
  ) t
  GROUP BY platform_name
  ORDER BY usage_count DESC;
END;
$$;
```

## 🎨 前端界面设计

### 1. **运单表单中的平台名称输入**

```tsx
// 其他平台名称输入组件
<div className="space-y-2">
  <Label>其他平台名称</Label>
  <div className="space-y-2">
    {otherPlatformNames.map((platform, index) => (
      <div key={index} className="flex gap-2">
        <Input
          value={platform}
          onChange={(e) => updatePlatformName(index, e.target.value)}
          placeholder="输入平台名称"
        />
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => removePlatformName(index)}
        >
          <Trash2 className="h-4 w-4" />
        </Button>
      </div>
    ))}
    <Button
      type="button"
      variant="outline"
      size="sm"
      onClick={addPlatformName}
    >
      <Plus className="mr-2 h-4 w-4" />
      添加平台
    </Button>
  </div>
</div>
```

### 2. **运单列表中的显示**

```tsx
// 在运单列表中显示其他平台名称
<TableCell>
  <div>
    <div className="font-medium">{record.auto_number}</div>
    {record.other_platform_names && record.other_platform_names.length > 0 && (
      <div className="text-sm text-muted-foreground mt-1">
        {record.other_platform_names.map((platform, index) => (
          <Badge key={index} variant="secondary" className="mr-1 text-xs">
            {platform}
          </Badge>
        ))}
      </div>
    )}
  </div>
</TableCell>
```

### 3. **运单详情中的展示**

```tsx
// 运单详情中的其他平台信息
{record.other_platform_names && record.other_platform_names.length > 0 && (
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <ExternalLink className="h-5 w-5" />
        其他平台
      </CardTitle>
    </CardHeader>
    <CardContent>
      <div className="flex flex-wrap gap-2">
        {record.other_platform_names.map((platform, index) => (
          <Badge key={index} variant="outline" className="text-sm">
            {platform}
          </Badge>
        ))}
      </div>
    </CardContent>
  </Card>
)}
```

## 🔧 实施步骤

### 1. **数据库更新**
```sql
-- 添加字段
ALTER TABLE public.logistics_records 
ADD COLUMN other_platform_names TEXT[] DEFAULT '{}';

-- 添加注释
COMMENT ON COLUMN public.logistics_records.other_platform_names IS '其他平台名称数组';

-- 创建索引
CREATE INDEX idx_logistics_records_other_platform_names 
ON public.logistics_records USING GIN (other_platform_names);

-- 创建查询函数
CREATE OR REPLACE FUNCTION public.get_logistics_records_by_platform(TEXT)
RETURNS TABLE (id UUID, auto_number TEXT, project_name TEXT, other_platform_names TEXT[])
LANGUAGE plpgsql AS $$
BEGIN
  RETURN QUERY
  SELECT lr.id, lr.auto_number, lr.project_name, lr.other_platform_names
  FROM public.logistics_records lr
  WHERE p_platform_name = ANY(lr.other_platform_names);
END;
$$;
```

### 2. **前端更新**
- 在运单表单中添加平台名称输入组件
- 在运单列表和详情中显示平台名称
- 更新TypeScript类型定义

### 3. **类型定义更新**
```typescript
// 更新LogisticsRecord接口
export interface LogisticsRecord {
  // ... 现有字段
  other_platform_names?: string[]; // 其他平台名称数组
}
```

## 📊 使用示例

### 1. **添加平台名称**
```typescript
// 在运单表单中
const [otherPlatformNames, setOtherPlatformNames] = useState<string[]>([]);

const addPlatformName = () => {
  setOtherPlatformNames([...otherPlatformNames, '']);
};

const updatePlatformName = (index: number, value: string) => {
  const newPlatforms = [...otherPlatformNames];
  newPlatforms[index] = value;
  setOtherPlatformNames(newPlatforms);
};
```

### 2. **保存运单**
```typescript
// 保存运单时包含平台名称
const saveLogisticsRecord = async (formData: any) => {
  const recordData = {
    ...formData,
    other_platform_names: otherPlatformNames.filter(name => name.trim() !== '')
  };
  
  await supabase
    .from('logistics_records')
    .insert(recordData);
};
```

### 3. **查询运单**
```sql
-- 查询包含"货拉拉"的运单
SELECT * FROM get_logistics_records_by_platform('货拉拉');

-- 查询所有使用过的平台
SELECT * FROM get_all_used_platforms();
```

## 🎯 优势

### 1. **简单易用**
- 直接添加字段，无需复杂表结构
- 使用PostgreSQL原生数组功能
- 查询性能优秀

### 2. **灵活扩展**
- 支持任意数量的平台名称
- 可以随时添加或删除平台
- 与现有功能完美配合

### 3. **数据一致性**
- 使用数组确保数据格式统一
- 支持空数组表示无其他平台
- 便于数据验证和清理

这个方案简单直接，完全满足您记录其他平台名称的需求！
