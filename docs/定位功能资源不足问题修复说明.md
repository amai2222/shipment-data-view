# 定位功能资源不足问题修复说明

## 🐛 问题描述

**错误信息**：`Function failed due to not having enough compute resources (please check logs)`

**发生位置**：定位功能（"定位"标签页）批量查询车辆位置时

**原因分析**：
1. **批量查询无延迟**：前端逐个调用 `vehicle-tracking` Edge Function，请求之间没有延迟，导致同时发起多个请求
2. **Edge Function 资源限制**：Supabase Edge Function 有资源限制，同时处理多个请求时可能资源不足
3. **无并发控制**：没有限制批量查询的数量，用户可能输入大量车牌号

## ✅ 修复方案（已更新为批次并发查询）

### 1. 批次并发查询（每批5个）

**策略**：将车辆列表分成多个批次，每批同时查询 **5 个车辆**，批次之间串行执行

```typescript
// 批次大小：每批同时查询5个
const BATCH_SIZE = 5;

// 将车辆列表分成批次
const batches: string[][] = [];
for (let i = 0; i < licensePlates.length; i += BATCH_SIZE) {
  batches.push(licensePlates.slice(i, i + BATCH_SIZE));
}

// 逐个批次处理
for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
  const batch = batches[batchIndex];
  
  // 并发查询当前批次的所有车辆
  const batchPromises = batch.map(async (plate) => {
    // 查询单个车辆的位置
  });
  
  // 等待当前批次全部完成
  const batchResults = await Promise.all(batchPromises);
  
  // 批次之间添加短暂延迟
  if (batchIndex < batches.length - 1) {
    await new Promise(resolve => setTimeout(resolve, 500)); // 500ms 延迟
  }
}
```

### 2. 支持中断功能

**实现**：使用 `AbortController` 支持随时中断查询

```typescript
// 创建 AbortController
locationAbortControllerRef.current = new AbortController();
const abortSignal = locationAbortControllerRef.current.signal;

// 在查询过程中检查是否被中断
if (abortSignal.aborted) {
  console.log('⏹️ 定位查询已中断');
  break;
}

// 在 fetch 请求中传递 signal
const response = await fetch(url, {
  signal: abortSignal // 支持中断
});
```

### 3. 优化错误处理

**特殊处理资源不足错误**：
- 检测错误信息中是否包含 `compute resources` 或 `资源不足`
- 显示更友好的错误提示
- 自动增加延迟并继续处理

```typescript
// 特殊处理资源不足错误
if (errorMessage.includes('compute resources') || errorMessage.includes('资源不足') || response.status === 503) {
  finalErrorMessage = '服务器资源不足，请稍后重试或减少批量查询数量';
  // 增加延迟
  await new Promise(resolve => setTimeout(resolve, 3000));
}
```

### 4. 实时进度更新

**显示当前处理进度**：
- 实时更新 `locationResults` 状态
- 用户可以看到当前处理的车辆和结果

```typescript
// 实时更新结果（显示进度）
setLocationResults([...results]);
```

## 📊 修复效果

### 修复前
- ❌ 批量查询时可能同时发起多个请求
- ❌ 遇到资源不足错误时直接失败
- ❌ 无批量查询数量限制
- ❌ 不支持中断

### 修复后
- ✅ **批次并发查询**：每批同时查询5个，批次之间串行执行
- ✅ **支持中断**：随时可以取消查询
- ✅ **实时显示进度**：显示当前处理的批次和结果
- ✅ **批次间延迟**：批次之间延迟500ms，避免资源竞争
- ✅ **更友好的错误提示**：特殊处理资源不足错误

## 🎯 使用建议

### 批量查询最佳实践

1. **无数量限制**：现在支持查询任意数量的车辆，系统会自动分批处理
2. **批次处理**：每批同时查询5个车辆，完成后再处理下一批
3. **支持中断**：如果查询时间过长，可以随时点击"取消定位"按钮中断
4. **监控进度**：观察处理进度，实时查看每个车辆的查询结果

### 示例

```typescript
// ✅ 推荐：系统自动分批处理
输入: 50个车辆
系统处理:
  批次1: 车辆1-5 (并发查询)
  批次2: 车辆6-10 (并发查询)
  批次3: 车辆11-15 (并发查询)
  ...
  批次10: 车辆46-50 (并发查询)

// ✅ 支持中断
点击"取消定位"按钮 → 立即中断当前查询
```

## 🔍 相关文件

- **前端代码**：`src/pages/VehicleTracking.tsx`（`handleLocation` 函数）
- **后端函数**：`supabase/functions/vehicle-tracking/index.ts`

## 📝 技术细节

### 批次并发查询说明

- **每批5个车辆**：
  - 平衡查询速度和资源使用
  - 避免同时发起过多请求导致资源不足
  - 批次之间串行执行，确保资源释放

- **批次间延迟500ms**：
  - 给服务器时间释放资源
  - 避免批次之间资源竞争
  - 平衡查询速度和系统稳定性

### 中断功能说明

- **AbortController**：
  - 使用浏览器原生 `AbortController` API
  - 支持中断正在进行的 fetch 请求
  - 中断后立即停止查询，不等待当前批次完成

- **中断时机**：
  - 可以在任何时刻点击"取消定位"按钮
  - 中断后显示已查询的结果
  - 不会影响已完成的查询结果

---

**修复日期**：2025-01-27  
**更新日期**：2025-01-27（批次并发查询 + 中断支持）  
**修复版本**：v2.0.0  
**状态**：✅ 已修复并部署

