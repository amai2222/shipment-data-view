# 集成权限管理 - 合同权限管理使用指南

## 📋 概述

合同权限管理已成功集成到"设置-集成权限管理"系统中，现在您可以在统一的界面中管理所有权限，包括用户权限、角色权限和合同权限。

## 🎯 功能位置

### 1. 访问路径
```
设置 → 集成权限管理 → 合同权限标签页
```

### 2. 界面布局
集成权限管理现在包含4个标签页：
- **用户管理**: 管理用户信息、角色和状态
- **权限配置**: 配置用户和角色的详细权限
- **合同权限**: 管理合同相关的细粒度权限
- **角色模板**: 管理预设的权限模板

## 🔧 合同权限管理功能

### 1. 权限统计面板
- **总权限数**: 显示所有合同权限记录数量
- **有效权限**: 显示当前有效的权限数量
- **过期权限**: 显示已过期的权限数量
- **用户权限**: 显示用户级权限数量

### 2. 权限列表管理
- **搜索功能**: 支持按合同、用户、角色、部门搜索
- **筛选功能**: 支持按权限类型、目标类型、状态筛选
- **批量操作**: 支持批量启用、禁用、删除权限
- **权限状态**: 可视化显示权限状态（有效/禁用/过期）

### 3. 权限分配
- **合同选择**: 选择要分配权限的合同
- **权限对象**: 选择用户、角色或部门
- **权限类型**: 选择具体的权限类型
- **过期时间**: 设置权限过期时间（可选）

## 🎨 权限类型说明

### 基础权限
- **查看 (view)**: 查看合同基本信息
- **下载 (download)**: 下载合同文件
- **编辑 (edit)**: 修改合同信息
- **删除 (delete)**: 删除合同记录

### 高级权限
- **管理 (manage)**: 管理合同权限
- **敏感信息 (sensitive)**: 查看金额、条款等敏感信息
- **审批 (approve)**: 审批合同
- **归档 (archive)**: 归档合同
- **审计 (audit)**: 查看审计日志

## 🔒 权限分配维度

### 1. 用户级权限
直接分配给特定用户，支持临时权限和永久权限。

**使用场景**:
- 临时授权特定用户访问某个合同
- 为特定用户设置特殊的合同权限
- 临时项目需要特定用户参与

### 2. 角色级权限
基于用户角色的权限模板，支持角色继承。

**使用场景**:
- 财务人员自动获得财务相关合同权限
- 业务人员自动获得业务相关合同权限
- 管理员自动获得所有合同权限

### 3. 部门级权限
基于组织架构的权限分配。

**使用场景**:
- 财务部门自动获得财务合同权限
- 法务部门自动获得合同审核权限
- 业务部门自动获得业务合同权限

## 📊 权限矩阵

### 角色权限矩阵

| 权限类型 | 管理员 | 财务 | 业务 | 操作员 | 查看者 |
|---------|--------|------|------|--------|--------|
| 查看合同 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 下载文件 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 编辑合同 | ✅ | ❌ | ✅ | ❌ | ❌ |
| 删除合同 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 管理权限 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 敏感信息 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 审批合同 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 归档合同 | ✅ | ❌ | ✅ | ❌ | ❌ |

## 🚀 使用步骤

### 1. 访问合同权限管理
1. 进入"设置"页面
2. 点击"集成权限管理"
3. 切换到"合同权限"标签页

### 2. 查看权限统计
- 查看总权限数量
- 查看有效/过期权限统计
- 查看权限类型分布

### 3. 创建新权限
1. 点击"新增权限"按钮
2. 选择要分配权限的合同
3. 选择权限对象（用户/角色/部门）
4. 选择权限类型
5. 设置过期时间（可选）
6. 点击"创建权限"

### 4. 管理现有权限
1. 使用搜索和筛选功能找到目标权限
2. 选择要操作的权限记录
3. 使用批量操作或单个操作
4. 编辑权限类型或过期时间
5. 启用/禁用权限状态

### 5. 批量操作
1. 选择多个权限记录
2. 使用批量操作工具栏
3. 选择操作类型（启用/禁用/删除）
4. 确认操作

## 🔍 权限检查

### 1. 前端权限检查
```typescript
import { ContractPermissionService } from '@/services/ContractPermissionService';

// 检查用户是否有特定合同权限
const hasPermission = await ContractPermissionService.hasPermission(
  userId,
  contractId,
  'edit'
);
```

### 2. 组件级权限控制
```typescript
import { useContractPermission } from '@/services/ContractPermissionService';

function ContractEditButton({ contractId }: { contractId: string }) {
  const { hasPermission, loading } = useContractPermission(contractId, 'edit');
  
  if (loading) return <LoadingSpinner />;
  if (!hasPermission) return null;
  
  return <Button onClick={handleEdit}>编辑合同</Button>;
}
```

## 📈 权限统计和分析

### 1. 权限使用统计
- 按权限类型统计使用情况
- 按用户/角色/部门统计权限分布
- 权限过期情况分析

### 2. 权限趋势分析
- 权限创建趋势
- 权限使用频率分析
- 权限过期预警

### 3. 权限合规检查
- 检查权限是否符合最小权限原则
- 检查是否有过期权限需要清理
- 检查权限分配是否合理

## 🔧 高级功能

### 1. 权限模板
使用预设的权限模板快速分配权限：
- **基础查看权限**: 只能查看合同基本信息
- **文件下载权限**: 可以下载合同文件
- **编辑权限**: 可以编辑合同信息
- **完整权限**: 拥有所有权限
- **财务权限**: 财务相关权限
- **业务权限**: 业务操作权限

### 2. 权限继承
- 角色权限自动继承到用户
- 部门权限自动继承到用户
- 权限优先级处理（用户 > 角色 > 部门）

### 3. 权限审计
- 记录所有权限变更操作
- 记录权限使用情况
- 生成权限审计报告

## 🎯 最佳实践

### 1. 权限分配原则
- **最小权限原则**: 只授予必要的权限
- **职责分离**: 将敏感权限与普通权限分离
- **定期审查**: 定期检查和清理过期权限

### 2. 权限管理策略
- **使用权限模板**: 统一权限管理标准
- **批量操作**: 提高权限管理效率
- **权限监控**: 实时监控权限使用情况

### 3. 安全控制
- **权限验证**: 在关键操作前验证权限
- **审计跟踪**: 记录所有权限相关操作
- **权限过期**: 设置合理的权限过期时间

## 🔍 故障排除

### 1. 常见问题

**Q: 合同权限列表为空**
A: 检查数据库表是否正确创建，运行迁移脚本：
```sql
\i scripts/contract-permission-management-migration.sql
```

**Q: 无法创建权限**
A: 检查用户是否有创建权限的权限，确保数据库连接正常。

**Q: 权限检查总是返回false**
A: 检查权限是否已激活，是否已过期，用户是否已登录。

### 2. 调试工具

```typescript
// 启用权限调试
const DEBUG_CONTRACT_PERMISSIONS = process.env.NODE_ENV === 'development';

if (DEBUG_CONTRACT_PERMISSIONS) {
  console.log('合同权限检查:', { userId, contractId, permissionType, result });
}
```

### 3. 权限验证脚本

```sql
-- 检查用户权限
SELECT * FROM contract_permissions 
WHERE user_id = 'user-uuid' 
  AND contract_id = 'contract-uuid' 
  AND permission_type = 'edit'
  AND is_active = true;

-- 检查角色权限
SELECT * FROM contract_permissions cp
JOIN profiles p ON p.id = 'user-uuid'
WHERE cp.contract_id = 'contract-uuid' 
  AND cp.role_id = p.role
  AND cp.permission_type = 'edit'
  AND cp.is_active = true;
```

## 📚 相关文档

- [合同权限管理系统设计方案](./contract-permission-management-design.md)
- [合同权限管理使用指南](./contract-permission-management-guide.md)
- [集成权限管理最佳实践](./permission-management-best-practices.md)

## 🎉 总结

合同权限管理已成功集成到集成权限管理系统中，现在您可以：

1. **统一管理**: 在一个界面中管理所有权限
2. **细粒度控制**: 精确控制合同访问权限
3. **批量操作**: 高效管理大量权限
4. **实时统计**: 实时查看权限使用情况
5. **审计跟踪**: 完整的权限变更记录

这个集成方案提供了完整的合同权限管理解决方案，确保合同数据的安全性和合规性！
