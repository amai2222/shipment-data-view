# 定价法保护机制说明

## 🛡️ 保护机制总览

定价法（fixed_price）已集成完整的三重保护机制，确保数据安全和业务逻辑正确。

---

## ✅ 三重保护机制

### 1️⃣ 运单状态保护（运单级）

**保护对象**：整条运单的所有合作方成本

**检查条件**：
```sql
-- 跳过已付款、已开票或已收款的运单
IF v_record_status.payment_status != 'Unpaid' 
   OR (v_record_status.invoice_status IS NOT NULL AND v_record_status.invoice_status != 'Uninvoiced')
   OR (v_record_status.receipt_status IS NOT NULL AND v_record_status.receipt_status = 'Received') THEN
    -- 跳过自动重算
    CONTINUE;
END IF;
```

**保护范围**：
- ✅ **已付款运单**（`payment_status != 'Unpaid'`）
- ✅ **已开票运单**（`invoice_status != 'Uninvoiced'`）
- ✅ **已收款运单**（`receipt_status = 'Received'`）

**保护级别**：**运单级**

**保护效果**：
- 一旦运单进入"已付款"、"已开票"或"已收款"状态，该运单的所有合作方成本（包括定价法）都不会被自动重算
- 即使修改了有效数量、基础运价等字段，系统也不会触发重算
- 保护财务数据的完整性和一致性

---

### 2️⃣ 手工修改保护（成本记录级）

**保护对象**：特定合作方的手工修改的应付金额

**检查条件**：
```sql
-- 检查该合作方是否被手工修改过
IF EXISTS (
    SELECT 1
    FROM jsonb_array_elements(v_manually_modified_costs) AS elem
    WHERE (elem->>'partner_id')::UUID = v_project_partners.partner_id
    AND (elem->>'level')::INTEGER = v_project_partners.level
) THEN
    RAISE NOTICE '⏭️  保护手工修改：level=%, 跳过重算', v_project_partners.level;
    CONTINUE;  -- 跳过重算，保留手工值
END IF;
```

**保护范围**：
- ✅ **所有计算方法的手工修改**：税点法、利润法、定价法
- ✅ **任何层级的合作方**：1级、2级、3级...所有层级

**保护级别**：**成本记录级**

**保护效果**：
- 用户在对账管理中手工修改合作方应付金额后，系统会标记 `is_manually_modified = true`
- 后续自动重算时，会跳过这些记录，保留用户的手工修改值
- 即使链路配置改变、有效数量改变，手工修改的值也不会被覆盖

---

### 3️⃣ 独立计算保护（层级级）

**保护对象**：每个层级的独立计算逻辑

**计算逻辑**：
```sql
-- ✅ 每个level都独立从payable_cost（司机应收）开始计算
v_base_amount := v_base_amount;  -- 使用payable_cost

-- ✅ 根据计算方法计算应付金额（支持三种方法）
IF v_project_partners.calculation_method = 'fixed_price' THEN
    -- 直接定价法：有效数量 × 单价（不依赖 payable_cost）
    v_payable_amount := v_effective_quantity * v_project_partners.unit_price;
ELSIF v_project_partners.calculation_method = 'profit' THEN
    -- 利润法：基础金额 + (利润 × 装货重量)
    v_payable_amount := v_base_amount + (profit_rate * v_loading_weight);
ELSE
    -- 税点法：基础金额 / (1 - 税点)
    v_payable_amount := v_base_amount / (1 - v_project_partners.tax_rate);
END IF;
```

**保护范围**：
- ✅ **定价法独立计算**：不依赖基础运价，只依赖有效数量和单价
- ✅ **层级间互不影响**：每个层级独立计算，不级联

**保护级别**：**层级级**

**保护效果**：
- 定价法不受基础运价（`payable_cost`）变化的影响
- 修改基础运价时，定价法合作方不会重新计算
- 每个层级独立计算，一个层级的修改不影响其他层级

---

## 📊 保护机制对比表

| 保护类型 | 检查条件 | 保护对象 | 保护级别 | 定价法支持 |
|---------|---------|---------|---------|-----------|
| **运单状态保护** | 已付款/已开票/已收款 | 整条运单 | 运单级 | ✅ 支持 |
| **手工修改保护** | `is_manually_modified = true` | 特定合作方成本 | 成本记录级 | ✅ 支持 |
| **独立计算保护** | 每个level独立计算 | 层级间互不影响 | 层级级 | ✅ 支持 |

---

## 🔧 适用的函数和触发器

### 批量重算函数
- **函数名**：`batch_recalculate_partner_costs(p_record_ids UUID[])`
- **调用方式**：手动调用（RPC）
- **保护机制**：✅✅✅ 三重保护

### 自动重算触发器1
- **触发器名**：`trigger_recalc_on_payable_cost_change`
- **触发时机**：`AFTER UPDATE OF payable_cost`
- **功能**：基础运价改变时自动重算
- **保护机制**：✅✅✅ 三重保护

### 自动重算触发器2
- **触发器名**：`trigger_recalc_on_effective_quantity_change`
- **触发时机**：`AFTER UPDATE OF effective_quantity, payable_cost, loading_weight, unloading_weight, chain_id, project_id`
- **功能**：有效数量或相关字段改变时自动重算
- **保护机制**：✅✅✅ 三重保护

---

## 🎯 使用场景示例

### 场景1：手工修改最高级合作方成本（定价法）

**操作步骤**：
1. 在对账管理中，找到使用定价法的合作方
2. 手工修改应付金额（例如从 200 元改为 250 元）
3. 保存后，系统标记 `is_manually_modified = true`

**后续行为**：
- ✅ 修改有效数量：手工值不变（保留 250 元）
- ✅ 修改基础运价：手工值不变（保留 250 元，且定价法本身也不依赖基础运价）
- ✅ 修改链路配置：手工值不变（保留 250 元）
- ✅ 运单开票：手工值不变（已开票后不再重算）
- ✅ 运单付款：手工值不变（已付款后不再重算）
- ✅ 运单收款：手工值不变（已收款后不再重算）

---

### 场景2：已开票运单

**运单状态**：
- `invoice_status = 'Invoiced'`（已开票）
- 使用定价法的合作方：单价 10 元/吨，有效数量 20 吨，应付金额 200 元

**后续操作**：
1. 修改装货重量（导致有效数量变化）
2. 修改卸货重量（导致有效数量变化）
3. 修改链路（改变计费模式）
4. 手动调用重算函数

**结果**：
- ✅ **所有自动重算都被跳过**
- ✅ **应付金额保持 200 元不变**
- ✅ **财务数据不受影响**

---

### 场景3：未开票运单 + 定价法

**运单状态**：
- `invoice_status = 'Uninvoiced'`（未开票）
- `payment_status = 'Unpaid'`（未付款）
- `receipt_status = 'Unreceived'`（未收款）
- 使用定价法的合作方：单价 10 元/吨，有效数量 20 吨，应付金额 200 元

**后续操作**：
1. 修改装货重量从 20 吨改为 25 吨
2. 触发器自动计算新的有效数量为 25 吨
3. 自动重算定价法合作方成本

**结果**：
- ✅ **自动重算**：应付金额 = 25 × 10 = 250 元
- ✅ **基础运价不影响定价法**：即使基础运价改变，定价法仍然按有效数量计算

---

## 📋 验证清单

### 运单状态保护验证
- [x] 已付款运单不会重算
- [x] 已开票运单不会重算
- [x] 已收款运单不会重算
- [x] 三种状态同时存在时不会重算

### 手工修改保护验证
- [x] 手工修改税点法合作方，重算时保留
- [x] 手工修改利润法合作方，重算时保留
- [x] 手工修改定价法合作方，重算时保留
- [x] 手工修改最高级合作方，重算时保留

### 独立计算验证
- [x] 定价法不依赖基础运价
- [x] 修改基础运价时，定价法不重算
- [x] 修改有效数量时，定价法自动重算
- [x] 每个层级独立计算，互不影响

---

## 🚨 重要提示

1. **三重保护机制相互独立**
   - 运单状态保护优先级最高
   - 手工修改保护适用于所有计算方法
   - 独立计算保护确保定价法的独立性

2. **手工修改后如何恢复自动计算**
   - 在数据库中将 `is_manually_modified` 设为 `false`
   - 或者删除该成本记录，让系统重新生成

3. **定价法不依赖基础运价**
   - 修改基础运价（`payable_cost`）不会触发定价法重算
   - 只有有效数量（`effective_quantity`）改变才会触发定价法重算

4. **已开票/已付款/已收款后不可修改**
   - 一旦运单进入这些状态，所有自动重算都会被阻止
   - 确保财务数据的完整性和一致性

---

**创建日期**：2025-11-20  
**最后更新**：2025-11-20  
**状态**：✅ 保护机制完整，可以安全使用

