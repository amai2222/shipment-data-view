# 磅单管理修复说明

## 修复内容

### 1. 编辑时车次读取问题修复

**问题描述**：
- 编辑磅单记录时，车次字段没有正确显示当前记录的车次
- 而是显示了下一个可用的车次

**根本原因**：
- `loadAvailableTrips` 函数在查询现有车次时，包含了当前正在编辑的记录
- 导致当前记录的车次被排除在可用选项之外

**修复方案**：
```typescript
// 在编辑模式下，排除当前记录本身
if (isEditMode && editingRecord?.id) {
  query = query.neq('id', editingRecord.id);
}
```

**修复效果**：
- 编辑时车次字段正确显示当前记录的车次
- 同时仍然提供其他可用的车次选项

### 2. 点击行为优化

**问题描述**：
- 点击磅单记录行时直接打开图片查看器
- 用户无法通过点击记录来编辑或查看详细信息

**修复方案**：
1. **记录行点击**：改为打开编辑对话框
   ```typescript
   onClick={() => handleEditRecord(record)}
   ```

2. **图片区域点击**：只有点击图片图标才打开图片查看器
   ```typescript
   <div 
     onClick={(e) => {
       e.stopPropagation();
       handleImageClick(record.image_urls);
     }}
     className="flex items-center gap-2 cursor-pointer hover:bg-muted/50 rounded px-2 py-1 transition-colors"
   >
   ```

**修复效果**：
- 点击记录行：打开编辑对话框
- 点击图片图标：打开图片查看器
- 点击运单号：查看运单详情
- 点击操作按钮：执行相应操作

## 用户体验改进

### 交互逻辑优化
1. **直观的点击行为**：记录行点击编辑，图片点击查看
2. **视觉反馈**：图片区域有悬停效果，明确可点击
3. **事件冒泡控制**：使用 `stopPropagation()` 防止事件冲突

### 数据一致性
1. **车次选择**：编辑时保持原有车次，同时提供其他选项
2. **表单状态**：编辑模式下正确初始化所有字段
3. **数据验证**：保持原有的数据验证逻辑

## 测试建议

### 功能测试
1. **编辑测试**：
   - 打开任意磅单记录的编辑对话框
   - 验证车次字段显示当前记录的车次
   - 验证其他字段正确填充

2. **点击测试**：
   - 点击记录行：应打开编辑对话框
   - 点击图片图标：应打开图片查看器
   - 点击运单号：应打开运单详情
   - 点击操作按钮：应执行相应操作

3. **车次选择测试**：
   - 编辑模式下，车次下拉框应包含当前车次
   - 应包含其他可用的车次选项
   - 新建模式下，应自动选择下一个可用车次

### 边界情况测试
1. **无图片记录**：点击行为应正常
2. **无运单号记录**：运单号区域应显示"未关联"
3. **单张图片记录**：图片查看器应正常工作
4. **多张图片记录**：图片查看器应支持导航

## 技术细节

### 代码修改文件
- `src/pages/ScaleRecords/index.tsx`：修改点击行为
- `src/pages/ScaleRecords/components/ScaleRecordForm.tsx`：修复车次加载逻辑

### 关键修改点
1. **查询优化**：编辑时排除当前记录ID
2. **事件处理**：分离记录点击和图片点击事件
3. **UI反馈**：添加悬停效果和视觉提示

### 兼容性
- 保持原有API接口不变
- 保持原有数据结构不变
- 保持原有权限控制不变
