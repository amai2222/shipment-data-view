# 项目管理合作方选择优化完成说明

## 🎯 优化目标

在项目管理中添加合作链路选择合作方时，优化选择界面：
1. ✅ 按合作方类型多标签分类
2. ✅ 货主类型按树型结构展示（可展开/折叠）

---

## ✨ 新功能特性

### 1. 按类型分类标签
- 🏢 **货主** - 显示为层级树结构
- 👥 **合作商** - 显示为普通列表
- 🏦 **资方** - 显示为普通列表  
- 🏠 **本公司** - 显示为普通列表

每个标签显示对应类型的合作方数量：
```
货主 (15)  合作商 (8)  资方 (3)  本公司 (1)
```

### 2. 货主层级树展示
- ✅ 自动构建层级树结构
- ✅ 点击展开/折叠按钮控制子节点
- ✅ 显示根节点标记
- ✅ 支持"全部展开"/"全部折叠"快捷操作
- ✅ 缩进显示层级关系
- ✅ 选中状态高亮显示

### 3. 普通列表展示（合作商、资方、本公司）
- ✅ 按名称排序
- ✅ 显示税点信息
- ✅ 选中状态高亮
- ✅ 空状态提示

---

## 📦 新增文件

### 组件文件
`src/components/PartnerSelector.tsx` - 合作方选择组件

**功能包括**：
- 按类型分组显示
- 货主层级树构建和渲染
- 展开/折叠控制
- 类型图标和统计
- 搜索和选择交互

---

## 🔧 修改文件

### 1. src/pages/Projects.tsx

#### 修改内容：

**A. 导入新组件**
```typescript
import { PartnerSelector } from "@/components/PartnerSelector";
```

**B. 更新合作方数据查询**
```typescript
// 添加层级相关字段
const { data: partnersData, error: partnersError } = await supabase
  .from('partners')
  .select('id, name, tax_rate, created_at, partner_type, parent_partner_id, hierarchy_path, hierarchy_depth, is_root')
  .order('name', { ascending: true });
```

**C. 替换合作方选择器**
```typescript
// 原来：普通 select
<select value={partner.partnerId} ...>
  <option value="">请选择合作方</option>
  {partners.map(p => (
    <option key={p.id} value={p.id}>
      {p.name} (默认税点: {(p.taxRate * 100).toFixed(2)}%)
    </option>
  ))}
</select>

// 现在：新的 PartnerSelector
<PartnerSelector
  value={partner.partnerId}
  onChange={(value) => updatePartnerInChain(chainIndex, partnerIndex, 'partnerId', value)}
  partners={partners}
  disabled={isSubmitting}
  placeholder="请选择合作方"
  className="w-full text-sm"
/>
```

---

## 📊 界面效果

### 货主树型结构示例
```
货主 (15)
├─ 🏢 中粮集团 (5.20%) [根]
│  ├─ 🏢 中粮北京 (5.20%)
│  │  └─ 🏢 中粮朝阳 (5.20%)
│  └─ 🏢 中粮上海 (5.70%)
├─ 🏢 中粮国际 (9.00%) [根]
└─ 🏢 邯郸集团 (9.00%) [根]
```

### 合作商列表示例
```
合作商 (8)
👥 山西晋丰 (6.00%)
👥 张海亮 (0.00%)
👥 朱晓通 (5.50%)
👥 数创 (6.10%)
```

---

## 🎨 视觉设计

### 1. 类型标签
- **图标**：每种类型有独特图标
  - 货主：Building2 (建筑物)
  - 合作商：Users (多人)
  - 资方：Landmark (地标/银行)
  - 本公司：Home (房子)
- **徽章**：显示每类合作方的数量
- **激活状态**：当前标签背景高亮

### 2. 货主树节点
- **缩进**：每层级缩进 20px
- **展开图标**：
  - ChevronRight ▶ - 折叠状态
  - ChevronDown ▼ - 展开状态
- **根节点标记**：灰色边框的"根"徽章
- **选中状态**：蓝色背景 + 左侧蓝色边框
- **税点信息**：右侧显示税点百分比

### 3. 普通列表项
- **图标**：左侧显示类型图标
- **选中状态**：蓝色背景 + 左侧蓝色边框
- **税点信息**：右侧显示税点百分比

### 4. 交互反馈
- **Hover 效果**：鼠标悬停显示灰色背景
- **点击反馈**：选中项高亮显示
- **滚动区域**：固定高度 300px，支持滚动

---

## 🚀 使用方法

### 1. 添加项目并配置合作链路

1. 进入 **项目管理** 页面
2. 点击 **+ 新建项目** 或编辑现有项目
3. 在"合作链路配置"区域点击 **添加链路**
4. 点击 **添加合作方** 按钮

### 2. 选择合作方

**使用标签页切换**：
- 点击顶部标签切换不同类型
- 每个标签显示对应类型的合作方数量

**选择货主（树型结构）**：
1. 点击 **货主** 标签
2. 使用"全部展开"查看完整层级
3. 点击 ▶/▼ 展开/折叠子节点
4. 点击合作方名称进行选择
5. 选中的合作方会显示蓝色高亮

**选择其他类型（普通列表）**：
1. 点击对应类型标签（合作商/资方/本公司）
2. 浏览列表并点击选择
3. 选中的合作方会显示蓝色高亮

### 3. 查看合作方信息

每个合作方显示：
- **名称**：合作方全称
- **税点**：默认税点百分比
- **根节点标记**：仅货主类型，标记根节点
- **层级关系**：仅货主类型，通过缩进显示

---

## 🔍 技术细节

### 组件接口

```typescript
interface PartnerSelectorProps {
  value: string;              // 选中的合作方 ID
  onChange: (value: string) => void;  // 选择回调
  partners: PartnerOption[];  // 合作方列表
  disabled?: boolean;         // 是否禁用
  placeholder?: string;       // 占位文本
  className?: string;         // 自定义样式
}

interface PartnerOption {
  id: string;
  name: string;
  taxRate: number;
  partnerType?: '货主' | '合作商' | '资方' | '本公司';
  parentPartnerId?: string | null;
  hierarchyPath?: string;
  hierarchyDepth?: number;
  isRoot?: boolean;
}
```

### 层级树构建算法

1. **分组**：按 `partnerType` 分组
2. **映射**：创建 ID → Node 的映射表
3. **构建树**：
   - 遍历所有货主
   - 根据 `parentPartnerId` 建立父子关系
   - 无父节点或父节点不存在的作为根节点
4. **排序**：递归按名称排序所有节点

### 展开/折叠状态管理

```typescript
const [expandedNodes, setExpandedNodes] = useState<Set<string>>(new Set());

// 切换单个节点
const toggleNode = (nodeId: string) => {
  setExpandedNodes(prev => {
    const newSet = new Set(prev);
    if (newSet.has(nodeId)) {
      newSet.delete(nodeId);  // 折叠
    } else {
      newSet.add(nodeId);     // 展开
    }
    return newSet;
  });
};

// 全部展开
const expandAll = () => {
  // 收集所有有子节点的节点 ID
  const allIds = new Set<string>();
  // ... 递归收集
  setExpandedNodes(allIds);
};

// 全部折叠
const collapseAll = () => {
  setExpandedNodes(new Set());
};
```

---

## 📝 注意事项

### 1. 数据要求

合作方数据必须包含以下字段：
- `id` - 必填
- `name` - 必填
- `taxRate` - 必填
- `partnerType` - 可选，默认为"货主"
- `parentPartnerId` - 货主层级必需
- `hierarchyPath` - 货主层级必需
- `hierarchyDepth` - 货主层级必需
- `isRoot` - 货主层级必需

### 2. 性能优化

- ✅ 使用 `useMemo` 缓存分组和树构建结果
- ✅ 只在必要时重新计算
- ✅ 使用 `Set` 管理展开状态（O(1) 查找）

### 3. 兼容性

- ✅ 兼容原有合作方数据（没有层级字段）
- ✅ 自动处理 null/undefined 值
- ✅ 防止循环引用（最大深度100层）

---

## 🎉 用户体验提升

### 优化前 ❌
- 所有合作方混在一起
- 难以找到特定类型
- 货主层级关系不可见
- 长列表难以浏览

### 优化后 ✅
- 按类型清晰分类
- 一目了然的数量统计
- 货主层级结构可视化
- 支持展开/折叠控制
- 更好的视觉层次
- 更快的查找速度

---

## 🐛 已知限制

1. **层级深度限制**：最大100层（实际业务中足够）
2. **大数据量**：超过1000个合作方时可能需要虚拟滚动优化
3. **搜索功能**：当前版本未实现搜索（可后续添加）

---

## 🔮 未来优化方向

1. **搜索功能**：添加合作方名称搜索
2. **收藏功能**：常用合作方快速访问
3. **最近使用**：显示最近选择的合作方
4. **批量选择**：支持多选模式
5. **虚拟滚动**：优化大数据量性能
6. **快捷键**：键盘导航支持

---

## ✅ 测试清单

### 功能测试
- [ ] 按类型正确分组
- [ ] 货主树正确构建
- [ ] 展开/折叠功能正常
- [ ] 全部展开/折叠按钮有效
- [ ] 选择合作方正确回调
- [ ] 选中状态正确显示
- [ ] 税点信息正确显示
- [ ] 根节点标记正确显示

### 边界测试
- [ ] 无合作方时显示空状态
- [ ] 某类型无合作方时显示提示
- [ ] 单个根节点正确显示
- [ ] 多个根节点并列显示
- [ ] 深层嵌套（5层以上）正常显示

### 交互测试
- [ ] 点击切换标签流畅
- [ ] 展开/折叠动画自然
- [ ] Hover 效果正常
- [ ] 滚动区域正常工作
- [ ] 禁用状态正确响应

---

## 📞 技术支持

如遇问题：
1. 检查合作方数据是否完整
2. 查看浏览器控制台错误
3. 确认 `partner_type` 字段值正确
4. 验证层级字段（货主类型）存在

---

## 🎊 完成！

项目管理的合作方选择功能已完全优化，提供了更好的用户体验和更清晰的数据展示！✨

