# 项目合作方自动重算功能说明

## 📅 创建日期
2025-01-22

## 🎯 功能概述

实现了**项目合作链路修改时自动更新运单成本**的功能，解决了修改项目配置后运费对账数据不同步的问题。

---

## ✨ 核心功能

### 1. 自动重算触发器 ⚡（安全模式）

**触发时机**：
- ✅ 添加合作方到项目
- ✅ 修改合作方的税点/利润率
- ✅ 删除项目的合作方
- ✅ 修改合作方的级别

**触发操作**：
- 自动查找使用该链路的所有运单
- **跳过已付款的运单**（保护财务数据）⭐
- 删除未付款运单的旧成本记录
- 根据最新配置重新计算
- 插入新的成本记录

**触发器名称**：`trigger_auto_recalc_partner_costs`

**安全保护**：
- ✅ 已付款运单不会被修改
- ✅ 未付款运单自动更新
- ✅ 保护已完成的财务记录

### 2. 手动重算函数 🔧

#### 函数1：重算单个链路（普通模式）

```sql
SELECT recalculate_costs_for_chain(
    '项目UUID'::UUID,
    '链路UUID'::UUID
);
```

**返回**：更新的运单数量

**适用场景**：只修改了某个特定链路，重算所有运单

#### 函数1.5：安全重算单个链路（推荐）⭐

```sql
-- 安全模式：跳过已付款运单
SELECT recalculate_costs_for_chain_safe(
    '项目UUID'::UUID,
    '链路UUID'::UUID,
    TRUE  -- 只重算未付款的
);
```

**返回**：
```json
{
  "total_records": 100,
  "updated_records": 80,
  "skipped_records": 20,
  "message": "总计 100 条运单，更新 80 条，跳过 20 条（已付款）"
}
```

**适用场景**：修改配置后，只想更新未付款的运单

#### 函数2：重算整个项目

```sql
SELECT recalculate_costs_for_project('项目UUID'::UUID);
```

**返回**：
```json
{
  "project_id": "项目UUID",
  "total_records_updated": 150,
  "message": "成功重算 150 条运单的合作方成本"
}
```

**适用场景**：修改了项目的多个链路

---

## 📊 工作流程

### 自动重算流程

```
用户在项目管理修改合作方
  ↓
保存项目（调用 save_project_with_chains_fixed）
  ↓
更新 project_partners 表
  ↓
触发器 trigger_auto_recalc_partner_costs 被激活
  ↓
调用 recalculate_costs_for_chain 函数
  ↓
FOR 每个使用该链路的运单:
    1. 获取运单的基础金额和重量
    2. 删除旧的 logistics_partner_costs 记录
    3. 查询最新的 project_partners 配置
    4. 重新计算每个合作方的应付金额
    5. 插入新的 logistics_partner_costs 记录
  ↓
完成！运费对账自动显示最新数据 ✅
```

### 重算逻辑

**税点法**：
```
应付金额 = 基础金额 ÷ (1 - 税点)

例如：
  基础金额: 1000元
  税点: 0.10 (10%)
  应付金额 = 1000 ÷ (1 - 0.10) = 1111.11元
```

**利润法**：
```
应付金额 = 基础金额 + (利润率 × 有效重量)

例如：
  基础金额: 1000元
  有效重量: 10吨
  利润率: 50元/吨
  应付金额 = 1000 + (50 × 10) = 1500元
```

---

## 🚀 使用方法

### 方法1：自动触发（默认启用）

**无需任何操作**！

1. 在项目管理中修改合作方
2. 点击保存
3. 系统自动重算所有受影响的运单
4. 运费对账立即显示最新数据

**示例**：
```
项目："中粮集团"（有100条运单，其中20条已付款）
原配置：合作方A（税点 5%）
修改为：合作方B（税点 6%）
  ↓
保存后自动执行：
  - 查找所有"中粮集团"的运单
  - 跳过已付款的20条运单 ✅（保护财务数据）
  - 删除未付款80条运单的合作方A成本记录
  - 重新计算合作方B的成本
  - 运费对账：
    · 80条未付款运单 → 显示合作方B（新）
    · 20条已付款运单 → 显示合作方A（旧，保持不变）
```

### 方法2：手动重算（可选）

**适用场景**：
- 需要重算历史数据
- 批量修复数据问题
- 验证计算结果

**操作步骤**：

#### 重算单个链路
```sql
-- 在 Supabase SQL Editor 中执行
SELECT recalculate_costs_for_chain(
    '645517d8-0afe-4dfe-b607-2655435734b9'::UUID,  -- 项目ID
    'chain-uuid'::UUID                              -- 链路ID
);

-- 返回：更新了 50 条运单
```

#### 重算整个项目
```sql
SELECT recalculate_costs_for_project(
    '645517d8-0afe-4dfe-b607-2655435734b9'::UUID
);

-- 返回：
{
  "project_id": "...",
  "total_records_updated": 150,
  "message": "成功重算 150 条运单的合作方成本"
}
```

---

## ⚙️ 触发器配置

### 触发器详情

```sql
-- 触发器名称
trigger_auto_recalc_partner_costs

-- 监控表
project_partners

-- 触发条件
AFTER INSERT OR UPDATE OR DELETE

-- 执行函数
auto_recalc_on_project_partner_change()
```

### 监控的字段

触发器会在以下字段变化时触发：
- `partner_id` - 合作方ID变化
- `level` - 级别变化
- `tax_rate` - 税点变化
- `calculation_method` - 计算方法变化
- `profit_rate` - 利润率变化

### 不触发的情况

- 只修改项目基础信息（名称、日期等）
- 只修改链路名称
- 不涉及 project_partners 表的操作

---

## ⚠️ 注意事项

### 1. 性能影响

**小规模项目**（<100条运单）：
- ✅ 几乎无感知
- ✅ 毫秒级完成

**大规模项目**（>1000条运单）：
- ⚠️ 可能需要几秒到几十秒
- ⚠️ 建议在非业务高峰期修改

### 2. 数据覆盖（安全模式）⭐

**会覆盖的数据**：
- ⚠️ 未付款运单的 logistics_partner_costs 记录
- ⚠️ 未付款运单手动调整过的应付金额

**不会覆盖的数据**：
- ✅ 已付款运单的成本记录（受保护）⭐
- ✅ logistics_records 表（运单基础信息）
- ✅ 已生成的付款/开票申请
- ✅ 运单编号和历史记录

### 3. 已付款运单的处理

**默认行为**（安全模式）：
- ✅ 已付款运单：**跳过，保持不变**
- ✅ 未付款运单：自动更新

**如需强制更新已付款运单**：
```sql
-- 使用普通模式
SELECT recalculate_costs_for_chain(
    '项目UUID'::UUID,
    '链路UUID'::UUID
);

-- 或使用安全函数的强制模式
SELECT recalculate_costs_for_chain_safe(
    '项目UUID'::UUID,
    '链路UUID'::UUID,
    FALSE  -- 不跳过已付款
);
```

### 4. 触发器的启用/禁用

如果需要临时禁用自动重算：

```sql
-- 禁用触发器
ALTER TABLE project_partners DISABLE TRIGGER trigger_auto_recalc_partner_costs;

-- 修改项目配置...

-- 启用触发器
ALTER TABLE project_partners ENABLE TRIGGER trigger_auto_recalc_partner_costs;

-- 手动重算
SELECT recalculate_costs_for_project('项目UUID');
```

---

## 🧪 测试验证

### 测试场景1：修改合作方

**操作步骤**：
1. 选择一个有运单的项目
2. 修改合作方的税点（例如：5% → 6%）
3. 保存
4. 查看运费对账

**预期结果**：
```sql
-- 查询运单的合作方成本
SELECT 
    lr.auto_number,
    p.name as partner_name,
    lpc.tax_rate,
    lpc.base_amount,
    lpc.payable_amount
FROM logistics_partner_costs lpc
JOIN logistics_records lr ON lpc.logistics_record_id = lr.id
JOIN partners p ON lpc.partner_id = p.id
WHERE lr.project_id = '项目UUID'
ORDER BY lr.auto_number, lpc.level;

-- 应该显示新的税点和重算后的应付金额
```

### 测试场景2：更换合作方

**操作步骤**：
1. 选择一个项目
2. 将合作方A替换为合作方B
3. 保存
4. 检查运费对账

**预期结果**：
- ✅ 所有运单显示合作方B（不是合作方A）
- ✅ 应付金额按合作方B的配置计算

### 验证SQL

```sql
-- 1. 修改前记录当前数据
CREATE TEMP TABLE before_change AS
SELECT 
    lr.id as record_id,
    lr.auto_number,
    lpc.partner_id,
    p.name as partner_name,
    lpc.payable_amount
FROM logistics_records lr
JOIN logistics_partner_costs lpc ON lr.id = lpc.logistics_record_id
JOIN partners p ON lpc.partner_id = p.id
WHERE lr.project_id = '项目UUID';

-- 2. 修改项目配置...

-- 3. 修改后对比数据
SELECT 
    b.auto_number as "运单编号",
    b.partner_name as "修改前合作方",
    a.partner_name as "修改后合作方",
    b.payable_amount as "修改前金额",
    a.payable_amount as "修改后金额",
    CASE 
        WHEN b.partner_id != a.partner_id THEN '✓ 合作方已更新'
        WHEN b.payable_amount != a.payable_amount THEN '✓ 金额已重算'
        ELSE '= 无变化'
    END as "变化状态"
FROM before_change b
JOIN (
    SELECT 
        lr.id as record_id,
        lr.auto_number,
        lpc.partner_id,
        p.name as partner_name,
        lpc.payable_amount
    FROM logistics_records lr
    JOIN logistics_partner_costs lpc ON lr.id = lpc.logistics_record_id
    JOIN partners p ON lpc.partner_id = p.id
    WHERE lr.project_id = '项目UUID'
) a ON b.record_id = a.record_id;
```

---

## 📈 性能监控

### 监控重算进度

```sql
-- 查看触发器执行日志（PostgreSQL 日志）
-- 会显示类似：
-- NOTICE: 已更新合作方配置，重算链路 xxx 的运单成本
-- NOTICE: 链路 xxx 重算完成，更新 50 条运单
```

### 统计影响范围

```sql
-- 查询某个项目有多少运单
SELECT 
    pc.chain_name as "链路",
    COUNT(lr.id) as "运单数量"
FROM logistics_records lr
LEFT JOIN partner_chains pc ON lr.chain_id = pc.id
WHERE lr.project_id = '项目UUID'
GROUP BY pc.chain_name;
```

---

## 🔄 对比：修改前 vs 修改后

### 修改前 ❌

```
1. 修改项目合作方配置
   ↓
2. 保存成功
   ↓
3. 运费对账仍显示旧的合作方 ❌
   ↓
4. 需要手动到运费对账页面批量重算 😓
```

### 修改后 ✅

```
1. 修改项目合作方配置
   ↓
2. 保存成功
   ↓
3. 触发器自动重算受影响的运单 ⚡
   ↓
4. 运费对账自动显示最新数据 ✅
```

---

## 🎯 使用示例

### 场景1：更换合作方

**需求**：将"中粮集团"项目的合作方从"A公司"改为"B公司"

**操作**：
1. 打开项目管理
2. 编辑"中粮集团"项目
3. 在合作链路中，将"A公司"改为"B公司"
4. 保存

**自动执行**：
```
触发器检测到 project_partners 变化
  ↓
查找所有"中粮集团"使用该链路的运单
  ↓
假设有 50 条运单
  ↓
FOR 每条运单:
  - 删除"A公司"的成本记录
  - 重新计算"B公司"的应付金额
  - 插入"B公司"的成本记录
  ↓
完成！50 条运单的成本已更新
```

**验证**：
- 打开运费对账页面
- 筛选"中粮集团"项目
- 确认所有运单都显示"B公司"

### 场景2：调整税点

**需求**：将某个合作方的税点从 5% 调整为 6%

**操作**：
1. 打开项目管理
2. 编辑项目
3. 修改合作方的税点
4. 保存

**自动执行**：
```
触发器检测到税点变化
  ↓
自动重算所有运单
  ↓
应付金额按新税点计算
  ↓
运费对账自动更新
```

---

## ⚙️ 高级配置

### 临时禁用自动重算

**适用场景**：
- 大批量修改项目配置
- 避免频繁触发重算
- 想集中处理

**操作步骤**：

```sql
-- 1. 禁用触发器
ALTER TABLE project_partners 
DISABLE TRIGGER trigger_auto_recalc_partner_costs;

-- 2. 修改多个项目的配置...

-- 3. 启用触发器
ALTER TABLE project_partners 
ENABLE TRIGGER trigger_auto_recalc_partner_costs;

-- 4. 手动批量重算（可选）
SELECT recalculate_costs_for_project('项目UUID1');
SELECT recalculate_costs_for_project('项目UUID2');
```

### 只重算未付款的运单（安全模式）

**使用安全重算函数**：

```sql
-- 安全模式：跳过已付款的运单
SELECT recalculate_costs_for_chain_safe(
    '项目UUID'::UUID,
    '链路UUID'::UUID,
    TRUE  -- 只重算未付款的
);

-- 返回：
{
  "total_records": 100,
  "updated_records": 80,
  "skipped_records": 20,
  "message": "总计 100 条运单，更新 80 条，跳过 20 条（已付款）"
}
```

**强制重算所有运单**（包括已付款）：

```sql
SELECT recalculate_costs_for_chain_safe(
    '项目UUID'::UUID,
    '链路UUID'::UUID,
    FALSE  -- 重算所有运单
);
```

---

## 🔍 监控和日志

### 查看触发器执行情况

触发器执行时会在 PostgreSQL 日志中记录：

```
NOTICE: 已更新合作方配置，重算链路 abc-123 的运单成本
NOTICE: 链路 abc-123 重算完成，更新 50 条运单
```

### 验证重算结果

```sql
-- 查看最近更新的成本记录
SELECT 
    lr.auto_number as "运单编号",
    p.name as "合作方",
    lpc.level as "级别",
    lpc.payable_amount as "应付金额",
    lpc.created_at as "创建时间"
FROM logistics_partner_costs lpc
JOIN logistics_records lr ON lpc.logistics_record_id = lr.id
JOIN partners p ON lpc.partner_id = p.id
WHERE lr.project_id = '项目UUID'
ORDER BY lpc.created_at DESC
LIMIT 20;

-- 最近创建的记录就是刚刚重算的
```

---

## 📊 性能影响

### 估算重算时间

| 运单数量 | 预计时间 | 建议 |
|---------|---------|------|
| <50 | <1秒 | ✅ 可以实时重算 |
| 50-200 | 1-3秒 | ✅ 可以接受 |
| 200-500 | 3-10秒 | ⚠️ 用户可能感知 |
| 500-1000 | 10-30秒 | ⚠️ 建议异步处理 |
| >1000 | >30秒 | ❌ 建议禁用自动重算 |

### 优化建议

**对于大规模项目**：

1. **禁用自动触发器**
2. **使用批量重算**（在运费对账页面）
3. **或在非业务时间手动执行SQL**

---

## ✅ 执行迁移

### 安装自动重算功能

```bash
# 使用 Supabase CLI
supabase db push

# 或在 Supabase Dashboard SQL Editor 中执行
# supabase/migrations/20250122_auto_recalc_on_project_partner_change.sql
```

### 验证安装

```sql
-- 检查触发器是否创建
SELECT 
    trigger_name,
    event_manipulation,
    event_object_table
FROM information_schema.triggers
WHERE trigger_name = 'trigger_auto_recalc_partner_costs';

-- 检查函数是否创建
SELECT routine_name
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_name IN (
      'recalculate_costs_for_chain',
      'recalculate_costs_for_project',
      'auto_recalc_on_project_partner_change'
  );
```

---

## 📝 相关文档

- [项目合作方修改后如何更新运费对账数据.md](./项目合作方修改后如何更新运费对账数据.md)
- [运单修改是否自动重算合作方成本_问题分析.md](./运单修改是否自动重算合作方成本_问题分析.md)
- [运单运费计算逻辑说明.md](./docs/运单运费计算逻辑说明.md)

---

## ✅ 功能总结

本次更新实现了：

1. ✅ **自动重算触发器** - 修改项目配置时自动更新运单成本
2. ✅ **手动重算函数** - 支持按链路或项目批量重算
3. ✅ **智能更新** - 只重算受影响的运单
4. ✅ **完整日志** - 记录重算过程和结果

**效果**：
- ✅ 修改项目配置后，运费对账立即显示最新数据
- ✅ 无需手动批量重算
- ✅ 数据始终保持同步

**状态**: ✅ 开发完成，执行迁移即可使用！

---

**创建时间**: 2025-01-22
**版本**: v1.0
**迁移文件**: `supabase/migrations/20250122_auto_recalc_on_project_partner_change.sql`

