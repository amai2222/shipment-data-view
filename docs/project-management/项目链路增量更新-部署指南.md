# 项目链路增量更新 - 部署指南 🚀

## 📋 部署清单

### ✅ 必须执行

1. **数据库脚本**（优先）
2. **前端代码**（其次）

### ⏰ 预计部署时间

- 数据库脚本：2 分钟
- 前端代码：5 分钟
- **总计**：约 7 分钟

---

## 🎯 第1步：执行数据库脚本（必须先执行）

### 方式1：Supabase Dashboard（推荐）⭐

1. **登录 Supabase Dashboard**
   - 访问：https://supabase.com/dashboard
   - 选择你的项目

2. **打开 SQL Editor**
   - 点击左侧菜单"SQL Editor"
   - 点击"New query"

3. **执行增量更新函数**
   - 打开文件：`supabase/migrations/20251025_create_incremental_update_function.sql`
   - 复制全部内容
   - 粘贴到编辑器
   - 点击 **Run** 执行

4. **验证执行成功**
   
   应该看到：
   ```
   ========================================
   项目链路增量更新函数创建完成
   ========================================
   
   函数名称：
     update_project_chains_incremental
   
   优点：
     ✓ 减少不必要的数据库操作
     ✓ 只触发必要的重算
     ✓ 保持未修改数据的时间戳
     ✓ 提升系统性能
   ```

5. **（可选）执行触发器优化**
   - 打开文件：`修复触发器避免不必要重算.sql`
   - 复制并执行
   - 进一步优化性能

---

## 🎯 第2步：部署前端代码

### 检查修改的文件

```bash
git status
```

应该显示：
```
modified:   src/pages/Partners.tsx
modified:   src/pages/mobile/MobilePartners.tsx
modified:   src/pages/Projects.tsx
modified:   src/pages/PaymentRequest.tsx
```

### 提交代码

```bash
# 添加所有修改的文件
git add src/pages/Partners.tsx
git add src/pages/mobile/MobilePartners.tsx
git add src/pages/Projects.tsx
git add src/pages/PaymentRequest.tsx

# 提交
git commit -m "优化项目管理和付款申请功能

- 修复合作方添加后不即时显示问题
- 修复合作链路is_default状态被重置问题
- 实现项目链路增量更新（只更新变更的链路）
- 优化付款申请页面合作方列显示（默认仅显示最高级）
- 添加跨页面React Query缓存同步"

# 推送到远程仓库
git push
```

### 部署到生产环境

根据你的部署方式：

**方式A：自动部署（Vercel/Netlify）**
```bash
git push  # 自动触发部署
```

**方式B：手动部署**
```bash
npm run build
# 然后上传 dist 目录到服务器
```

---

## 🧪 第3步：验证部署

### 3.1 验证数据库函数

在 Supabase SQL Editor 执行：

```sql
-- 检查函数是否存在
SELECT 
    proname as function_name,
    pg_get_functiondef(oid) as definition
FROM pg_proc 
WHERE proname = 'update_project_chains_incremental';
```

**预期**：返回函数定义

### 3.2 验证前端功能

#### 测试1：合作方即时显示

1. 进入"合作方管理"
2. 添加一个新合作方
3. 立即切换到"项目管理"
4. ✅ **验证**：新合作方立即出现在下拉列表中

#### 测试2：增量更新

1. 编辑一个有多个链路的项目
2. 只在链路2添加一个合作方
3. 点击保存
4. ✅ **验证**：Toast 提示"已更新 1 条链路"
5. ✅ **验证**：链路1和3不受影响

#### 测试3：付款申请页面

1. 打开付款申请页面
2. ✅ **验证**：默认只显示最高级合作方列
3. 点击"展示全部级别"
4. ✅ **验证**：显示所有层级的合作方

---

## ⚠️ 回滚方案（如果需要）

### 回滚前端代码

```bash
# 查看提交历史
git log --oneline -5

# 回滚到上一个提交
git revert HEAD

# 或者硬回滚（慎用）
git reset --hard HEAD~1
git push --force
```

### 回滚数据库函数

在 Supabase SQL Editor 执行：

```sql
-- 删除新函数
DROP FUNCTION IF EXISTS public.update_project_chains_incremental;
```

**注意**：
- 删除函数后，编辑项目会报错
- 需要同时回滚前端代码
- 或者前端回退到使用旧的 `save_project_with_chains_fixed`

---

## 📊 部署检查清单

### 部署前

- [ ] 代码已通过 Linter 检查
- [ ] 本地测试通过
- [ ] 已备份数据库（如果是生产环境）
- [ ] 已通知相关用户（如果需要）

### 部署中

- [ ] 先执行数据库脚本
- [ ] 验证数据库脚本成功
- [ ] 再部署前端代码
- [ ] 验证前端部署成功

### 部署后

- [ ] 执行功能测试
- [ ] 检查浏览器控制台无错误
- [ ] 检查数据库日志
- [ ] 监控用户反馈

---

## 🎓 技术说明

### 为什么要先部署数据库？

1. **向后兼容**：新函数不会影响旧代码
2. **前端依赖**：前端代码依赖新函数
3. **安全性**：数据库脚本执行失败时，前端仍能使用旧逻辑

### 部署顺序

```
步骤1：执行数据库脚本
  ↓ 新函数创建完成，但还没被调用
步骤2：部署前端代码
  ↓ 前端开始调用新函数
完成：增量更新功能生效
```

### 如果顺序反了？

```
步骤1：部署前端代码（错误）
  ↓ 前端调用不存在的函数
  ↓ 报错：function update_project_chains_incremental does not exist
  ↓ 用户无法编辑项目 ❌

步骤2：执行数据库脚本
  ↓ 函数创建
  ↓ 功能恢复
```

---

## 🚀 一键部署脚本（可选）

### PowerShell 脚本

创建 `deploy-incremental-update.ps1`：

```powershell
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "项目链路增量更新功能部署" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# 第1步：提示执行数据库脚本
Write-Host "第1步：执行数据库脚本" -ForegroundColor Yellow
Write-Host "请在 Supabase Dashboard 执行以下脚本：" -ForegroundColor White
Write-Host "  supabase/migrations/20251025_create_incremental_update_function.sql" -ForegroundColor Green
Write-Host ""
$confirm = Read-Host "已完成数据库脚本执行？(输入 'y' 继续)"

if ($confirm -ne 'y') {
    Write-Host "❌ 部署已取消" -ForegroundColor Red
    exit
}

# 第2步：提交并推送代码
Write-Host ""
Write-Host "第2步：部署前端代码" -ForegroundColor Yellow

git add src/pages/Partners.tsx
git add src/pages/mobile/MobilePartners.tsx
git add src/pages/Projects.tsx
git add src/pages/PaymentRequest.tsx

git commit -m "优化项目管理和付款申请功能

- 修复合作方添加后不即时显示问题
- 修复合作链路is_default状态被重置问题
- 实现项目链路增量更新（只更新变更的链路）
- 优化付款申请页面合作方列显示（默认仅显示最高级）
- 添加跨页面React Query缓存同步"

git push

Write-Host ""
Write-Host "========================================" -ForegroundColor Green
Write-Host "✓ 部署完成！" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Green
Write-Host ""
Write-Host "下一步：" -ForegroundColor Yellow
Write-Host "  1. 等待前端自动部署完成" -ForegroundColor White
Write-Host "  2. 刷新浏览器测试功能" -ForegroundColor White
Write-Host "  3. 检查是否有错误" -ForegroundColor White
Write-Host ""
```

---

## 📞 遇到问题？

### 常见问题

**Q1：前端报错 "function update_project_chains_incremental does not exist"**

A：数据库脚本还没执行或执行失败。先执行数据库脚本。

**Q2：编辑项目时没有变更提示**

A：检查浏览器控制台是否有 JavaScript 错误。

**Q3：仍然触发了所有链路的重算**

A：执行 `修复触发器避免不必要重算.sql` 优化触发器逻辑。

### 获取帮助

1. 检查浏览器控制台错误
2. 检查 Supabase 日志
3. 查看详细文档：`项目链路增量更新功能完成.md`

---

**准备好了吗？按照步骤执行部署吧！** 🚀

