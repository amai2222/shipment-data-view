# 项目合作方修改后如何更新运费对账数据

## 📅 创建日期
2025-01-22

## ❓ 问题说明

**问题**：在项目管理中修改了合作链路的合作方，但运费对账里的数据还显示原来的合作商。

**原因**：运单的合作方成本信息是在创建运单时生成并保存的，修改项目配置不会自动更新已有运单的成本记录。

---

## 📊 数据流程说明

### 1. 项目配置（合作链路）

```
项目管理页面 (/projects)
  ↓ 创建/编辑项目
保存到数据库：
  - partner_chains 表（合作链路）
  - project_partners 表（合作方配置）
```

**这些是配置数据**，用于后续创建运单时参考。

### 2. 运单创建

```
运单管理页面 (/business-entry)
  ↓ 创建运单
根据 chain_id 查询 project_partners
  ↓ 计算每个合作方的应付金额
保存到数据库：
  - logistics_records 表（运单基础信息）
  - logistics_partner_costs 表（每个合作方的成本）
```

**合作方成本数据在此时固化**，不会自动更新。

### 3. 运费对账查询

```
运费对账页面 (/finance/reconciliation)
  ↓ 查询运费数据
直接查询 logistics_partner_costs 表
  ↓ 显示数据
显示创建运单时的合作方信息
```

**显示的是历史数据**，不是最新的项目配置。

---

## ✅ 解决方案

### 方法1：批量重新计算（推荐）

#### 步骤：

1. **打开运费对账页面**
   - 访问：`/finance/reconciliation`

2. **筛选需要更新的运单**
   - 选择项目
   - 选择日期范围
   - 选择合作方（可选）

3. **选择运单**
   
   **方式A：全选当前筛选**
   ```
   勾选表头的"全选"复选框
     ↓
   点击"全选当前筛选的所有运单"
   ```
   
   **方式B：选择特定运单**
   ```
   逐个勾选需要重算的运单
   ```

4. **批量重新计算**
   ```
   点击"批量重新计算"按钮
     ↓
   确认对话框：
   "您确定要为选中的 X 条运单重新计算所有合作方的应付金额吗？
    此操作会根据最新的项目合作链路配置覆盖现有数据。"
     ↓
   点击"确认"
     ↓
   系统自动：
   1. 删除旧的 logistics_partner_costs 记录
   2. 根据最新的 project_partners 配置
   3. 重新计算并生成新的 logistics_partner_costs 记录
     ↓
   完成！数据已更新
   ```

5. **验证结果**
   - 刷新页面
   - 检查合作方是否已更新为最新的

---

### 方法2：删除并重新创建运单（不推荐）

**缺点**：
- ❌ 会丢失运单编号
- ❌ 会丢失关联的付款/开票记录
- ❌ 操作繁琐

**不推荐使用此方法**

---

## 🔍 技术原理

### 批量重新计算的工作原理

**使用的数据库函数**：

1. **`batch_recalculate_partner_costs(p_record_ids)`**
   - 输入：运单ID数组
   - 功能：重新计算指定运单的合作方成本
   
2. **`batch_recalculate_by_filter(...)`**
   - 输入：筛选条件（项目、日期、合作方）
   - 功能：重新计算符合条件的所有运单

**执行步骤**：

```sql
-- 伪代码
FOR EACH 运单 IN 选中的运单列表
  -- 1. 删除旧的成本记录
  DELETE FROM logistics_partner_costs 
  WHERE logistics_record_id = 运单ID;
  
  -- 2. 根据 chain_id 查询最新的合作方配置
  SELECT * FROM project_partners 
  WHERE project_id = 运单.project_id 
    AND chain_id = 运单.chain_id;
  
  -- 3. 重新计算每个合作方的应付金额
  FOR EACH 合作方 IN 合作方列表
    计算应付金额（根据税点或利润率）
  END FOR;
  
  -- 4. 保存新的成本记录
  INSERT INTO logistics_partner_costs (...);
END FOR;
```

---

## 📋 操作示例

### 场景：修改了"中粮集团"项目的合作方

**操作前**：
```
项目配置：
  合作方 A（旧）
    ↓
修改为：
  合作方 B（新）

已有运单 100 条（仍显示合作方 A）❌
```

**操作步骤**：

1. **打开运费对账**
   - URL: `/finance/reconciliation`

2. **筛选运单**
   ```
   项目：中粮集团
   日期：2025-01-01 ~ 2025-01-31
   ```

3. **全选运单**
   - 勾选表头复选框
   - 点击"全选当前筛选的所有运单"

4. **批量重新计算**
   - 点击"批量重新计算"按钮
   - 确认操作

5. **等待完成**
   ```
   提示：已为 100 条运单提交重算任务。
   ```

6. **刷新验证**
   - 刷新页面
   - 确认合作方已更新为"合作方 B"

**操作后**：
```
所有运单的合作方成本已更新 ✅
运费对账显示最新的合作方 B
```

---

## ⚠️ 注意事项

### 1. 数据覆盖

批量重新计算会**覆盖现有的成本数据**：
- ⚠️ 如果之前手动调整过某些运单的应付金额，会被覆盖
- ⚠️ 重算基于最新的项目配置（税点、利润率等）
- ⚠️ 操作不可撤销

**建议**：
- 在非业务高峰期操作
- 操作前通知相关人员
- 必要时先导出数据备份

### 2. 运单状态检查

**重新计算的条件**：
- ✅ 运单仍然关联到该项目
- ✅ 运单的 `chain_id` 仍然有效
- ⚠️ 如果运单已经生成付款/开票申请，需要谨慎操作

### 3. 批量操作限制

- 建议分批处理（每次不超过500条）
- 大量运单可能需要较长时间
- 操作期间页面会显示加载状态

---

## 🎯 最佳实践

### 修改项目配置的推荐流程

1. **修改前检查**
   ```sql
   -- 查询该项目有多少运单
   SELECT COUNT(*) 
   FROM logistics_records 
   WHERE project_id = '项目UUID';
   ```

2. **修改项目配置**
   - 在项目管理页面修改合作链路
   - 保存

3. **立即更新已有运单**
   - 打开运费对账页面
   - 筛选该项目的运单
   - 批量重新计算

4. **验证结果**
   - 检查几条运单的合作方是否正确
   - 检查应付金额是否合理

### 新建项目的建议

1. **先配置好合作链路**
2. **测试：创建1-2条测试运单**
3. **验证：检查运费对账数据是否正确**
4. **确认无误后再批量创建运单**

---

## 🔍 验证方法

### SQL 查询验证

```sql
-- 查看某个运单的合作方成本记录
SELECT 
    lr.auto_number as "运单编号",
    lr.project_name as "项目",
    p.name as "合作方",
    lpc.level as "级别",
    lpc.base_amount as "基础金额",
    lpc.payable_amount as "应付金额",
    lpc.tax_rate as "税率"
FROM logistics_partner_costs lpc
JOIN logistics_records lr ON lpc.logistics_record_id = lr.id
JOIN partners p ON lpc.partner_id = p.id
WHERE lr.auto_number = '运单编号'
ORDER BY lpc.level;

-- 对比项目的当前配置
SELECT 
    p.name as "合作方",
    pp.level as "级别",
    pp.tax_rate as "税率",
    pp.calculation_method as "计算方法"
FROM project_partners pp
JOIN partners p ON pp.partner_id = p.id
WHERE pp.project_id = '项目UUID'
  AND pp.chain_id = '链路UUID'
ORDER BY pp.level;
```

---

## 📚 相关文档

- [运单运费计算逻辑说明.md](./docs/运单运费计算逻辑说明.md)
- [数据库结构完整记录.md](./docs/数据库结构完整记录.md)

---

## ❓ 常见问题

### Q1: 修改项目配置后，新建的运单会用新配置吗？

A: ✅ 会的。新建运单会自动使用最新的项目配置。

### Q2: 批量重新计算会影响已完成的付款吗？

A: ⚠️ 会影响。建议只对未付款的运单进行重算。

### Q3: 能否自动更新？

A: ❌ 目前不支持。这是为了保护历史数据完整性。如果需要自动更新，可以：
- 添加触发器（不推荐）
- 定期批量重算（需谨慎）

### Q4: 重算会很慢吗？

A: 取决于运单数量：
- 100条以内：几秒
- 1000条：几十秒
- 10000条：可能需要几分钟

---

## ✅ 总结

**问题**：修改项目配置后，运费对账显示旧的合作方

**根本原因**：运单的合作方成本在创建时固化，不会自动更新

**解决方法**：在运费对账页面使用"批量重新计算"功能

**操作路径**：
```
运费对账页面 → 筛选运单 → 勾选 → 批量重新计算 → 完成
```

**效果**：
- ✅ 合作方成本按最新配置重新计算
- ✅ 运费对账显示最新的合作方
- ✅ 应付金额按最新规则计算

---

**更新时间**: 2025-01-22
**文档版本**: v1.0

