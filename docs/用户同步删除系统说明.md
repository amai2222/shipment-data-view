# 用户同步删除系统 - 完整说明

## 📋 目录

1. [问题背景](#问题背景)
2. [架构说明](#架构说明)
3. [解决方案](#解决方案)
4. [使用指南](#使用指南)
5. [部署步骤](#部署步骤)
6. [常见问题](#常见问题)

---

## 问题背景

### 🔍 现象

当您尝试注册用户时，遇到错误：

```
AuthApiError: A user with this email address has already been registered
```

但是在用户管理界面（`profiles` 表）中却找不到这个用户。

### 🤔 原因

Supabase 有两个独立的用户表：

| 表名 | 作用 | 位置 | 可见性 |
|------|------|------|--------|
| **auth.users** | 认证系统表 | Supabase Auth 系统 | ❌ 您在界面看不到 |
| **public.profiles** | 业务信息表 | 您的数据库 | ✅ 您在界面可以看到 |

**问题所在**：
- 有些代码只删除了 `profiles` 表
- 没有删除 `auth.users` 表
- 导致两个表不同步

---

## 架构说明

### 🏗️ 正常流程

```
创建用户:
┌─────────────┐
│ 1. 创建     │
│ auth.users  │  ←── Supabase Auth
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 2. 创建     │
│ profiles    │  ←── 您的业务表
└─────────────┘
```

```
删除用户（正确）:
┌─────────────┐
│ 1. 删除     │
│ profiles    │  ←── 先删除业务表
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 2. 删除     │
│ auth.users  │  ←── 再删除认证表
└─────────────┘
```

### ❌ 错误流程（导致不同步）

```
删除用户（错误）:
┌─────────────┐
│ 1. 删除     │
│ profiles    │  ←── 只删除了这个
└─────────────┘
       
┌─────────────┐
│ auth.users  │  ←── ❌ 没有删除，成为孤立记录
└─────────────┘
```

---

## 解决方案

### 📦 已实现的功能

1. **修复前端删除代码** ✅
   - 统一使用 Edge Function 删除用户
   - 确保同时删除两个表

2. **数据库触发器** ✅
   - 当删除 `profiles` 时自动清理 `auth.users`
   - 防止将来再次出现不同步

3. **清理工具界面** ✅
   - 查看所有孤立用户
   - 一键清理孤立用户

4. **RPC 函数** ✅
   - `cleanup_orphaned_auth_users()` - 查询孤立用户
   - `delete_auth_user_by_email()` - 删除孤立用户

---

## 使用指南

### 方法 1: 使用前端界面（推荐） 🌟

1. **打开用户管理页面**
   ```
   系统设置 → 用户管理
   ```

2. **查看孤立用户清理工具**
   - 页面会自动显示所有孤立用户
   - 显示：邮箱、用户ID、创建时间

3. **清理孤立用户**
   - 点击 "清理" 按钮
   - 确认删除
   - 完成！

### 方法 2: 使用 SQL 查询

#### 查看孤立用户

```sql
-- 在 Supabase SQL Editor 中执行
SELECT * FROM public.cleanup_orphaned_auth_users();
```

#### 删除指定邮箱的孤立用户

```sql
-- 替换成实际邮箱
SELECT public.delete_auth_user_by_email('user@example.com');
```

### 方法 3: 使用前端代码

```typescript
// 查询孤立用户
const { data, error } = await supabase.rpc('cleanup_orphaned_auth_users');

console.log('孤立用户列表:', data);

// 删除孤立用户
const { data: result, error: deleteError } = await supabase.rpc('delete_auth_user_by_email', {
  p_email: 'user@example.com'
});

if (result?.success) {
  console.log('删除成功:', result.message);
}
```

---

## 部署步骤

### 1️⃣ 部署数据库迁移

```bash
# 在项目根目录执行
cd supabase

# 应用迁移
supabase db push
```

**或者手动执行 SQL:**

在 Supabase Dashboard → SQL Editor 中执行：

```
supabase/migrations/20251101_auto_sync_user_deletion.sql
```

### 2️⃣ 部署 Edge Function

```bash
# 部署 delete-user 函数
supabase functions deploy delete-user
```

### 3️⃣ 配置环境变量（可选）

如果要启用自动触发器清理，需要在 Supabase Dashboard 中配置：

```sql
-- 在 SQL Editor 中执行
ALTER DATABASE postgres SET app.settings.supabase_url = 'https://你的项目.supabase.co';
ALTER DATABASE postgres SET app.settings.service_role_key = '你的service_role_key';
```

⚠️ **注意**：`service_role_key` 是敏感信息，不要泄露！

### 4️⃣ 验证部署

1. **测试查询孤立用户**
   ```sql
   SELECT * FROM public.cleanup_orphaned_auth_users();
   ```

2. **测试前端界面**
   - 打开用户管理页面
   - 查看是否显示孤立用户清理工具

---

## 常见问题

### Q1: 为什么会出现孤立用户？

**A:** 有以下几种情况：

1. **代码错误**
   - 旧代码只删除 `profiles`，没删除 `auth.users`
   
2. **注册失败**
   - `auth.users` 创建成功
   - `profiles` 创建失败
   - 导致只有半个用户

3. **手动操作**
   - 在数据库中手动删除 `profiles`
   - 没有删除 `auth.users`

### Q2: 孤立用户有什么影响？

**A:** 

- ❌ 该邮箱无法重新注册（auth.users 认为已存在）
- ❌ 无法登录（profiles 不存在）
- ❌ 浪费数据库存储空间
- ❌ 可能导致权限检查错误

### Q3: 删除孤立用户安全吗？

**A:** 是的，非常安全！

- ✅ 只删除认证记录，不影响业务数据
- ✅ 有权限检查（只有管理员可以删除）
- ✅ 不会误删正常用户（会检查 profiles 是否存在）
- ✅ 可以重新注册该邮箱

### Q4: 如何防止将来再次出现？

**A:** 已经实现了以下保护措施：

1. **修复前端代码**
   - 统一使用 Edge Function 删除
   
2. **数据库触发器**（可选）
   - 自动清理 auth.users
   
3. **定期检查**
   - 使用清理工具定期查看

### Q5: 触发器不工作怎么办？

**A:** 

1. **检查 pg_net 扩展**
   ```sql
   CREATE EXTENSION IF NOT EXISTS pg_net;
   ```

2. **检查环境变量**
   ```sql
   SELECT current_setting('app.settings.supabase_url', true);
   SELECT current_setting('app.settings.service_role_key', true);
   ```

3. **手动清理**
   - 使用前端界面清理工具
   - 或使用 SQL 函数

### Q6: 能否批量清理所有孤立用户？

**A:** 可以！使用 SQL：

```sql
-- ⚠️ 危险操作！请先确认
DO $$
DECLARE
    orphaned_user RECORD;
BEGIN
    FOR orphaned_user IN 
        SELECT * FROM public.cleanup_orphaned_auth_users()
    LOOP
        PERFORM public.delete_auth_user_by_email(orphaned_user.email);
    END LOOP;
END $$;
```

---

## 📊 系统流程图

```
用户删除流程（新）
════════════════════

前端点击删除
     │
     ▼
Edge Function: delete-user
     │
     ├─→ 1. 删除 profiles (fromTrigger=false)
     │      │
     │      ▼
     │   触发器: auto_cleanup_auth_user_trigger
     │      │
     │      └─→ 调用 Edge Function (fromTrigger=true)
     │             │
     │             └─→ 2. 删除 auth.users
     │
     └─→ 3. 返回成功

结果: 两个表都被删除 ✅
```

---

## 🔧 维护建议

### 日常维护

1. **定期检查孤立用户**（每周）
   ```sql
   SELECT COUNT(*) FROM public.cleanup_orphaned_auth_users();
   ```

2. **定期清理**（发现后立即清理）
   - 使用前端界面工具
   - 或使用 SQL 脚本

### 监控指标

- 孤立用户数量应该 = 0
- 如果持续出现，检查代码逻辑

---

## 📝 更新日志

### 2025-11-01
- ✅ 修复前端删除用户代码
- ✅ 创建数据库触发器
- ✅ 添加前端清理工具界面
- ✅ 添加 RPC 函数
- ✅ 更新 Edge Function 防止循环

---

## 🆘 获取帮助

如果遇到问题：

1. **检查日志**
   - Supabase Dashboard → Logs
   - Edge Function 日志

2. **检查权限**
   - 确保您是管理员角色

3. **查看文档**
   - 本文档
   - Supabase 官方文档

---

**最后更新**: 2025-11-01  
**版本**: 1.0.0  
**作者**: Cursor AI Assistant

