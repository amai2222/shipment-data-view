# ç”¨æˆ·åŒæ­¥åˆ é™¤ç³»ç»Ÿ - å®Œæ•´è¯´æ˜

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
2. [æ¶æ„è¯´æ˜](#æ¶æ„è¯´æ˜)
3. [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
4. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
5. [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## é—®é¢˜èƒŒæ™¯

### ğŸ” ç°è±¡

å½“æ‚¨å°è¯•æ³¨å†Œç”¨æˆ·æ—¶ï¼Œé‡åˆ°é”™è¯¯ï¼š

```
AuthApiError: A user with this email address has already been registered
```

ä½†æ˜¯åœ¨ç”¨æˆ·ç®¡ç†ç•Œé¢ï¼ˆ`profiles` è¡¨ï¼‰ä¸­å´æ‰¾ä¸åˆ°è¿™ä¸ªç”¨æˆ·ã€‚

### ğŸ¤” åŸå› 

Supabase æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„ç”¨æˆ·è¡¨ï¼š

| è¡¨å | ä½œç”¨ | ä½ç½® | å¯è§æ€§ |
|------|------|------|--------|
| **auth.users** | è®¤è¯ç³»ç»Ÿè¡¨ | Supabase Auth ç³»ç»Ÿ | âŒ æ‚¨åœ¨ç•Œé¢çœ‹ä¸åˆ° |
| **public.profiles** | ä¸šåŠ¡ä¿¡æ¯è¡¨ | æ‚¨çš„æ•°æ®åº“ | âœ… æ‚¨åœ¨ç•Œé¢å¯ä»¥çœ‹åˆ° |

**é—®é¢˜æ‰€åœ¨**ï¼š
- æœ‰äº›ä»£ç åªåˆ é™¤äº† `profiles` è¡¨
- æ²¡æœ‰åˆ é™¤ `auth.users` è¡¨
- å¯¼è‡´ä¸¤ä¸ªè¡¨ä¸åŒæ­¥

---

## æ¶æ„è¯´æ˜

### ğŸ—ï¸ æ­£å¸¸æµç¨‹

```
åˆ›å»ºç”¨æˆ·:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆ›å»º     â”‚
â”‚ auth.users  â”‚  â†â”€â”€ Supabase Auth
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åˆ›å»º     â”‚
â”‚ profiles    â”‚  â†â”€â”€ æ‚¨çš„ä¸šåŠ¡è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
åˆ é™¤ç”¨æˆ·ï¼ˆæ­£ç¡®ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆ é™¤     â”‚
â”‚ profiles    â”‚  â†â”€â”€ å…ˆåˆ é™¤ä¸šåŠ¡è¡¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åˆ é™¤     â”‚
â”‚ auth.users  â”‚  â†â”€â”€ å†åˆ é™¤è®¤è¯è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### âŒ é”™è¯¯æµç¨‹ï¼ˆå¯¼è‡´ä¸åŒæ­¥ï¼‰

```
åˆ é™¤ç”¨æˆ·ï¼ˆé”™è¯¯ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆ é™¤     â”‚
â”‚ profiles    â”‚  â†â”€â”€ åªåˆ é™¤äº†è¿™ä¸ª
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ auth.users  â”‚  â†â”€â”€ âŒ æ²¡æœ‰åˆ é™¤ï¼Œæˆä¸ºå­¤ç«‹è®°å½•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è§£å†³æ–¹æ¡ˆ

### ğŸ“¦ å·²å®ç°çš„åŠŸèƒ½

1. **ä¿®å¤å‰ç«¯åˆ é™¤ä»£ç ** âœ…
   - ç»Ÿä¸€ä½¿ç”¨ Edge Function åˆ é™¤ç”¨æˆ·
   - ç¡®ä¿åŒæ—¶åˆ é™¤ä¸¤ä¸ªè¡¨

2. **æ•°æ®åº“è§¦å‘å™¨** âœ…
   - å½“åˆ é™¤ `profiles` æ—¶è‡ªåŠ¨æ¸…ç† `auth.users`
   - é˜²æ­¢å°†æ¥å†æ¬¡å‡ºç°ä¸åŒæ­¥

3. **æ¸…ç†å·¥å…·ç•Œé¢** âœ…
   - æŸ¥çœ‹æ‰€æœ‰å­¤ç«‹ç”¨æˆ·
   - ä¸€é”®æ¸…ç†å­¤ç«‹ç”¨æˆ·

4. **RPC å‡½æ•°** âœ…
   - `cleanup_orphaned_auth_users()` - æŸ¥è¯¢å­¤ç«‹ç”¨æˆ·
   - `delete_auth_user_by_email()` - åˆ é™¤å­¤ç«‹ç”¨æˆ·

---

## ä½¿ç”¨æŒ‡å—

### æ–¹æ³• 1: ä½¿ç”¨å‰ç«¯ç•Œé¢ï¼ˆæ¨èï¼‰ ğŸŒŸ

1. **æ‰“å¼€ç”¨æˆ·ç®¡ç†é¡µé¢**
   ```
   ç³»ç»Ÿè®¾ç½® â†’ ç”¨æˆ·ç®¡ç†
   ```

2. **æŸ¥çœ‹å­¤ç«‹ç”¨æˆ·æ¸…ç†å·¥å…·**
   - é¡µé¢ä¼šè‡ªåŠ¨æ˜¾ç¤ºæ‰€æœ‰å­¤ç«‹ç”¨æˆ·
   - æ˜¾ç¤ºï¼šé‚®ç®±ã€ç”¨æˆ·IDã€åˆ›å»ºæ—¶é—´

3. **æ¸…ç†å­¤ç«‹ç”¨æˆ·**
   - ç‚¹å‡» "æ¸…ç†" æŒ‰é’®
   - ç¡®è®¤åˆ é™¤
   - å®Œæˆï¼

### æ–¹æ³• 2: ä½¿ç”¨ SQL æŸ¥è¯¢

#### æŸ¥çœ‹å­¤ç«‹ç”¨æˆ·

```sql
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
SELECT * FROM public.cleanup_orphaned_auth_users();
```

#### åˆ é™¤æŒ‡å®šé‚®ç®±çš„å­¤ç«‹ç”¨æˆ·

```sql
-- æ›¿æ¢æˆå®é™…é‚®ç®±
SELECT public.delete_auth_user_by_email('user@example.com');
```

### æ–¹æ³• 3: ä½¿ç”¨å‰ç«¯ä»£ç 

```typescript
// æŸ¥è¯¢å­¤ç«‹ç”¨æˆ·
const { data, error } = await supabase.rpc('cleanup_orphaned_auth_users');

console.log('å­¤ç«‹ç”¨æˆ·åˆ—è¡¨:', data);

// åˆ é™¤å­¤ç«‹ç”¨æˆ·
const { data: result, error: deleteError } = await supabase.rpc('delete_auth_user_by_email', {
  p_email: 'user@example.com'
});

if (result?.success) {
  console.log('åˆ é™¤æˆåŠŸ:', result.message);
}
```

---

## éƒ¨ç½²æ­¥éª¤

### 1ï¸âƒ£ éƒ¨ç½²æ•°æ®åº“è¿ç§»

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd supabase

# åº”ç”¨è¿ç§»
supabase db push
```

**æˆ–è€…æ‰‹åŠ¨æ‰§è¡Œ SQL:**

åœ¨ Supabase Dashboard â†’ SQL Editor ä¸­æ‰§è¡Œï¼š

```
supabase/migrations/20251101_auto_sync_user_deletion.sql
```

### 2ï¸âƒ£ éƒ¨ç½² Edge Function

```bash
# éƒ¨ç½² delete-user å‡½æ•°
supabase functions deploy delete-user
```

### 3ï¸âƒ£ é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰

å¦‚æœè¦å¯ç”¨è‡ªåŠ¨è§¦å‘å™¨æ¸…ç†ï¼Œéœ€è¦åœ¨ Supabase Dashboard ä¸­é…ç½®ï¼š

```sql
-- åœ¨ SQL Editor ä¸­æ‰§è¡Œ
ALTER DATABASE postgres SET app.settings.supabase_url = 'https://ä½ çš„é¡¹ç›®.supabase.co';
ALTER DATABASE postgres SET app.settings.service_role_key = 'ä½ çš„service_role_key';
```

âš ï¸ **æ³¨æ„**ï¼š`service_role_key` æ˜¯æ•æ„Ÿä¿¡æ¯ï¼Œä¸è¦æ³„éœ²ï¼

### 4ï¸âƒ£ éªŒè¯éƒ¨ç½²

1. **æµ‹è¯•æŸ¥è¯¢å­¤ç«‹ç”¨æˆ·**
   ```sql
   SELECT * FROM public.cleanup_orphaned_auth_users();
   ```

2. **æµ‹è¯•å‰ç«¯ç•Œé¢**
   - æ‰“å¼€ç”¨æˆ·ç®¡ç†é¡µé¢
   - æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤ºå­¤ç«‹ç”¨æˆ·æ¸…ç†å·¥å…·

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¼šå‡ºç°å­¤ç«‹ç”¨æˆ·ï¼Ÿ

**A:** æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

1. **ä»£ç é”™è¯¯**
   - æ—§ä»£ç åªåˆ é™¤ `profiles`ï¼Œæ²¡åˆ é™¤ `auth.users`
   
2. **æ³¨å†Œå¤±è´¥**
   - `auth.users` åˆ›å»ºæˆåŠŸ
   - `profiles` åˆ›å»ºå¤±è´¥
   - å¯¼è‡´åªæœ‰åŠä¸ªç”¨æˆ·

3. **æ‰‹åŠ¨æ“ä½œ**
   - åœ¨æ•°æ®åº“ä¸­æ‰‹åŠ¨åˆ é™¤ `profiles`
   - æ²¡æœ‰åˆ é™¤ `auth.users`

### Q2: å­¤ç«‹ç”¨æˆ·æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ

**A:** 

- âŒ è¯¥é‚®ç®±æ— æ³•é‡æ–°æ³¨å†Œï¼ˆauth.users è®¤ä¸ºå·²å­˜åœ¨ï¼‰
- âŒ æ— æ³•ç™»å½•ï¼ˆprofiles ä¸å­˜åœ¨ï¼‰
- âŒ æµªè´¹æ•°æ®åº“å­˜å‚¨ç©ºé—´
- âŒ å¯èƒ½å¯¼è‡´æƒé™æ£€æŸ¥é”™è¯¯

### Q3: åˆ é™¤å­¤ç«‹ç”¨æˆ·å®‰å…¨å—ï¼Ÿ

**A:** æ˜¯çš„ï¼Œéå¸¸å®‰å…¨ï¼

- âœ… åªåˆ é™¤è®¤è¯è®°å½•ï¼Œä¸å½±å“ä¸šåŠ¡æ•°æ®
- âœ… æœ‰æƒé™æ£€æŸ¥ï¼ˆåªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ï¼‰
- âœ… ä¸ä¼šè¯¯åˆ æ­£å¸¸ç”¨æˆ·ï¼ˆä¼šæ£€æŸ¥ profiles æ˜¯å¦å­˜åœ¨ï¼‰
- âœ… å¯ä»¥é‡æ–°æ³¨å†Œè¯¥é‚®ç®±

### Q4: å¦‚ä½•é˜²æ­¢å°†æ¥å†æ¬¡å‡ºç°ï¼Ÿ

**A:** å·²ç»å®ç°äº†ä»¥ä¸‹ä¿æŠ¤æªæ–½ï¼š

1. **ä¿®å¤å‰ç«¯ä»£ç **
   - ç»Ÿä¸€ä½¿ç”¨ Edge Function åˆ é™¤
   
2. **æ•°æ®åº“è§¦å‘å™¨**ï¼ˆå¯é€‰ï¼‰
   - è‡ªåŠ¨æ¸…ç† auth.users
   
3. **å®šæœŸæ£€æŸ¥**
   - ä½¿ç”¨æ¸…ç†å·¥å…·å®šæœŸæŸ¥çœ‹

### Q5: è§¦å‘å™¨ä¸å·¥ä½œæ€ä¹ˆåŠï¼Ÿ

**A:** 

1. **æ£€æŸ¥ pg_net æ‰©å±•**
   ```sql
   CREATE EXTENSION IF NOT EXISTS pg_net;
   ```

2. **æ£€æŸ¥ç¯å¢ƒå˜é‡**
   ```sql
   SELECT current_setting('app.settings.supabase_url', true);
   SELECT current_setting('app.settings.service_role_key', true);
   ```

3. **æ‰‹åŠ¨æ¸…ç†**
   - ä½¿ç”¨å‰ç«¯ç•Œé¢æ¸…ç†å·¥å…·
   - æˆ–ä½¿ç”¨ SQL å‡½æ•°

### Q6: èƒ½å¦æ‰¹é‡æ¸…ç†æ‰€æœ‰å­¤ç«‹ç”¨æˆ·ï¼Ÿ

**A:** å¯ä»¥ï¼ä½¿ç”¨ SQLï¼š

```sql
-- âš ï¸ å±é™©æ“ä½œï¼è¯·å…ˆç¡®è®¤
DO $$
DECLARE
    orphaned_user RECORD;
BEGIN
    FOR orphaned_user IN 
        SELECT * FROM public.cleanup_orphaned_auth_users()
    LOOP
        PERFORM public.delete_auth_user_by_email(orphaned_user.email);
    END LOOP;
END $$;
```

---

## ğŸ“Š ç³»ç»Ÿæµç¨‹å›¾

```
ç”¨æˆ·åˆ é™¤æµç¨‹ï¼ˆæ–°ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

å‰ç«¯ç‚¹å‡»åˆ é™¤
     â”‚
     â–¼
Edge Function: delete-user
     â”‚
     â”œâ”€â†’ 1. åˆ é™¤ profiles (fromTrigger=false)
     â”‚      â”‚
     â”‚      â–¼
     â”‚   è§¦å‘å™¨: auto_cleanup_auth_user_trigger
     â”‚      â”‚
     â”‚      â””â”€â†’ è°ƒç”¨ Edge Function (fromTrigger=true)
     â”‚             â”‚
     â”‚             â””â”€â†’ 2. åˆ é™¤ auth.users
     â”‚
     â””â”€â†’ 3. è¿”å›æˆåŠŸ

ç»“æœ: ä¸¤ä¸ªè¡¨éƒ½è¢«åˆ é™¤ âœ…
```

---

## ğŸ”§ ç»´æŠ¤å»ºè®®

### æ—¥å¸¸ç»´æŠ¤

1. **å®šæœŸæ£€æŸ¥å­¤ç«‹ç”¨æˆ·**ï¼ˆæ¯å‘¨ï¼‰
   ```sql
   SELECT COUNT(*) FROM public.cleanup_orphaned_auth_users();
   ```

2. **å®šæœŸæ¸…ç†**ï¼ˆå‘ç°åç«‹å³æ¸…ç†ï¼‰
   - ä½¿ç”¨å‰ç«¯ç•Œé¢å·¥å…·
   - æˆ–ä½¿ç”¨ SQL è„šæœ¬

### ç›‘æ§æŒ‡æ ‡

- å­¤ç«‹ç”¨æˆ·æ•°é‡åº”è¯¥ = 0
- å¦‚æœæŒç»­å‡ºç°ï¼Œæ£€æŸ¥ä»£ç é€»è¾‘

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### 2025-11-01
- âœ… ä¿®å¤å‰ç«¯åˆ é™¤ç”¨æˆ·ä»£ç 
- âœ… åˆ›å»ºæ•°æ®åº“è§¦å‘å™¨
- âœ… æ·»åŠ å‰ç«¯æ¸…ç†å·¥å…·ç•Œé¢
- âœ… æ·»åŠ  RPC å‡½æ•°
- âœ… æ›´æ–° Edge Function é˜²æ­¢å¾ªç¯

---

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æ£€æŸ¥æ—¥å¿—**
   - Supabase Dashboard â†’ Logs
   - Edge Function æ—¥å¿—

2. **æ£€æŸ¥æƒé™**
   - ç¡®ä¿æ‚¨æ˜¯ç®¡ç†å‘˜è§’è‰²

3. **æŸ¥çœ‹æ–‡æ¡£**
   - æœ¬æ–‡æ¡£
   - Supabase å®˜æ–¹æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025-11-01  
**ç‰ˆæœ¬**: 1.0.0  
**ä½œè€…**: Cursor AI Assistant

