# 其他平台运单信息最终方案说明

## 方案概述

保持原来的动态输入界面，但简化逻辑：
- **不需要单独输入其他平台名称字段**
- **从运单号输入中自动提取平台名称**
- **多个运单号用 `|` 分隔存储**

## 界面设计

### 输入界面
- 保持原来的动态添加/删除界面
- 每行包含：平台名称输入框 + 运单号输入框 + 删除按钮
- 底部有"添加运单号"按钮
- 实时显示：外部运单号数量 | 其他平台数量

### 数据流程
1. **用户输入**：在运单号界面输入平台名称和运单号
2. **自动提取**：系统自动从运单号中提取平台名称
3. **数据库存储**：
   - `external_tracking_numbers`：完整的运单号数组
   - `other_platform_names`：自动提取的平台名称数组（去重）

## 数据结构

### 表单数据
```typescript
interface FormData {
  // ... 其他字段
  external_tracking_numbers: any[]; // 外部运单号数组
}
```

### 数据库存储
```typescript
// external_tracking_numbers (JSONB)
[
  {
    "platform": "货拉拉",
    "tracking_number": "HL123456", 
    "status": "pending",
    "created_at": "2025-01-20T..."
  },
  {
    "platform": "满帮",
    "tracking_number": "MB789012",
    "status": "pending", 
    "created_at": "2025-01-20T..."
  }
]

// other_platform_names (TEXT[])
["货拉拉", "满帮"]
```

## 核心逻辑

### 数据提取
```typescript
// 从运单号数组中提取平台名称
const externalTrackingNumbers = formData.external_tracking_numbers || [];
const otherPlatformNames = externalTrackingNumbers
  .map(item => item.platform)
  .filter(Boolean)
  .filter((platform, index, arr) => arr.indexOf(platform) === index); // 去重
```

### 实时统计
```typescript
// 界面显示统计
外部运单号: {formData.external_tracking_numbers.length} 个 | 
其他平台: {formData.external_tracking_numbers
  .map(item => item.platform)
  .filter(Boolean)
  .filter((platform, index, arr) => arr.indexOf(platform) === index)
  .length} 个
```

## 使用流程

### 1. 新增运单
1. 点击"添加运单号"按钮
2. 在平台名称输入框输入：`货拉拉`
3. 在运单号输入框输入：`HL123456`
4. 重复步骤1-3添加更多运单号
5. 系统自动提取平台名称到 `other_platform_names` 字段

### 2. 编辑运单
1. 打开编辑对话框
2. 系统自动加载现有的运单号数据
3. 可以添加、修改或删除运单号
4. 平台名称会自动更新

### 3. 查看详情
- 运单详情页面显示所有平台信息
- 平台名称以标签形式展示
- 运单号以卡片形式展示

## 优势

1. **界面熟悉**：保持用户熟悉的动态输入界面
2. **逻辑简化**：不需要单独输入平台名称
3. **数据一致**：确保平台名称和运单号一一对应
4. **自动提取**：系统自动提取并去重平台名称
5. **实时反馈**：界面实时显示统计信息

## 技术实现

### 关键修改
1. **FormData接口**：只保留 `external_tracking_numbers` 字段
2. **数据处理**：从运单号数组中自动提取平台名称
3. **UI界面**：保持原来的动态输入界面
4. **实时统计**：动态计算并显示统计信息

### 文件修改
- `src/pages/BusinessEntry/components/LogisticsFormDialog.tsx`：主要修改
- `src/components/WaybillDetailDialog.tsx`：详情展示（已修改）

## 注意事项

1. **数据完整性**：确保每个运单号都有对应的平台名称
2. **去重处理**：平台名称会自动去重
3. **空值过滤**：系统会自动过滤空的平台名称和运单号
4. **状态管理**：每个运单号都有默认的 pending 状态

## 更新日志

- 2025-01-20: 恢复动态输入界面
- 2025-01-20: 实现自动平台名称提取
- 2025-01-20: 添加实时统计显示
- 2025-01-20: 完善数据一致性保证
