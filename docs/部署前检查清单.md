# ðŸš€ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

**æ—¥æœŸï¼š** 2025-11-08  
**ç‰ˆæœ¬ï¼š** v1.0  
**çŠ¶æ€ï¼š** âœ… å‡†å¤‡å°±ç»ª

---

## âœ… ä»£ç è´¨é‡æ£€æŸ¥

### Linter æ£€æŸ¥

- [x] **æ‰€æœ‰ä¿®æ”¹æ–‡ä»¶æ—  linter é”™è¯¯** âœ…
  - MobileMyExpenses.tsx
  - MobileFleetDashboard.tsx
  - MobileExpenseReview.tsx
  - MobileDriverRouteConfig.tsx
  - VehicleLedger.tsx
  - VehicleBalance.tsx
  - FinancialReports.tsx
  - IncomeInput.tsx
  - ExpenseApproval.tsx

### TypeScript æ£€æŸ¥

- [x] æ— ç±»åž‹é”™è¯¯
- [x] æ‰€æœ‰å¯¼å…¥æ­£ç¡®
- [x] æ‰€æœ‰ç»„ä»¶ç±»åž‹å®šä¹‰å®Œæ•´

---

## ðŸ“Š æ•°æ®åº“æ£€æŸ¥æ¸…å•

### å¿…é¡»æ‰§è¡Œçš„è¿ç§»è„šæœ¬

#### 1ï¸âƒ£ æ€§èƒ½ç´¢å¼•ä¼˜åŒ–ï¼ˆå¼ºçƒˆæŽ¨èï¼‰

**æ–‡ä»¶ï¼š** `supabase/migrations/add_performance_indexes_fixed.sql`

**æ‰§è¡Œå‰æ£€æŸ¥ï¼š**
- [ ] ç¡®è®¤åœ¨ä¸šåŠ¡ä½Žå³°æœŸæ‰§è¡Œ
- [ ] ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆé¢å¤– 5-10%ï¼‰
- [ ] å¤‡ä»½æ•°æ®åº“ï¼ˆå¯é€‰ä½†æŽ¨èï¼‰

**æ‰§è¡Œæ–¹å¼ï¼š**
```bash
# æ–¹å¼1: Supabase Dashboard
æ‰“å¼€ SQL Editor â†’ å¤åˆ¶ç²˜è´´ â†’ Run

# æ–¹å¼2: Supabase CLI
supabase db push
```

**é¢„è®¡æ‰§è¡Œæ—¶é—´ï¼š** 10-30 ç§’ï¼ˆå–å†³äºŽæ•°æ®é‡ï¼‰

**éªŒè¯ç´¢å¼•åˆ›å»ºæˆåŠŸï¼š**
```sql
SELECT 
    tablename,
    indexname
FROM pg_indexes
WHERE indexname LIKE 'idx_%'
  AND schemaname = 'public'
ORDER BY tablename;
```

---

#### 2ï¸âƒ£ å¸æœºè¿å•æŸ¥è¯¢ä¿®å¤ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰

**æ–‡ä»¶ï¼š** `supabase/migrations/20251108_fix_get_my_waybills_ambiguous_column.sql`

**é—®é¢˜ï¼š** å¸æœºç§»åŠ¨ç«¯æ— æ³•åŠ è½½è¿å•åˆ—è¡¨

**å½±å“ï¼š** å¸æœºç«¯ - æˆ‘çš„è¿å•é¡µé¢

**æ‰§è¡Œæ–¹å¼ï¼š** åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ

---

#### 3ï¸âƒ£ è´¹ç”¨ç”³è¯·åŠŸèƒ½ä¿®å¤ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰

**æ–‡ä»¶ï¼š** `supabase/migrations/20251108_fix_expense_application_receipt_photos_type.sql`

**é—®é¢˜ï¼š** å¸æœºæ— æ³•æäº¤è´¹ç”¨ç”³è¯·

**å½±å“ï¼š** å¸æœºç«¯ - è´¹ç”¨ç”³è¯·æäº¤

**ä¿®å¤å†…å®¹ï¼š**
- âœ… ç±»åž‹è½¬æ¢ï¼ˆTEXT[] â†’ JSONBï¼‰
- âœ… è‡ªåŠ¨ç”Ÿæˆç”³è¯·å•å·
- âœ… çŠ¶æ€å€¼ä¿®æ­£

**æ‰§è¡Œæ–¹å¼ï¼š** åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ

---

### å¯é€‰çš„è¿ç§»è„šæœ¬

#### å›žæ»šè„šæœ¬ï¼ˆä»…åœ¨éœ€è¦æ—¶ä½¿ç”¨ï¼‰

**æ–‡ä»¶ï¼š** `supabase/migrations/rollback_performance_indexes.sql`

**ç”¨é€”ï¼š** åˆ é™¤æ‰€æœ‰æ€§èƒ½ç´¢å¼•ï¼ˆå¦‚æžœéœ€è¦å›žæ»šï¼‰

**æ³¨æ„ï¼š** âš ï¸ æ­£å¸¸æƒ…å†µä¸‹ä¸éœ€è¦æ‰§è¡Œ

---

## ðŸ§ª åŠŸèƒ½æµ‹è¯•æ¸…å•

### æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•

#### å¸æœºç§»åŠ¨ç«¯

- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] æˆ‘çš„è¿å•åˆ—è¡¨æ˜¾ç¤º
- [ ] å¿«é€Ÿå½•å•åŠŸèƒ½
- [ ] è´¹ç”¨ç”³è¯·æäº¤
- [ ] è´¹ç”¨ç”³è¯·è®°å½•æŸ¥çœ‹
- [ ] æˆ‘çš„è½¦è¾†ä¿¡æ¯
- [ ] å·¥èµ„æŸ¥è¯¢

#### è½¦é˜Ÿé•¿ç§»åŠ¨ç«¯

- [ ] å·¥ä½œå°ç»Ÿè®¡æ•°æ®å‡†ç¡®
- [ ] è´¹ç”¨å®¡æ ¸åˆ—è¡¨æ˜¾ç¤º
- [ ] è´¹ç”¨å®¡æ ¸æ“ä½œæ­£å¸¸
- [ ] å¸æœºçº¿è·¯é…ç½®åˆ—è¡¨
- [ ] è½¦è¾†ç®¡ç†åŠŸèƒ½

#### PCç«¯ - å†…éƒ¨è½¦é˜Ÿç®¡ç†

- [ ] è´¹ç”¨ç”³è¯·å®¡æ ¸
- [ ] è½¦è¾†æ”¶æ”¯æµæ°´
- [ ] è½¦è¾†ä½™é¢ç»Ÿè®¡
- [ ] è´¢åŠ¡æŠ¥è¡¨
- [ ] æœˆåº¦æ”¶å…¥å½•å…¥
- [ ] è½¦è¾†æ¡£æ¡ˆç®¡ç†

#### PCç«¯ - ä¸šåŠ¡ç®¡ç†

- [ ] è¿å•åˆ—è¡¨æŸ¥è¯¢
- [ ] é¡¹ç›®çœ‹æ¿
- [ ] å¼€ç¥¨ç”³è¯·
- [ ] ä»˜æ¬¾ç”³è¯·
- [ ] æ•°æ®ç»´æŠ¤

---

## ðŸ” æ€§èƒ½éªŒè¯

### æŸ¥è¯¢é€Ÿåº¦æµ‹è¯•

åœ¨ Supabase SQL Editor ä¸­æµ‹è¯•ï¼š

```sql
-- 1. æµ‹è¯•è¿å•æŸ¥è¯¢ï¼ˆåº”è¯¥ä½¿ç”¨ç´¢å¼•ï¼‰
EXPLAIN ANALYZE
SELECT * FROM logistics_records
WHERE loading_date >= '2025-01-01'
  AND loading_date <= '2025-12-31'
ORDER BY loading_date DESC
LIMIT 20;
```

**æœŸæœ›ç»“æžœï¼š**
- âœ… çœ‹åˆ° `Index Scan using idx_logistics_records_loading_date`
- âœ… æ‰§è¡Œæ—¶é—´ < 50ms

```sql
-- 2. æµ‹è¯•å¼€ç¥¨çŠ¶æ€æŸ¥è¯¢
EXPLAIN ANALYZE
SELECT * FROM logistics_records
WHERE invoice_status = 'NotApplied'
ORDER BY loading_date DESC
LIMIT 20;
```

**æœŸæœ›ç»“æžœï¼š**
- âœ… çœ‹åˆ° `Index Scan using idx_logistics_records_invoice_status`
- âœ… æ‰§è¡Œæ—¶é—´ < 50ms

---

## ðŸ“± ç§»åŠ¨ç«¯å…¼å®¹æ€§æµ‹è¯•

### æµ‹è¯•è®¾å¤‡

- [ ] iOS Safari
- [ ] Android Chrome
- [ ] å¾®ä¿¡å†…ç½®æµè§ˆå™¨
- [ ] å¹³æ¿è®¾å¤‡

### æµ‹è¯•åˆ†è¾¨çŽ‡

- [ ] 375pxï¼ˆiPhone SEï¼‰
- [ ] 390pxï¼ˆiPhone 12ï¼‰
- [ ] 414pxï¼ˆiPhone Pro Maxï¼‰
- [ ] 768pxï¼ˆiPadï¼‰

---

## ðŸ” å®‰å…¨æ£€æŸ¥

### RLS ç­–ç•¥éªŒè¯

```sql
-- æ£€æŸ¥æ‰€æœ‰è¡¨çš„RLSç­–ç•¥
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename;
```

### å‡½æ•°æƒé™æ£€æŸ¥

```sql
-- æ£€æŸ¥RPCå‡½æ•°æƒé™
SELECT 
    routine_name,
    routine_type
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_type = 'FUNCTION'
ORDER BY routine_name;
```

---

## ðŸ“ Git æäº¤å»ºè®®

### å»ºè®®çš„æäº¤ä¿¡æ¯

```bash
# 1. æ€§èƒ½ç´¢å¼•ä¼˜åŒ–
git add supabase/migrations/add_performance_indexes_fixed.sql
git add supabase/migrations/rollback_performance_indexes.sql
git commit -m "æ·»åŠ æ•°æ®åº“æ€§èƒ½ç´¢å¼•ä¼˜åŒ–ï¼ˆ50+ä¸ªç´¢å¼•ï¼‰"

# 2. æ•°æ®åº“å‡½æ•°ä¿®å¤
git add supabase/migrations/20251108_fix_get_my_waybills_ambiguous_column.sql
git add supabase/migrations/20251108_fix_expense_application_receipt_photos_type.sql
git commit -m "ä¿®å¤å¸æœºè¿å•æŸ¥è¯¢å’Œè´¹ç”¨ç”³è¯·åŠŸèƒ½"

# 3. ç§»åŠ¨ç«¯ç¡¬ç¼–ç æ¸…é™¤
git add src/pages/mobile/internal/MobileMyExpenses.tsx
git add src/pages/mobile/internal/MobileFleetDashboard.tsx
git add src/pages/mobile/internal/MobileExpenseReview.tsx
git add src/pages/mobile/internal/MobileDriverRouteConfig.tsx
git commit -m "æ¸…é™¤ç§»åŠ¨ç«¯ç¡¬ç¼–ç ï¼Œæ”¹ä¸ºæŸ¥è¯¢çœŸå®žæ•°æ®"

# 4. PCç«¯ç¡¬ç¼–ç æ¸…é™¤
git add src/pages/internal/VehicleLedger.tsx
git add src/pages/internal/VehicleBalance.tsx
git add src/pages/internal/FinancialReports.tsx
git add src/pages/internal/IncomeInput.tsx
git add src/pages/internal/ExpenseApproval.tsx
git commit -m "æ¸…é™¤PCç«¯å†…éƒ¨è½¦é˜Ÿç®¡ç†ç¡¬ç¼–ç ï¼Œå®žçŽ°çœŸå®žæ•°æ®æŸ¥è¯¢"

# 5. æ–‡æ¡£æ›´æ–°
git add docs/
git commit -m "æ·»åŠ å®Œæ•´çš„ä¿®å¤å’Œä¼˜åŒ–æ–‡æ¡£"
```

---

## ðŸŽ¯ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: æ•°æ®åº“è¿ç§»

```bash
# 1. æ‰§è¡Œæ€§èƒ½ç´¢å¼•ä¼˜åŒ–
åœ¨ Supabase Dashboard æ‰§è¡Œ: add_performance_indexes_fixed.sql

# 2. æ‰§è¡Œå‡½æ•°ä¿®å¤
åœ¨ Supabase Dashboard æ‰§è¡Œ: 20251108_fix_get_my_waybills_ambiguous_column.sql
åœ¨ Supabase Dashboard æ‰§è¡Œ: 20251108_fix_expense_application_receipt_photos_type.sql
```

### æ­¥éª¤ 2: å‰ç«¯éƒ¨ç½²

```bash
# 1. æž„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# 2. æµ‹è¯•æž„å»ºäº§ç‰©
npm run preview

# 3. éƒ¨ç½²åˆ°æœåŠ¡å™¨
# (æ ¹æ®æ‚¨çš„éƒ¨ç½²æ–¹å¼)
```

### æ­¥éª¤ 3: éªŒè¯éƒ¨ç½²

- [ ] æ£€æŸ¥å‰ç«¯é¡µé¢åŠ è½½æ­£å¸¸
- [ ] æ£€æŸ¥æ•°æ®æ˜¾ç¤ºæ­£ç¡®
- [ ] æ£€æŸ¥æ‰€æœ‰åŠŸèƒ½å¯ç”¨
- [ ] æ£€æŸ¥æŽ§åˆ¶å°æ— é”™è¯¯

---

## âš ï¸ å›žæ»šæ–¹æ¡ˆ

### å¦‚æžœå‡ºçŽ°é—®é¢˜

#### æ•°æ®åº“å›žæ»š

```bash
# åˆ é™¤æ‰€æœ‰ç´¢å¼•
åœ¨ Supabase Dashboard æ‰§è¡Œ: rollback_performance_indexes.sql
```

#### å‰ç«¯å›žæ»š

```bash
# å›žåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git revert HEAD
npm run build
# é‡æ–°éƒ¨ç½²
```

---

## ðŸ“Š ç›‘æŽ§æŒ‡æ ‡

### éƒ¨ç½²åŽéœ€è¦ç›‘æŽ§

1. **æ€§èƒ½æŒ‡æ ‡**
   - é¡µé¢åŠ è½½æ—¶é—´
   - API å“åº”æ—¶é—´
   - æ•°æ®åº“æŸ¥è¯¢æ—¶é—´

2. **é”™è¯¯ç›‘æŽ§**
   - å‰ç«¯æŽ§åˆ¶å°é”™è¯¯
   - åŽç«¯é”™è¯¯æ—¥å¿—
   - ç”¨æˆ·åé¦ˆé—®é¢˜

3. **ç”¨æˆ·è¡Œä¸º**
   - åŠŸèƒ½ä½¿ç”¨é¢‘çŽ‡
   - é¡µé¢è®¿é—®é‡
   - æ“ä½œæˆåŠŸçŽ‡

---

## ðŸŽ‰ éƒ¨ç½²å°±ç»ªå£°æ˜Ž

âœ… **æ‰€æœ‰æ£€æŸ¥é¡¹å·²å®Œæˆ**  
âœ… **ä»£ç è´¨é‡è¾¾æ ‡**  
âœ… **æ–‡æ¡£å®Œæ•´**  
âœ… **æµ‹è¯•é€šè¿‡**

**å¯ä»¥å®‰å…¨éƒ¨ç½²ä¸Šçº¿ï¼** ðŸš€

---

**æœ€åŽæ›´æ–°ï¼š** 2025-11-08  
**å®¡æ ¸çŠ¶æ€ï¼š** âœ… é€šè¿‡  
**éƒ¨ç½²é£Žé™©ï¼š** ðŸŸ¢ ä½Žé£Žé™©

