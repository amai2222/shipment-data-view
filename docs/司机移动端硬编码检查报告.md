# å¸æœºç§»åŠ¨ç«¯ç¡¬ç¼–ç æ£€æŸ¥ä¸ä¿®å¤æŠ¥å‘Š

**æ£€æŸ¥æ—¶é—´ï¼š** 2025-11-08  
**æ£€æŸ¥èŒƒå›´ï¼š** src/pages/mobile/internal/  
**çŠ¶æ€ï¼š** âœ… å…¨éƒ¨å®Œæˆ

---

## ğŸ“Š æ£€æŸ¥ç»“æœæ€»è§ˆ

| æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| MobileMyExpenses.tsx | âœ… å·²ä¿®å¤ | è´¹ç”¨ç”³è¯·åˆ—è¡¨ - æ”¹ä¸ºæŸ¥è¯¢æ•°æ®åº“ |
| MobileFleetDashboard.tsx | âœ… å·²ä¿®å¤ | è½¦é˜Ÿé•¿å·¥ä½œå°ç»Ÿè®¡ - æ”¹ä¸ºæŸ¥è¯¢æ•°æ®åº“ |
| MobileExpenseReview.tsx | âœ… æ­£å¸¸ | è´¹ç”¨å®¡æ ¸ - ä½¿ç”¨çœŸå®æŸ¥è¯¢ï¼ˆçŠ¶æ€å€¼å·²ä¿®å¤ï¼‰ |
| MobileSalaryRecords.tsx | âœ… æ­£å¸¸ | å·¥èµ„è®°å½• - ä½¿ç”¨çœŸå® RPC æŸ¥è¯¢ |
| MobileDriverSalary.tsx | âœ… æ­£å¸¸ | å¸æœºå·¥èµ„ - ä½¿ç”¨çœŸå®æ•°æ®åº“æŸ¥è¯¢ |
| MobileMyVehicles.tsx | âœ… æ­£å¸¸ | æˆ‘çš„è½¦è¾† - ä½¿ç”¨çœŸå® RPC æŸ¥è¯¢ |
| MobileVehicleManagement.tsx | âœ… æ­£å¸¸ | è½¦è¾†ç®¡ç† - ä½¿ç”¨çœŸå®æ•°æ®åº“æŸ¥è¯¢ |
| MobileDriverRouteConfig.tsx | âœ… æ­£å¸¸ | å¸æœºçº¿è·¯é…ç½® - ä½¿ç”¨çœŸå®æ•°æ®åº“æŸ¥è¯¢ |
| MobileQuickEntry.tsx | âœ… æ­£å¸¸ | å¿«é€Ÿå½•å• - ä½¿ç”¨çœŸå® RPC æŸ¥è¯¢ |

**æ€»è®¡ï¼š** 9 ä¸ªæ–‡ä»¶  
**å·²ä¿®å¤ï¼š** 2 ä¸ª  
**æœ¬æ¥æ­£å¸¸ï¼š** 7 ä¸ª

---

## ğŸ”§ è¯¦ç»†ä¿®å¤è®°å½•

### 1ï¸âƒ£ MobileMyExpenses.tsx - æˆ‘çš„è´¹ç”¨ç”³è¯·

**é—®é¢˜ï¼š** ä½¿ç”¨ç¡¬ç¼–ç çš„æ¨¡æ‹Ÿæ•°æ®  
**ä¿®å¤ï¼š** æŸ¥è¯¢çœŸå®çš„æ•°æ®åº“è®°å½•

```typescript
// âŒ ä¿®å¤å‰
setApplications([...ç¡¬ç¼–ç æ•°æ®...]);

// âœ… ä¿®å¤å
const { data: driverInfo } = await supabase.rpc('get_my_driver_info');
const driverId = driverInfo[0].id;

const { data, error } = await supabase
  .from('internal_driver_expense_applications')
  .select('*')
  .eq('driver_id', driverId)
  .order('created_at', { ascending: false });

setApplications(data || []);
```

**å½±å“é¡µé¢ï¼š** å¸æœºç§»åŠ¨ç«¯ > æˆ‘çš„è´¹ç”¨ > ç”³è¯·è®°å½•åˆ—è¡¨

---

### 2ï¸âƒ£ MobileFleetDashboard.tsx - è½¦é˜Ÿé•¿å·¥ä½œå°

**é—®é¢˜ï¼š** ä½¿ç”¨ç¡¬ç¼–ç çš„ç»Ÿè®¡æ•°æ®  
**ä¿®å¤ï¼š** æŸ¥è¯¢çœŸå®çš„ç»Ÿè®¡æ•°æ®

```typescript
// âŒ ä¿®å¤å‰
const [stats, setStats] = useState<DashboardStats>({
  totalVehicles: 6,
  activeVehicles: 5,
  maintenanceVehicles: 1,
  totalDrivers: 5,
  activeDrivers: 4,
  pendingExpenses: 3,
  pendingVehicleChanges: 1,
  expiringCertificates: 2,
  thisMonthTrips: 45
});

// âœ… ä¿®å¤å
// åˆ†åˆ«æŸ¥è¯¢ï¼š
1. è½¦è¾†ç»Ÿè®¡ï¼ˆæŒ‰çŠ¶æ€åˆ†ç»„ï¼‰
2. å¸æœºç»Ÿè®¡ï¼ˆæ€»æ•°å’Œæ´»è·ƒæ•°ï¼‰
3. å¾…å®¡æ ¸è´¹ç”¨ç”³è¯·æ•°
4. å¾…å®¡æ ¸æ¢è½¦ç”³è¯·æ•°
5. å³å°†åˆ°æœŸè¯ä»¶æ•°ï¼ˆ30å¤©å†…ï¼‰
6. æœ¬æœˆè¿å•æ•°
```

**æŸ¥è¯¢å†…å®¹ï¼š**
- âœ… è½¦é˜Ÿé•¿ç®¡ç†çš„è½¦è¾†åˆ—è¡¨ï¼ˆæŒ‰çŠ¶æ€ç»Ÿè®¡ï¼‰
- âœ… å¸æœºæ€»æ•°å’Œæ´»è·ƒå¸æœºæ•°
- âœ… å¾…å®¡æ ¸çš„è´¹ç”¨ç”³è¯·ï¼ˆstatus='pending'ï¼‰
- âœ… å¾…å®¡æ ¸çš„æ¢è½¦ç”³è¯·ï¼ˆstatus='pending'ï¼‰
- âœ… å³å°†åˆ°æœŸçš„è¯ä»¶ï¼ˆ30å¤©å†…ï¼‰
- âœ… æœ¬æœˆè¿å•æ•°é‡ç»Ÿè®¡

**å½±å“é¡µé¢ï¼š** è½¦é˜Ÿé•¿ç§»åŠ¨ç«¯ > å·¥ä½œå°é¦–é¡µ

---

## âœ… å·²æ­£å¸¸è¿è¡Œçš„é¡µé¢

### 3ï¸âƒ£ MobileExpenseReview.tsx - è´¹ç”¨å®¡æ ¸

**æŸ¥è¯¢æ–¹å¼ï¼š** ç›´æ¥æŸ¥è¯¢æ•°æ®åº“è¡¨  
**ä¿®å¤çŠ¶æ€ï¼š** çŠ¶æ€å€¼å¤§å°å†™å·²ç»Ÿä¸€ä¸ºå°å†™

```typescript
let query = supabase
  .from('internal_driver_expense_applications')
  .select('*')
  .order('created_at', { ascending: false });

if (filterStatus === 'pending') {
  query = query.eq('status', 'pending');  // âœ… å·²ä¿®å¤ä¸ºå°å†™
}
```

---

### 4ï¸âƒ£ MobileSalaryRecords.tsx - å·¥èµ„è®°å½•

**æŸ¥è¯¢æ–¹å¼ï¼š** ä½¿ç”¨ RPC å‡½æ•°  
**å‡½æ•°åï¼š** `get_my_salary`

```typescript
const { data, error } = await supabase.rpc('get_my_salary', {
  p_year_month: selectedMonth || null
});
```

---

### 5ï¸âƒ£ MobileDriverSalary.tsx - å¸æœºå·¥èµ„æŸ¥è¯¢

**æŸ¥è¯¢æ–¹å¼ï¼š** ç›´æ¥æŸ¥è¯¢æ•°æ®åº“è¡¨  
**è¡¨åï¼š** `internal_driver_monthly_salary`

```typescript
const { data } = await supabase
  .from('internal_driver_monthly_salary')
  .select('*')
  .eq('driver_id', driverId)
  .eq('year_month', currentMonth)
  .single();
```

---

### 6ï¸âƒ£ MobileMyVehicles.tsx - æˆ‘çš„è½¦è¾†

**æŸ¥è¯¢æ–¹å¼ï¼š** ä½¿ç”¨ RPC å‡½æ•°  
**å‡½æ•°åï¼š** `get_my_vehicles`

```typescript
const { data } = await supabase.rpc('get_my_vehicles');
```

---

### 7ï¸âƒ£ MobileVehicleManagement.tsx - è½¦è¾†ç®¡ç†

**æŸ¥è¯¢æ–¹å¼ï¼š** ç›´æ¥æŸ¥è¯¢æ•°æ®åº“è¡¨ï¼ˆå¸¦å…³è”ï¼‰  
**è¡¨åï¼š** `internal_vehicles`

```typescript
const { data, error } = await supabase
  .from('internal_vehicles')
  .select(`
    *,
    driver:internal_driver_vehicle_relations!inner(
      driver:internal_drivers(name)
    )
  `)
  .order('license_plate');
```

---

### 8ï¸âƒ£ MobileDriverRouteConfig.tsx - å¸æœºçº¿è·¯é…ç½®

**æŸ¥è¯¢æ–¹å¼ï¼š** ç›´æ¥æŸ¥è¯¢æ•°æ®åº“è¡¨  
**è¡¨åï¼š** `internal_driver_project_routes`

```typescript
const { data } = await supabase
  .from('internal_driver_project_routes')
  .select('*')
  .order('created_at', { ascending: false });
```

---

### 9ï¸âƒ£ MobileQuickEntry.tsx - å¿«é€Ÿå½•å•

**æŸ¥è¯¢æ–¹å¼ï¼š** ä½¿ç”¨ RPC å‡½æ•°  
**å‡½æ•°åï¼š** 
- `get_my_driver_info`
- `get_my_vehicles`
- `get_my_project_routes`
- `get_my_waybills`
- `driver_quick_create_waybill`

---

## ğŸ¯ ç›¸å…³ä¿®å¤æ€»ç»“

é™¤äº†ç¡¬ç¼–ç ä¿®å¤å¤–ï¼Œè¿˜å®Œæˆäº†ä»¥ä¸‹ç›¸å…³ä¿®å¤ï¼š

### è´¹ç”¨ç”³è¯·ç³»ç»Ÿä¿®å¤

1. âœ… **ç±»å‹è½¬æ¢** - `receipt_photos` å­—æ®µï¼ˆTEXT[] â†’ JSONBï¼‰
2. âœ… **ç”³è¯·å•å·** - è‡ªåŠ¨ç”Ÿæˆ `application_number` å­—æ®µ
3. âœ… **çŠ¶æ€å€¼** - ç»Ÿä¸€ä½¿ç”¨å°å†™ï¼ˆ'pending', 'approved', 'rejected', 'paid'ï¼‰
4. âœ… **å‰ç«¯æŸ¥è¯¢** - çŠ¶æ€å€¼å¤§å°å†™ç»Ÿä¸€ä¿®æ­£
5. âœ… **å¸æœºæŸ¥è¯¢** - ç§»é™¤ç¡¬ç¼–ç ï¼ŒæŸ¥è¯¢çœŸå®æ•°æ®
6. âœ… **è½¦é˜Ÿé•¿å·¥ä½œå°** - ç§»é™¤ç¡¬ç¼–ç ï¼ŒæŸ¥è¯¢çœŸå®ç»Ÿè®¡

### è¿å•æŸ¥è¯¢ä¿®å¤

1. âœ… **get_my_waybills** - ä¿®å¤å­—æ®µå¼•ç”¨ä¸æ˜ç¡®é—®é¢˜

---

## ğŸ“ æ•°æ®åº“å‡½æ•°ä¾èµ–

### å¸æœºç«¯ RPC å‡½æ•°

| å‡½æ•°å | ç”¨é€” | çŠ¶æ€ |
|--------|------|------|
| get_my_driver_info | è·å–å¸æœºæ¡£æ¡ˆ | âœ… æ­£å¸¸ |
| get_my_vehicles | è·å–æˆ‘çš„è½¦è¾† | âœ… æ­£å¸¸ |
| get_my_project_routes | è·å–æˆ‘çš„é¡¹ç›®çº¿è·¯ | âœ… æ­£å¸¸ |
| get_my_waybills | è·å–æˆ‘çš„è¿å• | âœ… å·²ä¿®å¤ |
| get_my_salary | è·å–å·¥èµ„è®°å½• | âœ… æ­£å¸¸ |
| submit_expense_application | æäº¤è´¹ç”¨ç”³è¯· | âœ… å·²ä¿®å¤ |
| driver_quick_create_waybill | å¿«é€Ÿåˆ›å»ºè¿å• | âœ… æ­£å¸¸ |

### è½¦é˜Ÿé•¿ç«¯ RPC å‡½æ•°

| å‡½æ•°å | ç”¨é€” | çŠ¶æ€ |
|--------|------|------|
| review_expense_application | å®¡æ ¸è´¹ç”¨ç”³è¯· | âœ… æ­£å¸¸ |

---

## âœ… æµ‹è¯•æ¸…å•

### å¸æœºç«¯æµ‹è¯•

- [x] æˆ‘çš„è´¹ç”¨ - ç”³è¯·è®°å½•æ˜¾ç¤º
- [x] æˆ‘çš„è´¹ç”¨ - æäº¤æ–°ç”³è¯·
- [x] æˆ‘çš„è¿å• - è¿å•åˆ—è¡¨
- [x] æˆ‘çš„è½¦è¾† - è½¦è¾†ä¿¡æ¯
- [x] å·¥èµ„æŸ¥è¯¢ - å·¥èµ„è®°å½•
- [x] å¿«é€Ÿå½•å• - åˆ›å»ºè¿å•

### è½¦é˜Ÿé•¿ç«¯æµ‹è¯•

- [x] å·¥ä½œå° - ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
- [x] è´¹ç”¨å®¡æ ¸ - å¾…å®¡æ ¸åˆ—è¡¨
- [x] è½¦è¾†ç®¡ç† - è½¦è¾†åˆ—è¡¨
- [x] å¸æœºç®¡ç† - å¸æœºåˆ—è¡¨
- [x] çº¿è·¯é…ç½® - çº¿è·¯ç®¡ç†

---

## ğŸ‰ æ€»ç»“

æ‰€æœ‰å¸æœºç§»åŠ¨ç«¯å’Œè½¦é˜Ÿé•¿ç§»åŠ¨ç«¯çš„ç¡¬ç¼–ç å·²å…¨éƒ¨æ¸…é™¤ï¼Œç°åœ¨å…¨éƒ¨ä½¿ç”¨çœŸå®çš„æ•°æ®åº“æŸ¥è¯¢ï¼

**ä¿®å¤æ–‡ä»¶ï¼š** 2 ä¸ª  
**ç›¸å…³ä¼˜åŒ–ï¼š** å¤šå¤„çŠ¶æ€å€¼ç»Ÿä¸€ã€ç±»å‹è½¬æ¢ã€å­—æ®µä¿®å¤

**æœ€åæ›´æ–°ï¼š** 2025-11-08

