# 有效数量类型功能说明

## 📋 功能概述

在项目中新增了"有效数量类型"字段，用于配置运单中有效数量的计算方式。这个功能将原来的"重量计算逻辑"扩展为更通用的"有效数量计算逻辑"。

## 🎯 功能特点

### 1. 三种计算方式

- **min_value** (装货数量和卸货数量取较小值)
  - 这是默认的计算方式
  - 取装货数量和卸货数量中的较小值作为有效数量
  - 适用于大多数物流场景

- **loading** (取装货数量)
  - 直接使用装货数量作为有效数量
  - 适用于以装货数量为准的业务场景

- **unloading** (取卸货数量)
  - 直接使用卸货数量作为有效数量
  - 适用于以卸货数量为准的业务场景

### 2. 数据库结构

#### 新增枚举类型
```sql
CREATE TYPE public.effective_quantity_type AS ENUM (
    'min_value',    -- 装货数量和卸货数量取较小值
    'loading',      -- 取装货数量
    'unloading'     -- 取卸货数量
);
```

#### 项目表新增字段
```sql
ALTER TABLE public.projects 
ADD COLUMN effective_quantity_type public.effective_quantity_type 
DEFAULT 'min_value' NOT NULL;
```

### 3. 计算逻辑

#### 有效数量计算函数
```sql
CREATE OR REPLACE FUNCTION public.calculate_effective_quantity(
  p_loading_quantity numeric,
  p_unloading_quantity numeric,
  p_effective_quantity_type public.effective_quantity_type
)
RETURNS numeric
```

#### 计算逻辑
```sql
CASE p_effective_quantity_type
    WHEN 'min_value' THEN
        -- 取装货数量和卸货数量的较小值
        COALESCE(
            NULLIF(LEAST(
                COALESCE(p_loading_quantity, 999999), 
                COALESCE(p_unloading_quantity, 999999)
            ), 999999),
            COALESCE(p_loading_quantity, p_unloading_quantity, 0)
        )
    WHEN 'loading' THEN
        -- 取装货数量
        COALESCE(p_loading_quantity, 0)
    WHEN 'unloading' THEN
        -- 取卸货数量
        COALESCE(p_unloading_quantity, 0)
    ELSE
        -- 默认取较小值
        -- ... 同 min_value 逻辑
END
```

## 🖥️ 用户界面

### 1. 项目表单

在项目添加和编辑表单中新增了"有效数量计算方式"选择字段：

```typescript
<div className="space-y-2">
  <Label htmlFor="effectiveQuantityType">有效数量计算方式</Label>
  <Select value={formData.effectiveQuantityType} onValueChange={...}>
    <SelectTrigger>
      <SelectValue placeholder="选择有效数量计算方式" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="min_value">装货数量和卸货数量取较小值</SelectItem>
      <SelectItem value="loading">取装货数量</SelectItem>
      <SelectItem value="unloading">取卸货数量</SelectItem>
    </SelectContent>
  </Select>
</div>
```

### 2. 表单数据结构

```typescript
const [formData, setFormData] = useState({
  // ... 其他字段
  effectiveQuantityType: "min_value" as "min_value" | "loading" | "unloading",
});
```

## 🔄 影响范围

### 1. 运费对账计算

- 更新了 `calculate_partner_costs_v3` 函数
- 更新了 `bulk_calculate_partner_costs` 函数
- 所有合作方成本计算都会使用项目配置的有效数量类型

### 2. 运单录入

- 运单录入时的数量字段现在更通用
- 支持重量、体积、次数等不同类型的数量计算

### 3. 数据兼容性

- 现有项目默认使用 `min_value` 计算方式
- 保持向后兼容性
- 现有运单数据不受影响

## 📊 使用示例

### 示例1：默认计算方式（取较小值）
```
项目配置：effective_quantity_type = 'min_value'
运单数据：装货数量 = 10吨，卸货数量 = 8吨
计算结果：有效数量 = 8吨
```

### 示例2：取装货数量
```
项目配置：effective_quantity_type = 'loading'
运单数据：装货数量 = 10吨，卸货数量 = 8吨
计算结果：有效数量 = 10吨
```

### 示例3：取卸货数量
```
项目配置：effective_quantity_type = 'unloading'
运单数据：装货数量 = 10吨，卸货数量 = 8吨
计算结果：有效数量 = 8吨
```

## 🚀 部署说明

### 1. 数据库迁移

执行以下迁移脚本：
1. `20250120000000_add_effective_quantity_type.sql` - 添加字段和枚举
2. `20250120000001_update_effective_quantity_calculation.sql` - 更新计算逻辑

### 2. 前端更新

- 更新 TypeScript 类型定义
- 更新项目表单组件
- 确保所有相关组件支持新字段

### 3. 测试验证

- 测试项目创建和编辑功能
- 测试运单录入和计算功能
- 测试运费对账功能
- 验证数据兼容性

## 📝 注意事项

1. **数据迁移**：现有项目会自动设置为 `min_value` 类型
2. **向后兼容**：所有现有功能保持正常工作
3. **性能影响**：新计算逻辑对性能影响极小
4. **业务逻辑**：确保业务人员了解不同计算方式的含义

## 🔧 技术细节

### 1. 类型定义
```typescript
// 数据库类型
effective_quantity_type: "min_value" | "loading" | "unloading"

// 前端类型
type EffectiveQuantityType = "min_value" | "loading" | "unloading"
```

### 2. 函数更新
- `calculate_effective_quantity()` - 新增有效数量计算函数
- `calculate_partner_costs_v3()` - 更新合作方成本计算
- `bulk_calculate_partner_costs()` - 更新批量计算逻辑
- `upsert_project_with_details()` - 更新项目创建/更新函数

### 3. 前端组件
- `Projects.tsx` - 更新项目表单
- `types.ts` - 更新类型定义
- 相关运单和财务组件自动支持新逻辑

这个功能为物流管理系统提供了更灵活的数量计算方式，能够适应不同业务场景的需求。
