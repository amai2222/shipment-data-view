# 货主移动端功能说明

## 📅 创建日期
2025-11-14

## 🎯 功能概述

货主移动端是专为货主角色（`partner`角色，且`partner_type`为"货主"）设计的移动端应用，提供便捷的账户管理、付款查询、回单提交等功能。

## 🔐 权限控制

- **角色限制**：仅限`partner`角色且关联货主类型合作方的用户访问
- **权限检查**：在`ShipperMobileLayout`组件中进行权限验证
- **未授权处理**：显示权限不足提示，引导用户返回登录页

## 📱 页面清单

### 1. 首页（看板）- `/m/shipper`

**文件**：`src/pages/mobile/shipper/MobileShipperHome.tsx`

**功能**：
- 显示账户余额（大卡片，渐变背景）
- 显示待付款统计（数量、金额）
- 显示已逾期统计（数量、金额）
- 快速操作按钮（查看待付款、提交回单、运单查询）
- 最近待付款列表（最多5条）
- 支持下拉刷新

**数据来源**：
- 余额：`get_partner_balance` RPC
- 待付款：`get_invoice_requests_filtered_1114` RPC（筛选未全额收款的申请单）

---

### 2. 待付款列表 - `/m/shipper/pending-payments`

**文件**：`src/pages/mobile/shipper/MobileShipperPendingPayments.tsx`

**功能**：
- 搜索申请单号
- 显示待付款统计（数量、总额）
- 待付款列表（支持分页）
- 显示逾期标识和天数
- 快速提交回单按钮
- 点击查看详情

**详情页**：`/m/shipper/pending-payments/:id`
- 显示申请单详细信息
- 显示开票金额、已收款、未收款
- 显示到期日和逾期天数
- 提交电子回单按钮

**数据来源**：
- `get_invoice_requests_filtered_1114` RPC

---

### 3. 充值页面 - `/m/shipper/recharge`

**文件**：`src/pages/mobile/shipper/MobileShipperRecharge.tsx`

**功能**：
- 显示当前余额
- 快速金额选择（1000、5000、10000、20000、50000）
- 自定义金额输入
- 备注输入（可选）
- 确认充值按钮

**后端调用**：
- `manual_recharge_partner_balance` RPC

**充值后**：
- 余额立即更新
- 自动跳转回首页

---

### 4. 提交电子回单 - `/m/shipper/submit-receipt`

**文件**：`src/pages/mobile/shipper/MobileShipperSubmitReceipt.tsx`

**功能**：
- 显示申请单信息（如果通过URL参数传入）
- 回单信息表单：
  - 收款单号（可选）
  - 收款银行（可选）
  - 收款金额（必填，自动填充未收款金额）
  - 备注（可选）
- 上传银行回单图片（最多9张）
- 图片预览和删除
- 提交按钮

**流程**：
1. 选择/拍摄银行回单图片
2. 填写回单信息
3. 上传图片到七牛云
4. 调用`receive_invoice_payment_1114` RPC登记收款
5. 财务人员收到通知（通过通知系统）
6. 财务人员审核后，余额自动更新

**后端调用**：
- 图片上传：`qiniu-upload` Edge Function
- 收款登记：`receive_invoice_payment_1114` RPC

**通知机制**：
- 收款登记后，系统自动为财务人员创建通知
- 通知类型：`finance`
- 通知内容：包含申请单号、收款金额等信息

---

### 5. 运单查询 - `/m/shipper/waybills`

**文件**：`src/pages/mobile/shipper/MobileShipperWaybills.tsx`

**功能**：
- 搜索运单（运单号、起运地、目的地）
- 运单列表（支持分页）
- 显示运单基本信息：
  - 运单号
  - 起运地 → 目的地
  - 装货日期
  - 应付金额
  - 开票状态
- 点击查看详情

**数据来源**：
- 通过开票申请单关联查询运单
- `logistics_records` 表

---

### 6. 余额流水记录 - `/m/shipper/transactions`

**文件**：`src/pages/mobile/shipper/MobileShipperTransactions.tsx`

**功能**：
- 日期范围筛选（开始日期、结束日期）
- 流水记录列表（支持分页）
- 显示交易信息：
  - 交易类别（财务收款、手动充值、运单应付、服务费、逾期费等）
  - 交易类型（充值/扣款）
  - 交易金额（带颜色标识）
  - 交易后余额
  - 关联单号（如有）
  - 交易时间

**数据来源**：
- `get_partner_balance_transactions` RPC

---

### 7. 通知中心 - `/m/shipper/notifications`

**复用**：`src/pages/mobile/MobileNotifications.tsx`

**功能**：
- 查看所有通知
- 按分类筛选（finance、business等）
- 标记已读
- 删除通知

---

### 8. 设置页面 - `/m/shipper/settings`

**文件**：`src/pages/mobile/shipper/MobileShipperSettings.tsx`

**功能**：
- 显示账户信息
- 通知设置（跳转到通知中心）
- 版本信息
- 退出登录

---

## 🎨 UI设计特点

### 设计原则
- **现代化**：使用渐变背景、卡片式布局、圆角设计
- **易用性**：大按钮、清晰的视觉层次、直观的图标
- **响应式**：适配移动端屏幕，支持触摸操作
- **一致性**：与系统其他移动端页面保持一致的风格

### 颜色方案
- **主色**：蓝色（`blue-500`、`blue-600`）
- **成功**：绿色（`green-500`、`green-600`）
- **警告**：橙色（`orange-500`）
- **错误**：红色（`red-500`）
- **中性**：灰色（`gray-50`到`gray-900`）

### 组件使用
- **Card**：主要容器
- **Button**：操作按钮
- **Badge**：状态标识
- **Input**：文本输入
- **Textarea**：多行文本输入
- **Calendar**：日期选择
- **Popover**：弹出层

---

## 🔄 数据流程

### 提交电子回单流程

```
1. 货主选择申请单
   ↓
2. 上传银行回单图片（七牛云）
   ↓
3. 填写回单信息（金额、单号、银行等）
   ↓
4. 调用 receive_invoice_payment_1114 RPC
   ↓
5. 后端处理：
   - 创建收款记录（invoice_receipt_records）
   - 更新申请单状态和累计收款金额
   - 更新运单收款状态（如全额收款）
   - 为货主账号充值（update_partner_balance）
   - 为财务人员创建通知（notifications）
   ↓
6. 前端显示成功提示
   ↓
7. 财务人员收到通知，进行审核
```

### 充值流程

```
1. 货主输入充值金额
   ↓
2. 调用 manual_recharge_partner_balance RPC
   ↓
3. 后端处理：
   - 更新货主余额（partner_balance）
   - 创建流水记录（partner_balance_transactions）
   ↓
4. 前端显示成功提示，余额更新
```

---

## 📋 后端RPC函数

### 已使用的函数

| 函数名 | 用途 | 调用位置 |
|--------|------|---------|
| `get_partner_balance` | 获取货主余额 | 首页、充值页 |
| `get_partner_balance_transactions` | 获取余额流水 | 流水记录页 |
| `get_invoice_requests_filtered_1114` | 获取开票申请单列表 | 首页、待付款页 |
| `receive_invoice_payment_1114` | 登记收款（提交回单） | 提交回单页 |
| `manual_recharge_partner_balance` | 手动充值 | 充值页 |
| `get_user_notifications` | 获取用户通知 | 通知中心 |
| `get_unread_notification_count` | 获取未读通知数 | 布局组件 |

### 需要创建的函数

**无** - 所有需要的函数都已存在

---

## 🛣️ 路由配置

所有路由都在`src/App.tsx`中配置，路径前缀为`/m/shipper`：

- `/m/shipper` - 首页
- `/m/shipper/pending-payments` - 待付款列表
- `/m/shipper/pending-payments/:id` - 待付款详情
- `/m/shipper/recharge` - 充值
- `/m/shipper/submit-receipt` - 提交回单
- `/m/shipper/waybills` - 运单查询
- `/m/shipper/transactions` - 流水记录
- `/m/shipper/notifications` - 通知中心
- `/m/shipper/settings` - 设置

**注意**：货主移动端路由**不需要**`ProtectedRoute`包装，因为`ShipperMobileLayout`组件内部已经进行了权限检查。

---

## 📱 底部导航栏

底部导航栏显示前5个主要功能：
1. 首页
2. 待付款（带数量徽章）
3. 余额充值
4. 提交回单
5. 运单查询

其他功能（流水记录、通知、设置）通过侧边菜单访问。

---

## 🔔 通知集成

### 通知类型

- **收款提醒**：财务人员收到货主提交的回单后，系统自动创建通知
- **逾期提醒**：通过`send_receipt_reminders_1114`函数创建（定时任务）

### 通知显示

- 顶部导航栏显示未读数量徽章
- 侧边菜单显示未读数量徽章
- 点击进入通知中心查看详情

---

## ✅ 完成状态

- [x] 布局组件（ShipperMobileLayout）
- [x] 首页（看板）
- [x] 待付款列表和详情
- [x] 充值页面
- [x] 提交电子回单页面
- [x] 运单查询页面
- [x] 余额流水记录页面
- [x] 设置页面
- [x] 路由配置
- [x] 权限检查
- [x] 通知集成
- [x] UI美化

---

## 🚀 使用说明

### 货主用户登录

1. 使用`partner`角色且关联货主类型合作方的账号登录
2. 系统自动检测角色，如不符合要求，显示权限不足提示

### 主要操作流程

#### 查看待付款
1. 进入首页，查看待付款统计
2. 点击"查看待付款"或底部导航栏"待付款"
3. 查看待付款列表
4. 点击申请单查看详情

#### 提交电子回单
1. 在待付款列表或详情页点击"提交回单"
2. 或从首页"快速操作"进入
3. 选择/拍摄银行回单图片
4. 填写回单信息（金额自动填充）
5. 点击"提交电子回单"
6. 等待财务人员审核

#### 账户充值
1. 从首页点击"充值"按钮
2. 或从底部导航栏进入
3. 选择快速金额或输入自定义金额
4. 填写备注（可选）
5. 点击"确认充值"
6. 余额立即更新

#### 查看流水
1. 从首页点击"流水"按钮
2. 或从侧边菜单进入
3. 可选择日期范围筛选
4. 查看所有余额变动记录

---

## 📝 注意事项

1. **权限控制**：只有货主角色才能访问，其他角色会显示权限不足
2. **数据隔离**：货主只能查看自己关联的货主数据
3. **图片上传**：支持最多9张图片，建议使用清晰的照片
4. **金额校验**：提交回单时，系统会校验金额不能超过未收款金额
5. **通知机制**：提交回单后，财务人员会收到通知，需要审核

---

**最后更新**：2025-11-14  
**状态**：✅ 所有功能已完成

