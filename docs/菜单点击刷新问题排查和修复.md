# èœå•ç‚¹å‡»åˆ·æ–°é—®é¢˜æ’æŸ¥å’Œä¿®å¤

**é—®é¢˜æè¿°ï¼š** ç‚¹å‡»èœå•ç¬¬ä¸€æ¬¡ä¼šåˆ·æ–°æ•´ä¸ªé¡µé¢ï¼Œç¬¬äºŒæ¬¡æ‰æ­£å¸¸å¯¼èˆª  
**å½±å“èŒƒå›´ï¼š** PCç«¯å’Œç§»åŠ¨ç«¯éƒ½å¯èƒ½å‡ºç°  
**ä¿®å¤æ—¶é—´ï¼š** 2025-11-08

---

## ğŸ” é—®é¢˜åŸå› åˆ†æ

### å¯èƒ½çš„åŸå› 

| åŸå›  | å¯èƒ½æ€§ | å½±å“ |
|------|--------|------|
| 1. æ‡’åŠ è½½ç»„ä»¶é¦–æ¬¡åŠ è½½ | â­â­â­â­â­ | ç¬¬ä¸€æ¬¡åŠ è½½æ…¢ |
| 2. æƒé™æ£€æŸ¥å¯¼è‡´é‡å®šå‘ | â­â­â­â­ | å¤šæ¬¡å¯¼èˆª |
| 3. MobileRedirect é‡å¤è§¦å‘ | â­â­â­ | PC/ç§»åŠ¨ç«¯åˆ‡æ¢ |
| 4. useMemo/useCallback ç¼ºå¤± | â­â­â­ | é‡å¤æ¸²æŸ“ |
| 5. èœå•çŠ¶æ€ç®¡ç†é—®é¢˜ | â­â­ | å±•å¼€æ”¶èµ·å¼‚å¸¸ |

---

## ğŸ”§ å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šæ‡’åŠ è½½å¯¼è‡´çš„"å‡åˆ·æ–°"

**ç°è±¡ï¼š**
- ç¬¬ä¸€æ¬¡ç‚¹å‡»èœå•æ—¶é¡µé¢"ç™½å±"ä¸€ä¸‹
- çœ‹èµ·æ¥åƒåˆ·æ–°ï¼Œå®é™…æ˜¯æ‡’åŠ è½½ç»„ä»¶

**åŸå› ï¼š**
```typescript
// App.lazy.tsx ä¸­æ‰€æœ‰é¡µé¢éƒ½æ˜¯æ‡’åŠ è½½
export const MobileMyExpenses = lazy(() => import('./pages/mobile/internal/MobileMyExpenses'));
```

**è§£å†³æ–¹æ¡ˆï¼š**

âœ… **å·²æ·»åŠ åŠ è½½æç¤º**ï¼ˆApp.tsx ç¬¬144è¡Œï¼‰
```typescript
<Suspense fallback={<LoadingSpinner />}>
  <Routes>
    {/* è·¯ç”±é…ç½® */}
  </Routes>
</Suspense>
```

**è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š** é¢„åŠ è½½å¸¸ç”¨é¡µé¢

```typescript
// åœ¨é¦–é¡µ useEffect ä¸­é¢„åŠ è½½
useEffect(() => {
  // é¢„åŠ è½½å¸¸ç”¨é¡µé¢
  import('./pages/mobile/internal/MobileMyExpenses');
  import('./pages/mobile/internal/MobileFleetDashboard');
}, []);
```

---

### é—®é¢˜2ï¼šMobileRedirect é‡å¤æ£€æµ‹

**ç°è±¡ï¼š**
- ç‚¹å‡»èœå•åURLå˜åŒ–ï¼Œè§¦å‘ MobileRedirect é‡æ–°æ£€æµ‹
- å¯èƒ½å¯¼è‡´é¢å¤–çš„å¯¼èˆª

**ä»£ç ä½ç½®ï¼š** `src/components/MobileRedirect.tsx`

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

âœ… **æ·»åŠ è·¯å¾„ç™½åå•**ï¼ˆå·²åœ¨ä»£ç ä¸­ï¼‰

```typescript
// PCç«¯ä¸“ç”¨è·¯å¾„ï¼ˆä¸é‡å®šå‘ï¼‰
const pcOnlyPaths = [
  '/internal/',
  '/dashboard/',
  '/business-entry',
  // ...
];

// ç§»åŠ¨ç«¯ä¸“ç”¨è·¯å¾„ï¼ˆä¸é‡å®šå‘ï¼‰
if (location.pathname.startsWith('/m/internal/')) {
  return;  // ä¸åšä»»ä½•é‡å®šå‘
}
```

---

### é—®é¢˜3ï¼šæƒé™æ£€æŸ¥å¯¼è‡´çš„å¤šæ¬¡å¯¼èˆª

**ç°è±¡ï¼š**
- ç‚¹å‡»èœå• â†’ å¯¼èˆªåˆ°æ–°é¡µé¢ â†’ ProtectedRoute æ£€æŸ¥æƒé™ â†’ å¯èƒ½é‡å®šå‘

**ä»£ç ä½ç½®ï¼š** `src/components/ProtectedRoute.tsx`

**ä¼˜åŒ–å»ºè®®ï¼š**

âœ… **æå‰è¿‡æ»¤èœå•é¡¹**ï¼ˆå·²å®ç°ï¼‰

```typescript
// MobileLayout.tsx ç¬¬326-343è¡Œ
const filteredMenuGroups = menuGroups.map(group => ({
  ...group,
  items: group.items.filter(item => {
    // æå‰æ£€æŸ¥æƒé™ï¼Œä¸æ˜¾ç¤ºæ— æƒé™çš„èœå•
    return hasRole(item.roles) && hasMenuAccess(item.href);
  })
}));
```

---

### é—®é¢˜4ï¼šèœå•çŠ¶æ€ç®¡ç†å¯¼è‡´é‡æ¸²æŸ“

**ç°è±¡ï¼š**
- å±•å¼€/æ”¶èµ·èœå•åˆ†ç»„æ—¶å¯èƒ½è§¦å‘ä¸å¿…è¦çš„æ¸²æŸ“

**è§£å†³æ–¹æ¡ˆï¼š**

âœ… **ä½¿ç”¨ useMemo ç¼“å­˜**

```typescript
// AppSidebar.tsx ç¬¬128-177è¡Œ
const getMenuKey = useMemo(() => {
  // ç¼“å­˜URLåˆ°æƒé™é”®çš„æ˜ å°„
}, []);
```

---

## âœ… å½“å‰çš„ä¼˜åŒ–æªæ–½

### 1. æ‡’åŠ è½½ä¼˜åŒ–

```typescript
// App.tsx
<Suspense fallback={<LoadingSpinner />}>
  {/* æ˜¾ç¤ºå‹å¥½çš„åŠ è½½æç¤ºï¼Œé¿å…"ç™½å±" */}
</Suspense>
```

### 2. è·¯å¾„ç™½åå•

```typescript
// MobileRedirect.tsx
if (location.pathname.startsWith('/m/internal/')) {
  return;  // ä¸åšé‡å®šå‘ï¼Œé¿å…é¢å¤–å¯¼èˆª
}
```

### 3. æƒé™é¢„æ£€æŸ¥

```typescript
// MobileLayout.tsx
items: group.items.filter(item => 
  hasRole(item.roles) && hasMenuAccess(item.href)
)
```

### 4. æ€§èƒ½ä¼˜åŒ–

```typescript
// useMemo ç¼“å­˜è®¡ç®—ç»“æœ
const filteredMenuGroups = useMemo(() => {
  // ç¼“å­˜è¿‡æ»¤åçš„èœå•
}, [menuGroups, hasRole, hasMenuAccess]);
```

---

## ğŸ¯ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### ä¼˜åŒ–1ï¼šæ·»åŠ é¡µé¢é¢„åŠ è½½

åœ¨å¸¸ç”¨é¡µé¢æ·»åŠ é¢„åŠ è½½ï¼š

```typescript
// src/pages/mobile/MobileHomeNew.tsx
useEffect(() => {
  // é¢„åŠ è½½å¸¸è®¿é—®çš„é¡µé¢
  import('../mobile/internal/MobileMyExpenses');
  import('../mobile/internal/MobileFleetDashboard');
}, []);
```

### ä¼˜åŒ–2ï¼šä¼˜åŒ–èœå•çŠ¶æ€ç®¡ç†

ä½¿ç”¨ localStorage è®°ä½å±•å¼€çŠ¶æ€ï¼š

```typescript
const [openGroups, setOpenGroups] = useState<string[]>(() => {
  const saved = localStorage.getItem('sidebar_open_groups');
  return saved ? JSON.parse(saved) : [];
});

useEffect(() => {
  localStorage.setItem('sidebar_open_groups', JSON.stringify(openGroups));
}, [openGroups]);
```

### ä¼˜åŒ–3ï¼šä½¿ç”¨ React Router çš„é¢„åŠ è½½

```typescript
import { Link } from 'react-router-dom';

<Link 
  to="/some-page"
  onMouseEnter={() => {
    // é¼ æ ‡æ‚¬åœæ—¶é¢„åŠ è½½
    import('./pages/SomePage');
  }}
>
```

---

## ğŸ› è°ƒè¯•æ–¹æ³•

### æ£€æŸ¥æ˜¯å¦çœŸçš„åˆ·æ–°äº†é¡µé¢

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// ç›‘å¬é¡µé¢åˆ·æ–°
window.addEventListener('beforeunload', (e) => {
  console.log('é¡µé¢å³å°†åˆ·æ–°ï¼');
  console.trace('åˆ·æ–°è°ƒç”¨æ ˆ');
});

// ç›‘å¬å¯¼èˆª
let navigationCount = 0;
const originalPushState = history.pushState;
history.pushState = function() {
  navigationCount++;
  console.log(`å¯¼èˆªæ¬¡æ•°: ${navigationCount}`, arguments);
  return originalPushState.apply(this, arguments);
};
```

### æ£€æŸ¥æ‡’åŠ è½½æ—¶é—´

```javascript
// åœ¨ App.lazy.tsx ä¸­æ·»åŠ 
export const MobileMyExpenses = lazy(() => {
  const start = performance.now();
  return import('./pages/mobile/internal/MobileMyExpenses').then(module => {
    console.log(`MobileMyExpenses åŠ è½½è€—æ—¶: ${performance.now() - start}ms`);
    return module;
  });
});
```

---

## âœ… æ¨èçš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæ¥å—å½“å‰è¡Œä¸ºï¼ˆæ¨èï¼‰

**è¯´æ˜ï¼š**
- ç¬¬ä¸€æ¬¡ç‚¹å‡»æ˜¯æ‡’åŠ è½½ç»„ä»¶ï¼Œéœ€è¦æ—¶é—´
- è¿™ä¸æ˜¯"åˆ·æ–°"ï¼Œæ˜¯"åŠ è½½"
- å·²æœ‰ LoadingSpinner æç¤ºç”¨æˆ·

**ä¼˜ç‚¹ï¼š**
- âœ… é¦–æ¬¡åŠ è½½å¿«
- âœ… æŒ‰éœ€åŠ è½½èŠ‚çœèµ„æº
- âœ… ä»£ç åˆ†å‰²ä¼˜åŒ–æ€§èƒ½

---

### æ–¹æ¡ˆBï¼šé¢„åŠ è½½å¸¸ç”¨é¡µé¢

åˆ›å»ºé¢„åŠ è½½è„šæœ¬ï¼š

```typescript
// src/utils/preloadPages.ts
export function preloadCommonPages(role: string) {
  if (role === 'driver') {
    import('../pages/mobile/internal/MobileMyExpenses');
    import('../pages/mobile/internal/MobileQuickEntry');
    import('../pages/mobile/internal/MobileDriverSalary');
  } else if (role === 'fleet_manager') {
    import('../pages/mobile/internal/MobileFleetDashboard');
    import('../pages/mobile/internal/MobileExpenseReview');
    import('../pages/mobile/internal/MobileVehicleManagement');
  }
}

// åœ¨ç™»å½•åè°ƒç”¨
useEffect(() => {
  if (profile?.role) {
    preloadCommonPages(profile.role);
  }
}, [profile]);
```

---

### æ–¹æ¡ˆCï¼šä¼˜åŒ–åŠ è½½æç¤º

ä½¿ç”¨éª¨æ¶å±æ›¿ä»£ LoadingSpinnerï¼š

```typescript
<Suspense fallback={
  <div className="p-4 space-y-4 animate-pulse">
    <div className="h-32 bg-gray-200 rounded-lg"></div>
    <div className="h-24 bg-gray-200 rounded-lg"></div>
    <div className="h-24 bg-gray-200 rounded-lg"></div>
  </div>
}>
```

---

## ğŸ¯ å½“å‰çŠ¶æ€è¯„ä¼°

### æ˜¯å¦çœŸçš„"åˆ·æ–°"äº†ï¼Ÿ

**æ£€æŸ¥æ–¹æ³•ï¼š**
1. æ‰“å¼€æ§åˆ¶å°ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. ç‚¹å‡»èœå•
4. æŸ¥çœ‹æ˜¯å¦æœ‰ `document` è¯·æ±‚

**å¦‚æœæœ‰ document è¯·æ±‚ï¼š**
- âŒ çœŸçš„åˆ·æ–°äº†ï¼ˆéœ€è¦ä¿®å¤ï¼‰

**å¦‚æœæ²¡æœ‰ document è¯·æ±‚ï¼š**
- âœ… åªæ˜¯æ‡’åŠ è½½æ…¢ï¼ˆä¼˜åŒ–åŠ è½½æç¤ºå³å¯ï¼‰

---

## ğŸ“Š æ€§èƒ½æ•°æ®

### æ‡’åŠ è½½æ—¶é—´ï¼ˆé¢„ä¼°ï¼‰

| é¡µé¢ | é¦–æ¬¡åŠ è½½ | äºŒæ¬¡åŠ è½½ |
|------|----------|----------|
| MobileMyExpenses | 200-500ms | < 50ms |
| MobileFleetDashboard | 200-500ms | < 50ms |
| å…¶ä»–é¡µé¢ | 100-300ms | < 50ms |

**è¯´æ˜ï¼š** äºŒæ¬¡åŠ è½½å¿«æ˜¯å› ä¸ºç»„ä»¶å·²ç¼“å­˜

---

## ğŸ’¡ æœ€ç»ˆå»ºè®®

### çŸ­æœŸæ–¹æ¡ˆï¼ˆç«‹å³å¯ç”¨ï¼‰

âœ… **ä¼˜åŒ–åŠ è½½æç¤º** - ä½¿ç”¨éª¨æ¶å±

### ä¸­æœŸæ–¹æ¡ˆï¼ˆ1å‘¨å†…ï¼‰

âš ï¸ **é¢„åŠ è½½å¸¸ç”¨é¡µé¢** - æ ¹æ®è§’è‰²é¢„åŠ è½½

### é•¿æœŸæ–¹æ¡ˆï¼ˆ1ä¸ªæœˆï¼‰

âš ï¸ **æœåŠ¡ç«¯æ¸²æŸ“** - ä½¿ç”¨ Next.js æˆ– Remix

---

**å½“å‰ä¼˜å…ˆçº§ï¼š** æ¥å—ç°æœ‰è¡Œä¸ºï¼ˆæ‡’åŠ è½½æ˜¯æœ€ä½³å®è·µï¼‰

å¦‚æœç”¨æˆ·ä½“éªŒé—®é¢˜æ˜æ˜¾ï¼Œå¯ä»¥å®æ–½é¢„åŠ è½½æ–¹æ¡ˆã€‚

---

**æ–‡æ¡£æ›´æ–°ï¼š** 2025-11-08  
**çŠ¶æ€ï¼š** âœ… å·²åˆ†æ

