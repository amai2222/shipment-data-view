# 审核页面抖动优化说明

## 问题描述

用户反馈：打开**开票审核**和**付款审核**页面时，申请单列表会抖一下。

---

## 问题原因分析

### 1. 状态更新时机不当
在数据获取过程中，多次调用 `setState`：
```typescript
// 问题代码（PaymentAudit.tsx 旧版本）
setTotalRequestsCount(totalCount);  // 第1次状态更新
setTotalPages(totalPagesCount);     // 第2次状态更新
// ... 等待并行数据获取 ...
setRequests(requestsWithTotals);    // 第3次状态更新
```

**结果：** 页面渲染3次，导致抖动

### 2. useEffect 依赖过多导致重复执行
```typescript
// 问题代码
const fetchPaymentRequests = useCallback(async () => {
  // ...
}, [toast, filters, currentPage, pageSize, selectedShipperId, selectedProjectId, availableProjects]);

useEffect(() => { fetchPaymentRequests(); }, [fetchPaymentRequests]);
```

**问题：**
- `availableProjects` 在 `fetchProjects` 和 `ShipperProjectCascadeFilter` 中都会更新
- 每次 `availableProjects` 更新都会触发 `fetchPaymentRequests` 重新执行
- 页面初始化时可能触发多次加载

---

## 优化方案

### 1. 批量更新状态（减少重新渲染）

**优化前：**
```typescript
// 分别更新，导致多次渲染
setTotalRequestsCount(totalCount);
setTotalPages(totalPagesCount);
// ... 等待数据 ...
setRequests(requestsWithTotals);
```

**优化后：**
```typescript
// 先计算所有值
const totalCount = requestsData[0]?.total_count || 0;
const totalPagesCount = Math.ceil(totalCount / pageSize);
const requestsWithTotals = await Promise.all(...);

// 批量更新所有状态
setRequests(requestsWithTotals);
setTotalRequestsCount(totalCount);
setTotalPages(totalPagesCount);
```

**效果：** 页面只渲染1次，消除抖动

### 2. 优化 useEffect 依赖（减少重复执行）

**优化前：**
```typescript
useEffect(() => { fetchPaymentRequests(); }, [fetchPaymentRequests]);
// fetchPaymentRequests 依赖 availableProjects，导致重复执行
```

**优化后：**
```typescript
// 直接依赖真正需要触发重新加载的变量
useEffect(() => { 
  fetchPaymentRequests(); 
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [filters, currentPage, pageSize, selectedShipperId, selectedProjectId]);
```

**效果：** 只在真正需要时加载数据，避免重复

---

## 已优化的页面

### 1. PaymentAudit.tsx（付款审核）
✅ **优化内容：**
- 批量更新状态（setRequests, setTotalRequestsCount, setTotalPages 一起更新）
- 优化 useEffect 依赖（移除 availableProjects 触发）

### 2. InvoiceAudit.tsx（开票审核）
✅ **优化内容：**
- 批量更新状态
- 优化 useEffect 依赖（移除 availableProjects 触发）

---

## 其他可能的抖动原因（已排除）

### ❌ 不是表格骨架屏的问题
- 两个页面都已经添加了 `TableSkeleton`
- 骨架屏正确匹配了表格列数

### ❌ 不是权限加载的问题
- `permissionsLoading` 不影响主表格渲染

### ❌ 不是 ShipperProjectCascadeFilter 的问题
- 该组件本身不会导致布局变化
- 只是会触发 `availableProjects` 更新

---

## 优化效果

**优化前：**
1. 页面加载 → 骨架屏
2. 项目加载完成 → availableProjects 更新 → 重新加载数据
3. 申请单列表返回 → 更新 totalCount 和 totalPages → 渲染1次
4. 详细数据返回 → 更新 requests → 渲染2次
5. **总共可能渲染 3-4 次，明显抖动**

**优化后：**
1. 页面加载 → 骨架屏
2. 数据加载完成 → 批量更新所有状态 → 渲染1次
3. **只渲染 1 次，无抖动**

---

## 验证方法

1. 打开**付款审核**页面
2. 观察申请单列表是否还会抖动
3. 打开**开票审核**页面
4. 观察申请单列表是否还会抖动

**预期效果：** 页面加载流畅，无抖动

---

**创建日期：** 2025-11-20  
**优化状态：** ✅ 已完成

