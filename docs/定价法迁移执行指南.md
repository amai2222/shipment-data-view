# å®šä»·æ³•è¿ç§»æ‰§è¡ŒæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—æä¾›äº†å®Œæ•´çš„æ•°æ®åº“è¿ç§»æ‰§è¡Œæ­¥éª¤ï¼Œç”¨äºæ·»åŠ å®šä»·æ³•åŠŸèƒ½å¹¶æ›´æ–°æ‰€æœ‰é‡ç®—å‡½æ•°ä¸º _1120 ç‰ˆæœ¬ã€‚

**æ‰§è¡Œæ—¶é—´**ï¼šçº¦ 5-10 åˆ†é’Ÿ  
**å½±å“èŒƒå›´**ï¼šé¡¹ç›®åˆä½œæ–¹é…ç½®ã€è¿å•æˆæœ¬è®¡ç®—  
**å…¼å®¹æ€§**ï¼šå‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

---

## ğŸš€ å¿«é€Ÿæ‰§è¡Œï¼ˆæ¨èï¼‰

### ä½¿ç”¨ Supabase CLI

```bash
cd C:\Users\admin\Desktop\ä¸­ç§‘ç‰©æµè·Ÿè¸ªç³»ç»Ÿé€»è¾‘\github\shipment-data-view
supabase db push
```

è¿™å°†è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æœªåº”ç”¨çš„è¿ç§»æ–‡ä»¶ã€‚

---

## ğŸ“ æ‰‹åŠ¨æ‰§è¡Œï¼ˆSupabase SQL Editorï¼‰

å¦‚æœä½ preferæ‰‹åŠ¨æ‰§è¡Œï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºåœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

### ç¬¬ä¸€æ­¥ï¼šæ·»åŠ åŸºç¡€å­—æ®µå’Œçº¦æŸ

**æ–‡ä»¶**ï¼š`20251120_add_fixed_price_calculation_method.sql`

**åŠŸèƒ½**ï¼š
- æ·»åŠ  `project_partners.unit_price` å­—æ®µ
- æ›´æ–° `calculation_method` çº¦æŸï¼Œæ”¯æŒ `fixed_price`

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥å­—æ®µæ˜¯å¦æ·»åŠ æˆåŠŸ
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'project_partners' 
AND column_name = 'unit_price';

-- æ£€æŸ¥çº¦æŸæ˜¯å¦æ›´æ–°æˆåŠŸ
SELECT constraint_name, check_clause
FROM information_schema.check_constraints
WHERE constraint_name = 'check_calculation_method';
```

---

### ç¬¬äºŒæ­¥ï¼šæ›´æ–°æ ¸å¿ƒé‡ç®—å‡½æ•°

**æ–‡ä»¶**ï¼š`20251120_update_recalculate_functions_support_fixed_price.sql`

**åŠŸèƒ½**ï¼š
- æ›´æ–° `batch_recalculate_partner_costs`ï¼ˆæ·»åŠ  fixed_price æ”¯æŒï¼‰
- æ›´æ–° `auto_recalc_on_payable_cost_change`ï¼ˆæ·»åŠ  fixed_price æ”¯æŒï¼‰

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
SELECT proname, prosrc 
FROM pg_proc 
WHERE proname IN (
    'batch_recalculate_partner_costs',
    'auto_recalc_on_payable_cost_change'
);
```

---

### ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ æœ‰æ•ˆæ•°é‡å˜åŒ–è§¦å‘å™¨

**æ–‡ä»¶**ï¼š`20251120_add_trigger_recalc_on_effective_quantity_change.sql`

**åŠŸèƒ½**ï¼š
- åˆ›å»º `auto_recalc_on_effective_quantity_or_cost_change` å‡½æ•°
- åˆ›å»º `trigger_recalc_on_effective_quantity_or_cost_change` è§¦å‘å™¨

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥è§¦å‘å™¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT tgname, tgrelid::regclass, tgtype
FROM pg_trigger
WHERE tgname = 'trigger_recalc_on_effective_quantity_or_cost_change';
```

---

### ç¬¬å››æ­¥ï¼šæ›´æ–°é“¾è·¯ç›¸å…³é‡ç®—å‡½æ•°

**æ–‡ä»¶**ï¼š`20251120_update_all_recalc_functions_to_1120_with_fixed_price.sql`

**åŠŸèƒ½**ï¼š
- åˆ›å»º `recalculate_costs_for_chain_1120`
- åˆ›å»º `recalculate_costs_for_chain_safe_1120`
- åˆ›å»º `recalculate_costs_for_project_1120`
- åˆ›å»º `auto_recalc_on_project_partner_change_1120`
- æ›´æ–° `trigger_auto_recalc_partner_costs`

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥å‡½æ•°æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT proname 
FROM pg_proc 
WHERE proname LIKE '%_1120';
```

---

### ç¬¬äº”æ­¥ï¼šæ›´æ–°ç‰¹æ®Šæ“ä½œå‡½æ•°

**æ–‡ä»¶**ï¼š`20251120_update_modify_and_batch_filter_to_1120.sql`

**åŠŸèƒ½**ï¼š
- åˆ›å»º `modify_logistics_record_chain_with_recalc_1120`
- åˆ›å»º `batch_recalculate_by_filter_1120`

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥å‡½æ•°æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT proname 
FROM pg_proc 
WHERE proname IN (
    'modify_logistics_record_chain_with_recalc_1120',
    'batch_recalculate_by_filter_1120'
);
```

---

## âœ… å…¨é¢éªŒè¯

æ‰§è¡Œå®Œæ‰€æœ‰è¿ç§»åï¼Œè¿è¡Œä»¥ä¸‹æŸ¥è¯¢è¿›è¡Œå…¨é¢éªŒè¯ï¼š

### 1. æ£€æŸ¥å­—æ®µ

```sql
-- æ£€æŸ¥ project_partners è¡¨å­—æ®µ
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'project_partners'
AND column_name IN ('unit_price', 'calculation_method')
ORDER BY ordinal_position;
```

**é¢„æœŸç»“æœ**ï¼š
- `unit_price`ï¼šNUMERIC(10,2)ï¼Œå¯ä¸º NULL
- `calculation_method`ï¼šTEXTï¼Œå¯ä¸º NULL

### 2. æ£€æŸ¥çº¦æŸ

```sql
-- æ£€æŸ¥ calculation_method çº¦æŸ
SELECT 
    conname AS constraint_name,
    pg_get_constraintdef(oid) AS constraint_definition
FROM pg_constraint
WHERE conname = 'check_calculation_method';
```

**é¢„æœŸç»“æœ**ï¼š
- çº¦æŸåº”åŒ…å« `'tax'`, `'profit'`, `'fixed_price'`

### 3. æ£€æŸ¥å‡½æ•°

```sql
-- æ£€æŸ¥æ‰€æœ‰ _1120 å‡½æ•°
SELECT 
    proname AS function_name,
    pronargs AS num_args,
    obj_description(oid) AS description
FROM pg_proc
WHERE proname LIKE '%1120%'
OR proname IN (
    'batch_recalculate_partner_costs',
    'auto_recalc_on_payable_cost_change',
    'auto_recalc_on_effective_quantity_or_cost_change'
)
ORDER BY proname;
```

**é¢„æœŸç»“æœ**ï¼šåº”è‡³å°‘åŒ…å«ä»¥ä¸‹å‡½æ•°
- `auto_recalc_on_effective_quantity_or_cost_change`
- `auto_recalc_on_payable_cost_change`
- `auto_recalc_on_project_partner_change_1120`
- `batch_recalculate_by_filter_1120`
- `batch_recalculate_partner_costs`
- `modify_logistics_record_chain_with_recalc_1120`
- `recalculate_costs_for_chain_1120`
- `recalculate_costs_for_chain_safe_1120`
- `recalculate_costs_for_project_1120`

### 4. æ£€æŸ¥è§¦å‘å™¨

```sql
-- æ£€æŸ¥æ‰€æœ‰é‡ç®—ç›¸å…³è§¦å‘å™¨
SELECT 
    tgname AS trigger_name,
    tgrelid::regclass AS table_name,
    CASE 
        WHEN tgtype & 2 = 2 THEN 'BEFORE'
        WHEN tgtype & 4 = 4 THEN 'INSTEAD OF'
        ELSE 'AFTER'
    END AS timing,
    CASE 
        WHEN tgtype & 4 = 4 THEN 'INSERT'
        WHEN tgtype & 8 = 8 THEN 'DELETE'
        WHEN tgtype & 16 = 16 THEN 'UPDATE'
        WHEN tgtype & 32 = 32 THEN 'TRUNCATE'
    END AS event
FROM pg_trigger
WHERE tgname LIKE '%recalc%'
ORDER BY tgname;
```

**é¢„æœŸç»“æœ**ï¼šåº”è‡³å°‘åŒ…å«ä»¥ä¸‹è§¦å‘å™¨
- `trigger_auto_recalc_partner_costs`ï¼ˆé¡¹ç›®åˆä½œæ–¹å˜æ›´ï¼‰
- `trigger_recalc_on_payable_cost_change`ï¼ˆåŸºç¡€è¿ä»·æ”¹å˜ï¼‰
- `trigger_recalc_on_effective_quantity_or_cost_change`ï¼ˆæœ‰æ•ˆæ•°é‡æ”¹å˜ï¼‰

---

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

### æµ‹è¯• 1ï¼šåˆ›å»ºå®šä»·æ³•åˆä½œæ–¹

```sql
-- 1. åˆ›å»ºæµ‹è¯•é¡¹ç›®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
-- 2. åˆ›å»ºæµ‹è¯•é“¾è·¯ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
-- 3. æ·»åŠ å®šä»·æ³•åˆä½œæ–¹
INSERT INTO project_partners (
    project_id,
    chain_id,
    partner_id,
    level,
    calculation_method,
    unit_price,
    tax_rate
) VALUES (
    'your-project-id',
    'your-chain-id',
    'your-partner-id',
    1,
    'fixed_price',
    10.00,
    0.0
);
```

**é¢„æœŸ**ï¼šæ’å…¥æˆåŠŸï¼Œæ— é”™è¯¯

### æµ‹è¯• 2ï¼šé‡ç®—å®šä»·æ³•æˆæœ¬

```sql
-- è°ƒç”¨æ‰¹é‡é‡ç®—å‡½æ•°
SELECT batch_recalculate_partner_costs(
    ARRAY['your-record-id']::UUID[]
);
```

**é¢„æœŸ**ï¼š
- è¿”å›æˆåŠŸ JSON
- `logistics_partner_costs` è¡¨ä¸­åº”æœ‰è®¡ç®—ç»“æœ
- `payable_amount = effective_quantity * unit_price`

### æµ‹è¯• 3ï¼šè§¦å‘å™¨è‡ªåŠ¨é‡ç®—

```sql
-- ä¿®æ”¹æœ‰æ•ˆæ•°é‡
UPDATE logistics_records
SET effective_quantity = 25
WHERE id = 'your-record-id';

-- æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨é‡ç®—
SELECT * FROM logistics_partner_costs
WHERE logistics_record_id = 'your-record-id'
AND calculation_method = 'fixed_price';
```

**é¢„æœŸ**ï¼š
- `payable_amount` åº”æ›´æ–°ä¸º `25 * unit_price`

---

## ğŸ”„ å›æ»šè®¡åˆ’ï¼ˆå¦‚éœ€è¦ï¼‰

å¦‚æœéœ€è¦å›æ»šï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

### å›æ»šæ­¥éª¤ 1ï¼šåˆ é™¤è§¦å‘å™¨

```sql
DROP TRIGGER IF EXISTS trigger_recalc_on_effective_quantity_or_cost_change ON logistics_records;
```

### å›æ»šæ­¥éª¤ 2ï¼šåˆ é™¤ _1120 å‡½æ•°

```sql
DROP FUNCTION IF EXISTS recalculate_costs_for_chain_1120(UUID, UUID);
DROP FUNCTION IF EXISTS recalculate_costs_for_chain_safe_1120(UUID, UUID, BOOLEAN);
DROP FUNCTION IF EXISTS recalculate_costs_for_project_1120(UUID);
DROP FUNCTION IF EXISTS auto_recalc_on_project_partner_change_1120();
DROP FUNCTION IF EXISTS modify_logistics_record_chain_with_recalc_1120(UUID, TEXT);
DROP FUNCTION IF EXISTS batch_recalculate_by_filter_1120(TEXT, DATE, DATE, UUID);
DROP FUNCTION IF EXISTS auto_recalc_on_effective_quantity_or_cost_change();
```

### å›æ»šæ­¥éª¤ 3ï¼šæ¢å¤çº¦æŸ

```sql
ALTER TABLE project_partners
DROP CONSTRAINT IF EXISTS check_calculation_method;

ALTER TABLE project_partners
ADD CONSTRAINT check_calculation_method 
CHECK (calculation_method IN ('tax', 'profit'));
```

### å›æ»šæ­¥éª¤ 4ï¼šåˆ é™¤å­—æ®µ

```sql
ALTER TABLE project_partners
DROP COLUMN IF EXISTS unit_price;
```

---

## ğŸ“ æ”¯æŒä¸åé¦ˆ

å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

1. **SQL è¯­æ³•é”™è¯¯**ï¼šæ£€æŸ¥ Supabase SQL Editor çš„é”™è¯¯ä¿¡æ¯
2. **å‡½æ•°ä¸å­˜åœ¨**ï¼šç¡®ä¿æŒ‰é¡ºåºæ‰§è¡Œäº†æ‰€æœ‰è¿ç§»æ–‡ä»¶
3. **è§¦å‘å™¨æœªç”Ÿæ•ˆ**ï¼šæ£€æŸ¥è§¦å‘å™¨æ˜¯å¦æ­£ç¡®åˆ›å»º
4. **æ•°æ®æœªæ›´æ–°**ï¼šæ£€æŸ¥ä¿æŠ¤æœºåˆ¶ï¼ˆå·²ä»˜æ¬¾/å·²å¼€ç¥¨/å·²æ”¶æ¬¾è¿å•ä¸ä¼šé‡ç®—ï¼‰

---

**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-20  
**æœ€åæ›´æ–°**ï¼š2025-11-20  
**çŠ¶æ€**ï¼šâœ… æ‰§è¡ŒæŒ‡å—å·²å®Œæˆ

