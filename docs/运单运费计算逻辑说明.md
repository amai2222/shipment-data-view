# 运单运费计算逻辑说明

## 📋 概述

本文档详细说明了运单录入时的运费计算逻辑以及运费对账的计算机制。

## 🚛 运单录入计算逻辑

### 1. 基础运费计算

#### 运单录入时的字段：
- **当前费用** (`current_cost`): 司机基础运费
- **额外费用** (`extra_cost`): 额外产生的费用（如过路费、油费等）
- **应付费用** (`payable_cost`): 司机应收总金额

#### 计算公式：
```typescript
payable_cost = current_cost + extra_cost
```

#### 代码实现：
```typescript
// 在 LogisticsFormDialog.tsx 中
payable_cost: (parseFloat(formData.currentCost) || 0) + (parseFloat(formData.extraCost) || 0)
```

### 2. 重量计算逻辑

#### 有效重量计算：
```sql
effective_weight = COALESCE(
    NULLIF(LEAST(
        COALESCE(loading_weight, 999999), 
        COALESCE(unloading_weight, 999999)
    ), 999999),
    COALESCE(loading_weight, unloading_weight, 0)
)
```

#### 逻辑说明：
1. 取装货重量和卸货重量中的较小值
2. 如果其中一个为空，取另一个值
3. 如果都为空，取0

## 💰 运费对账计算逻辑

### 1. 合作方成本计算

运费对账的核心是计算每个合作方的应付款项，支持两种计算方法：

#### 方法一：税点法 (tax_rate)
```sql
payable_amount = base_amount / (1 - tax_rate)
```

#### 方法二：利润法 (profit_rate)
```sql
-- 如果有有效重量
payable_amount = base_amount + (profit_rate * effective_weight)

-- 如果没有有效重量
payable_amount = base_amount + profit_rate
```

### 2. 计算流程

#### 步骤1：获取运单基础数据
```sql
base_payable_amount = current_cost + extra_cost
effective_weight = 计算有效重量
```

#### 步骤2：获取合作方信息
```sql
-- 按级别顺序获取项目的合作方
SELECT 
  pp.partner_id,
  p.name as partner_name,
  pp.level,
  pp.tax_rate,
  pp.calculation_method,
  pp.profit_rate
FROM project_partners pp
JOIN partners p ON pp.partner_id = p.id
WHERE pp.project_id = ? AND pp.chain_id = ?
ORDER BY pp.level ASC
```

#### 步骤3：计算每个合作方的应付款
```sql
CASE
    WHEN calculation_method = 'profit' THEN
        CASE
            WHEN effective_weight > 0 THEN
                base_amount + (profit_rate * effective_weight)
            ELSE
                base_amount + profit_rate
        END
    ELSE -- 默认为税点法
        CASE
            WHEN tax_rate IS NOT NULL AND tax_rate <> 1 THEN
                base_amount / (1 - tax_rate)
            ELSE
                base_amount
        END
END AS payable_amount
```

### 3. 实际计算示例

#### 示例1：税点法计算
```
基础运费: 1000元
税点: 0.1 (10%)
应付款 = 1000 / (1 - 0.1) = 1000 / 0.9 = 1111.11元
```

#### 示例2：利润法计算
```
基础运费: 1000元
有效重量: 10吨
利润率: 50元/吨
应付款 = 1000 + (50 * 10) = 1000 + 500 = 1500元
```

#### 示例3：多级合作方计算
```
项目合作方配置：
- 一级合作方A: 税点法, 税点10%
- 二级合作方B: 利润法, 利润率30元/吨

运单数据：
- 基础运费: 1000元
- 有效重量: 10吨

计算结果：
- 合作方A应付款: 1000 / (1 - 0.1) = 1111.11元
- 合作方B应付款: 1000 + (30 * 10) = 1300元
```

## 🔄 对账流程

### 1. 数据获取
```typescript
// 调用数据库函数获取对账数据
const { data, error } = await supabase.rpc('get_finance_reconciliation_by_partner', {
  p_project_id: projectId,
  p_start_date: startDate,
  p_end_date: endDate,
  p_partner_id: partnerId,
  p_page_number: pageNumber,
  p_page_size: pageSize
});
```

### 2. 数据展示
- 按合作方分组显示
- 显示每个运单的详细费用信息
- 汇总每个合作方的总应付款

### 3. 批量操作
- 支持批量重新计算费用
- 支持批量导出Excel
- 支持批量生成付款申请

## 📊 关键数据表

### 1. logistics_records (运单记录表)
```sql
- id: 运单ID
- current_cost: 当前费用
- extra_cost: 额外费用
- payable_cost: 应付费用
- loading_weight: 装货重量
- unloading_weight: 卸货重量
- project_id: 项目ID
- chain_id: 合作方链ID
```

### 2. project_partners (项目合作方表)
```sql
- project_id: 项目ID
- partner_id: 合作方ID
- chain_id: 合作方链ID
- level: 级别
- tax_rate: 税点
- calculation_method: 计算方法 (tax_rate/profit)
- profit_rate: 利润率
```

### 3. logistics_partner_costs (合作方成本表)
```sql
- logistics_record_id: 运单ID
- partner_id: 合作方ID
- level: 级别
- base_amount: 基础金额
- payable_amount: 应付款金额
- tax_rate: 税率
```

## 🎯 计算逻辑总结

1. **运单录入**：基础运费 + 额外费用 = 司机应收
2. **对账计算**：根据合作方配置的计算方法，计算每个合作方的应付款
3. **税点法**：基础金额 ÷ (1 - 税点)
4. **利润法**：基础金额 + (利润率 × 有效重量)
5. **多级计算**：每个合作方独立计算，基于原始基础金额

这套计算逻辑确保了运费计算的准确性和灵活性，支持不同的业务场景和合作方需求。
