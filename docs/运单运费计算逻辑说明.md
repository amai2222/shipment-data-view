# è¿å•è¿è´¹è®¡ç®—é€»è¾‘è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†è¿å•å½•å…¥æ—¶çš„è¿è´¹è®¡ç®—é€»è¾‘ä»¥åŠè¿è´¹å¯¹è´¦çš„è®¡ç®—æœºåˆ¶ã€‚

## ğŸš› è¿å•å½•å…¥è®¡ç®—é€»è¾‘

### 1. åŸºç¡€è¿è´¹è®¡ç®—

#### è¿å•å½•å…¥æ—¶çš„å­—æ®µï¼š
- **å½“å‰è´¹ç”¨** (`current_cost`): å¸æœºåŸºç¡€è¿è´¹
- **é¢å¤–è´¹ç”¨** (`extra_cost`): é¢å¤–äº§ç”Ÿçš„è´¹ç”¨ï¼ˆå¦‚è¿‡è·¯è´¹ã€æ²¹è´¹ç­‰ï¼‰
- **åº”ä»˜è´¹ç”¨** (`payable_cost`): å¸æœºåº”æ”¶æ€»é‡‘é¢

#### è®¡ç®—å…¬å¼ï¼š
```typescript
payable_cost = current_cost + extra_cost
```

#### ä»£ç å®ç°ï¼š
```typescript
// åœ¨ LogisticsFormDialog.tsx ä¸­
payable_cost: (parseFloat(formData.currentCost) || 0) + (parseFloat(formData.extraCost) || 0)
```

### 2. é‡é‡è®¡ç®—é€»è¾‘

#### æœ‰æ•ˆé‡é‡è®¡ç®—ï¼š
```sql
effective_weight = COALESCE(
    NULLIF(LEAST(
        COALESCE(loading_weight, 999999), 
        COALESCE(unloading_weight, 999999)
    ), 999999),
    COALESCE(loading_weight, unloading_weight, 0)
)
```

#### é€»è¾‘è¯´æ˜ï¼š
1. å–è£…è´§é‡é‡å’Œå¸è´§é‡é‡ä¸­çš„è¾ƒå°å€¼
2. å¦‚æœå…¶ä¸­ä¸€ä¸ªä¸ºç©ºï¼Œå–å¦ä¸€ä¸ªå€¼
3. å¦‚æœéƒ½ä¸ºç©ºï¼Œå–0

## ğŸ’° è¿è´¹å¯¹è´¦è®¡ç®—é€»è¾‘

### 1. åˆä½œæ–¹æˆæœ¬è®¡ç®—

è¿è´¹å¯¹è´¦çš„æ ¸å¿ƒæ˜¯è®¡ç®—æ¯ä¸ªåˆä½œæ–¹çš„åº”ä»˜æ¬¾é¡¹ï¼Œæ”¯æŒä¸¤ç§è®¡ç®—æ–¹æ³•ï¼š

#### æ–¹æ³•ä¸€ï¼šç¨ç‚¹æ³• (tax_rate)
```sql
payable_amount = base_amount / (1 - tax_rate)
```

#### æ–¹æ³•äºŒï¼šåˆ©æ¶¦æ³• (profit_rate)
```sql
-- å¦‚æœæœ‰æœ‰æ•ˆé‡é‡
payable_amount = base_amount + (profit_rate * effective_weight)

-- å¦‚æœæ²¡æœ‰æœ‰æ•ˆé‡é‡
payable_amount = base_amount + profit_rate
```

### 2. è®¡ç®—æµç¨‹

#### æ­¥éª¤1ï¼šè·å–è¿å•åŸºç¡€æ•°æ®
```sql
base_payable_amount = current_cost + extra_cost
effective_weight = è®¡ç®—æœ‰æ•ˆé‡é‡
```

#### æ­¥éª¤2ï¼šè·å–åˆä½œæ–¹ä¿¡æ¯
```sql
-- æŒ‰çº§åˆ«é¡ºåºè·å–é¡¹ç›®çš„åˆä½œæ–¹
SELECT 
  pp.partner_id,
  p.name as partner_name,
  pp.level,
  pp.tax_rate,
  pp.calculation_method,
  pp.profit_rate
FROM project_partners pp
JOIN partners p ON pp.partner_id = p.id
WHERE pp.project_id = ? AND pp.chain_id = ?
ORDER BY pp.level ASC
```

#### æ­¥éª¤3ï¼šè®¡ç®—æ¯ä¸ªåˆä½œæ–¹çš„åº”ä»˜æ¬¾
```sql
CASE
    WHEN calculation_method = 'profit' THEN
        CASE
            WHEN effective_weight > 0 THEN
                base_amount + (profit_rate * effective_weight)
            ELSE
                base_amount + profit_rate
        END
    ELSE -- é»˜è®¤ä¸ºç¨ç‚¹æ³•
        CASE
            WHEN tax_rate IS NOT NULL AND tax_rate <> 1 THEN
                base_amount / (1 - tax_rate)
            ELSE
                base_amount
        END
END AS payable_amount
```

### 3. å®é™…è®¡ç®—ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šç¨ç‚¹æ³•è®¡ç®—
```
åŸºç¡€è¿è´¹: 1000å…ƒ
ç¨ç‚¹: 0.1 (10%)
åº”ä»˜æ¬¾ = 1000 / (1 - 0.1) = 1000 / 0.9 = 1111.11å…ƒ
```

#### ç¤ºä¾‹2ï¼šåˆ©æ¶¦æ³•è®¡ç®—
```
åŸºç¡€è¿è´¹: 1000å…ƒ
æœ‰æ•ˆé‡é‡: 10å¨
åˆ©æ¶¦ç‡: 50å…ƒ/å¨
åº”ä»˜æ¬¾ = 1000 + (50 * 10) = 1000 + 500 = 1500å…ƒ
```

#### ç¤ºä¾‹3ï¼šå¤šçº§åˆä½œæ–¹è®¡ç®—
```
é¡¹ç›®åˆä½œæ–¹é…ç½®ï¼š
- ä¸€çº§åˆä½œæ–¹A: ç¨ç‚¹æ³•, ç¨ç‚¹10%
- äºŒçº§åˆä½œæ–¹B: åˆ©æ¶¦æ³•, åˆ©æ¶¦ç‡30å…ƒ/å¨

è¿å•æ•°æ®ï¼š
- åŸºç¡€è¿è´¹: 1000å…ƒ
- æœ‰æ•ˆé‡é‡: 10å¨

è®¡ç®—ç»“æœï¼š
- åˆä½œæ–¹Aåº”ä»˜æ¬¾: 1000 / (1 - 0.1) = 1111.11å…ƒ
- åˆä½œæ–¹Båº”ä»˜æ¬¾: 1000 + (30 * 10) = 1300å…ƒ
```

## ğŸ”„ å¯¹è´¦æµç¨‹

### 1. æ•°æ®è·å–
```typescript
// è°ƒç”¨æ•°æ®åº“å‡½æ•°è·å–å¯¹è´¦æ•°æ®
const { data, error } = await supabase.rpc('get_finance_reconciliation_by_partner', {
  p_project_id: projectId,
  p_start_date: startDate,
  p_end_date: endDate,
  p_partner_id: partnerId,
  p_page_number: pageNumber,
  p_page_size: pageSize
});
```

### 2. æ•°æ®å±•ç¤º
- æŒ‰åˆä½œæ–¹åˆ†ç»„æ˜¾ç¤º
- æ˜¾ç¤ºæ¯ä¸ªè¿å•çš„è¯¦ç»†è´¹ç”¨ä¿¡æ¯
- æ±‡æ€»æ¯ä¸ªåˆä½œæ–¹çš„æ€»åº”ä»˜æ¬¾

### 3. æ‰¹é‡æ“ä½œ
- æ”¯æŒæ‰¹é‡é‡æ–°è®¡ç®—è´¹ç”¨
- æ”¯æŒæ‰¹é‡å¯¼å‡ºExcel
- æ”¯æŒæ‰¹é‡ç”Ÿæˆä»˜æ¬¾ç”³è¯·

## ğŸ“Š å…³é”®æ•°æ®è¡¨

### 1. logistics_records (è¿å•è®°å½•è¡¨)
```sql
- id: è¿å•ID
- current_cost: å½“å‰è´¹ç”¨
- extra_cost: é¢å¤–è´¹ç”¨
- payable_cost: åº”ä»˜è´¹ç”¨
- loading_weight: è£…è´§é‡é‡
- unloading_weight: å¸è´§é‡é‡
- project_id: é¡¹ç›®ID
- chain_id: åˆä½œæ–¹é“¾ID
```

### 2. project_partners (é¡¹ç›®åˆä½œæ–¹è¡¨)
```sql
- project_id: é¡¹ç›®ID
- partner_id: åˆä½œæ–¹ID
- chain_id: åˆä½œæ–¹é“¾ID
- level: çº§åˆ«
- tax_rate: ç¨ç‚¹
- calculation_method: è®¡ç®—æ–¹æ³• (tax_rate/profit)
- profit_rate: åˆ©æ¶¦ç‡
```

### 3. logistics_partner_costs (åˆä½œæ–¹æˆæœ¬è¡¨)
```sql
- logistics_record_id: è¿å•ID
- partner_id: åˆä½œæ–¹ID
- level: çº§åˆ«
- base_amount: åŸºç¡€é‡‘é¢
- payable_amount: åº”ä»˜æ¬¾é‡‘é¢
- tax_rate: ç¨ç‡
```

## ğŸ¯ è®¡ç®—é€»è¾‘æ€»ç»“

1. **è¿å•å½•å…¥**ï¼šåŸºç¡€è¿è´¹ + é¢å¤–è´¹ç”¨ = å¸æœºåº”æ”¶
2. **å¯¹è´¦è®¡ç®—**ï¼šæ ¹æ®åˆä½œæ–¹é…ç½®çš„è®¡ç®—æ–¹æ³•ï¼Œè®¡ç®—æ¯ä¸ªåˆä½œæ–¹çš„åº”ä»˜æ¬¾
3. **ç¨ç‚¹æ³•**ï¼šåŸºç¡€é‡‘é¢ Ã· (1 - ç¨ç‚¹)
4. **åˆ©æ¶¦æ³•**ï¼šåŸºç¡€é‡‘é¢ + (åˆ©æ¶¦ç‡ Ã— æœ‰æ•ˆé‡é‡)
5. **å¤šçº§è®¡ç®—**ï¼šæ¯ä¸ªåˆä½œæ–¹ç‹¬ç«‹è®¡ç®—ï¼ŒåŸºäºåŸå§‹åŸºç¡€é‡‘é¢

è¿™å¥—è®¡ç®—é€»è¾‘ç¡®ä¿äº†è¿è´¹è®¡ç®—çš„å‡†ç¡®æ€§å’Œçµæ´»æ€§ï¼Œæ”¯æŒä¸åŒçš„ä¸šåŠ¡åœºæ™¯å’Œåˆä½œæ–¹éœ€æ±‚ã€‚
