# 多装多卸功能回滚指南

## 概述

本文档提供了多装多卸功能的完整回滚方案，包括快速回滚、完全回滚和分步回滚等多种选项，确保在出现问题时能够安全、快速地恢复到原始状态。

## 回滚前准备

### 1. 数据备份
```sql
-- 备份重要数据表
CREATE TABLE logistics_records_backup AS SELECT * FROM public.logistics_records;
CREATE TABLE projects_backup AS SELECT * FROM public.projects;
CREATE TABLE drivers_backup AS SELECT * FROM public.drivers;
CREATE TABLE partner_chains_backup AS SELECT * FROM public.partner_chains;
```

### 2. 确认回滚范围
- [ ] 只回滚新函数（推荐）
- [ ] 回滚数据库字段（会丢失数据）
- [ ] 清理测试数据
- [ ] 前端代码回滚

## 回滚方案

### 方案一：快速回滚（推荐）

**适用场景**：需要快速恢复功能，保留数据

**执行步骤**：
1. 在Supabase后台执行回滚脚本
2. 验证原有功能正常
3. 前端继续使用原有单地点功能

**回滚脚本**：
```sql
-- 执行 scripts/rollback-multi-location-functions-v2.sql
-- 删除所有 _v2 后缀的函数
DROP FUNCTION IF EXISTS public.compare_location_arrays_v2(text, text);
DROP FUNCTION IF EXISTS public.parse_location_string_v2(text);
DROP FUNCTION IF EXISTS public.get_or_create_locations_from_string_v2(text);
DROP FUNCTION IF EXISTS public.get_or_create_locations_batch_v2(text[]);
DROP FUNCTION IF EXISTS public.preview_import_with_duplicates_check_v2(jsonb);
DROP FUNCTION IF EXISTS public.check_logistics_record_duplicate_v2(text, text, text, text, text, text, text, numeric);
DROP FUNCTION IF EXISTS public.add_logistics_record_with_costs_v2(uuid, uuid, uuid, text, text, text, text, text, text, text, numeric, text, numeric, numeric, uuid);
DROP FUNCTION IF EXISTS public.import_logistics_data_v2(jsonb);

-- 显示回滚完成信息
SELECT '多装多卸功能回滚完成' as status;
```

**优点**：
- 快速恢复功能
- 不丢失数据
- 风险最小

**缺点**：
- 数据库字段仍然存在（但不影响功能）

### 方案二：完全回滚

**适用场景**：需要完全恢复到原始状态

**执行步骤**：
1. 执行快速回滚
2. 删除数据库字段
3. 清理测试数据
4. 前端代码回滚

**回滚脚本**：
```sql
-- 1. 删除所有 _v2 函数
-- 执行 scripts/rollback-multi-location-functions-v2.sql

-- 2. 删除多地点支持字段（⚠️ 会丢失数据）
ALTER TABLE public.logistics_records 
DROP COLUMN IF EXISTS loading_location_ids,
DROP COLUMN IF EXISTS unloading_location_ids;

ALTER TABLE public.import_templates 
DROP COLUMN IF EXISTS location_ids;

ALTER TABLE public.import_field_mappings 
DROP COLUMN IF EXISTS location_ids;

-- 3. 清理测试数据
DELETE FROM public.logistics_records WHERE project_name = '多地点测试项目V2';
DELETE FROM public.drivers WHERE name = '多地点测试司机V2';
DELETE FROM public.partner_chains WHERE chain_name = '默认链路V2';
DELETE FROM public.projects WHERE name = '多地点测试项目V2';

-- 4. 显示回滚完成信息
SELECT '多装多卸功能完全回滚完成' as status;
```

**优点**：
- 完全恢复到原始状态
- 数据库结构干净

**缺点**：
- 会丢失多地点相关数据
- 需要前端代码回滚

### 方案三：分步回滚

**适用场景**：只需要回滚部分功能

#### 3.1 只回滚验重函数
```sql
DROP FUNCTION IF EXISTS public.compare_location_arrays_v2(text, text);
DROP FUNCTION IF EXISTS public.preview_import_with_duplicates_check_v2(jsonb);
DROP FUNCTION IF EXISTS public.check_logistics_record_duplicate_v2(text, text, text, text, text, text, text, numeric);
```

#### 3.2 只回滚导入函数
```sql
DROP FUNCTION IF EXISTS public.add_logistics_record_with_costs_v2(uuid, uuid, uuid, text, text, text, text, text, text, text, numeric, text, numeric, numeric, uuid);
DROP FUNCTION IF EXISTS public.import_logistics_data_v2(jsonb);
```

#### 3.3 只回滚地点管理函数
```sql
DROP FUNCTION IF EXISTS public.parse_location_string_v2(text);
DROP FUNCTION IF EXISTS public.get_or_create_locations_from_string_v2(text);
DROP FUNCTION IF EXISTS public.get_or_create_locations_batch_v2(text[]);
```

## 前端回滚

### 1. 恢复原始组件

**文件**: `src/pages/BusinessEntry/components/LogisticsFormDialog.tsx`

**回滚内容**：
- 将 `MultiLocationInput` 组件改回单地点 `Select` 组件
- 恢复 `loadingLocationId` 和 `unloadingLocationId` 字段
- 移除多地点相关的处理逻辑

**示例**：
```typescript
// 回滚前（多地点）
<MultiLocationInput
  selectedLocationIds={formData.loadingLocationIds}
  onLocationChange={setLoadingLocationIds}
  onCustomLocationAdd={handleCustomLocationAdd}
/>

// 回滚后（单地点）
<Select
  value={formData.loadingLocationId}
  onValueChange={(value) => setFormData({...formData, loadingLocationId: value})}
>
  {/* 地点选项 */}
</Select>
```

### 2. 恢复原始表格显示

**文件**: `src/pages/BusinessEntry/components/LogisticsTable.tsx`

**回滚内容**：
- 将 `RouteDisplay` 组件改回简单的文本显示
- 移除多地点解析逻辑

### 3. 恢复原始导入逻辑

**文件**: `src/pages/BusinessEntry/hooks/useExcelImport.ts`

**回滚内容**：
- 移除多地点字符串处理逻辑
- 恢复单地点字段处理

## 回滚验证

### 1. 功能验证

**数据库验证**：
```sql
-- 验证原有函数存在
SELECT routine_name FROM information_schema.routines 
WHERE routine_name LIKE '%logistics%' AND routine_name NOT LIKE '%_v2%';

-- 验证原有功能正常
SELECT public.preview_import_with_duplicates_check('[]'::jsonb);
```

**前端验证**：
- [ ] 运单创建功能正常
- [ ] 运单编辑功能正常
- [ ] Excel导入功能正常
- [ ] 验重功能正常
- [ ] 表格显示正常

### 2. 性能验证

**数据库性能**：
```sql
-- 检查查询性能
EXPLAIN ANALYZE SELECT * FROM public.logistics_records LIMIT 10;
```

**前端性能**：
- [ ] 页面加载速度正常
- [ ] 表单响应速度正常
- [ ] 表格渲染速度正常

## 回滚检查清单

### 执行前检查
- [ ] 确认回滚原因和范围
- [ ] 备份重要数据
- [ ] 通知相关用户
- [ ] 准备回滚脚本

### 执行中检查
- [ ] 按顺序执行回滚步骤
- [ ] 每步执行后验证结果
- [ ] 记录执行日志
- [ ] 处理异常情况

### 执行后检查
- [ ] 验证原有功能正常
- [ ] 检查数据完整性
- [ ] 测试关键业务流程
- [ ] 更新相关文档

## 常见问题

### Q1: 回滚后数据丢失怎么办？
**A**: 如果执行了完全回滚，可以从备份中恢复数据：
```sql
-- 恢复数据
INSERT INTO public.logistics_records SELECT * FROM logistics_records_backup;
```

### Q2: 回滚后功能异常怎么办？
**A**: 检查以下几点：
1. 确认所有原有函数存在
2. 检查数据库约束
3. 验证前端代码正确性
4. 查看错误日志

### Q3: 如何避免回滚？
**A**: 建议：
1. 充分测试后再部署
2. 使用灰度发布
3. 准备回滚方案
4. 监控系统状态

## 联系支持

如果在回滚过程中遇到问题，请联系：
- 技术负责人：[联系方式]
- 数据库管理员：[联系方式]
- 系统管理员：[联系方式]

## 更新日志

- 2025-01-20: 创建初始版本
- 2025-01-20: 添加分步回滚方案
- 2025-01-20: 完善前端回滚指南
