# æ—¥æœŸç­›é€‰å™¨ç»Ÿä¸€ä¿®æ”¹æ¸…å•

## ğŸ“‹ ä¿®æ”¹ç›®æ ‡

å°†æ—¥æœŸç­›é€‰å™¨æ”¹ä¸ºä¸Excelå¯¼å…¥å’Œè¿å•å½•å…¥ä¸€è‡´çš„å¤„ç†æ–¹å¼ï¼š
- **å‰ç«¯**ï¼šä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²ï¼ˆå¦‚ `"2025-11-01"`ï¼‰
- **åç«¯**ï¼šæ˜ç¡®è½¬æ¢ä¸º `+08:00` æ—¶åŒºè¿›è¡Œæ¯”è¾ƒï¼ˆå¦‚ `(p_start_date || ' 00:00:00+08:00')::timestamptz`ï¼‰

---

## ğŸ”§ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

### ä¸€ã€å‰ç«¯é¡µé¢ï¼ˆæ¡Œé¢ç«¯ï¼‰

#### 1. è¿å•ç®¡ç†ç›¸å…³
- [ ] `src/pages/BusinessEntry/components/FilterBar.tsx`
  - ç§»é™¤ `convertChinaDateToUTCDate` å’Œ `convertChinaEndDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ `filters.startDate` å’Œ `filters.endDate`ï¼ˆä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²ï¼‰

- [ ] `src/pages/BusinessEntry/hooks/useLogisticsData.ts`
  - ç§»é™¤ `convertChinaDateToUTCDate` å’Œ `convertChinaEndDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ `filters.startDate` å’Œ `filters.endDate` ç»™åç«¯

#### 2. ç£…å•ç®¡ç†ç›¸å…³
- [ ] `src/pages/ScaleRecords/components/FilterSection.tsx`
  - ç§»é™¤æ—¥æœŸè½¬æ¢é€»è¾‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

- [ ] `src/pages/ScaleRecords/index.tsx`
  - ç§»é™¤ `convertChinaDateToUTCDate` å’Œ `convertChinaEndDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

- [ ] `src/pages/ScaleRecords/hooks/useScaleRecords.ts`
  - ç§»é™¤ `convertChinaDateToUTCDate` å’Œ `convertChinaEndDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

#### 3. è´¢åŠ¡å¯¹è´¦ç›¸å…³
- [ ] `src/pages/PaymentRequest.tsx`
  - ç§»é™¤ `convertChinaDateToUTCDate` å’Œ `convertChinaEndDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ `activeFilters.startDate` å’Œ `activeFilters.endDate`

- [ ] `src/pages/FinanceReconciliation.tsx`
  - ç§»é™¤ `convertChinaDateToUTCDate` å’Œ `convertChinaEndDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

#### 4. å¼€ç¥¨ç”³è¯·ç›¸å…³
- [ ] `src/pages/InvoiceRequest.tsx`
  - ç§»é™¤ `convertChinaDateToUTCDate` å’Œ `convertChinaEndDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

- [ ] `src/pages/InvoiceRequest/components/InvoiceRequestFilterBar.tsx`
  - ç§»é™¤æ—¥æœŸè½¬æ¢é€»è¾‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

#### 5. å¼€ç¥¨å®¡æ ¸ç›¸å…³
- [ ] `src/pages/InvoiceAudit.tsx`
  - ç§»é™¤ `convertSingleDateToDateRange` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ `filters.loadingDate`ï¼ˆä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²ï¼‰

- [ ] `src/pages/InvoiceRequestManagement.tsx`
  - ç§»é™¤ `convertSingleDateToDateRange` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ `filters.loadingDate`ï¼ˆä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²ï¼‰

- [ ] `src/pages/PaymentInvoice.tsx`
  - æ£€æŸ¥æ˜¯å¦æœ‰æ—¥æœŸç­›é€‰ï¼Œå¦‚æœ‰åˆ™ä¿®æ”¹

#### 6. ä»˜æ¬¾å®¡æ ¸ç›¸å…³
- [ ] `src/pages/PaymentAudit.tsx`
  - ç§»é™¤ `convertSingleDateToDateRange` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

- [ ] `src/pages/PaymentRequestsList.tsx`
  - ç§»é™¤ `convertSingleDateToDateRange` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

#### 7. é¦–é¡µçœ‹æ¿
- [ ] `src/pages/Home.tsx`
  - ç§»é™¤æ—¥æœŸè½¬æ¢é€»è¾‘
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

---

### äºŒã€å‰ç«¯é¡µé¢ï¼ˆç§»åŠ¨ç«¯ï¼‰

#### 1. ç§»åŠ¨ç«¯é¦–é¡µ
- [ ] `src/pages/mobile/MobileHome.tsx`
  - ç§»é™¤ `convertChinaDateToUTCDate` å’Œ `convertChinaEndDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

- [ ] `src/pages/mobile/MobileHomeNew.tsx`
  - ç§»é™¤æ—¥æœŸè½¬æ¢é€»è¾‘
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

#### 2. ç§»åŠ¨ç«¯ç£…å•
- [ ] `src/pages/mobile/MobileScaleRecords.tsx`
  - ç§»é™¤æ—¥æœŸè½¬æ¢é€»è¾‘ï¼ˆç¬¬100-121è¡Œçš„UTCè½¬æ¢ï¼‰
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²ç»™ `gte` å’Œ `lte` æŸ¥è¯¢

#### 3. ç§»åŠ¨ç«¯é¡¹ç›®ç›¸å…³
- [ ] `src/pages/mobile/MobileProjectRecords.tsx`
  - ç§»é™¤ `convertChinaDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

- [ ] `src/pages/mobile/MobileProjectDetail.tsx`
  - ç§»é™¤ `convertChinaDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

- [ ] `src/pages/mobile/MobileProjectOverview.tsx`
  - ç§»é™¤æ—¥æœŸè½¬æ¢é€»è¾‘
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

#### 4. ç§»åŠ¨ç«¯å†…éƒ¨ç®¡ç†
- [ ] `src/pages/mobile/internal/MobileDailyWaybills.tsx`
  - ç§»é™¤æ—¥æœŸè½¬æ¢é€»è¾‘
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

- [ ] `src/pages/mobile/internal/MobileFleetDashboard.tsx`
  - ç§»é™¤ `convertChinaDateToUTCDate` çš„ä½¿ç”¨
  - ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

#### 5. ç§»åŠ¨ç«¯ä»˜æ¬¾ç”³è¯·
- [ ] `src/pages/mobile/MobilePaymentRequestsList.tsx`
  - æ£€æŸ¥æ˜¯å¦æœ‰æ—¥æœŸç­›é€‰ï¼Œå¦‚æœ‰åˆ™ä¿®æ”¹

---

### ä¸‰ã€å·¥å…·å‡½æ•°

#### 1. æ—¥æœŸå·¥å…·å‡½æ•°
- [ ] `src/utils/dateUtils.ts`
  - **ä¿ç•™** `convertChinaDateToUTCDate` å’Œ `convertChinaEndDateToUTCDate`ï¼ˆå¯èƒ½å…¶ä»–åœ°æ–¹è¿˜åœ¨ç”¨ï¼‰
  - **ä¿ç•™** `convertSingleDateToDateRange`ï¼ˆå¯èƒ½å…¶ä»–åœ°æ–¹è¿˜åœ¨ç”¨ï¼‰
  - **ä¿ç•™** `formatChinaDateString`ï¼ˆç”¨äºæ ¼å¼åŒ–æ˜¾ç¤ºï¼‰
  - **ä¿ç•™** `convertUTCDateToChinaDate`ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
  - æ·»åŠ æ³¨é‡Šè¯´æ˜ï¼šè¿™äº›å‡½æ•°ä»…ç”¨äºå‘åå…¼å®¹ï¼Œæ–°ä»£ç åº”ç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²

---

### å››ã€åç«¯å‡½æ•°ï¼ˆSQLè¿ç§»æ–‡ä»¶ï¼‰

#### 1. è¿å•ç®¡ç†å‡½æ•°
- [ ] `supabase/migrations/20250126_update_logistics_functions_support_space.sql`
  - ä¿®æ”¹ `get_logistics_summary_and_records_enhanced` å‡½æ•°
    - å°† `lr.loading_date >= p_start_date::date` æ”¹ä¸º `lr.loading_date >= (p_start_date || ' 00:00:00+08:00')::timestamptz`
    - å°† `lr.loading_date <= p_end_date::date` æ”¹ä¸º `lr.loading_date < ((p_end_date || ' 23:59:59+08:00')::timestamptz + INTERVAL '1 second')`
  
  - ä¿®æ”¹ `get_all_filtered_record_ids` å‡½æ•°
    - åŒæ ·çš„æ—¥æœŸæ¯”è¾ƒé€»è¾‘ä¿®æ”¹

#### 2. ç£…å•ç®¡ç†å‡½æ•°
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰ç£…å•ç›¸å…³çš„åç«¯å‡½æ•°éœ€è¦ä¿®æ”¹
  - å¦‚æœæœ‰ï¼Œä½¿ç”¨ç›¸åŒçš„æ—¶åŒºè½¬æ¢é€»è¾‘

#### 3. è´¢åŠ¡å¯¹è´¦å‡½æ•°
- [ ] `supabase/migrations/20251029_fix_payment_request_data_sort_by_auto_number.sql` æˆ–ç›¸å…³æ–‡ä»¶
  - ä¿®æ”¹ `get_payment_request_data` å‡½æ•°
    - å°†æ—¥æœŸæ¯”è¾ƒæ”¹ä¸ºä½¿ç”¨ `+08:00` æ—¶åŒºè½¬æ¢

#### 4. å¼€ç¥¨ç”³è¯·å‡½æ•°
- [ ] `supabase/migrations/20251029_fix_invoice_request_data_sort_by_auto_number.sql` æˆ–ç›¸å…³æ–‡ä»¶
  - ä¿®æ”¹ `get_invoice_request_data` å‡½æ•°
    - å°†æ—¥æœŸæ¯”è¾ƒæ”¹ä¸ºä½¿ç”¨ `+08:00` æ—¶åŒºè½¬æ¢

#### 5. ä»˜æ¬¾å®¡æ ¸å‡½æ•°
- [ ] `supabase/migrations/20250126_update_payment_request_functions_support_space.sql` æˆ–ç›¸å…³æ–‡ä»¶
  - ä¿®æ”¹ `get_payment_requests_filtered` å‡½æ•°
    - å°†å•æ—¥æŸ¥è¯¢æ”¹ä¸ºä½¿ç”¨æ—¥æœŸèŒƒå›´ï¼Œæ˜ç¡®æŒ‡å®š `+08:00` æ—¶åŒº

#### 6. å¼€ç¥¨å®¡æ ¸å‡½æ•°
- [ ] `supabase/migrations/20250126_create_invoice_requests_filtered_function.sql` æˆ–ç›¸å…³æ–‡ä»¶
  - ä¿®æ”¹ `get_invoice_requests_filtered` å‡½æ•°
    - å°†å•æ—¥æŸ¥è¯¢æ”¹ä¸ºä½¿ç”¨æ—¥æœŸèŒƒå›´ï¼Œæ˜ç¡®æŒ‡å®š `+08:00` æ—¶åŒº

#### 7. é¦–é¡µçœ‹æ¿å‡½æ•°
- [ ] `supabase/migrations/20250122_create_shipper_dashboard_functions.sql` æˆ–ç›¸å…³æ–‡ä»¶
  - ä¿®æ”¹ `get_dashboard_stats_with_billing_types` å‡½æ•°
    - å°†æ—¥æœŸæ¯”è¾ƒæ”¹ä¸ºä½¿ç”¨ `+08:00` æ—¶åŒºè½¬æ¢

---

## ğŸ“ ä¿®æ”¹æ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºæ–°çš„SQLè¿ç§»æ–‡ä»¶
åˆ›å»ºä¸€ä¸ªæ–°çš„è¿ç§»æ–‡ä»¶ï¼Œç»Ÿä¸€ä¿®æ”¹æ‰€æœ‰åç«¯å‡½æ•°çš„æ—¥æœŸæ¯”è¾ƒé€»è¾‘ã€‚

**ä¿®æ”¹æ¨¡å¼ï¼š**

#### æ—¥æœŸèŒƒå›´ç­›é€‰ï¼ˆp_start_date, p_end_dateï¼‰
```sql
-- ä¿®æ”¹å‰
WHERE lr.loading_date >= p_start_date::date
  AND lr.loading_date <= p_end_date::date

-- ä¿®æ”¹å
WHERE (p_start_date IS NULL OR p_start_date = '' OR 
       lr.loading_date >= (p_start_date || ' 00:00:00+08:00')::timestamptz)
  AND (p_end_date IS NULL OR p_end_date = '' OR 
       lr.loading_date < ((p_end_date || ' 23:59:59+08:00')::timestamptz + INTERVAL '1 second'))
```

#### å•æ—¥ç­›é€‰ï¼ˆp_loading_dateï¼‰
```sql
-- ä¿®æ”¹å‰
WHERE (p_loading_date IS NULL OR lr.loading_date = p_loading_date)

-- ä¿®æ”¹åï¼ˆæ”¹ä¸ºæ—¥æœŸèŒƒå›´ï¼‰
WHERE (p_loading_date IS NULL OR p_loading_date = '' OR
       (lr.loading_date >= (p_loading_date || ' 00:00:00+08:00')::timestamptz
        AND lr.loading_date < ((p_loading_date || ' 23:59:59+08:00')::timestamptz + INTERVAL '1 second')))
```

### æ­¥éª¤2ï¼šä¿®æ”¹å‰ç«¯é¡µé¢
æŒ‰é¡ºåºä¿®æ”¹å‰ç«¯é¡µé¢ï¼Œç§»é™¤æ—¥æœŸè½¬æ¢é€»è¾‘ï¼Œç›´æ¥ä¼ é€’ä¸­å›½æ—¶åŒºæ—¥æœŸå­—ç¬¦ä¸²ã€‚

**ä¿®æ”¹æ¨¡å¼ï¼š**

#### æ—¥æœŸèŒƒå›´ç­›é€‰
```typescript
// ä¿®æ”¹å‰
const utcStartDate = filters.startDate ? convertChinaDateToUTCDate(chinaDate) : null;
const utcEndDate = filters.endDate ? convertChinaEndDateToUTCDate(chinaDate) : null;
await supabase.rpc('function_name', {
  p_start_date: utcStartDate,
  p_end_date: utcEndDate
});

// ä¿®æ”¹å
await supabase.rpc('function_name', {
  p_start_date: filters.startDate || null,
  p_end_date: filters.endDate || null
});
```

#### å•æ—¥ç­›é€‰
```typescript
// ä¿®æ”¹å‰
p_loading_date: filters.loadingDate ? (() => {
  const { startDate } = convertSingleDateToDateRange(filters.loadingDate);
  return startDate;
})() : null

// ä¿®æ”¹å
p_loading_date: filters.loadingDate || null
```

### æ­¥éª¤3ï¼šæµ‹è¯•éªŒè¯
- æµ‹è¯•æ—¥æœŸèŒƒå›´ç­›é€‰
- æµ‹è¯•å•æ—¥ç­›é€‰
- æµ‹è¯•ç§»åŠ¨ç«¯æ—¥æœŸç­›é€‰
- éªŒè¯æ—¶åŒºè½¬æ¢æ­£ç¡®æ€§

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šä¿ç•™æ—§çš„æ—¥æœŸè½¬æ¢å‡½æ•°ï¼Œä½†æ·»åŠ æ³¨é‡Šè¯´æ˜ä¸å†ä½¿ç”¨
2. **ç»Ÿä¸€æ ¼å¼**ï¼šæ‰€æœ‰æ—¥æœŸå­—ç¬¦ä¸²ç»Ÿä¸€ä½¿ç”¨ `YYYY-MM-DD` æ ¼å¼
3. **æ—¶åŒºæ˜ç¡®**ï¼šåç«¯ç»Ÿä¸€ä½¿ç”¨ `+08:00` æ—¶åŒºè½¬æ¢ï¼Œä¸ä¾èµ–ä¼šè¯æ—¶åŒº
4. **æµ‹è¯•è¦†ç›–**ï¼šç¡®ä¿æ‰€æœ‰ä½¿ç”¨æ—¥æœŸç­›é€‰çš„é¡µé¢éƒ½ç»è¿‡æµ‹è¯•

---

## ğŸ“Š ç»Ÿè®¡

### å‰ç«¯é¡µé¢ï¼ˆæ¡Œé¢ç«¯ï¼‰ï¼š15 ä¸ªæ–‡ä»¶
1. `src/pages/BusinessEntry/components/FilterBar.tsx`
2. `src/pages/BusinessEntry/hooks/useLogisticsData.ts`
3. `src/pages/ScaleRecords/components/FilterSection.tsx`
4. `src/pages/ScaleRecords/index.tsx`
5. `src/pages/ScaleRecords/hooks/useScaleRecords.ts`
6. `src/pages/PaymentRequest.tsx`
7. `src/pages/FinanceReconciliation.tsx`
8. `src/pages/InvoiceRequest.tsx`
9. `src/pages/InvoiceRequest/components/InvoiceRequestFilterBar.tsx`
10. `src/pages/InvoiceAudit.tsx`
11. `src/pages/InvoiceRequestManagement.tsx`
12. `src/pages/PaymentInvoice.tsx`ï¼ˆéœ€æ£€æŸ¥ï¼‰
13. `src/pages/PaymentAudit.tsx`
14. `src/pages/PaymentRequestsList.tsx`
15. `src/pages/Home.tsx`

### å‰ç«¯é¡µé¢ï¼ˆç§»åŠ¨ç«¯ï¼‰ï¼š8 ä¸ªæ–‡ä»¶
1. `src/pages/mobile/MobileHome.tsx`
2. `src/pages/mobile/MobileHomeNew.tsx`
3. `src/pages/mobile/MobileScaleRecords.tsx`
4. `src/pages/mobile/MobileProjectRecords.tsx`
5. `src/pages/mobile/MobileProjectDetail.tsx`
6. `src/pages/mobile/MobileProjectOverview.tsx`
7. `src/pages/mobile/internal/MobileDailyWaybills.tsx`
8. `src/pages/mobile/internal/MobileFleetDashboard.tsx`
9. `src/pages/mobile/MobilePaymentRequestsList.tsx`ï¼ˆéœ€æ£€æŸ¥ï¼‰

### åç«¯å‡½æ•°ï¼ˆSQLè¿ç§»æ–‡ä»¶ï¼‰ï¼š7-8 ä¸ªå‡½æ•°
1. `get_logistics_summary_and_records_enhanced`ï¼ˆè¿å•ç®¡ç†ï¼‰
2. `get_all_filtered_record_ids`ï¼ˆè¿å•ç®¡ç†ï¼‰
3. `get_payment_request_data`ï¼ˆè´¢åŠ¡å¯¹è´¦ï¼‰
4. `get_invoice_request_data`ï¼ˆå¼€ç¥¨ç”³è¯·ï¼‰
5. `get_payment_requests_filtered`ï¼ˆä»˜æ¬¾å®¡æ ¸ï¼‰
6. `get_invoice_requests_filtered`ï¼ˆå¼€ç¥¨å®¡æ ¸ï¼‰
7. `get_dashboard_stats_with_billing_types`ï¼ˆé¦–é¡µçœ‹æ¿ï¼‰
8. ç£…å•ç›¸å…³å‡½æ•°ï¼ˆå¦‚æœæœ‰ï¼‰

### å·¥å…·å‡½æ•°ï¼š1 ä¸ªæ–‡ä»¶
1. `src/utils/dateUtils.ts`ï¼ˆæ·»åŠ æ³¨é‡Šï¼‰

**æ€»è®¡**ï¼šçº¦ 31-33 ä¸ªæ–‡ä»¶éœ€è¦ä¿®æ”¹

