# 计费类型4（按件）功能设计说明

## 📋 功能概述

在现有系统中添加第4种计费类型：**按件**，单位是**件**。

### 现有计费类型
- **类型1**：按重量（吨）
- **类型2**：按车次（车）
- **类型3**：按体积（立方）

### 新增计费类型
- **类型4**：按件（件）

---

## 🗄️ 数据库变更

### 1. 数据库迁移文件

**文件**：`supabase/migrations/20251120_add_billing_type_4_by_piece.sql`

**内容**：
- 在 `billing_types` 表中插入 `billing_type_id = 4` 的记录
- `type_name = '按件'`
- `type_code = 'piece'`
- 更新表注释，说明4种计费类型

**执行顺序**：
- 在单价功能迁移文件之后执行（如果已执行单价功能）
- 可以独立执行，不影响现有数据

---

## 🎨 前端变更

### 1. 链路配置页面（项目设置）

**文件**：`src/pages/Projects.tsx`

**变更**：
- 在计费模式下拉菜单中添加 `<option value="4">计件</option>`

**位置**：第644-647行

```tsx
<select>
  <option value="1">计吨</option>
  <option value="2">计车</option>
  <option value="3">计方</option>
  <option value="4">计件</option>  {/* 新增 */}
</select>
```

---

### 2. 数据看板页面（图表显示）

**文件**：`src/pages/Home.tsx`

**变更**：
- 在 `BILLING_TYPE_MAP` 中添加类型4的配置
- 添加 `Box` 图标导入
- 配置颜色和样式（紫色主题）

**位置**：第25-29行

```typescript
const BILLING_TYPE_MAP = {
  '1': { name: '计重', unit: '吨', icon: Truck, color: 'text-green-600', bgColor: 'bg-green-100' },
  '2': { name: '计车', unit: '车', icon: Package, color: 'text-sky-600', bgColor: 'bg-sky-100' },
  '3': { name: '计体积', unit: '立方', icon: Cuboid, color: 'text-orange-600', bgColor: 'bg-orange-100' },
  '4': { name: '计件', unit: '件', icon: Box, color: 'text-purple-600', bgColor: 'bg-purple-100' }, // 新增
};
```

**效果**：
- 图表中会显示类型4的数据
- 图表标题显示"计件"
- 单位显示为"件"

---

### 3. 格式化工具函数

**文件**：`src/utils/formatters.ts`

**变更**：
- 更新 `formatQuantityByBillingType` 函数，添加类型4的处理
- 更新 `getBillingTypeConfig` 函数，添加类型4的配置

**位置**：
- `formatQuantityByBillingType`：第167-186行
- `getBillingTypeConfig`：第193-206行

**逻辑**：
```typescript
case 4: // 计件
  return `${loading.toFixed(0)} / ${unloading.toFixed(0)} 件`;
```

**说明**：
- 按件计费时，数量显示为整数（无小数）
- 格式：`装货件数 / 卸货件数 件`

---

### 4. 移动端页面

#### 4.1 移动端项目看板

**文件**：`src/pages/mobile/MobileProjectDashboard.tsx`

**变更**：
- 在 `unitConfig` 的 `useMemo` 中添加类型4的判断

**位置**：第242-244行

```typescript
let unitText = '吨';
if (typeId === 2) unitText = '车';
if (typeId === 3) unitText = '立方';
if (typeId === 4) unitText = '件'; // 新增
```

---

#### 4.2 移动端项目详细看板

**文件**：`src/pages/mobile/MobileProjectDashboardDetail.tsx`

**变更**：
1. 更新 `billingTypeConfig` 对象，添加类型4
2. 更新 `unitConfig` 的 `useMemo`，添加类型4的判断

**位置**：
- `billingTypeConfig`：第116-120行
- `unitConfig`：第213-215行

```typescript
const billingTypeConfig = {
  1: { name: '计重', unit: '吨', icon: Package },
  2: { name: '计车', unit: '车', icon: Truck },
  3: { name: '计体积', unit: '立方', icon: Package },
  4: { name: '计件', unit: '件', icon: Package } // 新增
};
```

---

#### 4.3 移动端运单详情

**文件**：
- `src/pages/mobile/MobileWaybillDetail.tsx`
- `src/pages/mobile/internal/MobileInternalWaybillDetail.tsx`

**变更**：
- 更新 `billingTypeConfig` 对象，添加类型4

**位置**：第84-88行（两个文件相同）

```typescript
const billingTypeConfig = {
  1: { name: '计重', unit: '吨', icon: Weight },
  2: { name: '计车', unit: '车', icon: Truck },
  3: { name: '计体积', unit: '立方', icon: Package },
  4: { name: '计件', unit: '件', icon: Package } // 新增
};
```

---

### 5. 桌面端项目看板

**文件**：`src/pages/ProjectDashboard.tsx`

**变更**：
- 在 `unitConfig` 的 `useMemo` 中添加类型4的判断

**位置**：第88-90行

```typescript
let unitText = '吨';
if (typeId === 2) unitText = '车';
if (typeId === 3) unitText = '立方';
if (typeId === 4) unitText = '件'; // 新增
```

---

### 6. 数据服务

**文件**：`src/services/DashboardDataService.ts`

**变更**：
- 在 `getUnitConfig` 函数中添加类型4的判断

**位置**：第242-244行

```typescript
let unitText = '吨';
if (typeId === 2) unitText = '车';
if (typeId === 3) unitText = '立方';
if (typeId === 4) unitText = '件'; // 新增
```

---

## 📊 图表显示说明

### 图表中的中文描述

在图表中，计费类型会显示为：

| billing_type_id | 中文名称 | 单位 | 图标 | 颜色 |
|----------------|---------|------|------|------|
| 1 | 计重 | 吨 | Truck | 绿色 |
| 2 | 计车 | 车 | Package | 蓝色 |
| 3 | 计体积 | 立方 | Cuboid | 橙色 |
| 4 | 计件 | 件 | Box | 紫色 |

### 图表标题示例

- **类型1**：`计重统计（吨）`
- **类型2**：`计车统计（车）`
- **类型3**：`计体积统计（立方）`
- **类型4**：`计件统计（件）`（新增）

---

## 🔄 数据兼容性

### 现有数据

- ✅ **不影响现有数据**：所有现有运单的 `billing_type_id` 保持不变（1、2、3）
- ✅ **向后兼容**：如果某个运单的 `billing_type_id` 为 NULL 或无效值，系统默认使用类型1（计重）

### 新数据

- ✅ **支持类型4**：新建运单时，如果链路配置为类型4，运单会自动使用类型4
- ✅ **磅单支持**：磅单记录可以选择类型4作为计费方式

---

## 🧪 测试检查清单

### 数据库测试

- [ ] 执行迁移文件，确认 `billing_types` 表中存在 `billing_type_id = 4` 的记录
- [ ] 验证 `type_name = '按件'`，`type_code = 'piece'`

### 前端测试

#### 项目设置
- [ ] 在项目设置中，链路配置的计费模式下拉显示"计件"选项
- [ ] 选择"计件"后，可以正常保存

#### 数据看板
- [ ] 数据看板中，如果存在类型4的运单，图表会显示"计件统计（件）"
- [ ] 图表单位显示为"件"
- [ ] 图表颜色为紫色主题

#### 运单管理
- [ ] 新建运单时，如果链路配置为类型4，运单自动使用类型4
- [ ] 运单列表中，类型4的运单显示正确的单位和格式

#### 磅单管理
- [ ] 磅单表单中，计费方式下拉显示"按件"选项
- [ ] 选择"按件"后，有效数量输入框的标签显示为"有效数量 (件)"

#### 移动端
- [ ] 移动端项目看板中，类型4的项目显示单位"件"
- [ ] 移动端运单详情中，类型4的运单显示正确的单位和格式

---

## 📝 注意事项

### 1. 数量显示格式

- **类型1（计重）**：显示2位小数，如 `10.50 / 10.30 吨`
- **类型2（计车）**：显示为 `1 车`（固定值）
- **类型3（计体积）**：显示2位小数，如 `5.20 / 5.20 立方`
- **类型4（计件）**：显示整数，如 `100 / 100 件`（新增）

### 2. 有效数量计算

对于类型4（按件），有效数量的计算逻辑：
- 如果项目配置为 `effective_quantity_type = 'loading'`：使用装货件数
- 如果项目配置为 `effective_quantity_type = 'unloading'`：使用卸货件数
- 如果项目配置为 `effective_quantity_type = 'min_value'`：使用装货件数和卸货件数的较小值

### 3. 单价计算

如果使用单价自动计算功能：
- `current_cost = unit_price × effective_quantity`
- 对于类型4，`effective_quantity` 是件数（整数）

---

## 🚀 部署步骤

### 1. 执行数据库迁移

```sql
-- 在 Supabase Dashboard → SQL Editor 中执行
supabase/migrations/20251120_add_billing_type_4_by_piece.sql
```

### 2. 验证数据库

```sql
-- 检查 billing_types 表
SELECT * FROM billing_types WHERE billing_type_id = 4;

-- 预期结果：
-- billing_type_id: 4
-- type_name: '按件'
-- type_code: 'piece'
```

### 3. 刷新前端

- 清除浏览器缓存
- 刷新页面
- 测试功能

---

## 📚 相关文件清单

### 数据库文件
- ✅ `supabase/migrations/20251120_add_billing_type_4_by_piece.sql`

### 前端文件
- ✅ `src/pages/Projects.tsx` - 链路配置
- ✅ `src/pages/Home.tsx` - 数据看板图表
- ✅ `src/utils/formatters.ts` - 格式化函数
- ✅ `src/pages/mobile/MobileProjectDashboard.tsx` - 移动端项目看板
- ✅ `src/pages/mobile/MobileProjectDashboardDetail.tsx` - 移动端项目详细看板
- ✅ `src/pages/mobile/MobileWaybillDetail.tsx` - 移动端运单详情
- ✅ `src/pages/mobile/internal/MobileInternalWaybillDetail.tsx` - 移动端内部运单详情
- ✅ `src/pages/ProjectDashboard.tsx` - 桌面端项目看板
- ✅ `src/services/DashboardDataService.ts` - 数据服务

---

## ✅ 完成状态

- [x] 数据库迁移文件已创建
- [x] 链路配置下拉已更新
- [x] 数据看板图表配置已更新
- [x] 格式化函数已更新
- [x] 移动端页面已更新
- [x] 桌面端页面已更新
- [x] 数据服务已更新

---

**文档创建日期**：2025-11-20  
**最后更新**：2025-11-20  
**状态**：✅ 已完成

