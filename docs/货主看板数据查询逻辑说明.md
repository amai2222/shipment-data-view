# è´§ä¸»çœ‹æ¿æ•°æ®æŸ¥è¯¢é€»è¾‘è¯´æ˜

## ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ

### 1. æ•°æ®è¡¨ç»“æ„

#### `partners` è¡¨ï¼ˆåˆä½œæ–¹è¡¨ï¼‰
å­˜å‚¨è´§ä¸»çš„åŸºæœ¬ä¿¡æ¯å’Œå±‚çº§å…³ç³»ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | UUID | è´§ä¸»IDï¼ˆä¸»é”®ï¼‰ |
| `name` | TEXT | è´§ä¸»åç§° |
| `partner_type` | TEXT | åˆä½œæ–¹ç±»å‹ï¼ˆå¿…é¡»æ˜¯ `'è´§ä¸»'` æ‰å‚ä¸å±‚çº§ï¼‰ |
| `parent_partner_id` | UUID | ä¸Šçº§è´§ä¸»IDï¼ˆNULLè¡¨ç¤ºæ ¹èŠ‚ç‚¹ï¼‰ |
| `hierarchy_path` | TEXT | å±‚çº§è·¯å¾„ï¼ˆå¦‚ï¼š`/uuid1/uuid2/uuid3`ï¼‰ |
| `hierarchy_depth` | INTEGER | å±‚çº§æ·±åº¦ï¼ˆ0=æ ¹èŠ‚ç‚¹ï¼Œ1=ä¸€çº§ï¼Œ2=äºŒçº§...ï¼‰ |
| `is_root` | BOOLEAN | æ˜¯å¦æ ¹èŠ‚ç‚¹ |

**ç¤ºä¾‹æ•°æ®ï¼š**
```
id: uuid-A (ç››ä¸°)
  - parent_partner_id: NULL
  - hierarchy_path: /uuid-A
  - hierarchy_depth: 0
  - is_root: true

id: uuid-B (ç››ä¸°-åŒ—äº¬åˆ†å…¬å¸)
  - parent_partner_id: uuid-A
  - hierarchy_path: /uuid-A/uuid-B
  - hierarchy_depth: 1
  - is_root: false

id: uuid-C (ç››ä¸°-ä¸Šæµ·åˆ†å…¬å¸)
  - parent_partner_id: uuid-A
  - hierarchy_path: /uuid-A/uuid-C
  - hierarchy_depth: 1
  - is_root: false
```

#### `project_partners` è¡¨ï¼ˆé¡¹ç›®åˆä½œæ–¹å…³è”è¡¨ï¼‰
å­˜å‚¨é¡¹ç›®å’Œè´§ä¸»çš„å…³è”å…³ç³»ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | UUID | ä¸»é”® |
| `project_id` | UUID | é¡¹ç›®ID |
| `partner_id` | UUID | è´§ä¸»IDï¼ˆå…³è”åˆ° `partners.id`ï¼‰ |
| `chain_id` | UUID | åˆä½œé“¾è·¯ID |
| `level` | INTEGER | åœ¨é“¾è·¯ä¸­çš„å±‚çº§ |

**å…³é”®ç‚¹ï¼š** ä¸€ä¸ªé¡¹ç›®å¯ä»¥å…³è”å¤šä¸ªè´§ä¸»ï¼ˆé€šè¿‡ä¸åŒçš„ `level`ï¼‰ï¼Œä¸€ä¸ªè´§ä¸»ä¹Ÿå¯ä»¥å…³è”å¤šä¸ªé¡¹ç›®ã€‚

#### `logistics_records` è¡¨ï¼ˆè¿å•è®°å½•è¡¨ï¼‰
å­˜å‚¨è¿å•ä¿¡æ¯ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | UUID | è¿å•IDï¼ˆä¸»é”®ï¼‰ |
| `project_id` | UUID | é¡¹ç›®IDï¼ˆå…³è”åˆ° `projects.id`ï¼‰ |
| `loading_date` | TIMESTAMPTZ | è£…è´§æ—¥æœŸ |
| `payable_cost` | NUMERIC | åº”ä»˜è´¹ç”¨ |
| `loading_weight` | NUMERIC | è£…è´§é‡é‡ |
| `unloading_weight` | NUMERIC | å¸è´§é‡é‡ |
| ... | ... | å…¶ä»–å­—æ®µ |

**å…³é”®ç‚¹ï¼š** è¿å•é€šè¿‡ `project_id` å…³è”åˆ°é¡¹ç›®ï¼Œå†é€šè¿‡ `project_partners` å…³è”åˆ°è´§ä¸»ã€‚

---

## ğŸ”— å…³è”å…³ç³»é“¾

```
è¿å• (logistics_records)
  â†“ (é€šè¿‡ project_id)
é¡¹ç›® (projects)
  â†“ (é€šè¿‡ project_id)
é¡¹ç›®åˆä½œæ–¹å…³è” (project_partners)
  â†“ (é€šè¿‡ partner_id)
è´§ä¸» (partners)
  â†“ (é€šè¿‡ hierarchy_path)
ä¸‹çº§è´§ä¸» (partners)
```

---

## ğŸ“Š æŸ¥è¯¢é€»è¾‘è¯¦è§£

### ç¬¬ä¸€æ­¥ï¼šè·å–å½“å‰è´§ä¸»çš„å±‚çº§è·¯å¾„

```sql
SELECT hierarchy_path INTO v_shipper_path
FROM public.partners
WHERE id = p_shipper_id AND partner_type = 'è´§ä¸»';
```

**ç¤ºä¾‹ï¼š**
- å¦‚æœæŸ¥è¯¢ `uuid-A`ï¼ˆç››ä¸°ï¼‰ï¼Œå¾—åˆ° `hierarchy_path = '/uuid-A'`

---

### ç¬¬äºŒæ­¥ï¼šæŸ¥è¯¢æœ¬çº§è´§ä¸»çš„æ•°æ®

**é€»è¾‘ï¼š** æŸ¥è¯¢ `project_partners` è¡¨ä¸­ `partner_id = å½“å‰è´§ä¸»ID` çš„æ‰€æœ‰é¡¹ç›®ï¼Œç„¶åæ‰¾åˆ°è¿™äº›é¡¹ç›®çš„æ‰€æœ‰è¿å•ã€‚

```sql
SELECT 
    COUNT(DISTINCT lr.id),
    COALESCE(SUM(COALESCE(lr.unloading_weight, lr.loading_weight)), 0),
    COALESCE(SUM(lr.payable_cost), 0)
FROM (
    SELECT DISTINCT lr.id, lr.unloading_weight, lr.loading_weight, lr.payable_cost
    FROM public.logistics_records lr
    INNER JOIN public.project_partners pp ON lr.project_id = pp.project_id
    WHERE pp.partner_id = p_shipper_id  -- âœ… å…³é”®ï¼šç›´æ¥åŒ¹é…å½“å‰è´§ä¸»ID
      AND lr.loading_date::date >= v_start_date
      AND lr.loading_date::date <= v_end_date
) lr;
```

**æ‰§è¡Œæ­¥éª¤ï¼š**
1. ä» `project_partners` è¡¨ä¸­æ‰¾åˆ°æ‰€æœ‰ `partner_id = uuid-A` çš„è®°å½•
2. è·å–è¿™äº›è®°å½•å¯¹åº”çš„ `project_id` åˆ—è¡¨ï¼ˆä¾‹å¦‚ï¼š`[project-1, project-2]`ï¼‰
3. ä» `logistics_records` è¡¨ä¸­æ‰¾åˆ°æ‰€æœ‰ `project_id IN [project-1, project-2]` çš„è¿å•
4. æŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰è¿å•
5. ç»Ÿè®¡è¿å•æ•°é‡ã€é‡é‡ã€é‡‘é¢

**ç¤ºä¾‹æ•°æ®æµï¼š**
```
project_partners:
  project_id: project-1, partner_id: uuid-A
  project_id: project-2, partner_id: uuid-A

logistics_records:
  id: waybill-1, project_id: project-1, loading_date: 2025-11-10
  id: waybill-2, project_id: project-2, loading_date: 2025-11-15

ç»“æœï¼šç»Ÿè®¡åˆ° 2 æ¡è¿å•ï¼ˆwaybill-1, waybill-2ï¼‰
```

---

### ç¬¬ä¸‰æ­¥ï¼šæŸ¥è¯¢ä¸‹çº§è´§ä¸»çš„æ•°æ®

**é€»è¾‘ï¼š** ä½¿ç”¨ `hierarchy_path LIKE '/uuid-A/%'` æ‰¾åˆ°æ‰€æœ‰ä¸‹çº§è´§ä¸»ï¼Œç„¶åæŸ¥è¯¢è¿™äº›ä¸‹çº§è´§ä¸»å…³è”çš„è¿å•ã€‚

```sql
SELECT 
    COUNT(DISTINCT lr.id),
    COALESCE(SUM(COALESCE(lr.unloading_weight, lr.loading_weight)), 0),
    COALESCE(SUM(lr.payable_cost), 0)
FROM (
    SELECT DISTINCT lr.id, lr.unloading_weight, lr.loading_weight, lr.payable_cost
    FROM public.logistics_records lr
    INNER JOIN public.project_partners pp ON lr.project_id = pp.project_id
    INNER JOIN public.partners p ON pp.partner_id = p.id
    WHERE p.hierarchy_path LIKE v_shipper_path || '/%'  -- âœ… å…³é”®ï¼šåŒ¹é…æ‰€æœ‰ä¸‹çº§
      AND p.partner_type = 'è´§ä¸»'  -- âœ… ç¡®ä¿æ˜¯è´§ä¸»ç±»å‹
      AND lr.loading_date::date >= v_start_date
      AND lr.loading_date::date <= v_end_date
) lr;
```

**æ‰§è¡Œæ­¥éª¤ï¼š**
1. ä» `partners` è¡¨ä¸­æ‰¾åˆ°æ‰€æœ‰ `hierarchy_path LIKE '/uuid-A/%'` çš„è´§ä¸»
   - ä¾‹å¦‚ï¼š`uuid-B`ï¼ˆ`/uuid-A/uuid-B`ï¼‰ã€`uuid-C`ï¼ˆ`/uuid-A/uuid-C`ï¼‰
2. ä» `project_partners` è¡¨ä¸­æ‰¾åˆ°è¿™äº›ä¸‹çº§è´§ä¸»å…³è”çš„æ‰€æœ‰é¡¹ç›®
   - ä¾‹å¦‚ï¼š`uuid-B` å…³è” `[project-3]`ï¼Œ`uuid-C` å…³è” `[project-4]`
3. ä» `logistics_records` è¡¨ä¸­æ‰¾åˆ°è¿™äº›é¡¹ç›®çš„æ‰€æœ‰è¿å•
4. æŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰è¿å•
5. ç»Ÿè®¡è¿å•æ•°é‡ã€é‡é‡ã€é‡‘é¢

**ç¤ºä¾‹æ•°æ®æµï¼š**
```
partners (ä¸‹çº§è´§ä¸»):
  id: uuid-B, hierarchy_path: /uuid-A/uuid-B
  id: uuid-C, hierarchy_path: /uuid-A/uuid-C

project_partners:
  project_id: project-3, partner_id: uuid-B
  project_id: project-4, partner_id: uuid-C

logistics_records:
  id: waybill-3, project_id: project-3, loading_date: 2025-11-12
  id: waybill-4, project_id: project-4, loading_date: 2025-11-18

ç»“æœï¼šç»Ÿè®¡åˆ° 2 æ¡è¿å•ï¼ˆwaybill-3, waybill-4ï¼‰
```

---

### ç¬¬å››æ­¥ï¼šå…¶ä»–ç»Ÿè®¡ï¼ˆæ´»è·ƒé¡¹ç›®ã€æ´»è·ƒå¸æœºã€å¾…ä»˜æ¬¾ç­‰ï¼‰

**é€»è¾‘ï¼š** ä½¿ç”¨ç›¸åŒçš„å±‚çº§è·¯å¾„åŒ¹é…é€»è¾‘ï¼ŒæŸ¥è¯¢æœ¬çº§å’Œä¸‹çº§çš„æ•°æ®ã€‚

```sql
-- æ´»è·ƒé¡¹ç›®æ•°ï¼ˆæœ¬çº§å’Œä¸‹çº§ï¼‰
SELECT COUNT(DISTINCT pp.project_id)
FROM public.project_partners pp
INNER JOIN public.partners p ON pp.partner_id = p.id
WHERE (p.id = p_shipper_id OR p.hierarchy_path LIKE v_shipper_path || '/%')
  AND p.partner_type = 'è´§ä¸»';

-- æ´»è·ƒå¸æœºæ•°ï¼ˆæœ¬çº§å’Œä¸‹çº§ï¼‰
SELECT COUNT(DISTINCT lr.driver_id)
FROM public.logistics_records lr
INNER JOIN public.project_partners pp ON lr.project_id = pp.project_id
INNER JOIN public.partners p ON pp.partner_id = p.id
WHERE (p.id = p_shipper_id OR p.hierarchy_path LIKE v_shipper_path || '/%')
  AND p.partner_type = 'è´§ä¸»'
  AND lr.loading_date::date >= v_start_date
  AND lr.loading_date::date <= v_end_date
  AND lr.driver_id IS NOT NULL;
```

**å…³é”®ç‚¹ï¼š**
- `p.id = p_shipper_id`ï¼šåŒ…å«æœ¬çº§è´§ä¸»
- `p.hierarchy_path LIKE v_shipper_path || '/%'`ï¼šåŒ…å«æ‰€æœ‰ä¸‹çº§è´§ä¸»
- `p.partner_type = 'è´§ä¸»'`ï¼šç¡®ä¿åªç»Ÿè®¡è´§ä¸»ç±»å‹

---

## ğŸ¯ å…³é”®æŸ¥è¯¢æ¡ä»¶è¯´æ˜

### 1. å±‚çº§è·¯å¾„åŒ¹é…

```sql
p.hierarchy_path LIKE v_shipper_path || '/%'
```

**å«ä¹‰ï¼š** åŒ¹é…æ‰€æœ‰ä»¥å½“å‰è´§ä¸»è·¯å¾„å¼€å¤´çš„ä¸‹çº§è´§ä¸»ã€‚

**ç¤ºä¾‹ï¼š**
- å½“å‰è´§ä¸»ï¼š`uuid-A`ï¼Œ`hierarchy_path = '/uuid-A'`
- åŒ¹é…æ¡ä»¶ï¼š`hierarchy_path LIKE '/uuid-A/%'`
- åŒ¹é…ç»“æœï¼š
  - âœ… `/uuid-A/uuid-B`ï¼ˆä¸€çº§ä¸‹çº§ï¼‰
  - âœ… `/uuid-A/uuid-C`ï¼ˆä¸€çº§ä¸‹çº§ï¼‰
  - âœ… `/uuid-A/uuid-B/uuid-D`ï¼ˆäºŒçº§ä¸‹çº§ï¼‰
  - âŒ `/uuid-A`ï¼ˆæœ¬çº§ï¼Œä¸åŒ¹é…ï¼‰
  - âŒ `/uuid-X/uuid-A`ï¼ˆä¸Šçº§ï¼Œä¸åŒ¹é…ï¼‰

### 2. åŒ…å«æœ¬çº§å’Œä¸‹çº§

```sql
WHERE (p.id = p_shipper_id OR p.hierarchy_path LIKE v_shipper_path || '/%')
```

**å«ä¹‰ï¼š**
- `p.id = p_shipper_id`ï¼šåŒ…å«æœ¬çº§è´§ä¸»
- `p.hierarchy_path LIKE v_shipper_path || '/%'`ï¼šåŒ…å«æ‰€æœ‰ä¸‹çº§è´§ä¸»

### 3. æ—¥æœŸèŒƒå›´ç­›é€‰

```sql
lr.loading_date::date >= v_start_date
AND lr.loading_date::date <= v_end_date
```

**å«ä¹‰ï¼š** ä½¿ç”¨ `::date` è½¬æ¢ï¼Œåªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼Œé¿å…æ—¶åŒºé—®é¢˜ã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¿…é¡»é€šè¿‡ `project_partners` å…³è”

**é”™è¯¯ç†è§£ï¼š** ç›´æ¥é€šè¿‡ `logistics_records.partner_id` å…³è”è´§ä¸»ï¼ˆè¯¥å­—æ®µä¸å­˜åœ¨ï¼‰

**æ­£ç¡®ç†è§£ï¼š** å¿…é¡»é€šè¿‡ä»¥ä¸‹è·¯å¾„å…³è”ï¼š
```
logistics_records.project_id 
  â†’ project_partners.project_id 
  â†’ project_partners.partner_id 
  â†’ partners.id
```

### 2. åªæœ‰è´§ä¸»ç±»å‹å‚ä¸å±‚çº§

**å…³é”®æ¡ä»¶ï¼š** `p.partner_type = 'è´§ä¸»'`

- âœ… åªæœ‰ `partner_type = 'è´§ä¸»'` çš„åˆä½œæ–¹æ‰å‚ä¸å±‚çº§å…³ç³»
- âŒ åˆä½œå•†ã€èµ„æ–¹ç­‰å…¶ä»–ç±»å‹ä¸å‚ä¸å±‚çº§

### 3. ä½¿ç”¨ DISTINCT é¿å…é‡å¤ç»Ÿè®¡

**é—®é¢˜ï¼š** ä¸€ä¸ªè¿å•å¯èƒ½å…³è”å¤šä¸ª `project_partners` è®°å½•ï¼ˆåŒä¸€é¡¹ç›®å¯èƒ½æœ‰å¤šä¸ªè´§ä¸»ï¼‰

**è§£å†³ï¼š** ä½¿ç”¨ `COUNT(DISTINCT lr.id)` å’Œ `SELECT DISTINCT lr.id` é¿å…é‡å¤ç»Ÿè®¡

### 4. æ—¥æœŸæ¯”è¾ƒä½¿ç”¨ `::date` è½¬æ¢

**é—®é¢˜ï¼š** `loading_date` æ˜¯ `TIMESTAMPTZ` ç±»å‹ï¼Œç›´æ¥ä¸ `DATE` æ¯”è¾ƒå¯èƒ½æœ‰æ—¶åŒºé—®é¢˜

**è§£å†³ï¼š** ä½¿ç”¨ `lr.loading_date::date >= v_start_date` åªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†

---

## ğŸ“ å®Œæ•´æŸ¥è¯¢æµç¨‹å›¾

```
å¼€å§‹
  â†“
è·å–å½“å‰è´§ä¸»ID (p_shipper_id)
  â†“
æŸ¥è¯¢è´§ä¸»çš„ hierarchy_path
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŸ¥è¯¢æœ¬çº§è´§ä¸»æ•°æ®                    â”‚
â”‚  - project_partners.partner_id =    â”‚
â”‚    p_shipper_id                     â”‚
â”‚  - æ‰¾åˆ°å…³è”çš„é¡¹ç›®                   â”‚
â”‚  - æ‰¾åˆ°è¿™äº›é¡¹ç›®çš„è¿å•               â”‚
â”‚  - æŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰                   â”‚
â”‚  - ç»Ÿè®¡æ•°é‡ã€é‡é‡ã€é‡‘é¢             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŸ¥è¯¢ä¸‹çº§è´§ä¸»æ•°æ®                    â”‚
â”‚  - partners.hierarchy_path LIKE     â”‚
â”‚    '/uuid-A/%'                      â”‚
â”‚  - æ‰¾åˆ°æ‰€æœ‰ä¸‹çº§è´§ä¸»                 â”‚
â”‚  - æ‰¾åˆ°è¿™äº›è´§ä¸»å…³è”çš„é¡¹ç›®           â”‚
â”‚  - æ‰¾åˆ°è¿™äº›é¡¹ç›®çš„è¿å•               â”‚
â”‚  - æŒ‰æ—¥æœŸèŒƒå›´ç­›é€‰                   â”‚
â”‚  - ç»Ÿè®¡æ•°é‡ã€é‡é‡ã€é‡‘é¢             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»Ÿè®¡å…¶ä»–æŒ‡æ ‡                        â”‚
â”‚  - æ´»è·ƒé¡¹ç›®æ•°                       â”‚
â”‚  - æ´»è·ƒå¸æœºæ•°                       â”‚
â”‚  - å¾…ä»˜æ¬¾è¿å•æ•°                     â”‚
â”‚  - å¾…å¼€ç¥¨è¿å•æ•°                     â”‚
â”‚  - é€¾æœŸä»˜æ¬¾æ•°                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
åˆå¹¶æœ¬çº§å’Œä¸‹çº§æ•°æ®
  â†“
è¿”å›JSONç»“æœ
  â†“
ç»“æŸ
```

---

## ğŸ” è°ƒè¯•æŸ¥è¯¢ç¤ºä¾‹

### æ£€æŸ¥è´§ä¸»å±‚çº§å…³ç³»

```sql
-- æŸ¥çœ‹è´§ä¸»çš„å±‚çº§å…³ç³»
SELECT 
    id,
    name,
    parent_partner_id,
    hierarchy_path,
    hierarchy_depth,
    is_root
FROM partners
WHERE partner_type = 'è´§ä¸»'
ORDER BY hierarchy_depth, name;
```

### æ£€æŸ¥è´§ä¸»å…³è”çš„é¡¹ç›®

```sql
-- æŸ¥çœ‹è´§ä¸»å…³è”çš„é¡¹ç›®
SELECT 
    p.name as è´§ä¸»åç§°,
    pp.project_id,
    pr.name as é¡¹ç›®åç§°
FROM partners p
JOIN project_partners pp ON p.id = pp.partner_id
JOIN projects pr ON pp.project_id = pr.id
WHERE p.id = 'è´§ä¸»UUID'
ORDER BY pr.name;
```

### æ£€æŸ¥è¿å•æ•°æ®

```sql
-- æŸ¥çœ‹è´§ä¸»ç›¸å…³çš„è¿å•
SELECT 
    lr.id,
    lr.auto_number,
    lr.loading_date,
    lr.payable_cost,
    pr.name as é¡¹ç›®åç§°,
    p.name as è´§ä¸»åç§°
FROM logistics_records lr
JOIN project_partners pp ON lr.project_id = pp.project_id
JOIN partners p ON pp.partner_id = p.id
JOIN projects pr ON lr.project_id = pr.id
WHERE p.id = 'è´§ä¸»UUID'
  AND lr.loading_date::date >= '2025-10-15'
  AND lr.loading_date::date <= '2025-11-15'
ORDER BY lr.loading_date DESC;
```

---

## âœ… æ€»ç»“

1. **å±‚çº§å…³ç³»**ï¼šé€šè¿‡ `hierarchy_path` å­—æ®µå­˜å‚¨ï¼Œä½¿ç”¨ `LIKE '/uuid-A/%'` åŒ¹é…æ‰€æœ‰ä¸‹çº§
2. **è¿å•å…³è”**ï¼šå¿…é¡»é€šè¿‡ `project_partners` è¡¨å…³è”ï¼Œä¸èƒ½ç›´æ¥å…³è”
3. **æ•°æ®ç»Ÿè®¡**ï¼šåˆ†åˆ«ç»Ÿè®¡æœ¬çº§å’Œä¸‹çº§ï¼Œç„¶ååˆå¹¶
4. **æ—¥æœŸç­›é€‰**ï¼šä½¿ç”¨ `::date` è½¬æ¢é¿å…æ—¶åŒºé—®é¢˜
5. **å»é‡å¤„ç†**ï¼šä½¿ç”¨ `DISTINCT` é¿å…é‡å¤ç»Ÿè®¡

