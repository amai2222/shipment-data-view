# 运输单据轨迹地图功能配置指南

## 功能概述

运输单据现在支持显示轨迹地图，包括：
- 🗺️ **实时地图显示**：显示起点和终点位置
- 🚗 **路线规划**：自动规划最优运输路线
- 📍 **位置标记**：起点（绿色）和终点（红色）标记
- 📱 **响应式设计**：支持桌面和移动端显示

## 配置步骤

### 1. 获取高德地图API密钥

1. 访问 [高德开放平台](https://lbs.amap.com/)
2. 注册/登录账号
3. 创建应用，选择"Web服务API"
4. 获取API Key

### 2. 配置API密钥

在 `src/services/RouteMapService.ts` 文件中，将 `YOUR_AMAP_KEY` 替换为您的实际API密钥：

```typescript
// 第338行附近
script.src = 'https://webapi.amap.com/maps?v=2.0&key=YOUR_ACTUAL_API_KEY';
```

### 3. 配置域名白名单

在高德开放平台控制台中：
1. 进入应用管理
2. 添加您的域名到白名单
3. 确保包含：
   - `localhost`（开发环境）
   - 您的生产域名

## 功能特性

### 地图显示逻辑
- **只读取已有数据**：仅从 `locations` 表读取已地理编码的地点坐标
- **不进行地理编码**：不会调用地理编码API，只使用现有数据
- **智能降级处理**：如果没有地理编码数据，不显示地图轨迹
- **完整数据要求**：只有当起点和终点都有坐标时才显示地图

### 地图显示条件
1. **起点坐标**：装货地点在 `locations` 表中有成功的地理编码
2. **终点坐标**：卸货地点在 `locations` 表中有成功的地理编码
3. **状态检查**：`geocoding_status = 'success'`

### 无地图情况
- **显示提示**：当缺少地理编码数据时，显示"地点坐标未获取，无法显示地图轨迹"
- **隐藏地图区域**：完全不显示地图部分，保持单据简洁

### 打印支持
- 地图在打印时保持显示
- 支持A4纸张格式
- 地图尺寸自动调整

## 使用示例

```typescript
// 在运输单据生成时自动调用
const routeInfo = await RouteMapService.getRouteInfo(
  '哈尔滨平房区可口可乐',
  '海伦市康道酒饮批发商店'
);

// 生成包含地图的HTML
const mapHTML = RouteMapService.generateMapHTML(routeInfo);
```

## 技术实现

### 坐标获取策略
1. **只读取locations表**：仅从 `locations` 表读取已地理编码的数据
2. **状态验证**：确保 `geocoding_status = 'success'`
3. **降级处理**：如果没有数据，不显示地图轨迹
4. **无API调用**：不进行任何地理编码API调用

### 地图渲染
- 动态加载高德地图JavaScript API
- 使用AMap.Map创建地图实例
- AMap.Driving进行路线规划
- 条件渲染：只有完整数据时才渲染地图

### 性能优化
- 只读取缓存的地理编码数据
- 无API调用开销
- 智能降级处理
- 异步加载地图API

## 故障排除

### 地图不显示
1. **检查地点地理编码状态**：
   - 确认装货和卸货地点在 `locations` 表中
   - 检查 `geocoding_status` 是否为 `'success'`
   - 验证 `latitude` 和 `longitude` 字段有值

2. **地理编码地点**：
   - 使用"地点管理（增强版）"功能
   - 对缺少坐标的地点进行地理编码
   - 确保编码状态为"成功"

3. **API配置**：
   - 检查高德地图API密钥是否正确
   - 确认域名在白名单中
   - 检查网络连接

### 坐标获取失败
1. **地点名称匹配**：
   - 确认运单中的地点名称与 `locations` 表中的 `name` 字段完全一致
   - 检查是否有特殊字符或空格问题

2. **数据完整性**：
   - 确认地点在 `locations` 表中存在
   - 检查 `latitude` 和 `longitude` 字段是否有值
   - 验证 `geocoding_status` 是否为 `'success'`

### 路线规划失败
1. **坐标有效性**：
   - 确认起点和终点坐标都在中国境内
   - 检查坐标格式是否正确

2. **API配额**：
   - 检查高德地图API调用次数限制
   - 验证API密钥权限

## 注意事项

1. **API配额**：高德地图API有调用次数限制
2. **网络依赖**：地图功能需要网络连接
3. **浏览器兼容**：支持现代浏览器
4. **打印限制**：某些浏览器可能限制打印时的地图显示

## 更新日志

- **v1.0.0**：初始版本，支持基础地图显示和路线规划
- 支持起点终点标记
- 支持路线规划
- 支持错误降级处理
