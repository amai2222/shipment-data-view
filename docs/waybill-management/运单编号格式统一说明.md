# 运单编号格式统一说明

## 📋 变更概述

将**数据维护**和**运单管理**的Excel导入功能统一使用相同的运单编号格式。

---

## 🎯 新的统一格式

### 运单编号格式
```
YDN + YYYYMMDD + - + 3位序号
```

### 格式说明
- **YDN**：运单的拼音缩写，固定前缀
- **YYYYMMDD**：装货日期，8位数字
- **-**：分隔符
- **3位序号**：当天的序号，从001开始

### 示例
```
YDN20250108-001
YDN20250108-002
YDN20250108-003
...
YDN20250109-001
YDN20250109-002
```

---

## 🔄 修改内容

### 1. 修改 `generate_auto_number` 函数

**原格式**：`202501080001`（12位纯数字）
**新格式**：`YDN20250108-001`（15位字符）

```sql
CREATE OR REPLACE FUNCTION public.generate_auto_number(loading_date_input text)
RETURNS text
AS $function$
DECLARE
    date_part TEXT;
    next_number INTEGER;
    padded_number TEXT;
BEGIN
    -- 提取日期部分
    date_part := to_char(to_date(loading_date_input, 'YYYY-MM-DD'), 'YYYYMMDD');
    
    -- 获取当天的下一个序号
    SELECT COALESCE(MAX(CAST(substring(auto_number from 12) AS INTEGER)), 0) + 1
    INTO next_number
    FROM public.logistics_records
    WHERE auto_number LIKE 'YDN' || date_part || '-%';
    
    -- 补零到3位数
    padded_number := LPAD(next_number::TEXT, 3, '0');
    
    -- 返回新格式
    RETURN 'YDN' || date_part || '-' || padded_number;
END;
$function$;
```

### 2. 修改 `import_logistics_data` 函数

**原逻辑**：内联SQL生成运单编号
**新逻辑**：调用 `generate_auto_number` 函数

```sql
-- 原来的代码（已移除）
v_auto_number := 'YDN' || to_char(loading_date_formatted, 'YYYYMMDD') || '-' ||
               lpad((
                   COALESCE(
                       (SELECT MAX(substring(auto_number from 12)::integer) + 1
                        FROM public.logistics_records 
                        WHERE loading_date::date = loading_date_formatted::date 
                          AND auto_number LIKE 'YDN%'), 
                       1
                   )
               )::text, 3, '0');

-- 新的代码（统一）
v_auto_number := public.generate_auto_number(record_data->>'loading_date');
```

---

## ✅ 影响范围

### 受影响的功能

#### 1. 数据维护 > 运单维护 > 标准导入
- ✅ 原格式：`202501080001`
- ✅ 新格式：`YDN20250108-001`

#### 2. 运单管理 > 导入Excel
- ✅ 原格式：`YDN20250108-001`
- ✅ 新格式：`YDN20250108-001`（保持不变）

#### 3. 所有手动添加运单的功能
- ✅ 统一使用新格式

---

## 📊 对比表

| 项目 | 修改前（数据维护） | 修改前（运单管理） | 修改后（统一） |
|------|------------------|------------------|--------------|
| **格式** | `YYYYMMDD0001` | `YDN20250108-001` | `YDN20250108-001` |
| **长度** | 12位 | 15位 | 15位 |
| **前缀** | 无 | YDN | YDN |
| **分隔符** | 无 | - | - |
| **序号位数** | 4位 | 3位 | 3位 |
| **最大序号** | 9999 | 999 | 999 |

---

## 🚀 部署步骤

### 1. 执行SQL迁移
```bash
# 在 Supabase Dashboard 中执行
supabase/migrations/unify_waybill_number_format.sql
```

### 2. 验证函数
```sql
-- 测试生成运单编号
SELECT public.generate_auto_number('2025-01-08');
-- 预期结果: YDN20250108-001（或当天的下一个序号）
```

### 3. 测试导入功能
- 测试数据维护 > 运单维护 > 标准导入
- 测试运单管理 > 导入Excel
- 验证生成的运单编号格式是否正确

---

## 🔧 现有数据处理

### 选项1：保持现有编号不变（推荐）
- 现有的运单编号保持原格式
- 只有新导入的运单使用新格式
- 系统可以同时支持两种格式

### 选项2：迁移现有编号（可选）
如果需要将现有的旧格式编号转换为新格式，可以执行以下SQL：

```sql
-- 1. 添加备份列
ALTER TABLE public.logistics_records 
ADD COLUMN IF NOT EXISTS old_auto_number TEXT;

-- 2. 备份并转换旧编号
UPDATE public.logistics_records
SET 
    old_auto_number = auto_number,
    auto_number = 'YDN' || 
                  SUBSTRING(auto_number, 1, 8) || 
                  '-' || 
                  SUBSTRING(auto_number, 9, 3)
WHERE auto_number ~ '^\d{11,12}$'  -- 只转换纯数字格式
  AND auto_number NOT LIKE 'YDN%'; -- 排除已是新格式的
```

**注意**：执行选项2前请务必备份数据库！

---

## ⚠️ 注意事项

### 1. 编号唯一性
- 新格式仍然保证同一天内编号唯一
- 不同天的编号会重新从001开始

### 2. 序号上限
- 新格式每天最多支持999条运单
- 如果超过999条，需要扩展序号位数

### 3. 历史数据兼容
- 系统可以同时支持新旧两种格式
- 查询、搜索功能不受影响

### 4. 导出功能
- Excel导出时会包含新格式的运单编号
- PDF生成功能会显示新格式编号

---

## 🎨 前端显示

### 运单编号显示
新格式更加清晰易读：

```
旧格式：202501080001
新格式：YDN20250108-001

优势：
✓ 有明确的前缀标识
✓ 日期和序号通过分隔符区分
✓ 更易于人工识别和记忆
```

---

## 📈 优势总结

### 1. 统一性
- 所有导入功能使用相同的编号格式
- 减少混淆，提高可维护性

### 2. 可读性
- 前缀 `YDN` 明确标识为运单编号
- 分隔符 `-` 提高可读性

### 3. 可扩展性
- 预留了格式扩展的空间
- 便于未来添加其他类型的编号

### 4. 专业性
- 符合行业标准的编号格式
- 提升系统的专业形象

---

## 🧪 测试清单

### 功能测试
- [ ] 数据维护导入Excel生成新格式编号
- [ ] 运单管理导入Excel生成新格式编号
- [ ] 手动添加运单生成新格式编号
- [ ] 同一天多次导入序号递增正确
- [ ] 不同天的编号序号重置为001
- [ ] 运单详情页显示新格式编号
- [ ] 导出Excel包含新格式编号
- [ ] PDF生成显示新格式编号

### 边界测试
- [ ] 一天导入100条运单（序号到100）
- [ ] 一天导入999条运单（达到上限）
- [ ] 跨天导入，序号正确重置

### 兼容性测试
- [ ] 现有旧格式编号正常显示
- [ ] 查询功能支持新旧两种格式
- [ ] 筛选功能支持新旧两种格式

---

## 📞 问题排查

### 如果编号格式不正确
1. 检查 `generate_auto_number` 函数是否已更新
2. 检查 `import_logistics_data` 函数是否调用了 `generate_auto_number`
3. 清空浏览器缓存重新测试

### 如果序号不连续
1. 检查是否有导入失败的记录
2. 查询当天已有的最大序号
3. 手动调整序号起始值

### 如果出现重复编号
1. 检查数据库函数的并发控制
2. 查看是否有多用户同时导入
3. 考虑添加数据库级别的唯一约束

---

## 📝 总结

**变更类型**：功能优化  
**影响范围**：数据维护、运单管理的Excel导入功能  
**风险等级**：低（保持向后兼容）  
**测试要求**：中等（需要完整的功能测试）  

**变更完成后，所有导入功能将统一使用 `YDN20250108-001` 格式的运单编号。**

---

*文档版本：1.0*  
*最后更新：2025年1月8日*  
*状态：待执行*
