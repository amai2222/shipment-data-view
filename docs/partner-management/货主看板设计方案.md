# 货主看板设计方案

## 📊 功能概述

货主看板是一个为货主用户设计的专属数据看板，展示本级及下级货主的业务数据。

## 🔐 权限规则

### 核心原则
- ✅ **本级数据**：可以查看自己的所有数据
- ✅ **下级数据**：可以查看所有下级货主的数据（无限层级）
- ❌ **上级数据**：不能查看上级货主的数据
- ❌ **平级数据**：不能查看其他分支的货主数据

### 权限实现
利用 `hierarchy_path` 字段：
- 当前货主：`hierarchy_path = '/uuid1/uuid2'`
- 下级货主：`hierarchy_path LIKE '/uuid1/uuid2/%'`

## 📈 看板内容设计

### 1️⃣ 顶部统计卡片（5个）

#### 卡片1：运单总数
```typescript
{
  title: "运单总数",
  value: 1234,
  trend: "+15%",
  icon: "Package",
  color: "blue",
  subtitle: "本级及下级总运单"
}
```

#### 卡片2：总重量
```typescript
{
  title: "总重量",
  value: "12,345.6 吨",
  trend: "+8%",
  icon: "Weight",
  color: "green"
}
```

#### 卡片3：总金额
```typescript
{
  title: "总金额",
  value: "¥1,234,567",
  trend: "+12%",
  icon: "DollarSign",
  color: "purple"
}
```

#### 卡片4：活跃项目
```typescript
{
  title: "活跃项目",
  value: 12,
  subtitle: "共15个项目",
  icon: "Briefcase",
  color: "orange"
}
```

#### 卡片5：合作司机
```typescript
{
  title: "合作司机",
  value: 45,
  subtitle: "活跃司机数量",
  icon: "Users",
  color: "pink"
}
```

### 2️⃣ 下级货主列表（表格）

显示所有下级货主的统计数据：

| 货主名称 | 层级 | 运单数 | 总重量(吨) | 总金额(¥) | 活跃项目 | 待付款 | 操作 |
|---------|------|--------|-----------|-----------|---------|--------|------|
| 中粮集团 | 根节点 | 500 | 5,000 | 500,000 | 5 | 10 | 查看详情 |
| ├─ 中粮贸易 | 一级 | 300 | 3,000 | 300,000 | 3 | 5 | 查看详情 |
| │  └─ 中粮华北 | 二级 | 100 | 1,000 | 100,000 | 1 | 2 | 查看详情 |
| ├─ 中粮物流 | 一级 | 200 | 2,000 | 200,000 | 2 | 3 | 查看详情 |

### 3️⃣ 运单趋势图表（折线图）

- X轴：日期（最近7天/30天）
- Y轴：运单数量
- 多条线：
  - 本级货主
  - 所有下级合计
  - 总计

### 4️⃣ 金额趋势图表（面积图）

- X轴：日期
- Y轴：金额
- 显示本级和下级的金额变化趋势

### 5️⃣ 项目分布（饼图）

按项目统计运单数量或金额占比

### 6️⃣ 常用路线（Top 10）

| 排名 | 装货地 | 卸货地 | 运单数 | 总重量 | 总金额 |
|------|--------|--------|--------|--------|--------|
| 1 | 北京 | 上海 | 100 | 1,000 | 100,000 |
| 2 | 上海 | 广州 | 80 | 800 | 80,000 |

### 7️⃣ 待处理事项

```typescript
{
  pendingPayments: 10,      // 待付款
  pendingInvoices: 5,       // 待开票
  overduePayments: 2,       // 逾期付款
  processingRecords: 8      // 处理中的运单
}
```

## 🗂️ 筛选器

### 时间范围
- 今天
- 最近7天
- 最近30天
- 本月
- 上月
- 自定义日期范围

### 货主范围
- 全部（本级+所有下级）
- 仅本级
- 仅直接下级
- 选择特定货主

### 项目筛选
- 全部项目
- 选择特定项目

## 🎨 界面设计

### 布局结构
```
┌─────────────────────────────────────────────────┐
│ 📊 货主看板 - 中粮集团                            │
│ [时间筛选] [货主范围] [项目筛选] [导出报表]        │
├─────────────────────────────────────────────────┤
│ [运单总数] [总重量] [总金额] [活跃项目] [合作司机]  │
├─────────────────────────────────────────────────┤
│ 📈 运单趋势图                                     │
├─────────────────────────────────────────────────┤
│ 💰 金额趋势图                                     │
├──────────────────────┬──────────────────────────┤
│ 🥧 项目分布          │ 📋 常用路线 Top 10        │
├──────────────────────┴──────────────────────────┤
│ 👥 下级货主统计列表                               │
├─────────────────────────────────────────────────┤
│ ⚠️ 待处理事项                                     │
└─────────────────────────────────────────────────┘
```

## 🔧 技术实现

### 数据库函数

#### 1. 获取货主看板统计数据
```sql
CREATE OR REPLACE FUNCTION get_shipper_dashboard_stats(
  p_shipper_id UUID,
  p_start_date DATE DEFAULT NULL,
  p_end_date DATE DEFAULT NULL,
  p_include_self BOOLEAN DEFAULT TRUE,
  p_include_subordinates BOOLEAN DEFAULT TRUE
)
RETURNS JSON
```

#### 2. 获取下级货主列表及统计
```sql
CREATE OR REPLACE FUNCTION get_subordinate_shippers_stats(
  p_shipper_id UUID,
  p_start_date DATE DEFAULT NULL,
  p_end_date DATE DEFAULT NULL
)
RETURNS TABLE (
  shipper_id UUID,
  shipper_name TEXT,
  hierarchy_depth INTEGER,
  parent_name TEXT,
  record_count BIGINT,
  total_weight NUMERIC,
  total_amount NUMERIC,
  active_projects BIGINT,
  pending_payments BIGINT
)
```

#### 3. 获取运单趋势数据
```sql
CREATE OR REPLACE FUNCTION get_shipper_trend_data(
  p_shipper_id UUID,
  p_days INTEGER DEFAULT 7
)
RETURNS TABLE (
  date DATE,
  self_count BIGINT,
  subordinates_count BIGINT,
  total_count BIGINT,
  self_amount NUMERIC,
  subordinates_amount NUMERIC,
  total_amount NUMERIC
)
```

### 前端组件

#### 页面结构
```
src/pages/
  ├─ ShipperDashboard.tsx          # 桌面端货主看板
  └─ mobile/
      └─ MobileShipperDashboard.tsx # 移动端货主看板
```

#### 核心组件
```typescript
// 统计卡片
<StatCard 
  title="运单总数" 
  value={stats.totalRecords}
  trend={stats.trend}
  icon={Package}
  color="blue"
/>

// 下级货主表格
<SubordinateShippersTable 
  data={subordinates}
  onRowClick={handleViewDetail}
/>

// 趋势图表
<TrendChart 
  data={trendData}
  type="line"
  dataKeys={['self', 'subordinates', 'total']}
/>
```

## 🔒 权限控制

### 前端权限检查
```typescript
// 检查用户是否是货主类型
const isShipperUser = user?.partnerType === '货主';

// 获取当前用户的货主ID
const currentShipperId = user?.partnerId;

// 只有货主用户可以访问货主看板
if (!isShipperUser) {
  navigate('/'); // 重定向到首页
}
```

### 后端权限检查
```sql
-- 在所有函数中检查权限
CREATE OR REPLACE FUNCTION get_shipper_dashboard_stats(...)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_user_shipper_id UUID;
  v_shipper_path TEXT;
BEGIN
  -- 获取当前用户的货主ID
  SELECT partner_id INTO v_user_shipper_id
  FROM auth.users
  WHERE id = auth.uid();
  
  -- 检查权限：只能查看本级或下级
  SELECT hierarchy_path INTO v_shipper_path
  FROM partners
  WHERE id = p_shipper_id;
  
  IF v_shipper_path NOT LIKE (
    SELECT hierarchy_path || '%'
    FROM partners
    WHERE id = v_user_shipper_id
  ) THEN
    RAISE EXCEPTION '无权限查看此货主的数据';
  END IF;
  
  -- ... 继续执行统计逻辑
END;
$$;
```

## 📱 响应式设计

### 桌面端（> 1280px）
- 完整的多列布局
- 显示所有图表和详细数据
- 大尺寸图表

### 平板端（768px - 1280px）
- 两列布局
- 简化的图表
- 折叠部分详细信息

### 移动端（≤ 768px）
- 单列布局
- 卡片式设计
- 可展开的详细信息
- 底部导航栏

## 🚀 实施步骤

### Phase 1: 数据库层（1天）
- [x] 创建统计函数
- [x] 创建权限检查函数
- [x] 测试数据准确性

### Phase 2: 后端API（0.5天）
- [x] 创建 RPC 调用封装
- [x] 测试 API 响应

### Phase 3: 前端UI（2天）
- [ ] 创建桌面端页面
- [ ] 创建移动端页面
- [ ] 实现图表组件
- [ ] 实现筛选器
- [ ] 实现权限控制

### Phase 4: 测试和优化（0.5天）
- [ ] 功能测试
- [ ] 权限测试
- [ ] 性能优化
- [ ] UI/UX 优化

## 📊 数据示例

### 统计数据
```json
{
  "summary": {
    "totalRecords": 1234,
    "totalWeight": 12345.6,
    "totalAmount": 1234567.89,
    "activeProjects": 12,
    "activeDrivers": 45,
    "selfRecords": 234,
    "subordinatesRecords": 1000
  },
  "trends": {
    "recordsTrend": "+15%",
    "weightTrend": "+8%",
    "amountTrend": "+12%"
  },
  "pending": {
    "pendingPayments": 10,
    "pendingInvoices": 5,
    "overduePayments": 2
  }
}
```

### 下级货主列表
```json
[
  {
    "id": "uuid1",
    "name": "中粮贸易",
    "depth": 1,
    "parentName": "中粮集团",
    "recordCount": 300,
    "totalWeight": 3000,
    "totalAmount": 300000,
    "activeProjects": 3,
    "pendingPayments": 5
  }
]
```

## 🎯 成功指标

- ✅ 货主用户可以快速了解业务概况
- ✅ 权限控制准确，数据安全
- ✅ 页面加载速度 < 2秒
- ✅ 支持导出报表功能
- ✅ 移动端体验良好

---

**是否开始实施**：是 ✅  
**预计工作量**：4 天  
**优先级**：高  
**依赖**：货主层级系统已完成

