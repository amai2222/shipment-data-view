# 合作方类型说明 - 完整版

## 📅 更新日期
2025-01-22

## 🏷️ 合作方类型概述

系统支持 **4 种合作方类型**，每种类型有不同的业务用途和权限管理方式：

| 类型 | 说明 | 层级管理 | 权限类型 | 典型用途 |
|------|------|---------|---------|---------|
| **货主** | 货物的拥有者，委托运输的一方 | ✅ 支持 | 层级权限 | 主要客户、托运人 |
| **合作商** | 提供运输服务的合作方 | ❌ 不支持 | 简单权限 | 物流公司、运输商 |
| **资方** | 提供资金支持的合作方 | ❌ 不支持 | 简单权限 | 投资方、金融机构 |
| **本公司** | 本公司自身记录 | ❌ 不支持 | 简单权限 | 公司内部记录 |

---

## 📋 详细说明

### 1. 货主（Owner）

**定义**：货物的拥有者，委托运输的一方

**特点**：
- ✅ 支持无限层级管理
- ✅ 可以建立上下级关系
- ✅ 上级货主可以查看下级数据
- ✅ 下级货主可以查看上级数据
- ✅ 同一层级链路可以互相查看
- ✅ 不同链路完全隔离

**适用场景**：
- 主要客户（大型托运公司）
- 有组织架构的客户群体
- 需要分级管理的货主

**权限规则**：层级权限
- 基于组织架构的层级关系
- 上级看下级，下级看上级
- 同链路互看，跨链路隔离

**默认值**：✅ 是（新建合作方默认为货主）

---

### 2. 合作商（Partner）

**定义**：提供运输服务的合作方

**特点**：
- ❌ 不参与层级管理
- ❌ 无上下级关系
- ✅ 独立的业务实体
- ✅ 只能查看自己创建的数据

**适用场景**：
- 物流公司
- 运输服务商
- 承运商
- 第三方服务提供商

**权限规则**：简单权限
- 只能查看自己创建的记录
- 管理员/财务可以查看所有

**默认值**：❌ 否

---

### 3. 资方（Financier）

**定义**：提供资金支持的合作方

**特点**：
- ❌ 不参与层级管理
- ❌ 无上下级关系
- ✅ 独立的业务实体
- ✅ 只能查看自己创建的数据

**适用场景**：
- 投资方
- 金融机构
- 资金提供方
- 融资租赁公司

**权限规则**：简单权限
- 只能查看自己创建的记录
- 管理员/财务可以查看所有

**默认值**：❌ 否

---

### 4. 本公司（Our Company）

**定义**：本公司自身记录

**特点**：
- ❌ 不参与层级管理
- ❌ 无上下级关系
- ✅ 用于内部记录
- ✅ 只能查看自己创建的数据

**适用场景**：
- 公司自身信息记录
- 内部结算账户
- 自营业务记录

**权限规则**：简单权限
- 只能查看自己创建的记录
- 管理员/财务可以查看所有

**默认值**：❌ 否

---

## 🔐 权限对比

### 层级权限（仅货主）

```
货主A（根节点）
├── 货主B（一级）     ✅ A 可以看 B
│   └── 货主C（二级） ✅ A 可以看 C，B 可以看 C，C 可以看 A 和 B
└── 货主D（一级）     ✅ A 可以看 D，B 和 D 可以互看

货主E（另一个根节点）  ❌ A/B/C/D 都看不到 E（跨链路隔离）
```

### 简单权限（合作商、资方、本公司）

```
合作商A  ✅ 只能看自己的数据
合作商B  ✅ 只能看自己的数据，看不到合作商A
资方C    ✅ 只能看自己的数据，看不到合作商A/B
本公司   ✅ 只能看自己的数据，看不到其他所有
```

**管理员/财务**：✅ 可以查看所有类型的所有数据

---

## 💾 数据库结构

### 枚举类型定义

```sql
CREATE TYPE partner_type_enum AS ENUM (
  '货主',      -- 默认
  '合作商',
  '资方',
  '本公司'
);
```

### 字段定义

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `partner_type` | `partner_type_enum` | `'货主'` | 合作方类型 |

### 层级字段（仅货主使用）

| 字段 | 类型 | 说明 | 货主 | 其他类型 |
|------|------|------|------|---------|
| `parent_partner_id` | UUID | 上级ID | ✅ 使用 | ❌ NULL |
| `hierarchy_path` | TEXT | 层级路径 | ✅ 使用 | ❌ NULL |
| `hierarchy_depth` | INTEGER | 层级深度 | ✅ 使用 | ❌ NULL |
| `is_root` | BOOLEAN | 是否根节点 | ✅ 使用 | ❌ NULL |

---

## 🎯 使用场景示例

### 场景 1：货主层级管理

```typescript
// 创建根节点货主
await supabase.from('partners').insert({
  name: '大型托运集团',
  partner_type: '货主',
  tax_rate: 0.13
});

// 创建下级货主
await supabase.from('partners').insert({
  name: '托运集团华东分公司',
  partner_type: '货主',
  parent_partner_id: '大型托运集团的UUID',
  tax_rate: 0.13
});
```

### 场景 2：独立合作商

```typescript
// 创建独立合作商（不参与层级）
await supabase.from('partners').insert({
  name: '顺丰物流',
  partner_type: '合作商',
  tax_rate: 0.06
});
```

### 场景 3：资金方

```typescript
// 创建资方记录
await supabase.from('partners').insert({
  name: '工商银行供应链金融部',
  partner_type: '资方',
  tax_rate: 0.06
});
```

### 场景 4：本公司记录

```typescript
// 创建本公司记录
await supabase.from('partners').insert({
  name: '本公司-上海分公司',
  partner_type: '本公司',
  tax_rate: 0.13
});
```

---

## 📊 数据统计

### 按类型统计

```sql
SELECT 
  partner_type as "类型",
  COUNT(*) as "数量",
  COUNT(CASE WHEN is_root = TRUE THEN 1 END) as "根节点数",
  COUNT(CASE WHEN parent_partner_id IS NOT NULL THEN 1 END) as "有上级数"
FROM public.partners
GROUP BY partner_type
ORDER BY 
  CASE partner_type
    WHEN '货主' THEN 1
    WHEN '合作商' THEN 2
    WHEN '资方' THEN 3
    WHEN '本公司' THEN 4
  END;
```

### 查询特定类型

```sql
-- 查询所有货主
SELECT * FROM partners WHERE partner_type = '货主';

-- 查询所有合作商
SELECT * FROM partners WHERE partner_type = '合作商';

-- 查询所有资方
SELECT * FROM partners WHERE partner_type = '资方';

-- 查询本公司记录
SELECT * FROM partners WHERE partner_type = '本公司';

-- 查询所有非货主类型
SELECT * FROM partners WHERE partner_type IN ('合作商', '资方', '本公司');
```

---

## 🔄 类型切换

### 切换到货主（启用层级管理）

```typescript
await supabase.from('partners')
  .update({ partner_type: '货主' })
  .eq('id', partnerId);
// 触发器会自动初始化层级字段
```

### 切换到其他类型（禁用层级管理）

```typescript
await supabase.from('partners')
  .update({ partner_type: '合作商' }) // 或 '资方' 或 '本公司'
  .eq('id', partnerId);
// 触发器会自动清空层级字段
```

---

## ⚙️ 前端组件示例

### 类型选择器

```typescript
import { Partner } from '@/types';

type PartnerType = '货主' | '合作商' | '资方' | '本公司';

function PartnerTypeSelector() {
  const [type, setType] = useState<PartnerType>('货主');
  
  return (
    <select 
      value={type} 
      onChange={(e) => setType(e.target.value as PartnerType)}
      className="form-select"
    >
      <option value="货主">货主（支持层级管理）</option>
      <option value="合作商">合作商（独立）</option>
      <option value="资方">资方（独立）</option>
      <option value="本公司">本公司（独立）</option>
    </select>
  );
}
```

### 带说明的选择器

```typescript
function PartnerTypeWithDescription() {
  const [type, setType] = useState<PartnerType>('货主');
  
  const descriptions: Record<PartnerType, string> = {
    '货主': '货物拥有者，支持层级管理，可建立上下级关系',
    '合作商': '运输服务提供商，独立管理，不参与层级',
    '资方': '资金提供方，独立管理，不参与层级',
    '本公司': '公司内部记录，独立管理，不参与层级'
  };
  
  return (
    <div className="space-y-2">
      <select 
        value={type} 
        onChange={(e) => setType(e.target.value as PartnerType)}
      >
        <option value="货主">货主</option>
        <option value="合作商">合作商</option>
        <option value="资方">资方</option>
        <option value="本公司">本公司</option>
      </select>
      <p className="text-sm text-gray-600">{descriptions[type]}</p>
    </div>
  );
}
```

---

## 🔍 验证方法

### 验证类型分布

```sql
SELECT 
  partner_type,
  COUNT(*) as count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) as percentage
FROM partners
GROUP BY partner_type;
```

### 验证层级字段

```sql
-- 货主应该有层级字段
SELECT 
  name,
  partner_type,
  parent_partner_id IS NOT NULL as "有上级",
  hierarchy_path IS NOT NULL as "有路径"
FROM partners
WHERE partner_type = '货主'
LIMIT 10;

-- 其他类型不应该有层级字段
SELECT 
  name,
  partner_type,
  parent_partner_id IS NULL as "上级为空",
  hierarchy_path IS NULL as "路径为空"
FROM partners
WHERE partner_type IN ('合作商', '资方', '本公司')
LIMIT 10;
```

---

## 📚 相关文档

- [合作方类型字段添加说明.md](./合作方类型字段添加说明.md)
- [货主层级管理功能更新说明.md](./货主层级管理功能更新说明.md)
- [货主层级管理_快速迁移指南.md](./货主层级管理_快速迁移指南.md)

---

## ❓ 常见问题

### Q: 为什么默认是货主？
A: 货主是最常见的合作方类型，且支持层级管理，功能最完整。

### Q: 可以有多个"本公司"记录吗？
A: 可以。例如不同分公司、不同部门等可以创建多条记录。

### Q: 资方和合作商有什么区别？
A: 主要是业务角色不同，资方提供资金，合作商提供服务。权限管理方式相同。

### Q: 切换类型会丢失数据吗？
A: 不会丢失基础信息（名称、税率等），只会清空或初始化层级字段。

### Q: 如何批量修改类型？
```sql
UPDATE partners 
SET partner_type = '合作商' 
WHERE id IN ('uuid1', 'uuid2', 'uuid3');
```

---

**文档版本**: v1.0
**最后更新**: 2025-01-22

