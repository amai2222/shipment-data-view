# 合作方类型输入功能添加说明

## 📅 更新日期
2025-01-22

## 🎯 功能说明

在合作方管理页面的新增和编辑表单中添加了**合作方类型选择器**，支持选择以下4种类型：

| 类型 | 说明 | 层级管理 |
|------|------|---------|
| 货主 | 支持层级管理 | ✅ |
| 合作商 | 独立管理 | ❌ |
| 资方 | 独立管理 | ❌ |
| 本公司 | 独立管理 | ❌ |

---

## 📝 修改的文件

### 1. 桌面端合作方管理

**文件**：`src/pages/Partners.tsx`

#### 修改内容：

1. **导入Select组件**
```typescript
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
```

2. **formData添加partnerType字段**
```typescript
const [formData, setFormData] = useState({
  name: '',
  fullName: '',
  bankAccount: '',
  bankName: '',
  branchName: '',
  taxNumber: '',
  companyAddress: '',
  taxRate: 0,
  partnerType: '货主' as '货主' | '合作商' | '资方' | '本公司'  // 新增
});
```

3. **查询时包含partner_type字段**
```typescript
.select(`
  id, name, tax_rate, partner_type, created_at,  // 新增 partner_type
  partner_bank_details ( ... ),
  project_partners ( ... )
`)
```

4. **formattedData添加partnerType**
```typescript
return {
  id: item.id,
  name: item.name,
  // ...其他字段
  partnerType: item.partner_type || '货主',  // 新增
  createdAt: item.created_at,
  projects: [...]
};
```

5. **保存时包含partner_type**
```typescript
const partnerData = {
  user_id: user.id,
  name: formData.name.trim(),
  tax_rate: formData.taxRate,
  partner_type: formData.partnerType  // 新增
};
```

6. **handleEdit包含partnerType**
```typescript
setFormData({
  name: partner.name,
  fullName: partner.fullName || '',
  // ...其他字段
  partnerType: partner.partnerType || '货主'  // 新增
});
```

7. **closeDialog重置partnerType**
```typescript
setFormData({
  name: '',
  // ...其他字段
  partnerType: '货主'  // 新增
});
```

8. **表单中添加类型选择器**
```typescript
<div>
  <Label htmlFor="partnerType">合作方类型 *</Label>
  <Select 
    value={formData.partnerType} 
    onValueChange={(value) => setFormData({ 
      ...formData, 
      partnerType: value as '货主' | '合作商' | '资方' | '本公司' 
    })}
  >
    <SelectTrigger>
      <SelectValue placeholder="选择合作方类型" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="货主">货主（支持层级管理）</SelectItem>
      <SelectItem value="合作商">合作商</SelectItem>
      <SelectItem value="资方">资方</SelectItem>
      <SelectItem value="本公司">本公司</SelectItem>
    </SelectContent>
  </Select>
</div>
```

---

### 2. 移动端合作方管理

**文件**：`src/pages/mobile/MobilePartners.tsx`

#### 修改内容：

完全相同的修改内容（8个地方），适配移动端界面：

1. ✅ 导入Select组件
2. ✅ formData添加partnerType
3. ✅ 查询包含partner_type
4. ✅ formattedData添加partnerType
5. ✅ 保存包含partner_type
6. ✅ handleEdit包含partnerType
7. ✅ resetForm重置partnerType
8. ✅ 表单添加类型选择器

---

## 🎨 界面效果

### 桌面端表单

```
┌─────────────────────────────────┐
│ 添加合作方                      │
├─────────────────────────────────┤
│ 合作方名称 *                    │
│ [________________]              │
│                                 │
│ 合作方类型 *                    │  ← 新增
│ [货主（支持层级管理）  ▼]      │  ← 新增
│                                 │
│ 合作方全名                      │
│ [________________]              │
│                                 │
│ 税号                            │
│ [________________]              │
│                                 │
│ ... 其他字段 ...                │
│                                 │
│           [取消] [添加]          │
└─────────────────────────────────┘
```

### 类型下拉选项

```
┌─────────────────────────────┐
│ 货主（支持层级管理）        │ ← 默认选项
│ 合作商                      │
│ 资方                        │
│ 本公司                      │
└─────────────────────────────┘
```

---

## 💡 使用说明

### 1. 新增合作方

1. 点击"添加合作方"按钮
2. 填写合作方名称
3. **选择合作方类型**（默认为"货主"）
4. 填写其他信息
5. 点击"添加"

**示例**：
- 创建货主：选择"货主（支持层级管理）"
- 创建合作商：选择"合作商"
- 创建资方：选择"资方"
- 创建本公司：选择"本公司"

### 2. 编辑合作方

1. 点击编辑按钮
2. 表单会自动填充当前信息（包括类型）
3. 可以修改类型
4. 点击"更新"

**注意**：
- ⚠️ 将"货主"改为其他类型会清空层级信息
- ⚠️ 将其他类型改为"货主"会初始化层级信息

### 3. 类型切换的影响

#### 改为货主
```typescript
// 合作商 → 货主
触发器会自动：
- 初始化 hierarchy_path
- 设置 hierarchy_depth = 0
- 设置 is_root = TRUE（如果没有上级）
```

#### 改为其他类型
```typescript
// 货主 → 合作商/资方/本公司
触发器会自动：
- 清空 parent_partner_id
- 清空 hierarchy_path
- 清空 hierarchy_depth
- 清空 is_root
```

---

## 🔍 字段验证

### 必填字段

- ✅ 合作方名称
- ✅ 合作方类型
- ✅ 默认税点

### 选填字段

- 合作方全名
- 税号
- 公司地址
- 银行账户
- 开户行名称
- 支行网点

---

## 📊 数据示例

### 创建货主

```json
{
  "name": "某大型托运集团",
  "partner_type": "货主",
  "full_name": "某某大型托运集团有限公司",
  "tax_rate": 0.13,
  "tax_number": "91110000MA1FXXXXXX"
}
```

**结果**：
- ✅ partner_type = '货主'
- ✅ hierarchy_path = '/uuid...'
- ✅ hierarchy_depth = 0
- ✅ is_root = TRUE

### 创建合作商

```json
{
  "name": "顺丰物流",
  "partner_type": "合作商",
  "full_name": "顺丰速运有限公司",
  "tax_rate": 0.06
}
```

**结果**：
- ✅ partner_type = '合作商'
- ✅ hierarchy_path = NULL
- ✅ hierarchy_depth = NULL
- ✅ is_root = NULL

### 创建资方

```json
{
  "name": "工商银行供应链金融部",
  "partner_type": "资方",
  "tax_rate": 0.06
}
```

### 创建本公司

```json
{
  "name": "本公司-上海分公司",
  "partner_type": "本公司",
  "tax_rate": 0.13
}
```

---

## ⚠️ 注意事项

### 1. 类型选择的重要性

- 类型决定是否参与层级管理
- 类型影响权限规则
- 类型影响数据显示范围

### 2. 默认值

- 新增合作方默认类型为"货主"
- 这是最常用的类型，支持层级管理

### 3. 类型修改

- 可以随时修改合作方类型
- 修改会触发层级信息的自动维护
- 建议在创建时就选择正确的类型

### 4. 层级管理

- 只有"货主"类型才会出现在"货主层级管理"页面
- 其他类型在基础的"合作方管理"页面管理

---

## 🧪 测试清单

### 功能测试

- [ ] 新增货主：类型默认为"货主"
- [ ] 新增合作商：可以选择"合作商"
- [ ] 新增资方：可以选择"资方"
- [ ] 新增本公司：可以选择"本公司"
- [ ] 编辑合作方：正确显示当前类型
- [ ] 修改类型：保存成功
- [ ] 类型切换：层级信息自动维护

### 界面测试

- [ ] 桌面端：类型选择器显示正常
- [ ] 移动端：类型选择器显示正常
- [ ] 下拉选项：4个选项都能选择
- [ ] 保存后：类型正确显示

### 数据验证

```sql
-- 验证保存的数据
SELECT id, name, partner_type, hierarchy_path IS NOT NULL as "有层级"
FROM partners
ORDER BY created_at DESC
LIMIT 10;

-- 验证各类型数量
SELECT partner_type, COUNT(*) 
FROM partners 
GROUP BY partner_type;
```

---

## 📚 相关文档

- [合作方类型说明_完整版.md](./合作方类型说明_完整版.md)
- [合作方类型字段添加说明.md](./合作方类型字段添加说明.md)
- [货主层级管理功能更新说明.md](./货主层级管理功能更新说明.md)
- [数据库迁移执行顺序说明.md](./数据库迁移执行顺序说明.md)

---

## ✅ 完成总结

本次更新在合作方管理页面（桌面端和移动端）的新增/编辑表单中添加了合作方类型选择器，用户现在可以：

1. ✅ 新增合作方时选择类型（货主/合作商/资方/本公司）
2. ✅ 编辑合作方时修改类型
3. ✅ 清晰了解各类型的特点（货主支持层级管理）
4. ✅ 自动维护层级信息（切换类型时）

**状态**: ✅ 开发完成，无错误，可以使用！

---

**更新时间**: 2025-01-22
**影响文件**: 2个（桌面端+移动端）
**修改行数**: 约30行
**版本**: v1.0

