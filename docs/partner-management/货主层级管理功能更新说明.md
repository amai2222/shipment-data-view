# 货主层级管理功能更新说明

## 修改概述

将"合作方层级管理"功能改为"货主层级管理"，层级管理功能仅针对 `partner_type = '货主'` 的合作方，合作商类型的合作方不参与层级关系。

## 修改日期

2025-01-22

## 修改原因

- 业务需求：层级管理功能主要用于管理货主的组织架构
- 数据隔离：货主和合作商是不同的业务角色，不应混合管理
- 简化逻辑：合作商通常是独立的服务提供方，不需要层级关系

## 修改内容

### 1. 数据库迁移

**文件**: `supabase/migrations/20250122_update_hierarchy_to_owner_only.sql`

#### 主要变更：

1. **清理合作商层级信息**
   ```sql
   UPDATE public.partners
   SET 
     parent_partner_id = NULL,
     hierarchy_path = NULL,
     hierarchy_depth = NULL,
     is_root = NULL
   WHERE partner_type = '合作商';
   ```

2. **更新触发器函数**
   - 只处理 `partner_type = '货主'` 的记录
   - 合作商的层级字段自动设为 NULL
   - 触发条件增加 `partner_type` 字段变更

3. **更新查询函数**
   - `get_all_subordinate_ids()`: 只返回货主类型的下级
   - `get_all_ancestor_ids()`: 只返回货主类型的上级
   - `can_view_partner()`: 货主使用层级权限，合作商使用简单权限
   - `get_hierarchy_statistics()`: 只统计货主
   - `get_hierarchy_tree()`: 只返回货主的层级树

4. **更新视图**
   - `partners_hierarchy_view`: 只显示货主类型的合作方

5. **更新字段注释**
   - 所有层级相关字段注释都标明"只对货主类型有效"

### 2. 前端组件更新

**文件**: `src/pages/PartnerHierarchyManagement.tsx`

#### 主要变更：

1. **组件标题和说明**
   - 页面标题：`🌳 合作方层级管理` → `🌳 货主层级管理`
   - 副标题：增加"（不包括合作商）"说明
   - 使用说明：所有"合作方"改为"货主"

2. **数据查询**
   ```typescript
   // 只查询货主类型的合作方
   const { data, error } = await supabase
     .from('partners')
     .select('*')
     .eq('partner_type', '货主')  // 新增过滤条件
     .order('name');
   ```

3. **统计显示**
   - "总合作方" → "总货主数"
   - "根节点" → "根节点货主"

4. **搜索提示**
   - "搜索合作方..." → "搜索货主..."

5. **列表说明**
   - "未分配层级的合作方" → "未分配层级的货主"
   - 对话框标题："未分配的合作方" → "未分配的货主"

### 3. 权限规则变更

#### 货主权限（层级权限）

- ✅ 上级货主可以查看所有下级货主（无限层级）
- ✅ 下级货主可以查看所有上级货主
- ✅ 同一层级链路可以互相查看
- ✅ 不同链路完全隔离
- ✅ 管理员/财务可以查看所有货主

#### 其他类型权限（简单权限）

适用于：合作商、资方、本公司

- ✅ 只能查看自己创建的记录
- ✅ 管理员/财务可以查看所有记录
- ❌ 不参与层级关系
- ❌ 不能查看其他同类型记录

## 功能影响范围

### 受影响的功能

1. **货主层级管理页面**
   - 只显示货主类型的合作方
   - 只能管理货主的层级关系
   - 合作商不会出现在层级树中

2. **数据权限**
   - 货主的数据权限基于层级关系
   - 合作商的数据权限不受层级影响

3. **统计报表**
   - 层级统计只包含货主
   - 合作商单独统计

### 不受影响的功能

1. **合作方基础信息管理**
   - 合作方（包括货主和合作商）的增删改查不受影响
   - 在 `/partners` 页面可以正常管理所有类型的合作方

2. **项目关联关系**
   - `project_partners` 表的层级关系（level字段）不受影响
   - 这是另一个独立的层级系统

3. **合作链路管理**
   - `partner_chains` 表不受影响
   - 继续正常工作

## 数据迁移说明

### 自动处理

1. **合作商数据清理**
   - 所有合作商的层级字段自动设为 NULL
   - 包括：`parent_partner_id`, `hierarchy_path`, `hierarchy_depth`, `is_root`

2. **货主数据初始化**
   - 所有货主的层级字段自动初始化
   - 已有层级关系的货主保持不变
   - 未分配层级的货主设为独立节点（不自动设为根节点）

### 无需手动处理

- ✅ 现有数据会自动迁移
- ✅ 合作商的层级信息会被清空
- ✅ 货主的层级信息会被保留
- ✅ 触发器会自动维护后续数据

## 使用指南

### 1. 执行数据库迁移

```bash
# 使用 Supabase CLI
supabase db push

# 或在 Supabase Dashboard SQL Editor 中执行
# 复制 supabase/migrations/20250122_update_hierarchy_to_owner_only.sql 的内容并执行
```

### 2. 管理货主层级

1. 访问 `/partner-hierarchy` 页面
2. 只会显示货主类型的合作方
3. 使用拖拽功能调整货主的上下级关系
4. 设置根节点货主

### 3. 管理合作商

1. 访问 `/partners` 页面
2. 可以查看和管理所有类型的合作方
3. 合作商不会出现在层级管理页面
4. 合作商不受层级权限控制

### 4. 创建新合作方

```typescript
// 创建货主（参与层级管理）
await supabase.from('partners').insert({
  name: '某货主',
  partner_type: '货主',
  tax_rate: 0.13,
  // 可选：指定上级货主
  parent_partner_id: '上级货主UUID'
});

// 创建其他类型（不参与层级管理）
await supabase.from('partners').insert({
  name: '某合作商',
  partner_type: '合作商', // 或 '资方' 或 '本公司'
  tax_rate: 0.13,
  // parent_partner_id 会自动设为 NULL
});
```

## 验证方法

### 1. 验证视图只显示货主

```sql
-- 应该只返回货主类型的记录
SELECT * FROM partners_hierarchy_view;
```

### 2. 验证统计只包含货主

```sql
-- 应该只统计货主
SELECT * FROM get_hierarchy_statistics();
```

### 3. 验证合作商层级信息已清空

```sql
-- 所有合作商的层级字段应该为 NULL
SELECT name, partner_type, parent_partner_id, hierarchy_path, hierarchy_depth, is_root
FROM partners
WHERE partner_type = '合作商';
```

### 4. 验证触发器正确工作

```sql
-- 测试1: 更新货主的上级
UPDATE partners
SET parent_partner_id = '某货主UUID'
WHERE id = '目标货主UUID';
-- 检查 hierarchy_path 和 hierarchy_depth 是否自动更新

-- 测试2: 将货主改为合作商
UPDATE partners
SET partner_type = '合作商'
WHERE id = '某货主UUID';
-- 检查层级字段是否自动清空

-- 测试3: 将合作商改为货主
UPDATE partners
SET partner_type = '货主'
WHERE id = '某合作商UUID';
-- 检查层级字段是否自动初始化
```

### 5. 验证前端页面

1. 访问 `/partner-hierarchy` 页面
2. 确认只显示货主类型的合作方
3. 确认合作商不出现在列表中
4. 测试拖拽功能正常工作

## 兼容性说明

### 向后兼容

- ✅ 现有的合作方数据不会丢失
- ✅ 现有的项目关联关系不受影响
- ✅ 现有的权限系统继续工作
- ✅ API 接口保持不变

### 需要注意的变更

1. **查询结果变化**
   - `partners_hierarchy_view` 只返回货主
   - `get_hierarchy_tree()` 只返回货主
   - 如果有其他地方使用这些视图/函数，需要检查是否需要调整

2. **权限检查**
   - 合作商的权限检查不再基于层级关系
   - 如果有自定义权限逻辑，需要检查是否需要调整

## 回滚方案

如需回滚此修改，可以执行以下操作：

```sql
BEGIN;

-- 1. 恢复触发器函数（移除 partner_type 检查）
CREATE OR REPLACE FUNCTION public.maintain_partner_hierarchy()
RETURNS TRIGGER AS $$
DECLARE
  new_path TEXT;
  new_depth INTEGER;
  is_root_node BOOLEAN;
BEGIN
  -- 不检查 partner_type，处理所有合作方
  new_path := public.calculate_hierarchy_path(NEW.id);
  new_depth := public.calculate_hierarchy_depth(NEW.id);
  is_root_node := (NEW.parent_partner_id IS NULL);
  
  NEW.hierarchy_path := new_path;
  NEW.hierarchy_depth := new_depth;
  NEW.is_root := is_root_node;
  NEW.updated_at := NOW();
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 2. 恢复视图（包括所有合作方）
CREATE OR REPLACE VIEW public.partners_hierarchy_view AS
SELECT 
  p.id,
  p.name,
  p.user_id,
  p.full_name,
  p.tax_rate,
  p.partner_type,
  p.parent_partner_id,
  p.hierarchy_path,
  p.hierarchy_depth,
  p.is_root,
  p.created_at,
  p.updated_at,
  parent.name AS parent_name,
  parent.hierarchy_depth AS parent_depth,
  (SELECT COUNT(*) FROM public.partners WHERE parent_partner_id = p.id) AS direct_children_count,
  (SELECT COUNT(*) FROM public.partners WHERE hierarchy_path LIKE p.hierarchy_path || '%' AND id != p.id) AS total_subordinates_count
FROM public.partners p
LEFT JOIN public.partners parent ON p.parent_partner_id = parent.id;

-- 3. 恢复其他函数（移除 partner_type 过滤）
-- ... 恢复所有函数到之前的版本

-- 4. 前端代码回滚
-- 移除 .eq('partner_type', '货主') 过滤条件
-- 恢复所有"货主"文字为"合作方"

COMMIT;
```

## 测试清单

- [ ] 数据库迁移成功执行
- [ ] 合作商的层级字段已清空
- [ ] 货主的层级信息正常显示
- [ ] 前端页面只显示货主
- [ ] 拖拽功能正常工作
- [ ] 设置根节点功能正常
- [ ] 层级统计只包含货主
- [ ] 权限检查正常工作
- [ ] 新创建的货主自动维护层级
- [ ] 新创建的合作商层级字段为空
- [ ] 类型切换触发器正常工作

## 相关文档

- [合作方类型字段添加说明](./合作方类型字段添加说明.md)
- [合作方层级管理-使用说明](./合作方层级管理-使用说明.md)
- [数据库结构文档](./docs/database-structure.md)

## 常见问题

### Q1: 已有的合作商会怎样？

A: 合作商的层级信息会被清空，但基础信息（名称、税率等）完全保留。合作商不再参与层级关系。

### Q2: 如何将合作商改为货主？

A: 在合作方管理页面修改 `partner_type` 字段，触发器会自动初始化层级信息。

### Q3: 层级管理页面为什么看不到某个合作方？

A: 检查该合作方的 `partner_type` 字段，只有"货主"类型才会出现在层级管理页面。

### Q4: 合作商的权限如何管理？

A: 合作商使用简单权限规则，只能查看自己创建的数据，管理员和财务可以查看所有。

### Q5: 项目中的合作商层级（level字段）会受影响吗？

A: 不会。`project_partners` 表的 level 字段是独立的层级系统，与 partners 表的层级管理无关。

