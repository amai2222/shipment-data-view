# 合作方层级管理 - 使用说明

## 📦 核心文件

1. **数据库迁移**: `supabase/migrations/20250121_add_partner_unlimited_hierarchy.sql`
2. **前端页面**: `src/pages/PartnerHierarchyManagement.tsx`
3. **路由配置**: 已集成到 App.tsx, AppSidebar.tsx, EnhancedHeader.tsx

---

## 🚀 快速开始

### 1. 执行数据库迁移

```powershell
psql -h localhost -p 54322 -U postgres -d postgres -f supabase/migrations/20250121_add_partner_unlimited_hierarchy.sql
```

### 2. 访问页面

```
http://localhost:3000/partners/hierarchy
```

---

## 🎨 页面布局

```
┌────────────────────────────────────────────────┐
│ 🌳 合作方层级管理                              │
│ [🏠 设置根节点 (12)] [管理信息] [刷新]         │
├────────────────────────────────────────────────┤
│ 统计: [总:14] [根:2] [最大深度:0]              │
├────────────────────────────────────────────────┤
│ 🌳 组织架构树 (14)                             │
│                                                │
│ ≡ 🏠 [根] 中粮 | 下级: 0  ▼                   │
│ ≡ 🏠 [根] 邯郸 | 下级: 0  ▼                   │
│                                                │
├─ ⚠️ 未分配层级的合作方 (12) ─────────────────┤
│  ≡ [未分配] 合作方1  ← 拖我                   │
│  ≡ [未分配] 合作方2  ← 拖我                   │
│  ≡ [未分配] 合作方3  ← 拖我                   │
│  ...                                           │
│                                                │
├────────────────────────────────────────────────┤
│         🏠                                     │
│    拖到这里设为根节点                          │
└────────────────────────────────────────────────┘
```

---

## 🎯 功能特性

### 新增字段

- `parent_partner_id` - 上级合作方ID
- `hierarchy_path` - 层级路径（自动维护）
- `hierarchy_depth` - 层级深度（自动维护）
- `is_root` - 是否根节点（自动维护）

### 页面功能

- ✅ 树形结构展示
- ✅ 拖拽调整上下级关系
- ✅ 批量设置根节点
- ✅ 搜索过滤
- ✅ 展开/折叠
- ✅ 统计信息

### 权限规则

- 上级可以查看所有下级数据
- 下级可以查看所有上级数据
- 不同链路完全隔离
- 管理员/财务可以查看所有

---

## 💡 使用流程

### 方式 1: 拖拽操作（推荐）

**建立上下级关系**:
1. 在"未分配"区域找到要移动的合作方
2. 按住鼠标拖拽到目标根节点上
3. 松开鼠标，确认操作
4. 成功！该合作方成为目标的下级

**设为根节点**:
1. 拖拽"未分配"的合作方到底部绿色区域
2. 松开鼠标，确认操作
3. 成功！成为独立的根节点

### 方式 2: 批量设置根节点

1. 点击橙色按钮 **"🏠 设置根节点 (12)"**
2. 在弹窗中勾选要设为根的合作方
3. 点击"设置为根节点"
4. 成功！选中的合作方都成为根节点

---

## 📊 实际表结构

**partners 表**:
- id, name, tax_rate, created_at, user_id, full_name
- parent_partner_id ← 新增
- hierarchy_path ← 新增
- hierarchy_depth ← 新增
- is_root ← 新增
- updated_at ← 新增

**partner_bank_details 表**（一对一关联）:
- partner_id → partners.id
- full_name, tax_number, company_address
- bank_account, bank_name, branch_name

---

## ⚠️ 注意事项

1. **tax_number** 和 **company_address** 在 `partner_bank_details` 表，不在 `partners` 表
2. 初始所有合作方都是未分配状态（需要手动设置根节点）
3. 触发器会自动维护层级路径和深度
4. 不能拖拽到自己的子孙节点（防止循环）

---

**版本**: v1.0  
**最后更新**: 2025-01-21  
**状态**: ✅ 生产就绪

