# 合作方类型更新 - 增加资方和本公司

## 📅 更新日期
2025-01-22

## 🎯 更新内容

在原有的"货主"和"合作商"基础上，新增两种合作方类型：

- ✅ **资方**：提供资金支持的合作方
- ✅ **本公司**：本公司自身记录

现在系统支持 **4 种合作方类型**：
1. 货主（默认）- 支持层级管理
2. 合作商 - 独立管理
3. 资方 - 独立管理（新增）
4. 本公司 - 独立管理（新增）

---

## 📝 修改的文件

### 1. 数据库迁移文件

**`supabase/migrations/20250122_add_partner_type.sql`**
```sql
-- 更新前
CREATE TYPE partner_type_enum AS ENUM ('货主', '合作商');

-- 更新后
CREATE TYPE partner_type_enum AS ENUM ('货主', '合作商', '资方', '本公司');
```

**`supabase/migrations/20250122_update_hierarchy_to_owner_only.sql`**
```sql
-- 更新清理逻辑，包含所有非货主类型
WHERE partner_type IN ('合作商', '资方', '本公司');

-- 更新触发器注释
-- 非货主类型（合作商、资方、本公司）不维护层级信息
```

### 2. TypeScript 类型定义

**`src/types/index.ts`**
```typescript
// 更新前
partnerType?: '货主' | '合作商';

// 更新后
partnerType?: '货主' | '合作商' | '资方' | '本公司';
```

**`src/integrations/supabase/types.ts`**
```typescript
// 更新前
partner_type: '货主' | '合作商'

// 更新后
partner_type: '货主' | '合作商' | '资方' | '本公司'
```

### 3. 文档文件

- ✅ `合作方类型字段添加说明.md` - 更新示例代码
- ✅ `货主层级管理功能更新说明.md` - 更新权限说明
- ✅ `验证合作方类型字段.sql` - 更新测试用例
- ✅ `合作方类型说明_完整版.md` - 新增完整说明文档

---

## 📊 类型对比表

| 类型 | 层级管理 | 权限类型 | 典型用途 | 默认 |
|------|---------|---------|---------|------|
| **货主** | ✅ 支持 | 层级权限 | 主要客户、托运人 | ✅ |
| **合作商** | ❌ 不支持 | 简单权限 | 物流公司、运输商 | ❌ |
| **资方** | ❌ 不支持 | 简单权限 | 投资方、金融机构 | ❌ |
| **本公司** | ❌ 不支持 | 简单权限 | 公司内部记录 | ❌ |

---

## 🎨 使用示例

### 创建资方记录

```typescript
await supabase.from('partners').insert({
  name: '工商银行供应链金融部',
  partner_type: '资方',
  full_name: '中国工商银行股份有限公司供应链金融部',
  tax_rate: 0.06,
  tax_number: '91110000100000XXXX',
  company_address: '北京市西城区复兴门内大街55号'
});
```

### 创建本公司记录

```typescript
await supabase.from('partners').insert({
  name: '本公司-上海分公司',
  partner_type: '本公司',
  full_name: '某某物流有限公司上海分公司',
  tax_rate: 0.13,
  tax_number: '91310000MA1FXXXXXX',
  company_address: '上海市浦东新区世纪大道XXX号'
});
```

### 前端选择器

```typescript
<select value={partnerType} onChange={(e) => setPartnerType(e.target.value)}>
  <option value="货主">货主（支持层级管理）</option>
  <option value="合作商">合作商</option>
  <option value="资方">资方</option>
  <option value="本公司">本公司</option>
</select>
```

---

## 🔍 验证方法

### 1. 验证枚举类型

```sql
-- 应该返回 4 个值
SELECT enum_range(NULL::partner_type_enum);
-- 结果：{货主,合作商,资方,本公司}
```

### 2. 验证各类型数量

```sql
SELECT 
  partner_type as "类型",
  COUNT(*) as "数量"
FROM partners
GROUP BY partner_type
ORDER BY partner_type;
```

### 3. 测试插入各类型

```sql
-- 测试插入所有类型
INSERT INTO partners (name, partner_type, tax_rate)
VALUES 
  ('测试货主', '货主', 0.13),
  ('测试合作商', '合作商', 0.06),
  ('测试资方', '资方', 0.06),
  ('测试本公司', '本公司', 0.13)
RETURNING id, name, partner_type;
```

### 4. 验证层级字段

```sql
-- 货主应该有层级字段
SELECT name, partner_type, hierarchy_path IS NOT NULL as "有路径"
FROM partners
WHERE partner_type = '货主'
LIMIT 5;

-- 其他类型不应该有层级字段
SELECT name, partner_type, hierarchy_path IS NULL as "路径为空"
FROM partners
WHERE partner_type IN ('合作商', '资方', '本公司')
LIMIT 5;
```

---

## ⚙️ 权限规则

### 货主（层级权限）

```typescript
// 上级货主可以查看下级
// 下级货主可以查看上级
// 同一链路可以互相查看
// 不同链路完全隔离
```

### 其他类型（简单权限）

适用于：合作商、资方、本公司

```typescript
// 只能查看自己创建的记录
// 管理员/财务可以查看所有
```

---

## 📚 业务场景

### 场景 1：货主层级管理

```
大型托运集团（货主-根节点）
├── 华东分公司（货主-一级）
│   └── 上海办事处（货主-二级）
└── 华南分公司（货主-一级）
```

### 场景 2：独立合作商

```
顺丰物流（合作商）
德邦物流（合作商）
京东物流（合作商）
```

### 场景 3：资金合作

```
工商银行供应链金融部（资方）
建设银行物流金融中心（资方）
某融资租赁公司（资方）
```

### 场景 4：公司内部

```
本公司-上海分公司（本公司）
本公司-北京分公司（本公司）
本公司-广州分公司（本公司）
```

---

## 🔄 迁移步骤

### 已有数据迁移

如果已经执行过之前的迁移（只有货主和合作商），需要：

1. **更新枚举类型**（如果使用 ALTER TYPE）

```sql
-- 添加新的枚举值
ALTER TYPE partner_type_enum ADD VALUE '资方';
ALTER TYPE partner_type_enum ADD VALUE '本公司';
```

**注意**：PostgreSQL 的 `ALTER TYPE ADD VALUE` 不能在事务中执行。

**推荐方式**：直接使用新的迁移文件，它会自动处理。

2. **执行新的迁移文件**

```bash
supabase db push
```

### 全新安装

直接执行迁移文件即可，会创建包含 4 种类型的枚举。

---

## ⚠️ 注意事项

### 1. 枚举值顺序

PostgreSQL 枚举值的顺序是固定的，一旦创建就无法更改顺序。当前顺序：
1. 货主
2. 合作商
3. 资方
4. 本公司

### 2. 类型切换

可以在任意类型之间自由切换：

```typescript
// 将合作商改为资方
await supabase.from('partners')
  .update({ partner_type: '资方' })
  .eq('id', partnerId);
```

### 3. 层级管理

只有"货主"类型参与层级管理，切换到其他类型会自动清空层级字段。

### 4. 权限影响

- 货主：层级权限
- 其他类型：简单权限（只看自己）

---

## 📈 数据统计示例

### 按类型统计

```sql
SELECT 
  partner_type as "类型",
  COUNT(*) as "数量",
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) as "占比%"
FROM partners
GROUP BY partner_type
ORDER BY COUNT(*) DESC;
```

### 有层级关系的统计

```sql
SELECT 
  '货主（有层级）' as "分类",
  COUNT(*) as "总数",
  COUNT(CASE WHEN is_root = TRUE THEN 1 END) as "根节点",
  COUNT(CASE WHEN parent_partner_id IS NOT NULL THEN 1 END) as "有上级"
FROM partners
WHERE partner_type = '货主'

UNION ALL

SELECT 
  '其他类型（无层级）' as "分类",
  COUNT(*) as "总数",
  0 as "根节点",
  0 as "有上级"
FROM partners
WHERE partner_type IN ('合作商', '资方', '本公司');
```

---

## ✅ 完成清单

- [x] 更新数据库枚举类型（增加资方、本公司）
- [x] 更新触发器函数处理逻辑
- [x] 更新迁移文件注释和提示
- [x] 更新 TypeScript 类型定义
- [x] 更新所有相关文档
- [x] 创建完整的类型说明文档
- [x] 更新验证脚本
- [x] 代码无 Linter 错误

---

## 📞 相关文档

- [合作方类型说明_完整版.md](./合作方类型说明_完整版.md) - 完整的类型说明
- [合作方类型字段添加说明.md](./合作方类型字段添加说明.md) - 字段添加文档
- [货主层级管理功能更新说明.md](./货主层级管理功能更新说明.md) - 层级管理说明
- [货主层级管理_快速迁移指南.md](./货主层级管理_快速迁移指南.md) - 迁移指南

---

## 🎉 更新总结

本次更新成功增加了 **2 种新的合作方类型**（资方、本公司），使系统支持 **4 种合作方类型**，更好地满足业务需求：

1. ✅ **货主** - 核心客户，支持层级管理
2. ✅ **合作商** - 服务提供商
3. ✅ **资方** - 金融合作伙伴（新增）
4. ✅ **本公司** - 内部记录（新增）

所有修改已完成，代码无错误，可以立即部署使用！

---

**更新时间**: 2025-01-22
**版本**: v1.1

