# 货主看板使用指南

## 📋 功能简介

货主看板是专为货主用户设计的数据分析和业务监控页面，提供本级和下级货主的业务数据统计、趋势分析和待处理事项提醒。

## 🎯 核心功能

### 1. 总体统计
- **运单总数**：显示本级和下级的总运单数
- **总重量**：统计所有运单的货物重量
- **总金额**：汇总所有运单的金额
- **活跃项目**：正在运行的项目数量
- **合作司机**：参与运输的司机数量

### 2. 数据分层统计
- **本级数据**：货主自己的业务数据
- **下级数据**：所有下级货主的业务数据
- **总计数据**：本级+下级的汇总数据

### 3. 待处理事项
- **待付款**：需要付款的运单数量
- **待开票**：需要开票的运单数量
- **逾期付款**：超过30天未付款的运单数量（高亮显示）

### 4. 趋势分析
- **运单趋势图**：折线图显示近7天/30天的运单数量变化
- **金额趋势图**：面积图显示收入金额变化趋势
- 支持切换时间范围（7天/30天）

### 5. 项目分布
- 饼图展示各项目的运单数量占比
- 显示百分比和具体数值

### 6. 常用路线 Top 10
- 显示运输最频繁的路线
- 包含运单数、总重量、总金额信息
- 按运单数量降序排列

### 7. 下级货主列表
- 表格形式展示所有下级货主
- 包含：
  - 货主名称和层级关系
  - 运单数、总重量、总金额
  - 活跃项目数
  - 待付款和待开票数量
- 支持查看详情

## 🔐 权限控制

### 数据可见性
✅ **可以查看**：
- 本级货主的所有数据
- 所有下级货主的数据（无限层级）

❌ **不能查看**：
- 上级货主的数据
- 其他分支（平级）货主的数据

### 访问权限
**允许访问的角色**：
- 管理员 (admin)
- 财务 (finance)
- 业务 (business)
- 查看者 (viewer)

**前提条件**：
- 用户必须是货主类型的合作方
- 用户的 `partnerId` 必须指向一个 `partner_type = '货主'` 的记录

## 🎨 界面设计

### 桌面端
访问路径：`/dashboard/shipper`

**特点**：
- 多列布局，数据密集型
- 完整的图表和统计信息
- 大尺寸数据展示

**主要区域**：
1. **页面头部**：筛选器和操作按钮
2. **统计卡片**：5个彩色卡片展示核心指标
3. **待处理事项**：橙色提示卡片
4. **趋势图表**：2个图表（运单和金额）
5. **项目分布和Top路线**：并排显示
6. **下级货主表格**：详细列表

### 移动端/平板端
访问路径：`/m/dashboard/shipper`

**特点**：
- 单列布局，卡片式设计
- 触摸友好的交互
- 响应式适配

**主要区域**：
1. **顶部信息卡**：渐变背景，显示总体数据
2. **筛选器**：时间范围选择
3. **待处理事项**：折叠式卡片
4. **统计网格**：2列布局
5. **趋势图**：简化版折线图
6. **下级货主列表**：可展开详情的卡片

## 🔧 筛选功能

### 时间范围筛选
- **最近7天**：查看近一周数据
- **最近30天**：查看近一个月数据（默认）
- **本月**：查看本月数据
- **上月**：查看上个月数据

### 货主范围筛选（桌面端）
- **全部（本级+下级）**：查看所有数据（默认）
- **仅本级**：只看本级货主的数据
- **仅直接下级**：只看直接下级的数据

### 趋势周期筛选
- **7天**：查看近一周趋势
- **30天**：查看近一个月趋势

## 📊 数据说明

### 统计周期
- 默认统计周期为最近30天
- 可通过筛选器调整统计周期
- 不同筛选器独立工作

### 数据计算规则

**运单数量**：
- 本级：直接关联到当前货主的运单
- 下级：所有下级货主（包括子子孙）的运单

**重量统计**：
- 优先使用卸货重量（`unloading_weight`）
- 如果卸货重量为空，则使用装货重量（`loading_weight`）

**金额统计**：
- 使用运单的 `payable_cost` 字段
- 自动汇总计算

**活跃项目**：
- 统计当前有关联运单的项目数量
- 本级和下级的项目去重计数

**合作司机**：
- 统计参与运输的司机数量
- 在选定时间范围内有运单的司机

**逾期付款**：
- 定义：付款状态为"待付款"且装货日期超过30天

## 🚀 使用流程

### 首次使用

1. **确认权限**
   - 确保您是货主类型用户
   - 确认您的账号关联了货主信息

2. **访问页面**
   - 桌面端：点击左侧菜单"数据看板" → "货主看板"
   - 移动端：点击菜单"数据看板" → "货主看板"

3. **查看数据**
   - 系统自动加载最近30天的数据
   - 查看总体统计和趋势图表

### 日常使用

1. **监控业务数据**
   - 查看今日/本周/本月的运单数量
   - 关注待处理事项提醒

2. **分析趋势**
   - 通过趋势图了解业务增长情况
   - 对比本级和下级的业务占比

3. **管理下级货主**
   - 查看下级货主的业务情况
   - 点击"查看详情"深入了解

4. **导出报表**
   - 点击"导出报表"按钮
   - 生成Excel或PDF格式的数据报表

## 📱 移动端特色功能

### 一键刷新
- 下拉页面刷新数据
- 点击刷新按钮手动更新

### 详细信息切换
- 点击"详细/隐藏"按钮
- 展开或折叠下级货主的详细信息

### 触摸优化
- 大按钮设计，易于点击
- 卡片滑动交互
- 手势支持

## ⚠️ 注意事项

### 权限限制
1. **非货主用户**无法访问货主看板
   - 系统会显示权限不足提示
   - 需要联系管理员配置货主权限

2. **数据隔离**
   - 只能看到自己和下级的数据
   - 不能看到上级或平级货主的数据

### 数据准确性
1. **实时性**
   - 数据每次打开页面时自动加载
   - 点击刷新按钮获取最新数据

2. **统计口径**
   - 所有统计基于已录入系统的运单
   - 未录入或删除的运单不计入统计

3. **层级关系**
   - 确保货主层级关系正确配置
   - 错误的层级关系会导致数据统计不准确

## 🔍 常见问题

### Q1：为什么我看不到货主看板？
**A**：可能的原因：
1. 您不是货主类型用户
2. 您的角色没有访问权限
3. 您的账号未关联货主信息

**解决方法**：
- 联系管理员检查您的账号配置
- 确认您的角色权限

### Q2：为什么数据显示为0？
**A**：可能的原因：
1. 选定时间范围内没有运单
2. 您的货主没有关联项目
3. 数据还未同步

**解决方法**：
- 调整时间范围重新查看
- 检查项目配置和合作方设置
- 点击刷新按钮重新加载

### Q3：下级货主列表是空的？
**A**：可能的原因：
1. 您是叶子节点（没有下级）
2. 下级货主未正确配置层级关系

**解决方法**：
- 在"货主层级管理"中配置下级关系
- 确认层级路径正确

### Q4：待处理事项数量不对？
**A**：可能的原因：
1. 运单状态未及时更新
2. 付款或开票记录未同步

**解决方法**：
- 检查运单的付款状态和开票状态
- 刷新页面重新加载数据

### Q5：趋势图没有数据？
**A**：可能的原因：
1. 选定时间范围内确实没有运单
2. 数据加载失败

**解决方法**：
- 调整时间范围
- 检查网络连接
- 刷新页面

## 📈 数据分析建议

### 业务增长分析
1. **对比周期数据**
   - 对比本周与上周的运单数量
   - 分析增长或下降原因

2. **关注趋势变化**
   - 查看趋势图的走势
   - 识别业务高峰和低谷

3. **项目占比分析**
   - 了解哪些项目贡献最多
   - 优化资源配置

### 下级货主管理
1. **业绩对比**
   - 对比各下级货主的业绩
   - 识别表现优异或需要帮助的下级

2. **资源分配**
   - 根据业务量分配资源
   - 优化运输路线和司机调度

3. **问题识别**
   - 关注待付款和逾期付款数量
   - 及时处理财务问题

### 运营优化
1. **路线优化**
   - 分析Top路线数据
   - 优化常用路线的运输成本

2. **司机管理**
   - 监控活跃司机数量
   - 确保司机资源充足

3. **项目管理**
   - 关注活跃项目数量
   - 及时启动或关闭项目

## 🛠️ 技术支持

### 数据库函数
货主看板使用以下数据库函数：
- `get_shipper_dashboard_stats()`：获取总体统计
- `get_subordinate_shippers_stats()`：获取下级货主列表
- `get_shipper_trend_data()`：获取趋势数据
- `get_shipper_top_routes()`：获取Top路线
- `get_shipper_project_distribution()`：获取项目分布

### 性能优化
- 使用索引优化查询性能
- 缓存常用数据
- 分页加载大量数据

### 故障排查
如遇到问题，请：
1. 检查浏览器控制台错误信息
2. 查看网络请求是否成功
3. 确认数据库函数是否正常
4. 联系技术支持

## 📝 更新日志

### v1.0.0 (2025-01-22)
- ✨ 初始版本发布
- 📊 完整的货主看板功能
- 📱 移动端和桌面端支持
- 🔐 层级权限控制
- 📈 趋势分析和数据可视化

---

**版本**：v1.0.0  
**更新日期**：2025-01-22  
**适用范围**：货主用户

如有问题或建议，请联系系统管理员。

