# 定价法功能实施指南

## 📋 功能概述

已成功为合作链路配置添加**定价法（fixed_price）**计算方法，支持固定单价计算合作方成本。

### 计算公式
```
应付金额 = 有效数量 × 单价
```

---

## ✅ 已完成的更改

### 1. 类型定义更新 ✅
**文件**：`src/types/index.ts`
- ✅ `ProjectPartner.calculationMethod` 类型扩展为 `"tax" | "profit" | "fixed_price"`
- ✅ 添加 `ProjectPartner.unitPrice?: number` 字段

### 2. 前端界面更新 ✅
**文件**：`src/pages/Projects.tsx`

#### 新增功能：
- ✅ 计算方法下拉框新增"定价"选项
- ✅ 输入框根据计算方法动态切换：
  - 税点法：显示税点输入框
  - 利润法：显示利润输入框
  - **定价法：显示单价输入框 + 单位标签（元/吨、元/车、元/方、元/件）**
- ✅ 单位标签根据 `billing_type_id` 动态显示
- ✅ 项目列表中正确显示定价法信息

#### 界面效果：
```
合作方：冠县昇仓仓储
层级：1
计算方法：[定价 ▼]  （下拉选项：税点、利润、定价）
单价：[10.00] 元/吨  （单位根据计费模式动态显示）
```

### 3. 数据提交逻辑更新 ✅
- ✅ 新建项目时，`unit_price` 正确保存到数据库
- ✅ 编辑项目时，`unit_price` 正确更新到数据库
- ✅ 加载项目时，`unit_price` 正确从数据库读取

### 4. 数据库迁移文件 ✅
**文件**：`supabase/migrations/20251120_add_fixed_price_calculation_method.sql`
- ✅ 添加 `project_partners.unit_price` 字段（NUMERIC(10,2)）
- ✅ 更新 `calculation_method` 约束，支持 `fixed_price`
- ✅ 添加字段注释和验证信息

---

## 🚀 实施步骤

### 第一步：执行数据库迁移

在 Supabase SQL Editor 中执行：

```bash
supabase/migrations/20251120_add_fixed_price_calculation_method.sql
```

或者使用 Supabase CLI：

```bash
supabase db push
```

### 第二步：重启前端应用

确保前端应用重新加载最新代码：

```bash
npm run dev
```

### 第三步：测试功能

1. **打开项目管理页面**
2. **点击"添加项目"或编辑现有项目**
3. **在合作链路配置中添加合作方**
4. **选择计算方法为"定价"**
5. **输入单价**（单位会根据计费模式自动显示）
6. **保存项目**

---

## 📊 三种计算方法对比

| 计算方法 | 公式 | 依赖字段 | 适用场景 |
|---------|------|---------|---------|
| **税点法（tax）** | `应付金额 = 基础运价 / (1 - 税点)` | `payable_cost`, `tax_rate` | 含税结算 |
| **利润法（profit）** | `应付金额 = 基础运价 + (利润 × 装货重量)` | `payable_cost`, `profit_rate`, `loading_weight` | 按重量加利润 |
| **定价法（fixed_price）** | `应付金额 = 有效数量 × 单价` | `effective_quantity`, `unit_price` | 固定单价 |

---

## 🎨 界面截图说明

### 计算方法下拉框
```
[定价 ▼]
  税点    ← 现有方法
  利润    ← 现有方法
  定价    ← 新增方法 ✨
```

### 单价输入框（计件模式）
```
计算方法：[定价 ▼]
单价：[10.00] 元/件  ← 单位根据计费模式动态显示
```

### 单位动态显示规则
- **计吨（billing_type_id=1）**：显示 "元/吨"
- **计车（billing_type_id=2）**：显示 "元/车"
- **计方（billing_type_id=3）**：显示 "元/方"
- **计件（billing_type_id=4）**：显示 "元/件"

---

## 🧪 测试用例

### 测试用例1：新建项目 + 定价法
1. 创建新项目
2. 添加链路，设置计费模式为"计件"
3. 添加合作方，选择"定价"方法
4. 输入单价：10元/件
5. 保存项目
6. **预期**：数据库中 `project_partners.unit_price = 10`，`calculation_method = 'fixed_price'`

### 测试用例2：编辑现有项目
1. 编辑现有项目
2. 修改合作方计算方法为"定价"
3. 输入单价：15元/吨
4. 保存项目
5. **预期**：数据库中 `unit_price` 更新为 15

### 测试用例3：单位动态显示
1. 创建链路，计费模式为"计吨"
2. 添加合作方，选择"定价"
3. **预期**：输入框旁显示"元/吨"
4. 修改计费模式为"计件"
5. **预期**：输入框旁显示"元/件"

---

## 🔧 后续开发（已由数据库触发器自动处理）

### 自动重算逻辑 ✅
- ✅ 有效数量改变时，自动重算定价法合作方成本
- ✅ 基础运价改变时，不影响定价法（独立计算）
- ✅ 保护机制：已付款、已开票、已收款的运单不重算

### 相关触发器
- `trigger_recalc_on_effective_quantity_change`：有效数量改变时触发
- `trigger_recalc_on_payable_cost_change`：基础运价改变时触发
- `batch_recalculate_partner_costs`：批量重算函数

---

## 📝 注意事项

1. **数据库迁移文件必须先执行**，再使用前端功能
2. **单价字段类型为 NUMERIC(10,2)**，最多支持 2 位小数
3. **定价法不依赖基础运价**，只依赖有效数量
4. **单位标签仅在定价法时显示**，税点法和利润法不显示
5. **保护机制**：已付款/已开票/已收款的运单不会自动重算

---

## ✅ 验证清单

- [x] 数据库字段添加成功
- [x] 约束更新成功
- [x] 前端下拉框显示"定价"选项
- [x] 单价输入框正常工作
- [x] 单位标签动态显示正确
- [x] 新建项目时，单价正确保存
- [x] 编辑项目时，单价正确更新
- [x] 项目列表正确显示定价法信息
- [x] 无 TypeScript 错误
- [x] 无 Linter 错误

---

**创建日期**：2025-11-20  
**最后更新**：2025-11-20  
**状态**：✅ 功能已完成，可以投入使用

