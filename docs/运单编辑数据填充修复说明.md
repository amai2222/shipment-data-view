# 运单编辑数据填充修复说明

## 问题描述

在运单编辑模式下，打开编辑对话框时，以下关键字段没有正确填充：

- **司机**：显示"选择司机"占位符，而不是当前记录的司机
- **司机电话**：显示"选择司机后自动填充"占位符
- **车牌号**：显示"选择司机后自动填充"占位符  
- **装货地点**：显示"已选择 0/5 个地点"
- **卸货地点**：显示"已选择 0/5 个地点"

## 问题原因

1. **数据加载时机问题**：`populateFormWithRecord` 函数在 `locations` 和 `drivers` 数据还没有加载完成时就被调用
2. **地点ID映射失败**：`findLocationIdsByName` 函数在 `locations` 数组为空时返回空数组
3. **司机信息缺失**：当前记录的司机可能不在加载的司机列表中
4. **地点信息缺失**：当前记录的地点可能不在加载的地点列表中

## 修复方案

### 1. 分步数据填充

**修改前**：
```typescript
useEffect(() => {
  if (isOpen) {
    if (editingRecord) {
      populateFormWithRecord(editingRecord); // 一次性填充所有数据
    } else {
      setFormData(INITIAL_FORM_DATA);
    }
  }
}, [isOpen, editingRecord]);
```

**修改后**：
```typescript
useEffect(() => {
  if (isOpen) {
    if (editingRecord) {
      // 先设置基本信息，等数据加载完成后再填充地点和司机信息
      setFormData({
        projectId: editingRecord.project_id || '',
        chainId: editingRecord.chain_id || '',
        driverId: editingRecord.driver_id || '',
        loadingLocationIds: [],
        unloadingLocationIds: [],
        // ... 其他基本字段
      });
    } else {
      setFormData(INITIAL_FORM_DATA);
    }
  }
}, [isOpen, editingRecord]);
```

### 2. 延迟填充地点和司机信息

**新增**：
```typescript
// 在编辑模式下，当数据加载完成后填充地点和司机信息
useEffect(() => {
  if (editingRecord && locations.length > 0 && drivers.length > 0) {
    // 解析装卸货地点
    const loadingLocationNames = parseLocationString(editingRecord.loading_location || '');
    const unloadingLocationNames = parseLocationString(editingRecord.unloading_location || '');
    
    // 确保当前司机在司机列表中
    const currentDriver = drivers.find(d => d.id === editingRecord.driver_id);
    if (!currentDriver && editingRecord.driver_id) {
      loadDriverById(editingRecord.driver_id);
    }
    
    // 确保地点在地点列表中
    const missingLocations = [...loadingLocationNames, ...unloadingLocationNames]
      .filter(name => !locations.find(l => l.name === name));
    
    if (missingLocations.length > 0) {
      createMissingLocations(missingLocations);
    }
    
    setFormData(prev => ({
      ...prev,
      loadingLocationIds: findLocationIdsByName(loadingLocationNames),
      unloadingLocationIds: findLocationIdsByName(unloadingLocationNames),
    }));
  }
}, [editingRecord, locations, drivers]);
```

### 3. 动态加载缺失数据

**新增司机加载函数**：
```typescript
const loadDriverById = async (driverId: string) => {
  try {
    const { data, error } = await supabase
      .from('drivers')
      .select('*')
      .eq('id', driverId)
      .single();
    
    if (error) throw error;
    if (data) {
      setDrivers(prev => {
        // 如果司机不在列表中，添加到列表
        if (!prev.find(d => d.id === driverId)) {
          return [...prev, data];
        }
        return prev;
      });
    }
  } catch (error) {
    console.error('Error loading driver:', error);
  }
};
```

**新增地点创建函数**：
```typescript
const createMissingLocations = async (locationNames: string[]) => {
  try {
    const { data, error } = await supabase.rpc('get_or_create_locations_from_string', {
      p_location_string: locationNames.join('|')
    });
    
    if (error) throw error;
    if (data) {
      setLocations(prev => {
        const newLocations = data.filter((loc: any) => !prev.find(l => l.id === loc.id));
        return [...prev, ...newLocations];
      });
    }
  } catch (error) {
    console.error('Error creating locations:', error);
  }
};
```

## 修复效果

### 修复前
- 司机字段：显示"选择司机"占位符
- 司机电话：显示"选择司机后自动填充"占位符
- 车牌号：显示"选择司机后自动填充"占位符
- 装货地点：显示"已选择 0/5 个地点"
- 卸货地点：显示"已选择 0/5 个地点"

### 修复后
- 司机字段：正确显示当前记录的司机信息
- 司机电话：自动填充当前记录的司机电话
- 车牌号：自动填充当前记录的车牌号
- 装货地点：正确显示当前记录的装货地点（支持多地点）
- 卸货地点：正确显示当前记录的卸货地点（支持多地点）

## 测试验证

### 测试脚本
```sql
-- 执行 scripts/test-waybill-edit-fix.sql
-- 创建测试数据并验证修复效果
```

### 测试步骤
1. 创建测试项目、司机、地点和运单记录
2. 打开运单编辑对话框
3. 验证所有字段是否正确填充
4. 清理测试数据

### 预期结果
- 所有字段都能正确显示当前记录的数据
- 多地点信息正确解析和显示
- 司机信息正确关联和显示

## 技术要点

1. **数据加载时机**：确保在相关数据加载完成后再进行字段填充
2. **动态数据补充**：对于缺失的司机和地点数据，动态加载或创建
3. **多地点支持**：正确解析和显示 `|` 分隔的多地点字符串
4. **错误处理**：添加适当的错误处理和日志记录

## 相关文件

- `src/pages/BusinessEntry/components/LogisticsFormDialog.tsx` - 主要修复文件
- `scripts/test-waybill-edit-fix.sql` - 测试脚本
- `docs/运单编辑数据填充修复说明.md` - 本文档

## 更新日志

- 2025-01-20: 创建初始版本
- 2025-01-20: 修复数据加载时机问题
- 2025-01-20: 添加动态数据加载功能
- 2025-01-20: 完善多地点支持
