# å…±äº«ä»£ç æ¨¡å—éƒ¨ç½²æŒ‡å—

## ğŸ“‹ é‡è¦è¯´æ˜

**`_shared` ç›®å½•ä¸‹çš„å…±äº«ä»£ç æ¨¡å—ä¸éœ€è¦å•ç‹¬éƒ¨ç½²ï¼**

å®ƒä»¬ä¼š**è‡ªåŠ¨**éšç€å¼•ç”¨å®ƒä»¬çš„ Edge Functions ä¸€èµ·éƒ¨ç½²ã€‚

## ğŸ” å·¥ä½œåŸç†

### Supabase Edge Functions éƒ¨ç½²æœºåˆ¶

å½“æ‚¨éƒ¨ç½²ä¸€ä¸ª Edge Function æ—¶ï¼ŒSupabase CLI ä¼šï¼š

1. **æ‰«æå‡½æ•°ä»£ç **ï¼šæŸ¥æ‰¾æ‰€æœ‰ `import` è¯­å¥
2. **è§£æç›¸å¯¹è·¯å¾„**ï¼šè¯†åˆ« `../_shared/` å¯¼å…¥
3. **è‡ªåŠ¨åŒ…å«å…±äº«ä»£ç **ï¼šå°†å…±äº«æ¨¡å—æ‰“åŒ…åˆ°å‡½æ•°ä¸­
4. **ä¸€èµ·éƒ¨ç½²**ï¼šå…±äº«ä»£ç å’Œå‡½æ•°ä»£ç ä¸€èµ·ä¸Šä¼ 

### ç¤ºä¾‹

```typescript
// supabase/functions/add-vehicle/index.ts
import { getToken } from '../_shared/token-cache.ts';
```

å½“éƒ¨ç½² `add-vehicle` æ—¶ï¼š
- âœ… `add-vehicle/index.ts` ä¼šè¢«éƒ¨ç½²
- âœ… `_shared/token-cache.ts` **è‡ªåŠ¨åŒ…å«**åœ¨éƒ¨ç½²åŒ…ä¸­
- âœ… æ— éœ€å•ç‹¬éƒ¨ç½² `_shared` ç›®å½•

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹æ³•1ï¼šä½¿ç”¨ Supabase CLIï¼ˆæ¨èï¼‰

#### æ­¥éª¤1ï¼šéƒ¨ç½²æ‰€æœ‰ä½¿ç”¨å…±äº«æ¨¡å—çš„å‡½æ•°

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ

# 1. ç™»å½• Supabaseï¼ˆå¦‚æœè¿˜æ²¡ç™»å½•ï¼‰
supabase login

# 2. é“¾æ¥é¡¹ç›®ï¼ˆå¦‚æœè¿˜æ²¡é“¾æ¥ï¼‰
supabase link --project-ref <your-project-ref>

# 3. éƒ¨ç½²æ‰€æœ‰ä½¿ç”¨å…±äº«æ¨¡å—çš„å‡½æ•°
supabase functions deploy get-tracking-token
supabase functions deploy add-vehicle
supabase functions deploy vehicle-tracking
supabase functions deploy sync-vehicle-tracking-ids
supabase functions deploy sync-vehicle
```

**é‡è¦**ï¼šéƒ¨ç½²è¿™äº›å‡½æ•°æ—¶ï¼Œ`_shared/token-cache.ts` ä¼šè‡ªåŠ¨åŒ…å«åœ¨éƒ¨ç½²åŒ…ä¸­ã€‚

#### æ­¥éª¤2ï¼šéªŒè¯éƒ¨ç½²

éƒ¨ç½²å®Œæˆåï¼Œæ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š

```
âœ… ä»å…±äº«æ¨¡å—è·å–åˆ° Token
```

è€Œä¸æ˜¯ï¼š

```
âœ… ä» get-tracking-token æœåŠ¡è·å–åˆ° Token
```

### æ–¹æ³•2ï¼šä¸€æ¬¡æ€§éƒ¨ç½²æ‰€æœ‰å‡½æ•°

```bash
# éƒ¨ç½²æ‰€æœ‰ Edge Functionsï¼ˆåŒ…æ‹¬ä½¿ç”¨å…±äº«æ¨¡å—çš„å‡½æ•°ï¼‰
supabase functions deploy
```

è¿™ä¼šéƒ¨ç½²æ‰€æœ‰å‡½æ•°ï¼Œå…±äº«æ¨¡å—ä¼šè‡ªåŠ¨åŒ…å«ã€‚

### æ–¹æ³•3ï¼šé€šè¿‡ Supabase Dashboardï¼ˆä¸æ¨èï¼‰

**æ³¨æ„**ï¼šé€šè¿‡ Dashboard æ‰‹åŠ¨éƒ¨ç½²æ—¶ï¼Œéœ€è¦ç¡®ä¿ï¼š

1. **å¤åˆ¶å®Œæ•´çš„å‡½æ•°ä»£ç **ï¼ˆåŒ…æ‹¬å¯¼å…¥è¯­å¥ï¼‰
2. **å…±äº«æ¨¡å—ä»£ç ä¸ä¼šè¢«åŒ…å«**ï¼ˆDashboard ä¸æ”¯æŒå…±äº«æ¨¡å—ï¼‰
3. **éœ€è¦æ‰‹åŠ¨å¤„ç†ä¾èµ–**

**æ¨è**ï¼šä½¿ç”¨ CLI éƒ¨ç½²ï¼Œè‡ªåŠ¨å¤„ç†å…±äº«æ¨¡å—ã€‚

## ğŸ“Š éƒ¨ç½²éªŒè¯

### 1. æ£€æŸ¥éƒ¨ç½²æ—¥å¿—

éƒ¨ç½²æ—¶åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```bash
Deploying function get-tracking-token...
Deploying function add-vehicle...
  â†’ Including shared module: _shared/token-cache.ts
Deploying function vehicle-tracking...
  â†’ Including shared module: _shared/token-cache.ts
...
```

### 2. æµ‹è¯•å‡½æ•°

```bash
# æµ‹è¯• add-vehicleï¼ˆåº”è¯¥ä½¿ç”¨å…±äº«æ¨¡å—ï¼‰
curl -X POST https://<your-project-ref>.supabase.co/functions/v1/add-vehicle \
  -H "Authorization: Bearer <your-anon-key>" \
  -H "Content-Type: application/json" \
  -d '{"licensePlate": "æµ‹è¯•è½¦ç‰Œ", "loadWeight": "10"}'
```

### 3. æŸ¥çœ‹å‡½æ•°æ—¥å¿—

åœ¨ Supabase Dashboard ä¸­ï¼š
1. è¿›å…¥ **Edge Functions** é¡µé¢
2. é€‰æ‹©å‡½æ•°ï¼ˆå¦‚ `add-vehicle`ï¼‰
3. æŸ¥çœ‹ **Logs** æ ‡ç­¾é¡µ
4. åº”è¯¥çœ‹åˆ°ï¼š`âœ… ä»å…±äº«æ¨¡å—è·å–åˆ° Token`

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: å…±äº«æ¨¡å—ä¿®æ”¹åéœ€è¦é‡æ–°éƒ¨ç½²å—ï¼Ÿ

**A**: æ˜¯çš„ï¼ä¿®æ”¹å…±äº«æ¨¡å—åï¼Œéœ€è¦é‡æ–°éƒ¨ç½²æ‰€æœ‰ä½¿ç”¨å®ƒçš„å‡½æ•°ã€‚

```bash
# ä¿®æ”¹ _shared/token-cache.ts åï¼Œé‡æ–°éƒ¨ç½²æ‰€æœ‰ä½¿ç”¨å®ƒçš„å‡½æ•°
supabase functions deploy get-tracking-token
supabase functions deploy add-vehicle
supabase functions deploy vehicle-tracking
supabase functions deploy sync-vehicle-tracking-ids
supabase functions deploy sync-vehicle
```

### Q2: å¯ä»¥å•ç‹¬éƒ¨ç½²å…±äº«æ¨¡å—å—ï¼Ÿ

**A**: ä¸å¯ä»¥ã€‚å…±äº«æ¨¡å—ä¸æ˜¯ç‹¬ç«‹çš„ Edge Functionï¼Œå®ƒåªæ˜¯ä»£ç æ¨¡å—ã€‚

å…±äº«æ¨¡å—ä¼šéšç€ä½¿ç”¨å®ƒçš„å‡½æ•°ä¸€èµ·éƒ¨ç½²ã€‚

### Q3: å¦‚ä½•çŸ¥é“å“ªäº›å‡½æ•°ä½¿ç”¨äº†å…±äº«æ¨¡å—ï¼Ÿ

**A**: æœç´¢å¯¼å…¥è¯­å¥ï¼š

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
grep -r "from '../_shared/token-cache.ts'" supabase/functions/
```

æˆ–æŸ¥çœ‹ä»¥ä¸‹å‡½æ•°ï¼š
- `get-tracking-token`
- `add-vehicle`
- `vehicle-tracking`
- `sync-vehicle-tracking-ids`
- `sync-vehicle`

### Q4: éƒ¨ç½²æ—¶å‡ºç° "Module not found" é”™è¯¯ï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **è·¯å¾„æ˜¯å¦æ­£ç¡®**ï¼š
   ```typescript
   // âœ… æ­£ç¡®
   import { getToken } from '../_shared/token-cache.ts';
   
   // âŒ é”™è¯¯
   import { getToken } from './_shared/token-cache.ts';
   ```

2. **æ–‡ä»¶æ˜¯å¦å­˜åœ¨**ï¼š
   ```bash
   # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   ls supabase/functions/_shared/token-cache.ts
   ```

3. **æ‰©å±•åæ˜¯å¦æ­£ç¡®**ï¼š
   ```typescript
   // âœ… æ­£ç¡®ï¼ˆåŒ…å« .ts æ‰©å±•åï¼‰
   import { getToken } from '../_shared/token-cache.ts';
   
   // âŒ é”™è¯¯ï¼ˆç¼ºå°‘æ‰©å±•åï¼‰
   import { getToken } from '../_shared/token-cache';
   ```

### Q5: å…±äº«æ¨¡å—çš„ä»£ç åœ¨å“ªé‡Œï¼Ÿ

**A**: å…±äº«æ¨¡å—ä½äºï¼š

```
supabase/functions/_shared/token-cache.ts
```

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰æ£€æŸ¥ï¼š

- [ ] `_shared/token-cache.ts` æ–‡ä»¶å­˜åœ¨
- [ ] æ‰€æœ‰å‡½æ•°æ­£ç¡®å¯¼å…¥å…±äº«æ¨¡å—
- [ ] å¯¼å…¥è·¯å¾„ä½¿ç”¨ç›¸å¯¹è·¯å¾„ `../_shared/`
- [ ] å¯¼å…¥è¯­å¥åŒ…å« `.ts` æ‰©å±•å
- [ ] Supabase CLI å·²å®‰è£…å¹¶ç™»å½•
- [ ] é¡¹ç›®å·²æ­£ç¡®é“¾æ¥

éƒ¨ç½²åéªŒè¯ï¼š

- [ ] æ‰€æœ‰å‡½æ•°éƒ¨ç½²æˆåŠŸ
- [ ] æ—¥å¿—æ˜¾ç¤º "ä»å…±äº«æ¨¡å—è·å–åˆ° Token"
- [ ] å‡½æ•°æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æå‡ï¼ˆå»¶è¿Ÿå‡å°‘ï¼‰

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ä¿®æ”¹å…±äº«æ¨¡å—å

```bash
# 1. ä¿®æ”¹ _shared/token-cache.ts
# 2. é‡æ–°éƒ¨ç½²æ‰€æœ‰ä½¿ç”¨å®ƒçš„å‡½æ•°
supabase functions deploy get-tracking-token
supabase functions deploy add-vehicle
supabase functions deploy vehicle-tracking
supabase functions deploy sync-vehicle-tracking-ids
supabase functions deploy sync-vehicle
```

### 2. æ·»åŠ æ–°çš„å…±äº«æ¨¡å—

1. åœ¨ `supabase/functions/_shared/` åˆ›å»ºæ–°æ–‡ä»¶
2. åœ¨å‡½æ•°ä¸­å¯¼å…¥ä½¿ç”¨
3. éƒ¨ç½²ä½¿ç”¨å®ƒçš„å‡½æ•°ï¼ˆå…±äº«æ¨¡å—è‡ªåŠ¨åŒ…å«ï¼‰

### 3. ç‰ˆæœ¬æ§åˆ¶

å…±äº«æ¨¡å—çš„ç‰ˆæœ¬ç”±ä½¿ç”¨å®ƒçš„å‡½æ•°å†³å®šï¼š
- æ¯ä¸ªå‡½æ•°éƒ¨ç½²æ—¶ï¼Œä¼šåŒ…å«å½“å‰ç‰ˆæœ¬çš„å…±äº«æ¨¡å—
- ä¸åŒå‡½æ•°å¯ä»¥åŒ…å«ä¸åŒç‰ˆæœ¬çš„å…±äº«æ¨¡å—ï¼ˆä¸æ¨èï¼‰

**æ¨è**ï¼šä¿æŒæ‰€æœ‰å‡½æ•°ä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„å…±äº«æ¨¡å—ã€‚

## ğŸ“Š éƒ¨ç½²å‘½ä»¤æ€»ç»“

### å®Œæ•´éƒ¨ç½²æµç¨‹

```bash
# 1. ç™»å½•ï¼ˆå¦‚æœè¿˜æ²¡ç™»å½•ï¼‰
supabase login

# 2. é“¾æ¥é¡¹ç›®ï¼ˆå¦‚æœè¿˜æ²¡é“¾æ¥ï¼‰
supabase link --project-ref <your-project-ref>

# 3. éƒ¨ç½²æ‰€æœ‰ä½¿ç”¨å…±äº«æ¨¡å—çš„å‡½æ•°
supabase functions deploy get-tracking-token
supabase functions deploy add-vehicle
supabase functions deploy vehicle-tracking
supabase functions deploy sync-vehicle-tracking-ids
supabase functions deploy sync-vehicle

# 4. éªŒè¯éƒ¨ç½²
# æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤ä½¿ç”¨å…±äº«æ¨¡å—
```

### å¿«é€Ÿéƒ¨ç½²è„šæœ¬

åˆ›å»º `deploy-token-functions.ps1`ï¼ˆWindowsï¼‰ï¼š

```powershell
# deploy-token-functions.ps1
Write-Host "å¼€å§‹éƒ¨ç½² Token ç›¸å…³å‡½æ•°..." -ForegroundColor Green

supabase functions deploy get-tracking-token
supabase functions deploy add-vehicle
supabase functions deploy vehicle-tracking
supabase functions deploy sync-vehicle-tracking-ids
supabase functions deploy sync-vehicle

Write-Host "éƒ¨ç½²å®Œæˆï¼" -ForegroundColor Green
```

ä½¿ç”¨ï¼š

```powershell
.\deploy-token-functions.ps1
```

## âœ… æ€»ç»“

### å…³é”®ç‚¹

1. **å…±äº«æ¨¡å—ä¸éœ€è¦å•ç‹¬éƒ¨ç½²**
2. **ä¼šè‡ªåŠ¨åŒ…å«åœ¨ä½¿ç”¨å®ƒçš„å‡½æ•°ä¸­**
3. **ä¿®æ”¹å…±äº«æ¨¡å—åï¼Œéœ€è¦é‡æ–°éƒ¨ç½²æ‰€æœ‰ä½¿ç”¨å®ƒçš„å‡½æ•°**
4. **ä½¿ç”¨ Supabase CLI éƒ¨ç½²ï¼Œè‡ªåŠ¨å¤„ç†å…±äº«æ¨¡å—**

### éƒ¨ç½²æµç¨‹

```
ä¿®æ”¹å…±äº«æ¨¡å—
    â†“
é‡æ–°éƒ¨ç½²æ‰€æœ‰ä½¿ç”¨å®ƒçš„å‡½æ•°
    â†“
å…±äº«æ¨¡å—è‡ªåŠ¨åŒ…å«åœ¨éƒ¨ç½²åŒ…ä¸­
    â†“
éƒ¨ç½²å®Œæˆ âœ…
```

---

**æœ€åæ›´æ–°**ï¼š2025-01-16  
**çŠ¶æ€**ï¼šâœ… å…±äº«æ¨¡å—éƒ¨ç½²æœºåˆ¶è¯´æ˜å®Œæˆ

