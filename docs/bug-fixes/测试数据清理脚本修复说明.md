# æµ‹è¯•æ•°æ®æ¸…ç†è„šæœ¬ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

æ‰§è¡Œæ¸…ç†æµ‹è¯•æ•°æ®è„šæœ¬æ—¶é‡åˆ°é”™è¯¯ï¼š

```
ERROR: 42703: column lr.partner_id does not exist
```

## ğŸ” é—®é¢˜åŸå› 

**æ•°æ®åº“è¡¨ç»“æ„ç†è§£é”™è¯¯**ï¼š

1. **åŸè„šæœ¬å‡è®¾**ï¼š`logistics_records` è¡¨æœ‰ `partner_id` å­—æ®µ
2. **å®é™…æƒ…å†µ**ï¼š`logistics_records` è¡¨**æ²¡æœ‰** `partner_id` å­—æ®µ

### æ­£ç¡®çš„æ•°æ®åº“å…³ç³»

æ ¹æ®æ•°æ®åº“ schemaï¼š

```sql
-- è¿å•è¡¨
CREATE TABLE logistics_records (
    id uuid PRIMARY KEY,
    auto_number text NOT NULL,
    project_id uuid,
    driver_id uuid,
    chain_id uuid,  -- åˆä½œé“¾è·¯ID
    -- æ²¡æœ‰ partner_id å­—æ®µï¼
    ...
);

-- è¿å•åˆä½œæ–¹æˆæœ¬è¡¨ï¼ˆå…³è”è¡¨ï¼‰
CREATE TABLE logistics_partner_costs (
    id uuid PRIMARY KEY,
    logistics_record_id uuid NOT NULL,  -- è¿å•ID
    partner_id uuid NOT NULL,           -- åˆä½œæ–¹ID
    level integer NOT NULL,
    base_amount numeric(12,2),
    payable_amount numeric(12,2),
    ...
);
```

**è¿å•å’Œåˆä½œæ–¹çš„å…³ç³»**ï¼š
- ä¸€ä¸ªè¿å•å¯ä»¥å…³è”**å¤šä¸ªåˆä½œæ–¹**ï¼ˆé€šè¿‡åˆä½œé“¾è·¯ï¼‰
- å…³è”å…³ç³»å­˜å‚¨åœ¨ `logistics_partner_costs` è¡¨ä¸­
- **ä¸æ˜¯ç›´æ¥å…³è”**ï¼Œè€Œæ˜¯**å¤šå¯¹å¤šå…³ç³»**

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹1ï¼šç»Ÿè®¡æµ‹è¯•æ•°æ®

**ä¿®å¤å‰**ï¼š
```sql
SELECT COUNT(*) INTO v_logistics_count
FROM public.logistics_records lr
JOIN public.partners p ON lr.partner_id = p.id  -- âŒ é”™è¯¯ï¼šlr.partner_id ä¸å­˜åœ¨
WHERE p.full_name LIKE '%æµ‹è¯•%';
```

**ä¿®å¤å**ï¼š
```sql
SELECT COUNT(*) INTO v_logistics_cost_count
FROM public.logistics_partner_costs lpc  -- âœ“ ä½¿ç”¨æ­£ç¡®çš„å…³è”è¡¨
JOIN public.partners p ON lpc.partner_id = p.id
WHERE p.full_name LIKE '%æµ‹è¯•%';
```

### ä¿®æ”¹2ï¼šåˆ é™¤æµ‹è¯•æ•°æ®

**ä¿®å¤å‰**ï¼š
```sql
DELETE FROM public.logistics_records 
WHERE partner_id IN (  -- âŒ é”™è¯¯ï¼špartner_id ä¸å­˜åœ¨
    SELECT id FROM public.partners 
    WHERE full_name LIKE '%æµ‹è¯•%'
);
```

**ä¿®å¤å**ï¼š
```sql
-- åªåˆ é™¤åˆä½œæ–¹æˆæœ¬è®°å½•ï¼Œä¸åˆ é™¤æ•´ä¸ªè¿å•
DELETE FROM public.logistics_partner_costs 
WHERE partner_id IN (  -- âœ“ æ­£ç¡®ï¼šåœ¨å…³è”è¡¨ä¸­åˆ é™¤
    SELECT id FROM public.partners 
    WHERE full_name LIKE '%æµ‹è¯•%'
);
```

### ä¿®æ”¹3ï¼šéªŒè¯æ¸…ç†ç»“æœ

**ä¿®å¤å‰**ï¼š
```sql
SELECT COUNT(*) as remaining_test_records
FROM public.logistics_records lr
WHERE EXISTS (
    SELECT 1 FROM public.partners p 
    WHERE lr.partner_id = p.id  -- âŒ é”™è¯¯ï¼šlr.partner_id ä¸å­˜åœ¨
    AND p.full_name LIKE '%æµ‹è¯•%'
);
```

**ä¿®å¤å**ï¼š
```sql
SELECT COUNT(*) as remaining_test_records
FROM public.logistics_partner_costs lpc  -- âœ“ ä½¿ç”¨æ­£ç¡®çš„å…³è”è¡¨
JOIN public.partners p ON lpc.partner_id = p.id
WHERE p.full_name LIKE '%æµ‹è¯•%';
```

## ğŸ“Š ä¿®å¤åçš„æ¸…ç†é€»è¾‘

### æ¸…ç†é¡ºåº

1. âœ… **åˆ é™¤æµ‹è¯•åˆä½œæ–¹çš„æˆæœ¬è®°å½•**
   - è¡¨ï¼š`logistics_partner_costs`
   - åŸå› ï¼šåŒ…å«å¤–é”®çº¦æŸï¼Œéœ€è¦å…ˆåˆ é™¤

2. âœ… **åˆ é™¤æµ‹è¯•åˆä½œæ–¹çš„é“¶è¡Œè¯¦æƒ…**
   - è¡¨ï¼š`partner_bank_details`
   - åŸå› ï¼šåŒ…å«å¤–é”®çº¦æŸï¼Œéœ€è¦å…ˆåˆ é™¤

3. âœ… **åˆ é™¤æµ‹è¯•åˆä½œæ–¹**
   - è¡¨ï¼š`partners`
   - åŸå› ï¼šä¸»è¡¨ï¼Œæœ€ååˆ é™¤

### ä¸ºä»€ä¹ˆä¸åˆ é™¤è¿å•ï¼Ÿ

- è¿å•å¯èƒ½å…³è”**å¤šä¸ªåˆä½œæ–¹**
- åªéœ€åˆ é™¤**æµ‹è¯•åˆä½œæ–¹çš„æˆæœ¬è®°å½•**
- ä¿ç•™è¿å•æœ¬èº«å’Œå…¶ä»–çœŸå®åˆä½œæ–¹çš„æˆæœ¬è®°å½•

## ğŸš€ ä½¿ç”¨æ–¹æ³•

ä¿®å¤åçš„è„šæœ¬å¯ä»¥å®‰å…¨æ‰§è¡Œï¼š

1. ç™»å½• Supabase Dashboard
2. æ‰“å¼€ SQL Editor
3. å¤åˆ¶ `æ‰§è¡Œæ¸…ç†æµ‹è¯•æ•°æ®.sql` çš„å†…å®¹
4. ç²˜è´´å¹¶æ‰§è¡Œ

## ğŸ“ é¢„æœŸæ‰§è¡Œç»“æœ

```
============================
å‘ç°æµ‹è¯•æ•°æ®ç»Ÿè®¡ï¼š
- æµ‹è¯•åˆä½œæ–¹æ•°é‡ï¼š1
- æµ‹è¯•åˆä½œæ–¹æˆæœ¬è®°å½•æ•°é‡ï¼š5
- æµ‹è¯•é“¶è¡Œè¯¦æƒ…æ•°é‡ï¼š1
============================

å¼€å§‹æ¸…ç†æµ‹è¯•æ•°æ®...
âœ“ å·²åˆ é™¤ 5 æ¡æµ‹è¯•åˆä½œæ–¹æˆæœ¬è®°å½•
âœ“ å·²åˆ é™¤ 1 æ¡æµ‹è¯•é“¶è¡Œè¯¦æƒ…
âœ“ å·²åˆ é™¤ 1 æ¡æµ‹è¯•åˆä½œæ–¹

============================
æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆï¼
============================

éªŒè¯æ¸…ç†ç»“æœï¼š
table_name             | remaining_test_records
-----------------------+----------------------
partners               | 0
partner_bank_details   | 0
logistics_partner_costs| 0

âœ“ æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆï¼
```

## ğŸ¯ å…³é”®è¦ç‚¹

1. **æ•°æ®åº“è¡¨ç»“æ„**ï¼š
   - `logistics_records` è¡¨ä¸­**æ²¡æœ‰** `partner_id` å­—æ®µ
   - è¿å•å’Œåˆä½œæ–¹é€šè¿‡ `logistics_partner_costs` è¡¨å…³è”

2. **å¤šå¯¹å¤šå…³ç³»**ï¼š
   - ä¸€ä¸ªè¿å•å¯ä»¥å…³è”å¤šä¸ªåˆä½œæ–¹ï¼ˆåˆä½œé“¾è·¯ï¼‰
   - ä¸èƒ½ç®€å•åœ°é€šè¿‡è¿å•è¡¨ç›´æ¥å…³è”åˆä½œæ–¹

3. **æ¸…ç†ç­–ç•¥**ï¼š
   - åªåˆ é™¤æµ‹è¯•åˆä½œæ–¹çš„**æˆæœ¬è®°å½•**
   - **ä¸åˆ é™¤æ•´ä¸ªè¿å•**ï¼ˆé¿å…å½±å“å…¶ä»–åˆä½œæ–¹ï¼‰

## ğŸ”§ ç¬¬äºŒæ¬¡ä¿®å¤ï¼šuser_id NOT NULL çº¦æŸé”™è¯¯

### é—®é¢˜æè¿°

æ‰§è¡Œä¿®å¤åçš„è„šæœ¬æ—¶é‡åˆ°æ–°é”™è¯¯ï¼š

```
ERROR: 23502: null value in column "user_id" of relation "logistics_partner_costs" violates not-null constraint
```

### é—®é¢˜åŸå› 

åˆ é™¤ `partners` è¡¨è®°å½•æ—¶ï¼Œä¼šè§¦å‘ `ON DELETE CASCADE` çº§è”åˆ é™¤ `project_partners` è¡¨ä¸­çš„è®°å½•ï¼Œè¿™ä¼šè§¦å‘è‡ªåŠ¨é‡ç®—è§¦å‘å™¨ï¼š

```sql
CREATE TRIGGER trigger_auto_recalc_on_project_partner_change
  AFTER INSERT OR UPDATE OR DELETE ON public.project_partners
  FOR EACH ROW
  EXECUTE FUNCTION public.auto_recalc_on_project_partner_change();
```

è¿™ä¸ªè§¦å‘å™¨è°ƒç”¨ `recalculate_costs_for_chain_safe()` å‡½æ•°é‡ç®—æˆæœ¬ï¼Œå°è¯•æ’å…¥æ–°çš„ `logistics_partner_costs` è®°å½•ï¼Œä½†æ²¡æœ‰æä¾› `user_id`ã€‚

### è§£å†³æ–¹æ¡ˆ

åœ¨æ¸…ç†æµ‹è¯•æ•°æ®å‰ï¼Œ**ç¦ç”¨æ‰€æœ‰è§¦å‘å™¨**ï¼ˆä½¿ç”¨ä¼šè¯çº§åˆ«è®¾ç½®ï¼‰ï¼š

```sql
-- ç¦ç”¨æ‰€æœ‰è§¦å‘å™¨ï¼ˆä¼šè¯çº§åˆ«ï¼‰
SET session_replication_role = replica;

-- æ¸…ç†æµ‹è¯•æ•°æ®
-- ...

-- é‡æ–°å¯ç”¨æ‰€æœ‰è§¦å‘å™¨
SET session_replication_role = DEFAULT;
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ `session_replication_role = replica`ï¼Ÿ**
- âœ… ç¦ç”¨æ‰€æœ‰ç”¨æˆ·å®šä¹‰çš„è§¦å‘å™¨
- âœ… åªåœ¨å½“å‰ä¼šè¯ç”Ÿæ•ˆï¼Œä¸å½±å“å…¶ä»–è¿æ¥
- âœ… æ¯”å•ç‹¬ç¦ç”¨è§¦å‘å™¨æ›´å½»åº•ã€æ›´å¯é 
- âœ… æ‰§è¡Œå®Œæˆåè‡ªåŠ¨æ¢å¤

### ä¿®å¤åçš„æ¸…ç†é¡ºåº

1. âœ… **ç¦ç”¨æ‰€æœ‰è§¦å‘å™¨** (`SET session_replication_role = replica`)
2. âœ… **åˆ é™¤æµ‹è¯•åˆä½œæ–¹çš„é¡¹ç›®é…ç½®** (`project_partners`)
3. âœ… **åˆ é™¤æµ‹è¯•åˆä½œæ–¹çš„æˆæœ¬è®°å½•** (`logistics_partner_costs`)
4. âœ… **åˆ é™¤æµ‹è¯•åˆä½œæ–¹çš„é“¶è¡Œè¯¦æƒ…** (`partner_bank_details`)
5. âœ… **åˆ é™¤æµ‹è¯•åˆä½œæ–¹** (`partners`)
6. âœ… **é‡æ–°å¯ç”¨æ‰€æœ‰è§¦å‘å™¨** (`SET session_replication_role = DEFAULT`)

## ğŸ“… ä¿®å¤è®°å½•

### ç¬¬ä¸€æ¬¡ä¿®å¤
- **é—®é¢˜**ï¼š`lr.partner_id` å­—æ®µä¸å­˜åœ¨
- **æ—¶é—´**ï¼š2025-10-25
- **è§£å†³**ï¼šæ”¹ç”¨ `logistics_partner_costs` è¡¨å…³è”

### ç¬¬äºŒæ¬¡ä¿®å¤
- **é—®é¢˜**ï¼š`user_id` NOT NULL çº¦æŸé”™è¯¯ï¼ˆè§¦å‘å™¨å¹²æ‰°ï¼‰
- **æ—¶é—´**ï¼š2025-10-25
- **è§£å†³**ï¼šä½¿ç”¨ `SET session_replication_role = replica` ç¦ç”¨æ‰€æœ‰è§¦å‘å™¨

---

**ä¿®å¤å®Œæˆ**ï¼šè„šæœ¬å·²å®Œå…¨ä¿®å¤ï¼Œå¯ä»¥å®‰å…¨æ‰§è¡Œï¼âœ…

