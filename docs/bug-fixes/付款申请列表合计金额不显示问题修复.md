# 付款申请列表合计金额不显示问题修复

## 🐛 问题描述

在付款申请列表页面，筛选"已支付"状态时，合计金额列不显示或显示为"-"。

**截图显示**：
- 运单数正常显示
- 其他列正常显示
- 唯独"申请金额"列显示为"-"

---

## 🔍 问题原因

### 根本原因

在`fetchPaymentRequests`函数中，从后端RPC函数获取数据后，映射到前端state时**遗漏了`max_amount`字段**。

**问题代码**（Line 130-137）：
```typescript
setRequests(requestsData.map(item => ({
  id: item.id,
  created_at: item.created_at,
  request_id: item.request_id,
  status: item.status,
  notes: item.notes,
  logistics_record_ids: item.logistics_record_ids,
  record_count: item.record_count
  // ❌ 缺少: max_amount: item.max_amount
})));
```

### 为什么会发生

1. 后端RPC函数 `get_payment_requests_filtered` 正确返回了 `max_amount`
2. 但前端在数据映射时忘记了这个字段
3. 导致前端state中的 `max_amount` 始终为 `undefined`
4. 显示时判断为假值，显示为"-"

---

## ✅ 修复方案

### 修复代码

```typescript
// ✅ 添加 max_amount 字段映射
setRequests(requestsData.map(item => ({
  id: item.id,
  created_at: item.created_at,
  request_id: item.request_id,
  status: item.status,
  notes: item.notes,
  logistics_record_ids: item.logistics_record_ids,
  record_count: item.record_count,
  max_amount: item.max_amount  // ✅ 添加申请金额字段
})));
```

**修改位置**：`src/pages/PaymentRequestsList.tsx` Line 137

---

## 🧪 验证

### 测试步骤

1. 打开付款申请列表页面
2. 筛选"已支付"状态
3. 查看申请金额列
4. ✅ 应该正常显示金额

### 预期结果

```
运单编号        状态      运单数   申请金额
FK-001         已支付      5条    ¥2,977.50 ✅
FK-002         已支付     17条   ¥32,138.42 ✅
FK-003         已支付     10条   ¥35,746.61 ✅
```

---

## 📊 影响范围

### 受影响的功能

| 功能 | 影响 | 修复后 |
|------|------|--------|
| 筛选已支付 | ❌ 金额不显示 | ✅ 正常显示 |
| 筛选待审批 | ❌ 金额不显示 | ✅ 正常显示 |
| 筛选已审批 | ❌ 金额不显示 | ✅ 正常显示 |
| 筛选全部 | ❌ 金额不显示 | ✅ 正常显示 |

### 为什么所有筛选都受影响？

因为问题在数据映射环节，无论筛选什么状态，都会经过这个映射逻辑，所以所有情况下的 `max_amount` 都不显示。

---

## 🔧 技术细节

### PaymentRequest接口

```typescript
interface PaymentRequest {
  id: string;
  created_at: string;
  request_id: string;
  status: 'Pending' | 'Approved' | 'Paid' | 'Rejected' | 'Cancelled';
  notes: string | null;
  logistics_record_ids: string[];
  record_count: number;
  max_amount?: number; // ✅ 接口定义是正确的
}
```

### 显示逻辑

```typescript
<TableCell className="text-right">
  {req.max_amount ? `¥${req.max_amount.toLocaleString()}` : '-'}
</TableCell>
```

**逻辑分析**：
- 如果 `req.max_amount` 存在且为数字 → 显示格式化金额
- 如果 `req.max_amount` 为 `undefined` 或 `0` → 显示"-"

**之前的问题**：`req.max_amount` 始终为 `undefined`

---

## 🎯 最佳实践

### 数据映射完整性检查

**原则**：前端state的字段应该与后端返回的字段一一对应

**检查清单**：
```typescript
// ✅ 推荐：完整映射所有字段
setRequests(requestsData.map(item => ({
  ...item,  // 或者逐个列出所有字段
  // 确保不遗漏任何字段
})));

// ❌ 不推荐：选择性映射容易遗漏
setRequests(requestsData.map(item => ({
  id: item.id,
  name: item.name,
  // 遗漏其他字段...
})));
```

---

## 📝 修复总结

**修改文件**：`src/pages/PaymentRequestsList.tsx`

**修改内容**：
- ✅ 在数据映射时添加 `max_amount` 字段
- ✅ Line 137添加：`max_amount: item.max_amount`

**影响**：
- ✅ 修复所有筛选条件下金额不显示的问题
- ✅ 不影响其他功能
- ✅ 向后兼容

**测试**：
- ✅ 所有状态筛选都能正常显示金额
- ✅ 0个新增错误

---

**修复完成时间**：2025-01-31  
**问题严重性**：中等（影响数据展示但不影响功能）  
**修复难度**：简单（一行代码）  
**文件归档位置**：docs/bug-fixes/（遵循文档规范）✅

