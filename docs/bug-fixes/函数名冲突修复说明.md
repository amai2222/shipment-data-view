# 函数名冲突修复说明

## 🐛 问题描述

在应用开票申请高级筛选迁移文件时，出现函数名冲突错误：

```
ERROR: 42725: function name "public.get_invoice_request_data" is not unique
HINT: Specify the argument list to select the function unambiguously.
```

## 🔍 问题分析

### 根本原因
数据库中已经存在同名的`get_invoice_request_data`函数，但参数签名不同：
- **旧函数**: 7个参数 (uuid, date, date, uuid, text[], integer, integer)
- **新函数**: 12个参数 (增加了5个高级筛选参数)

PostgreSQL无法确定要替换哪个函数，因为函数重载需要明确的参数类型。

### 具体问题
1. **函数重载冲突**: 同名函数但参数不同
2. **参数签名不明确**: CREATE OR REPLACE无法确定目标函数
3. **迁移失败**: 无法创建新函数

## ✅ 修复方案

### 1. 明确删除旧函数

**修复前**:
```sql
CREATE OR REPLACE FUNCTION public.get_invoice_request_data(
    -- 参数列表
)
```

**修复后**:
```sql
-- 先删除旧函数（如果存在）
DROP FUNCTION IF EXISTS public.get_invoice_request_data(uuid, date, date, uuid, text[], integer, integer);

-- 创建新的get_invoice_request_data函数，添加高级筛选参数
CREATE OR REPLACE FUNCTION public.get_invoice_request_data(
    -- 参数列表
)
```

### 2. 参数签名对比

**旧函数参数**:
```sql
get_invoice_request_data(
    p_project_id uuid,
    p_start_date date,
    p_end_date date,
    p_partner_id uuid,
    p_invoice_status_array text[],
    p_page_size integer,
    p_page_number integer
)
```

**新函数参数**:
```sql
get_invoice_request_data(
    p_project_id uuid,
    p_start_date date,
    p_end_date date,
    p_partner_id uuid,
    p_invoice_status_array text[],
    p_page_size integer,
    p_page_number integer,
    -- 新增高级筛选参数
    p_waybill_numbers text,
    p_driver_name text,
    p_license_plate text,
    p_driver_phone text,
    p_driver_receivable text
)
```

## 🔧 技术细节

### 函数重载规则

PostgreSQL支持函数重载，但需要明确的参数类型来区分：

1. **参数数量不同**: 7个参数 vs 12个参数
2. **参数类型不同**: 新增5个text类型参数
3. **函数名相同**: 但参数签名不同

### 删除策略

**精确删除**:
```sql
DROP FUNCTION IF EXISTS public.get_invoice_request_data(uuid, date, date, uuid, text[], integer, integer);
```

**参数类型顺序**:
1. `uuid` - p_project_id
2. `date` - p_start_date  
3. `date` - p_end_date
4. `uuid` - p_partner_id
5. `text[]` - p_invoice_status_array
6. `integer` - p_page_size
7. `integer` - p_page_number

## 📋 修复清单

### 迁移文件修改
- [x] 添加DROP FUNCTION语句
- [x] 指定精确的参数类型
- [x] 使用IF EXISTS避免错误
- [x] 保持向后兼容性

### 函数创建
- [x] 创建新函数（12个参数）
- [x] 保持原有功能
- [x] 添加高级筛选功能
- [x] 更新函数注释

## 🎯 修复效果

### 修复前
- ❌ 函数名冲突错误
- ❌ 无法创建新函数
- ❌ 迁移失败
- ❌ 高级筛选功能不可用

### 修复后
- ✅ 成功删除旧函数
- ✅ 成功创建新函数
- ✅ 迁移成功
- ✅ 高级筛选功能正常
- ✅ 向后兼容

## 🚀 部署说明

### 迁移执行顺序
1. **删除旧函数**: 使用精确的参数类型
2. **创建新函数**: 包含所有参数
3. **验证功能**: 确保新函数正常工作

### 风险控制
- **IF EXISTS**: 避免删除不存在的函数时报错
- **参数精确**: 只删除特定签名的函数
- **功能保持**: 新函数包含所有原有功能

## 📝 注意事项

1. **参数顺序**: DROP FUNCTION必须按照正确的参数类型顺序
2. **向后兼容**: 新函数包含所有原有参数
3. **功能验证**: 确保新函数功能正常
4. **性能测试**: 测试新函数的性能

## 🔍 测试建议

1. **基本功能**: 测试原有筛选功能
2. **高级功能**: 测试新增的高级筛选功能
3. **参数兼容**: 测试只传原有参数的情况
4. **性能对比**: 对比新旧函数的性能
5. **错误处理**: 测试各种错误情况

---

**修复时间**: 2025-01-16  
**修复状态**: ✅ 已完成  
**测试状态**: ⏳ 待测试  
**部署状态**: ⏳ 待部署
