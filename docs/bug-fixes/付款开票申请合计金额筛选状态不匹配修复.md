# 付款和开票申请合计金额筛选状态不匹配修复

## 🐛 问题描述

在合作方付款申请和开票申请页面，当筛选特定状态时，底部合计行显示为¥0.00。

**问题表现**：
- 筛选"已申请支付"状态 → 底部各合作方合计都显示 ¥0.00
- 筛选"开票中"状态 → 底部各合作方合计都显示 ¥0.00
- 筛选"未支付"或"未开票"状态 → 合计正常显示

**用户截图显示**：
```
司机应收: ¥33,423.08 ✅
山西成本: ¥0.00      ❌
张海亮:   ¥0.00      ❌  
数创:     ¥0.00      ❌
盛丰物流: ¥0.00      ❌
```

---

## 🔍 问题原因

### 后端RPC函数的设计缺陷

#### 1. 付款申请合计计算

**问题代码**（get_payment_request_data函数）：
```sql
SELECT 
    lpc.partner_id, 
    SUM(lpc.payable_amount) AS total_payable
FROM logistics_partner_costs lpc
WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
  AND lpc.payment_status = 'Unpaid'  -- ❌ 问题：硬编码只统计未支付！
GROUP BY lpc.partner_id
```

**后果**：
```
用户筛选"已申请支付" → 运单是Processing状态
  ↓
但合计计算只统计payment_status='Unpaid'的记录
  ↓
Processing状态的不计入合计
  ↓
合计显示 ¥0.00 ❌
```

---

#### 2. 开票申请合计计算

**问题代码**（get_invoice_request_data函数）：
```sql
WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
  AND lpc.invoice_status = 'Uninvoiced'  -- ❌ 问题：硬编码只统计未开票！
```

**后果**：
```
用户筛选"开票中" → 运单是Processing状态
  ↓
但合计计算只统计invoice_status='Uninvoiced'的记录
  ↓
Processing状态的不计入合计
  ↓
合计显示 ¥0.00 ❌
```

---

## ✅ 解决方案

### 核心思路

**合计计算应该跟随用户的筛选条件**：
- 用户筛选什么状态 → 合计就统计什么状态
- 没有筛选 → 合计统计所有状态

---

### 修复后的逻辑

#### 付款申请合计

```sql
WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
  -- ✅ 修复：根据筛选条件决定统计哪些状态
  AND (
    p_payment_status_array IS NULL  -- 没有筛选，统计所有
    OR (
      CASE 
        WHEN 'Unpaid' = ANY(p_payment_status_array) 
          THEN lpc.payment_status = 'Unpaid'
        WHEN 'Processing' = ANY(p_payment_status_array) 
          THEN lpc.payment_status = 'Processing'
        WHEN 'Paid' = ANY(p_payment_status_array) 
          THEN lpc.payment_status = 'Paid'
        ELSE lpc.payment_status = 'Unpaid'
      END
    )
  )
```

#### 开票申请合计

```sql
WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
  -- ✅ 修复：根据筛选条件决定统计哪些状态
  AND (
    p_invoice_status_array IS NULL  -- 没有筛选，统计所有
    OR (
      CASE 
        WHEN 'Uninvoiced' = ANY(p_invoice_status_array) 
          THEN lpc.invoice_status = 'Uninvoiced'
        WHEN 'Processing' = ANY(p_invoice_status_array) 
          THEN lpc.invoice_status = 'Processing'
        WHEN 'Invoiced' = ANY(p_invoice_status_array) 
          THEN lpc.invoice_status = 'Invoiced'
        ELSE lpc.invoice_status = 'Uninvoiced'
      END
    )
  )
```

---

## 📊 修复前后对比

### 筛选"已申请支付"状态

**修复前**：
```
运单列表：显示Processing状态的运单 ✅
底部合计：只统计Unpaid状态 → ¥0.00 ❌
```

**修复后**：
```
运单列表：显示Processing状态的运单 ✅
底部合计：统计Processing状态 → ¥33,423.08 ✅
```

---

### 筛选"开票中"状态

**修复前**：
```
运单列表：显示Processing状态的运单 ✅
底部合计：只统计Uninvoiced状态 → ¥0.00 ❌
```

**修复后**：
```
运单列表：显示Processing状态的运单 ✅
底部合计：统计Processing状态 → ¥28,756.42 ✅
```

---

## 🔧 技术实现

### 数据库迁移文件

**文件位置**：
```
supabase/migrations/20250131_fix_payment_invoice_summary_by_status.sql
```

**修改的函数**：
1. `get_payment_request_data` - 付款申请数据获取
2. `get_invoice_request_data` - 开票申请数据获取

---

### 关键代码

```sql
-- 动态匹配筛选状态
CASE 
  WHEN 'Processing' = ANY(p_payment_status_array) 
    THEN lpc.payment_status = 'Processing'
  WHEN 'Paid' = ANY(p_payment_status_array) 
    THEN lpc.payment_status = 'Paid'
  ELSE lpc.payment_status = 'Unpaid'
END
```

**逻辑**：
- 如果用户筛选了"Processing"，就统计Processing状态的
- 如果用户筛选了"Paid"，就统计Paid状态的
- 没有筛选，默认统计Unpaid状态的

---

## 📋 影响范围

### 受影响的页面

| 页面 | 影响 | 修复后 |
|------|------|--------|
| 合作方付款申请 | 底部合计 | ✅ 跟随筛选 |
| 合作方开票申请 | 底部合计 | ✅ 跟随筛选 |

### 受影响的筛选状态

**付款申请**：
- 筛选"未支付" → 合计统计未支付的
- 筛选"已申请支付" → 合计统计已申请支付的 ⭐
- 筛选"已完成支付" → 合计统计已完成支付的 ⭐

**开票申请**：
- 筛选"未开票" → 合计统计未开票的
- 筛选"开票中" → 合计统计开票中的 ⭐
- 筛选"已开票" → 合计统计已开票的 ⭐

---

## 🧪 测试步骤

### 测试付款申请

1. 打开"合作方付款申请"页面
2. 筛选条件选择"已申请支付"
3. 点击"搜索"
4. ✅ 验证底部合计行各合作方金额正确显示（不是¥0.00）

5. 切换筛选"已完成支付"
6. 点击"搜索"
7. ✅ 验证底部合计行正确显示

---

### 测试开票申请

1. 打开"合作方开票申请"页面
2. 筛选条件选择"开票中"
3. 点击"搜索"
4. ✅ 验证底部合计行各合作方金额正确显示

---

## 🚀 部署步骤

1. **运行数据库迁移**
```bash
# 自动执行迁移文件
supabase db push
```

2. **验证修复**
- 打开付款申请页面
- 筛选"已申请支付"
- 确认合计不为0

3. **无需前端修改**
- 前端代码无需改动
- 后端修复后自动生效

---

## 📝 修复总结

**修复文件**：
- `supabase/migrations/20250131_fix_payment_invoice_summary_by_status.sql`

**修复内容**：
- ✅ 修改 `get_payment_request_data` 函数的合计计算逻辑
- ✅ 修改 `get_invoice_request_data` 函数的合计计算逻辑
- ✅ 合计计算跟随用户筛选条件

**影响**：
- ✅ 修复所有状态筛选下的合计显示问题
- ✅ 不影响其他功能
- ✅ 向后兼容

---

**修复完成时间**：2025-01-31  
**问题严重性**：中等（影响数据展示，用户体验差）  
**修复难度**：中等（需要修改数据库函数）  
**文件归档位置**：
- SQL: supabase/migrations/
- 文档: docs/bug-fixes/（遵循文档规范）✅

