# 司机列表加载失败修复指南

## 问题症状
- 司机列表页面显示"加载失败"和"无法加载司机数据"
- 页面显示"暂无司机数据"
- 浏览器控制台可能有数据库连接或权限错误

## ⚠️ 重要修复说明
**SQL脚本已修复！** 之前的脚本中照片字段数据类型错误（使用了`text[]`而不是`jsonb`），现在已经修正。

## 快速修复步骤

### 方法1：使用 Supabase Dashboard（推荐）

1. **打开 Supabase Dashboard**
   - 访问 https://supabase.com/dashboard
   - 选择您的项目：`mnwzvtvyauyxwowjjsmf`

2. **进入 SQL Editor**
   - 点击左侧菜单的 "SQL Editor"
   - 点击 "New query"

3. **运行修复脚本**
   - 复制 `fix-driver-loading-issue.sql` 文件的全部内容
   - 粘贴到 SQL Editor 中
   - 点击 "Run" 按钮执行

4. **验证修复结果**
   - 运行以下测试查询：
   ```sql
   -- 测试RPC函数
   SELECT * FROM public.get_drivers_paginated(1, 5, '');
   
   -- 测试直接查询
   SELECT COUNT(*) FROM public.drivers;
   ```

### 方法2：使用 Supabase CLI

```bash
# 1. 安装 Supabase CLI（如果还没有安装）
npm install -g supabase

# 2. 登录 Supabase
supabase login

# 3. 链接到您的项目
supabase link --project-ref mnwzvtvyauyxwowjjsmf

# 4. 运行修复脚本
supabase db reset --linked

# 5. 或者直接运行 SQL 脚本
psql "postgresql://postgres:[password]@db.mnwzvtvyauyxwowjjsmf.supabase.co:5432/postgres" -f fix-driver-loading-issue.sql
```

### 方法3：手动检查表结构

1. **检查表是否存在**
   ```sql
   SELECT table_name 
   FROM information_schema.tables 
   WHERE table_schema = 'public' 
   AND table_name IN ('drivers', 'driver_projects');
   ```

2. **检查RLS策略**
   ```sql
   SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
   FROM pg_policies 
   WHERE tablename IN ('drivers', 'driver_projects');
   ```

3. **测试简单查询**
   ```sql
   SELECT COUNT(*) FROM public.drivers;
   SELECT COUNT(*) FROM public.driver_projects;
   ```

## 常见问题解决

### 问题1：权限不足
**症状**：查询被拒绝，提示权限不足
**解决**：
```sql
-- 确保用户有正确的权限
GRANT USAGE ON SCHEMA public TO authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO authenticated;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO authenticated;
```

### 问题2：RLS 策略问题
**症状**：表存在但查询返回空结果
**解决**：
```sql
-- 临时禁用 RLS 进行测试
ALTER TABLE public.drivers DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.driver_projects DISABLE ROW LEVEL SECURITY;

-- 测试查询
SELECT COUNT(*) FROM public.drivers;

-- 重新启用 RLS
ALTER TABLE public.drivers ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.driver_projects ENABLE ROW LEVEL SECURITY;
```

### 问题3：RPC函数不存在
**症状**：函数调用失败，提示函数不存在
**解决**：
```sql
-- 检查函数是否存在
SELECT routine_name, routine_type 
FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_name = 'get_drivers_paginated';

-- 如果不存在，运行修复脚本重新创建
```

### 问题4：表结构不完整
**症状**：查询失败，提示列不存在
**解决**：
```sql
-- 检查表结构
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'drivers' AND table_schema = 'public';

-- 添加缺失的列
ALTER TABLE public.drivers ADD COLUMN IF NOT EXISTS id_card_photos text[] DEFAULT '{}';
ALTER TABLE public.drivers ADD COLUMN IF NOT EXISTS driver_license_photos text[] DEFAULT '{}';
ALTER TABLE public.drivers ADD COLUMN IF NOT EXISTS qualification_certificate_photos text[] DEFAULT '{}';
ALTER TABLE public.drivers ADD COLUMN IF NOT EXISTS driving_license_photos text[] DEFAULT '{}';
ALTER TABLE public.drivers ADD COLUMN IF NOT EXISTS transport_license_photos text[] DEFAULT '{}';
```

## 验证修复

修复完成后，请执行以下步骤验证：

1. **刷新浏览器页面**
2. **检查司机列表是否正常显示**
3. **测试搜索功能**
4. **测试分页功能**
5. **检查浏览器控制台是否有错误**

## 联系支持

如果问题持续存在，请提供：
1. 浏览器控制台的错误信息
2. Supabase Dashboard中的表结构截图
3. 您使用的数据库设置方法
4. 修复脚本的执行结果
