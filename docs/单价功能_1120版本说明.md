# å•ä»·åŠŸèƒ½ _1120 ç‰ˆæœ¬è¯´æ˜

## ğŸ“‹ ç‰ˆæœ¬ç­–ç•¥

æ‰€æœ‰æ–°åˆ›å»ºçš„å‡½æ•°éƒ½ä½¿ç”¨ `_1120` åç¼€ï¼Œè¡¨ç¤º 2025-11-20 ç‰ˆæœ¬ã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ç‰ˆæœ¬åç¼€ï¼Ÿ

1. âœ… **é¿å…å†²çª**ï¼šä¸è¦†ç›–ç°æœ‰å‡½æ•°ï¼Œæ–°æ—§ç‰ˆæœ¬å¹¶å­˜
2. âœ… **ä¾¿äºå›æ»š**ï¼šå¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿåˆ‡æ¢å›æ—§ç‰ˆæœ¬
3. âœ… **æ¸…æ™°ç‰ˆæœ¬**ï¼šé€šè¿‡å‡½æ•°åå°±èƒ½çŸ¥é“æ˜¯å“ªä¸ªç‰ˆæœ¬
4. âœ… **ç°åº¦å‘å¸ƒ**ï¼šå¯ä»¥å…ˆåœ¨éƒ¨åˆ†é¡µé¢ä½¿ç”¨æ–°ç‰ˆæœ¬æµ‹è¯•

---

## ğŸ“¦ åˆ›å»ºçš„å‡½æ•°æ¸…å•

### 1. get_effective_quantity_for_record_1120

**åŠŸèƒ½**ï¼šæ ¹æ®é¡¹ç›®é…ç½®è®¡ç®—æœ‰æ•ˆæ•°é‡

**å‚æ•°**ï¼š
```sql
p_loading_weight NUMERIC,    -- è£…è´§é‡é‡
p_unloading_weight NUMERIC,  -- å¸è´§é‡é‡
p_project_id UUID            -- é¡¹ç›®ID
```

**è¿”å›**ï¼š`NUMERIC` - æœ‰æ•ˆæ•°é‡

**é€»è¾‘**ï¼š
```sql
1. æŸ¥è¯¢é¡¹ç›®çš„ effective_quantity_type é…ç½®
2. æ ¹æ®é…ç½®è®¡ç®—ï¼š
   - 'loading' â†’ è¿”å›è£…è´§é‡é‡
   - 'unloading' â†’ è¿”å›å¸è´§é‡é‡
   - 'min_value' â†’ è¿”å›è¾ƒå°å€¼ï¼ˆé»˜è®¤ï¼‰
```

### 2. auto_calculate_cost_from_unit_price_1120

**åŠŸèƒ½**ï¼šè‡ªåŠ¨è®¡ç®—è¿è´¹çš„è§¦å‘å™¨å‡½æ•°

**è§¦å‘æ—¶æœº**ï¼š
- `BEFORE INSERT OR UPDATE OF unit_price, loading_weight, unloading_weight, extra_cost`

**é€»è¾‘**ï¼š
```sql
1. åˆ¤æ–­è®¡ç®—æ¨¡å¼
   æœ‰å•ä»·ä¸” > 0 â†’ calculation_mode = 'auto'
   å¦åˆ™ â†’ calculation_mode = 'manual'

2. auto æ¨¡å¼ï¼š
   - è°ƒç”¨ get_effective_quantity_for_record_1120 è®¡ç®—æœ‰æ•ˆæ•°é‡
   - current_cost = unit_price Ã— effective_quantity
   - payable_cost = current_cost + extra_cost

3. manual æ¨¡å¼ï¼š
   - è®¡ç®—æœ‰æ•ˆæ•°é‡ï¼ˆä»…è®°å½•ï¼‰
   - payable_cost = current_cost + extra_cost
```

### 3. add_logistics_record_with_costs_1120

**åŠŸèƒ½**ï¼šåˆ›å»ºæ–°è¿å•ï¼ˆæ”¯æŒå•ä»·ï¼‰

**æ–°å¢å‚æ•°**ï¼š
```sql
p_unit_price NUMERIC  -- å•ä»·ï¼ˆå…ƒ/å¨ï¼‰
```

**å®Œæ•´å‚æ•°åˆ—è¡¨**ï¼ˆ18ä¸ªå‚æ•°ï¼‰ï¼š
```sql
p_project_id uuid,
p_project_name text,
p_chain_id uuid,
p_driver_id uuid,
p_driver_name text,
p_loading_location text,
p_unloading_location text,
p_loading_date text,
p_unloading_date text,
p_loading_weight numeric,
p_unloading_weight numeric,
p_unit_price numeric,      -- æ–°å¢ï¼šå•ä»·
p_current_cost numeric,
p_extra_cost numeric,
p_license_plate text,
p_driver_phone text,
p_transport_type text,
p_remarks text
```

**è¿”å›**ï¼š`UUID` - æ–°åˆ›å»ºçš„è¿å•ID

### 4. update_logistics_record_via_recalc_1120

**åŠŸèƒ½**ï¼šæ›´æ–°è¿å•ï¼ˆæ”¯æŒå•ä»·ï¼‰

**æ–°å¢å‚æ•°**ï¼š
```sql
p_unit_price NUMERIC  -- å•ä»·ï¼ˆå…ƒ/å¨ï¼‰
```

**å®Œæ•´å‚æ•°åˆ—è¡¨**ï¼ˆ19ä¸ªå‚æ•°ï¼‰ï¼š
```sql
p_record_id uuid,
p_project_id uuid,
p_project_name text,
p_chain_id uuid,
p_driver_id uuid,
p_driver_name text,
p_loading_location text,
p_unloading_location text,
p_loading_date text,
p_unloading_date text,
p_loading_weight numeric,
p_unloading_weight numeric,
p_unit_price numeric,      -- æ–°å¢ï¼šå•ä»·
p_current_cost numeric,
p_extra_cost numeric,
p_license_plate text,
p_driver_phone text,
p_transport_type text,
p_remarks text
```

**è¿”å›**ï¼š`VOID`

---

## ğŸ”„ å‰ç«¯è°ƒç”¨

### åˆ›å»ºè¿å•

```typescript
const { data: newRecordId, error } = await supabase.rpc('add_logistics_record_with_costs_1120', {
  p_project_id: formData.projectId,
  p_project_name: projectName,
  p_chain_id: formData.chainId,
  p_driver_id: formData.driverId,
  p_driver_name: driverName,
  p_loading_location: loadingLocationNames,
  p_unloading_location: unloadingLocationNames,
  p_loading_date: formatChinaDateString(formData.loadingDate),
  p_unloading_date: formatChinaDateString(formData.unloadingDate),
  p_loading_weight: parseFloat(formData.loading_weight) || 0,
  p_unloading_weight: parseFloat(formData.unloading_weight) || 0,
  p_unit_price: formData.unitPrice ? parseFloat(formData.unitPrice) : null, // å•ä»·
  p_current_cost: parseFloat(formData.currentCost) || 0,
  p_extra_cost: parseFloat(formData.extraCost) || 0,
  p_license_plate: formData.licensePlate,
  p_driver_phone: formData.driverPhone,
  p_transport_type: formData.transportType,
  p_remarks: formData.remarks
});
```

### æ›´æ–°è¿å•

```typescript
const { error } = await supabase.rpc('update_logistics_record_via_recalc_1120', {
  p_record_id: editingRecord.id,
  p_project_id: projectId,
  p_project_name: projectName,
  // ... å…¶ä»–å‚æ•°
  p_unit_price: formData.unitPrice ? parseFloat(formData.unitPrice) : null, // å•ä»·
  p_current_cost: parseFloat(formData.currentCost) || 0,
  // ...
});
```

---

## ğŸ” ä¸æ—§ç‰ˆæœ¬çš„åŒºåˆ«

### å‡½æ•°å‘½å

| åŠŸèƒ½ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ï¼ˆ_1120ï¼‰ |
|------|--------|----------------|
| åˆ›å»ºè¿å• | `add_logistics_record_with_costs` | `add_logistics_record_with_costs_1120` |
| æ›´æ–°è¿å• | `update_logistics_record_via_recalc` | `update_logistics_record_via_recalc_1120` |
| è®¡ç®—æœ‰æ•ˆæ•°é‡ | - | `get_effective_quantity_for_record_1120` |
| è‡ªåŠ¨è®¡ç®—è§¦å‘å™¨ | - | `auto_calculate_cost_from_unit_price_1120` |

### å‚æ•°å˜åŒ–

| å‡½æ•° | æ—§ç‰ˆæœ¬å‚æ•°æ•°é‡ | æ–°ç‰ˆæœ¬å‚æ•°æ•°é‡ | æ–°å¢å‚æ•° |
|------|--------------|--------------|---------|
| `add_logistics_record_with_costs` | 17 | 18 | `p_unit_price` |
| `update_logistics_record_via_recalc` | 18 | 19 | `p_unit_price` |

### è¡Œä¸ºå˜åŒ–

| åŠŸèƒ½ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ï¼ˆ_1120ï¼‰ |
|------|--------|----------------|
| è¿è´¹è®¡ç®— | ç›´æ¥ä½¿ç”¨è¾“å…¥å€¼ | æ ¹æ®å•ä»·è‡ªåŠ¨è®¡ç®—ï¼ˆauto æ¨¡å¼ï¼‰ |
| æœ‰æ•ˆæ•°é‡ | ä¸å­˜å‚¨ | å­˜å‚¨å¹¶æ ¹æ®é¡¹ç›®é…ç½®è®¡ç®— |
| è®¡ç®—æ¨¡å¼ | ä¸åŒºåˆ† | åŒºåˆ† manual/auto æ¨¡å¼ |

---

## ğŸ›¡ï¸ å‘åå…¼å®¹ä¿è¯

### æ—§å‡½æ•°ä¿æŒä¸å˜

```sql
-- æ—§ç‰ˆæœ¬å‡½æ•°ä»ç„¶å¯ç”¨
add_logistics_record_with_costs         âœ… æœªä¿®æ”¹
update_logistics_record_via_recalc      âœ… æœªä¿®æ”¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
```

### æ–°æ—§ç‰ˆæœ¬å¹¶å­˜

```sql
-- æ•°æ®åº“ä¸­åŒæ—¶å­˜åœ¨ä¸¤ä¸ªç‰ˆæœ¬
add_logistics_record_with_costs         -- æ—§ç‰ˆæœ¬ï¼ˆ17å‚æ•°ï¼‰
add_logistics_record_with_costs_1120    -- æ–°ç‰ˆæœ¬ï¼ˆ18å‚æ•°ï¼‰

update_logistics_record_via_recalc      -- æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
update_logistics_record_via_recalc_1120 -- æ–°ç‰ˆæœ¬ï¼ˆ19å‚æ•°ï¼‰
```

### å¿«é€Ÿå›æ»š

å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```typescript
// å‰ç«¯åªéœ€ä¿®æ”¹å‡½æ•°åå³å¯
// ä»ï¼š
await supabase.rpc('add_logistics_record_with_costs_1120', {...})

// æ”¹å›ï¼š
await supabase.rpc('add_logistics_record_with_costs', {...})
```

---

## ğŸ“Š æ•°æ®å…¼å®¹æ€§

### æ–°æ—§æ•°æ®å…±å­˜

| æ•°æ® | calculation_mode | unit_price | current_cost | è¯´æ˜ |
|------|-----------------|------------|--------------|------|
| æ—§æ•°æ® | 'manual' | NULL | åŸå€¼ | âœ… ä¸å—å½±å“ |
| æ–°æ•°æ®ï¼ˆmanualï¼‰ | 'manual' | NULL | ç”¨æˆ·è¾“å…¥ | âœ… ä¼ ç»Ÿæ–¹å¼ |
| æ–°æ•°æ®ï¼ˆautoï¼‰ | 'auto' | 350 | è‡ªåŠ¨è®¡ç®— | âœ… æ–°åŠŸèƒ½ |

---

## âš ï¸ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### 1. æ‰§è¡Œé¡ºåº

åªéœ€æ‰§è¡Œ 1 ä¸ªè¿ç§»æ–‡ä»¶ï¼š
```sql
supabase/migrations/20251120_create_unit_price_functions.sql
```

è¿™ä¸ªæ–‡ä»¶åŒ…å«ï¼š
- âœ… æ·»åŠ å­—æ®µ
- âœ… åˆ›å»ºæ‰€æœ‰ _1120 ç‰ˆæœ¬çš„å‡½æ•°
- âœ… åˆ›å»ºè§¦å‘å™¨
- âœ… è¿ç§»æ—§æ•°æ®

### 2. å‰ç«¯æ›´æ–°

å‰ç«¯å·²ä¿®æ”¹ä¸ºè°ƒç”¨ _1120 ç‰ˆæœ¬å‡½æ•°ï¼š
- âœ… `add_logistics_record_with_costs_1120`
- âœ… `update_logistics_record_via_recalc_1120`

### 3. æµ‹è¯•éªŒè¯

```sql
-- éªŒè¯æ–°å‡½æ•°å·²åˆ›å»º
SELECT proname, pronargs 
FROM pg_proc 
WHERE proname LIKE '%_1120'
ORDER BY proname;

-- é¢„æœŸç»“æœï¼šåº”è¯¥çœ‹åˆ° 4 ä¸ªå‡½æ•°
-- add_logistics_record_with_costs_1120
-- auto_calculate_cost_from_unit_price_1120
-- get_effective_quantity_for_record_1120
-- update_logistics_record_via_recalc_1120
```

---

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

### ç‰ˆæœ¬ç®¡ç†ä¼˜åŠ¿

1. âœ… **å®‰å…¨æ€§é«˜**ï¼šä¸å½±å“ç°æœ‰åŠŸèƒ½
2. âœ… **å¯å›æ»š**ï¼šå‡ºé—®é¢˜å¯ä»¥ç«‹å³å›æ»š
3. âœ… **ä¾¿äºæµ‹è¯•**ï¼šå¯ä»¥å¯¹æ¯”æ–°æ—§ç‰ˆæœ¬
4. âœ… **æ¸…æ™°å¯è¿½æº¯**ï¼šé€šè¿‡åç¼€çŸ¥é“ç‰ˆæœ¬æ—¥æœŸ

### æŠ€æœ¯ä¼˜åŠ¿

1. âœ… **æ™ºèƒ½è®¡ç®—**ï¼šè‡ªåŠ¨åˆ¤æ–­æ¨¡å¼ï¼Œè‡ªåŠ¨è®¡ç®—è¿è´¹
2. âœ… **é¡¹ç›®é©±åŠ¨**ï¼šæ ¹æ®é¡¹ç›®é…ç½®è®¡ç®—æœ‰æ•ˆæ•°é‡
3. âœ… **è§¦å‘å™¨è‡ªåŠ¨åŒ–**ï¼šæ•°æ®åº“å±‚é¢ä¿è¯è®¡ç®—æ­£ç¡®æ€§
4. âœ… **å‰åç«¯ä¸€è‡´**ï¼šå‰ç«¯é¢„è§ˆï¼Œåç«¯ç¡®è®¤

---

**ç‰ˆæœ¬å·**ï¼š_1120  
**å‘å¸ƒæ—¥æœŸ**ï¼š2025-11-20  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

