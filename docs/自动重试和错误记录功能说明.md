# 自动重试和错误记录功能说明

## 🎯 功能概述

系统已实现完整的自动重试机制和错误记录功能，确保：

1. ✅ **自动重试**：资源加载失败时自动重试（最多3次）
2. ✅ **错误记录**：所有错误自动记录到数据库
3. ✅ **监控机制**：全局监控资源加载错误

## 📦 核心组件

### 1. `resourceLoader.ts` - 资源加载工具

**功能：**
- 带重试的动态导入（`importWithRetry`）
- 带重试的 fetch（`fetchWithRetry`）
- 资源加载监控（`setupResourceLoadMonitor`）
- **自动记录错误到数据库**

**关键特性：**
- ✅ 检测 HTML 响应（服务器返回错误页面）
- ✅ 检测资源加载错误类型
- ✅ 自动清理缓存
- ✅ 每次重试都记录错误到数据库

### 2. `safeLazy.ts` - 安全的懒加载

**功能：**
- 包装 `React.lazy`，自动处理资源加载失败
- 使用 `resourceLoader` 的重试机制
- **自动记录错误到数据库**

### 3. `LazyLoadErrorBoundary.tsx` - 错误边界

**功能：**
- React 错误边界，捕获组件加载错误
- 自动重试机制（最多3次）
- **自动记录错误到数据库**

**配置：**
```typescript
const ENABLE_AUTO_RETRY = true; // 启用自动重试
```

### 4. `GlobalErrorHandler.tsx` - 全局错误处理

**功能：**
- 捕获全局 JavaScript 错误
- 捕获未处理的 Promise 拒绝
- 拦截网络请求错误
- **自动记录错误到数据库**

### 5. `errorLogger.ts` - 错误记录工具

**功能：**
- 提供统一的错误记录接口
- 支持多种错误类型：
  - `javascript` - JavaScript 错误
  - `network` - 网络错误
  - `react` - React 组件错误
  - `chunk_load` - 资源加载错误
  - `unhandled_rejection` - Promise 拒绝

## 🔄 自动重试流程

### 资源加载失败时：

1. **检测错误类型**
   - 判断是否为资源加载错误（ChunkLoadError、Failed to fetch 等）

2. **记录错误到数据库**
   - 使用 `logErrorToDatabase` 记录错误信息
   - 包含错误详情、重试次数、资源 URL 等

3. **自动重试**
   - 等待 1 秒后重试
   - 最多重试 3 次
   - 每次重试都记录到数据库

4. **清理缓存**
   - 自动清理 Service Worker 缓存
   - 清理浏览器缓存

5. **最终失败处理**
   - 如果 3 次重试都失败，抛出错误
   - 显示错误页面，允许用户手动刷新

## 📝 错误记录详情

### 记录的信息包括：

- ✅ 错误类型（errorType）
- ✅ 错误名称（errorName）
- ✅ 错误消息（errorMessage）
- ✅ 错误堆栈（errorStack）
- ✅ 资源 URL（resourceUrl）
- ✅ 重试次数（retryCount）
- ✅ 用户代理（userAgent）
- ✅ 当前页面 URL
- ✅ 视口尺寸
- ✅ 时间戳
- ✅ 其他元数据

### 数据库表结构：

错误记录到 `frontend_error_logs` 表，包含以下字段：
- `error_type` - 错误类型
- `error_name` - 错误名称
- `error_message` - 错误消息
- `error_stack` - 错误堆栈
- `url` - 发生错误的页面 URL
- `user_agent` - 用户代理
- `retry_count` - 重试次数
- `metadata` - 其他元数据（JSONB）
- `created_at` - 创建时间

## 🚀 使用方法

### 1. 使用安全的懒加载

```typescript
import { safeLazy } from '@/utils/safeLazy';

// 自动处理重试和错误记录
export const MyComponent = safeLazy(() => import('./MyComponent'));
```

### 2. 手动使用重试机制

```typescript
import { importWithRetry } from '@/utils/resourceLoader';

const module = await importWithRetry(
  () => import('./MyModule'),
  {
    maxRetries: 3,
    retryDelay: 1000,
    onRetry: (attempt) => {
      console.log(`重试 ${attempt}/3`);
    }
  }
);
```

### 3. 全局监控（已自动启动）

在 `main.tsx` 中已自动启动资源加载监控：

```typescript
import { setupResourceLoadMonitor } from './utils/resourceLoader';
setupResourceLoadMonitor();
```

## ⚙️ 配置选项

### 启用/禁用自动重试

**文件：** `src/components/LazyLoadErrorBoundary.tsx`

```typescript
const ENABLE_AUTO_RETRY = true; // 启用自动重试
// 或
const ENABLE_AUTO_RETRY = false; // 禁用自动重试（用于调试）
```

### 调整重试参数

**文件：** `src/utils/resourceLoader.ts`

```typescript
export async function importWithRetry<T = any>(
  importFn: () => Promise<T>,
  options: RetryOptions = {}
): Promise<T> {
  const {
    maxRetries = 3,      // 最大重试次数
    retryDelay = 1000,   // 重试延迟（毫秒）
    onRetry              // 重试回调
  } = options;
  // ...
}
```

## 📊 错误监控

### 查看错误记录

1. **数据库查询：**
   ```sql
   SELECT * FROM frontend_error_logs 
   ORDER BY created_at DESC 
   LIMIT 100;
   ```

2. **按错误类型统计：**
   ```sql
   SELECT error_type, COUNT(*) 
   FROM frontend_error_logs 
   GROUP BY error_type;
   ```

3. **查看资源加载错误：**
   ```sql
   SELECT * FROM frontend_error_logs 
   WHERE error_type = 'chunk_load'
   ORDER BY created_at DESC;
   ```

## ✅ 功能验证

### 测试自动重试：

1. 临时修改资源 URL，使其加载失败
2. 观察控制台日志，应该看到：
   - ⚠️ 资源加载失败，重试提示
   - ✅ 错误日志已记录到数据库
   - 🔄 自动重试（最多3次）

### 测试错误记录：

1. 触发资源加载错误
2. 检查数据库 `frontend_error_logs` 表
3. 确认错误信息已正确记录

## 🎉 总结

系统现在具备：

- ✅ **完整的自动重试机制**（最多3次）
- ✅ **自动错误记录到数据库**（所有错误类型）
- ✅ **全局资源加载监控**
- ✅ **缓存自动清理**
- ✅ **详细的错误信息记录**

**所有错误都会自动记录到数据库，方便后续分析和排查问题！**

