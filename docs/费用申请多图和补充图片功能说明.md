# 费用申请多图和补充图片功能说明

**功能：** 费用申请支持多图上传和补充图片  
**创建时间：** 2025-11-09  
**状态：** ✅ 已完成

---

## 🎯 功能概述

### 1. 多图上传支持
- ✅ 新建费用申请时，支持一次选择/拍摄多张图片
- ✅ 相册选择支持多图（`multiple` 属性）
- ✅ 拍照功能支持多图（`multiple` 属性）

### 2. 补充图片功能
- ✅ 在申请详情中，可以补充上传图片
- ✅ 支持拍照和相册两种方式
- ✅ 图片会追加到现有的凭证照片中
- ✅ 实时更新申请详情显示

---

## 📋 功能详情

### 新建申请 - 多图上传

**位置：** 新建费用申请对话框

**功能：**
1. **拍照上传**
   - 点击"拍照"按钮
   - 可以一次拍摄多张照片
   - 拍完后点击"使用照片"，照片添加到待上传列表

2. **相册选择**
   - 点击"相册"按钮
   - 可以一次选择多张图片
   - 选中的图片添加到待上传列表

3. **图片预览**
   - 所有选中的图片以网格形式预览
   - 可以删除不需要的图片
   - 提交时一次性上传所有图片

**技术实现：**
```typescript
// input 元素已设置 multiple 属性
<input
  id="photo-file-input"
  type="file"
  accept="image/*"
  multiple  // ✅ 支持多图
  onChange={handleFileSelect}
/>

<input
  id="camera-file-input"
  type="file"
  accept="image/*"
  capture="environment"
  multiple  // ✅ 支持多图
  onChange={handleCameraFileSelect}
/>
```

---

### 申请详情 - 补充图片

**位置：** 申请详情对话框底部

**功能：**
1. **查看现有图片**
   - 显示所有已上传的凭证照片
   - 显示图片数量
   - 点击图片可查看大图（新窗口打开）

2. **补充上传图片**
   - 点击"拍照"或"相册"按钮
   - 可以一次选择/拍摄多张图片
   - 图片预览在"待上传"区域
   - 点击"上传 X 张图片"按钮提交

3. **实时更新**
   - 上传成功后，图片立即追加到现有图片列表
   - 申请详情自动刷新
   - 显示成功提示

**UI 设计：**
- 与新建申请的上传界面保持一致
- 使用分隔线区分现有图片和补充图片区域
- 上传状态有明确的视觉反馈

---

## 🔧 技术实现

### 数据库函数

**文件：** `supabase/migrations/20251109_add_expense_photos.sql`

**函数：** `add_expense_application_photos`

**功能：**
- 验证用户权限（只能补充自己的申请）
- 获取现有图片数组
- 合并新图片到现有数组
- 更新数据库记录

**参数：**
- `p_application_id`: 申请ID
- `p_additional_photos`: 新图片URL数组（TEXT[]）

**返回值：**
```json
{
  "success": true,
  "message": "图片已成功添加",
  "total_photos": 5
}
```

### 前端实现

**文件：** `src/pages/mobile/internal/MobileMyExpenses.tsx`

**关键函数：**

1. **`handleAdditionalFileSelect`**
   - 处理相册选择的多图
   - 过滤非图片文件
   - 添加到待上传列表

2. **`handleAdditionalCameraFileSelect`**
   - 处理拍照返回的多图
   - 添加到待上传列表
   - 显示成功提示

3. **`uploadAdditionalFilesToQiniu`**
   - 上传补充图片到七牛云
   - 返回图片URL数组

4. **`handleAddAdditionalPhotos`**
   - 调用 RPC 函数追加图片
   - 更新本地状态
   - 刷新申请列表

---

## 📊 数据流程

### 新建申请上传流程

```
用户选择/拍摄图片
    ↓
添加到 selectedFiles 数组
    ↓
用户点击"提交申请"
    ↓
上传所有图片到七牛云
    ↓
获取图片URL数组
    ↓
调用 submit_expense_application
    ↓
保存到数据库（receipt_photos 字段）
```

### 补充图片流程

```
用户在申请详情中点击"拍照"/"相册"
    ↓
选择/拍摄图片
    ↓
添加到 additionalFiles 数组
    ↓
用户点击"上传 X 张图片"
    ↓
上传图片到七牛云
    ↓
获取图片URL数组
    ↓
调用 add_expense_application_photos
    ↓
合并到现有 receipt_photos 数组
    ↓
更新数据库
    ↓
刷新申请详情显示
```

---

## ✅ 功能清单

### 新建申请
- [x] 支持一次选择多张图片（相册）
- [x] 支持一次拍摄多张照片（拍照）
- [x] 图片预览网格显示
- [x] 可以删除待上传的图片
- [x] 一次性上传所有图片
- [x] 上传状态提示

### 补充图片
- [x] 查看现有图片（带数量显示）
- [x] 点击图片查看大图
- [x] 支持拍照补充
- [x] 支持相册选择补充
- [x] 支持一次选择多张
- [x] 待上传图片预览
- [x] 可以删除待上传的图片
- [x] 上传状态提示
- [x] 上传成功后实时更新
- [x] 关闭对话框时清空待上传列表

---

## 🧪 测试建议

### 测试场景

1. **新建申请 - 多图上传**
   - ✅ 从相册选择 3 张图片，应该都能添加
   - ✅ 拍照 2 张，应该都能添加
   - ✅ 混合使用（1张拍照 + 2张相册），应该都能添加
   - ✅ 删除其中一张，其他图片保留
   - ✅ 提交后，所有图片都应该上传成功

2. **补充图片功能**
   - ✅ 打开已有图片的申请详情
   - ✅ 拍照补充 2 张图片
   - ✅ 从相册选择 1 张图片
   - ✅ 删除待上传的其中一张
   - ✅ 点击上传，应该成功追加到现有图片
   - ✅ 申请详情应该立即显示新图片
   - ✅ 关闭对话框后重新打开，新图片应该还在

3. **边界情况**
   - ✅ 申请没有图片时，补充图片功能应该正常
   - ✅ 申请已有 10 张图片，补充后应该显示 13 张
   - ✅ 网络错误时，应该显示错误提示
   - ✅ 上传过程中关闭对话框，应该正确处理

---

## 📝 部署步骤

### 1. 执行数据库迁移

在 Supabase SQL Editor 中执行：

```sql
-- 文件：supabase/migrations/20251109_add_expense_photos.sql
```

或直接执行：

```sql
CREATE OR REPLACE FUNCTION add_expense_application_photos(
    p_application_id UUID,
    p_additional_photos TEXT[]
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
-- ... (见完整文件)
$$;
```

### 2. 验证函数

```sql
-- 测试函数是否存在
SELECT proname 
FROM pg_proc 
WHERE proname = 'add_expense_application_photos';
```

### 3. 前端代码

前端代码已更新，无需额外部署步骤。

---

## 🎨 UI/UX 说明

### 设计原则

1. **一致性**
   - 新建申请和补充图片使用相同的上传界面
   - 按钮样式和布局保持一致

2. **清晰性**
   - 明确区分"现有图片"和"待上传图片"
   - 显示图片数量
   - 上传状态有明确的视觉反馈

3. **易用性**
   - 支持拍照和相册两种方式
   - 可以预览和删除待上传的图片
   - 操作简单直观

---

## 🔍 常见问题

### Q: 为什么补充图片后，列表没有更新？

A: 补充图片后会自动刷新申请列表。如果没看到更新，可能是：
- 网络延迟，稍等片刻
- 刷新页面查看最新数据

### Q: 可以删除已上传的图片吗？

A: 当前版本不支持删除已上传的图片。如需删除，请联系管理员。

### Q: 最多可以上传多少张图片？

A: 理论上没有限制，但建议单次不超过 10 张，以保证上传速度和用户体验。

---

**最后更新：** 2025-11-09  
**状态：** ✅ 功能已完成，等待测试

