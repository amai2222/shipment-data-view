# é‡ç®—å‡½æ•°ç»Ÿä¸€æ›´æ–°æ€»ç»“ - _1120 ç‰ˆæœ¬

## ğŸ“‹ æ›´æ–°æ¦‚è¿°

æ‰€æœ‰é‡ç®—ç›¸å…³å‡½æ•°å·²ç»Ÿä¸€æ›´æ–°ä¸º **_1120 ç‰ˆæœ¬**ï¼Œå¹¶æ·»åŠ äº†å®Œæ•´çš„**å®šä»·æ³•ï¼ˆfixed_priceï¼‰**æ”¯æŒå’Œ**ä¸‰é‡ä¿æŠ¤æœºåˆ¶**ã€‚

**æ›´æ–°æ—¥æœŸ**ï¼š2025-11-20  
**æ¶‰åŠå‡½æ•°æ•°é‡**ï¼š8 ä¸ª  
**æ¶‰åŠè¿ç§»æ–‡ä»¶æ•°é‡**ï¼š3 ä¸ª

---

## âœ… å·²æ›´æ–°çš„å‡½æ•°åˆ—è¡¨

### 1. æ‰¹é‡é‡ç®—å‡½æ•°

| æ—§å‡½æ•°å | æ–°å‡½æ•°å | çŠ¶æ€ |
|---------|---------|------|
| `batch_recalculate_partner_costs` | `batch_recalculate_partner_costs` | âœ… å·²æ›´æ–°ï¼ˆæ— åç¼€å˜åŒ–ï¼Œæ·»åŠ  fixed_price æ”¯æŒï¼‰ |
| `batch_recalculate_by_filter_1116` | `batch_recalculate_by_filter_1120` | âœ… å·²æ›´æ–° |

### 2. é“¾è·¯é‡ç®—å‡½æ•°

| æ—§å‡½æ•°å | æ–°å‡½æ•°å | çŠ¶æ€ |
|---------|---------|------|
| `recalculate_costs_for_chain` | `recalculate_costs_for_chain_1120` | âœ… å·²æ›´æ–° |
| `recalculate_costs_for_chain_safe` | `recalculate_costs_for_chain_safe_1120` | âœ… å·²æ›´æ–° |
| `recalculate_costs_for_project` | `recalculate_costs_for_project_1120` | âœ… å·²æ›´æ–° |

### 3. è§¦å‘å™¨å‡½æ•°

| æ—§å‡½æ•°å | æ–°å‡½æ•°å | çŠ¶æ€ |
|---------|---------|------|
| `auto_recalc_on_payable_cost_change` | `auto_recalc_on_payable_cost_change` | âœ… å·²æ›´æ–°ï¼ˆæ— åç¼€å˜åŒ–ï¼Œæ·»åŠ  fixed_price æ”¯æŒï¼‰ |
| `auto_recalc_on_project_partner_change` | `auto_recalc_on_project_partner_change_1120` | âœ… å·²æ›´æ–° |

### 4. ç‰¹æ®Šæ“ä½œå‡½æ•°

| æ—§å‡½æ•°å | æ–°å‡½æ•°å | çŠ¶æ€ |
|---------|---------|------|
| `modify_logistics_record_chain_with_recalc` | `modify_logistics_record_chain_with_recalc_1120` | âœ… å·²æ›´æ–° |

### 5. å·²åˆ›å»ºçš„æ–°å‡½æ•°

| å‡½æ•°å | ç”¨é€” | çŠ¶æ€ |
|--------|------|------|
| `auto_recalc_on_effective_quantity_or_cost_change` | æœ‰æ•ˆæ•°é‡æˆ–åŸºç¡€è¿ä»·æ”¹å˜æ—¶è‡ªåŠ¨é‡ç®— | âœ… æ–°åˆ›å»º |

---

## ğŸ“¦ æ¶‰åŠçš„è¿ç§»æ–‡ä»¶

### æ–‡ä»¶ 1ï¼šæ ¸å¿ƒé‡ç®—å‡½æ•°æ›´æ–°
**æ–‡ä»¶å**ï¼š`20251120_update_recalculate_functions_support_fixed_price.sql`

**æ›´æ–°å†…å®¹**ï¼š
- âœ… `batch_recalculate_partner_costs`ï¼ˆæ·»åŠ  fixed_price æ”¯æŒï¼‰
- âœ… `auto_recalc_on_payable_cost_change`ï¼ˆæ·»åŠ  fixed_price æ”¯æŒï¼‰

### æ–‡ä»¶ 2ï¼šè§¦å‘å™¨å’Œæ–°å‡½æ•°
**æ–‡ä»¶å**ï¼š`20251120_add_trigger_recalc_on_effective_quantity_change.sql`

**æ›´æ–°å†…å®¹**ï¼š
- âœ… `auto_recalc_on_effective_quantity_or_cost_change`ï¼ˆæ–°åˆ›å»ºï¼‰
- âœ… `trigger_recalc_on_effective_quantity_or_cost_change`ï¼ˆæ–°åˆ›å»ºï¼‰

### æ–‡ä»¶ 3ï¼šé“¾è·¯ç›¸å…³é‡ç®—å‡½æ•°
**æ–‡ä»¶å**ï¼š`20251120_update_all_recalc_functions_to_1120_with_fixed_price.sql`

**æ›´æ–°å†…å®¹**ï¼š
- âœ… `recalculate_costs_for_chain_1120`
- âœ… `recalculate_costs_for_chain_safe_1120`
- âœ… `recalculate_costs_for_project_1120`
- âœ… `auto_recalc_on_project_partner_change_1120`
- âœ… `trigger_auto_recalc_partner_costs`ï¼ˆæ›´æ–°ä¸ºä½¿ç”¨ _1120 å‡½æ•°ï¼‰

### æ–‡ä»¶ 4ï¼šç‰¹æ®Šæ“ä½œå‡½æ•°
**æ–‡ä»¶å**ï¼š`20251120_update_modify_and_batch_filter_to_1120.sql`

**æ›´æ–°å†…å®¹**ï¼š
- âœ… `modify_logistics_record_chain_with_recalc_1120`
- âœ… `batch_recalculate_by_filter_1120`

---

## ğŸ¯ æ–°å¢åŠŸèƒ½

### 1. å®šä»·æ³•æ”¯æŒï¼ˆfixed_priceï¼‰

**è®¡ç®—å…¬å¼**ï¼š
```sql
åº”ä»˜é‡‘é¢ = æœ‰æ•ˆæ•°é‡ Ã— å•ä»·
```

**æ•°æ®åº“å­—æ®µ**ï¼š
- `project_partners.unit_price`ï¼šå•ä»·ï¼ˆå…ƒ/å•ä½ï¼‰
- `project_partners.calculation_method`ï¼šè®¡ç®—æ–¹æ³•ï¼ˆæ”¯æŒ 'tax', 'profit', 'fixed_price'ï¼‰

**è®¡ç®—é€»è¾‘**ï¼š
```sql
IF calculation_method = 'fixed_price' THEN
    IF effective_quantity > 0 AND unit_price > 0 THEN
        payable_amount := effective_quantity * unit_price;
    ELSE
        payable_amount := 0;
    END IF;
END IF;
```

### 2. æœ‰æ•ˆæ•°é‡è®¡ç®—

**æ–°å¢å­—æ®µ**ï¼š
- `logistics_records.effective_quantity`ï¼šæœ‰æ•ˆæ•°é‡

**è®¡ç®—å‡½æ•°**ï¼š
- `get_effective_quantity_for_record_1120()`

**è®¡ç®—è§„åˆ™**ï¼š
- è®¡å¨ï¼ˆbilling_type_id=1ï¼‰ï¼šå–è£…è´§é‡é‡å’Œå¸è´§é‡é‡çš„æœ€å°å€¼
- è®¡è½¦ï¼ˆbilling_type_id=2ï¼‰ï¼šå›ºå®šå€¼ 1
- è®¡æ–¹ï¼ˆbilling_type_id=3ï¼‰ï¼šå–è£…è´§é‡é‡å’Œå¸è´§é‡é‡çš„æœ€å°å€¼
- è®¡ä»¶ï¼ˆbilling_type_id=4ï¼‰ï¼šå–è£…è´§é‡é‡å’Œå¸è´§é‡é‡çš„æœ€å°å€¼

### 3. ä¸‰é‡ä¿æŠ¤æœºåˆ¶

#### ä¿æŠ¤ 1ï¼šè¿å•çŠ¶æ€ä¿æŠ¤ï¼ˆè¿å•çº§ï¼‰

**æ£€æŸ¥æ¡ä»¶**ï¼š
```sql
IF payment_status != 'Unpaid' 
   OR invoice_status != 'Uninvoiced'
   OR receipt_status = 'Received' THEN
    -- è·³è¿‡é‡ç®—
END IF;
```

**ä¿æŠ¤å¯¹è±¡**ï¼š
- âœ… å·²ä»˜æ¬¾è¿å•
- âœ… å·²å¼€ç¥¨è¿å•
- âœ… å·²æ”¶æ¬¾è¿å•

#### ä¿æŠ¤ 2ï¼šæ‰‹å·¥ä¿®æ”¹ä¿æŠ¤ï¼ˆæˆæœ¬è®°å½•çº§ï¼‰

**æ£€æŸ¥æ¡ä»¶**ï¼š
```sql
IF is_manually_modified = true THEN
    -- ä¿ç•™æ‰‹å·¥å€¼ï¼Œè·³è¿‡é‡ç®—
END IF;
```

**ä¿æŠ¤å¯¹è±¡**ï¼š
- âœ… æ‰‹å·¥ä¿®æ”¹çš„åˆä½œæ–¹æˆæœ¬ï¼ˆæ‰€æœ‰è®¡ç®—æ–¹æ³•ï¼‰

#### ä¿æŠ¤ 3ï¼šç‹¬ç«‹è®¡ç®—ä¿æŠ¤ï¼ˆå±‚çº§çº§ï¼‰

**ç‰¹æ€§**ï¼š
- âœ… å®šä»·æ³•ä¸ä¾èµ–åŸºç¡€è¿ä»·ï¼ˆ`payable_cost`ï¼‰
- âœ… ä¿®æ”¹åŸºç¡€è¿ä»·ä¸ä¼šè§¦å‘å®šä»·æ³•é‡ç®—
- âœ… åªæœ‰æœ‰æ•ˆæ•°é‡æ”¹å˜æ‰ä¼šè§¦å‘å®šä»·æ³•é‡ç®—

---

## ğŸ”§ è§¦å‘å™¨æ›´æ–°

### ç°æœ‰è§¦å‘å™¨

| è§¦å‘å™¨å | è§¦å‘æ—¶æœº | ä½¿ç”¨çš„å‡½æ•° | çŠ¶æ€ |
|---------|---------|-----------|------|
| `trigger_auto_recalc_partner_costs` | é¡¹ç›®åˆä½œæ–¹å˜æ›´ | `auto_recalc_on_project_partner_change_1120` | âœ… å·²æ›´æ–° |
| `trigger_recalc_on_payable_cost_change` | åŸºç¡€è¿ä»·æ”¹å˜ | `auto_recalc_on_payable_cost_change` | âœ… å·²æ›´æ–° |
| `trigger_recalc_on_effective_quantity_or_cost_change` | æœ‰æ•ˆæ•°é‡æˆ–ç›¸å…³å­—æ®µæ”¹å˜ | `auto_recalc_on_effective_quantity_or_cost_change` | âœ… æ–°åˆ›å»º |
| `trigger_auto_calculate_cost_from_unit_price_1120` | å•ä»·æˆ–é‡é‡æ”¹å˜ | `auto_calculate_cost_from_unit_price_1120` | âœ… å·²å­˜åœ¨ |

---

## ğŸ“Š å‡½æ•°ä¾èµ–å…³ç³»

```
æ‰¹é‡é‡ç®—å‡½æ•°
â”œâ”€â”€ batch_recalculate_partner_costs (æ ¸å¿ƒå‡½æ•°)
â”‚   â””â”€â”€ è¢«ä»¥ä¸‹å‡½æ•°è°ƒç”¨ï¼š
â”‚       â”œâ”€â”€ batch_recalculate_by_filter_1120
â”‚       â”œâ”€â”€ recalculate_costs_for_chain_1120
â”‚       â””â”€â”€ recalculate_costs_for_chain_safe_1120
â”‚
â”œâ”€â”€ recalculate_costs_for_chain_1120
â”‚   â””â”€â”€ ç”¨äºï¼šå¼ºåˆ¶é‡ç®—æŒ‡å®šé“¾è·¯
â”‚
â”œâ”€â”€ recalculate_costs_for_chain_safe_1120
â”‚   â””â”€â”€ ç”¨äºï¼šå®‰å…¨é‡ç®—æŒ‡å®šé“¾è·¯ï¼ˆä¿æŠ¤å·²ä»˜æ¬¾ï¼‰
â”‚       â””â”€â”€ è¢«ä»¥ä¸‹å‡½æ•°è°ƒç”¨ï¼š
â”‚           â”œâ”€â”€ auto_recalc_on_project_partner_change_1120
â”‚           â””â”€â”€ recalculate_costs_for_project_1120
â”‚
â”œâ”€â”€ recalculate_costs_for_project_1120
â”‚   â””â”€â”€ ç”¨äºï¼šé‡ç®—æ•´ä¸ªé¡¹ç›®
â”‚
â”œâ”€â”€ batch_recalculate_by_filter_1120
â”‚   â””â”€â”€ ç”¨äºï¼šæŒ‰ç­›é€‰æ¡ä»¶æ‰¹é‡é‡ç®—
â”‚
â””â”€â”€ modify_logistics_record_chain_with_recalc_1120
    â””â”€â”€ ç”¨äºï¼šä¿®æ”¹é“¾è·¯å¹¶é‡ç®—
```

---

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»

æŒ‰é¡ºåºæ‰§è¡Œä»¥ä¸‹ SQL æ–‡ä»¶ï¼š

```bash
# 1. æ·»åŠ å®šä»·æ³•å­—æ®µå’Œçº¦æŸ
supabase/migrations/20251120_add_fixed_price_calculation_method.sql

# 2. æ›´æ–°æ ¸å¿ƒé‡ç®—å‡½æ•°ï¼ˆæ”¯æŒå®šä»·æ³•ï¼‰
supabase/migrations/20251120_update_recalculate_functions_support_fixed_price.sql

# 3. æ·»åŠ æœ‰æ•ˆæ•°é‡å˜åŒ–è§¦å‘å™¨
supabase/migrations/20251120_add_trigger_recalc_on_effective_quantity_change.sql

# 4. æ›´æ–°é“¾è·¯ç›¸å…³é‡ç®—å‡½æ•°
supabase/migrations/20251120_update_all_recalc_functions_to_1120_with_fixed_price.sql

# 5. æ›´æ–°ç‰¹æ®Šæ“ä½œå‡½æ•°
supabase/migrations/20251120_update_modify_and_batch_filter_to_1120.sql
```

æˆ–ä½¿ç”¨ Supabase CLIï¼š

```bash
supabase db push
```

### ç¬¬äºŒæ­¥ï¼šå‰ç«¯å·²æ›´æ–°

å‰ç«¯å·²å®Œæˆä»¥ä¸‹æ›´æ–°ï¼š
- âœ… `src/types/index.ts`ï¼šæ·»åŠ  `unit_price` å­—æ®µ
- âœ… `src/pages/Projects.tsx`ï¼šæ·»åŠ å®šä»·æ³•é€‰é¡¹å’Œå•ä½æ˜¾ç¤º

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯åŠŸèƒ½

1. æ‰“å¼€é¡¹ç›®ç®¡ç†é¡µé¢
2. åˆ›å»ºæˆ–ç¼–è¾‘é¡¹ç›®ï¼Œæ·»åŠ åˆä½œæ–¹
3. é€‰æ‹©"å®šä»·"è®¡ç®—æ–¹æ³•
4. è¾“å…¥å•ä»·ï¼ŒéªŒè¯å•ä½æ˜¾ç¤ºæ­£ç¡®
5. ä¿å­˜é¡¹ç›®ï¼ŒéªŒè¯æ•°æ®åº“æ­£ç¡®ä¿å­˜
6. ä¿®æ”¹è¿å•ï¼ŒéªŒè¯é‡ç®—é€»è¾‘æ­£ç¡®å·¥ä½œ

---

## ğŸ“ å‡½æ•°å¯¹æ¯”è¡¨

### å®šä»·æ³•æ”¯æŒå¯¹æ¯”

| å‡½æ•°å | æ—§ç‰ˆæœ¬ | _1120 ç‰ˆæœ¬ | å®šä»·æ³•æ”¯æŒ |
|--------|--------|-----------|-----------|
| `batch_recalculate_partner_costs` | tax, profit | tax, profit, fixed_price | âœ… |
| `recalculate_costs_for_chain` | tax, profit | tax, profit, fixed_price | âœ… |
| `recalculate_costs_for_chain_safe` | tax, profit | tax, profit, fixed_price | âœ… |
| `recalculate_costs_for_project` | tax, profit | tax, profit, fixed_price | âœ… |
| `auto_recalc_on_payable_cost_change` | tax, profit | tax, profit, fixed_price | âœ… |
| `auto_recalc_on_project_partner_change` | tax, profit | tax, profit, fixed_price | âœ… |
| `modify_logistics_record_chain_with_recalc` | tax, profit | tax, profit, fixed_price | âœ… |
| `batch_recalculate_by_filter` | tax, profit | tax, profit, fixed_price | âœ… |

### ä¿æŠ¤æœºåˆ¶å¯¹æ¯”

| å‡½æ•°å | è¿å•çŠ¶æ€ä¿æŠ¤ | æ‰‹å·¥ä¿®æ”¹ä¿æŠ¤ | ç‹¬ç«‹è®¡ç®—ä¿æŠ¤ |
|--------|------------|------------|------------|
| `batch_recalculate_partner_costs` | âœ… | âœ… | âœ… |
| `recalculate_costs_for_chain_1120` | âœ… | âœ… | âœ… |
| `recalculate_costs_for_chain_safe_1120` | âœ… | âœ… | âœ… |
| `recalculate_costs_for_project_1120` | âœ… | âœ… | âœ… |
| `auto_recalc_on_payable_cost_change` | âœ… | âœ… | âœ… |
| `auto_recalc_on_project_partner_change_1120` | âœ… | âœ… | âœ… |
| `modify_logistics_record_chain_with_recalc_1120` | âœ… | âœ… | âœ… |
| `batch_recalculate_by_filter_1120` | âœ… | âœ… | âœ… |

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

1. **åç¼€ç»Ÿä¸€**ï¼šæ‰€æœ‰æ–°ç‰ˆæœ¬å‡½æ•°ç»Ÿä¸€ä½¿ç”¨ `_1120` åç¼€ï¼ˆé™¤äº†æ— éœ€åç¼€çš„æ ¸å¿ƒå‡½æ•°ï¼‰

2. **å‘åå…¼å®¹**ï¼šæ—§ç‰ˆæœ¬å‡½æ•°ä»ç„¶å­˜åœ¨ï¼Œä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½

3. **è§¦å‘å™¨å·²æ›´æ–°**ï¼šè§¦å‘å™¨å·²æ›´æ–°ä¸ºä½¿ç”¨æ–°ç‰ˆæœ¬å‡½æ•°

4. **ä¿æŠ¤æœºåˆ¶å®Œæ•´**ï¼šæ‰€æœ‰å‡½æ•°éƒ½åŒ…å«ä¸‰é‡ä¿æŠ¤æœºåˆ¶

5. **å®šä»·æ³•ç‹¬ç«‹**ï¼šå®šä»·æ³•ä¸ä¾èµ–åŸºç¡€è¿ä»·ï¼Œåªä¾èµ–æœ‰æ•ˆæ•°é‡å’Œå•ä»·

---

## âœ… éªŒè¯æ¸…å•

### æ•°æ®åº“éªŒè¯
- [x] æ‰€æœ‰ _1120 å‡½æ•°å·²åˆ›å»º
- [x] è§¦å‘å™¨å·²æ›´æ–°
- [x] å­—æ®µçº¦æŸå·²æ›´æ–°
- [x] å®šä»·æ³•æ”¯æŒå·²æ·»åŠ 

### åŠŸèƒ½éªŒè¯
- [x] å®šä»·æ³•è®¡ç®—æ­£ç¡®
- [x] æœ‰æ•ˆæ•°é‡è®¡ç®—æ­£ç¡®
- [x] ä¸‰é‡ä¿æŠ¤æœºåˆ¶å·¥ä½œæ­£å¸¸
- [x] æ‰‹å·¥ä¿®æ”¹å€¼è¢«æ­£ç¡®ä¿æŠ¤
- [x] å·²ä»˜æ¬¾/å·²å¼€ç¥¨/å·²æ”¶æ¬¾è¿å•ä¸é‡ç®—

### å‰ç«¯éªŒè¯
- [x] å®šä»·æ³•é€‰é¡¹æ˜¾ç¤ºæ­£ç¡®
- [x] å•ä½åŠ¨æ€æ˜¾ç¤ºæ­£ç¡®
- [x] å•ä»·è¾“å…¥ä¿å­˜æ­£ç¡®
- [x] æ—  TypeScript é”™è¯¯

---

**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-20  
**æœ€åæ›´æ–°**ï¼š2025-11-20  
**çŠ¶æ€**ï¼šâœ… æ‰€æœ‰æ›´æ–°å·²å®Œæˆï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨

