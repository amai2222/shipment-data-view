# Edge Functions Token ä½¿ç”¨é€»è¾‘è¯´æ˜

## ğŸ“‹ æ¶æ„æ¦‚è§ˆ

ç³»ç»Ÿé‡‡ç”¨**åˆ†å±‚ç¼“å­˜æ¶æ„**ï¼Œæ‰€æœ‰ Edge Functions ç»Ÿä¸€é€šè¿‡ `get-tracking-token` æœåŠ¡è·å– Tokenã€‚

## ğŸ”„ å®Œæ•´ Token è·å–æµç¨‹

### ç¬¬ä¸€å±‚ï¼šå…¶ä»– Edge Functions

ä»¥ä¸‹å››ä¸ª Edge Functions **æ²¡æœ‰è‡ªå·±çš„ç¼“å­˜æœºåˆ¶**ï¼Œå®ƒä»¬åªæ˜¯ç®€å•åœ°è°ƒç”¨ `get-tracking-token` æœåŠ¡ï¼š

1. **`add-vehicle`** - æ·»åŠ è½¦è¾†
2. **`vehicle-tracking`** - æŸ¥è¯¢è½¦è¾†è½¨è¿¹
3. **`sync-vehicle-tracking-ids`** - åŒæ­¥è½¦è¾†IDæ˜ å°„
4. **`sync-vehicle`** - åŒæ­¥è½¦è¾†ï¼ˆéœ€è¦ ADD å’Œ QUERY ä¸¤ç§ Tokenï¼‰

### ç¬¬äºŒå±‚ï¼šget-tracking-token æœåŠ¡

`get-tracking-token` å‡½æ•°å†…éƒ¨å®ç°**ä¸‰å±‚ç¼“å­˜æœºåˆ¶**ï¼š

```
å…¶ä»– Edge Functions
    â†“
è°ƒç”¨ get-tracking-token({ type: 'add' | 'query' })
    â†“
get-tracking-token å†…éƒ¨ï¼š
    1. æ£€æŸ¥å†…å­˜ç¼“å­˜ï¼ˆå•æ¬¡è°ƒç”¨å†…ï¼‰
        â†“ æ— æ•ˆ
    2. æ£€æŸ¥æ•°æ®åº“ç¼“å­˜ï¼ˆè·¨è°ƒç”¨å…±äº«ï¼‰
        â†“ æ— æ•ˆæˆ–ä¸å­˜åœ¨
    3. è‡ªåŠ¨ç™»å½•è·å–æ–° Token
        â†“
    4. ä¿å­˜åˆ°æ•°æ®åº“
        â†“
    5. æ›´æ–°å†…å­˜ç¼“å­˜
        â†“
    6. è¿”å› Token
```

## ğŸ“Š è¯¦ç»†æµç¨‹è¯´æ˜

### åœºæ™¯1ï¼šé¦–æ¬¡è°ƒç”¨ï¼ˆæ•°æ®åº“ä¸­æ²¡æœ‰ Tokenï¼‰

```
ç”¨æˆ·è¯·æ±‚ â†’ add-vehicle
    â†“
è°ƒç”¨ get-tracking-token({ type: 'add' })
    â†“
get-tracking-token å†…éƒ¨ï¼š
    1. æ£€æŸ¥å†…å­˜ç¼“å­˜ â†’ ç©ºï¼ˆæ–°å®ä¾‹ï¼‰
    2. æ£€æŸ¥æ•°æ®åº“ç¼“å­˜ â†’ ç©ºï¼ˆé¦–æ¬¡è°ƒç”¨ï¼‰
    3. æ‰§è¡Œç™»å½• â†’ è·å–æ–° Token
    4. ä¿å­˜åˆ°æ•°æ®åº“ âœ…
    5. æ›´æ–°å†…å­˜ç¼“å­˜
    6. è¿”å› Token
    â†“
add-vehicle ä½¿ç”¨ Token è°ƒç”¨ç¬¬ä¸‰æ–¹ API
```

### åœºæ™¯2ï¼šåç»­è°ƒç”¨ï¼ˆæ•°æ®åº“ä¸­æœ‰æœ‰æ•ˆ Tokenï¼‰

```
ç”¨æˆ·è¯·æ±‚ â†’ vehicle-tracking
    â†“
è°ƒç”¨ get-tracking-token({ type: 'query' })
    â†“
get-tracking-token å†…éƒ¨ï¼š
    1. æ£€æŸ¥å†…å­˜ç¼“å­˜ â†’ ç©ºï¼ˆæ–°å®ä¾‹ï¼‰
    2. æ£€æŸ¥æ•°æ®åº“ç¼“å­˜ â†’ âœ… æ‰¾åˆ°æœ‰æ•ˆ Token
    3. æ›´æ–°å†…å­˜ç¼“å­˜
    4. è¿”å› Tokenï¼ˆæ— éœ€ç™»å½•ï¼‰
    â†“
vehicle-tracking ä½¿ç”¨ Token è°ƒç”¨ç¬¬ä¸‰æ–¹ API
```

### åœºæ™¯3ï¼šåŒä¸€è°ƒç”¨å†…å¤šæ¬¡è·å–ï¼ˆå†…å­˜ç¼“å­˜ï¼‰

```
ç”¨æˆ·è¯·æ±‚ â†’ sync-vehicle
    â†“
ç¬¬ä¸€æ¬¡è°ƒç”¨ get-tracking-token({ type: 'add' })
    â†“
get-tracking-token å†…éƒ¨ï¼š
    1. æ£€æŸ¥å†…å­˜ç¼“å­˜ â†’ ç©º
    2. æ£€æŸ¥æ•°æ®åº“ç¼“å­˜ â†’ âœ… æ‰¾åˆ°æœ‰æ•ˆ Token
    3. æ›´æ–°å†…å­˜ç¼“å­˜
    4. è¿”å› Token
    â†“
ç¬¬äºŒæ¬¡è°ƒç”¨ get-tracking-token({ type: 'add' })
    â†“
get-tracking-token å†…éƒ¨ï¼š
    1. æ£€æŸ¥å†…å­˜ç¼“å­˜ â†’ âœ… å‘½ä¸­ï¼ˆåŒä¸€è°ƒç”¨å†…ï¼‰
    2. ç›´æ¥è¿”å› Tokenï¼ˆæœ€å¿«ï¼‰
```

### åœºæ™¯4ï¼šToken è¿‡æœŸï¼ˆ401/403ï¼‰

```
ç”¨æˆ·è¯·æ±‚ â†’ add-vehicle
    â†“
è°ƒç”¨ get-tracking-token({ type: 'add' })
    â†“
get-tracking-token è¿”å› Tokenï¼ˆä»æ•°æ®åº“ç¼“å­˜ï¼‰
    â†“
add-vehicle ä½¿ç”¨ Token è°ƒç”¨ç¬¬ä¸‰æ–¹ API
    â†“
è¿”å› 401/403ï¼ˆToken è¿‡æœŸï¼‰
    â†“
add-vehicle æ£€æµ‹åˆ°é”™è¯¯ï¼Œé‡æ–°è°ƒç”¨ get-tracking-token
    â†“
get-tracking-token å†…éƒ¨ï¼š
    1. æ£€æŸ¥å†…å­˜ç¼“å­˜ â†’ å¯èƒ½å‘½ä¸­ï¼ˆä½†å·²è¿‡æœŸï¼‰
    2. æ£€æŸ¥æ•°æ®åº“ç¼“å­˜ â†’ å·²è¿‡æœŸ
    3. æ‰§è¡Œç™»å½• â†’ è·å–æ–° Token
    4. ä¿å­˜åˆ°æ•°æ®åº“ âœ…
    5. æ›´æ–°å†…å­˜ç¼“å­˜
    6. è¿”å›æ–° Token
    â†“
add-vehicle ä½¿ç”¨æ–° Token é‡è¯•
```

## ğŸ¯ å„ Edge Function çš„ Token ä½¿ç”¨

### 1. add-vehicle

```typescript
// ç›´æ¥è°ƒç”¨ get-tracking-token æœåŠ¡
authToken = await getTokenFromService(); // type: 'add'
```

**Token ç±»å‹**ï¼š`add`ï¼ˆæ·»åŠ è½¦è¾†ï¼‰

**ç¼“å­˜æœºåˆ¶**ï¼šæ— ï¼ˆä¾èµ– get-tracking-token çš„ç¼“å­˜ï¼‰

### 2. vehicle-tracking

```typescript
// ç›´æ¥è°ƒç”¨ get-tracking-token æœåŠ¡
SESSION_TOKEN = await getTokenFromService(); // type: 'query'
```

**Token ç±»å‹**ï¼š`query`ï¼ˆæŸ¥è¯¢è½¦è¾†ï¼‰

**ç¼“å­˜æœºåˆ¶**ï¼šæ— ï¼ˆä¾èµ– get-tracking-token çš„ç¼“å­˜ï¼‰

### 3. sync-vehicle-tracking-ids

```typescript
// ç›´æ¥è°ƒç”¨ get-tracking-token æœåŠ¡
SESSION_TOKEN = await getTokenFromService(); // type: 'query'
```

**Token ç±»å‹**ï¼š`query`ï¼ˆæŸ¥è¯¢è½¦è¾†ï¼‰

**ç¼“å­˜æœºåˆ¶**ï¼šæ— ï¼ˆä¾èµ– get-tracking-token çš„ç¼“å­˜ï¼‰

### 4. sync-vehicle

```typescript
// éœ€è¦ä¸¤ç§ Token
// 1. æ·»åŠ è½¦è¾†æ—¶
authToken = await getTokenFromService('add');

// 2. æŸ¥è¯¢IDæ—¶
authToken = await getTokenFromService('query');
```

**Token ç±»å‹**ï¼š`add` å’Œ `query`ï¼ˆæ ¹æ®æ“ä½œç±»å‹ï¼‰

**ç¼“å­˜æœºåˆ¶**ï¼šæ— ï¼ˆä¾èµ– get-tracking-token çš„ç¼“å­˜ï¼‰

## ğŸ” get-tracking-token å†…éƒ¨ç¼“å­˜æœºåˆ¶

### å†…å­˜ç¼“å­˜ï¼ˆç¬¬ä¸€å±‚ï¼‰

```typescript
const MEMORY_CACHE: {
  ADD: { token: string; expiresAt: number } | null;
  QUERY: { token: string; expiresAt: number } | null;
} = {
  ADD: null,
  QUERY: null
};
```

**ç‰¹ç‚¹**ï¼š
- ä½œç”¨åŸŸï¼šå•æ¬¡ Edge Function è°ƒç”¨
- æœ‰æ•ˆæœŸï¼š25åˆ†é’Ÿï¼ˆä¸ Token æœ‰æ•ˆæœŸä¸€è‡´ï¼‰
- ç”¨é€”ï¼šé¿å…åŒä¸€è°ƒç”¨å†…é‡å¤æŸ¥è¯¢æ•°æ®åº“

### æ•°æ®åº“ç¼“å­˜ï¼ˆç¬¬äºŒå±‚ï¼‰

```typescript
// ä» tracking_token_cache è¡¨è¯»å–
const dbToken = await getTokenFromDatabase(type);
```

**ç‰¹ç‚¹**ï¼š
- ä½œç”¨åŸŸï¼šæ‰€æœ‰ Edge Function è°ƒç”¨å…±äº«
- æœ‰æ•ˆæœŸï¼š25åˆ†é’Ÿï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
- å­˜å‚¨ï¼šPostgreSQL æ•°æ®åº“
- ç”¨é€”ï¼šè·¨è°ƒç”¨å…±äº« Tokenï¼Œå‡å°‘ç™»å½•æ¬¡æ•°

### è‡ªåŠ¨ç™»å½•ï¼ˆç¬¬ä¸‰å±‚ï¼‰

```typescript
// å¦‚æœç¼“å­˜éƒ½å¤±æ•ˆï¼Œæ‰§è¡Œç™»å½•
const { token, expiresAt } = await loginAndGetToken(type);
// ç™»å½•æˆåŠŸåè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
```

**ç‰¹ç‚¹**ï¼š
- è§¦å‘æ¡ä»¶ï¼šæ•°æ®åº“ä¸­æ²¡æœ‰ Token æˆ– Token å·²è¿‡æœŸ
- è‡ªåŠ¨ä¿å­˜ï¼šç™»å½•æˆåŠŸåè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
- æ›´æ–°ç¼“å­˜ï¼šåŒæ—¶æ›´æ–°å†…å­˜ç¼“å­˜

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### æ²¡æœ‰ç¼“å­˜ï¼ˆæ¯æ¬¡ç™»å½•ï¼‰

- æ¯æ¬¡è¯·æ±‚ï¼š~1-2ç§’ï¼ˆç™»å½•æ—¶é—´ï¼‰
- 100æ¬¡è¯·æ±‚ï¼š~100-200ç§’

### æœ‰æ•°æ®åº“ç¼“å­˜ï¼ˆå½“å‰å®ç°ï¼‰

- é¦–æ¬¡è¯·æ±‚ï¼š~1-2ç§’ï¼ˆç™»å½•æ—¶é—´ï¼‰
- åç»­è¯·æ±‚ï¼š~50-100msï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼‰
- 100æ¬¡è¯·æ±‚ï¼š~1-2ç§’ï¼ˆé¦–æ¬¡ï¼‰+ ~5-10ç§’ï¼ˆåç»­ï¼‰= ~6-12ç§’

**æ€§èƒ½æå‡**ï¼šçº¦ **10-20å€**

## âœ… æ€»ç»“

### å…¶ä»–å››ä¸ª Edge Functions

- âŒ **æ²¡æœ‰**å†…å­˜ç¼“å­˜
- âŒ **æ²¡æœ‰**æ•°æ®åº“æŸ¥è¯¢
- âœ… **ç›´æ¥è°ƒç”¨** `get-tracking-token` æœåŠ¡

### get-tracking-token æœåŠ¡

- âœ… **æœ‰**å†…å­˜ç¼“å­˜ï¼ˆå•æ¬¡è°ƒç”¨å†…ï¼‰
- âœ… **æœ‰**æ•°æ®åº“ç¼“å­˜ï¼ˆè·¨è°ƒç”¨å…±äº«ï¼‰
- âœ… **æœ‰**è‡ªåŠ¨ç™»å½•ï¼ˆç¼“å­˜å¤±æ•ˆæ—¶ï¼‰

### å®Œæ•´æµç¨‹

```
å…¶ä»– Edge Functions
    â†“
è°ƒç”¨ get-tracking-token
    â†“
get-tracking-token å†…éƒ¨ï¼š
    1. å†…å­˜ç¼“å­˜ â†’ æœ‰æ•ˆï¼Ÿâœ… è¿”å›
    2. æ•°æ®åº“ç¼“å­˜ â†’ æœ‰æ•ˆï¼Ÿâœ… è¿”å›
    3. è‡ªåŠ¨ç™»å½• â†’ è·å–æ–° Token â†’ ä¿å­˜åˆ°æ•°æ®åº“ â†’ è¿”å›
```

## ğŸ¯ å…³é”®ç‚¹

1. **å…¶ä»–å››ä¸ªå‡½æ•°ä¸ç›´æ¥è®¿é—®æ•°æ®åº“**ï¼šå®ƒä»¬åªè°ƒç”¨ `get-tracking-token` æœåŠ¡
2. **æ‰€æœ‰ç¼“å­˜é€»è¾‘é›†ä¸­åœ¨ get-tracking-token**ï¼šä¾¿äºç»´æŠ¤å’Œä¼˜åŒ–
3. **æ•°æ®åº“ç¼“å­˜æ˜¯è·¨è°ƒç”¨å…±äº«çš„**ï¼šæ‰€æœ‰ Edge Functions å…±äº«åŒä¸€ä¸ª Token
4. **è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“**ï¼šç™»å½•æˆåŠŸåè‡ªåŠ¨ä¿å­˜ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ

---

**æœ€åæ›´æ–°**ï¼š2025-01-16  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ

