# 数据库结构完整记录

## 数据表概览

根据 Supabase 查询结果，系统包含以下主要数据表：

### 核心业务表
1. **logistics_records** - 运单记录表（核心表）
2. **projects** - 项目表
3. **drivers** - 司机表
4. **locations** - 地点表
5. **partners** - 合作方表
6. **partner_chains** - 合作链路表
7. **billing_types** - 计费类型表

### 关联表
8. **driver_projects** - 司机项目关联表
9. **location_projects** - 地点项目关联表
10. **project_partners** - 项目合作方关联表

### 财务相关表
11. **logistics_partner_costs** - 物流合作方成本表
12. **partner_payment_requests** - 合作方支付申请表
13. **partner_payment_items** - 合作方支付项目表
14. **payment_records** - 支付记录表
15. **payment_requests** - 支付申请表
16. **invoice_records** - 发票记录表

### 磅单管理表
17. **scale_records** - 磅单记录表

### 合同管理表
18. **contracts** - 合同表
19. **contract_file_versions** - 合同文件版本表
20. **contract_permissions** - 合同权限表
21. **contract_reminders** - 合同提醒表
22. **contract_tags** - 合同标签表
23. **contract_tag_relations** - 合同标签关联表
24. **contract_numbering_rules** - 合同编号规则表
25. **contract_access_logs** - 合同访问日志表

### 导入模板表
26. **import_templates** - 导入模板表
27. **import_field_mappings** - 导入字段映射表
28. **import_fixed_mappings** - 导入固定映射表

### 外部平台表
29. **external_platforms** - 外部平台表

### 用户权限表
30. **profiles** - 用户档案表
31. **user_permissions** - 用户权限表
32. **user_roles** - 用户角色表
33. **role_permission_templates** - 角色权限模板表
34. **permission_audit_logs** - 权限审计日志表

### 其他功能表
35. **saved_searches** - 保存的搜索表
36. **partner_bank_details** - 合作方银行详情表

## 核心表详细结构

### logistics_records 表（运单记录表）

| 字段名 | 数据类型 | 是否可空 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | uuid | NO | gen_random_uuid() | 主键 |
| auto_number | text | NO | null | 运单编号 |
| project_id | uuid | YES | null | 项目ID |
| project_name | text | NO | null | 项目名称 |
| loading_date | timestamp with time zone | NO | null | 装货日期 |
| loading_location | text | NO | null | 装货地点 |
| unloading_location | text | NO | null | 卸货地点 |
| driver_id | uuid | YES | null | 司机ID |
| driver_name | text | NO | null | 司机姓名 |
| license_plate | text | NO | null | 车牌号 |
| driver_phone | text | NO | null | 司机电话 |
| loading_weight | numeric | YES | null | 装货重量 |
| unloading_date | timestamp with time zone | YES | null | 卸货日期 |
| unloading_weight | numeric | YES | null | 卸货重量 |
| transport_type | text | NO | null | 运输类型 |
| current_cost | numeric | YES | null | 运费金额 |
| extra_cost | numeric | YES | null | 额外费用 |
| payable_cost | numeric | YES | null | 应付费用 |
| remarks | text | YES | null | 备注 |
| created_by_user_id | uuid | NO | null | 创建用户ID |
| created_at | timestamp with time zone | NO | now() | 创建时间 |
| chain_id | uuid | YES | null | 合作链路ID |
| driver_payable_cost | numeric | YES | null | 司机应收费用 |
| user_id | uuid | YES | null | 用户ID |
| payment_status | text | NO | 'Unpaid' | 支付状态 |
| cargo_type | text | YES | null | 货物类型 |
| billing_type_id | bigint | YES | 1 | 计费类型ID |
| external_tracking_numbers | jsonb | YES | '[]'::jsonb | 其他平台运单号码 |
| other_platform_names | text[] | YES | '{}'::text[] | 其他平台名称数组 |
| loading_location_ids | text[] | YES | null | 装货地点ID数组 |
| unloading_location_ids | text[] | YES | null | 卸货地点ID数组 |

### projects 表（项目表）

| 字段名 | 数据类型 | 是否可空 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | uuid | NO | gen_random_uuid() | 主键 |
| name | text | NO | null | 项目名称 |
| start_date | text | NO | null | 开始日期 |
| end_date | text | NO | null | 结束日期 |
| manager | text | NO | null | 项目经理 |
| loading_address | text | NO | null | 装货地址 |
| unloading_address | text | NO | null | 卸货地址 |
| created_at | timestamp with time zone | NO | now() | 创建时间 |
| auto_code | text | YES | null | 自动编码 |
| finance_manager | text | YES | null | 财务负责人 |
| project_status | text | NO | '进行中' | 项目状态 |
| user_id | uuid | YES | null | 用户ID |
| planned_total_tons | numeric | YES | null | 计划总吨数 |
| cargo_type | text | NO | '货品' | 货物类型 |
| effective_quantity_type | effective_quantity_type | NO | 'min_value' | 有效数量计算类型 |

### drivers 表（司机表）

| 字段名 | 数据类型 | 是否可空 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | uuid | NO | gen_random_uuid() | 主键 |
| name | text | NO | null | 司机姓名 |
| license_plate | text | NO | null | 车牌号 |
| phone | text | NO | null | 电话 |
| created_at | timestamp with time zone | NO | now() | 创建时间 |
| user_id | uuid | YES | null | 用户ID |

### locations 表（地点表）

| 字段名 | 数据类型 | 是否可空 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | uuid | NO | gen_random_uuid() | 主键 |
| name | text | NO | null | 地点名称 |
| created_at | timestamp with time zone | NO | now() | 创建时间 |
| user_id | uuid | YES | null | 用户ID |

### partners 表（合作方表）

| 字段名 | 数据类型 | 是否可空 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | uuid | NO | gen_random_uuid() | 主键 |
| name | text | NO | null | 合作方名称 |
| tax_rate | numeric | NO | null | 税率 |
| created_at | timestamp with time zone | NO | now() | 创建时间 |
| user_id | uuid | YES | null | 用户ID |
| full_name | text | YES | null | 合作方全名 |

### scale_records 表（磅单记录表）

| 字段名 | 数据类型 | 是否可空 | 默认值 | 说明 |
|--------|----------|----------|--------|------|
| id | uuid | NO | gen_random_uuid() | 主键 |
| project_id | uuid | NO | null | 项目ID |
| project_name | text | NO | null | 项目名称 |
| loading_date | date | NO | null | 装货日期 |
| trip_number | integer | NO | null | 车次 |
| valid_quantity | numeric | YES | null | 有效数量 |
| billing_type_id | bigint | NO | 1 | 计费类型ID |
| image_urls | text[] | YES | '{}'::text[] | 图片URL数组 |
| license_plate | text | YES | null | 车牌号 |
| driver_name | text | YES | null | 司机姓名 |
| created_at | timestamp with time zone | NO | now() | 创建时间 |
| updated_at | timestamp with time zone | NO | now() | 更新时间 |
| created_by_user_id | uuid | NO | auth.uid() | 创建用户ID |
| user_id | uuid | NO | auth.uid() | 用户ID |
| logistics_number | text | YES | null | 物流编号 |

## 自定义类型

### effective_quantity_type 枚举
- `min_value` - 取较小值
- `loading` - 取装货数量
- `unloading` - 取卸货数量

### contract_category 枚举
- 合同分类枚举类型

### app_role 枚举
- `operator` - 操作员
- 其他角色类型

## 索引和约束

### 主键约束
- 所有表都有 `id` 字段作为主键，类型为 `uuid`
- 主键默认值使用 `gen_random_uuid()`

### 外键约束
- `logistics_records.project_id` → `projects.id`
- `logistics_records.driver_id` → `drivers.id`
- `logistics_records.chain_id` → `partner_chains.id`
- `logistics_records.billing_type_id` → `billing_types.billing_type_id`
- 其他关联表的外键关系

### 唯一约束
- `drivers.name` + `drivers.license_plate` 组合唯一（已移除）
- 其他业务唯一约束

## 时间戳字段

### 标准时间戳字段
- `created_at` - 创建时间，类型：`timestamp with time zone`，默认值：`now()`
- `updated_at` - 更新时间，类型：`timestamp with time zone`，默认值：`now()`

### 业务时间字段
- `loading_date` - 装货日期，类型：`timestamp with time zone`
- `unloading_date` - 卸货日期，类型：`timestamp with time zone`
- `loading_date` (scale_records) - 装货日期，类型：`date`

## 数组字段

### 文本数组
- `other_platform_names` - 其他平台名称数组
- `loading_location_ids` - 装货地点ID数组
- `unloading_location_ids` - 卸货地点ID数组
- `image_urls` - 图片URL数组
- `recipient_emails` - 收件人邮箱数组

### UUID数组
- `logistics_record_ids` - 运单记录ID数组

### 整数数组
- `work_wechat_department` - 企业微信部门数组

## JSONB字段

### 业务数据
- `external_tracking_numbers` - 外部运单号码JSON数据
- `details` - 详细信息JSON数据
- `field_permissions` - 字段权限JSON数据
- `file_permissions` - 文件权限JSON数据
- `filters` - 筛选条件JSON数据
- `approval_result` - 审批结果JSON数据
- `old_value` - 旧值JSON数据
- `new_value` - 新值JSON数据
- `custom_settings` - 自定义设置JSON数据

## 默认值策略

### 时间戳默认值
- 大部分表使用 `now()` 作为 `created_at` 的默认值
- 部分表使用 `now()` 作为 `updated_at` 的默认值

### 业务默认值
- `payment_status` 默认为 `'Unpaid'`
- `project_status` 默认为 `'进行中'`
- `cargo_type` 默认为 `'货品'`
- `billing_type_id` 默认为 `1`
- `is_active` 默认为 `true`
- `is_default` 默认为 `false`

### 数组默认值
- 空数组使用 `'{}'::text[]` 或 `'[]'::jsonb`
- UUID数组使用 `'{}'::uuid[]`

## 注释说明

### 重要字段注释
- `payment_status`: "运单的支付状态 (Unpaid: 未支付, Processing: 已申请支付, Paid: 已完成支付)"
- `cargo_type`: "货物类型"
- `external_tracking_numbers`: "其他平台运单号码，JSON格式存储，支持多个平台的运单号关联"
- `other_platform_names`: "其他平台名称数组，记录该运单涉及的其他物流平台"
- `loading_location_ids`: "装货地点ID数组，用于多装多卸功能"
- `unloading_location_ids`: "卸货地点ID数组，用于多装多卸功能"
- `effective_quantity_type`: "有效数量计算类型：min_value=取较小值，loading=取装货数量，unloading=取卸货数量"

## 数据完整性

### 必填字段
- 所有主键字段都是必填的
- 核心业务字段如 `project_name`, `driver_name`, `loading_location` 等是必填的
- 时间戳字段 `created_at` 通常是必填的

### 可选字段
- 大部分业务字段都允许为空
- 数组字段通常有默认的空数组值
- JSONB字段通常有默认的空对象或数组值

## 总结

数据库结构设计合理，包含了完整的业务功能：
1. **核心业务**：运单管理、项目管理、司机管理、地点管理
2. **财务管理**：成本计算、支付管理、发票管理
3. **权限管理**：用户权限、角色管理、审计日志
4. **合同管理**：合同存储、版本控制、权限管理
5. **磅单管理**：磅单记录、图片管理
6. **导入功能**：模板管理、字段映射
7. **多装多卸**：支持多个装货和卸货地点

所有字段都有明确的类型定义和约束，数据结构完整且规范。
