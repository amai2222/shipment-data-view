# 菜单与权限自动同步指南

## 📋 系统设计

### 自动同步规则

```
┌──────────────────┐
│  menu_config     │
│  (菜单配置)       │
│                  │
│  - 添加菜单       │
│  - 删除菜单       │
│  - 修改菜单       │
│  - 启用/禁用     │
└────────┬─────────┘
         │
         │ 触发器
         ↓
┌────────────────────────────────┐
│    自动同步                      │
├────────────────────────────────┤
│  ✅ admin → 自动同步所有菜单      │
│  ⚠️ 其他角色 → 手动配置          │
└────────────────────────────────┘
```

### 角色权限管理策略

| 角色 | 菜单权限 | 同步方式 | 说明 |
|------|----------|----------|------|
| **admin** | 全部菜单 | ✅ 自动同步 | 管理员应该能访问所有功能 |
| **finance** | 部分菜单 | ⚠️ 手动配置 | 根据职责配置 |
| **business** | 部分菜单 | ⚠️ 手动配置 | 根据职责配置 |
| **operator** | 部分菜单 | ⚠️ 手动配置 | 根据职责配置 |
| **partner** | 部分菜单 | ⚠️ 手动配置 | 根据职责配置 |
| **viewer** | 部分菜单 | ⚠️ 手动配置 | 根据职责配置 |

---

## 🎯 管理员自动同步

### 触发时机

**所有菜单操作都会自动同步到管理员**：

1. ✅ **添加新菜单**
   ```
   在 menu_config 中插入新菜单
   ↓
   触发器自动执行
   ↓
   管理员的 menu_permissions 自动添加新菜单key
   ```

2. ✅ **删除菜单**
   ```
   从 menu_config 中删除菜单
   ↓
   触发器自动执行
   ↓
   管理员的 menu_permissions 自动移除该菜单key
   ```

3. ✅ **禁用菜单**
   ```
   将 is_active 设为 false
   ↓
   触发器自动执行
   ↓
   管理员的 menu_permissions 自动移除该菜单key
   ```

4. ✅ **启用菜单**
   ```
   将 is_active 设为 true
   ↓
   触发器自动执行
   ↓
   管理员的 menu_permissions 自动添加该菜单key
   ```

5. ✅ **修改菜单（不改key）**
   ```
   修改菜单的标题、图标、排序等
   ↓
   触发器自动执行
   ↓
   管理员的 menu_permissions 保持不变（因为key未变）
   ```

### 实现机制

**数据库触发器**：
- 文件：`supabase/migrations/20251103_auto_sync_admin_menu_permissions.sql`
- 触发条件：menu_config 表的 INSERT/UPDATE/DELETE
- 执行动作：重新同步管理员的 menu_permissions

---

## 👥 其他角色手动配置

### 为什么不自动同步？

❌ **不推荐自动同步原因**：
1. **权限隔离**：不同角色应该有不同的访问权限
2. **安全考虑**：新功能可能包含敏感信息
3. **灵活性**：管理员可以精细控制每个角色的权限

### 配置流程

#### 场景 1：添加新菜单后配置权限

**步骤：**

1. **添加菜单**
   ```
   访问：/settings/menu-config
   点击：新建菜单
   填写：
   - 菜单Key: reports.analysis
   - 显示标题: 数据分析
   - 所属分组: business_group
   保存
   ```

2. **系统自动处理**
   ```
   ✅ 管理员自动获得访问权限
   ⏳ 其他角色暂无权限
   ```

3. **检查同步状态**
   ```
   在菜单配置页面
   点击："检查同步状态"
   
   显示：⚠️ 发现 1 个新菜单尚未被非管理员角色使用
         [reports.analysis]
         
         ✅ 管理员已自动拥有这些菜单的访问权限
   ```

4. **为其他角色配置权限**
   ```
   访问：/settings/role-templates
   
   finance 角色：
   - 勾选 [reports.analysis]
   - 保存
   
   business 角色：
   - 勾选 [reports.analysis]
   - 保存
   
   operator 角色：
   - 不勾选（不需要此功能）
   ```

5. **验证**
   ```
   返回菜单配置页面
   点击："检查同步状态"
   
   ✅ 菜单配置与权限设置完全同步
   ```

---

#### 场景 2：删除菜单后清理权限

**步骤：**

1. **删除菜单**
   ```
   访问：/settings/menu-config
   找到要删除的菜单
   点击：删除按钮
   确认
   ```

2. **系统自动处理**
   ```
   ✅ 管理员权限自动清理
   ⏳ 其他角色需要手动清理
   ```

3. **检查同步状态**
   ```
   点击："检查同步状态"
   
   显示：❌ 发现 1 个过期权限
         [deleted.menu.key]
         
         （管理员已自动清理）
   ```

4. **清理其他角色的过期权限**
   ```
   点击："清理过期权限"
   确认
   
   ✅ 已从非管理员角色中移除 1 个过期权限
   ```

---

## 🔧 技术实现

### 数据库触发器

**文件**：`supabase/migrations/20251103_auto_sync_admin_menu_permissions.sql`

**核心函数**：
```sql
CREATE OR REPLACE FUNCTION auto_sync_admin_menu_permissions()
RETURNS void AS $$
DECLARE
    v_menu_keys TEXT[];
BEGIN
    -- 1. 获取所有启用的菜单项的 key
    SELECT array_agg(key ORDER BY order_index)
    INTO v_menu_keys
    FROM menu_config
    WHERE is_active = true
      AND is_group = false;

    -- 2. 更新管理员模板的菜单权限
    UPDATE role_permission_templates
    SET menu_permissions = v_menu_keys
    WHERE role = 'admin';
END;
$$ LANGUAGE plpgsql;
```

**触发器**：
```sql
CREATE TRIGGER trigger_auto_sync_admin_on_menu_change
    AFTER INSERT OR UPDATE OR DELETE ON menu_config
    FOR EACH STATEMENT
    EXECUTE FUNCTION trigger_sync_admin_menu_permissions();
```

### 前端同步管理器

**文件**：`src/components/permissions/PermissionSyncManager.tsx`

**功能**：
- ✅ 检查非管理员角色的同步状态
- ✅ 排除管理员（因为已自动同步）
- ✅ 一键清理过期权限

---

## 📊 使用示例

### 示例 1：新增功能模块

**场景**：添加"合同审核"功能

```
1. 创建菜单
   /settings/menu-config
   → 新建菜单
   → 菜单Key: contracts.audit
   → 标题: 合同审核
   → 保存

2. 系统自动处理
   ✅ admin 角色自动获得权限
   
3. 配置其他角色
   /settings/role-templates
   → finance: 勾选 ✅
   → business: 勾选 ✅
   → operator: 不勾选 ❌
   → partner: 不勾选 ❌
   → 保存

4. 验证
   - admin 用户登录 → 可见"合同审核"
   - finance 用户登录 → 可见"合同审核"
   - operator 用户登录 → 不可见
```

---

### 示例 2：移除废弃功能

**场景**：移除"旧版报表"功能

```
1. 删除菜单
   /settings/menu-config
   → 找到"旧版报表"
   → 删除
   → 确认

2. 系统自动处理
   ✅ admin 权限自动清理
   
3. 清理其他角色
   /settings/menu-config
   → 点击"检查同步状态"
   → 显示：❌ 发现 1 个过期权限
   → 点击"清理过期权限"
   → 确认

4. 完成
   ✅ 所有角色的权限已同步清理
   ✅ 用户界面不再显示此菜单
```

---

## ⚙️ 配置验证

### 验证管理员自动同步

```sql
-- 1. 查看当前菜单数
SELECT COUNT(*) AS menu_count
FROM menu_config
WHERE is_active = true AND is_group = false;

-- 2. 查看管理员权限数
SELECT 
    role,
    array_length(menu_permissions, 1) AS permission_count,
    menu_permissions
FROM role_permission_templates
WHERE role = 'admin';

-- 3. 两者应该相等
-- 如果不等，手动触发同步：
SELECT auto_sync_admin_menu_permissions();
```

### 检查触发器状态

```sql
-- 查看触发器是否存在
SELECT 
    trigger_name,
    event_manipulation,
    action_statement
FROM information_schema.triggers
WHERE trigger_name = 'trigger_auto_sync_admin_on_menu_change';
```

---

## 📅 最佳实践

### 工作流程

1. **添加新功能时**
   ```
   添加菜单 → 自动同步admin → 配置其他角色 → 测试验证
   ```

2. **删除功能时**
   ```
   删除菜单 → 自动同步admin → 清理其他角色 → 验证
   ```

3. **定期维护**
   ```
   每周检查一次同步状态
   清理过期权限
   审查各角色的权限配置
   ```

### 权限配置建议

**finance（财务）**：
- ✅ 财务看板
- ✅ 对账管理
- ✅ 付款开票
- ✅ 付款申请
- ✅ 开票申请
- ✅ 审核管理

**business（业务）**：
- ✅ 运输看板
- ✅ 项目看板
- ✅ 运单管理
- ✅ 磅单管理
- ✅ 开票申请
- ✅ 付款申请

**operator（操作员）**：
- ✅ 运输看板
- ✅ 运单管理
- ✅ 司机管理
- ✅ 地点管理
- ✅ 数据维护

**partner（合作方）**：
- ✅ 货主看板
- ✅ 自己的运单查询
- ❌ 其他功能受限

**viewer（查看者）**：
- ✅ 基础看板
- ❌ 所有编辑功能

---

## ❓ 常见问题

### Q1: 为什么管理员要自动同步？

**A**: 
- ✅ 管理员需要管理系统的所有功能
- ✅ 新功能可能需要管理员配置
- ✅ 避免管理员权限配置遗漏

### Q2: 可以让所有角色都自动同步吗？

**A**: 不推荐，原因：
- ❌ 破坏权限隔离
- ❌ 安全风险（所有人看到新功能）
- ❌ 不符合最小权限原则

### Q3: 触发器会影响性能吗？

**A**: 不会，因为：
- ✅ 只在菜单变化时触发（频率很低）
- ✅ 只更新一条记录（admin 模板）
- ✅ 使用 FOR EACH STATEMENT（不是 FOR EACH ROW）

### Q4: 如果触发器失败了怎么办？

**A**: 可以手动触发：
```sql
SELECT auto_sync_admin_menu_permissions();
```

### Q5: 可以禁用自动同步吗？

**A**: 可以，删除触发器：
```sql
DROP TRIGGER trigger_auto_sync_admin_on_menu_change ON menu_config;
```
但不推荐，建议保持自动同步。

---

## ✅ 部署检查清单

### 数据库迁移

- [ ] 运行 `20251103_create_dynamic_menu_system.sql`
- [ ] 运行 `20251103_auto_sync_admin_menu_permissions.sql`
- [ ] 验证触发器已创建
- [ ] 验证管理员权限已同步

### 前端配置

- [ ] 启用动态侧边栏组件
- [ ] 添加菜单配置路由
- [ ] 测试权限同步管理器

### 功能测试

- [ ] admin 登录 → 可见所有菜单
- [ ] 添加新菜单 → admin 自动可见
- [ ] 删除菜单 → admin 自动隐藏
- [ ] 其他角色 → 按配置显示

---

## 📊 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                    菜单管理系统                           │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐         ┌─────────────────┐          │
│  │ menu_config  │ 触发器   │ admin 权限       │          │
│  │ (菜单配置)    ├────────→│ 自动同步         │          │
│  └──────────────┘         └─────────────────┘          │
│         │                                                │
│         │                 ┌─────────────────┐          │
│         └────手动配置─────→│ 其他角色权限     │          │
│                           │ (手动同步)       │          │
│                           └─────────────────┘          │
│                                                           │
│  ┌──────────────────────────────────────────┐          │
│  │       PermissionSyncManager              │          │
│  │  - 检查非admin角色同步状态               │          │
│  │  - 清理过期权限                          │          │
│  │  - 提示需要配置的权限                    │          │
│  └──────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────┘
```

---

**文档版本**：2.0  
**创建时间**：2025-11-03  
**最后更新**：2025-11-03  
**维护者**：系统管理员

