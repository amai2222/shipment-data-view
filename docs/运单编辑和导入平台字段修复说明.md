# 运单编辑和导入平台字段修复说明

## 问题描述

1. **运单管理编辑时信息出不来** - 编辑运单时，司机、司机电话、车牌号、装卸货地点等信息无法正确加载
2. **导入时其他平台名称和运单号带不进去** - Excel导入时，平台字段数据无法正确保存到数据库

## 问题原因

### 1. 运单编辑问题
- `get_logistics_summary_and_records` 函数没有返回平台字段
- 运单管理页面查询的数据缺少 `external_tracking_numbers` 和 `other_platform_names` 字段
- 编辑对话框无法获取完整的运单信息

### 2. 导入平台字段问题
- `import_logistics_data` 函数没有正确处理平台字段
- 导入时平台字段数据被忽略，没有保存到数据库

## 修复内容

### 1. 更新运单查询函数

**文件**: `scripts/fix-waybill-edit-and-import-platform-fields.sql`

**修复内容**:
- 更新 `get_logistics_summary_and_records` 函数
- 在返回的记录中包含平台字段
- 确保编辑时能获取完整的运单信息

**关键代码**:
```sql
SELECT jsonb_agg(
    jsonb_build_object(
        'id', lr.id,
        'auto_number', lr.auto_number,
        -- ... 其他字段
        'external_tracking_numbers', lr.external_tracking_numbers,
        'other_platform_names', lr.other_platform_names,
        'created_at', lr.created_at
    )
) INTO v_records
FROM public.logistics_records lr
-- ... 查询条件
```

### 2. 更新导入函数

**修复内容**:
- 更新 `import_logistics_data` 函数
- 在INSERT语句中包含平台字段
- 正确处理 `external_tracking_numbers` 和 `other_platform_names`

**关键代码**:
```sql
INSERT INTO public.logistics_records (
    -- ... 其他字段
    external_tracking_numbers, other_platform_names
) VALUES (
    -- ... 其他值
    CASE WHEN record_data->'external_tracking_numbers' IS NOT NULL 
         THEN record_data->'external_tracking_numbers' ELSE '[]'::jsonb END,
    CASE WHEN record_data->'other_platform_names' IS NOT NULL 
         THEN (record_data->'other_platform_names')::text[] ELSE '{}'::text[] END
)
```

## 修复后的效果

### 1. 运单编辑功能
- ✅ 编辑时能正确加载所有运单信息
- ✅ 司机、司机电话、车牌号信息正确显示
- ✅ 装卸货地点信息正确显示
- ✅ 平台字段信息正确显示

### 2. 导入功能
- ✅ Excel导入时平台字段正确保存
- ✅ 其他平台名称正确保存到 `other_platform_names` 字段
- ✅ 外部运单号正确保存到 `external_tracking_numbers` 字段
- ✅ 数据维护和运单管理导入都支持平台字段

## 测试脚本

### 1. 执行修复
```sql
\i scripts/fix-waybill-edit-and-import-platform-fields.sql
```

### 2. 测试修复结果
```sql
\i scripts/test-waybill-edit-fix.sql
```

## 使用说明

### 1. 运单编辑
1. 进入运单管理页面
2. 点击"编辑"按钮
3. 现在应该能正确显示所有运单信息，包括平台字段

### 2. Excel导入
1. 下载Excel模板
2. 填写数据，包括平台字段：
   - 其他平台名称：`平台A,平台B,平台C`
   - 其他平台运单号：`运单1|运单2,运单3|运单4,运单5`
3. 上传导入
4. 平台字段数据将正确保存到数据库

## 相关文件

1. **数据库函数**:
   - `get_logistics_summary_and_records` - 运单查询函数
   - `import_logistics_data` - 导入函数

2. **前端文件**:
   - `src/pages/BusinessEntry/components/LogisticsFormDialog.tsx` - 编辑对话框
   - `src/pages/BusinessEntry/hooks/useLogisticsData.ts` - 数据查询Hook
   - `src/pages/BusinessEntry/hooks/useExcelImport.ts` - 导入Hook

3. **类型定义**:
   - `src/pages/BusinessEntry/types.ts` - LogisticsRecord类型

## 更新日志

- 2025-01-20: 识别运单编辑和导入平台字段问题
- 2025-01-20: 修复运单查询函数，包含平台字段
- 2025-01-20: 修复导入函数，支持平台字段
- 2025-01-20: 创建测试脚本验证修复
- 2025-01-20: 创建修复说明文档

## 结论

现在运单管理编辑功能和Excel导入功能都能正确处理平台字段了：

1. **编辑功能** - 能正确加载和显示所有运单信息
2. **导入功能** - 能正确保存平台字段数据到数据库
3. **数据一致性** - 前端显示和数据库存储保持一致

所有功能都已修复并可以正常使用！
