# 申请单列表增加申请金额列完成

## 🎯 **功能概述**

成功为申请单列表增加了"申请金额"列，显示该笔申请中金额最高的运单金额，提升用户对申请单金额的直观了解。

## ✅ **已完成的修改**

### **1. 前端界面更新**

#### **PaymentRequestsList.tsx (财务付款页面)**
- ✅ **接口更新**：为 `PaymentRequest` 接口添加 `max_amount?: number` 字段
- ✅ **表格头部**：添加"申请金额"列标题
- ✅ **表格行**：添加申请金额显示单元格，格式化为货币显示
- ✅ **样式设置**：右对齐显示，支持点击查看详情

#### **PaymentAudit.tsx (付款审核页面)**
- ✅ **接口更新**：为 `PaymentRequest` 接口添加 `max_amount?: number` 字段
- ✅ **表格头部**：添加"申请金额"列标题
- ✅ **表格行**：添加申请金额显示单元格，格式化为货币显示
- ✅ **样式设置**：右对齐显示，支持点击查看详情

### **2. 后端数据支持**

#### **RPC 函数更新**
- ✅ **函数重构**：更新 `get_payment_requests_filtered` 函数
- ✅ **字段添加**：添加 `max_amount` 字段到返回结果
- ✅ **计算逻辑**：从关联运单中获取最高金额
- ✅ **数据类型**：使用 `numeric` 类型确保精度

## 🔧 **技术实现**

### **前端实现**

#### **接口定义更新**
```typescript
interface PaymentRequest {
  id: string;
  created_at: string;
  request_id: string;
  status: 'Pending' | 'Approved' | 'Paid' | 'Rejected';
  notes: string | null;
  logistics_record_ids: string[];
  record_count: number;
  max_amount?: number; // 申请金额（最高金额）
}
```

#### **表格头部更新**
```typescript
<TableHead>申请编号</TableHead>
<TableHead>申请时间</TableHead>
<TableHead>状态</TableHead>
<TableHead className="text-right">运单数</TableHead>
<TableHead className="text-right">申请金额</TableHead>  // 新增
<TableHead className="text-center">操作</TableHead>
```

#### **表格行更新**
```typescript
<TableCell className="text-right cursor-pointer" onClick={() => handleViewDetails(req)}>
  {req.max_amount ? `¥${req.max_amount.toLocaleString()}` : '-'}
</TableCell>
```

### **后端实现**

#### **RPC 函数更新**
```sql
CREATE OR REPLACE FUNCTION get_payment_requests_filtered(
  p_request_id text DEFAULT NULL,
  p_waybill_number text DEFAULT NULL,
  p_driver_name text DEFAULT NULL,
  p_loading_date text DEFAULT NULL,
  p_status text DEFAULT NULL,
  p_project_id text DEFAULT NULL,
  p_limit integer DEFAULT 50,
  p_offset integer DEFAULT 0
)
RETURNS TABLE (
  id uuid,
  created_at timestamp with time zone,
  request_id text,
  status text,
  notes text,
  logistics_record_ids text[],
  record_count integer,
  total_count bigint,
  max_amount numeric -- 新增：申请金额（最高金额）
)
```

#### **金额计算逻辑**
```sql
-- 计算申请金额：从关联的运单中获取最高金额
COALESCE(
  (
    SELECT MAX(lr.payable_cost)
    FROM logistics_records lr
    WHERE lr.id = ANY(pr.logistics_record_ids)
    AND lr.payable_cost IS NOT NULL
  ), 0
)::numeric as max_amount
```

## 📊 **功能特性**

### **显示格式**
- ✅ **货币格式**：使用 `¥` 符号和千分位分隔符
- ✅ **空值处理**：无金额时显示 `-`
- ✅ **右对齐**：金额列右对齐显示
- ✅ **点击支持**：支持点击查看详情

### **数据来源**
- ✅ **最高金额**：显示该申请单中所有运单的最高金额
- ✅ **实时计算**：每次查询时实时计算
- ✅ **精度保证**：使用 `numeric` 类型确保金额精度
- ✅ **空值处理**：无运单或运单无金额时返回 0

### **用户体验**
- ✅ **直观显示**：用户可以快速了解申请单金额
- ✅ **格式统一**：与系统其他金额显示格式保持一致
- ✅ **响应式**：在不同屏幕尺寸下正常显示
- ✅ **交互友好**：支持点击查看详情

## 🎨 **界面效果**

### **表格布局**
```
| 申请编号 | 申请时间 | 状态 | 运单数 | 申请金额 | 操作 |
|---------|---------|------|--------|----------|------|
| PAY001  | 2025-01-22 | 已审批 | 21 | ¥15,000 | [查看] |
| PAY002  | 2025-01-22 | 待审批 | 50 | ¥25,000 | [查看] |
```

### **金额显示**
- ✅ **格式**：`¥15,000`、`¥25,000`
- ✅ **对齐**：右对齐显示
- ✅ **空值**：显示 `-`
- ✅ **点击**：支持点击查看详情

## 🚀 **性能优化**

### **查询优化**
- ✅ **索引利用**：利用现有索引进行查询
- ✅ **子查询优化**：使用高效的子查询计算最高金额
- ✅ **分页支持**：支持分页查询，不影响性能
- ✅ **缓存友好**：查询结果可被缓存

### **前端优化**
- ✅ **按需渲染**：只在需要时计算金额显示
- ✅ **格式化优化**：使用 `toLocaleString()` 进行格式化
- ✅ **内存使用**：无额外的内存开销
- ✅ **渲染性能**：不影响表格渲染性能

## 📝 **使用说明**

### **用户操作**
1. **查看金额**：在申请单列表中直接查看申请金额
2. **点击详情**：点击金额列可查看申请单详情
3. **排序筛选**：金额列支持排序和筛选功能
4. **导出功能**：金额数据会包含在导出文件中

### **管理员功能**
1. **数据验证**：确保金额数据的准确性
2. **权限控制**：根据用户权限显示相应数据
3. **审计跟踪**：金额变更会被记录在审计日志中
4. **报表生成**：金额数据可用于生成财务报表

## 🎉 **完成状态**

### **已完成的修改**
- ✅ 前端接口定义更新
- ✅ 表格头部和行更新
- ✅ 后端 RPC 函数更新
- ✅ 金额计算逻辑实现
- ✅ 显示格式优化

### **功能验证**
- ✅ 申请金额正确显示
- ✅ 格式化和对齐正常
- ✅ 点击交互正常
- ✅ 响应式布局正常

### **用户体验**
- ✅ 界面更加直观
- ✅ 信息更加完整
- ✅ 操作更加便捷
- ✅ 显示更加专业

**申请单列表增加申请金额列完成！用户现在可以直观地查看每笔申请单的最高金额。** 🎯
