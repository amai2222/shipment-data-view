# 🧾 开票申请完整流程详解

## 📋 目录
- [正向流程](#正向流程)
- [逆向流程（取消和作废）](#逆向流程取消和作废)
- [状态流转图](#状态流转图)
- [功能矩阵](#功能矩阵)
- [与付款流程对照](#与付款流程对照)

---

## 🎯 正向流程

### 步骤1：创建开票申请

**操作页面**：`合作方开票申请`（业务管理 → 合作方开票申请）

#### 前置条件
- ✅ 运单 `invoice_status` = `Uninvoiced`（未开票）
- ✅ 运单已有合作方成本数据
- ✅ 合作方成本 `invoice_status` = `Uninvoiced`

#### 操作步骤
1. 在运单列表中筛选未开票的运单
2. 勾选需要开票的运单（支持跨页批量选择）
3. 点击顶部"开票申请"按钮（绿色）
4. 确认申请

#### 系统执行
**RPC函数**：`save_invoice_request`

```sql
-- 1. 创建开票申请单
INSERT INTO invoice_requests (
    request_number,      -- 自动生成：INVOICE-XXXXXX
    status,              -- Pending（待审核）
    partner_id,          -- 开票合作方ID
    total_amount,        -- 开票总金额
    record_count,        -- 运单数量
    remarks              -- 备注
) VALUES (...);

-- 2. 创建开票申请明细
INSERT INTO invoice_request_details (
    invoice_request_id,
    logistics_record_id,
    amount
) VALUES (...);

-- 3. 更新运单状态
UPDATE logistics_records
SET invoice_status = 'Processing'  -- 已申请开票
WHERE id = ANY(p_record_ids);

-- 4. 更新合作方成本状态
UPDATE logistics_partner_costs
SET 
    invoice_status = 'Processing',
    invoice_request_id = v_request_id,
    invoice_applied_at = NOW()
WHERE logistics_record_id = ANY(p_record_ids);
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | invoice_status | `Uninvoiced` | `Processing` |
| **运单显示** | - | 未开票 | **已申请开票**（灰色徽章） |
| **申请单** | status | - | `Pending` |
| **申请单显示** | - | - | **待审核**（灰色徽章） |
| **合作方成本** | invoice_status | `Uninvoiced` | `Processing` |

---

### 步骤2：审批开票申请

**操作页面**：`开票审核`（审核管理 → 开票审核）

#### 前置条件
- ✅ 申请单 `status` = `Pending`（待审核）
- ✅ 用户具有审批权限（财务/管理员）

#### 操作步骤
1. 进入开票审核页面（默认筛选待审核状态）
2. 查看申请单详情（点击申请单编号）
3. 点击"审批"按钮（绿色）或"批量审批"
4. 确认审批

#### 系统执行
**RPC函数**：`approve_invoice_request_v2`（单个）/ `batch_approve_invoice_requests`（批量）

```sql
-- 1. 更新申请单状态
UPDATE invoice_requests
SET 
    status = 'Approved',  -- 已审批待开票
    approved_by = auth.uid(),
    approved_at = NOW(),
    updated_at = NOW()
WHERE request_number = p_request_number;

-- 2. 更新运单状态
UPDATE logistics_records
SET invoice_status = 'Approved'  -- 开票审核通过 ← 新增状态
WHERE id = ANY(v_record_ids)
  AND invoice_status = 'Processing';

-- 3. 更新合作方成本状态
UPDATE logistics_partner_costs
SET invoice_status = 'Approved'
WHERE invoice_request_id = v_request_id
  AND invoice_status = 'Processing';
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | invoice_status | `Processing` | `Approved` |
| **运单显示** | - | 已申请开票 | **开票审核通过**（绿色边框徽章） |
| **申请单** | status | `Pending` | `Approved` |
| **申请单显示** | - | 待审核 | **已审批待开票**（蓝色徽章） |
| **合作方成本** | invoice_status | `Processing` | `Approved` |

#### 界面变化
- **开票审核页面**：申请单排序移至"已审批待开票"分区
- **财务开票页面**：申请单出现在列表中，显示"开票"按钮

---

### 步骤3：执行开票

**操作页面**：`财务开票`（财务管理 → 财务开票）

#### 前置条件
- ✅ 申请单 `status` = `Approved`（已审批待开票）
- ✅ 用户具有开票权限（财务/管理员）

#### 操作步骤
1. 进入财务开票页面（默认筛选已审批待开票状态）
2. 查看申请单和运单详情
3. 点击"开票"按钮（绿色）或"批量开票"
4. 确认开票

#### 系统执行
**RPC函数**：`complete_invoice_request_v2`（单个）/ `batch_complete_invoice_requests`（批量）

```sql
-- 1. 更新申请单状态
UPDATE invoice_requests
SET 
    status = 'Completed',  -- 已开票
    invoice_number = p_invoice_number,
    invoice_date = COALESCE(p_invoice_date, CURRENT_DATE),
    updated_at = NOW()
WHERE request_number = p_request_number;

-- 2. 更新运单状态
UPDATE logistics_records
SET 
    invoice_status = 'Invoiced',  -- 已开票
    invoice_completed_at = NOW()
WHERE id = ANY(v_record_ids)
  AND invoice_status = 'Approved';

-- 3. 更新合作方成本状态
UPDATE logistics_partner_costs
SET 
    invoice_status = 'Invoiced',
    invoice_number = p_invoice_number,
    invoice_completed_at = NOW()
WHERE invoice_request_id = v_request_id
  AND invoice_status = 'Approved';
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | invoice_status | `Approved` | `Invoiced` |
| **运单** | invoice_completed_at | NULL | 当前时间 |
| **运单显示** | - | 开票审核通过 | **已开票**（绿底白字徽章） |
| **申请单** | status | `Approved` | `Completed` |
| **申请单** | invoice_number | NULL | 发票号码 |
| **申请单显示** | - | 已审批待开票 | **已开票**（绿底白字徽章） |
| **合作方成本** | invoice_status | `Approved` | `Invoiced` |
| **合作方成本** | invoice_completed_at | NULL | 当前时间 |

---

## 🔄 逆向流程（取消和作废）

### 操作A：取消审批（审批回滚）

**操作页面**：`开票审核`

#### 适用场景
- 已审批但**尚未开票**的申请单需要重新审核
- 审批有误需要退回待审核状态

#### 前置条件
- ✅ 申请单 `status` = `Approved`（已审批待开票）
- ✅ 用户具有审批权限（财务/管理员）

#### 操作步骤
1. 进入开票审核页面
2. 勾选已审批待开票的申请单
3. 点击"批量取消审批"按钮（橙色）
4. 确认取消

#### 系统执行
**RPC函数**：`batch_rollback_invoice_approval`

```sql
-- 1. 更新申请单状态（回退到待审核）
UPDATE invoice_requests
SET 
    status = 'Pending',
    updated_at = NOW()
WHERE request_number = ANY(p_request_numbers)
  AND status = 'Approved';

-- 2. 更新运单状态（回退到已申请开票）
UPDATE logistics_records
SET invoice_status = 'Processing'
WHERE id IN (
    SELECT UNNEST(logistics_record_ids)
    FROM invoice_requests
    WHERE request_number = ANY(p_request_numbers)
);

-- 3. 更新合作方成本状态
UPDATE logistics_partner_costs
SET invoice_status = 'Processing'
WHERE invoice_request_id IN (
    SELECT id FROM invoice_requests
    WHERE request_number = ANY(p_request_numbers)
);
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | invoice_status | `Approved` | `Processing` |
| **运单显示** | - | 开票审核通过 | **已申请开票** |
| **申请单** | status | `Approved` | `Pending` |
| **申请单显示** | - | 已审批待开票 | **待审核** |

---

### 操作B：取消开票（开票回滚）

**操作页面**：`财务开票`

#### 适用场景
- 开票错误需要撤销
- 需要重新开票

#### 前置条件
- ✅ 申请单 `status` = `Completed`（已开票）
- ✅ 用户具有财务权限（财务/管理员）

#### 操作步骤
1. 进入财务开票页面
2. 筛选或查找已开票的申请单
3. 勾选需要取消开票的申请单
4. 点击"批量取消开票"按钮（橙色）
5. 确认取消

#### 系统执行
**RPC函数**：`cancel_invoice_request`（通过批量取消调用）

```sql
-- 1. 更新申请单状态（回退到已审批待开票）
UPDATE invoice_requests
SET 
    status = 'Approved',
    updated_at = NOW(),
    remarks = remarks || ' [开票已取消]'
WHERE request_number = p_request_number
  AND status = 'Completed';

-- 2. 更新运单状态（回退到开票审核通过）
UPDATE logistics_records
SET 
    invoice_status = 'Approved',
    invoice_completed_at = NULL
WHERE id = ANY(v_record_ids)
  AND invoice_status = 'Invoiced';

-- 3. 更新合作方成本状态
UPDATE logistics_partner_costs
SET 
    invoice_status = 'Approved',
    invoice_completed_at = NULL
WHERE invoice_request_id = v_request_id
  AND invoice_status = 'Invoiced';
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | invoice_status | `Invoiced` | `Approved` |
| **运单** | invoice_completed_at | 时间戳 | NULL |
| **运单显示** | - | 已开票 | **开票审核通过** |
| **申请单** | status | `Completed` | `Approved` |
| **申请单** | remarks | 原备注 | 原备注 + [开票已取消] |
| **申请单显示** | - | 已开票 | **已审批待开票** |

---

### 操作C：作废申请单（永久删除）

**操作页面**：`财务开票` / `开票审核`

#### 适用场景
- 错误生成的申请单需要删除
- 不再需要的开票申请

#### 前置条件
- ✅ 申请单 `status` = `Pending`（待审核）或 `Approved`（已审批待开票）
- ❌ **已开票**的申请单**不能**直接作废（需先取消开票）
- ✅ 用户具有管理员权限

#### 操作步骤
1. 进入财务开票页面或开票审核页面
2. 勾选需要作废的申请单
3. 点击"一键作废"按钮（红色）
4. 阅读警告信息
5. 确认作废

#### 系统执行
**RPC函数**：`void_and_delete_invoice_requests`

```sql
-- 1. 回滚运单状态到未开票
UPDATE logistics_records
SET 
    invoice_status = 'Uninvoiced',
    invoice_completed_at = NULL
WHERE id IN (
    SELECT logistics_record_id
    FROM invoice_request_details
    WHERE invoice_request_id IN (
        SELECT id FROM invoice_requests
        WHERE request_number = ANY(p_request_numbers)
          AND status IN ('Pending', 'Approved')
    )
);

-- 2. 回滚合作方成本状态
UPDATE logistics_partner_costs
SET 
    invoice_status = 'Uninvoiced',
    invoice_request_id = NULL,
    invoice_applied_at = NULL,
    invoice_completed_at = NULL
WHERE invoice_request_id IN (
    SELECT id FROM invoice_requests
    WHERE request_number = ANY(p_request_numbers)
);

-- 3. 删除开票申请明细
DELETE FROM invoice_request_details
WHERE invoice_request_id IN (
    SELECT id FROM invoice_requests
    WHERE request_number = ANY(p_request_numbers)
);

-- 4. 永久删除申请单记录
DELETE FROM invoice_requests
WHERE request_number = ANY(p_request_numbers)
  AND status IN ('Pending', 'Approved');
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | invoice_status | `Processing` 或 `Approved` | `Uninvoiced` |
| **运单显示** | - | 已申请开票/开票审核通过 | **未开票** |
| **申请单** | - | 存在 | **永久删除** |
| **合作方成本** | invoice_status | `Processing` 或 `Approved` | `Uninvoiced` |
| **合作方成本** | invoice_request_id | 申请单ID | NULL |

---

## 📊 状态流转图

### 完整状态流转

```
┌─────────────────────────────────────────────────────────────┐
│                        运单状态流转                          │
└─────────────────────────────────────────────────────────────┘

┌──────────┐  步骤1：创建开票申请  ┌──────────┐
│Uninvoiced│ ──────────────────→ │Processing│
│  未开票  │                      │已申请开票 │
└──────────┘                      └─────┬────┘
                                        │
                           步骤2：审批开票申请
                                        │
                                        ↓
                                  ┌──────────┐
                                  │ Approved │
                                  │开票审核  │ ← 新增状态
                                  │  通过    │
                                  └─────┬────┘
                                        │
                           步骤3：执行开票
                                        │
                                        ↓
                                  ┌──────────┐
                                  │ Invoiced │
                                  │  已开票  │
                                  └──────────┘

┌─────────────────────────────────────────────────────────────┐
│                      申请单状态流转                          │
└─────────────────────────────────────────────────────────────┘

┌──────────┐  步骤1：创建开票申请  ┌──────────┐
│   创建    │ ──────────────────→ │ Pending  │
│          │                      │  待审核  │
└──────────┘                      └─────┬────┘
                                        │
                           步骤2：审批开票申请
                                        │
                                        ↓
                                  ┌──────────┐
                                  │ Approved │
                                  │已审批待  │
                                  │  开票    │
                                  └─────┬────┘
                                        │
                           步骤3：执行开票
                                        │
                                        ↓
                                  ┌──────────┐
                                  │Completed │
                                  │  已开票  │
                                  └──────────┘
```

### 逆向操作流转

```
操作A：取消审批（回滚）
┌──────────┐
│ Pending  │
│  待审核  │
└─────┬────┘
      │
      │ 审批
    ↓↑ 取消审批
      │
┌──────────┐
│ Approved │
│已审批待  │
│  开票    │
└─────┬────┘
      │
      │ 开票
    ↓↑ 取消开票
      │
┌──────────┐
│Completed │
│  已开票  │
└──────────┘

操作B：一键作废（永久删除）
┌──────────┐                    ┌──────────┐
│ Pending/ │ ──作废删除──→    │Uninvoiced│
│ Approved │                    │  未开票  │
└──────────┘                    └──────────┘
                                 (运单状态)
```

---

## 📋 功能矩阵

### 操作权限矩阵

| 操作 | 页面 | 所需权限 | 按钮颜色 |
|------|------|----------|----------|
| 创建开票申请 | 合作方开票申请 | 财务/管理员 | 🟢 绿色 |
| 审批开票 | 开票审核 | 财务/管理员 | 🟢 绿色 |
| 批量审批 | 开票审核 | 财务/管理员 | 🟢 绿色 |
| 执行开票 | 财务开票 | 财务/管理员 | 🟢 绿色 |
| 批量开票 | 财务开票 | 财务/管理员 | 🟢 绿色 |
| 取消审批 | 开票审核 | 财务/管理员 | 🟠 橙色 |
| 批量取消审批 | 开票审核 | 财务/管理员 | 🟠 橙色 |
| 取消开票 | 财务开票 | 财务/管理员 | 🟠 橙色 |
| 批量取消开票 | 财务开票 | 财务/管理员 | 🟠 橙色 |
| 一键作废 | 财务开票/开票审核 | **仅管理员** | 🔴 红色 |

### 状态可操作矩阵

| 申请单状态 | 可执行操作 |
|-----------|-----------|
| `Pending`（待审核） | ✅ 审批<br>✅ 一键作废 |
| `Approved`（已审批待开票） | ✅ 开票<br>✅ 取消审批<br>✅ 一键作废 |
| `Completed`（已开票） | ✅ 取消开票 |

---

## 🔍 与付款流程对照

### 状态名称对照

| 流程 | 步骤1 | 步骤2 | 步骤3 | 最终状态 |
|------|-------|-------|-------|----------|
| **付款** | 已申请支付 | 支付审核通过 | 已支付 | Paid |
| **开票** | 已申请开票 | 开票审核通过 | 已开票 | Invoiced |
| **申请单** | 待审核 | 已审批待XX | 已XX | Completed/Paid |

### 数据库状态对照

#### 运单状态（logistics_records）
| 付款字段 | 付款状态值 | 开票字段 | 开票状态值 |
|---------|-----------|---------|-----------|
| payment_status | Unpaid | invoice_status | Uninvoiced |
| payment_status | Processing | invoice_status | Processing |
| payment_status | **Approved** ⭐ | invoice_status | **Approved** ⭐ |
| payment_status | Paid | invoice_status | Invoiced |

#### 申请单状态（payment_requests / invoice_requests）
| 付款申请单 | 开票申请单 | 中文显示 |
|-----------|-----------|---------|
| Pending | Pending | 待审核 |
| Approved | Approved | 已审批待支付/开票 |
| Paid | Completed | 已支付/已开票 |
| Rejected | Rejected | 已驳回 |
| Cancelled | Voided | 已作废 |

### RPC函数对照

| 功能 | 付款RPC | 开票RPC |
|------|--------|--------|
| 单个审批 | approve_payment_request | approve_invoice_request_v2 |
| 批量审批 | batch_approve_payment_requests | batch_approve_invoice_requests |
| 单个执行 | pay_payment_request | complete_invoice_request_v2 |
| 批量执行 | batch_pay_payment_requests | batch_complete_invoice_requests |
| 取消执行 | cancel_payment_request | cancel_invoice_request |
| 批量取消 | batch_cancel_payment_requests | batch_cancel_invoice_requests |
| 取消审批 | batch_rollback_payment_approval | batch_rollback_invoice_approval |
| 作废删除 | void_and_delete_payment_requests | void_and_delete_invoice_requests |

---

## 🔧 SQL迁移文件

**文件名**：`supabase/migrations/20251031_complete_invoice_workflow_optimization.sql`

**主要内容**：
1. ✅ approve_invoice_request_v2 - 审批时同步更新运单状态
2. ✅ batch_approve_invoice_requests - 批量审批
3. ✅ complete_invoice_request_v2 - 开票时使用Completed状态
4. ✅ batch_complete_invoice_requests - 批量开票
5. ✅ cancel_invoice_request - 取消开票
6. ✅ batch_cancel_invoice_requests - 批量取消开票
7. ✅ 添加invoice_status的Approved状态约束

---

## 🎯 关键改进点

### 1. 新增Approved中间状态
```
旧流程：Uninvoiced -> Processing -> Invoiced（缺失审批通过状态）
新流程：Uninvoiced -> Processing -> Approved -> Invoiced（完整）
```

### 2. 状态名称标准化
```
旧名称：已审批（Approved）
新名称：已审批待开票（Approved）- 更准确

旧状态：Invoiced
新状态：Completed（申请单）/ Invoiced（运单）- 更清晰
```

### 3. RPC函数改进
- ✅ 审批和开票操作**原子性**更新申请单和运单
- ✅ 批量操作支持**部分失败**继续执行
- ✅ 详细的错误信息和成功计数

---

## 💡 使用建议

### 部署顺序
```
1. 执行SQL迁移文件
   supabase/migrations/20251031_complete_invoice_workflow_optimization.sql
   
2. 前端代码已自动更新
   - InvoiceAudit.tsx
   - InvoiceRequestManagement.tsx
   
3. 清除浏览器缓存，刷新页面

4. 测试完整流程
```

### 测试检查表
- [ ] 创建开票申请 → 运单状态变为Processing
- [ ] 审批开票申请 → 运单状态变为Approved
- [ ] 执行开票 → 运单状态变为Invoiced，申请单状态为Completed
- [ ] 取消审批 → 运单回退到Processing
- [ ] 取消开票 → 运单回退到Approved
- [ ] 一键作废 → 运单回退到Uninvoiced，申请单删除

---

## ⚠️ 注意事项

1. **状态约束更新**
   - 数据库约束已更新，支持Approved状态
   - 旧数据不受影响

2. **向后兼容**
   - 保留旧函数作为备份
   - 新函数使用_v2后缀

3. **权限控制**
   - 一键作废仅管理员可用
   - 其他操作财务和管理员都可以

4. **数据一致性**
   - 所有状态更新都在事务中执行
   - 失败自动回滚

---

**文档维护者**：系统管理员  
**最后更新**：2025-10-31  
**版本**：v2.0（与付款流程对齐）

