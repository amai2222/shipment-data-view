# 付款审核页面项目筛选功能完成

## 🎯 **功能概述**
为付款审核页面的筛选器添加了项目筛选功能，用户可以根据项目来筛选付款申请单。

## ✅ **实现的功能**

### **1. 项目筛选器**
- **位置**：筛选器面板中，位于状态筛选器之后
- **图标**：使用Building图标
- **功能**：下拉选择项目进行筛选
- **加载状态**：显示"加载中..."提示

### **2. 数据获取**
- **项目列表**：从`projects`表获取所有项目
- **排序**：按项目名称升序排列
- **加载状态**：独立的加载状态管理

### **3. 筛选逻辑**
- **参数传递**：将项目ID传递给后端RPC函数
- **清除功能**：包含在清除筛选条件中
- **状态检测**：包含在活跃筛选条件检测中

## 🔧 **技术实现**

### **状态管理**
```typescript
// 筛选器状态扩展
const [filters, setFilters] = useState({
  requestId: '',
  waybillNumber: '',
  driverName: '',
  loadingDate: null as Date | null,
  status: '',
  projectId: ''  // 新增项目筛选
});

// 项目列表状态
const [projects, setProjects] = useState<Array<{id: string, name: string}>>([]);
const [loadingProjects, setLoadingProjects] = useState(false);
```

### **数据获取函数**
```typescript
// 获取项目列表
const fetchProjects = useCallback(async () => {
  setLoadingProjects(true);
  try {
    const { data, error } = await supabase
      .from('projects')
      .select('id, name')
      .order('name', { ascending: true });

    if (error) throw error;
    setProjects(data || []);
  } catch (error) {
    console.error('获取项目列表失败:', error);
    toast({ title: "错误", description: "获取项目列表失败", variant: "destructive" });
  } finally {
    setLoadingProjects(false);
  }
}, [toast]);
```

### **RPC函数调用**
```typescript
// 后端筛选函数调用
const { data, error } = await supabase.rpc('get_payment_requests_filtered', {
  p_request_id: filters.requestId || null,
  p_waybill_number: filters.waybillNumber || null,
  p_driver_name: filters.driverName || null,
  p_loading_date: filters.loadingDate ? format(filters.loadingDate, 'yyyy-MM-dd') : null,
  p_status: filters.status || null,
  p_project_id: filters.projectId || null,  // 新增项目参数
  p_limit: pageSize,
  p_offset: (currentPage - 1) * pageSize
});
```

### **UI组件**
```typescript
{/* 项目筛选 */}
<div className="space-y-2">
  <Label htmlFor="projectId" className="flex items-center gap-2">
    <Building className="h-4 w-4" />
    项目
  </Label>
  <select
    id="projectId"
    value={filters.projectId}
    onChange={(e) => handleFilterChange('projectId', e.target.value)}
    disabled={loadingProjects}
    className="w-full px-3 py-2 border border-input bg-background rounded-md text-sm disabled:opacity-50"
  >
    <option value="">{loadingProjects ? "加载中..." : "全部项目"}</option>
    {projects.map((project) => (
      <option key={project.id} value={project.id}>
        {project.name}
      </option>
    ))}
  </select>
</div>
```

## 📋 **功能特性**

### **1. 用户体验**
- ✅ **直观选择**：下拉列表显示所有可用项目
- ✅ **加载提示**：项目加载时显示"加载中..."状态
- ✅ **禁用状态**：加载期间禁用选择器
- ✅ **图标标识**：使用Building图标清晰标识项目筛选

### **2. 数据管理**
- ✅ **自动加载**：页面加载时自动获取项目列表
- ✅ **错误处理**：获取项目失败时显示错误提示
- ✅ **排序显示**：项目按名称排序，便于查找

### **3. 筛选集成**
- ✅ **参数传递**：项目ID正确传递给后端RPC函数
- ✅ **清除功能**：清除筛选时包含项目筛选
- ✅ **状态检测**：活跃筛选条件检测包含项目筛选

## 🎉 **完成状态**

### **前端实现**
- ✅ **状态管理**：添加项目筛选状态和项目列表状态
- ✅ **数据获取**：实现项目列表获取函数
- ✅ **UI组件**：添加项目筛选下拉选择器
- ✅ **图标导入**：导入Building图标
- ✅ **筛选集成**：集成到现有筛选逻辑中

### **后端支持**
- ✅ **RPC函数**：`get_payment_requests_filtered`函数支持`p_project_id`参数
- ✅ **数据库查询**：后端函数能够根据项目ID筛选付款申请

### **用户体验**
- ✅ **直观操作**：用户可以通过下拉选择器选择项目
- ✅ **实时筛选**：选择项目后立即应用筛选条件
- ✅ **状态反馈**：加载状态和错误处理完善

**付款审核页面的项目筛选功能已成功实现，用户现在可以根据项目来筛选付款申请单！** 🚀
