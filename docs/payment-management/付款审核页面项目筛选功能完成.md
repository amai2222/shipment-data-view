# ä»˜æ¬¾å®¡æ ¸é¡µé¢é¡¹ç›®ç­›é€‰åŠŸèƒ½å®Œæˆ

## ğŸ¯ **åŠŸèƒ½æ¦‚è¿°**
ä¸ºä»˜æ¬¾å®¡æ ¸é¡µé¢çš„ç­›é€‰å™¨æ·»åŠ äº†é¡¹ç›®ç­›é€‰åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®é¡¹ç›®æ¥ç­›é€‰ä»˜æ¬¾ç”³è¯·å•ã€‚

## âœ… **å®ç°çš„åŠŸèƒ½**

### **1. é¡¹ç›®ç­›é€‰å™¨**
- **ä½ç½®**ï¼šç­›é€‰å™¨é¢æ¿ä¸­ï¼Œä½äºçŠ¶æ€ç­›é€‰å™¨ä¹‹å
- **å›¾æ ‡**ï¼šä½¿ç”¨Buildingå›¾æ ‡
- **åŠŸèƒ½**ï¼šä¸‹æ‹‰é€‰æ‹©é¡¹ç›®è¿›è¡Œç­›é€‰
- **åŠ è½½çŠ¶æ€**ï¼šæ˜¾ç¤º"åŠ è½½ä¸­..."æç¤º

### **2. æ•°æ®è·å–**
- **é¡¹ç›®åˆ—è¡¨**ï¼šä»`projects`è¡¨è·å–æ‰€æœ‰é¡¹ç›®
- **æ’åº**ï¼šæŒ‰é¡¹ç›®åç§°å‡åºæ’åˆ—
- **åŠ è½½çŠ¶æ€**ï¼šç‹¬ç«‹çš„åŠ è½½çŠ¶æ€ç®¡ç†

### **3. ç­›é€‰é€»è¾‘**
- **å‚æ•°ä¼ é€’**ï¼šå°†é¡¹ç›®IDä¼ é€’ç»™åç«¯RPCå‡½æ•°
- **æ¸…é™¤åŠŸèƒ½**ï¼šåŒ…å«åœ¨æ¸…é™¤ç­›é€‰æ¡ä»¶ä¸­
- **çŠ¶æ€æ£€æµ‹**ï¼šåŒ…å«åœ¨æ´»è·ƒç­›é€‰æ¡ä»¶æ£€æµ‹ä¸­

## ğŸ”§ **æŠ€æœ¯å®ç°**

### **çŠ¶æ€ç®¡ç†**
```typescript
// ç­›é€‰å™¨çŠ¶æ€æ‰©å±•
const [filters, setFilters] = useState({
  requestId: '',
  waybillNumber: '',
  driverName: '',
  loadingDate: null as Date | null,
  status: '',
  projectId: ''  // æ–°å¢é¡¹ç›®ç­›é€‰
});

// é¡¹ç›®åˆ—è¡¨çŠ¶æ€
const [projects, setProjects] = useState<Array<{id: string, name: string}>>([]);
const [loadingProjects, setLoadingProjects] = useState(false);
```

### **æ•°æ®è·å–å‡½æ•°**
```typescript
// è·å–é¡¹ç›®åˆ—è¡¨
const fetchProjects = useCallback(async () => {
  setLoadingProjects(true);
  try {
    const { data, error } = await supabase
      .from('projects')
      .select('id, name')
      .order('name', { ascending: true });

    if (error) throw error;
    setProjects(data || []);
  } catch (error) {
    console.error('è·å–é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
    toast({ title: "é”™è¯¯", description: "è·å–é¡¹ç›®åˆ—è¡¨å¤±è´¥", variant: "destructive" });
  } finally {
    setLoadingProjects(false);
  }
}, [toast]);
```

### **RPCå‡½æ•°è°ƒç”¨**
```typescript
// åç«¯ç­›é€‰å‡½æ•°è°ƒç”¨
const { data, error } = await supabase.rpc('get_payment_requests_filtered', {
  p_request_id: filters.requestId || null,
  p_waybill_number: filters.waybillNumber || null,
  p_driver_name: filters.driverName || null,
  p_loading_date: filters.loadingDate ? format(filters.loadingDate, 'yyyy-MM-dd') : null,
  p_status: filters.status || null,
  p_project_id: filters.projectId || null,  // æ–°å¢é¡¹ç›®å‚æ•°
  p_limit: pageSize,
  p_offset: (currentPage - 1) * pageSize
});
```

### **UIç»„ä»¶**
```typescript
{/* é¡¹ç›®ç­›é€‰ */}
<div className="space-y-2">
  <Label htmlFor="projectId" className="flex items-center gap-2">
    <Building className="h-4 w-4" />
    é¡¹ç›®
  </Label>
  <select
    id="projectId"
    value={filters.projectId}
    onChange={(e) => handleFilterChange('projectId', e.target.value)}
    disabled={loadingProjects}
    className="w-full px-3 py-2 border border-input bg-background rounded-md text-sm disabled:opacity-50"
  >
    <option value="">{loadingProjects ? "åŠ è½½ä¸­..." : "å…¨éƒ¨é¡¹ç›®"}</option>
    {projects.map((project) => (
      <option key={project.id} value={project.id}>
        {project.name}
      </option>
    ))}
  </select>
</div>
```

## ğŸ“‹ **åŠŸèƒ½ç‰¹æ€§**

### **1. ç”¨æˆ·ä½“éªŒ**
- âœ… **ç›´è§‚é€‰æ‹©**ï¼šä¸‹æ‹‰åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨é¡¹ç›®
- âœ… **åŠ è½½æç¤º**ï¼šé¡¹ç›®åŠ è½½æ—¶æ˜¾ç¤º"åŠ è½½ä¸­..."çŠ¶æ€
- âœ… **ç¦ç”¨çŠ¶æ€**ï¼šåŠ è½½æœŸé—´ç¦ç”¨é€‰æ‹©å™¨
- âœ… **å›¾æ ‡æ ‡è¯†**ï¼šä½¿ç”¨Buildingå›¾æ ‡æ¸…æ™°æ ‡è¯†é¡¹ç›®ç­›é€‰

### **2. æ•°æ®ç®¡ç†**
- âœ… **è‡ªåŠ¨åŠ è½½**ï¼šé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–é¡¹ç›®åˆ—è¡¨
- âœ… **é”™è¯¯å¤„ç†**ï¼šè·å–é¡¹ç›®å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯æç¤º
- âœ… **æ’åºæ˜¾ç¤º**ï¼šé¡¹ç›®æŒ‰åç§°æ’åºï¼Œä¾¿äºæŸ¥æ‰¾

### **3. ç­›é€‰é›†æˆ**
- âœ… **å‚æ•°ä¼ é€’**ï¼šé¡¹ç›®IDæ­£ç¡®ä¼ é€’ç»™åç«¯RPCå‡½æ•°
- âœ… **æ¸…é™¤åŠŸèƒ½**ï¼šæ¸…é™¤ç­›é€‰æ—¶åŒ…å«é¡¹ç›®ç­›é€‰
- âœ… **çŠ¶æ€æ£€æµ‹**ï¼šæ´»è·ƒç­›é€‰æ¡ä»¶æ£€æµ‹åŒ…å«é¡¹ç›®ç­›é€‰

## ğŸ‰ **å®ŒæˆçŠ¶æ€**

### **å‰ç«¯å®ç°**
- âœ… **çŠ¶æ€ç®¡ç†**ï¼šæ·»åŠ é¡¹ç›®ç­›é€‰çŠ¶æ€å’Œé¡¹ç›®åˆ—è¡¨çŠ¶æ€
- âœ… **æ•°æ®è·å–**ï¼šå®ç°é¡¹ç›®åˆ—è¡¨è·å–å‡½æ•°
- âœ… **UIç»„ä»¶**ï¼šæ·»åŠ é¡¹ç›®ç­›é€‰ä¸‹æ‹‰é€‰æ‹©å™¨
- âœ… **å›¾æ ‡å¯¼å…¥**ï¼šå¯¼å…¥Buildingå›¾æ ‡
- âœ… **ç­›é€‰é›†æˆ**ï¼šé›†æˆåˆ°ç°æœ‰ç­›é€‰é€»è¾‘ä¸­

### **åç«¯æ”¯æŒ**
- âœ… **RPCå‡½æ•°**ï¼š`get_payment_requests_filtered`å‡½æ•°æ”¯æŒ`p_project_id`å‚æ•°
- âœ… **æ•°æ®åº“æŸ¥è¯¢**ï¼šåç«¯å‡½æ•°èƒ½å¤Ÿæ ¹æ®é¡¹ç›®IDç­›é€‰ä»˜æ¬¾ç”³è¯·

### **ç”¨æˆ·ä½“éªŒ**
- âœ… **ç›´è§‚æ“ä½œ**ï¼šç”¨æˆ·å¯ä»¥é€šè¿‡ä¸‹æ‹‰é€‰æ‹©å™¨é€‰æ‹©é¡¹ç›®
- âœ… **å®æ—¶ç­›é€‰**ï¼šé€‰æ‹©é¡¹ç›®åç«‹å³åº”ç”¨ç­›é€‰æ¡ä»¶
- âœ… **çŠ¶æ€åé¦ˆ**ï¼šåŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†å®Œå–„

**ä»˜æ¬¾å®¡æ ¸é¡µé¢çš„é¡¹ç›®ç­›é€‰åŠŸèƒ½å·²æˆåŠŸå®ç°ï¼Œç”¨æˆ·ç°åœ¨å¯ä»¥æ ¹æ®é¡¹ç›®æ¥ç­›é€‰ä»˜æ¬¾ç”³è¯·å•ï¼** ğŸš€
