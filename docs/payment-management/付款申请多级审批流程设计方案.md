# ä»˜æ¬¾ç”³è¯·å¤šçº§å®¡æ‰¹æµç¨‹è®¾è®¡æ–¹æ¡ˆ

## ğŸ¯ **éœ€æ±‚åˆ†æ**

### **å®¡æ‰¹æµç¨‹éœ€æ±‚**
- 6ä¸ªå®¡æ‰¹ç¯èŠ‚ï¼šä¿¡æ¯ä¸“å‘˜ç­¾å­—ã€ä¿¡æ¯éƒ¨å®¡æ ¸ç­¾å­—ã€ä¸šåŠ¡è´Ÿè´£äººç­¾å­—ã€ä¸šåŠ¡ç»ç†ç­¾å­—ã€å¤æ ¸å®¡æ‰¹äººç­¾å­—ã€è´¢åŠ¡éƒ¨å®¡æ ¸ç­¾å­—
- äººå‘˜é…ç½®ï¼šæ²ˆæœ±å³°å¯¹åº”ä¿¡æ¯éƒ¨å®¡æ ¸ï¼Œåˆ˜ä¼šå¯¹åº”è´¢åŠ¡å®¡æ ¸ç­‰
- æµç¨‹æ§åˆ¶ï¼šæ‰€æœ‰äººå‘˜éƒ½å®Œæˆå®¡æ ¸åæ‰èƒ½ç‚¹å‡»ä»˜æ¬¾
- çŠ¶æ€ç®¡ç†ï¼šå®æ—¶æ˜¾ç¤ºæ¯ä¸ªç¯èŠ‚çš„å®¡æ‰¹çŠ¶æ€

## ğŸ—ï¸ **æ•°æ®åº“è®¾è®¡**

### **1. å®¡æ‰¹æµç¨‹é…ç½®è¡¨**
```sql
CREATE TABLE public.approval_workflows (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- å®¡æ‰¹ç¯èŠ‚é…ç½®è¡¨
CREATE TABLE public.approval_steps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workflow_id UUID REFERENCES public.approval_workflows(id) ON DELETE CASCADE,
    step_order INTEGER NOT NULL,
    step_name TEXT NOT NULL,
    step_description TEXT,
    required_role TEXT, -- å¯é€‰ï¼šè§’è‰²è¦æ±‚
    is_required BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- å®¡æ‰¹äººå‘˜é…ç½®è¡¨
CREATE TABLE public.approval_assignments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    step_id UUID REFERENCES public.approval_steps(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    user_name TEXT NOT NULL,
    is_primary BOOLEAN DEFAULT TRUE, -- ä¸»è¦å®¡æ‰¹äºº
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### **2. å®¡æ‰¹è®°å½•è¡¨**
```sql
-- ä»˜æ¬¾ç”³è¯·å®¡æ‰¹è®°å½•è¡¨
CREATE TABLE public.payment_approval_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    payment_request_id UUID REFERENCES public.payment_requests(id) ON DELETE CASCADE,
    step_id UUID REFERENCES public.approval_steps(id),
    approver_id UUID REFERENCES auth.users(id),
    approver_name TEXT NOT NULL,
    approval_status TEXT NOT NULL CHECK (approval_status IN ('pending', 'approved', 'rejected')),
    approval_comment TEXT,
    approved_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ·»åŠ å®¡æ‰¹çŠ¶æ€åˆ°ä»˜æ¬¾ç”³è¯·è¡¨
ALTER TABLE public.payment_requests 
ADD COLUMN approval_status TEXT DEFAULT 'pending' CHECK (approval_status IN ('pending', 'in_progress', 'approved', 'rejected')),
ADD COLUMN approval_workflow_id UUID REFERENCES public.approval_workflows(id);
```

## ğŸ”§ **åç«¯å‡½æ•°è®¾è®¡**

### **1. åˆ›å»ºå®¡æ‰¹æµç¨‹é…ç½®**
```sql
CREATE OR REPLACE FUNCTION public.create_payment_approval_workflow()
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_workflow_id UUID;
    v_step_ids UUID[];
    v_result JSONB;
BEGIN
    -- åˆ›å»ºå®¡æ‰¹æµç¨‹
    INSERT INTO public.approval_workflows (name, description)
    VALUES ('ä»˜æ¬¾ç”³è¯·å®¡æ‰¹æµç¨‹', 'æ ‡å‡†ä»˜æ¬¾ç”³è¯·å¤šçº§å®¡æ‰¹æµç¨‹')
    RETURNING id INTO v_workflow_id;
    
    -- åˆ›å»ºå®¡æ‰¹ç¯èŠ‚
    INSERT INTO public.approval_steps (workflow_id, step_order, step_name, step_description, required_role)
    VALUES 
        (v_workflow_id, 1, 'ä¿¡æ¯ä¸“å‘˜ç­¾å­—', 'ä¿¡æ¯ä¸“å‘˜ç¡®è®¤ä¿¡æ¯å‡†ç¡®æ€§', 'operator'),
        (v_workflow_id, 2, 'ä¿¡æ¯éƒ¨å®¡æ ¸ç­¾å­—', 'ä¿¡æ¯éƒ¨å®¡æ ¸ç­¾å­—', 'admin'),
        (v_workflow_id, 3, 'ä¸šåŠ¡è´Ÿè´£äººç­¾å­—', 'ä¸šåŠ¡è´Ÿè´£äººç¡®è®¤ä¸šåŠ¡åˆç†æ€§', 'business'),
        (v_workflow_id, 4, 'ä¸šåŠ¡ç»ç†ç­¾å­—', 'ä¸šåŠ¡ç»ç†å®¡æ‰¹', 'business'),
        (v_workflow_id, 5, 'å¤æ ¸å®¡æ‰¹äººç­¾å­—', 'å¤æ ¸å®¡æ‰¹äººæœ€ç»ˆç¡®è®¤', 'admin'),
        (v_workflow_id, 6, 'è´¢åŠ¡éƒ¨å®¡æ ¸ç­¾å­—', 'è´¢åŠ¡éƒ¨æœ€ç»ˆå®¡æ ¸', 'finance')
    RETURNING id INTO v_step_ids;
    
    -- é…ç½®å®¡æ‰¹äººå‘˜ï¼ˆç¤ºä¾‹ï¼‰
    INSERT INTO public.approval_assignments (step_id, user_id, user_name, is_primary)
    SELECT 
        s.id,
        u.id,
        u.raw_user_meta_data->>'full_name',
        TRUE
    FROM public.approval_steps s
    CROSS JOIN auth.users u
    WHERE s.workflow_id = v_workflow_id
    AND u.raw_user_meta_data->>'full_name' IN ('æ²ˆæœ±å³°', 'åˆ˜ä¼š', 'ä¸šåŠ¡è´Ÿè´£äºº', 'ä¸šåŠ¡ç»ç†', 'å¤æ ¸å®¡æ‰¹äºº', 'è´¢åŠ¡å®¡æ ¸äºº');
    
    v_result := jsonb_build_object(
        'success', true,
        'workflow_id', v_workflow_id,
        'message', 'å®¡æ‰¹æµç¨‹åˆ›å»ºæˆåŠŸ'
    );
    
    RETURN v_result;
END;
$$;
```

### **2. è·å–å®¡æ‰¹çŠ¶æ€**
```sql
CREATE OR REPLACE FUNCTION public.get_payment_approval_status(
    p_payment_request_id UUID
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_result JSONB;
    v_workflow_id UUID;
    v_steps JSONB;
BEGIN
    -- è·å–ä»˜æ¬¾ç”³è¯·çš„å®¡æ‰¹æµç¨‹ID
    SELECT approval_workflow_id INTO v_workflow_id
    FROM public.payment_requests
    WHERE id = p_payment_request_id;
    
    -- è·å–æ‰€æœ‰å®¡æ‰¹ç¯èŠ‚åŠå…¶çŠ¶æ€
    SELECT jsonb_agg(
        jsonb_build_object(
            'step_id', s.id,
            'step_order', s.step_order,
            'step_name', s.step_name,
            'step_description', s.step_description,
            'required_role', s.required_role,
            'is_required', s.is_required,
            'approval_status', COALESCE(par.approval_status, 'pending'),
            'approver_name', COALESCE(par.approver_name, ''),
            'approved_at', par.approved_at,
            'approval_comment', par.approval_comment,
            'can_approve', CASE 
                WHEN par.approval_status IS NULL THEN TRUE
                ELSE FALSE
            END
        ) ORDER BY s.step_order
    ) INTO v_steps
    FROM public.approval_steps s
    LEFT JOIN public.payment_approval_records par ON par.step_id = s.id 
        AND par.payment_request_id = p_payment_request_id
    WHERE s.workflow_id = v_workflow_id;
    
    -- æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿…éœ€ç¯èŠ‚éƒ½å·²å®Œæˆ
    SELECT jsonb_build_object(
        'workflow_id', v_workflow_id,
        'steps', v_steps,
        'all_approved', NOT EXISTS (
            SELECT 1 FROM public.approval_steps s
            LEFT JOIN public.payment_approval_records par ON par.step_id = s.id 
                AND par.payment_request_id = p_payment_request_id
            WHERE s.workflow_id = v_workflow_id 
            AND s.is_required = TRUE
            AND (par.approval_status IS NULL OR par.approval_status != 'approved')
        ),
        'can_pay', NOT EXISTS (
            SELECT 1 FROM public.approval_steps s
            LEFT JOIN public.payment_approval_records par ON par.step_id = s.id 
                AND par.payment_request_id = p_payment_request_id
            WHERE s.workflow_id = v_workflow_id 
            AND s.is_required = TRUE
            AND (par.approval_status IS NULL OR par.approval_status != 'approved')
        )
    ) INTO v_result;
    
    RETURN v_result;
END;
$$;
```

### **3. æäº¤å®¡æ‰¹**
```sql
CREATE OR REPLACE FUNCTION public.submit_payment_approval(
    p_payment_request_id UUID,
    p_step_id UUID,
    p_approval_status TEXT,
    p_approval_comment TEXT DEFAULT NULL
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_result JSONB;
    v_current_user_id UUID;
    v_current_user_name TEXT;
    v_workflow_id UUID;
    v_step_order INTEGER;
    v_previous_steps_completed BOOLEAN;
    v_assigned_approver TEXT;
    v_step_name TEXT;
BEGIN
    -- è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    v_current_user_id := auth.uid();
    SELECT raw_user_meta_data->>'full_name' INTO v_current_user_name
    FROM auth.users WHERE id = v_current_user_id;
    
    -- æ£€æŸ¥æƒé™
    IF NOT public.is_finance_operator_or_admin() THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šåªæœ‰è´¢åŠ¡ã€æ“ä½œå‘˜æˆ–ç®¡ç†å‘˜å¯ä»¥æäº¤å®¡æ‰¹';
    END IF;
    
    -- è·å–å½“å‰æ­¥éª¤ä¿¡æ¯å’Œåˆ†é…çš„å®¡æ‰¹äººå‘˜
    SELECT s.step_name, aa.user_name INTO v_step_name, v_assigned_approver
    FROM public.approval_steps s
    LEFT JOIN public.approval_assignments aa ON aa.step_id = s.id
    WHERE s.id = p_step_id AND aa.is_primary = TRUE;
    
    -- éªŒè¯å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºæŒ‡å®šçš„å®¡æ‰¹äººå‘˜
    IF v_assigned_approver IS NOT NULL AND v_current_user_name != v_assigned_approver THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šåªæœ‰æŒ‡å®šçš„å®¡æ‰¹äººå‘˜ "%" å¯ä»¥å®¡æ‰¹ "%" ç¯èŠ‚ï¼Œå½“å‰ç”¨æˆ·: "%"', 
            v_assigned_approver, v_step_name, v_current_user_name;
    END IF;
    
    -- è·å–å®¡æ‰¹æµç¨‹ID
    SELECT approval_workflow_id INTO v_workflow_id
    FROM public.payment_requests
    WHERE id = p_payment_request_id;
    
    -- è·å–å½“å‰æ­¥éª¤çš„åºå·
    SELECT step_order INTO v_step_order
    FROM public.approval_steps
    WHERE id = p_step_id;
    
    -- æ£€æŸ¥å‰ç½®æ­¥éª¤æ˜¯å¦éƒ½å·²å®Œæˆ
    SELECT NOT EXISTS (
        SELECT 1 FROM public.approval_steps s
        LEFT JOIN public.payment_approval_records par ON par.step_id = s.id 
            AND par.payment_request_id = p_payment_request_id
        WHERE s.workflow_id = v_workflow_id 
        AND s.step_order < v_step_order
        AND s.is_required = TRUE
        AND (par.approval_status IS NULL OR par.approval_status != 'approved')
    ) INTO v_previous_steps_completed;
    
    IF NOT v_previous_steps_completed THEN
        RAISE EXCEPTION 'å‰ç½®å®¡æ‰¹æ­¥éª¤æœªå®Œæˆï¼Œæ— æ³•æäº¤å½“å‰å®¡æ‰¹';
    END IF;
    
    -- æ’å…¥æˆ–æ›´æ–°å®¡æ‰¹è®°å½•
    INSERT INTO public.payment_approval_records (
        payment_request_id,
        step_id,
        approver_id,
        approver_name,
        approval_status,
        approval_comment,
        approved_at
    ) VALUES (
        p_payment_request_id,
        p_step_id,
        v_current_user_id,
        v_current_user_name,
        p_approval_status,
        p_approval_comment,
        CASE WHEN p_approval_status = 'approved' THEN NOW() ELSE NULL END
    )
    ON CONFLICT (payment_request_id, step_id) 
    DO UPDATE SET
        approver_id = EXCLUDED.approver_id,
        approver_name = EXCLUDED.approver_name,
        approval_status = EXCLUDED.approval_status,
        approval_comment = EXCLUDED.approval_comment,
        approved_at = EXCLUDED.approved_at,
        updated_at = NOW();
    
    -- æ›´æ–°ä»˜æ¬¾ç”³è¯·çŠ¶æ€
    UPDATE public.payment_requests
    SET 
        approval_status = CASE 
            WHEN p_approval_status = 'rejected' THEN 'rejected'
            WHEN EXISTS (
                SELECT 1 FROM public.approval_steps s
                LEFT JOIN public.payment_approval_records par ON par.step_id = s.id 
                    AND par.payment_request_id = p_payment_request_id
                WHERE s.workflow_id = v_workflow_id 
                AND s.is_required = TRUE
                AND (par.approval_status IS NULL OR par.approval_status != 'approved')
            ) THEN 'in_progress'
            ELSE 'approved'
        END,
        updated_at = NOW()
    WHERE id = p_payment_request_id;
    
    v_result := jsonb_build_object(
        'success', true,
        'message', 'å®¡æ‰¹æäº¤æˆåŠŸ',
        'approval_status', p_approval_status,
        'step_id', p_step_id
    );
    
    RETURN v_result;
END;
$$;
```

## ğŸ¨ **å‰ç«¯ç•Œé¢è®¾è®¡**

### **1. å®¡æ‰¹çŠ¶æ€æ˜¾ç¤ºç»„ä»¶**
```typescript
interface ApprovalStep {
  step_id: string;
  step_order: number;
  step_name: string;
  step_description: string;
  required_role: string;
  is_required: boolean;
  approval_status: 'pending' | 'approved' | 'rejected';
  approver_name: string;
  approved_at: string;
  approval_comment: string;
  can_approve: boolean;
}

interface ApprovalStatus {
  workflow_id: string;
  steps: ApprovalStep[];
  all_approved: boolean;
  can_pay: boolean;
}

const ApprovalStatusCard: React.FC<{ paymentRequestId: string }> = ({ paymentRequestId }) => {
  const [approvalStatus, setApprovalStatus] = useState<ApprovalStatus | null>(null);
  const [loading, setLoading] = useState(false);

  const fetchApprovalStatus = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase.rpc('get_payment_approval_status', {
        p_payment_request_id: paymentRequestId
      });
      if (error) throw error;
      setApprovalStatus(data);
    } catch (error) {
      console.error('è·å–å®¡æ‰¹çŠ¶æ€å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleApproval = async (stepId: string, status: 'approved' | 'rejected', comment?: string) => {
    try {
      const { data, error } = await supabase.rpc('submit_payment_approval', {
        p_payment_request_id: paymentRequestId,
        p_step_id: stepId,
        p_approval_status: status,
        p_approval_comment: comment
      });
      if (error) throw error;
      await fetchApprovalStatus();
      toast({ title: "å®¡æ‰¹æäº¤æˆåŠŸ", description: "å®¡æ‰¹çŠ¶æ€å·²æ›´æ–°" });
    } catch (error) {
      toast({ title: "å®¡æ‰¹æäº¤å¤±è´¥", description: "è¯·é‡è¯•", variant: "destructive" });
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <CheckCircle className="h-5 w-5" />
          å®¡æ‰¹æµç¨‹çŠ¶æ€
        </CardTitle>
      </CardHeader>
      <CardContent>
        {loading ? (
          <div className="flex justify-center py-4">
            <Loader2 className="h-6 w-6 animate-spin" />
          </div>
        ) : (
          <div className="space-y-3">
            {approvalStatus?.steps.map((step, index) => (
              <div key={step.step_id} className="flex items-center justify-between p-3 border rounded-lg">
                <div className="flex items-center gap-3">
                  <div className="flex items-center gap-2">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                      step.approval_status === 'approved' ? 'bg-green-100 text-green-800' :
                      step.approval_status === 'rejected' ? 'bg-red-100 text-red-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {step.step_order}
                    </div>
                    <div>
                      <div className="font-medium">{step.step_name}</div>
                      <div className="text-sm text-muted-foreground">{step.step_description}</div>
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  {step.approval_status === 'approved' && (
                    <Badge variant="default" className="bg-green-100 text-green-800">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      å·²é€šè¿‡
                    </Badge>
                  )}
                  {step.approval_status === 'rejected' && (
                    <Badge variant="destructive">
                      <X className="h-3 w-3 mr-1" />
                      å·²æ‹’ç»
                    </Badge>
                  )}
                  {step.approval_status === 'pending' && step.can_approve && (
                    <div className="flex gap-1">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => handleApproval(step.step_id, 'approved')}
                        className="text-green-600 border-green-300 hover:bg-green-50"
                      >
                        <CheckCircle className="h-3 w-3 mr-1" />
                        é€šè¿‡
                      </Button>
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => handleApproval(step.step_id, 'rejected')}
                        className="text-red-600 border-red-300 hover:bg-red-50"
                      >
                        <X className="h-3 w-3 mr-1" />
                        æ‹’ç»
                      </Button>
                    </div>
                  )}
                  {step.approval_status === 'pending' && !step.can_approve && (
                    <Badge variant="secondary">ç­‰å¾…å‰ç½®å®¡æ‰¹</Badge>
                  )}
                </div>
              </div>
            ))}
            
            {approvalStatus?.all_approved && (
              <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <div className="flex items-center gap-2 text-green-800">
                  <CheckCircle className="h-5 w-5" />
                  <span className="font-medium">æ‰€æœ‰å®¡æ‰¹å·²å®Œæˆï¼Œå¯ä»¥è¿›è¡Œä»˜æ¬¾æ“ä½œ</span>
                </div>
              </div>
            )}
          </div>
        )}
      </CardContent>
    </Card>
  );
};
```

### **2. ä»˜æ¬¾æŒ‰é’®æ§åˆ¶**
```typescript
const PaymentButton: React.FC<{ paymentRequest: PaymentRequest }> = ({ paymentRequest }) => {
  const [approvalStatus, setApprovalStatus] = useState<ApprovalStatus | null>(null);

  // æ£€æŸ¥æ˜¯å¦å¯ä»¥ä»˜æ¬¾
  const canPay = approvalStatus?.can_pay && paymentRequest.status === 'Approved';

  return (
    <Button
      onClick={handlePayment}
      disabled={!canPay}
      className={canPay ? "bg-green-600 hover:bg-green-700" : "bg-gray-400"}
    >
      {canPay ? "ä»˜æ¬¾" : "ç­‰å¾…å®¡æ‰¹å®Œæˆ"}
    </Button>
  );
};
```

## ğŸ¯ **å®æ–½æ­¥éª¤**

### **1. æ•°æ®åº“è¿ç§»**
```sql
-- æ‰§è¡Œæ•°æ®åº“è®¾è®¡è„šæœ¬
-- åˆ›å»ºå®¡æ‰¹æµç¨‹é…ç½®è¡¨
-- åˆ›å»ºå®¡æ‰¹è®°å½•è¡¨
-- æ·»åŠ å®¡æ‰¹çŠ¶æ€å­—æ®µ
```

### **2. åˆå§‹åŒ–å®¡æ‰¹æµç¨‹**
```sql
-- æ‰§è¡Œåˆ›å»ºå®¡æ‰¹æµç¨‹å‡½æ•°
SELECT public.create_payment_approval_workflow();
```

### **3. é…ç½®å®¡æ‰¹äººå‘˜**
```sql
-- æ›´æ–°å®¡æ‰¹äººå‘˜é…ç½®
UPDATE public.approval_assignments 
SET user_name = 'æ²ˆæœ±å³°'
WHERE step_id = (SELECT id FROM public.approval_steps WHERE step_name = 'ä¿¡æ¯éƒ¨å®¡æ ¸ç­¾å­—');

UPDATE public.approval_assignments 
SET user_name = 'åˆ˜ä¼š'
WHERE step_id = (SELECT id FROM public.approval_steps WHERE step_name = 'è´¢åŠ¡éƒ¨å®¡æ ¸ç­¾å­—');
```

### **4. å‰ç«¯é›†æˆ**
- åœ¨ä»˜æ¬¾ç”³è¯·é¡µé¢æ·»åŠ å®¡æ‰¹çŠ¶æ€ç»„ä»¶
- ä¿®æ”¹ä»˜æ¬¾æŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘
- æ·»åŠ å®¡æ‰¹æ“ä½œç•Œé¢

## ğŸ” **å®¡æ‰¹äººå‘˜éªŒè¯æœºåˆ¶**

### **1. éªŒè¯é€»è¾‘**
- **ç”¨æˆ·èº«ä»½éªŒè¯**ï¼šéªŒè¯å½“å‰ç”¨æˆ·çš„`profiles`è¡¨çš„`full_name`å­—æ®µ
- **å®¡æ‰¹äººå‘˜åŒ¹é…**ï¼šç¡®ä¿å½“å‰ç”¨æˆ·ä¸æŒ‡å®šçš„å®¡æ‰¹äººå‘˜å®Œå…¨åŒ¹é…
- **æƒé™åŒé‡éªŒè¯**ï¼šæ—¢éªŒè¯è§’è‰²æƒé™ï¼ŒåˆéªŒè¯äººå‘˜èº«ä»½

### **2. éªŒè¯æµç¨‹**
```sql
-- 1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
SELECT raw_user_meta_data->>'full_name' INTO v_current_user_name
FROM auth.users WHERE id = auth.uid();

-- 2. è·å–æŒ‡å®šå®¡æ‰¹äººå‘˜
SELECT aa.user_name INTO v_assigned_approver
FROM public.approval_assignments aa
WHERE aa.step_id = p_step_id AND aa.is_primary = TRUE;

-- 3. éªŒè¯äººå‘˜åŒ¹é…
IF v_assigned_approver IS NOT NULL AND v_current_user_name != v_assigned_approver THEN
    RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šåªæœ‰æŒ‡å®šçš„å®¡æ‰¹äººå‘˜ "%" å¯ä»¥å®¡æ‰¹ "%" ç¯èŠ‚ï¼Œå½“å‰ç”¨æˆ·: "%"', 
        v_assigned_approver, v_step_name, v_current_user_name;
END IF;
```

### **3. å®‰å…¨ç‰¹æ€§**
- **ç²¾ç¡®åŒ¹é…**ï¼šå¿…é¡»å®Œå…¨åŒ¹é…å®¡æ‰¹äººå‘˜å§“å
- **å®æ—¶éªŒè¯**ï¼šæ¯æ¬¡å®¡æ‰¹æ“ä½œéƒ½è¿›è¡ŒéªŒè¯
- **é”™è¯¯æç¤º**ï¼šæ¸…æ™°çš„æƒé™ä¸è¶³æç¤ºä¿¡æ¯
- **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰å®¡æ‰¹æ“ä½œå’ŒéªŒè¯ç»“æœ

## âœ… **åŠŸèƒ½ç‰¹ç‚¹**

### **1. æµç¨‹æ§åˆ¶**
- âœ… é¡ºåºå®¡æ‰¹ï¼šå¿…é¡»æŒ‰é¡ºåºå®Œæˆå®¡æ‰¹
- âœ… æƒé™æ§åˆ¶ï¼šåªæœ‰æŒ‡å®šäººå‘˜å¯ä»¥å®¡æ‰¹
- âœ… äººå‘˜éªŒè¯ï¼šéªŒè¯å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºæŒ‡å®šå®¡æ‰¹äººå‘˜
- âœ… çŠ¶æ€ç®¡ç†ï¼šå®æ—¶æ˜¾ç¤ºå®¡æ‰¹çŠ¶æ€
- âœ… ä»˜æ¬¾æ§åˆ¶ï¼šæ‰€æœ‰å®¡æ‰¹å®Œæˆåæ‰èƒ½ä»˜æ¬¾

### **2. ç”¨æˆ·ä½“éªŒ**
- âœ… ç›´è§‚çš„å®¡æ‰¹çŠ¶æ€æ˜¾ç¤º
- âœ… æ¸…æ™°çš„å®¡æ‰¹æµç¨‹æŒ‡ç¤º
- âœ… ä¾¿æ·çš„å®¡æ‰¹æ“ä½œ
- âœ… å®æ—¶çš„çŠ¶æ€æ›´æ–°

### **3. æ•°æ®å®‰å…¨**
- âœ… å®¡æ‰¹è®°å½•å®Œæ•´ä¿å­˜
- âœ… å®¡æ‰¹æ—¥å¿—å¯è¿½æº¯
- âœ… æƒé™ä¸¥æ ¼æ§åˆ¶
- âœ… æ•°æ®ä¸€è‡´æ€§ä¿è¯

è¿™ä¸ªè®¾è®¡æ–¹æ¡ˆå¯ä»¥å®Œå…¨æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œå®ç°å¤šçº§å®¡æ‰¹æµç¨‹æ§åˆ¶ï¼
