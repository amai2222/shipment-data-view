# 💰 付款申请完整流程详解

## 📋 目录
- [正向流程](#正向流程)
- [逆向流程（取消和作废）](#逆向流程取消和作废)
- [状态流转图](#状态流转图)
- [功能矩阵](#功能矩阵)

---

## 🎯 正向流程

### 步骤1：创建付款申请

**操作页面**：`合作方付款申请`（业务管理 → 合作方付款申请）

#### 前置条件
- ✅ 运单 `payment_status` = `Unpaid`（未支付）
- ✅ 运单 `invoice_status` = `Uninvoiced`（未开票）或空
- ✅ 运单已有合作方成本数据

#### 操作步骤
1. 在运单列表中筛选未支付的运单
2. 勾选需要付款的运单（支持跨页批量选择）
3. 点击顶部"付款申请"按钮（绿色）
4. 确认申请

#### 系统执行
**RPC函数**：`process_payment_application`

```sql
-- 1. 更新运单状态
UPDATE logistics_records
SET payment_status = 'Processing'  -- 已申请支付
WHERE id = ANY(p_record_ids);

-- 2. 创建付款申请单
INSERT INTO payment_requests (
    request_id,          -- 自动生成：FKD20251031-XXXX
    status,              -- Pending（待审核）
    logistics_record_ids, -- 运单ID数组
    record_count,        -- 运单数量
    max_amount,          -- 最高应付金额
    notes                -- 备注
) VALUES (...);

-- 3. 更新合作方成本状态
UPDATE logistics_partner_costs
SET 
    payment_status = 'Processing',
    payment_request_id = v_request_id,
    payment_applied_at = NOW()
WHERE logistics_record_id = ANY(p_record_ids);
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | payment_status | `Unpaid` | `Processing` |
| **运单显示** | - | 未支付 | **已申请支付**（灰色徽章） |
| **申请单** | status | - | `Pending` |
| **申请单显示** | - | - | **待审核**（灰色徽章） |
| **合作方成本** | payment_status | `Unpaid` | `Processing` |

#### 可编辑性变化
- ❌ **修改运费按钮**：隐藏（不可编辑）
- ❌ **修改链路按钮**：隐藏（不可编辑）
- ℹ️ 显示：**"已申请支付"**（不可编辑原因）

---

### 步骤2：审批付款申请

**操作页面**：`付款审核`（审核管理 → 付款审核）

#### 前置条件
- ✅ 申请单 `status` = `Pending`（待审核）
- ✅ 用户具有审批权限（财务/管理员）

#### 操作步骤
1. 进入付款审核页面（默认筛选待审核状态）
2. 查看申请单详情（点击申请单编号）
3. 点击"审批"按钮（绿色）或"批量审批"
4. 确认审批

#### 系统执行
**RPC函数**：`approve_payment_request`（单个）/ `batch_approve_payment_requests`（批量）

```sql
-- 1. 更新申请单状态
UPDATE payment_requests
SET 
    status = 'Approved',  -- 已审批待支付
    updated_at = NOW()
WHERE request_id = p_request_id;

-- 2. 更新运单状态
UPDATE logistics_records
SET payment_status = 'Approved'  -- 支付审核通过
WHERE id = ANY(
    SELECT logistics_record_ids 
    FROM payment_requests 
    WHERE request_id = p_request_id
);

-- 3. 更新合作方成本状态
UPDATE logistics_partner_costs
SET payment_status = 'Approved'
WHERE payment_request_id = (
    SELECT id FROM payment_requests 
    WHERE request_id = p_request_id
);
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | payment_status | `Processing` | `Approved` |
| **运单显示** | - | 已申请支付 | **支付审核通过**（绿色边框徽章） |
| **申请单** | status | `Pending` | `Approved` |
| **申请单显示** | - | 待审核 | **已审批待支付**（蓝色徽章） |
| **合作方成本** | payment_status | `Processing` | `Approved` |

#### 界面变化
- **付款审核页面**：申请单排序移至"已审批待支付"分区
- **财务付款页面**：申请单出现在列表中，显示"付款"按钮

---

### 步骤3：执行付款

**操作页面**：`财务付款`（财务管理 → 财务付款）

#### 前置条件
- ✅ 申请单 `status` = `Approved`（已审批待支付）
- ✅ 用户具有付款权限（财务/管理员）

#### 操作步骤
1. 进入财务付款页面（默认筛选已审批待支付状态）
2. 查看申请单和运单详情
3. 点击"付款"按钮（绿色）或"批量付款"
4. 确认付款

#### 系统执行
**RPC函数**：`pay_payment_request`（单个）/ `batch_pay_payment_requests`（批量）

```sql
-- 1. 更新申请单状态
UPDATE payment_requests
SET 
    status = 'Paid',  -- 已支付
    updated_at = NOW()
WHERE request_id = p_request_id;

-- 2. 更新运单状态
UPDATE logistics_records
SET 
    payment_status = 'Paid',  -- 已支付
    payment_completed_at = NOW()
WHERE id = ANY(
    SELECT logistics_record_ids 
    FROM payment_requests 
    WHERE request_id = p_request_id
);

-- 3. 更新合作方成本状态
UPDATE logistics_partner_costs
SET 
    payment_status = 'Paid',
    payment_completed_at = NOW()
WHERE payment_request_id = (
    SELECT id FROM payment_requests 
    WHERE request_id = p_request_id
);
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | payment_status | `Approved` | `Paid` |
| **运单** | payment_completed_at | NULL | 当前时间 |
| **运单显示** | - | 支付审核通过 | **已支付**（绿底白字徽章） |
| **申请单** | status | `Approved` | `Paid` |
| **申请单显示** | - | 已审批待支付 | **已支付**（绿底白字徽章） |
| **合作方成本** | payment_status | `Approved` | `Paid` |
| **合作方成本** | payment_completed_at | NULL | 当前时间 |

#### 界面变化
- **付款审核页面**：申请单排序移至"已支付"分区（最下方）
- **财务付款页面**：申请单排序移至"已支付"分区（最下方）
- **合作方付款申请**：运单显示"已付款"，不可再编辑

---

## 🔄 逆向流程（取消和作废）

### 操作A：取消审批（审批回滚）

**操作页面**：`付款审核`

#### 适用场景
- 已审批但**尚未付款**的申请单需要重新审核
- 审批有误需要退回待审核状态

#### 前置条件
- ✅ 申请单 `status` = `Approved`（已审批待支付）
- ✅ 用户具有审批权限（财务/管理员）

#### 操作步骤
1. 进入付款审核页面
2. 勾选已审批待支付的申请单
3. 点击"批量取消审批"按钮（橙色）
4. 确认取消

#### 系统执行
**RPC函数**：`batch_rollback_payment_approval`

```sql
-- 1. 更新申请单状态（回退到待审核）
UPDATE payment_requests
SET 
    status = 'Pending',
    updated_at = NOW()
WHERE request_id = ANY(p_request_ids)
  AND status = 'Approved';

-- 2. 更新运单状态（回退到已申请支付）
UPDATE logistics_records
SET payment_status = 'Processing'
WHERE id IN (
    SELECT UNNEST(logistics_record_ids)
    FROM payment_requests
    WHERE request_id = ANY(p_request_ids)
);

-- 3. 更新合作方成本状态
UPDATE logistics_partner_costs
SET payment_status = 'Processing'
WHERE payment_request_id IN (
    SELECT id FROM payment_requests
    WHERE request_id = ANY(p_request_ids)
);
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | payment_status | `Approved` | `Processing` |
| **运单显示** | - | 支付审核通过 | **已申请支付** |
| **申请单** | status | `Approved` | `Pending` |
| **申请单显示** | - | 已审批待支付 | **待审核** |

#### 注意事项
- ⚠️ **已付款**的申请单**不能**取消审批
- ℹ️ 取消审批后需要重新审批才能付款
- ✅ 申请单记录**保留**，只是状态回退

---

### 操作B：取消付款（付款回滚）

**操作页面**：`财务付款`

#### 适用场景
- 付款错误需要撤销
- 需要重新生成付款申请单

#### 前置条件
- ✅ 申请单 `status` = `Paid`（已支付）
- ✅ 用户具有财务权限（财务/管理员）

#### 操作步骤
1. 进入财务付款页面
2. 筛选或查找已支付的申请单
3. 勾选需要取消付款的申请单
4. 点击"批量取消付款"按钮（橙色）
5. 确认取消

#### 系统执行
**RPC函数**：`cancel_payment_request`（通过批量取消调用）

```sql
-- 1. 更新申请单状态（回退到已审批待支付）
UPDATE payment_requests
SET 
    status = 'Approved',
    updated_at = NOW(),
    notes = notes || ' [付款已取消]'
WHERE request_id = p_request_id
  AND status = 'Paid';

-- 2. 更新运单状态（回退到支付审核通过）
UPDATE logistics_records
SET 
    payment_status = 'Approved',
    payment_completed_at = NULL
WHERE id = ANY(
    SELECT logistics_record_ids 
    FROM payment_requests 
    WHERE request_id = p_request_id
);

-- 3. 更新合作方成本状态
UPDATE logistics_partner_costs
SET 
    payment_status = 'Approved',
    payment_completed_at = NULL
WHERE payment_request_id = (
    SELECT id FROM payment_requests 
    WHERE request_id = p_request_id
);
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | payment_status | `Paid` | `Approved` |
| **运单** | payment_completed_at | 时间戳 | NULL |
| **运单显示** | - | 已支付 | **支付审核通过** |
| **申请单** | status | `Paid` | `Approved` |
| **申请单** | notes | 原备注 | 原备注 + [付款已取消] |
| **申请单显示** | - | 已支付 | **已审批待支付** |

#### 注意事项
- ⚠️ 取消付款后申请单仍然存在
- ✅ 可以重新执行付款操作
- ℹ️ 备注中会添加取消记录

---

### 操作C：作废申请单（永久删除）

**操作页面**：`财务付款` / `付款审核`

#### 适用场景
- 错误生成的申请单需要删除
- 不再需要的付款申请

#### 前置条件
- ✅ 申请单 `status` = `Pending`（待审核）或 `Approved`（已审批待支付）
- ❌ **已支付**的申请单**不能**直接作废（需先取消付款）
- ✅ 用户具有管理员权限

#### 操作步骤
1. 进入财务付款页面或付款审核页面
2. 勾选需要作废的申请单
3. 点击"一键作废"按钮（红色）
4. 阅读警告信息
5. 确认作废

#### 系统执行
**RPC函数**：`void_and_delete_payment_requests`

```sql
-- 1. 回滚运单状态到未支付
UPDATE logistics_records
SET 
    payment_status = 'Unpaid',
    payment_completed_at = NULL,
    updated_at = NOW()
WHERE id = ANY(
    SELECT UNNEST(logistics_record_ids)
    FROM payment_requests
    WHERE request_id = ANY(p_request_ids)
      AND status IN ('Pending', 'Approved')
);

-- 2. 回滚合作方成本状态
UPDATE logistics_partner_costs
SET 
    payment_status = 'Unpaid',
    payment_request_id = NULL,
    payment_applied_at = NULL,
    payment_completed_at = NULL
WHERE payment_request_id IN (
    SELECT id FROM payment_requests
    WHERE request_id = ANY(p_request_ids)
      AND status IN ('Pending', 'Approved')
);

-- 3. 删除付款申请明细（如果有）
DELETE FROM partner_payment_items
WHERE payment_request_id IN (
    SELECT id FROM payment_requests
    WHERE request_id = ANY(p_request_ids)
);

-- 4. 永久删除申请单记录
DELETE FROM payment_requests
WHERE request_id = ANY(p_request_ids)
  AND status IN ('Pending', 'Approved');
```

#### 结果状态
| 对象 | 字段 | 变更前 | 变更后 |
|------|------|--------|--------|
| **运单** | payment_status | `Processing` 或 `Approved` | `Unpaid` |
| **运单显示** | - | 已申请支付/支付审核通过 | **未支付** |
| **申请单** | - | 存在 | **永久删除** |
| **合作方成本** | payment_status | `Processing` 或 `Approved` | `Unpaid` |
| **合作方成本** | payment_request_id | 申请单ID | NULL |

#### 注意事项
- ⚠️ **不可逆操作**：记录永久删除，无法恢复
- ⚠️ **已支付**的申请单会被跳过（需先取消付款）
- ✅ 运单恢复到未支付状态，可重新申请付款
- ✅ 合作方成本数据保留，但付款关联清除

---

## 📊 状态流转图

### 正向流程

```
┌─────────────────────────────────────────────────────────────┐
│                        运单状态流转                          │
└─────────────────────────────────────────────────────────────┘

┌──────────┐  步骤1：创建付款申请  ┌──────────┐
│  Unpaid  │ ──────────────────→ │Processing│
│  未支付  │                      │已申请支付 │
└──────────┘                      └─────┬────┘
                                        │
                           步骤2：审批付款申请
                                        │
                                        ↓
                                  ┌──────────┐
                                  │ Approved │
                                  │支付审核  │
                                  │  通过    │
                                  └─────┬────┘
                                        │
                           步骤3：执行付款
                                        │
                                        ↓
                                  ┌──────────┐
                                  │   Paid   │
                                  │  已支付  │
                                  └──────────┘

┌─────────────────────────────────────────────────────────────┐
│                      申请单状态流转                          │
└─────────────────────────────────────────────────────────────┘

┌──────────┐  步骤1：创建付款申请  ┌──────────┐
│   创建    │ ──────────────────→ │ Pending  │
│          │                      │  待审核  │
└──────────┘                      └─────┬────┘
                                        │
                           步骤2：审批付款申请
                                        │
                                        ↓
                                  ┌──────────┐
                                  │ Approved │
                                  │已审批待  │
                                  │  支付    │
                                  └─────┬────┘
                                        │
                           步骤3：执行付款
                                        │
                                        ↓
                                  ┌──────────┐
                                  │   Paid   │
                                  │  已支付  │
                                  └──────────┘
```

### 逆向流程

```
┌─────────────────────────────────────────────────────────────┐
│                    取消和作废操作流转                         │
└─────────────────────────────────────────────────────────────┘

        ┌──────────┐
        │ Pending  │
        │  待审核  │
        └─────┬────┘
              │
    操作A：取消审批 │ 审批
      （回滚）    ↓↑
              ┌──────────┐
              │ Approved │
              │已审批待  │
              │  支付    │
              └─────┬────┘
                    │
      操作B：取消付款│ 付款
        （回滚）  ↓↑
                    │
              ┌──────────┐
              │   Paid   │
              │  已支付  │
              └──────────┘

操作C：一键作废（永久删除）
┌──────────┐                    ┌──────────┐
│ Pending  │ ──作废删除──→    │  Unpaid  │
│  待审核  │                    │  未支付  │
└──────────┘                    └──────────┘
                                 (运单状态)
┌──────────┐                    
│ Approved │ ──作废删除──→    ┌──────────┐
│已审批待  │                    │  Unpaid  │
│  支付    │                    │  未支付  │
└──────────┘                    └──────────┘
                                 (运单状态)
```

---

## 📋 功能矩阵

### 操作权限矩阵

| 操作 | 页面 | 所需权限 | 按钮颜色 |
|------|------|----------|----------|
| 创建付款申请 | 合作方付款申请 | 财务/管理员 | 🟢 绿色 |
| 审批付款 | 付款审核 | 财务/管理员 | 🟢 绿色 |
| 批量审批 | 付款审核 | 财务/管理员 | 🟢 绿色 |
| 执行付款 | 财务付款 | 财务/管理员 | 🟢 绿色 |
| 批量付款 | 财务付款 | 财务/管理员 | 🟢 绿色 |
| 取消审批 | 付款审核 | 财务/管理员 | 🟠 橙色 |
| 批量取消审批 | 付款审核 | 财务/管理员 | 🟠 橙色 |
| 取消付款 | 财务付款 | 财务/管理员 | 🟠 橙色 |
| 批量取消付款 | 财务付款 | 财务/管理员 | 🟠 橙色 |
| 一键作废 | 财务付款/付款审核 | **仅管理员** | 🔴 红色 |

### 状态可操作矩阵

| 申请单状态 | 可执行操作 |
|-----------|-----------|
| `Pending`（待审核） | ✅ 审批<br>✅ 一键作废 |
| `Approved`（已审批待支付） | ✅ 付款<br>✅ 取消审批<br>✅ 一键作废 |
| `Paid`（已支付） | ✅ 取消付款 |

### 运单可编辑性矩阵

| 运单付款状态 | 修改运费 | 修改链路 | 说明 |
|-------------|---------|---------|------|
| `Unpaid`（未支付） | ✅ 可以 | ✅ 可以 | 正常编辑状态 |
| `Processing`（已申请支付） | ❌ 不可以 | ❌ 不可以 | 已进入付款流程 |
| `Approved`（支付审核通过） | ❌ 不可以 | ❌ 不可以 | 已审批通过 |
| `Paid`（已支付） | ❌ 不可以 | ❌ 不可以 | 已完成付款 |

---

## 💡 最佳实践

### 1. 正常付款流程
```
1. 业务人员创建付款申请（选择未支付运单）
   ↓
2. 财务审核人员审批申请单
   ↓
3. 出纳人员执行付款
```

### 2. 错误更正流程

#### 情况A：审批错误
```
1. 发现审批错误（尚未付款）
   ↓
2. 在"付款审核"页面取消审批
   ↓
3. 重新审核
```

#### 情况B：付款错误
```
1. 发现付款错误
   ↓
2. 在"财务付款"页面取消付款
   ↓
3. 重新执行付款
```

#### 情况C：申请单错误（需删除）
```
1. 确认申请单需要删除
   ↓
2. 如果已付款，先取消付款
   ↓
3. 在"财务付款"页面一键作废
   ↓
4. 运单恢复到未支付状态
   ↓
5. 重新创建正确的申请单
```

### 3. 注意事项

#### ⚠️ 作废前必读
- 作废是**永久性删除**，无法恢复
- 已支付的申请单需要**先取消付款**才能作废
- 作废会将运单状态回滚到**未支付**
- 合作方成本数据**保留**，但付款关联会清除

#### ✅ 推荐做法
- 能取消就不要作废（取消可逆，作废不可逆）
- 定期检查待审核申请单，及时处理
- 付款前再次确认申请单信息
- 重要操作前备份数据

#### 🚫 禁止操作
- ❌ 不要频繁创建和作废申请单
- ❌ 不要在运单已开票后付款（先付款后开票）
- ❌ 不要随意取消已完成的付款

---

## 📞 相关页面

| 页面名称 | 路径 | 主要功能 |
|---------|------|---------|
| 合作方付款申请 | 业务管理 → 合作方付款申请 | 创建付款申请 |
| 付款审核 | 审核管理 → 付款审核 | 审批/取消审批 |
| 财务付款 | 财务管理 → 财务付款 | 执行付款/取消付款/作废 |

---

## 🔧 相关数据库函数

### 正向流程函数
- `process_payment_application` - 创建付款申请
- `approve_payment_request` - 审批付款申请（单个）
- `batch_approve_payment_requests` - 批量审批
- `pay_payment_request` - 执行付款（单个）
- `batch_pay_payment_requests` - 批量付款

### 逆向流程函数
- `batch_rollback_payment_approval` - 批量取消审批
- `cancel_payment_request` - 取消付款
- `void_and_delete_payment_requests` - 作废并删除申请单
- `rollback_payment_status_for_waybills` - 回滚运单付款状态

---

## 📝 更新日志

- **2025-10-31**：创建完整流程文档
- **2025-01-31**：添加批量取消审批功能
- **2025-01-22**：添加取消付款和作废功能
- **2025-01-15**：完善审批和付款流程

---

**文档维护者**：系统管理员  
**最后更新**：2025-10-31

