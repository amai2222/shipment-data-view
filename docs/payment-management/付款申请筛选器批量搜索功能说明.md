# 付款申请筛选器批量搜索功能说明

## ✅ 批量搜索支持状态

现在**所有筛选字段都支持批量搜索**！

| 筛选字段 | 批量支持 | 搜索逻辑 | 示例 |
|---------|---------|---------|------|
| 司机名称 | ✅ 支持 | OR逻辑 + 模糊匹配 | `张三,李四,王五` |
| 车牌号 | ✅ 支持 | OR逻辑 + 模糊匹配 | `京A,京B,沪C` |
| 电话 | ✅ 支持 | OR逻辑 + 模糊匹配 | `138,139,186` |
| 运单编号 | ✅ 支持 | OR逻辑 + 精确匹配 + 其他平台 | `HDA0648,2021991438` |
| 其他平台名称 | ❌ 单选 | 下拉选择 | `可乐公司` |

---

## 🔍 批量搜索逻辑详解

### 1. 司机名称批量搜索

**输入格式**：
```
张三,李四,王五
```

**SQL逻辑**：
```sql
-- 解析为数组: ['张三', '李四', '王五']
-- 搜索逻辑: 
WHERE driver_name ILIKE '%张三%' 
   OR driver_name ILIKE '%李四%' 
   OR driver_name ILIKE '%王五%'
```

**搜索结果**：
- ✅ 司机名称包含"张三"的运单
- ✅ 司机名称包含"李四"的运单
- ✅ 司机名称包含"王五"的运单

---

### 2. 车牌号批量搜索

**输入格式**：
```
京A12345,京B67890,沪C11111
```

**SQL逻辑**：
```sql
-- 解析为数组: ['京A12345', '京B67890', '沪C11111']
-- 搜索逻辑:
WHERE license_plate ILIKE '%京A12345%'
   OR license_plate ILIKE '%京B67890%'
   OR license_plate ILIKE '%沪C11111%'
```

**支持模糊搜索**：
- 输入 `京A,京B` 可以匹配：
  - ✅ 京A12345
  - ✅ 京A67890
  - ✅ 京B11111

---

### 3. 电话批量搜索

**输入格式**：
```
13812345678,13987654321,18611112222
```

**或简化输入**（只输入部分号码）：
```
138,139,186
```

**SQL逻辑**：
```sql
-- 解析为数组: ['138', '139', '186']
-- 搜索逻辑:
WHERE driver_phone ILIKE '%138%'
   OR driver_phone ILIKE '%139%'
   OR driver_phone ILIKE '%186%'
```

**搜索结果**：
- ✅ 138开头的所有电话
- ✅ 139开头的所有电话
- ✅ 186开头的所有电话

---

### 4. 运单编号批量搜索

**输入格式**：
```
HDA0648,2021991438,ABC123
```

**SQL逻辑**：
```sql
-- 解析为数组: ['HDA0648', '2021991438', 'ABC123']
-- 搜索逻辑:
WHERE auto_number = ANY(ARRAY['HDA0648', '2021991438', 'ABC123'])
   OR external_tracking_numbers && ARRAY['HDA0648', '2021991438', 'ABC123']
```

**特殊功能**：
- ✅ 同时搜索本平台运单号（`auto_number`）
- ✅ 同时搜索其他平台运单号（`external_tracking_numbers`）
- ✅ 精确匹配（不是模糊匹配）

---

## 💡 使用场景

### 场景1：查找多个司机的运单

**需求**：查看张三、李四、王五三个司机的所有未支付运单

**操作**：
1. 点击司机输入框旁边的 [+] 按钮
2. 批量输入对话框中粘贴：
   ```
   张三
   李四
   王五
   ```
3. 确认
4. 点击搜索

**结果**：返回所有这三个司机的运单（OR逻辑）

---

### 场景2：查找特定车牌的运单

**需求**：查看多辆车的运输记录

**操作**：
1. 在车牌号输入框输入：`京A12345,京B67890,沪C11111`
2. 点击搜索

**结果**：返回这三辆车的所有运单

---

### 场景3：通过其他平台运单号查找

**需求**：客户提供了其他平台的运单号，需要找到对应的本平台运单

**操作**：
1. 在运单编号输入框输入：`2021991438,2021975523`
2. 点击搜索

**结果**：
- 找到本平台运单 HDA0648（external_tracking_numbers包含2021991438）
- 找到本平台运单 XYZ123（external_tracking_numbers包含2021975523）

---

### 场景4：综合批量筛选

**需求**：查找多个司机、多个车牌、特定日期范围的未支付运单

**操作**：
1. 项目：选择"可乐项目"
2. 日期：2025-01-01 到 2025-12-31
3. 支付状态：未支付
4. 展开高级筛选
5. 司机：`张三,李四,王五`
6. 车牌：`京A,京B`
7. 点击搜索

**结果**：返回所有满足条件的运单（所有条件是AND，但同类型内是OR）

---

## 🔧 技术实现

### SQL层面

#### 1. 字符串解析为数组

```sql
-- 输入: "张三,李四,王五"
v_driver_array := string_to_array(p_driver_name, ',');
-- 结果: {'张三', '李四', '王五'}

-- 去除空格
v_driver_array := array(SELECT trim(unnest(v_driver_array)));
-- 结果: {'张三', '李四', '王五'} (已去除前后空格)
```

#### 2. OR逻辑实现

```sql
-- 使用 EXISTS + unnest 实现OR逻辑
EXISTS (
    SELECT 1 FROM unnest(v_driver_array) AS driver_name
    WHERE lr.driver_name ILIKE '%' || driver_name || '%'
)

-- 等价于:
WHERE driver_name ILIKE '%张三%' 
   OR driver_name ILIKE '%李四%' 
   OR driver_name ILIKE '%王五%'
```

#### 3. 模糊匹配 vs 精确匹配

| 字段 | 匹配方式 | 原因 |
|-----|---------|------|
| 司机 | 模糊匹配 | 支持部分姓名搜索 |
| 车牌 | 模糊匹配 | 支持省份/前缀搜索 |
| 电话 | 模糊匹配 | 支持号段搜索 |
| 运单号 | 精确匹配 | 运单号必须完全匹配 |

---

## 📊 性能优化

### 索引支持

确保以下索引存在以提高批量搜索性能：

```sql
-- 司机名称索引
CREATE INDEX IF NOT EXISTS idx_logistics_records_driver_name 
ON logistics_records(driver_name);

-- 车牌号索引
CREATE INDEX IF NOT EXISTS idx_logistics_records_license_plate 
ON logistics_records(license_plate);

-- 电话索引
CREATE INDEX IF NOT EXISTS idx_logistics_records_driver_phone 
ON logistics_records(driver_phone);

-- 运单编号索引（已存在）
CREATE INDEX IF NOT EXISTS idx_logistics_records_auto_number 
ON logistics_records(auto_number);

-- 其他平台运单号索引（已存在）
CREATE INDEX IF NOT EXISTS idx_logistics_records_external_tracking 
ON logistics_records USING GIN (external_tracking_numbers);
```

---

## 🧪 测试用例

### 测试1：单个值搜索（向后兼容）

```sql
-- 司机
SELECT * FROM get_payment_request_data(p_driver_name := '张三');
-- 预期：返回所有包含"张三"的运单
```

### 测试2：批量值搜索（OR逻辑）

```sql
-- 司机批量
SELECT * FROM get_payment_request_data(p_driver_name := '张三,李四,王五');
-- 预期：返回张三 OR 李四 OR 王五的运单
```

### 测试3：带空格的批量输入

```sql
-- 自动去除空格
SELECT * FROM get_payment_request_data(p_driver_name := '张三, 李四 , 王五');
-- 预期：正常工作，自动去除多余空格
```

### 测试4：综合批量筛选

```sql
SELECT * FROM get_payment_request_data(
    p_driver_name := '张三,李四',
    p_license_plate := '京A,京B',
    p_driver_phone := '138,139',
    p_waybill_numbers := 'HDA0648,2021991438'
);
-- 预期：返回满足所有条件的运单（多字段AND，单字段内OR）
```

---

## ⚡ 输入便利性

### 前端批量输入对话框

每个筛选字段旁边都有 **[+]** 按钮，点击后可以：

1. **粘贴多行数据**：
   ```
   张三
   李四
   王五
   ```

2. **自动转换为逗号分隔**：
   ```
   张三,李四,王五
   ```

3. **支持混合分隔符**：
   - 换行符
   - 逗号
   - 空格

---

## 📋 筛选逻辑汇总

### 多条件组合（AND逻辑）

```
项目=可乐项目 
AND 日期=2025年 
AND 支付状态=未支付 
AND (司机=张三 OR 司机=李四) 
AND (车牌包含京A OR 车牌包含京B)
```

### 单字段内（OR逻辑）

```
司机: 张三,李四,王五
结果: 张三 OR 李四 OR 王五
```

---

## 🎯 功能亮点

### 1. 完全支持批量（4个字段）

- ✅ 司机名称
- ✅ 车牌号
- ✅ 电话
- ✅ 运单编号

### 2. 智能模糊匹配

- 输入 `张` 可以匹配：张三、张四、老张
- 输入 `京A` 可以匹配：京A12345、京A67890
- 输入 `138` 可以匹配：13812345678、13898765432

### 3. 自动去除空格

```
输入: "张三, 李四 , 王五"
处理后: ['张三', '李四', '王五']
```

### 4. 支持其他平台运单号

```
输入: "HDA0648,2021991438"
搜索: 
  - auto_number = 'HDA0648'
  - external_tracking_numbers 包含 '2021991438'
```

---

## 🚀 下一步

### 执行SQL脚本

在 Supabase SQL Editor 中执行：
```
增强付款申请筛选器_后端函数.sql
```

### 执行后验证

```sql
-- 测试批量司机搜索
SELECT * FROM get_payment_request_data(
    p_driver_name := '张三,李四,王五'
);

-- 应该返回所有司机名称包含"张三"、"李四"或"王五"的运单
```

---

## 📊 与运单管理的区别

| 功能 | 运单管理 | 付款申请（升级后） |
|-----|---------|-----------------|
| 司机批量搜索 | ❌ 前端支持，后端不支持 | ✅ 完全支持 |
| 车牌批量搜索 | ❌ 前端支持，后端不支持 | ✅ 完全支持 |
| 电话批量搜索 | ❌ 前端支持，后端不支持 | ✅ 完全支持 |
| 运单号批量 | ✅ 支持 | ✅ 支持（增强版） |
| 其他平台运单号 | ✅ 支持 | ✅ 支持 |

---

## 💡 用户体验提升

### 修改前

```
司机: 张三
结果: 只能搜索一个司机 ❌

需要搜索多个司机时，只能逐个搜索
```

### 修改后

```
司机: 张三,李四,王五
结果: 一次性搜索三个司机 ✅

批量输入，一次搜索，节省时间
```

---

## 🧪 完整测试清单

### 基础功能
- [ ] 单个司机搜索
- [ ] 批量司机搜索（2-3个）
- [ ] 批量司机搜索（10+个）
- [ ] 单个车牌搜索
- [ ] 批量车牌搜索
- [ ] 单个电话搜索
- [ ] 批量电话搜索
- [ ] 单个运单号搜索
- [ ] 批量运单号搜索
- [ ] 其他平台运单号搜索

### 组合功能
- [ ] 司机 + 车牌批量搜索
- [ ] 司机 + 日期 + 支付状态
- [ ] 所有筛选字段组合
- [ ] 跨页全选功能

### 边界情况
- [ ] 输入带空格的批量值
- [ ] 输入空字符串
- [ ] 输入不存在的值
- [ ] 输入特殊字符

---

## 📝 SQL函数变更总结

### get_payment_request_data 函数

**变更点**：

1. ✅ 新增4个变量声明
   ```sql
   v_driver_array text[];
   v_license_array text[];
   v_phone_array text[];
   v_waybill_array text[];
   ```

2. ✅ 新增字符串解析逻辑（将逗号分隔转为数组）

3. ✅ 修改筛选逻辑为OR批量搜索

### get_filtered_unpaid_ids 函数

**变更点**：同步修改，确保跨页全选功能正常

---

**状态**: ✅ SQL脚本已完成，支持所有字段批量搜索  
**下一步**: 执行SQL后修改前端代码

