# 付款申请通知触发器修复说明

## 🐛 错误信息

```
操作失败: record "new" has no field "project_id"
```

## 📍 问题定位

### 错误来源

**文件：** `supabase/migrations/create_notifications_system.sql`  
**函数：** `notify_payment_request_created()`  
**触发器：** `trigger_payment_request_notification`  
**触发时机：** 在 `payment_requests` 表插入数据后

### 错误代码

```sql
-- 第162行
CREATE OR REPLACE FUNCTION public.notify_payment_request_created()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
  v_project_name text;
BEGIN
  -- ❌ 错误：payment_requests表没有project_id字段
  SELECT name INTO v_project_name
  FROM public.projects
  WHERE id = NEW.project_id;  -- 这里报错！
  ...
END;
$$;
```

## 🔍 根本原因

### payment_requests表结构

`payment_requests` 表没有 `project_id` 字段！

**实际字段：**
- id
- total_amount
- status
- work_wechat_sp_no
- approval_result
- created_at
- updated_at
- created_by
- user_id
- ...

**缺少：**
- ❌ project_id

### 为什么会出错？

在生成付款申请并保存到数据库时：
```sql
INSERT INTO payment_requests (total_amount, created_by, ...)
VALUES (...);
```

触发了 `AFTER INSERT` 触发器 `trigger_payment_request_notification`，这个触发器调用函数尝试访问 `NEW.project_id`，但这个字段不存在，导致报错。

## ✅ 解决方案

### 方案1：修复触发器函数（推荐）

不依赖不存在的 `project_id` 字段，从关联表获取项目信息。

**修复后的代码：**

```sql
CREATE OR REPLACE FUNCTION public.notify_payment_request_created()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_project_name text;
  v_user_record record;
BEGIN
  -- ✅ 从关联的运单记录获取项目信息
  SELECT DISTINCT lr.project_name
  INTO v_project_name
  FROM public.payment_request_items pri
  JOIN public.logistics_records lr ON pri.logistics_record_id = lr.id
  WHERE pri.payment_request_id = NEW.id
  LIMIT 1;
  
  -- 如果没有找到，使用默认值
  v_project_name := COALESCE(v_project_name, '未知项目');

  -- 通知所有admin和finance角色的用户
  FOR v_user_record IN 
    SELECT id FROM public.profiles 
    WHERE role IN ('admin', 'finance') AND is_active = true
  LOOP
    PERFORM public.create_payment_request_notification(
      v_user_record.id,
      NEW.id,
      NEW.total_amount,
      v_project_name
    );
  END LOOP;

  RETURN NEW;
END;
$$;
```

**关键改动：**
1. 不再使用 `NEW.project_id`
2. 通过 `payment_request_items` 和 `logistics_records` 获取项目名称
3. 添加容错处理

---

### 方案2：禁用触发器（临时）

如果暂时不需要通知功能，可以禁用触发器：

```sql
-- 禁用触发器
DROP TRIGGER IF EXISTS trigger_payment_request_notification ON public.payment_requests;
```

**注意：** 这会导致付款申请创建时不再发送通知。

---

### 方案3：添加project_id字段（不推荐）

为 `payment_requests` 表添加 `project_id` 字段：

```sql
ALTER TABLE public.payment_requests 
ADD COLUMN IF NOT EXISTS project_id UUID;
```

**不推荐原因：**
- payment_requests可能包含多个项目的运单
- 单一project_id字段不够灵活
- 需要修改更多相关代码

---

## 🔧 应用修复

### 修复文件

`supabase/migrations/20250816_fix_payment_request_notification_trigger.sql`

### 应用方式

**在Supabase SQL Editor中：**
```sql
-- 直接运行修复文件的内容
```

**或使用CLI：**
```bash
supabase db push
```

### 验证修复

```sql
-- 1. 检查函数是否已更新
SELECT pg_get_functiondef(oid) 
FROM pg_proc 
WHERE proname = 'notify_payment_request_created';

-- 2. 检查触发器是否正常
SELECT 
  tgname AS 触发器名称,
  tgtype AS 触发器类型,
  tgenabled AS 是否启用
FROM pg_trigger
WHERE tgname = 'trigger_payment_request_notification';
```

---

## 🧪 测试步骤

### 测试付款申请创建

1. 选择一些运单记录
2. 点击"一键申请付款"
3. 在预览对话框中查看合作方列表
4. 点击"确认并生成申请"
5. 应该成功，不再报错

### 预期结果

- ✅ 付款申请创建成功
- ✅ 运单状态更新为"已申请支付"
- ✅ 通知发送给管理员和财务（如果函数正常）
- ✅ 不再出现 "record new has no field project_id" 错误

---

## 📊 相关表结构

### payment_requests表（推测）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| total_amount | NUMERIC | 总金额 |
| status | TEXT | 状态 |
| work_wechat_sp_no | TEXT | 企业微信审批单号 |
| approval_result | JSONB | 审批结果 |
| created_at | TIMESTAMPTZ | 创建时间 |
| created_by | UUID | 创建人 |
| user_id | UUID | 用户ID |
| ❌ project_id | - | **不存在** |

### partner_payment_items表（关联表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| payment_request_id | UUID | 付款申请ID |
| logistics_record_id | UUID | 运单记录ID |
| user_id | UUID | 用户ID |

### 数据关系

```
payment_requests (1)
      ↓ (1对多)
partner_payment_items (N)
      ↓ (N对1)
logistics_records
      ├─ project_id
      └─ project_name  ✅ 通过这里获取项目信息
```

---

## 🎯 其他可能需要修复的地方

### 检查其他触发器

```sql
-- 查找所有使用NEW.project_id的触发器
SELECT 
  t.tgname AS 触发器名,
  p.proname AS 函数名,
  pg_get_functiondef(p.oid) AS 函数定义
FROM pg_trigger t
JOIN pg_proc p ON t.tgfoid = p.oid
WHERE pg_get_functiondef(p.oid) LIKE '%NEW.project_id%'
  OR pg_get_functiondef(p.oid) LIKE '%new.project_id%';
```

### 检查其他函数

```sql
-- 查找所有可能使用payment_requests.project_id的函数
SELECT 
  proname AS 函数名,
  pg_get_functiondef(oid) AS 函数定义
FROM pg_proc
WHERE pg_get_functiondef(oid) LIKE '%payment_requests%project_id%';
```

---

## ⚠️ 注意事项

1. **备份数据**
   - 修改触发器前先确认当前系统状态
   - 如有需要，导出payment_requests数据

2. **通知功能影响**
   - 修复后，通知会包含正确的项目名称
   - 如果payment_request_items为空，显示"未知项目"

3. **测试建议**
   - 先在测试环境应用修复
   - 验证付款申请创建流程
   - 确认通知正常发送

---

## 📝 相关文档

- [API_DOCUMENTATION.md](./API_DOCUMENTATION.md) - API文档
- [开票申请功能说明.md](./开票申请功能说明.md) - 开票申请功能

---

**修复文件：** `supabase/migrations/20250816_fix_payment_request_notification_trigger.sql`  
**错误级别：** 🔴 高（阻止付款申请创建）  
**修复状态：** ✅ 已创建修复迁移  
**需要应用：** 是

