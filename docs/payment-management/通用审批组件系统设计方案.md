# 通用审批组件系统设计方案

## 📋 目录

1. [系统概述](#系统概述)
2. [核心概念](#核心概念)
3. [数据库设计](#数据库设计)
4. [审批流程配置](#审批流程配置)
5. [审批执行流程](#审批执行流程)
6. [组件接口设计](#组件接口设计)
7. [使用场景示例](#使用场景示例)
8. [状态管理](#状态管理)
9. [权限控制](#权限控制)

---

## 🎯 系统概述

### 设计目标

创建一个**通用的审批组件系统**，可以应用于任何需要审批的业务场景，支持：

1. **灵活配置审批环节**：可以自由设置哪些环节需要审批
2. **多审批人支持**：每个环节可以配置多个审批人
3. **并行/串行审批**：支持并行审批（任意顺序）和串行审批（按顺序）
4. **可复用性**：同一套系统可用于付款申请、开票申请、费用报销等不同业务

### 适用场景

- ✅ 付款申请审批
- ✅ 开票申请审批
- ✅ 费用报销审批
- ✅ 合同审批
- ✅ 采购申请审批
- ✅ 任何需要多级审批的业务流程

---

## 🔑 核心概念

### 1. 审批流程（Approval Workflow）

**定义**：一个完整的审批流程，包含多个审批环节。

**示例**：
- 付款申请审批流程
- 开票申请审批流程
- 费用报销审批流程

### 2. 审批环节（Approval Step）

**定义**：审批流程中的一个步骤，可以配置多个审批人。

**示例**：
- 环节1：信息专员审批
- 环节2：信息部审核
- 环节3：业务负责人审批
- 环节4：财务部审核

### 3. 审批人（Approver）

**定义**：每个环节中需要审批的用户，一个环节可以有多个审批人。

**示例**：
- 环节1：用户A、用户B（两人都需要审批）
- 环节2：用户C（一人审批即可）

### 4. 审批模式（Approval Mode）

**定义**：审批的执行方式。

- **并行审批（Parallel）**：同一环节的多个审批人可以任意顺序审批，全部通过后进入下一环节
- **串行审批（Sequential）**：必须按环节顺序审批，前一个环节完成后才能进入下一环节

### 5. 审批记录（Approval Record）

**定义**：记录每个审批人的审批结果和签名。

---

## 🗄️ 数据库设计

### 1. 审批流程模板表

**表名**：`approval_workflows`

**用途**：定义审批流程模板（可复用）

```sql
CREATE TABLE approval_workflows (
    id UUID PRIMARY KEY,
    workflow_name TEXT NOT NULL,              -- 流程名称（如：付款申请审批流程）
    workflow_type TEXT NOT NULL,               -- 流程类型（如：payment_request, invoice_request）
    description TEXT,                          -- 流程描述
    approval_mode TEXT DEFAULT 'parallel',     -- 审批模式：parallel=并行, sequential=串行
    is_active BOOLEAN DEFAULT TRUE,            -- 是否启用
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**说明**：
- 一个流程模板可以用于多个业务实例
- 例如：创建"付款申请审批流程"模板，所有付款申请都使用这个模板

### 2. 审批环节配置表

**表名**：`approval_steps`

**用途**：定义审批流程中的各个环节

```sql
CREATE TABLE approval_steps (
    id UUID PRIMARY KEY,
    workflow_id UUID REFERENCES approval_workflows(id) ON DELETE CASCADE,
    step_order INTEGER NOT NULL,               -- 环节顺序（1, 2, 3, 4...）
    step_name TEXT NOT NULL,                  -- 环节名称（如：信息部审核）
    step_description TEXT,                    -- 环节描述
    approval_mode TEXT DEFAULT 'parallel',   -- 本环节审批模式：parallel=并行, sequential=串行
    is_required BOOLEAN DEFAULT TRUE,          -- 是否必需
    min_approvers INTEGER DEFAULT 1,           -- 最少需要几个审批人通过（用于并行审批）
    created_at TIMESTAMP DEFAULT NOW()
);
```

**说明**：
- 一个流程可以有多个环节
- 每个环节有顺序（step_order）
- 每个环节可以配置审批模式（并行或串行）
- min_approvers：并行审批时，最少需要几个审批人通过

### 3. 审批人配置表

**表名**：`approval_step_assignments`

**用途**：为每个环节配置审批人

```sql
CREATE TABLE approval_step_assignments (
    id UUID PRIMARY KEY,
    step_id UUID REFERENCES approval_steps(id) ON DELETE CASCADE,
    approver_user_id UUID REFERENCES auth.users(id),
    approver_name TEXT NOT NULL,               -- 审批人姓名
    approver_role TEXT,                        -- 审批人角色（可选）
    is_required BOOLEAN DEFAULT TRUE,          -- 是否必需审批
    created_at TIMESTAMP DEFAULT NOW()
);
```

**说明**：
- 一个环节可以有多个审批人
- 每个审批人可以标记为必需或可选
- 支持按用户ID或角色配置

### 4. 业务实例审批配置表

**表名**：`business_approval_instances`

**用途**：将审批流程应用到具体的业务实例

```sql
CREATE TABLE business_approval_instances (
    id UUID PRIMARY KEY,
    business_type TEXT NOT NULL,               -- 业务类型（如：payment_request, invoice_request）
    business_id UUID NOT NULL,                 -- 业务ID（如：payment_requests.id）
    workflow_id UUID REFERENCES approval_workflows(id),
    approval_status TEXT DEFAULT 'pending',     -- 审批状态：pending, approving, approved, rejected
    current_step_order INTEGER,                 -- 当前审批环节（用于串行审批）
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- 唯一约束：一个业务实例只能有一个审批流程
    UNIQUE(business_type, business_id)
);
```

**说明**：
- 将审批流程模板应用到具体的业务实例
- 例如：付款申请PD20251111-0001使用"付款申请审批流程"

### 5. 审批记录表

**表名**：`approval_records`

**用途**：记录每个审批人的审批结果

```sql
CREATE TABLE approval_records (
    id UUID PRIMARY KEY,
    instance_id UUID REFERENCES business_approval_instances(id) ON DELETE CASCADE,
    step_id UUID REFERENCES approval_steps(id),
    step_order INTEGER NOT NULL,                -- 环节顺序
    approver_user_id UUID REFERENCES auth.users(id),
    approver_name TEXT NOT NULL,               -- 审批人姓名
    approval_status TEXT NOT NULL CHECK (approval_status IN ('pending', 'approved', 'rejected')),
    approval_comment TEXT,                     -- 审批意见
    signature_image_url TEXT,                  -- 签名图片URL（WebP格式，七牛云存储）
    signature_base64 TEXT,                     -- 签名Base64备份（可选）
    approved_at TIMESTAMP,                     -- 审批时间
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- 唯一约束：一个业务实例的每个环节的每个审批人只能有一条记录
    UNIQUE(instance_id, step_id, approver_user_id)
);
```

**说明**：
- 记录每个审批人在每个环节的审批结果
- 支持签名保存（WebP格式，文件小、加载快）
- 支持审批意见

**签名格式说明**：
- **推荐格式**：WebP（文件小、加载快、质量好）
- **备用格式**：PNG（兼容性好，但文件较大）
- **存储方式**：七牛云存储，数据库只保存URL

---

## ⚙️ 审批流程配置

### 配置流程

```
步骤1：创建审批流程模板
   → 在 approval_workflows 表中创建流程模板
   → 设置流程名称、类型、审批模式

步骤2：配置审批环节
   → 在 approval_steps 表中为流程添加环节
   → 设置环节顺序、名称、描述
   → 设置环节审批模式（并行/串行）

步骤3：配置审批人
   → 在 approval_step_assignments 表中为每个环节配置审批人
   → 可以配置多个审批人
   → 可以标记必需或可选

步骤4：应用到业务实例
   → 创建业务实例时，在 business_approval_instances 中创建记录
   → 关联到审批流程模板
   → 系统自动创建审批记录
```

### 配置示例

#### 示例1：付款申请审批流程

```
流程名称：付款申请审批流程
流程类型：payment_request
审批模式：sequential（串行）

环节1：信息专员审批
  - 顺序：1
  - 审批模式：parallel（并行）
  - 审批人：用户A、用户B（两人都需要审批）

环节2：信息部审核
  - 顺序：2
  - 审批模式：parallel（并行）
  - 审批人：用户C（一人审批即可）

环节3：业务负责人审批
  - 顺序：3
  - 审批模式：parallel（并行）
  - 审批人：用户D、用户E（两人都需要审批）

环节4：财务部审核
  - 顺序：4
  - 审批模式：parallel（并行）
  - 审批人：用户F（一人审批即可）
```

**执行逻辑**：
1. 环节1：用户A和用户B都需要审批（并行），全部通过后进入环节2
2. 环节2：用户C审批（并行），通过后进入环节3
3. 环节3：用户D和用户E都需要审批（并行），全部通过后进入环节4
4. 环节4：用户F审批（并行），通过后整个流程完成

#### 示例2：简单并行审批流程

```
流程名称：简单并行审批流程
流程类型：payment_request
审批模式：parallel（并行）

环节1：多人并行审批
  - 顺序：1
  - 审批模式：parallel（并行）
  - 审批人：用户A、用户B、用户C、用户D（四人全部需要审批）
```

**执行逻辑**：
- 用户A、B、C、D可以任意顺序审批
- 全部通过后流程完成

---

## 🔄 审批执行流程

### 流程1：初始化审批流程

```
触发时机：创建业务实例时（如创建付款申请）

步骤1：创建业务实例审批记录
   → 在 business_approval_instances 中创建记录
   → 关联到审批流程模板
   → 设置 approval_status = 'pending'

步骤2：获取审批流程配置
   → 查询 approval_workflows（流程模板）
   → 查询 approval_steps（所有环节）
   → 查询 approval_step_assignments（所有审批人）

步骤3：创建审批记录
   → 为每个环节的每个审批人创建审批记录
   → 在 approval_records 中插入记录
   → 设置 approval_status = 'pending'

步骤4：更新状态
   → 更新 business_approval_instances.approval_status = 'approving'
   → 如果是串行审批，设置 current_step_order = 1（第一个环节）
```

### 流程2：提交审批（普通用户）

```
触发时机：审批人点击"审批"按钮并完成签名

步骤1：验证权限
   → 检查当前用户是否在审批配置中
   → 检查是否已审批过
   → 检查当前环节是否可以审批（串行审批需要检查前置环节）

步骤2：处理签名图片（WebP格式）
   → 将Canvas画布转换为WebP格式图片
   → 压缩签名图片（优化文件大小，quality=0.9）
   → 上传到七牛云存储
   → 获取WebP格式签名图片URL

步骤3：更新审批记录
   → 更新 approval_records
     - approval_status = 'approved'
     - signature_image_url = 'WebP格式签名URL'
     - approved_at = NOW()

步骤4：检查当前环节是否完成
   → 查询当前环节的所有审批人
   → 检查是否达到最少通过人数（min_approvers）
   → 如果是并行审批，检查所有必需审批人是否都已审批

步骤5：判断流程状态
   → 如果当前环节未完成：保持 'approving' 状态
   → 如果当前环节已完成：
     - 如果是串行审批：检查是否还有下一环节
       - 有下一环节：更新 current_step_order，保持 'approving'
       - 无下一环节：流程完成
     - 如果是并行审批：检查是否所有环节都完成
       - 全部完成：流程完成
       - 未全部完成：保持 'approving'

步骤6：完成审批流程
   → 更新 business_approval_instances.approval_status = 'approved'
   → 触发业务回调（如更新付款申请状态）
```

### 流程3：管理员直接审批

```
触发时机：管理员点击"直接审批"按钮

步骤1：验证权限
   → 检查当前用户是否为管理员

步骤2：跳过审批流程
   → 更新 business_approval_instances.approval_status = 'approved'
   → 可选：在审批记录中记录管理员审批（但不要求签名）

步骤3：触发业务回调
   → 更新业务实例状态（如付款申请状态）
```

---

## 🧩 组件接口设计

### 1. 审批流程配置接口

#### 创建审批流程模板

```
接口：createApprovalWorkflow
参数：
  - workflow_name: 流程名称
  - workflow_type: 流程类型
  - approval_mode: 审批模式（parallel/sequential）
  - steps: 环节配置数组
    - step_name: 环节名称
    - step_order: 环节顺序
    - approval_mode: 环节审批模式
    - approvers: 审批人配置数组
      - user_id: 用户ID
      - user_name: 用户姓名
      - is_required: 是否必需

返回：
  - workflow_id: 流程模板ID
```

#### 更新审批流程模板

```
接口：updateApprovalWorkflow
参数：
  - workflow_id: 流程模板ID
  - steps: 更新的环节配置

返回：
  - success: 是否成功
```

### 2. 审批执行接口

#### 初始化业务实例审批流程

```
接口：initBusinessApproval
参数：
  - business_type: 业务类型（如：payment_request）
  - business_id: 业务ID
  - workflow_id: 流程模板ID（可选，如果不提供则使用默认流程）

返回：
  - instance_id: 审批实例ID
  - approval_status: 初始状态
```

#### 提交审批

```
接口：submitApproval
参数：
  - instance_id: 审批实例ID
  - approval_status: 审批结果（approved/rejected）
  - signature_image_url: 签名图片URL（WebP格式）
  - signature_base64: 签名Base64（可选，用于备份）
  - approval_comment: 审批意见（可选）

返回：
  - success: 是否成功
  - approval_status: 当前审批状态
  - current_step: 当前环节
  - all_completed: 是否全部完成
```

#### 查询审批状态

```
接口：getApprovalStatus
参数：
  - instance_id: 审批实例ID

返回：
  - approval_status: 审批状态
  - current_step_order: 当前环节
  - steps: 环节状态数组
    - step_name: 环节名称
    - step_order: 环节顺序
    - status: 环节状态（pending/approved/rejected）
    - approvers: 审批人状态数组
      - name: 审批人姓名
      - status: 审批状态
      - signature_url: 签名URL
      - approved_at: 审批时间
  - all_completed: 是否全部完成
```

### 3. 前端组件接口

#### 审批按钮组件

```
组件：ApprovalButton
属性：
  - instanceId: 审批实例ID
  - businessType: 业务类型
  - onApprovalComplete: 审批完成回调

功能：
  - 显示"审批"按钮（如果可审批）
  - 显示"已审批"状态（如果已审批）
  - 点击后弹出签名对话框
```

#### 审批状态显示组件

```
组件：ApprovalStatus
属性：
  - instanceId: 审批实例ID
  - showSignatures: 是否显示签名预览

功能：
  - 显示所有环节的审批状态
  - 显示每个审批人的状态和签名
  - 显示当前审批进度
```

#### 签名组件

```
组件：SignaturePad
属性：
  - open: 是否显示
  - onConfirm: 确认回调（返回签名数据）
  - onCancel: 取消回调

功能：
  - 手写签名画布（Canvas）
  - 清除签名
  - 确认/取消按钮
  - 自动转换为WebP格式
  - 图片压缩优化

签名处理逻辑：
1. 用户手写签名（Canvas绘制）
2. 点击"确定"按钮
3. Canvas转换为WebP格式（canvas.toBlob('image/webp', quality=0.9)）
4. 如果浏览器不支持WebP，自动降级为PNG格式
5. 返回WebP格式的Blob或Base64
6. 上传到七牛云存储（文件扩展名：.webp）
7. 保存WebP格式URL到数据库
```

---

## 📝 使用场景示例

### 场景1：付款申请审批

```
1. 创建付款申请审批流程模板
   - 流程名称：付款申请审批流程
   - 环节1：信息专员审批（用户A、用户B）
   - 环节2：财务部审核（用户C）

2. 创建付款申请时
   - 自动初始化审批流程
   - 创建审批记录

3. 用户A审批
   - 手写签名
   - 提交审批
   - 环节1：1/2完成

4. 用户B审批
   - 手写签名
   - 提交审批
   - 环节1：2/2完成 → 进入环节2

5. 用户C审批
   - 手写签名
   - 提交审批
   - 环节2：1/1完成 → 流程完成
   - 自动更新付款申请状态为 Approved
```

### 场景2：开票申请审批

```
1. 创建开票申请审批流程模板
   - 流程名称：开票申请审批流程
   - 环节1：业务负责人审批（用户D）
   - 环节2：财务部审核（用户E）

2. 创建开票申请时
   - 自动初始化审批流程
   - 创建审批记录

3. 用户D审批 → 进入环节2
4. 用户E审批 → 流程完成
```

### 场景3：费用报销审批

```
1. 创建费用报销审批流程模板
   - 流程名称：费用报销审批流程
   - 环节1：部门负责人审批（用户F）
   - 环节2：财务部审核（用户G、用户H，两人都需要）

2. 创建费用报销时
   - 自动初始化审批流程
   - 创建审批记录

3. 用户F审批 → 进入环节2
4. 用户G审批 → 环节2：1/2完成
5. 用户H审批 → 环节2：2/2完成 → 流程完成
```

---

## 📊 状态管理

### 审批流程状态

```
pending（待审批）
  → 业务实例刚创建，审批流程未初始化

approving（审批中）
  → 审批流程已初始化，正在审批中
  → 可能有多个环节，当前环节进行中

approved（已审批）
  → 所有环节都已完成，审批通过
  → 可以执行业务操作（如付款）

rejected（已拒绝）
  → 某个审批人拒绝了申请
  → 流程终止
```

### 环节状态

```
pending（待审批）
  → 环节未开始（串行审批中，前置环节未完成）

approving（审批中）
  → 环节进行中，等待审批人审批

approved（已通过）
  → 环节已完成，达到最少通过人数

rejected（已拒绝）
  → 环节被拒绝，流程终止
```

### 审批人状态

```
pending（待审批）
  → 审批人还未审批

approved（已通过）
  → 审批人已审批通过

rejected（已拒绝）
  → 审批人拒绝了申请
```

---

## 🔐 权限控制

### 1. 审批按钮显示逻辑

```
检查条件：
1. 当前用户是否为管理员？
   - 是 → 显示"直接审批"按钮
   - 否 → 继续检查

2. 当前用户是否在审批配置中？
   - 否 → 不显示按钮
   - 是 → 继续检查

3. 当前用户是否已审批？
   - 是 → 显示"已审批"状态
   - 否 → 继续检查

4. 当前环节是否可以审批？（串行审批）
   - 否 → 显示"等待前置环节"
   - 是 → 显示"审批"按钮
```

### 2. 后端权限验证

```
在 submitApproval 函数中：

1. 检查用户是否在审批配置中
   → 查询 approval_step_assignments
   → 验证当前用户是否为审批人

2. 检查是否已审批过
   → 查询 approval_records
   → 验证是否已存在审批记录

3. 检查环节是否可以审批（串行审批）
   → 查询前置环节状态
   → 验证前置环节是否已完成

4. 检查审批模式
   → 如果是串行审批，检查当前环节
   → 如果是并行审批，检查所有环节
```

---

## 🎯 核心优势

### 1. 高度可配置

- ✅ 可以自由设置审批环节
- ✅ 可以自由配置审批人
- ✅ 支持并行和串行审批
- ✅ 支持多业务类型复用

### 2. 灵活性强

- ✅ 同一套系统可用于不同业务
- ✅ 可以动态调整审批流程
- ✅ 支持复杂的审批场景

### 3. 易于维护

- ✅ 统一的审批逻辑
- ✅ 统一的数据库结构
- ✅ 统一的组件接口

### 4. 可扩展性

- ✅ 可以轻松添加新的审批环节
- ✅ 可以轻松添加新的审批人
- ✅ 可以支持新的业务类型

---

## 📋 实施步骤

### 阶段1：数据库设计

1. 创建审批流程模板表
2. 创建审批环节配置表
3. 创建审批人配置表
4. 创建业务实例审批配置表
5. 创建审批记录表

### 阶段2：核心函数开发

1. 创建审批流程模板函数
2. 初始化业务审批流程函数
3. 提交审批函数
4. 查询审批状态函数
5. 检查审批完成函数

### 阶段3：前端组件开发

1. 审批流程配置组件（管理后台）
2. 审批按钮组件
3. 审批状态显示组件
4. 签名组件

### 阶段4：业务集成

1. 付款申请集成
2. 开票申请集成
3. 其他业务集成

---

## ✅ 总结

### 核心特点

1. **通用性**：一套系统适用于所有审批场景
2. **灵活性**：可以自由配置审批环节和审批人
3. **可扩展性**：易于添加新的业务类型和审批规则
4. **易用性**：统一的接口和组件，易于使用和维护

### 关键设计点

1. **流程模板化**：审批流程作为模板，可以复用
2. **环节可配置**：每个环节可以独立配置
3. **审批人可配置**：每个环节可以配置多个审批人
4. **模式可选**：支持并行和串行两种审批模式
5. **状态透明**：实时显示审批状态和进度

---

## 🖼️ 签名图片格式优化（WebP）

### WebP格式优势

#### 1. 文件大小对比

```
签名图片（典型尺寸：800x300px）：
- PNG格式：约 50-100 KB
- WebP格式：约 10-20 KB（压缩率 70-80%）
- 文件大小减少：70-80%
```

#### 2. 加载速度提升

```
移动端网络环境（4G）：
- PNG格式：加载时间 0.5-1秒
- WebP格式：加载时间 0.1-0.2秒
- 加载速度提升：5倍
```

#### 3. 质量对比

```
- WebP格式：质量与PNG相当，但文件更小
- 支持透明度：与PNG相同
- 浏览器兼容性：现代浏览器全面支持
```

### 签名处理流程

```
步骤1：用户手写签名
   → Canvas画布绘制签名

步骤2：转换为WebP格式
   → 使用 canvas.toBlob('image/webp', quality=0.9)
   → quality参数：0.9（高质量，文件仍很小）
   → 如果浏览器不支持WebP，自动降级为PNG

步骤3：图片压缩（可选）
   → 如果签名图片过大，可以进一步压缩
   → 保持清晰度的同时减小文件大小

步骤4：上传到七牛云
   → 文件命名：signature-{request_id}-{user_id}-{timestamp}.webp
   → 上传目录：payment-approvals/signatures/
   → 获取WebP格式URL

步骤5：保存到数据库
   → signature_image_url = 'https://...signature.webp'
   → 可选：保存Base64备份（用于兼容性）
```

### PDF生成优化

#### 方案1：直接插入WebP图片（推荐）

```
PDF生成时：
1. 从数据库获取签名图片URL（WebP格式）
2. 下载WebP图片
3. PDF库支持WebP格式：直接插入
4. 如果PDF库不支持WebP：转换为PNG后插入

优势：
- PDF文件更小（WebP图片占用空间小）
- 加载速度快
- 质量好
```

#### 方案2：转换为PNG后插入（兼容方案）

```
PDF生成时：
1. 从数据库获取签名图片URL（WebP格式）
2. 下载WebP图片
3. 转换为PNG格式（临时）
4. 插入到PDF
5. 删除临时PNG文件

优势：
- 兼容所有PDF库
- 最终PDF文件仍较小（因为源文件是WebP）
```

### 浏览器兼容性

#### WebP支持情况

```
✅ 完全支持（推荐使用WebP）：
- Chrome 23+
- Edge 18+
- Firefox 65+
- Safari 14+
- 移动端浏览器（iOS Safari 14+, Android Chrome）

⚠️ 不支持（需要降级）：
- IE 11及以下
- 旧版Safari（13及以下）

降级方案：
- 检测浏览器是否支持WebP
- 不支持则使用PNG格式
- 代码自动处理，用户无感知
```

### 性能优化效果

#### 文件大小优化

```
单个签名图片：
- 优化前（PNG）：50-100 KB
- 优化后（WebP）：10-20 KB
- 减少：70-80%

多个签名（4个审批人）：
- 优化前：200-400 KB
- 优化后：40-80 KB
- 减少：80%
```

#### 加载速度优化

```
移动端加载签名图片：
- 优化前：2-4秒（4个PNG图片）
- 优化后：0.4-0.8秒（4个WebP图片）
- 提升：5倍
```

#### PDF文件大小优化

```
包含4个签名的审批单PDF：
- 优化前：500-800 KB
- 优化后：200-400 KB
- 减少：50-60%
```

### 实现建议

#### 1. 前端签名组件

```
签名转换逻辑：
1. 优先尝试WebP格式
2. 检测浏览器支持情况
3. 不支持则降级为PNG
4. 返回格式信息（用于后续处理）

代码逻辑：
- canvas.toBlob((blob) => {
    if (blob.type === 'image/webp') {
      // WebP格式，直接使用
    } else {
      // PNG格式，降级处理
    }
  }, 'image/webp', 0.9);
```

#### 2. 后端存储

```
数据库字段：
- signature_image_url: 存储WebP格式URL（主要）
- signature_base64: 存储Base64备份（可选，用于兼容）

七牛云存储：
- 文件格式：.webp
- 文件命名：signature-{id}-{timestamp}.webp
- 目录结构：payment-approvals/signatures/
```

#### 3. PDF生成

```
PDF插入逻辑：
1. 优先使用WebP格式（如果PDF库支持）
2. 不支持则转换为PNG后插入
3. 保持PDF文件大小优化
```

---

**文档创建时间**：2025-11-11  
**版本**：v1.1（添加WebP格式优化说明）  
**状态**：设计方案

