# 恢复默认按钮功能说明

## ✅ 功能已实现

在"修改合作方运费"对话框中添加了**"恢复默认"按钮**！

---

## 📊 按钮布局

### 对话框底部按钮（从左到右）

```
┌─────────────────────────────────────────────────┐
│                                    [DialogFooter]│
│  [取消]  [🔄 恢复默认]  [💾 保存修改]            │
└─────────────────────────────────────────────────┘
```

---

## 🎯 功能说明

### "恢复默认"按钮的作用

**清除手动修改标记，让系统自动重新计算该合作方的应收金额**

#### 执行流程

```
点击"恢复默认"
    ↓
弹出确认对话框
    ↓
确认后执行：
  1. 清除手动修改标记
     UPDATE logistics_partner_costs
     SET is_manually_modified = FALSE
     
  2. 触发成本重算
     调用 modify_logistics_record_chain_with_recalc
     
  3. 系统重新计算应收金额
     根据链路配置自动计算
     
  4. 显示成功提示
     ✅ 已恢复为系统自动计算
     
  5. 刷新数据
     fetchReportData()
```

---

## 💡 使用场景

### 场景1：撤销手动修改

```
1. 用户之前手动修改了应收：1000 → 1200
2. 现在想恢复为系统计算的 1000
3. 点击"恢复默认"按钮
4. 确认
5. ✅ 应收恢复为系统计算的值
6. ✅ is_manually_modified = FALSE
```

### 场景2：项目配置变化后重新计算

```
1. 用户手动修改了应收：1000 → 1200
2. 项目管理员修改了税点：6% → 3%
3. 用户想要使用新税点重新计算
4. 点击"恢复默认"按钮
5. ✅ 使用新税点自动计算
6. ✅ 后续链路修改也会自动计算（不再保护）
```

### 场景3：误操作修正

```
1. 用户误修改了应收
2. 不确定原来的值是多少
3. 点击"恢复默认"
4. ✅ 恢复为系统计算的正确值
```

---

## 🎨 界面效果

### 确认对话框

```
┌─────────────────────────────────────────┐
│ ⚠️ 确认恢复默认                           │
├─────────────────────────────────────────┤
│ 确定要将运单 YDN20251022-001 的应收     │
│ 金额恢复为系统自动计算吗？               │
│ 此操作将清除手动修改标记并重新计算。     │
├─────────────────────────────────────────┤
│              [取消]  [确认]               │
└─────────────────────────────────────────┘
```

### 成功提示

```
✅ 成功
已恢复为系统自动计算，最高级合作方"中粮可乐"的运费已重新计算
```

---

## 🔧 技术实现

### 1. 新增函数：handleResetToAutoCalculation

**位置**：`src/pages/PaymentRequest.tsx` 第600-650行

**功能**：
```typescript
const handleResetToAutoCalculation = async () => {
  // 1. 清除手动修改标记
  await supabase
    .from('logistics_partner_costs')
    .update({
      is_manually_modified: false,
      updated_at: new Date().toISOString()
    })
    .eq('logistics_record_id', recordId)
    .eq('partner_id', partnerId)
    .eq('level', maxLevel);
  
  // 2. 触发重算
  await supabase.rpc('modify_logistics_record_chain_with_recalc', {
    p_record_id: recordId,
    p_chain_name: currentChainName
  });
  
  // 3. 提示和刷新
  toast({ title: "成功", description: "已恢复为系统自动计算..." });
  fetchReportData();
};
```

### 2. 修改按钮布局

**位置**：`src/pages/PaymentRequest.tsx` 第1631-1655行

**新增**：
```tsx
<ConfirmDialog
  title="确认恢复默认"
  description="确定要将运单 xxx 的应收金额恢复为系统自动计算吗？..."
  onConfirm={handleResetToAutoCalculation}
>
  <Button variant="secondary" disabled={isSaving}>
    {isSaving ? <Loader2 .../> : "🔄"}
    恢复默认
  </Button>
</ConfirmDialog>
```

---

## 📊 与其他按钮的对比

| 按钮 | 功能 | 数据变化 | is_manually_modified |
|-----|------|---------|---------------------|
| **取消** | 关闭对话框 | 无变化 | 不变 |
| **恢复默认** 🆕 | 清除标记并重算 | 恢复系统计算值 | FALSE |
| **保存修改** | 保存用户输入值 | 更新为用户值 | TRUE |

---

## 🎯 用户体验流程

### 操作1：保存手动修改

```
打开对话框
    ↓
修改金额：1000 → 1200
    ↓
点击"保存修改"
    ↓
✅ is_manually_modified = TRUE
✅ 金额 = 1200（用户值）
✅ 后续重算会保护此值
```

### 操作2：恢复默认计算

```
打开对话框
    ↓
点击"恢复默认"
    ↓
确认
    ↓
✅ is_manually_modified = FALSE
✅ 金额 = 系统计算值
✅ 后续重算会自动计算
```

---

## ⚡ 重要特性

### 1. 带确认对话框

避免误操作，点击后会弹出确认框。

### 2. 自动触发重算

不只是清除标记，还会立即重新计算，用户能马上看到系统计算的值。

### 3. 智能提示

```
成功提示中包含：
- 合作方名称
- 明确说明"已恢复为系统自动计算"
- 提示"已重新计算"
```

### 4. 状态管理

使用统一的 `isSaving` 状态，避免重复点击。

---

## 🧪 测试场景

### 测试1：基础恢复功能

```
1. 打开一个运单的修改应收对话框
2. 查看当前金额（如 3186.81）
3. 点击"恢复默认"
4. 确认
5. ✅ 验证：金额可能变化（恢复为系统计算值）
6. ✅ 验证：再次修改链路时，会自动重算（不再保护）
```

### 测试2：恢复后再手动修改

```
1. 恢复默认
2. 关闭对话框
3. 再次打开修改应收对话框
4. 修改金额
5. 保存
6. ✅ 验证：is_manually_modified 又变成 TRUE
```

### 测试3：取消操作

```
1. 点击"恢复默认"
2. 在确认对话框中点击"取消"
3. ✅ 验证：不执行任何操作
4. ✅ 验证：金额保持不变
```

---

## 📝 按钮样式

### 按钮变体

| 按钮 | variant | 颜色 | 用途 |
|-----|---------|------|------|
| 取消 | outline | 灰色 | 次要操作 |
| 恢复默认 | secondary | 蓝灰色 | 中性操作 |
| 保存修改 | default | 主题色 | 主要操作 |

### 图标

- 🔄 恢复默认（刷新/重置的含义）
- 💾 保存修改（Save图标）

---

## ⚠️ 注意事项

### 1. 恢复默认会立即生效

点击确认后，会立即：
- 清除手动修改标记
- 重新计算成本
- 刷新页面数据

### 2. 恢复后的值可能不同

如果项目配置（税点/利润率）变化了，恢复后的值会基于最新配置计算。

### 3. 可以反复操作

- 恢复默认 → 可以再手动修改
- 手动修改 → 可以再恢复默认
- 灵活切换

---

## 🎯 实现总结

| 项目 | 状态 |
|-----|------|
| 新增函数 | ✅ handleResetToAutoCalculation |
| 修改DialogFooter | ✅ 添加恢复默认按钮 |
| 添加确认对话框 | ✅ 防止误操作 |
| Linter检查 | ✅ 无错误 |
| 功能测试 | ⏳ 待用户测试 |

---

## 📸 按钮位置

```
修改合作方运费对话框
├─ 标题：修改合作方运费
├─ 运单编号：YDN20251022-001
├─ 合作方列表
│   ├─ 中粮可乐 (3级) 最高级 [可编辑]
│   ├─ 数创 (2级) [不可编辑]
│   └─ 张海宽 (1级) [不可编辑]
├─ 说明：只能修改最高级...
└─ [取消]  [🔄 恢复默认]  [💾 保存修改]
           ↑ 新增按钮
```

---

**功能已完成！刷新页面后即可看到"恢复默认"按钮！** 🎉

**使用方法**：
1. 打开修改应收对话框
2. 点击"恢复默认"
3. 确认
4. ✅ 应收金额恢复为系统自动计算的值
5. ✅ 后续重算不再保护（因为清除了手动修改标记）

