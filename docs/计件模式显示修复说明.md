# è®¡ä»¶æ¨¡å¼ï¼ˆbilling_type_id = 4ï¼‰æ˜¾ç¤ºä¿®å¤è¯´æ˜

## ğŸ“… æ—¥æœŸ
2025-11-20

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š
1. è¿å•åˆ—è¡¨çš„"æ•°é‡"åˆ—ï¼Œå¯¹äºè®¡ä»¶æ¨¡å¼ï¼ˆbilling_type_id = 4ï¼‰æ˜¾ç¤ºä¸º `-`ï¼Œæ²¡æœ‰æ˜¾ç¤ºè£…å¸è´§ä»¶æ•°
2. æœ‰æ•ˆæ•°é‡æ˜¾ç¤ºä¸º 1256.000ï¼ˆå®é™…æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºç¡®å®æœ‰ 1256 ä»¶è´§ç‰©ï¼‰
3. ç»Ÿè®¡åˆè®¡æ²¡æœ‰è®¡ä»¶æ¨¡å¼çš„ç»Ÿè®¡

## ğŸ“Š é—®é¢˜åˆ†æ

### 1. å‰ç«¯æ˜¾ç¤ºé€»è¾‘ç¼ºå¤±

`LogisticsTable.tsx` ä¸­çš„ `getQuantityDisplay` å‡½æ•°åªå¤„ç†äº† 3 ç§è®¡è´¹æ¨¡å¼ï¼š
- case 1: è®¡é‡ï¼ˆå¨ï¼‰
- case 2: è®¡è½¦ï¼ˆè½¦ï¼‰
- case 3: è®¡æ–¹ï¼ˆç«‹æ–¹ï¼‰
- **ç¼ºå°‘ case 4: è®¡ä»¶ï¼ˆä»¶ï¼‰**

### 2. ç»Ÿè®¡é€»è¾‘ç¼ºå¤±

`summaryTotals` åªç»Ÿè®¡äº†è®¡é‡ã€è®¡è½¦ã€è®¡æ–¹ï¼Œæ²¡æœ‰è®¡ä»¶ã€‚

### 3. åç«¯ç»Ÿè®¡å‡½æ•°ç¼ºå¤±

`get_logistics_summary_and_records_enhanced_1116` å‡½æ•°è¿”å›çš„ summary å¯¹è±¡æ²¡æœ‰ `totalPiecesLoading` å’Œ `totalPiecesUnloading` å­—æ®µã€‚

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### å‰ç«¯ä¿®å¤ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰

#### 1. `src/pages/BusinessEntry/components/LogisticsTable.tsx`

**ä¿®æ”¹ç‚¹ 1ï¼šæ·»åŠ è®¡ä»¶æ¨¡å¼æ˜¾ç¤º**

```typescript
const getQuantityDisplay = (record: LogisticsRecord) => {
  const billingTypeId = record.billing_type_id || 1;
  const loading = record.loading_weight || 0;
  const unloading = record.unloading_weight || 0;
  switch (billingTypeId) {
    case 1: return `${(loading || 0).toFixed(2)} / ${(unloading || 0).toFixed(2)} å¨`;
    case 2: return `1 è½¦`;
    case 3: return `${(loading || 0).toFixed(2)} / ${(unloading || 0).toFixed(2)} ç«‹æ–¹`;
    case 4: return `${(loading || 0).toFixed(0)} / ${(unloading || 0).toFixed(0)} ä»¶`; // âœ… æ–°å¢
    default: return '-';
  }
};
```

**ä¿®æ”¹ç‚¹ 2ï¼šæ·»åŠ è®¡ä»¶ç»Ÿè®¡**

```typescript
const summaryTotals = useMemo(() => {
  const totals = {
    weight: { loading: 0, unloading: 0 },
    trips: { count: 0 },
    volume: { loading: 0, unloading: 0 },
    pieces: { loading: 0, unloading: 0 }, // âœ… æ–°å¢
    currentCost: 0,
    extraCost: 0,
    driverPayable: 0,
  };

  records.forEach(r => {
    const billingTypeId = r.billing_type_id || 1;
    if (billingTypeId === 1) {
      totals.weight.loading += r.loading_weight || 0;
      totals.weight.unloading += r.unloading_weight || 0;
    } else if (billingTypeId === 2) {
      totals.trips.count += 1;
    } else if (billingTypeId === 3) {
      totals.volume.loading += r.loading_weight || 0;
      totals.volume.unloading += r.unloading_weight || 0;
    } else if (billingTypeId === 4) { // âœ… æ–°å¢
      totals.pieces.loading += r.loading_weight || 0;
      totals.pieces.unloading += r.unloading_weight || 0;
    }
    totals.currentCost += r.current_cost || 0;
    totals.extraCost += r.extra_cost || 0;
    totals.driverPayable += (r.current_cost || 0) + (r.extra_cost || 0);
  });

  return totals;
}, [records]);
```

#### 2. `src/pages/BusinessEntry/index.tsx`

**æ·»åŠ è®¡ä»¶åˆè®¡æ˜¾ç¤º**

```tsx
{totalSummary.totalPiecesLoading > 0 && (
  <span className="whitespace-nowrap">
    è®¡ä»¶åˆè®¡: è£… <span className="font-bold text-primary">{totalSummary.totalPiecesLoading.toFixed(0)}ä»¶</span> / 
    å¸ <span className="font-bold text-primary">{totalSummary.totalPiecesUnloading.toFixed(0)}ä»¶</span>
  </span>
)}
```

#### 3. `src/pages/BusinessEntry/hooks/useLogisticsData.ts`

**æ·»åŠ è®¡ä»¶ç»Ÿè®¡å­—æ®µç±»å‹**

```typescript
export interface TotalSummary {
  totalCurrentCost: number;
  totalExtraCost: number;
  totalDriverPayableCost: number;
  actualCount: number;
  returnCount: number;
  totalWeightLoading: number;
  totalWeightUnloading: number;
  totalTripsLoading: number;
  totalVolumeLoading: number;
  totalVolumeUnloading: number;
  totalPiecesLoading: number; // âœ… æ–°å¢
  totalPiecesUnloading: number; // âœ… æ–°å¢
}

const INITIAL_SUMMARY: TotalSummary = {
  totalCurrentCost: 0,
  totalExtraCost: 0,
  totalDriverPayableCost: 0,
  actualCount: 0,
  returnCount: 0,
  totalWeightLoading: 0,
  totalWeightUnloading: 0,
  totalTripsLoading: 0,
  totalVolumeLoading: 0,
  totalVolumeUnloading: 0,
  totalPiecesLoading: 0, // âœ… æ–°å¢
  totalPiecesUnloading: 0, // âœ… æ–°å¢
};
```

### åç«¯ä¿®å¤ï¼ˆ1ä¸ªSQLæ–‡ä»¶ï¼‰

#### `supabase/migrations/20251120_update_summary_support_pieces.sql`

**ä¿®æ”¹ç»Ÿè®¡å‡½æ•°ï¼Œæ·»åŠ è®¡ä»¶ç»Ÿè®¡**

```sql
summary AS (
    SELECT 
        ...å…¶ä»–å­—æ®µ...,
        COALESCE(SUM(CASE WHEN COALESCE(lr.billing_type_id, 1) = 4 
            THEN COALESCE(lr.loading_weight, 0) ELSE 0 END), 0) as total_pieces_loading,
        COALESCE(SUM(CASE WHEN COALESCE(lr.billing_type_id, 1) = 4 
            THEN COALESCE(lr.unloading_weight, 0) ELSE 0 END), 0) as total_pieces_unloading
    FROM public.logistics_records lr
    ...
)

-- åœ¨è¿”å›çš„ jsonb ä¸­æ·»åŠ 
SELECT jsonb_build_object(
    'summary', (
        SELECT jsonb_build_object(
            ...å…¶ä»–å­—æ®µ...,
            'totalPiecesLoading', s.total_pieces_loading,
            'totalPiecesUnloading', s.total_pieces_unloading
        )
        FROM summary s
    ),
    ...
)
```

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤ 1ï¼šæ‰§è¡Œåç«¯SQLä¿®å¤

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```
supabase/migrations/20251120_update_summary_support_pieces.sql
```

### æ­¥éª¤ 2ï¼šå‰ç«¯ä»£ç å·²è‡ªåŠ¨ä¿®å¤

å‰ç«¯ä»£ç å·²ç»é€šè¿‡ AI è‡ªåŠ¨ä¿®å¤ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œã€‚

### æ­¥éª¤ 3ï¼šåˆ·æ–°é¡µé¢æµ‹è¯•

1. åˆ·æ–°æµè§ˆå™¨é¡µé¢
2. æŸ¥çœ‹è®¡ä»¶æ¨¡å¼çš„è¿å•
3. ç¡®è®¤"æ•°é‡"åˆ—æ˜¾ç¤ºä¸º `1256 / 1256 ä»¶` æˆ–ç±»ä¼¼æ ¼å¼
4. ç¡®è®¤ç»Ÿè®¡æ æ˜¾ç¤º `è®¡ä»¶åˆè®¡: è£… 1256ä»¶ / å¸ 1256ä»¶`

## âœ… é¢„æœŸç»“æœ

ä¿®å¤åï¼Œå¯¹äº `billing_type_id = 4`ï¼ˆè®¡ä»¶æ¨¡å¼ï¼‰çš„è¿å•ï¼š

### 1. åˆ—è¡¨æ˜¾ç¤º

| è¿å•ç¼–å· | æ•°é‡ | å¸æœºåº”æ”¶ |
|---------|------|---------|
| YDN20251119-002 | `1256 / 1256 ä»¶` | Â¥8,930.16 |
| YDN20251119-001 | `1256 / 1256 ä»¶` | Â¥9,043.20 |

âœ… ä¸å†æ˜¾ç¤º `-`

### 2. ç»Ÿè®¡æ æ˜¾ç¤º

```
è®¡ä»¶åˆè®¡: è£… 2512ä»¶ / å¸ 2512ä»¶
```

### 3. æ•°æ®åº“å­—æ®µ

| unit_price | effective_quantity | current_cost |
|-----------|-------------------|--------------|
| 7.11 | 1256.000 | 8930.16 |
| 7.20 | 1256.000 | 9043.20 |

âœ… æœ‰æ•ˆæ•°é‡æ­£ç¡®ä¿å­˜
âœ… è¿è´¹æ­£ç¡®è®¡ç®—ï¼ˆå•ä»· Ã— æœ‰æ•ˆæ•°é‡ï¼‰

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. æœ‰æ•ˆæ•°é‡çš„å«ä¹‰

å¯¹äºä¸åŒçš„è®¡è´¹æ¨¡å¼ï¼Œ`loading_weight` å’Œ `unloading_weight` å­—æ®µçš„å«ä¹‰ä¸åŒï¼š

- `billing_type_id = 1`ï¼ˆè®¡é‡ï¼‰ï¼šå•ä½æ˜¯**å¨**
- `billing_type_id = 2`ï¼ˆè®¡è½¦ï¼‰ï¼šå›ºå®šä¸º 1ï¼Œä¸æ˜¾ç¤ºè£…å¸è´§æ•°é‡
- `billing_type_id = 3`ï¼ˆè®¡æ–¹ï¼‰ï¼šå•ä½æ˜¯**ç«‹æ–¹**
- `billing_type_id = 4`ï¼ˆè®¡ä»¶ï¼‰ï¼šå•ä½æ˜¯**ä»¶**

### 2. æ˜¾ç¤ºæ ¼å¼

- è®¡é‡ã€è®¡æ–¹ï¼šæ˜¾ç¤º2ä½å°æ•°ï¼ˆå¦‚ `10.50 å¨`ï¼‰
- è®¡ä»¶ï¼šæ˜¾ç¤ºæ•´æ•°ï¼ˆå¦‚ `1256 ä»¶`ï¼‰
- è®¡è½¦ï¼šå›ºå®šæ˜¾ç¤º `1 è½¦`

### 3. æœ‰æ•ˆæ•°é‡è®¡ç®—

è®¡ä»¶æ¨¡å¼çš„æœ‰æ•ˆæ•°é‡è®¡ç®—é€»è¾‘ä¸è®¡é‡ã€è®¡æ–¹ç›¸åŒï¼Œæ ¹æ®é¡¹ç›®çš„ `effective_quantity_type` é…ç½®ï¼š
- `'loading'`ï¼šä½¿ç”¨è£…è´§ä»¶æ•°
- `'unloading'`ï¼šä½¿ç”¨å¸è´§ä»¶æ•°
- `'min_value'`ï¼šä½¿ç”¨è£…è´§å’Œå¸è´§ä»¶æ•°ä¸­çš„è¾ƒå°å€¼

## ğŸ¯ éªŒè¯æ¸…å•

- [x] å‰ç«¯ä»£ç ä¿®å¤ï¼ˆLogisticsTable.tsxï¼‰
- [x] å‰ç«¯ç»Ÿè®¡ä¿®å¤ï¼ˆindex.tsxï¼‰
- [x] å‰ç«¯ç±»å‹å®šä¹‰ä¿®å¤ï¼ˆuseLogisticsData.tsï¼‰
- [x] åç«¯ç»Ÿè®¡å‡½æ•°ä¿®å¤ï¼ˆSQLè„šæœ¬ï¼‰
- [ ] æ‰§è¡ŒSQLè„šæœ¬
- [ ] åˆ·æ–°é¡µé¢æµ‹è¯•
- [ ] ç¡®è®¤æ•°é‡åˆ—æ˜¾ç¤ºæ­£ç¡®
- [ ] ç¡®è®¤ç»Ÿè®¡æ æ˜¾ç¤ºæ­£ç¡®
- [ ] ç¡®è®¤æœ‰æ•ˆæ•°é‡ä¿å­˜æ­£ç¡®

---

**æ–‡ä»¶ä½ç½®**ï¼š`docs/è®¡ä»¶æ¨¡å¼æ˜¾ç¤ºä¿®å¤è¯´æ˜.md`  
**åˆ›å»ºæ—¶é—´**ï¼š2025-11-20  
**çŠ¶æ€**ï¼šå¾…éªŒè¯

