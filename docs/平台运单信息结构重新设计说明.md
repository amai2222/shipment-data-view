# 平台运单信息结构重新设计说明

## 📋 概述

根据用户需求，重新设计了运单记录中的平台运单信息结构，将原来的"外部运单号"和"其他平台名称"两个独立字段合并为一个统一的"平台运单信息"字段，支持一个平台对应多个运单号的逻辑。

## 🎯 新的数据结构

### 1. 数据结构设计

#### 1.1 平台运单信息 (PlatformTracking)
```typescript
interface PlatformTracking {
  platform: string;        // 平台名称
  trackingNumbers: string[]; // 该平台的运单号列表
}
```

#### 1.2 数据库存储格式
```json
// platform_trackings 字段 (JSONB数组)
[
  {
    "platform": "货拉拉",
    "trackingNumbers": ["HL20250120001", "HL20250120002"]
  },
  {
    "platform": "满帮", 
    "trackingNumbers": ["MB20250120001"]
  },
  {
    "platform": "运满满",
    "trackingNumbers": []
  }
]
```

### 2. 用户操作流程

#### 2.1 新增运单时的操作步骤
1. **添加平台**：点击"添加平台"按钮
2. **输入平台名称**：在平台名称输入框中输入平台名称（如：货拉拉）
3. **添加运单号**：点击"添加运单号"按钮，为该平台添加运单号
4. **继续添加运单号**：如果需要为该平台添加更多运单号，继续点击"添加运单号"
5. **添加其他平台**：如果需要添加其他平台，再次点击"添加平台"按钮
6. **重复步骤2-4**：为其他平台添加名称和运单号

#### 2.2 界面设计特点
- **分层结构**：平台 → 运单号列表
- **动态添加**：可以动态添加/删除平台和运单号
- **实时预览**：显示已添加的有效平台和运单号
- **数据验证**：确保平台名称不为空，运单号列表至少有一个有效运单号

## 🔧 技术实现

### 1. 前端组件

#### 1.1 新的输入组件
- **文件**: `src/components/PlatformTrackingInput.tsx`
- **功能**: 统一的平台运单信息输入组件
- **特性**:
  - 支持添加/删除平台
  - 支持为每个平台添加/删除多个运单号
  - 实时数据验证和预览
  - 响应式设计

#### 1.2 组件接口
```typescript
interface PlatformTrackingInputProps {
  platformTrackings: PlatformTracking[];
  onChange: (platformTrackings: PlatformTracking[]) => void;
  disabled?: boolean;
  className?: string;
}
```

### 2. 数据库结构

#### 2.1 字段定义
```sql
-- 添加新的平台运单信息字段
ALTER TABLE public.logistics_records 
ADD COLUMN IF NOT EXISTS platform_trackings JSONB[] DEFAULT '{}';

-- 创建GIN索引提高查询性能
CREATE INDEX IF NOT EXISTS idx_logistics_records_platform_trackings 
ON public.logistics_records USING GIN (platform_trackings);
```

#### 2.2 数据迁移
- 自动将现有的 `external_tracking_numbers` 和 `other_platform_names` 数据迁移到新的 `platform_trackings` 字段
- 保持数据完整性，不丢失现有信息
- 支持向后兼容

### 3. 数据库函数

#### 3.1 查询函数
- `get_logistics_records_by_platform(p_platform_name TEXT)`: 根据平台名称查询运单
- `get_logistics_records_by_tracking_number(p_tracking_number TEXT)`: 根据运单号查询运单
- `get_all_used_platforms()`: 获取所有使用过的平台名称
- `get_platform_usage_statistics()`: 获取平台使用情况统计

#### 3.2 更新函数
- `update_logistics_record_platform_trackings(UUID, JSONB[])`: 更新运单的平台运单信息
- `validate_platform_trackings(JSONB[])`: 验证平台运单信息的有效性

#### 3.3 触发器
- `clean_platform_trackings()`: 自动清理空的平台运单信息
- 在插入/更新时自动过滤空值

### 4. 导入导出支持

#### 4.1 Excel导入格式
支持以下列名（可选）：
- `外部运单号`: 多个运单号用逗号分隔
- `外部平台`: 对应的平台名称，用逗号分隔  
- `其他平台名称`: 平台名称列表，用逗号分隔

#### 4.2 导入逻辑
```typescript
// 智能合并平台和运单号
const platformMap = new Map();

// 处理外部运单号（需要平台和运单号配对）
if (rowData['外部运单号'] && rowData['外部平台']) {
  // 将平台和运单号配对
}

// 处理其他平台名称（只有平台名称，无运单号）
if (rowData['其他平台名称']) {
  // 添加只有平台名称的记录
}

// 转换为统一格式
platformTrackings = Array.from(platformMap.entries()).map(([platform, trackingNumbers]) => ({
  platform: platform,
  trackingNumbers: trackingNumbers
}));
```

## 📊 数据验证规则

### 1. 平台级别验证
- 平台名称不能为空
- 平台名称长度不超过50个字符
- 最多支持10个平台

### 2. 运单号级别验证
- 运单号不能为空字符串
- 所有平台的运单号总数不超过50个
- 自动过滤空值和重复值

### 3. 数据清理
- 自动去除首尾空格
- 过滤空字符串
- 去重处理

## 🚀 部署步骤

### 1. 数据库更新
```sql
-- 执行数据库结构更新
\i scripts/update-to-platform-tracking-structure.sql
```

### 2. 前端更新
- 所有相关文件已更新
- 新的组件已创建
- 类型定义已更新
- 无需额外配置

### 3. 数据迁移
- 自动迁移现有数据
- 保持数据完整性
- 支持向后兼容

## ✅ 功能特性

### 1. 用户体验
- ✅ 直观的分层结构（平台 → 运单号）
- ✅ 动态添加/删除功能
- ✅ 实时数据预览
- ✅ 响应式设计
- ✅ 数据验证提示

### 2. 数据处理
- ✅ 自动数据清理
- ✅ 空值过滤
- ✅ 重复值处理
- ✅ 数据验证
- ✅ 错误处理

### 3. 查询功能
- ✅ 按平台名称查询
- ✅ 按运单号查询
- ✅ 平台使用统计
- ✅ 数据导出支持

### 4. 导入导出
- ✅ Excel导入支持
- ✅ 智能数据解析
- ✅ 批量处理
- ✅ 错误处理

## 🔄 向后兼容

### 1. 数据兼容
- 现有数据自动迁移
- 保持数据完整性
- 支持旧格式查询

### 2. API兼容
- 新的查询函数
- 保持现有API不变
- 渐进式升级

### 3. 界面兼容
- 新的统一界面
- 更直观的操作流程
- 保持功能完整性

## 📝 使用示例

### 1. 添加平台运单信息
```
平台1: 货拉拉
  - 运单号1: HL20250120001
  - 运单号2: HL20250120002

平台2: 满帮
  - 运单号1: MB20250120001

平台3: 运满满
  - (无运单号，仅记录平台名称)
```

### 2. Excel导入示例
```
外部平台: 货拉拉,满帮
外部运单号: HL20250120001,MB20250120001
其他平台名称: 运满满,滴滴货运
```

导入后会自动合并为：
```json
[
  {"platform": "货拉拉", "trackingNumbers": ["HL20250120001"]},
  {"platform": "满帮", "trackingNumbers": ["MB20250120001"]},
  {"platform": "运满满", "trackingNumbers": []},
  {"platform": "滴滴货运", "trackingNumbers": []}
]
```

这个新的设计完全符合用户的需求：一个平台可以有多个运单号，可以有多个不同的平台，不需要记录运单状态，结构清晰直观。
