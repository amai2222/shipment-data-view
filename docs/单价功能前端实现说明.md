# 单价功能前端实现说明

## 📋 实现内容

在运单管理的新增/编辑运单界面中，在"费用信息"组添加了单价功能。

---

## ✅ 已完成的修改

### 1. 数据结构更新

#### FormData 接口（LogisticsFormDialog.tsx）
```typescript
interface FormData {
  // ... 其他字段
  unitPrice: string; // 单价（元/吨）- 新增
  currentCost: string;
  extraCost: string;
  // ...
}
```

#### Project 类型（types.ts）
```typescript
export interface Project {
  // ... 其他字段
  effective_quantity_type?: 'min_value' | 'loading' | 'unloading'; // 有效数量计算方式
}
```

### 2. 核心计算逻辑

#### 有效数量计算（根据项目配置）
```typescript
const effectiveQuantity = useMemo(() => {
  const loadingWeight = parseFloat(formData.loading_weight) || 0;
  const unloadingWeight = parseFloat(formData.unloading_weight) || 0;
  const project = projects.find(p => p.id === formData.projectId);
  const quantityType = project?.effective_quantity_type || 'min_value';
  
  // 根据项目配置计算
  if (quantityType === 'loading') {
    return loadingWeight;
  } else if (quantityType === 'unloading') {
    return unloadingWeight;
  } else { // min_value
    if (loadingWeight > 0 && unloadingWeight > 0) {
      return Math.min(loadingWeight, unloadingWeight);
    }
    return loadingWeight || unloadingWeight || 0;
  }
}, [formData.loading_weight, formData.unloading_weight, formData.projectId, projects]);
```

#### 计算模式判断
```typescript
// 判断是自动模式还是手动模式
const isAutoMode = useMemo(() => {
  return formData.unitPrice !== '' && parseFloat(formData.unitPrice) > 0;
}, [formData.unitPrice]);
```

**规则**：
- ✅ **有单价** → 自动模式（auto）：自动计算运费
- ✅ **无单价** → 手动模式（manual）：手动输入运费

#### 自动计算运费
```typescript
useEffect(() => {
  if (isAutoMode) {
    const unitPrice = parseFloat(formData.unitPrice) || 0;
    const calculatedCost = unitPrice * effectiveQuantity;
    setFormData(prev => ({
      ...prev,
      currentCost: calculatedCost > 0 ? calculatedCost.toFixed(2) : ''
    }));
  }
}, [isAutoMode, formData.unitPrice, effectiveQuantity]);
```

**计算公式**：
```
current_cost = unit_price × effective_quantity
```

### 3. UI 界面更新

#### 费用信息组布局

```
┌─────────────────────────────────────────────────┐
│ 💰 费用信息              [自动计算模式] ← 状态标识 │
├─────────────────────────────────────────────────┤
│                                                 │
│ 单价（元/吨）                                    │
│ ┌────────────────────────────────────────────┐│
│ │ 输入单价可自动计算运费...                   ││
│ └────────────────────────────────────────────┘│
│ 💡 提示：已输入单价，运费将自动计算              │
│                                                 │
├─────────────────────────────────────────────────┤
│ ▼ 仅在自动模式显示                              │
│ 有效数量（吨）                                   │
│ ┌────────────────────────────────────────────┐│
│ │ 19.800  (自动计算，只读)                    ││
│ └────────────────────────────────────────────┘│
│ 📦 按项目配置：取装货和卸货较小值               │
│                                                 │
├─────────────────────────────────────────────────┤
│ 运费(元) *              │  额外费(元)          │
│ ┌───────────────────┐ │ ┌────────────────┐  │
│ │ 6930.00 (自动计算) │ │ │ 100            │  │
│ └───────────────────┘ │ └────────────────┘  │
│ 计算：350 × 19.800 = 6930                       │
└─────────────────────────────────────────────────┘
```

#### 关键UI特性

1. **模式标识**：
   - 自动模式显示蓝色标签"自动计算模式"

2. **单价输入框**：
   - 始终显示
   - 占位符提示："输入单价可自动计算运费，留空则手动输入运费"
   - 有提示信息显示当前模式

3. **有效数量显示**：
   - 仅在自动模式显示
   - 只读，灰色背景
   - 显示项目配置的计算方式说明

4. **运费输入框**：
   - 自动模式：禁用，灰色背景，加粗字体
   - 手动模式：可输入，正常样式
   - 自动模式下显示计算公式

---

## 🎯 用户体验流程

### 场景1：自动计算模式

```
1. 用户选择项目
   → 系统读取项目的 effective_quantity_type 配置
   
2. 用户输入单价：350 元/吨
   → 系统切换到"自动计算模式"
   → 显示蓝色标签
   
3. 用户输入装货重量：20 吨
   用户输入卸货重量：19.8 吨
   → 系统根据项目配置计算有效数量：19.8 吨
   → 显示有效数量（只读）
   
4. 系统自动计算运费
   → current_cost = 350 × 19.8 = 6930.00 元
   → 运费输入框变为只读，显示计算结果
   → 显示计算公式
   
5. 用户输入额外费用：100 元
   → 系统自动计算司机应收：7030.00 元
```

### 场景2：手动输入模式

```
1. 用户选择项目
   
2. 用户不输入单价（留空）
   → 系统保持"手动输入模式"
   → 显示提示："未输入单价，请手动输入运费"
   
3. 用户直接输入运费：7000 元
   → 运费输入框可编辑，正常样式
   
4. 用户输入额外费用：100 元
   → 系统自动计算司机应收：7100.00 元
```

### 场景3：模式切换

```
1. 用户开始时输入单价：350 元/吨
   → 进入自动模式
   → 运费自动计算：6930.00 元
   
2. 用户删除单价（清空）
   → 切换回手动模式
   → 运费输入框变为可编辑
   → 保留之前计算的运费值（用户可修改）
   
3. 用户重新输入单价：360 元/吨
   → 重新进入自动模式
   → 运费重新计算：7128.00 元
```

---

## 📊 项目配置说明

### 有效数量计算方式（effective_quantity_type）

在项目设置中配置，三种选项：

| 配置值 | 显示名称 | 计算逻辑 | 示例 |
|--------|---------|---------|------|
| `min_value` | 装货数量和卸货数量取较小值 | `MIN(loading, unloading)` | 装货20吨，卸货19.8吨 → 19.8吨 |
| `loading` | 取装货数量 | `loading_weight` | 装货20吨，卸货19.8吨 → 20吨 |
| `unloading` | 取卸货数量 | `unloading_weight` | 装货20吨，卸货19.8吨 → 19.8吨 |

**界面显示**：
- 在有效数量字段下方显示当前项目的配置
- 例如："📦 按项目配置：取装货和卸货较小值"

---

## 🔄 计算链路

```
用户输入数据
    ↓
┌─────────────────────────────────┐
│ 是否输入了单价？                 │
├─────────────────────────────────┤
│ 是 → 自动模式                    │
│ 否 → 手动模式                    │
└─────────────────────────────────┘
    ↓
┌─ 自动模式 ─────────────────────┐
│                                 │
│ 1. 读取项目配置                 │
│    effective_quantity_type      │
│                                 │
│ 2. 计算有效数量                 │
│    根据配置计算                 │
│                                 │
│ 3. 自动计算运费                 │
│    current_cost =               │
│    unit_price × effective_qty   │
│                                 │
│ 4. 运费输入框禁用               │
│                                 │
└─────────────────────────────────┘

┌─ 手动模式 ─────────────────────┐
│                                 │
│ 1. 用户手动输入运费             │
│                                 │
│ 2. 运费输入框可编辑             │
│                                 │
└─────────────────────────────────┘

两种模式都执行：
    ↓
┌─────────────────────────────────┐
│ 计算司机应收                     │
│ payable_cost =                  │
│ current_cost + extra_cost       │
└─────────────────────────────────┘
```

---

## 💾 数据提交

### 提交时的数据
```typescript
{
  // ... 其他字段
  unit_price: formData.unitPrice, // 单价（可能为空）
  current_cost: formData.currentCost, // 运费
  extra_cost: formData.extraCost, // 额外费用
  loading_weight: formData.loading_weight,
  unloading_weight: formData.unloading_weight,
  // ...
}
```

**注意**：
- ✅ 前端只负责界面逻辑，不传递 `calculation_mode`
- ✅ 后端数据库触发器会根据是否有 `unit_price` 自动判断模式
- ✅ 如果后端触发器实现了自动计算，前端计算可作为实时预览

---

## ⚠️ 注意事项

### 1. 编辑模式
- 编辑现有运单时，`unitPrice` 默认为空（手动模式）
- 保持原有的 `current_cost` 值
- 用户可以主动输入单价切换到自动模式

### 2. 必填字段验证
- 单价不是必填字段（可选）
- 运费是必填字段（*标记）
- 自动模式下运费自动填充

### 3. 数据精度
- 单价：保留2位小数
- 有效数量：保留3位小数
- 运费：保留2位小数

### 4. 向后兼容
- 旧数据没有 `unit_price`，显示为空
- 不影响现有运单的显示和编辑
- 用户可以为旧运单补充单价信息

---

## 🎨 UI 样式说明

### 颜色方案
- **自动模式标签**：蓝色背景 `bg-blue-100`，蓝色文字 `text-blue-700`
- **有效数量卡片**：蓝色边框 `border-blue-100`
- **运费自动计算**：灰色背景 `bg-gray-50`，灰色文字 `text-gray-700`
- **计算公式提示**：蓝色文字 `text-blue-600`

### 响应式布局
- 移动端：单列布局
- 桌面端：运费和额外费用并列显示（grid-cols-2）

---

## 📝 总结

### 核心特性
1. ✅ **智能模式切换**：根据是否输入单价自动切换
2. ✅ **实时计算**：输入数据后立即显示计算结果
3. ✅ **项目配置驱动**：有效数量根据项目配置自动计算
4. ✅ **用户友好**：清晰的提示和视觉反馈
5. ✅ **向后兼容**：不影响现有数据和功能

### 用户价值
- **自动模式**：减少手动计算错误，提高效率
- **手动模式**：保留灵活性，适应特殊情况
- **透明化**：清楚显示计算过程，便于核对

---

**实施日期**：2025-11-20  
**文档版本**：1.0

