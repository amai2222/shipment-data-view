# 📱 派单系统使用说明

**创建时间：** 2025-11-08  
**功能：** 车队长派单 → 司机接单 → 完成运输 → 自动录入运单  
**状态：** ✅ 已完成开发

---

## 🎯 功能概述

### 完整流程

```
车队长创建派单
    ↓
实时推送给司机
    ↓
司机收到通知
    ↓
司机接受/拒绝
    ↓
司机完成运输
    ↓
填写重量+上传磅单
    ↓
自动创建运单（logistics_records）
```

---

## 👔 车队长端功能

### 1️⃣ 派单管理页面

**访问路径：** `/m/internal/dispatch-order`

**功能列表：**
- ✅ 新建派单
- ✅ 查看派单历史
- ✅ 常用线路快捷选择
- ✅ 保存常用线路

---

### 2️⃣ 创建派单

**必填信息：**
- 选择司机（从管理的司机中选择）
- 选择项目（默认显示进行中的项目）
- 选择装货地点
- 选择卸货地点

**可选信息：**
- 预期装货日期
- 预计重量
- 备注说明

**创建步骤：**
1. 点击"新建派单"按钮
2. 填写派单信息
3. 点击"派单"按钮
4. 系统自动推送给司机

---

### 3️⃣ 常用线路功能

**保存线路：**
1. 在新建派单时选择好装卸地点
2. 点击"保存线路"按钮
3. 输入线路名称（如：昆明→大理）
4. 确认保存

**使用线路：**
1. 在派单页面顶部看到常用线路列表
2. 点击任一线路
3. 自动填充装卸地点
4. 继续填写其他信息

**线路特点：**
- 📊 按使用次数排序（常用的排前面）
- 🔄 自动记录使用次数
- ⏰ 记录最后使用时间

---

### 4️⃣ 派单状态跟踪

**状态说明：**
- 🟡 **待接单** - 已派出，司机未处理
- 🔵 **已接单** - 司机已接受，运输中
- 🟢 **已完成** - 司机已完成，运单已创建
- 🔴 **已拒绝** - 司机拒绝接单
- ⚫ **已取消** - 车队长取消派单

---

## 🚗 司机端功能

### 1️⃣ 我的派单页面

**访问路径：** `/m/internal/my-dispatches`

**功能特点：**
- ✅ 实时接收新派单通知
- ✅ 查看待接单派单
- ✅ 查看进行中派单
- ✅ 查看已完成派单

---

### 2️⃣ 接单流程

**待接单列表：**
1. 登录后自动查看待接单派单
2. 点击派单查看详情
3. 确认信息无误后点击"接受"
4. 或点击"拒绝"拒绝派单

**接单后：**
- 派单状态变更为"已接单"
- 移动到"进行中"标签页
- 可以开始运输

---

### 3️⃣ 完成派单

**完成条件：** 运输完成后

**操作步骤：**
1. 在"进行中"标签页找到派单
2. 点击派单打开完成对话框
3. **必填**：输入装货重量（吨）
4. **可选**：输入卸货重量（吨）
5. **可选**：上传磅单照片
6. **可选**：填写完成备注
7. 点击"确认完成"

**系统自动：**
- ✅ 创建运单记录（logistics_records）
- ✅ 填充项目信息、司机信息、地点信息
- ✅ 填充实际重量
- ✅ 关联磅单照片
- ✅ 派单状态更新为"已完成"

---

### 4️⃣ 磅单照片上传

**功能说明：**
- 📸 支持多张照片上传
- ☁️ 自动上传到七牛云
- 📁 照片存储在磅单目录（scale-records）
- 🗑️ 上传后可删除重新上传

**上传步骤：**
1. 点击"上传磅单照片"按钮
2. 选择照片（可多选）
3. 等待上传完成
4. 照片显示在下方预览
5. 可删除不需要的照片

**照片命名规则：**
```
派单磅单-{司机姓名}-{时间戳}.jpg
```

---

## 🔔 实时通知功能

### 司机端实时通知

**新派单通知：**
- 车队长创建派单后
- 司机端立即收到通知
- 通知内容：`收到新的派单：PD20251108-0001`
- 派单列表自动刷新

**实现技术：**
- Supabase Realtime
- WebSocket 推送
- 自动重连机制

---

## 💾 数据库表结构

### dispatch_orders（派单表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| order_number | TEXT | 派单编号（PD+日期-序号） |
| project_id | UUID | 项目ID |
| driver_id | UUID | 司机ID |
| fleet_manager_id | UUID | 车队长ID |
| loading_location_id | UUID | 装货地点ID |
| unloading_location_id | UUID | 卸货地点ID |
| loading_location | TEXT | 装货地点名称 |
| unloading_location | TEXT | 卸货地点名称 |
| expected_loading_date | DATE | 预期装货日期 |
| expected_weight | NUMERIC | 预期重量 |
| status | TEXT | 派单状态 |
| loading_weight | NUMERIC | 实际装货重量 |
| unloading_weight | NUMERIC | 实际卸货重量 |
| scale_record_photos | JSONB | 磅单照片数组 |
| logistics_record_id | UUID | 关联的运单ID |

---

### fleet_manager_favorite_routes（常用线路表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| fleet_manager_id | UUID | 车队长ID |
| route_name | TEXT | 线路名称 |
| project_id | UUID | 项目ID |
| loading_location_id | UUID | 装货地点ID |
| unloading_location_id | UUID | 卸货地点ID |
| use_count | INTEGER | 使用次数 |
| last_used_at | TIMESTAMPTZ | 最后使用时间 |

---

## 🔧 RPC 函数说明

### create_dispatch_order（车队长派单）

**参数：**
```typescript
{
  p_project_id: UUID,           // 项目ID（必填）
  p_driver_id: UUID,            // 司机ID（必填）
  p_loading_location_id: UUID,  // 装货地点（必填）
  p_unloading_location_id: UUID,// 卸货地点（必填）
  p_expected_loading_date: DATE,// 预期日期（可选）
  p_expected_weight: NUMERIC,   // 预期重量（可选）
  p_remarks: TEXT               // 备注（可选）
}
```

**返回：**
```json
{
  "success": true,
  "message": "派单成功",
  "order_id": "uuid",
  "order_number": "PD20251108-0001"
}
```

---

### accept_dispatch_order（司机接单）

**参数：**
```typescript
{
  p_order_id: UUID  // 派单ID
}
```

**返回：**
```json
{
  "success": true,
  "message": "接单成功"
}
```

---

### complete_dispatch_order（司机完成派单）

**参数：**
```typescript
{
  p_order_id: UUID,              // 派单ID（必填）
  p_loading_weight: NUMERIC,     // 装货重量（必填）
  p_unloading_weight: NUMERIC,   // 卸货重量（可选）
  p_scale_photos: TEXT[],        // 磅单照片URL数组（可选）
  p_completion_remarks: TEXT     // 完成备注（可选）
}
```

**返回：**
```json
{
  "success": true,
  "message": "运单已创建",
  "logistics_id": "uuid",
  "auto_number": "YD20251108-0001"
}
```

**自动处理：**
- ✅ 生成运单编号
- ✅ 填充项目信息
- ✅ 填充司机信息（从司机档案）
- ✅ 填充车牌号（从车辆分配）
- ✅ 填充装卸地点
- ✅ 设置初始状态（Uninvoiced, Unpaid）
- ✅ 关联磅单照片

---

## 🚀 部署步骤

### 第1步：执行数据库脚本

在 Supabase SQL Editor 中执行：

```
supabase/migrations/20251108_create_dispatch_system.sql
```

**执行时间：** 约 5-10 秒

---

### 第2步：前端代码已完成

**新增文件：**
1. ✅ `src/pages/mobile/internal/MobileDispatchOrder.tsx` - 车队长派单
2. ✅ `src/pages/mobile/internal/MobileMyDispatches.tsx` - 司机接单

**修改文件：**
1. ✅ `src/App.tsx` - 添加路由
2. ✅ `src/App.lazy.tsx` - 添加懒加载
3. ✅ `src/components/mobile/MobileLayout.tsx` - 添加菜单
4. ✅ `src/pages/mobile/internal/MobileMyExpenses.tsx` - 添加预加载
5. ✅ `src/pages/mobile/internal/MobileFleetDashboard.tsx` - 添加预加载

---

## ✅ 测试清单

### 车队长端测试

- [ ] 登录车队长账号
- [ ] 进入"派单管理"
- [ ] 创建新派单
- [ ] 查看派单历史
- [ ] 保存常用线路
- [ ] 使用常用线路快速派单

### 司机端测试

- [ ] 登录司机账号
- [ ] 进入"我的派单"
- [ ] 收到新派单通知
- [ ] 查看派单详情
- [ ] 接受派单
- [ ] 在"进行中"标签查看
- [ ] 完成派单（填写重量）
- [ ] 上传磅单照片（可选）
- [ ] 确认完成
- [ ] 验证运单已创建

### 数据验证

```sql
-- 查看派单记录
SELECT * FROM dispatch_orders ORDER BY created_at DESC LIMIT 10;

-- 查看生成的运单
SELECT * FROM logistics_records 
WHERE auto_number LIKE 'YD%' 
ORDER BY created_at DESC LIMIT 10;

-- 查看常用线路
SELECT * FROM fleet_manager_favorite_routes 
ORDER BY use_count DESC;
```

---

## 🎨 功能特色

### 1. 常用线路管理
- 💾 自动保存常用线路
- 📊 按使用频率排序
- ⚡ 一键应用线路配置

### 2. 实时通知
- 🔔 新派单即时推送
- 📱 状态变更实时同步
- 🔄 列表自动刷新

### 3. 智能录入
- 🤖 自动生成运单编号
- 📋 自动填充项目信息
- 🚗 自动获取司机车牌
- 📍 自动关联地点信息

### 4. 照片上传
- ☁️ 七牛云存储
- 📁 统一存储在磅单目录
- 🖼️ 支持多张照片
- 👁️ 实时预览

### 5. 数据完整性
- ✅ 装货重量必填验证
- ✅ 司机身份验证
- ✅ 派单状态流转控制
- ✅ 运单自动关联

---

## 📊 业务规则

### 派单创建规则

1. **权限要求** - 只有车队长和管理员可以派单
2. **司机限制** - 只能派给自己管理的司机
3. **项目选择** - 可以选择任何进行中的项目
4. **地点选择** - 从系统地点库中选择，也可自定义添加

### 接单规则

1. **只能接自己的单** - 司机只能看到派给自己的单
2. **状态限制** - 只能接"待接单"状态的派单
3. **一次性操作** - 接受或拒绝后不可撤销

### 完成规则

1. **状态要求** - 只能完成"已接单"状态的派单
2. **重量必填** - 装货重量必须填写且大于0
3. **照片可选** - 磅单照片非必须，但推荐上传
4. **自动录入** - 完成后自动创建运单记录

---

## 💡 使用技巧

### 车队长技巧

**技巧1：批量派单**
- 保存常用线路后
- 连续派单只需选择司机
- 其他信息一键填充

**技巧2：线路命名**
- 使用简洁明确的名称
- 如：昆明→大理、市区配送、长途运输

**技巧3：预期信息**
- 填写预期日期和重量
- 帮助司机更好地安排

### 司机技巧

**技巧1：及时接单**
- 收到通知后及时查看
- 避免派单超时

**技巧2：详细记录**
- 填写准确的装卸货重量
- 上传清晰的磅单照片
- 有问题写在备注中

**技巧3：完成确认**
- 确认重量信息准确
- 检查照片上传成功
- 再点击确认完成

---

## 🔍 常见问题

### Q1: 派单后司机没收到通知？

**可能原因：**
- 司机未登录或未打开派单页面
- 网络连接问题
- 实时订阅未建立

**解决方案：**
- 让司机登录并进入"我的派单"页面
- 检查网络连接
- 手动刷新页面

### Q2: 完成派单后运单在哪里查看？

**答案：** 运单已自动创建到 `logistics_records` 表

**查看方式：**
- PC端：运单管理页面
- 移动端：运单管理页面
- 搜索运单编号（YD开头）

### Q3: 常用线路如何修改？

**当前：** 保存同名线路会覆盖原有配置

**未来：** 可添加编辑和删除功能

### Q4: 派单能否取消？

**当前：** 暂不支持

**建议：** 如需取消，让司机拒绝即可

---

## 📈 数据流转图

```
车队长派单
  ↓
dispatch_orders 表
  status = 'pending'
  ↓
Supabase Realtime 推送
  ↓
司机端收到通知
  ↓
司机接受
  ↓
dispatch_orders 表
  status = 'accepted'
  ↓
司机运输...
  ↓
司机填写完成信息
  ↓
complete_dispatch_order 函数
  ↓
创建 logistics_records
  ↓
更新 dispatch_orders
  status = 'completed'
  logistics_record_id = xxx
```

---

## 🎯 未来优化建议

### 短期（1周）
- ⚠️ 添加派单取消功能
- ⚠️ 添加派单修改功能
- ⚠️ 添加派单超时提醒

### 中期（1个月）
- ⚠️ 批量派单功能
- ⚠️ 派单模板功能
- ⚠️ 派单统计报表

### 长期（3个月）
- ⚠️ 智能派单（自动匹配司机）
- ⚠️ 路线规划优化
- ⚠️ 预测装货重量

---

## 🎉 总结

✅ **派单系统已完整开发**

**功能亮点：**
- 🚀 实时推送，即时响应
- 💾 常用线路，快速派单
- 📸 照片上传，七牛云存储
- 🤖 自动录入，减少手工
- 📱 移动优先，操作便捷

**用户体验：**
- 车队长：3步完成派单
- 司机：2步接单，简单填写完成
- 自动化程度高，减少重复工作

---

**文档版本：** v1.0  
**最后更新：** 2025-11-08  
**状态：** ✅ 可以使用

