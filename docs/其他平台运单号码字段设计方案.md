# å…¶ä»–å¹³å°è¿å•å·ç å­—æ®µè®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚åˆ†æ

### 1. **ä¸šåŠ¡åœºæ™¯**
- **å¤šå¹³å°å¯¹æ¥**ï¼šä¸ç¬¬ä¸‰æ–¹ç‰©æµå¹³å°ï¼ˆå¦‚è´§æ‹‰æ‹‰ã€æ»¡å¸®ã€è¿æ»¡æ»¡ç­‰ï¼‰å¯¹æ¥
- **è¿å•å…³è”**ï¼šä¸€ä¸ªå†…éƒ¨è¿å•å¯èƒ½å¯¹åº”å¤šä¸ªå¤–éƒ¨å¹³å°çš„è¿å•
- **æ•°æ®è¿½æº¯**ï¼šé€šè¿‡å¤–éƒ¨è¿å•å·å¿«é€Ÿå®šä½å’ŒæŸ¥è¯¢
- **è´¹ç”¨å¯¹è´¦**ï¼šä¸å¤–éƒ¨å¹³å°è¿›è¡Œè´¹ç”¨æ ¸å¯¹

### 2. **åŠŸèƒ½éœ€æ±‚**
- **æ”¯æŒå•ä¸ªè¿å•å·**ï¼šä¸€ä¸ªå†…éƒ¨è¿å•å¯¹åº”ä¸€ä¸ªå¤–éƒ¨è¿å•
- **æ”¯æŒå¤šä¸ªè¿å•å·**ï¼šä¸€ä¸ªå†…éƒ¨è¿å•å¯¹åº”å¤šä¸ªå¤–éƒ¨è¿å•
- **å¹³å°æ ‡è¯†**ï¼šåŒºåˆ†ä¸åŒå¹³å°çš„è¿å•å·
- **çŠ¶æ€è·Ÿè¸ª**ï¼šè·Ÿè¸ªå¤–éƒ¨è¿å•çš„çŠ¶æ€
- **å¤‡æ³¨ä¿¡æ¯**ï¼šè®°å½•é¢å¤–çš„å…³è”ä¿¡æ¯

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šJSONå­—æ®µè®¾è®¡ï¼ˆæ¨èï¼‰

#### 1. **åœ¨logistics_recordsè¡¨ä¸­å¢åŠ JSONå­—æ®µ**

```sql
-- æ·»åŠ å…¶ä»–å¹³å°è¿å•å·ç å­—æ®µ
ALTER TABLE public.logistics_records 
ADD COLUMN external_tracking_numbers JSONB DEFAULT '[]'::jsonb;

-- æ·»åŠ å­—æ®µæ³¨é‡Š
COMMENT ON COLUMN public.logistics_records.external_tracking_numbers IS 'å…¶ä»–å¹³å°è¿å•å·ç ï¼ŒJSONæ ¼å¼å­˜å‚¨';

-- åˆ›å»ºJSONç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_logistics_records_external_tracking ON public.logistics_records USING GIN (external_tracking_numbers);
```

#### 2. **JSONæ•°æ®ç»“æ„è®¾è®¡**

```json
[
  {
    "platform": "è´§æ‹‰æ‹‰",
    "tracking_number": "HLL20250120001",
    "status": "å·²å®Œæˆ",
    "created_at": "2025-01-20T10:00:00Z",
    "remarks": "ä¸»è¿å•"
  },
  {
    "platform": "æ»¡å¸®",
    "tracking_number": "MB20250120002",
    "status": "è¿è¾“ä¸­",
    "created_at": "2025-01-20T11:00:00Z",
    "remarks": "åˆ†å•"
  }
]
```

### æ–¹æ¡ˆäºŒï¼šç‹¬ç«‹è¡¨è®¾è®¡ï¼ˆå¤‡é€‰ï¼‰

#### 1. **åˆ›å»ºå¤–éƒ¨è¿å•å…³è”è¡¨**

```sql
-- åˆ›å»ºå¤–éƒ¨è¿å•å…³è”è¡¨
CREATE TABLE public.external_tracking_records (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  logistics_record_id UUID NOT NULL REFERENCES public.logistics_records(id) ON DELETE CASCADE,
  platform TEXT NOT NULL, -- å¹³å°åç§°
  tracking_number TEXT NOT NULL, -- å¤–éƒ¨è¿å•å·
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'in_transit', 'completed', 'cancelled')),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  remarks TEXT,
  created_by_user_id UUID NOT NULL DEFAULT auth.uid()
);

-- å¯ç”¨RLS
ALTER TABLE public.external_tracking_records ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºRLSç­–ç•¥
CREATE POLICY "Users can manage external tracking records for their logistics records"
ON public.external_tracking_records
FOR ALL
TO authenticated
USING (auth.uid() = created_by_user_id)
WITH CHECK (auth.uid() = created_by_user_id);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_external_tracking_logistics_record_id ON public.external_tracking_records(logistics_record_id);
CREATE INDEX idx_external_tracking_platform ON public.external_tracking_records(platform);
CREATE INDEX idx_external_tracking_number ON public.external_tracking_records(tracking_number);
```

## ğŸ¨ å‰ç«¯ç•Œé¢è®¾è®¡

### 1. **è¿å•è¡¨å•ä¸­çš„å¤–éƒ¨è¿å•å·è¾“å…¥**

```tsx
// å¤–éƒ¨è¿å•å·è¾“å…¥ç»„ä»¶
<div className="space-y-4">
  <div className="flex justify-between items-center">
    <Label>å…¶ä»–å¹³å°è¿å•å·ç </Label>
    <Button type="button" onClick={addExternalTracking} size="sm">
      <Plus className="mr-2 h-4 w-4" />
      æ·»åŠ è¿å•å·
    </Button>
  </div>
  
  {externalTrackingNumbers.map((tracking, index) => (
    <Card key={index} className="p-4 border-dashed">
      <div className="flex justify-between items-center mb-4">
        <Badge variant="outline">å¤–éƒ¨è¿å• {index + 1}</Badge>
        {externalTrackingNumbers.length > 1 && (
          <Button 
            type="button" 
            variant="ghost" 
            size="sm" 
            onClick={() => removeExternalTracking(index)}
          >
            <Trash2 className="h-4 w-4" />
          </Button>
        )}
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <Label>å¹³å°åç§° *</Label>
          <Select 
            value={tracking.platform} 
            onValueChange={(value) => updateExternalTracking(index, 'platform', value)}
          >
            <SelectTrigger>
              <SelectValue placeholder="é€‰æ‹©å¹³å°" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="è´§æ‹‰æ‹‰">è´§æ‹‰æ‹‰</SelectItem>
              <SelectItem value="æ»¡å¸®">æ»¡å¸®</SelectItem>
              <SelectItem value="è¿æ»¡æ»¡">è¿æ»¡æ»¡</SelectItem>
              <SelectItem value="å…¶ä»–">å…¶ä»–</SelectItem>
            </SelectContent>
          </Select>
        </div>
        <div>
          <Label>è¿å•å·ç  *</Label>
          <Input
            value={tracking.tracking_number}
            onChange={(e) => updateExternalTracking(index, 'tracking_number', e.target.value)}
            placeholder="è¯·è¾“å…¥è¿å•å·ç "
          />
        </div>
        <div>
          <Label>çŠ¶æ€</Label>
          <Select 
            value={tracking.status} 
            onValueChange={(value) => updateExternalTracking(index, 'status', value)}
          >
            <SelectTrigger>
              <SelectValue placeholder="é€‰æ‹©çŠ¶æ€" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="pending">å¾…å¤„ç†</SelectItem>
              <SelectItem value="in_transit">è¿è¾“ä¸­</SelectItem>
              <SelectItem value="completed">å·²å®Œæˆ</SelectItem>
              <SelectItem value="cancelled">å·²å–æ¶ˆ</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>
      
      <div className="mt-4">
        <Label>å¤‡æ³¨</Label>
        <Input
          value={tracking.remarks || ''}
          onChange={(e) => updateExternalTracking(index, 'remarks', e.target.value)}
          placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"
        />
      </div>
    </Card>
  ))}
</div>
```

### 2. **è¿å•åˆ—è¡¨ä¸­çš„å¤–éƒ¨è¿å•å·æ˜¾ç¤º**

```tsx
// åœ¨è¿å•åˆ—è¡¨ä¸­æ˜¾ç¤ºå¤–éƒ¨è¿å•å·
<TableRow>
  <TableCell>
    <div>
      <div className="font-medium">{record.auto_number}</div>
      {record.external_tracking_numbers && record.external_tracking_numbers.length > 0 && (
        <div className="text-sm text-muted-foreground mt-1">
          {record.external_tracking_numbers.map((tracking, index) => (
            <Badge key={index} variant="secondary" className="mr-1 text-xs">
              {tracking.platform}: {tracking.tracking_number}
            </Badge>
          ))}
        </div>
      )}
    </div>
  </TableCell>
  {/* å…¶ä»–åˆ—... */}
</TableRow>
```

### 3. **è¿å•è¯¦æƒ…ä¸­çš„å¤–éƒ¨è¿å•å·å±•ç¤º**

```tsx
// è¿å•è¯¦æƒ…ä¸­çš„å¤–éƒ¨è¿å•å·å¡ç‰‡
{record.external_tracking_numbers && record.external_tracking_numbers.length > 0 && (
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <ExternalLink className="h-5 w-5" />
        å…¶ä»–å¹³å°è¿å•å·ç 
      </CardTitle>
    </CardHeader>
    <CardContent>
      <div className="space-y-3">
        {record.external_tracking_numbers.map((tracking, index) => (
          <div key={index} className="border rounded-lg p-3">
            <div className="flex justify-between items-center mb-2">
              <div className="flex items-center gap-2">
                <Badge variant="outline">{tracking.platform}</Badge>
                <span className="font-medium">{tracking.tracking_number}</span>
              </div>
              <Badge variant={
                tracking.status === 'completed' ? 'default' : 
                tracking.status === 'in_transit' ? 'secondary' : 
                'outline'
              }>
                {tracking.status === 'completed' ? 'å·²å®Œæˆ' :
                 tracking.status === 'in_transit' ? 'è¿è¾“ä¸­' :
                 tracking.status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'å¾…å¤„ç†'}
              </Badge>
            </div>
            {tracking.remarks && (
              <div className="text-sm text-muted-foreground">
                å¤‡æ³¨: {tracking.remarks}
              </div>
            )}
          </div>
        ))}
      </div>
    </CardContent>
  </Card>
)}
```

## ğŸ”§ ä¸šåŠ¡é€»è¾‘è®¾è®¡

### 1. **æ•°æ®éªŒè¯é€»è¾‘**

```typescript
// å¤–éƒ¨è¿å•å·æ•°æ®éªŒè¯
const validateExternalTracking = (trackingNumbers: ExternalTrackingNumber[]) => {
  const errors: string[] = [];
  
  // éªŒè¯å¹³å°åç§°
  trackingNumbers.forEach((tracking, index) => {
    if (!tracking.platform.trim()) {
      errors.push(`å¤–éƒ¨è¿å•${index + 1}çš„å¹³å°åç§°ä¸èƒ½ä¸ºç©º`);
    }
    if (!tracking.tracking_number.trim()) {
      errors.push(`å¤–éƒ¨è¿å•${index + 1}çš„è¿å•å·ç ä¸èƒ½ä¸ºç©º`);
    }
  });
  
  // éªŒè¯è¿å•å·ä¸é‡å¤
  const trackingNumbersList = trackingNumbers.map(t => t.tracking_number.trim());
  const uniqueTrackingNumbers = new Set(trackingNumbersList);
  if (trackingNumbersList.length !== uniqueTrackingNumbers.size) {
    errors.push('å¤–éƒ¨è¿å•å·ç ä¸èƒ½é‡å¤');
  }
  
  return errors;
};
```

### 2. **æ•°æ®æ“ä½œå‡½æ•°**

```typescript
// æ·»åŠ å¤–éƒ¨è¿å•å·
const addExternalTracking = () => {
  setFormData(prev => ({
    ...prev,
    external_tracking_numbers: [
      ...prev.external_tracking_numbers,
      {
        platform: '',
        tracking_number: '',
        status: 'pending',
        remarks: ''
      }
    ]
  }));
};

// åˆ é™¤å¤–éƒ¨è¿å•å·
const removeExternalTracking = (index: number) => {
  setFormData(prev => ({
    ...prev,
    external_tracking_numbers: prev.external_tracking_numbers.filter((_, i) => i !== index)
  }));
};

// æ›´æ–°å¤–éƒ¨è¿å•å·
const updateExternalTracking = (index: number, field: string, value: string) => {
  setFormData(prev => ({
    ...prev,
    external_tracking_numbers: prev.external_tracking_numbers.map((tracking, i) => 
      i === index ? { ...tracking, [field]: value } : tracking
    )
  }));
};
```

### 3. **æ•°æ®åº“æŸ¥è¯¢å‡½æ•°**

```sql
-- æ ¹æ®å¤–éƒ¨è¿å•å·æŸ¥è¯¢è¿å•
CREATE OR REPLACE FUNCTION public.get_logistics_record_by_external_tracking(
  p_tracking_number TEXT
)
RETURNS TABLE (
  id UUID,
  auto_number TEXT,
  project_name TEXT,
  external_tracking_numbers JSONB
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    lr.id,
    lr.auto_number,
    lr.project_name,
    lr.external_tracking_numbers
  FROM public.logistics_records lr
  WHERE lr.external_tracking_numbers @> jsonb_build_array(
    jsonb_build_object('tracking_number', p_tracking_number)
  );
END;
$$;

-- æ ¹æ®å¹³å°æŸ¥è¯¢è¿å•
CREATE OR REPLACE FUNCTION public.get_logistics_records_by_platform(
  p_platform TEXT
)
RETURNS TABLE (
  id UUID,
  auto_number TEXT,
  project_name TEXT,
  external_tracking_numbers JSONB
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    lr.id,
    lr.auto_number,
    lr.project_name,
    lr.external_tracking_numbers
  FROM public.logistics_records lr
  WHERE lr.external_tracking_numbers @> jsonb_build_array(
    jsonb_build_object('platform', p_platform)
  );
END;
$$;
```

## ğŸ“± ç§»åŠ¨ç«¯é€‚é…

### 1. **ç§»åŠ¨ç«¯è¡¨å•è®¾è®¡**

```tsx
// ç§»åŠ¨ç«¯å¤–éƒ¨è¿å•å·è¾“å…¥
<Card>
  <CardHeader>
    <div className="flex justify-between items-center">
      <CardTitle className="text-base">å…¶ä»–å¹³å°è¿å•å·</CardTitle>
      <Button type="button" size="sm" onClick={addExternalTracking}>
        <Plus className="h-4 w-4" />
      </Button>
    </div>
  </CardHeader>
  <CardContent className="space-y-3">
    {externalTrackingNumbers.map((tracking, index) => (
      <div key={index} className="border rounded-lg p-3">
        <div className="flex justify-between items-center mb-2">
          <span className="font-medium">å¤–éƒ¨è¿å• {index + 1}</span>
          {externalTrackingNumbers.length > 1 && (
            <Button 
              type="button" 
              variant="ghost" 
              size="sm" 
              onClick={() => removeExternalTracking(index)}
            >
              <Trash2 className="h-4 w-4" />
            </Button>
          )}
        </div>
        <div className="space-y-2">
          <div>
            <Label>å¹³å°</Label>
            <Select 
              value={tracking.platform} 
              onValueChange={(value) => updateExternalTracking(index, 'platform', value)}
            >
              <SelectTrigger>
                <SelectValue placeholder="é€‰æ‹©å¹³å°" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="è´§æ‹‰æ‹‰">è´§æ‹‰æ‹‰</SelectItem>
                <SelectItem value="æ»¡å¸®">æ»¡å¸®</SelectItem>
                <SelectItem value="è¿æ»¡æ»¡">è¿æ»¡æ»¡</SelectItem>
                <SelectItem value="å…¶ä»–">å…¶ä»–</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <div>
            <Label>è¿å•å·</Label>
            <Input
              value={tracking.tracking_number}
              onChange={(e) => updateExternalTracking(index, 'tracking_number', e.target.value)}
              placeholder="è¯·è¾“å…¥è¿å•å·"
            />
          </div>
        </div>
      </div>
    ))}
  </CardContent>
</Card>
```

## ğŸš€ å®æ–½å»ºè®®

### 1. **åˆ†é˜¶æ®µå®æ–½**

#### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“è®¾è®¡
- æ·»åŠ  `external_tracking_numbers` JSONå­—æ®µ
- åˆ›å»ºç›¸å…³ç´¢å¼•
- åˆ›å»ºæŸ¥è¯¢å‡½æ•°

#### ç¬¬äºŒé˜¶æ®µï¼šå‰ç«¯ç•Œé¢
- ä¿®æ”¹è¿å•è¡¨å•ç»„ä»¶
- æ›´æ–°è¿å•åˆ—è¡¨æ˜¾ç¤º
- å®ç°è¿å•è¯¦æƒ…å±•ç¤º

#### ç¬¬ä¸‰é˜¶æ®µï¼šç§»åŠ¨ç«¯é€‚é…
- é€‚é…ç§»åŠ¨ç«¯è¡¨å•
- ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤ºæ•ˆæœ

#### ç¬¬å››é˜¶æ®µï¼šåŠŸèƒ½å¢å¼º
- æ·»åŠ å¹³å°ç®¡ç†åŠŸèƒ½
- å®ç°çŠ¶æ€åŒæ­¥
- æ·»åŠ æ•°æ®å¯¼å…¥å¯¼å‡º

### 2. **å…¼å®¹æ€§è€ƒè™‘**

- ä¿æŒç°æœ‰åŠŸèƒ½ä¸å˜
- æ–°å­—æ®µä¸ºå¯é€‰å­—æ®µ
- æä¾›æ•°æ®è¿ç§»æ–¹æ¡ˆ
- ç¡®ä¿ç°æœ‰æ•°æ®ä¸å—å½±å“

### 3. **æ€§èƒ½ä¼˜åŒ–**

- ä½¿ç”¨JSONç´¢å¼•æé«˜æŸ¥è¯¢æ€§èƒ½
- é™åˆ¶å¤–éƒ¨è¿å•å·æ•°é‡
- å®ç°æ•°æ®ç¼“å­˜æœºåˆ¶

è¿™ä¸ªè®¾è®¡æ–¹æ¡ˆæä¾›äº†çµæ´»çš„å¤–éƒ¨è¿å•å·ç®¡ç†åŠŸèƒ½ï¼Œæ—¢æ”¯æŒå•ä¸ªè¿å•å·ï¼Œä¹Ÿæ”¯æŒå¤šä¸ªè¿å•å·ï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½ã€‚
