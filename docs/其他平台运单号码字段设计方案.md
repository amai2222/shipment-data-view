# 其他平台运单号码字段设计方案

## 📋 需求分析

### 1. **业务场景**
- **多平台对接**：与第三方物流平台（如货拉拉、满帮、运满满等）对接
- **运单关联**：一个内部运单可能对应多个外部平台的运单
- **数据追溯**：通过外部运单号快速定位和查询
- **费用对账**：与外部平台进行费用核对

### 2. **功能需求**
- **支持单个运单号**：一个内部运单对应一个外部运单
- **支持多个运单号**：一个内部运单对应多个外部运单
- **平台标识**：区分不同平台的运单号
- **状态跟踪**：跟踪外部运单的状态
- **备注信息**：记录额外的关联信息

## 🗄️ 数据库设计方案

### 方案一：JSON字段设计（推荐）

#### 1. **在logistics_records表中增加JSON字段**

```sql
-- 添加其他平台运单号码字段
ALTER TABLE public.logistics_records 
ADD COLUMN external_tracking_numbers JSONB DEFAULT '[]'::jsonb;

-- 添加字段注释
COMMENT ON COLUMN public.logistics_records.external_tracking_numbers IS '其他平台运单号码，JSON格式存储';

-- 创建JSON索引以提高查询性能
CREATE INDEX idx_logistics_records_external_tracking ON public.logistics_records USING GIN (external_tracking_numbers);
```

#### 2. **JSON数据结构设计**

```json
[
  {
    "platform": "货拉拉",
    "tracking_number": "HLL20250120001",
    "status": "已完成",
    "created_at": "2025-01-20T10:00:00Z",
    "remarks": "主运单"
  },
  {
    "platform": "满帮",
    "tracking_number": "MB20250120002",
    "status": "运输中",
    "created_at": "2025-01-20T11:00:00Z",
    "remarks": "分单"
  }
]
```

### 方案二：独立表设计（备选）

#### 1. **创建外部运单关联表**

```sql
-- 创建外部运单关联表
CREATE TABLE public.external_tracking_records (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  logistics_record_id UUID NOT NULL REFERENCES public.logistics_records(id) ON DELETE CASCADE,
  platform TEXT NOT NULL, -- 平台名称
  tracking_number TEXT NOT NULL, -- 外部运单号
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'in_transit', 'completed', 'cancelled')),
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  remarks TEXT,
  created_by_user_id UUID NOT NULL DEFAULT auth.uid()
);

-- 启用RLS
ALTER TABLE public.external_tracking_records ENABLE ROW LEVEL SECURITY;

-- 创建RLS策略
CREATE POLICY "Users can manage external tracking records for their logistics records"
ON public.external_tracking_records
FOR ALL
TO authenticated
USING (auth.uid() = created_by_user_id)
WITH CHECK (auth.uid() = created_by_user_id);

-- 创建索引
CREATE INDEX idx_external_tracking_logistics_record_id ON public.external_tracking_records(logistics_record_id);
CREATE INDEX idx_external_tracking_platform ON public.external_tracking_records(platform);
CREATE INDEX idx_external_tracking_number ON public.external_tracking_records(tracking_number);
```

## 🎨 前端界面设计

### 1. **运单表单中的外部运单号输入**

```tsx
// 外部运单号输入组件
<div className="space-y-4">
  <div className="flex justify-between items-center">
    <Label>其他平台运单号码</Label>
    <Button type="button" onClick={addExternalTracking} size="sm">
      <Plus className="mr-2 h-4 w-4" />
      添加运单号
    </Button>
  </div>
  
  {externalTrackingNumbers.map((tracking, index) => (
    <Card key={index} className="p-4 border-dashed">
      <div className="flex justify-between items-center mb-4">
        <Badge variant="outline">外部运单 {index + 1}</Badge>
        {externalTrackingNumbers.length > 1 && (
          <Button 
            type="button" 
            variant="ghost" 
            size="sm" 
            onClick={() => removeExternalTracking(index)}
          >
            <Trash2 className="h-4 w-4" />
          </Button>
        )}
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <Label>平台名称 *</Label>
          <Select 
            value={tracking.platform} 
            onValueChange={(value) => updateExternalTracking(index, 'platform', value)}
          >
            <SelectTrigger>
              <SelectValue placeholder="选择平台" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="货拉拉">货拉拉</SelectItem>
              <SelectItem value="满帮">满帮</SelectItem>
              <SelectItem value="运满满">运满满</SelectItem>
              <SelectItem value="其他">其他</SelectItem>
            </SelectContent>
          </Select>
        </div>
        <div>
          <Label>运单号码 *</Label>
          <Input
            value={tracking.tracking_number}
            onChange={(e) => updateExternalTracking(index, 'tracking_number', e.target.value)}
            placeholder="请输入运单号码"
          />
        </div>
        <div>
          <Label>状态</Label>
          <Select 
            value={tracking.status} 
            onValueChange={(value) => updateExternalTracking(index, 'status', value)}
          >
            <SelectTrigger>
              <SelectValue placeholder="选择状态" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="pending">待处理</SelectItem>
              <SelectItem value="in_transit">运输中</SelectItem>
              <SelectItem value="completed">已完成</SelectItem>
              <SelectItem value="cancelled">已取消</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>
      
      <div className="mt-4">
        <Label>备注</Label>
        <Input
          value={tracking.remarks || ''}
          onChange={(e) => updateExternalTracking(index, 'remarks', e.target.value)}
          placeholder="请输入备注信息"
        />
      </div>
    </Card>
  ))}
</div>
```

### 2. **运单列表中的外部运单号显示**

```tsx
// 在运单列表中显示外部运单号
<TableRow>
  <TableCell>
    <div>
      <div className="font-medium">{record.auto_number}</div>
      {record.external_tracking_numbers && record.external_tracking_numbers.length > 0 && (
        <div className="text-sm text-muted-foreground mt-1">
          {record.external_tracking_numbers.map((tracking, index) => (
            <Badge key={index} variant="secondary" className="mr-1 text-xs">
              {tracking.platform}: {tracking.tracking_number}
            </Badge>
          ))}
        </div>
      )}
    </div>
  </TableCell>
  {/* 其他列... */}
</TableRow>
```

### 3. **运单详情中的外部运单号展示**

```tsx
// 运单详情中的外部运单号卡片
{record.external_tracking_numbers && record.external_tracking_numbers.length > 0 && (
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <ExternalLink className="h-5 w-5" />
        其他平台运单号码
      </CardTitle>
    </CardHeader>
    <CardContent>
      <div className="space-y-3">
        {record.external_tracking_numbers.map((tracking, index) => (
          <div key={index} className="border rounded-lg p-3">
            <div className="flex justify-between items-center mb-2">
              <div className="flex items-center gap-2">
                <Badge variant="outline">{tracking.platform}</Badge>
                <span className="font-medium">{tracking.tracking_number}</span>
              </div>
              <Badge variant={
                tracking.status === 'completed' ? 'default' : 
                tracking.status === 'in_transit' ? 'secondary' : 
                'outline'
              }>
                {tracking.status === 'completed' ? '已完成' :
                 tracking.status === 'in_transit' ? '运输中' :
                 tracking.status === 'cancelled' ? '已取消' : '待处理'}
              </Badge>
            </div>
            {tracking.remarks && (
              <div className="text-sm text-muted-foreground">
                备注: {tracking.remarks}
              </div>
            )}
          </div>
        ))}
      </div>
    </CardContent>
  </Card>
)}
```

## 🔧 业务逻辑设计

### 1. **数据验证逻辑**

```typescript
// 外部运单号数据验证
const validateExternalTracking = (trackingNumbers: ExternalTrackingNumber[]) => {
  const errors: string[] = [];
  
  // 验证平台名称
  trackingNumbers.forEach((tracking, index) => {
    if (!tracking.platform.trim()) {
      errors.push(`外部运单${index + 1}的平台名称不能为空`);
    }
    if (!tracking.tracking_number.trim()) {
      errors.push(`外部运单${index + 1}的运单号码不能为空`);
    }
  });
  
  // 验证运单号不重复
  const trackingNumbersList = trackingNumbers.map(t => t.tracking_number.trim());
  const uniqueTrackingNumbers = new Set(trackingNumbersList);
  if (trackingNumbersList.length !== uniqueTrackingNumbers.size) {
    errors.push('外部运单号码不能重复');
  }
  
  return errors;
};
```

### 2. **数据操作函数**

```typescript
// 添加外部运单号
const addExternalTracking = () => {
  setFormData(prev => ({
    ...prev,
    external_tracking_numbers: [
      ...prev.external_tracking_numbers,
      {
        platform: '',
        tracking_number: '',
        status: 'pending',
        remarks: ''
      }
    ]
  }));
};

// 删除外部运单号
const removeExternalTracking = (index: number) => {
  setFormData(prev => ({
    ...prev,
    external_tracking_numbers: prev.external_tracking_numbers.filter((_, i) => i !== index)
  }));
};

// 更新外部运单号
const updateExternalTracking = (index: number, field: string, value: string) => {
  setFormData(prev => ({
    ...prev,
    external_tracking_numbers: prev.external_tracking_numbers.map((tracking, i) => 
      i === index ? { ...tracking, [field]: value } : tracking
    )
  }));
};
```

### 3. **数据库查询函数**

```sql
-- 根据外部运单号查询运单
CREATE OR REPLACE FUNCTION public.get_logistics_record_by_external_tracking(
  p_tracking_number TEXT
)
RETURNS TABLE (
  id UUID,
  auto_number TEXT,
  project_name TEXT,
  external_tracking_numbers JSONB
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    lr.id,
    lr.auto_number,
    lr.project_name,
    lr.external_tracking_numbers
  FROM public.logistics_records lr
  WHERE lr.external_tracking_numbers @> jsonb_build_array(
    jsonb_build_object('tracking_number', p_tracking_number)
  );
END;
$$;

-- 根据平台查询运单
CREATE OR REPLACE FUNCTION public.get_logistics_records_by_platform(
  p_platform TEXT
)
RETURNS TABLE (
  id UUID,
  auto_number TEXT,
  project_name TEXT,
  external_tracking_numbers JSONB
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    lr.id,
    lr.auto_number,
    lr.project_name,
    lr.external_tracking_numbers
  FROM public.logistics_records lr
  WHERE lr.external_tracking_numbers @> jsonb_build_array(
    jsonb_build_object('platform', p_platform)
  );
END;
$$;
```

## 📱 移动端适配

### 1. **移动端表单设计**

```tsx
// 移动端外部运单号输入
<Card>
  <CardHeader>
    <div className="flex justify-between items-center">
      <CardTitle className="text-base">其他平台运单号</CardTitle>
      <Button type="button" size="sm" onClick={addExternalTracking}>
        <Plus className="h-4 w-4" />
      </Button>
    </div>
  </CardHeader>
  <CardContent className="space-y-3">
    {externalTrackingNumbers.map((tracking, index) => (
      <div key={index} className="border rounded-lg p-3">
        <div className="flex justify-between items-center mb-2">
          <span className="font-medium">外部运单 {index + 1}</span>
          {externalTrackingNumbers.length > 1 && (
            <Button 
              type="button" 
              variant="ghost" 
              size="sm" 
              onClick={() => removeExternalTracking(index)}
            >
              <Trash2 className="h-4 w-4" />
            </Button>
          )}
        </div>
        <div className="space-y-2">
          <div>
            <Label>平台</Label>
            <Select 
              value={tracking.platform} 
              onValueChange={(value) => updateExternalTracking(index, 'platform', value)}
            >
              <SelectTrigger>
                <SelectValue placeholder="选择平台" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="货拉拉">货拉拉</SelectItem>
                <SelectItem value="满帮">满帮</SelectItem>
                <SelectItem value="运满满">运满满</SelectItem>
                <SelectItem value="其他">其他</SelectItem>
              </SelectContent>
            </Select>
          </div>
          <div>
            <Label>运单号</Label>
            <Input
              value={tracking.tracking_number}
              onChange={(e) => updateExternalTracking(index, 'tracking_number', e.target.value)}
              placeholder="请输入运单号"
            />
          </div>
        </div>
      </div>
    ))}
  </CardContent>
</Card>
```

## 🚀 实施建议

### 1. **分阶段实施**

#### 第一阶段：数据库设计
- 添加 `external_tracking_numbers` JSON字段
- 创建相关索引
- 创建查询函数

#### 第二阶段：前端界面
- 修改运单表单组件
- 更新运单列表显示
- 实现运单详情展示

#### 第三阶段：移动端适配
- 适配移动端表单
- 优化移动端显示效果

#### 第四阶段：功能增强
- 添加平台管理功能
- 实现状态同步
- 添加数据导入导出

### 2. **兼容性考虑**

- 保持现有功能不变
- 新字段为可选字段
- 提供数据迁移方案
- 确保现有数据不受影响

### 3. **性能优化**

- 使用JSON索引提高查询性能
- 限制外部运单号数量
- 实现数据缓存机制

这个设计方案提供了灵活的外部运单号管理功能，既支持单个运单号，也支持多个运单号，同时保持了良好的用户体验和系统性能。
