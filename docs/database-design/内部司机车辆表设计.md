# å†…éƒ¨å¸æœºå’Œè½¦è¾†æ•°æ®åº“è®¾è®¡

## ğŸ“‹ è®¾è®¡åŸåˆ™

1. **å‚è€ƒ drivers è¡¨ç»“æ„**ï¼šç…§ç‰‡å­—æ®µä½¿ç”¨ JSONB æ•°ç»„å­˜å‚¨ URL
2. **ä¸ƒç‰›äº‘å­˜å‚¨**ï¼šæ‰€æœ‰ç…§ç‰‡ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
3. **èŒè´£åˆ†ç¦»**ï¼šå¸æœºè¯ä»¶å½’å¸æœºè¡¨ï¼Œè½¦è¾†è¯ä»¶å½’è½¦è¾†è¡¨
4. **æ”¯æŒä¸€å¸æœºå¤šè½¦**ï¼šé€šè¿‡å…³è”è¡¨å®ç°

---

## ğŸ“Š è¡¨ç»“æ„è¯¦è§£

### è¡¨1ï¼šinternal_driversï¼ˆå†…éƒ¨å¸æœºè¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| **åŸºæœ¬ä¿¡æ¯** ||||
| id | UUID | ä¸»é”® | |
| name | TEXT | å¸æœºå§“å | å¼ ä¸‰ |
| phone | TEXT | ç”µè¯ï¼ˆå”¯ä¸€ï¼‰ | 13800138000 |
| id_card_number | TEXT | èº«ä»½è¯å·ï¼ˆå”¯ä¸€ï¼‰ | 110101199001011234 |
| hire_date | DATE | å…¥èŒæ—¥æœŸ | 2024-01-01 |
| employment_status | TEXT | åœ¨èŒçŠ¶æ€ | active, on_leave, resigned |
| **å¸æœºè¯ä»¶ç…§ç‰‡ï¼ˆJSONBï¼Œä¸ƒç‰›äº‘ URLï¼‰** ||||
| id_card_photos | JSONB | èº«ä»½è¯ç…§ç‰‡ | `["https://cdn.xxx.com/driver/èº«ä»½è¯-å¼ ä¸‰-1.jpg"]` |
| driver_license_photos | JSONB | é©¾é©¶è¯ç…§ç‰‡ | `["https://cdn.xxx.com/driver/é©¾é©¶è¯-å¼ ä¸‰-1.jpg"]` |
| qualification_certificate_photos | JSONB | ä»ä¸šèµ„æ ¼è¯ç…§ç‰‡ | `["https://cdn.xxx.com/driver/èµ„æ ¼è¯-å¼ ä¸‰-1.jpg"]` |
| **è¯ä»¶æœ‰æ•ˆæœŸï¼ˆç”¨äºåˆ°æœŸæé†’ï¼‰** ||||
| id_card_expire_date | DATE | èº«ä»½è¯åˆ°æœŸæ—¥ | 2030-12-31 |
| driver_license_expire_date | DATE | é©¾é©¶è¯åˆ°æœŸæ—¥ | 2028-06-30 |
| qualification_certificate_expire_date | DATE | ä»ä¸šèµ„æ ¼è¯åˆ°æœŸæ—¥ | 2026-12-31 |
| **å·¥èµ„ä¿¡æ¯** ||||
| base_salary | NUMERIC(10,2) | åŸºæœ¬å·¥èµ„ï¼ˆå…ƒï¼‰ | 5000.00 |
| salary_calculation_type | TEXT | è®¡ç®—æ–¹å¼ | monthly, trip_based, commission |
| commission_rate | NUMERIC(5,2) | ææˆæ¯”ä¾‹ï¼ˆ%ï¼‰ | 10.5 |
| **é“¶è¡Œä¿¡æ¯** ||||
| bank_account | TEXT | é“¶è¡Œè´¦å· | 6222021234567890 |
| bank_name | TEXT | å¼€æˆ·è¡Œ | ä¸­å›½å·¥å•†é“¶è¡ŒåŒ—äº¬åˆ†è¡Œ |
| account_holder_name | TEXT | è´¦æˆ·æŒæœ‰äºº | å¼ ä¸‰ |
| **å…¶ä»–** ||||
| is_active | BOOLEAN | æ˜¯å¦å¯ç”¨ | true |
| remarks | TEXT | å¤‡æ³¨ | |
| created_at | TIMESTAMPTZ | åˆ›å»ºæ—¶é—´ | |
| updated_at | TIMESTAMPTZ | æ›´æ–°æ—¶é—´ | |

---

### è¡¨2ï¼šinternal_vehiclesï¼ˆå†…éƒ¨è½¦è¾†è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| **åŸºæœ¬ä¿¡æ¯** ||||
| id | UUID | ä¸»é”® | |
| license_plate | TEXT | è½¦ç‰Œå·ï¼ˆå”¯ä¸€ï¼‰ | äº‘F97310 |
| vehicle_number | TEXT | å†…éƒ¨ç¼–å· | V001 |
| vehicle_type | TEXT | è½¦è¾†ç±»å‹ | å¢å¼è´§è½¦ |
| vehicle_brand | TEXT | å“ç‰Œ | ä¸œé£ |
| vehicle_model | TEXT | å‹å· | å¤©é¾™KL |
| vehicle_color | TEXT | é¢œè‰² | ç™½è‰² |
| manufacture_year | INTEGER | å‡ºå‚å¹´ä»½ | 2020 |
| **è§„æ ¼å‚æ•°** ||||
| load_capacity | NUMERIC(10,2) | è½½é‡é‡ï¼ˆå¨ï¼‰ | 9.6 |
| vehicle_length | NUMERIC(5,2) | è½¦é•¿ï¼ˆç±³ï¼‰ | 7.6 |
| vehicle_width | NUMERIC(5,2) | è½¦å®½ï¼ˆç±³ï¼‰ | 2.4 |
| vehicle_height | NUMERIC(5,2) | è½¦é«˜ï¼ˆç±³ï¼‰ | 2.8 |
| fuel_type | TEXT | ç‡ƒæ–™ç±»å‹ | diesel, gasoline, electric |
| **è½¦è¾†è¯ä»¶ç…§ç‰‡ï¼ˆJSONBï¼Œä¸ƒç‰›äº‘ URLï¼‰** ||||
| driving_license_photos | JSONB | è¡Œé©¶è¯ç…§ç‰‡ | `["https://cdn.xxx.com/Truck/è¡Œé©¶è¯-äº‘F97310-1.jpg"]` |
| transport_license_photos | JSONB | é“è·¯è¿è¾“è¯ç…§ç‰‡ | `["https://cdn.xxx.com/Truck/è¿è¾“è¯-äº‘F97310-1.jpg"]` |
| vehicle_photos | JSONB | è½¦è¾†å¤–è§‚ç…§ç‰‡ | `["https://cdn.xxx.com/Truck/è½¦è¾†-äº‘F97310-å‰.jpg", "...å.jpg"]` |
| insurance_certificate_photos | JSONB | ä¿é™©å•ç…§ç‰‡ | `["https://cdn.xxx.com/Truck/ä¿é™©-äº‘F97310-1.jpg"]` |
| **è¯ä»¶ä¿¡æ¯** ||||
| vin | TEXT | è½¦æ¶å·ï¼ˆå”¯ä¸€ï¼‰ | LGAX3B246KA123456 |
| engine_number | TEXT | å‘åŠ¨æœºå· | AB1234567 |
| driving_license_number | TEXT | è¡Œé©¶è¯å· | äº‘123456 |
| transport_license_number | TEXT | é“è·¯è¿è¾“è¯å· | è¿123456 |
| **è¯ä»¶æœ‰æ•ˆæœŸ** ||||
| driving_license_expire_date | DATE | è¡Œé©¶è¯åˆ°æœŸæ—¥ | 2025-12-31 |
| transport_license_expire_date | DATE | é“è·¯è¿è¾“è¯åˆ°æœŸæ—¥ | 2026-06-30 |
| annual_inspection_date | DATE | å¹´æ£€åˆ°æœŸæ—¥ | 2025-11-30 |
| **ä¿é™©ä¿¡æ¯** ||||
| insurance_company | TEXT | ä¿é™©å…¬å¸ | ä¸­å›½äººä¿ |
| insurance_policy_number | TEXT | ä¿å•å· | PICC20250001 |
| insurance_type | TEXT | é™©ç§ | äº¤å¼ºé™©+å•†ä¸šé™© |
| insurance_amount | NUMERIC(12,2) | ä¿é¢ï¼ˆå…ƒï¼‰ | 1000000.00 |
| insurance_start_date | DATE | ä¿é™©ç”Ÿæ•ˆæ—¥ | 2025-01-01 |
| insurance_expire_date | DATE | ä¿é™©åˆ°æœŸæ—¥ | 2026-01-01 |
| **è´­è½¦ä¿¡æ¯** ||||
| purchase_date | DATE | è´­è½¦æ—¥æœŸ | 2020-03-15 |
| purchase_price | NUMERIC(12,2) | è´­è½¦ä»·æ ¼ï¼ˆå…ƒï¼‰ | 280000.00 |
| purchase_type | TEXT | è´­ç½®æ–¹å¼ | purchase, lease, finance |
| **ç»´ä¿ä¿¡æ¯** ||||
| last_maintenance_date | DATE | ä¸Šæ¬¡ä¿å…»æ—¥æœŸ | 2025-10-15 |
| next_maintenance_date | DATE | ä¸‹æ¬¡ä¿å…»æ—¥æœŸ | 2026-01-15 |
| maintenance_mileage | INTEGER | ä¿å…»é‡Œç¨‹ï¼ˆkmï¼‰ | 50000 |
| current_mileage | INTEGER | å½“å‰é‡Œç¨‹ï¼ˆkmï¼‰ | 48500 |
| **çŠ¶æ€** ||||
| vehicle_status | TEXT | è½¦è¾†çŠ¶æ€ | active, maintenance, retired |
| is_active | BOOLEAN | æ˜¯å¦å¯ç”¨ | true |
| remarks | TEXT | å¤‡æ³¨ | |

---

### è¡¨3ï¼šinternal_driver_vehicle_relationsï¼ˆå¸æœº-è½¦è¾†å…³è”è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | UUID | ä¸»é”® |
| driver_id | UUID | å¸æœºIDï¼ˆå¤–é”® â†’ internal_driversï¼‰ |
| vehicle_id | UUID | è½¦è¾†IDï¼ˆå¤–é”® â†’ internal_vehiclesï¼‰ |
| is_primary | BOOLEAN | æ˜¯å¦ä¸ºä¸»é©¾é©¶ |
| relation_type | TEXT | å…³ç³»ç±»å‹ï¼šregular, backup, temporary |
| valid_from | DATE | ç”Ÿæ•ˆæ—¥æœŸ |
| valid_until | DATE | å¤±æ•ˆæ—¥æœŸï¼ˆNULL=é•¿æœŸï¼‰ |
| created_at | TIMESTAMPTZ | åˆ›å»ºæ—¶é—´ |

**çº¦æŸ**ï¼š
- `UNIQUE (driver_id, vehicle_id)` - åŒä¸€å¸æœºå’Œè½¦è¾†åªèƒ½æœ‰ä¸€æ¡å…³è”è®°å½•

---

## ğŸ“¸ ç…§ç‰‡å­—æ®µè¯¦è§£

### å¸æœºè¯ä»¶ç…§ç‰‡ï¼ˆinternal_drivers è¡¨ï¼‰

| å­—æ®µå | è¯´æ˜ | æœ€å¤§æ•°é‡ | ä¸ƒç‰›äº‘ç›®å½• | å‘½åè§„åˆ™ |
|--------|------|---------|-----------|---------|
| id_card_photos | èº«ä»½è¯ï¼ˆæ­£åé¢ï¼‰ | 2å¼  | `driver/` | `èº«ä»½è¯-{å§“å}-{æ—¶é—´æˆ³}-{åºå·}.jpg` |
| driver_license_photos | é©¾é©¶è¯ï¼ˆæ­£å‰¯é¡µï¼‰ | 2å¼  | `driver/` | `é©¾é©¶è¯-{å§“å}-{æ—¶é—´æˆ³}-{åºå·}.jpg` |
| qualification_certificate_photos | ä»ä¸šèµ„æ ¼è¯ | 2å¼  | `driver/` | `èµ„æ ¼è¯-{å§“å}-{æ—¶é—´æˆ³}-{åºå·}.jpg` |

### è½¦è¾†è¯ä»¶ç…§ç‰‡ï¼ˆinternal_vehicles è¡¨ï¼‰

| å­—æ®µå | è¯´æ˜ | æœ€å¤§æ•°é‡ | ä¸ƒç‰›äº‘ç›®å½• | å‘½åè§„åˆ™ |
|--------|------|---------|-----------|---------|
| driving_license_photos | è¡Œé©¶è¯ï¼ˆæ­£å‰¯é¡µï¼‰ | 2å¼  | `Truck/` | `è¡Œé©¶è¯-{è½¦ç‰Œå·}-{æ—¶é—´æˆ³}-{åºå·}.jpg` |
| transport_license_photos | é“è·¯è¿è¾“è¯ | 2å¼  | `Truck/` | `è¿è¾“è¯-{è½¦ç‰Œå·}-{æ—¶é—´æˆ³}-{åºå·}.jpg` |
| vehicle_photos | è½¦è¾†å¤–è§‚ | 10å¼  | `Truck/` | `è½¦è¾†-{è½¦ç‰Œå·}-{è§’åº¦}-{æ—¶é—´æˆ³}.jpg` |
| insurance_certificate_photos | ä¿é™©å• | 5å¼  | `Truck/` | `ä¿é™©-{è½¦ç‰Œå·}-{æ—¶é—´æˆ³}-{åºå·}.jpg` |

**ç…§ç‰‡æ•°æ®æ ¼å¼**ï¼ˆJSONB æ•°ç»„ï¼‰ï¼š
```json
[
  "https://your-cdn.com/driver/èº«ä»½è¯-å¼ ä¸‰-1730880000000-1.jpg",
  "https://your-cdn.com/driver/èº«ä»½è¯-å¼ ä¸‰-1730880000000-2.jpg"
]
```

---

## ğŸ”— ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ

### 1. å¤ç”¨ logistics_records è¡¨

**å…³è”æ–¹å¼**ï¼š
```sql
-- æŸ¥è¯¢å†…éƒ¨å¸æœºçš„è¿å•è®°å½•
SELECT lr.*
FROM logistics_records lr
INNER JOIN internal_drivers id ON lr.driver_name = id.name
WHERE id.id = 'xxx';

-- æŸ¥è¯¢å†…éƒ¨è½¦è¾†çš„è¿å•è®°å½•
SELECT lr.*
FROM logistics_records lr
INNER JOIN internal_vehicles iv ON lr.license_plate = iv.license_plate
WHERE iv.id = 'xxx';
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸éœ€è¦ä¿®æ”¹ logistics_records è¡¨
- âœ… é€šè¿‡å­—æ®µåŒ¹é…å³å¯å…³è”
- âœ… å¤–éƒ¨å¸æœºå’Œå†…éƒ¨å¸æœºçš„è¿å•ç»Ÿä¸€ç®¡ç†

---

## ğŸ“· ç…§ç‰‡ä¸Šä¼ é€»è¾‘

### å‰ç«¯ä¸Šä¼ æµç¨‹ï¼ˆå‚è€ƒ DriverPhotoUpload.tsxï¼‰

```typescript
// 1. é€‰æ‹©ç…§ç‰‡æ–‡ä»¶
const handleFileSelect = (type: PhotoType, event) => {
  const files = Array.from(event.target.files);
  // éªŒè¯æ–‡ä»¶ç±»å‹å’Œæ•°é‡
};

// 2. ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘
const uploadToQiniu = async (type: PhotoType) => {
  // è¯»å–æ–‡ä»¶ä¸º Base64
  const fileData = await readFileAsBase64(file);
  
  // è°ƒç”¨ä¸ƒç‰›äº‘ä¸Šä¼ å‡½æ•°
  const { data, error } = await supabase.functions.invoke('qiniu-upload', {
    body: {
      files: [{
        fileName: file.name,
        fileData: fileData
      }],
      namingParams: {
        projectName: 'driver', // å¸æœºè¯ä»¶ â†’ 'driver' ç›®å½•
        // æˆ–
        projectName: 'Truck',  // è½¦è¾†è¯ä»¶ â†’ 'Truck' ç›®å½•
        customName: `èº«ä»½è¯-${driverName}-${timestamp}-1.jpg`
      }
    }
  });
  
  // 3. ä¿å­˜ URL åˆ°æ•°æ®åº“
  const photoUrls = data.urls; // ä¸ƒç‰›äº‘è¿”å›çš„ URL æ•°ç»„
  await supabase
    .from('internal_drivers')
    .update({
      id_card_photos: photoUrls
    })
    .eq('id', driverId);
};
```

---

## ğŸ¯ å…³é”®åŠŸèƒ½æŸ¥è¯¢

### æŸ¥è¯¢1ï¼šè·å–å¸æœºçš„æ‰€æœ‰è½¦è¾†

```sql
SELECT * FROM get_driver_vehicles('å¸æœºUUID');

-- è¿”å›ï¼š
-- vehicle_id, license_plate, vehicle_type, is_primary, relation_type
```

### æŸ¥è¯¢2ï¼šè·å–è½¦è¾†çš„æ‰€æœ‰å¸æœº

```sql
SELECT * FROM get_vehicle_drivers('è½¦è¾†UUID');

-- è¿”å›ï¼š
-- driver_id, driver_name, phone, is_primary, relation_type
```

### æŸ¥è¯¢3ï¼šæŸ¥æ‰¾å³å°†åˆ°æœŸçš„è¯ä»¶

```sql
-- 7å¤©å†…åˆ°æœŸçš„å¸æœºè¯ä»¶
SELECT 
    name as å¸æœºå§“å,
    'é©¾é©¶è¯' as è¯ä»¶ç±»å‹,
    driver_license_expire_date as åˆ°æœŸæ—¥æœŸ,
    driver_license_expire_date - CURRENT_DATE as å‰©ä½™å¤©æ•°
FROM internal_drivers
WHERE driver_license_expire_date <= CURRENT_DATE + INTERVAL '7 days'
  AND driver_license_expire_date > CURRENT_DATE
  AND is_active = true;

-- 7å¤©å†…åˆ°æœŸçš„è½¦è¾†è¯ä»¶
SELECT 
    license_plate as è½¦ç‰Œå·,
    'è¡Œé©¶è¯' as è¯ä»¶ç±»å‹,
    driving_license_expire_date as åˆ°æœŸæ—¥æœŸ,
    driving_license_expire_date - CURRENT_DATE as å‰©ä½™å¤©æ•°
FROM internal_vehicles
WHERE driving_license_expire_date <= CURRENT_DATE + INTERVAL '7 days'
  AND driving_license_expire_date > CURRENT_DATE
  AND is_active = true;
```

---

## ğŸ“¦ æ•°æ®ç¤ºä¾‹

### å¸æœºæ•°æ®ç¤ºä¾‹

```sql
INSERT INTO internal_drivers (
    name, phone, id_card_number, hire_date,
    id_card_photos, driver_license_photos,
    base_salary, salary_calculation_type
) VALUES (
    'å¼ ä¸‰',
    '13800138000',
    '110101199001011234',
    '2024-01-01',
    '["https://cdn.example.com/driver/èº«ä»½è¯-å¼ ä¸‰-1730880000000-1.jpg", "https://cdn.example.com/driver/èº«ä»½è¯-å¼ ä¸‰-1730880000000-2.jpg"]'::jsonb,
    '["https://cdn.example.com/driver/é©¾é©¶è¯-å¼ ä¸‰-1730880000000-1.jpg"]'::jsonb,
    5000.00,
    'monthly'
);
```

### è½¦è¾†æ•°æ®ç¤ºä¾‹

```sql
INSERT INTO internal_vehicles (
    license_plate, vehicle_number, vehicle_type, vehicle_brand,
    load_capacity, vehicle_length,
    driving_license_photos, vehicle_photos,
    vin, purchase_date, purchase_price
) VALUES (
    'äº‘F97310',
    'V001',
    'å¢å¼è´§è½¦',
    'ä¸œé£',
    9.6,
    7.6,
    '["https://cdn.example.com/Truck/è¡Œé©¶è¯-äº‘F97310-1730880000000-1.jpg"]'::jsonb,
    '["https://cdn.example.com/Truck/è½¦è¾†-äº‘F97310-å‰.jpg", "https://cdn.example.com/Truck/è½¦è¾†-äº‘F97310-å.jpg"]'::jsonb,
    'LGAX3B246KA123456',
    '2020-03-15',
    280000.00
);
```

### å…³è”å…³ç³»ç¤ºä¾‹

```sql
-- å¼ ä¸‰é©¾é©¶äº‘F97310ï¼ˆä¸»é©¾é©¶ï¼‰
INSERT INTO internal_driver_vehicle_relations (
    driver_id,
    vehicle_id,
    is_primary,
    relation_type,
    valid_from
) VALUES (
    (SELECT id FROM internal_drivers WHERE name = 'å¼ ä¸‰'),
    (SELECT id FROM internal_vehicles WHERE license_plate = 'äº‘F97310'),
    true,
    'regular',
    '2024-01-01'
);
```

---

## ğŸ¨ å‰ç«¯ç»„ä»¶è®¾è®¡

### ç»„ä»¶1ï¼šInternalDriverPhotoUploadï¼ˆå¸æœºè¯ä»¶ä¸Šä¼ ï¼‰

```typescript
// å‚è€ƒï¼šsrc/components/DriverPhotoUpload.tsx

interface InternalDriverPhotoUploadProps {
  driverName: string;
  existingPhotos: {
    id_card_photos: string[];
    driver_license_photos: string[];
    qualification_certificate_photos: string[];
  };
  onChange: (photos: any) => void;
}

// ä¸Šä¼ ç›®å½•ï¼š'driver'
// æ–‡ä»¶å‘½åï¼š{è¯ä»¶ç±»å‹}-{å¸æœºå§“å}-{æ—¶é—´æˆ³}-{åºå·}.jpg
```

### ç»„ä»¶2ï¼šInternalVehiclePhotoUploadï¼ˆè½¦è¾†è¯ä»¶ä¸Šä¼ ï¼‰

```typescript
interface InternalVehiclePhotoUploadProps {
  licensePlate: string;
  existingPhotos: {
    driving_license_photos: string[];
    transport_license_photos: string[];
    vehicle_photos: string[];
    insurance_certificate_photos: string[];
  };
  onChange: (photos: any) => void;
}

// ä¸Šä¼ ç›®å½•ï¼š'Truck'
// æ–‡ä»¶å‘½åï¼š{è¯ä»¶ç±»å‹}-{è½¦ç‰Œå·}-{æ—¶é—´æˆ³}-{åºå·}.jpg
```

---

## ğŸ”” æé†’åŠŸèƒ½è®¾è®¡

### è¯ä»¶åˆ°æœŸæé†’ SQL

```sql
CREATE OR REPLACE FUNCTION get_expiring_certificates(p_days_before INTEGER DEFAULT 7)
RETURNS TABLE (
    entity_type TEXT,     -- 'driver' æˆ– 'vehicle'
    entity_name TEXT,     -- å¸æœºå§“å æˆ– è½¦ç‰Œå·
    certificate_type TEXT, -- è¯ä»¶ç±»å‹
    expire_date DATE,     -- åˆ°æœŸæ—¥æœŸ
    days_left INTEGER     -- å‰©ä½™å¤©æ•°
)
LANGUAGE sql
AS $$
    -- å¸æœºè¯ä»¶åˆ°æœŸ
    SELECT 
        'driver'::TEXT,
        name::TEXT,
        'é©¾é©¶è¯'::TEXT,
        driver_license_expire_date,
        (driver_license_expire_date - CURRENT_DATE)::INTEGER
    FROM internal_drivers
    WHERE driver_license_expire_date <= CURRENT_DATE + (p_days_before || ' days')::INTERVAL
      AND driver_license_expire_date > CURRENT_DATE
      AND is_active = true
    
    UNION ALL
    
    -- è½¦è¾†è¡Œé©¶è¯åˆ°æœŸ
    SELECT 
        'vehicle'::TEXT,
        license_plate::TEXT,
        'è¡Œé©¶è¯'::TEXT,
        driving_license_expire_date,
        (driving_license_expire_date - CURRENT_DATE)::INTEGER
    FROM internal_vehicles
    WHERE driving_license_expire_date <= CURRENT_DATE + (p_days_before || ' days')::INTERVAL
      AND driving_license_expire_date > CURRENT_DATE
      AND is_active = true
    
    UNION ALL
    
    -- è½¦è¾†ä¿é™©åˆ°æœŸ
    SELECT 
        'vehicle'::TEXT,
        license_plate::TEXT,
        'ä¿é™©'::TEXT,
        insurance_expire_date,
        (insurance_expire_date - CURRENT_DATE)::INTEGER
    FROM internal_vehicles
    WHERE insurance_expire_date <= CURRENT_DATE + (p_days_before || ' days')::INTERVAL
      AND insurance_expire_date > CURRENT_DATE
      AND is_active = true
    
    ORDER BY 4;
$$;

COMMENT ON FUNCTION get_expiring_certificates IS 'è·å–å³å°†åˆ°æœŸçš„è¯ä»¶ï¼ˆå¸æœºå’Œè½¦è¾†ï¼‰';
```

---

## âœ… æ€»ç»“

### æ ¸å¿ƒè¡¨ï¼ˆ3ä¸ªï¼‰
1. âœ… `internal_drivers` - å†…éƒ¨å¸æœºæ¡£æ¡ˆï¼ˆå«å¸æœºè¯ä»¶ç…§ç‰‡ï¼‰
2. âœ… `internal_vehicles` - è½¦è¾†æ¡£æ¡ˆï¼ˆå«è½¦è¾†è¯ä»¶ç…§ç‰‡ï¼‰
3. âœ… `internal_driver_vehicle_relations` - å¸æœº-è½¦è¾†å…³è”ï¼ˆä¸€å¸æœºå¤šè½¦ï¼‰

### ç…§ç‰‡å­˜å‚¨
- âœ… æ‰€æœ‰ç…§ç‰‡å­˜å‚¨åˆ°**ä¸ƒç‰›äº‘**
- âœ… æ•°æ®åº“åªå­˜å‚¨**URLæ•°ç»„**ï¼ˆJSONBæ ¼å¼ï¼‰
- âœ… å¸æœºè¯ä»¶ â†’ `driver/` ç›®å½•
- âœ… è½¦è¾†è¯ä»¶ â†’ `Truck/` ç›®å½•

### ä¸ç°æœ‰ç³»ç»Ÿå…³è”
- âœ… å¤ç”¨ `logistics_records` è¡¨
- âœ… é€šè¿‡ `driver_name` å’Œ `license_plate` åŒ¹é…
- âœ… ä¸å½±å“å¤–éƒ¨å¸æœºç³»ç»Ÿï¼ˆ`drivers` è¡¨ï¼‰

**è¿ç§»è„šæœ¬å·²å‡†å¤‡å¥½ï¼Œå¯ä»¥ç›´æ¥åœ¨ Supabase æ‰§è¡Œï¼**

