# 组件重构规范

## 📋 重构时必须遵循的规范

### 1. 公共化原则

#### ✅ 必须移动到公共目录的

**src/utils/** - 通用工具函数
- 格式化函数（formatCurrency、formatDate等）
- 数据处理工具
- 验证函数
- **命名**：如有冲突，添加业务前缀（如`invoicePaymentFormatters.ts`）

**src/types/** - 类型定义
- 接口定义
- 类型别名
- **命名**：使用页面/模块名（如`invoiceRequest.ts`、`businessEntry.ts`）

**src/hooks/** - 通用自定义Hooks
- 防抖、节流等通用Hook
- 可跨页面复用的状态管理
- **命名**：使用驼峰命名（如`useDebounce.ts`，而非`use-debounce.ts`）

**src/components/common/** - 可复用UI组件
- 合计行组件
- 批量输入对话框
- 状态徽章
- **命名**：保持原名（如无冲突）
- **更新导出**：必须添加到`common/index.ts`

---

#### ❌ 保留在页面目录的

**pages/Xxx/hooks/** - 页面专用业务逻辑
- 数据获取hooks（useXxxData）
- 业务操作hooks（useXxxActions）
- 页面状态管理hooks
- RPC调用封装

**pages/Xxx/components/** - 页面专用组件
- 复杂表格组件
- 页面特定对话框
- 特定业务组件

---

### 2. 命名规范

#### 自动重命名策略（避免冲突）

| 类型 | 冲突检测 | 重命名策略 | 示例 |
|------|---------|-----------|------|
| 工具函数 | formatters.ts已存在 | 添加业务前缀 | `invoicePaymentFormatters.ts` |
| 类型文件 | index.ts已存在 | 使用页面/模块名 | `invoiceRequest.ts` |
| Hooks | use-xxx.ts已存在 | 规范化驼峰命名 | `useDebounce.ts` |
| 组件 | 检查是否存在 | 添加业务前缀 | `InvoiceXxxComponent.tsx` |

**原则**：严禁覆盖已有文件，必须自动重命名！

---

### 3. 导入路径规范

#### 使用@/路径别名

```typescript
// ✅ 正确
import { formatCurrency } from '@/utils/invoicePaymentFormatters';
import type { LogisticsRecord } from '@/types/invoiceRequest';
import { useDebounce } from '@/hooks/useDebounce';
import { BatchInputDialog } from '@/components/common';

// ❌ 错误
import { formatCurrency } from '../../../utils/invoicePaymentFormatters';
import { LogisticsRecord } from './types';
```

---

### 4. 重构检查清单

重构任何页面时必须检查：

- [ ] 识别可公共化的工具函数
- [ ] 识别可公共化的类型定义
- [ ] 识别可公共化的Hooks
- [ ] 识别可公共化的组件
- [ ] 检查公共目录是否存在同名文件
- [ ] 自动重命名（如有冲突）
- [ ] 更新所有导入路径为@/路径
- [ ] 更新common/index.ts导出（如有新组件）
- [ ] 运行Lint检查
- [ ] 确保0个错误

---

### 5. 目录结构

#### 重构后的标准结构

```
src/pages/XxxPage/
├── index.tsx                    # 主页面（200行以内）
├── XxxPage.backup.tsx           # 原文件备份
├── components/                  # 页面专用组件
│   ├── XxxTable.tsx
│   ├── XxxDialog.tsx
│   └── XxxButton.tsx
└── hooks/                       # 页面专用hooks
    ├── useXxxData.ts           # 数据获取
    ├── useXxxSelection.ts      # 状态管理
    └── useXxxActions.ts        # 业务操作
```

**注意**：utils/和types/已移到公共目录！

---

### 6. 文件操作规范

#### 移动策略

**通用资源（移动）**：
```bash
# 工具函数
pages/Xxx/utils/formatters.ts → utils/xxxFormatters.ts

# 类型定义
pages/Xxx/types/index.ts → types/xxxPage.ts

# 通用组件
pages/Xxx/components/Summary.tsx → components/common/XxxSummary.tsx
```

**专用资源（保留）**：
```bash
# 保留在原位置
pages/Xxx/hooks/useXxxData.ts
pages/Xxx/components/XxxTable.tsx
```

**重复资源（复制后删除原文件）**：
```bash
# 如use-debounce被多处使用
pages/Xxx/hooks/use-debounce.ts → hooks/useDebounce.ts（复制）
pages/Xxx/hooks/use-debounce.ts（删除原文件）
```

---

### 7. 更新导出

#### common/index.ts必须更新

每次添加公共组件后：

```typescript
// src/components/common/index.ts
export { ExistingComponent } from './ExistingComponent';
export { NewComponent } from './NewComponent';  // ✅ 新增这行
```

---

### 8. 质量保证

#### 重构后必须确保

- ✅ 0个Lint错误
- ✅ 所有导入路径正确
- ✅ TypeScript类型完整
- ✅ 无文件覆盖
- ✅ 原文件已备份
- ✅ 功能保持一致

---

## 📝 示例

### 重构InvoiceAudit页面示例

**步骤1**：分析代码
- 发现formatDate函数 → 可公共化
- 发现InvoiceRequest类型 → 可公共化
- 发现useInvoiceAuditData hook → 页面专用，不公共化

**步骤2**：检查冲突
- utils/formatters.ts已存在 → 重命名为`invoiceAuditFormatters.ts`
- types/index.ts已存在 → 重命名为`invoiceAudit.ts`

**步骤3**：移动文件
```bash
pages/InvoiceAudit/utils/formatters.ts → utils/invoiceAuditFormatters.ts
pages/InvoiceAudit/types/index.ts → types/invoiceAudit.ts
pages/InvoiceAudit/components/SummaryRow.tsx → components/common/InvoiceAuditSummaryRow.tsx
```

**步骤4**：更新导入
```typescript
// 更新所有组件的导入路径为@/
import { formatDate } from '@/utils/invoiceAuditFormatters';
import type { InvoiceRequest } from '@/types/invoiceAudit';
```

**步骤5**：更新导出
```typescript
// components/common/index.ts
export { InvoiceAuditSummaryRow } from './InvoiceAuditSummaryRow';
```

**步骤6**：验证
```bash
# 检查Lint
npm run lint

# 确保0个错误
```

---

## ✅ 遵循此规范的好处

1. **代码复用** - 减少重复代码
2. **易于维护** - 清晰的目录结构
3. **避免冲突** - 自动重命名机制
4. **类型安全** - 统一的类型定义
5. **团队协作** - 规范化的代码组织

---

**此规范已生效，所有未来的重构都将遵循！** ✅

