# Supabase åå°éƒ¨ç½² Edge Function æŒ‡å—

## ğŸŒ ä½¿ç”¨ Supabase Dashboard éƒ¨ç½²

### ğŸ“‹ å‡†å¤‡å·¥ä½œ

1. **ç¡®ä¿æ‚¨æœ‰ä»¥ä¸‹ä¿¡æ¯ï¼š**
   - Supabase è´¦å·å’Œå¯†ç 
   - é¡¹ç›® URLï¼ˆä¾‹å¦‚ï¼šhttps://mnwzvtvyauyxwowjjsmf.supabase.coï¼‰
   - é¡¹ç›®è®¿é—®æƒé™ï¼ˆç®¡ç†å‘˜ï¼‰

2. **å‡†å¤‡å¥½ä»£ç æ–‡ä»¶ï¼š**
   - æ‰“å¼€æœ¬åœ°æ–‡ä»¶ï¼š`supabase/functions/delete-user-v2/index.ts`
   - å‡†å¤‡å¤åˆ¶å…¨éƒ¨å†…å®¹

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤ï¼ˆè¯¦ç»†ç‰ˆï¼‰

### Step 1: ç™»å½• Supabase Dashboard

1. è®¿é—®ï¼šhttps://app.supabase.com
2. ä½¿ç”¨æ‚¨çš„è´¦å·ç™»å½•
3. é€‰æ‹©æ‚¨çš„é¡¹ç›®ï¼ˆä¸­ç§‘ç‰©æµè·Ÿè¸ªç³»ç»Ÿï¼‰

---

### Step 2: è¿›å…¥ Edge Functions é¡µé¢

1. åœ¨å·¦ä¾§èœå•æ æ‰¾åˆ° **"Edge Functions"**
   - å¦‚æœçœ‹ä¸åˆ°ï¼Œç‚¹å‡»å·¦ä¸Šè§’çš„ â˜° èœå•
   - å‘ä¸‹æ»šåŠ¨æ‰¾åˆ° **"Edge Functions"**

2. ç‚¹å‡»è¿›å…¥ Edge Functions ç®¡ç†é¡µé¢

---

### Step 3: åˆ›å»ºæ–°å‡½æ•°

æœ‰ä¸¤ç§æ–¹å¼ï¼š

#### æ–¹å¼ A: åˆ›å»ºå…¨æ–°å‡½æ•°ï¼ˆæ¨èï¼‰

1. ç‚¹å‡»å³ä¸Šè§’ **"Create a new function"** æˆ– **"New Edge Function"** æŒ‰é’®
2. å¡«å†™ä¿¡æ¯ï¼š
   - **Nameï¼ˆå‡½æ•°åï¼‰**: `delete-user-v2`
   - **Templateï¼ˆæ¨¡æ¿ï¼‰**: é€‰æ‹© "HTTP Request" æˆ– "Blank"
3. ç‚¹å‡» **"Create function"**

#### æ–¹å¼ B: æ›¿æ¢ç°æœ‰å‡½æ•°

å¦‚æœæ‚¨æƒ³ç›´æ¥æ›¿æ¢æ—§çš„ `delete-user`ï¼š
1. æ‰¾åˆ° `delete-user` å‡½æ•°
2. ç‚¹å‡»å‡½æ•°åè¿›å…¥ç¼–è¾‘é¡µé¢
3. ç›´æ¥æ›¿æ¢ä»£ç ï¼ˆè·³åˆ° Step 4ï¼‰

---

### Step 4: å¤åˆ¶ä»£ç åˆ°ç¼–è¾‘å™¨

1. **æ‰“å¼€æœ¬åœ°æ–‡ä»¶ï¼š**
   ```
   supabase/functions/delete-user-v2/index.ts
   ```

2. **é€‰æ‹©å…¨éƒ¨ä»£ç å¹¶å¤åˆ¶**ï¼ˆCtrl+A, Ctrl+Cï¼‰

3. **åœ¨ Supabase Dashboard ä¸­ï¼š**
   - æ‰¾åˆ°ä»£ç ç¼–è¾‘å™¨åŒºåŸŸ
   - æ¸…ç©ºç°æœ‰ä»£ç ï¼ˆå¦‚æœæœ‰ï¼‰
   - ç²˜è´´å¤åˆ¶çš„ä»£ç ï¼ˆCtrl+Vï¼‰

---

### Step 5: ä¿å­˜å¹¶éƒ¨ç½²

1. **æ£€æŸ¥ä»£ç ï¼š**
   - ç¡®ä¿ä»£ç å®Œæ•´
   - ç‰¹åˆ«æ£€æŸ¥å¼€å¤´å’Œç»“å°¾æ˜¯å¦å®Œæ•´

2. **ç‚¹å‡»å³ä¸Šè§’çš„ "Deploy" æˆ– "Save and Deploy" æŒ‰é’®**

3. **ç­‰å¾…éƒ¨ç½²ï¼š**
   - ä¼šæ˜¾ç¤ºéƒ¨ç½²è¿›åº¦
   - é€šå¸¸éœ€è¦ 10-30 ç§’
   - çœ‹åˆ° âœ… "Successfully deployed" è¡¨ç¤ºæˆåŠŸ

---

### Step 6: éªŒè¯éƒ¨ç½²

#### åœ¨ Dashboard ä¸­éªŒè¯

1. å›åˆ° Edge Functions åˆ—è¡¨
2. åº”è¯¥çœ‹åˆ° `delete-user-v2` å‡½æ•°
3. çŠ¶æ€åº”è¯¥æ˜¯ "Active" æˆ– "Deployed"

#### è·å–å‡½æ•° URL

å‡½æ•°éƒ¨ç½²åçš„ URL æ ¼å¼ï¼š
```
https://ä½ çš„é¡¹ç›®ID.supabase.co/functions/v1/delete-user-v2
```

ä¾‹å¦‚ï¼š
```
https://mnwzvtvyauyxwowjjsmf.supabase.co/functions/v1/delete-user-v2
```

---

## ğŸ§ª æµ‹è¯•æ–°å‡½æ•°

### æ–¹æ³• 1: åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•

1. æ‰“å¼€æ‚¨çš„åº”ç”¨å‰ç«¯
2. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
3. åˆ‡æ¢åˆ° "Console" æ ‡ç­¾
4. ç²˜è´´å¹¶æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š

```javascript
// æµ‹è¯•æ–°å‡½æ•°
const { data, error } = await supabase.functions.invoke('delete-user-v2', {
  body: {
    userId: '7136e5fd-08ae-47ea-a22b-34c1a1745206',  // æ›¿æ¢ä¸ºå®é™…æµ‹è¯•ç”¨æˆ·ID
    hardDelete: false  // å…ˆç”¨è½¯åˆ é™¤æµ‹è¯•
  }
});

console.log('ç»“æœ:', data);
console.log('é”™è¯¯:', error);
```

### æ–¹æ³• 2: åœ¨ç”¨æˆ·ç®¡ç†ç•Œé¢æµ‹è¯•

1. è¿›å…¥ ç”¨æˆ·ç®¡ç† é¡µé¢
2. åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨æˆ·
3. å°è¯•åˆ é™¤è¯¥ç”¨æˆ·
4. åº”è¯¥ä¸ä¼šæŠ¥é”™ï¼Œä¸”ç”¨æˆ·è¢«æˆåŠŸåˆ é™¤

---

## ğŸ”§ å¦‚æœéƒ¨ç½²å¤±è´¥

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ³•

#### é”™è¯¯ 1: "Invalid TypeScript"

**åŸå› **: ä»£ç è¯­æ³•é”™è¯¯æˆ–æ ¼å¼é—®é¢˜

**è§£å†³**:
1. é‡æ–°å¤åˆ¶å®Œæ•´ä»£ç 
2. ç¡®ä¿åŒ…å«æ–‡ä»¶å¼€å¤´çš„ import è¯­å¥
3. ç¡®ä¿åŒ…å«æ–‡ä»¶ç»“å°¾çš„ serve() è°ƒç”¨

#### é”™è¯¯ 2: "Deployment timeout"

**åŸå› **: ç½‘ç»œé—®é¢˜æˆ–ä»£ç å¤ªå¤§

**è§£å†³**:
1. åˆ·æ–°é¡µé¢é‡è¯•
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. ç¨åå†è¯•

#### é”™è¯¯ 3: "Permission denied"

**åŸå› **: è´¦å·æƒé™ä¸è¶³

**è§£å†³**:
1. ç¡®è®¤æ‚¨æ˜¯é¡¹ç›®çš„ Owner æˆ– Admin
2. è”ç³»é¡¹ç›®ç®¡ç†å‘˜æ·»åŠ æƒé™

---

## ğŸ”„ æ›´æ–°å‰ç«¯ä»£ç 

éƒ¨ç½²æˆåŠŸåï¼Œéœ€è¦æ›´æ–°å‰ç«¯è°ƒç”¨ï¼š

### æ–¹å¼ A: ä½¿ç”¨æ–°å‡½æ•°åï¼ˆæ¨èï¼‰

**æ–‡ä»¶**: `src/components/permissions/UserManagement.tsx`

**ç¬¬ 275 è¡Œï¼Œä¿®æ”¹ï¼š**

```typescript
// ä¹‹å‰
const { data, error } = await supabase.functions.invoke('delete-user', {

// æ”¹ä¸º
const { data, error } = await supabase.functions.invoke('delete-user-v2', {
```

### æ–¹å¼ B: æ›¿æ¢æ—§å‡½æ•°

å¦‚æœæ‚¨åœ¨ Step 3 é€‰æ‹©äº†æ›¿æ¢æ—§å‡½æ•°ï¼Œåˆ™ï¼š
- å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹
- ç»§ç»­ä½¿ç”¨ `delete-user`

---

## ğŸ“Š éƒ¨ç½²åéªŒè¯æ¸…å•

- [ ] Edge Functions åˆ—è¡¨ä¸­èƒ½çœ‹åˆ°æ–°å‡½æ•°
- [ ] å‡½æ•°çŠ¶æ€æ˜¾ç¤ºä¸º "Active"
- [ ] åœ¨æµè§ˆå™¨æ§åˆ¶å°èƒ½æˆåŠŸè°ƒç”¨
- [ ] åˆ é™¤ç”¨æˆ·ä¸å†æŠ¥å¤–é”®é”™è¯¯
- [ ] auth.users å’Œ profiles åŒæ—¶è¢«åˆ é™¤
- [ ] å…³è”æ•°æ®è¢«è½¬ç§»åˆ°ç®¡ç†å‘˜

---

## ğŸ†˜ è·å–å¸®åŠ©

### æŸ¥çœ‹æ—¥å¿—

åœ¨ Supabase Dashboard ä¸­ï¼š
1. Edge Functions â†’ ç‚¹å‡»å‡½æ•°å
2. æŸ¥çœ‹ "Logs" æ ‡ç­¾
3. å¯ä»¥çœ‹åˆ°å‡½æ•°æ‰§è¡Œçš„æ—¥å¿—

### æµ‹è¯• API ç«¯ç‚¹

ä½¿ç”¨ Postman æˆ– curlï¼š

```bash
curl -X POST \
  https://ä½ çš„é¡¹ç›®ID.supabase.co/functions/v1/delete-user-v2 \
  -H 'Authorization: Bearer ä½ çš„ANON_KEY' \
  -H 'Content-Type: application/json' \
  -d '{
    "userId": "æµ‹è¯•ç”¨æˆ·ID",
    "hardDelete": false
  }'
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **éƒ¨ç½²ç¯å¢ƒå˜é‡**
   - Edge Function ä¼šè‡ªåŠ¨è·å–ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š
     - `SUPABASE_URL`
     - `SUPABASE_SERVICE_ROLE_KEY`
   - æ— éœ€æ‰‹åŠ¨é…ç½®

2. **å‡½æ•°æƒé™**
   - Edge Function ä½¿ç”¨ Service Role Key
   - æ‹¥æœ‰ç®¡ç†å‘˜æƒé™
   - å¯ä»¥æ“ä½œæ‰€æœ‰è¡¨

3. **éƒ¨ç½²æ—¶é—´**
   - é¦–æ¬¡éƒ¨ç½²ï¼šçº¦ 30-60 ç§’
   - æ›´æ–°éƒ¨ç½²ï¼šçº¦ 10-20 ç§’

4. **åŒºåŸŸè®¾ç½®**
   - Edge Function ä¼šéƒ¨ç½²åˆ°å…¨çƒå¤šä¸ªåŒºåŸŸ
   - è‡ªåŠ¨é€‰æ‹©æœ€è¿‘çš„åŒºåŸŸæ‰§è¡Œ

---

## ğŸ‰ å®Œæˆï¼

éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨çš„ç³»ç»Ÿå°†ï¼š
- âœ… æ”¯æŒå®‰å…¨åˆ é™¤ç”¨æˆ·
- âœ… è‡ªåŠ¨è½¬ç§»å…³è”æ•°æ®
- âœ… ä¸ä¼šå‡ºç°å¤–é”®é”™è¯¯
- âœ… ä¿æŒ auth.users å’Œ profiles åŒæ­¥

---

**éƒ¨ç½²æ—¶é—´**: çº¦ 5 åˆ†é’Ÿ  
**éš¾åº¦**: â­â­ (ç®€å•)  
**æœ€åæ›´æ–°**: 2025-11-01

