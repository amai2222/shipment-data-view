# å¿«é€Ÿéƒ¨ç½²æŒ‡å— - Token ç›¸å…³ Edge Functions

## ğŸš€ æ–¹æ³•1ï¼šä½¿ç”¨ Supabase CLIï¼ˆæ¨èï¼‰

### æ­¥éª¤1ï¼šå®‰è£… Supabase CLI

#### Windows æ–¹å¼1ï¼šä½¿ç”¨ Scoopï¼ˆæ¨èï¼‰

```powershell
# 1. å®‰è£… Scoopï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
irm get.scoop.sh | iex

# 2. æ·»åŠ  Supabase bucket
scoop bucket add supabase https://github.com/supabase/scoop-bucket.git

# 3. å®‰è£… Supabase CLI
scoop install supabase
```

#### Windows æ–¹å¼2ï¼šç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶

1. è®¿é—®ï¼šhttps://github.com/supabase/cli/releases
2. ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„ `supabase_windows_amd64.zip`
3. è§£å‹åˆ°æŸä¸ªç›®å½•ï¼ˆå¦‚ `C:\tools\supabase\`ï¼‰
4. å°†è¯¥ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿ PATH ç¯å¢ƒå˜é‡

#### Windows æ–¹å¼3ï¼šä½¿ç”¨ Chocolatey

```powershell
choco install supabase
```

### æ­¥éª¤2ï¼šç™»å½• Supabase

```powershell
supabase login
```

è¿™ä¼šæ‰“å¼€æµè§ˆå™¨ï¼Œè®©æ‚¨ç™»å½• Supabase è´¦å·ã€‚

### æ­¥éª¤3ï¼šé“¾æ¥é¡¹ç›®

```powershell
# é¡¹ç›® ID ä» config.toml ä¸­è·å–ï¼šmnwzvtvyauyxwowjjsmf
supabase link --project-ref mnwzvtvyauyxwowjjsmf
```

### æ­¥éª¤4ï¼šéƒ¨ç½²å‡½æ•°

```powershell
# ä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰
.\scripts\deploy-token-functions.ps1

# æˆ–æ‰‹åŠ¨éƒ¨ç½²
supabase functions deploy get-tracking-token
supabase functions deploy add-vehicle
supabase functions deploy vehicle-tracking
supabase functions deploy sync-vehicle-tracking-ids
supabase functions deploy sync-vehicle
```

---

## ğŸŒ æ–¹æ³•2ï¼šä½¿ç”¨ Supabase Dashboardï¼ˆæ— éœ€ CLIï¼‰

å¦‚æœæ— æ³•å®‰è£… CLIï¼Œå¯ä»¥é€šè¿‡ Web ç•Œé¢éƒ¨ç½²ï¼š

### æ­¥éª¤1ï¼šç™»å½• Supabase Dashboard

1. è®¿é—®ï¼šhttps://app.supabase.com
2. ç™»å½•æ‚¨çš„è´¦å·
3. é€‰æ‹©é¡¹ç›®ï¼ˆé¡¹ç›® ID: `mnwzvtvyauyxwowjjsmf`ï¼‰

### æ­¥éª¤2ï¼šè¿›å…¥ Edge Functions

1. åœ¨å·¦ä¾§èœå•æ‰¾åˆ° **"Edge Functions"**
2. ç‚¹å‡»è¿›å…¥

### æ­¥éª¤3ï¼šéƒ¨ç½²æ¯ä¸ªå‡½æ•°

å¯¹äºæ¯ä¸ªå‡½æ•°ï¼ˆ`get-tracking-token`, `add-vehicle`, `vehicle-tracking`, `sync-vehicle-tracking-ids`, `sync-vehicle`ï¼‰ï¼š

1. **å¦‚æœå‡½æ•°å·²å­˜åœ¨**ï¼š
   - ç‚¹å‡»å‡½æ•°åè¿›å…¥ç¼–è¾‘é¡µé¢
   - å¤åˆ¶æœ¬åœ°æ–‡ä»¶å†…å®¹ï¼ˆ`supabase/functions/<function-name>/index.ts`ï¼‰
   - ç²˜è´´åˆ°ç¼–è¾‘å™¨
   - ç‚¹å‡» **"Deploy"** æˆ– **"Save"**

2. **å¦‚æœå‡½æ•°ä¸å­˜åœ¨**ï¼š
   - ç‚¹å‡» **"Create a new function"**
   - è¾“å…¥å‡½æ•°åï¼ˆå¦‚ `get-tracking-token`ï¼‰
   - å¤åˆ¶æœ¬åœ°æ–‡ä»¶å†…å®¹
   - ç²˜è´´åˆ°ç¼–è¾‘å™¨
   - ç‚¹å‡» **"Deploy"**

### æ­¥éª¤4ï¼šéƒ¨ç½²å…±äº«æ¨¡å—

**é‡è¦**ï¼šDashboard éƒ¨ç½²æ—¶ï¼Œå…±äº«æ¨¡å—éœ€è¦æ‰‹åŠ¨å¤„ç†ã€‚

ç”±äº Dashboard ä¸æ”¯æŒ `_shared` ç›®å½•ï¼Œæ‚¨æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š

#### é€‰æ‹©Aï¼šå°†å…±äº«æ¨¡å—ä»£ç å†…è”åˆ°æ¯ä¸ªå‡½æ•°ï¼ˆä¸æ¨èï¼‰

éœ€è¦å°† `_shared/token-cache.ts` çš„ä»£ç å¤åˆ¶åˆ°æ¯ä¸ªå‡½æ•°ä¸­ã€‚

#### é€‰æ‹©Bï¼šä½¿ç”¨ CLI éƒ¨ç½²ï¼ˆæ¨èï¼‰

å³ä½¿é€šè¿‡ Dashboard éƒ¨ç½²ï¼Œå…±äº«æ¨¡å—çš„å¯¼å…¥ä»ç„¶æœ‰æ•ˆï¼Œå› ä¸º Supabase ä¼šè‡ªåŠ¨å¤„ç†ã€‚

**å»ºè®®**ï¼šå…ˆå°è¯•é€šè¿‡ Dashboard éƒ¨ç½²ï¼Œå¦‚æœå¯¼å…¥å¤±è´¥ï¼Œå†ä½¿ç”¨ CLIã€‚

---

## ğŸ“‹ éƒ¨ç½²æ¸…å•

### éœ€è¦éƒ¨ç½²çš„å‡½æ•°

- [ ] `get-tracking-token`
- [ ] `add-vehicle`
- [ ] `vehicle-tracking`
- [ ] `sync-vehicle-tracking-ids`
- [ ] `sync-vehicle`

### éƒ¨ç½²åéªŒè¯

- [ ] æ‰€æœ‰å‡½æ•°çŠ¶æ€ä¸º **Active**
- [ ] æ—¥å¿—æ˜¾ç¤º "ä»å…±äº«æ¨¡å—è·å–åˆ° Token"
- [ ] æµ‹è¯•å‡½æ•°è°ƒç”¨æˆåŠŸ
- [ ] Token ç¼“å­˜åŠŸèƒ½æ­£å¸¸

---

## ğŸ” éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥å‡½æ•°çŠ¶æ€

åœ¨ Supabase Dashboard ä¸­ï¼š
1. è¿›å…¥ **Edge Functions** é¡µé¢
2. ç¡®è®¤æ‰€æœ‰å‡½æ•°çŠ¶æ€ä¸º **Active**

### 2. æŸ¥çœ‹æ—¥å¿—

1. ç‚¹å‡»å‡½æ•°åï¼ˆå¦‚ `add-vehicle`ï¼‰
2. è¿›å…¥ **Logs** æ ‡ç­¾é¡µ
3. åº”è¯¥çœ‹åˆ°ï¼š`âœ… ä»å…±äº«æ¨¡å—è·å–åˆ° Token`

### 3. æµ‹è¯•å‡½æ•°

```bash
# æµ‹è¯• get-tracking-token
curl -X POST https://mnwzvtvyauyxwowjjsmf.supabase.co/functions/v1/get-tracking-token \
  -H "Authorization: Bearer <your-anon-key>" \
  -H "Content-Type: application/json" \
  -d '{"type": "add"}'
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å…±äº«æ¨¡å—**ï¼š`_shared/token-cache.ts` ä¼šè‡ªåŠ¨åŒ…å«åœ¨éƒ¨ç½²ä¸­ï¼Œæ— éœ€å•ç‹¬éƒ¨ç½²
2. **ç¯å¢ƒå˜é‡**ï¼šç¡®ä¿ä»¥ä¸‹ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆå¯é€‰ï¼‰ï¼š
   - `PWD_ADD` æˆ– `TRACKING_ADD_PASSWORD`
   - `PWD_QUERY` æˆ– `TRACKING_QUERY_PASSWORD`
3. **æ•°æ®åº“è¡¨**ï¼šç¡®ä¿ `tracking_token_cache` è¡¨å·²åˆ›å»ºï¼ˆæ‰§è¡Œè¿ç§»æ–‡ä»¶ï¼‰

---

**æœ€åæ›´æ–°**ï¼š2025-01-16

