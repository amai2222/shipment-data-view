# 多装多卸功能实现说明

## 功能概述

实现了运单管理的多装多卸功能，支持在单个运单中记录多个装货地点和卸货地点，地点之间用 `|` 分隔。

## 实现内容

### 1. 数据库支持

#### 迁移脚本
- 文件：`supabase/migrations/20250120000010_add_multi_location_support.sql`
- 功能：
  - 添加地点格式验证函数
  - 创建地点解析和合并函数
  - 添加GIN索引支持地点查询
  - 创建视图简化地点查询

#### 数据库函数
```sql
-- 验证地点格式
validate_location_format(location_text TEXT)

-- 解析地点字符串为数组
parse_locations(location_text TEXT)

-- 合并地点数组为字符串
merge_locations(locations TEXT[])
```

### 2. 前端组件

#### MultiLocationInput 组件
- 文件：`src/components/MultiLocationInput.tsx`
- 功能：
  - 支持多地点选择
  - 支持自定义地点添加
  - 地点标签显示和删除
  - 最大地点数量限制
  - 响应式设计

#### 主要特性
- **多选支持**：可以选择多个地点
- **自定义添加**：可以添加新的地点到数据库
- **视觉反馈**：已选择的地点以标签形式显示
- **数量限制**：最多支持5个地点
- **实时更新**：添加新地点后自动刷新选项

### 3. 运单表单修改

#### LogisticsFormDialog 组件
- 文件：`src/pages/BusinessEntry/components/LogisticsFormDialog.tsx`
- 修改内容：
  - FormData接口改为支持地点ID数组
  - 地点选择器替换为MultiLocationInput组件
  - 数据解析和提交逻辑更新
  - 编辑模式下的数据回填逻辑

#### 关键修改
```typescript
// 接口修改
interface FormData {
  loadingLocationIds: string[];  // 改为数组
  unloadingLocationIds: string[]; // 改为数组
}

// 数据解析
const parseLocationString = (locationString: string): string[] => {
  if (!locationString) return [];
  return locationString.split('|').map(loc => loc.trim()).filter(Boolean);
};

// 数据提交
const loadingLocationNames = formData.loadingLocationIds
  .map(id => locations.find(l => l.id === id)?.name)
  .filter(Boolean)
  .join('|');
```

### 4. Excel导入支持

#### 导入逻辑修改
- 文件：`src/pages/BusinessEntry/hooks/useExcelImport.ts`
- 修改内容：
  - 表头校验更新（卸货日期改为可选）
  - 数据处理逻辑支持多地点解析
  - 地点字符串清理和格式化

#### 数据处理
```typescript
// 处理多地点：将地点字符串按|分割并清理
if (cleanedRow['装货地点']) {
  cleanedRow['装货地点'] = cleanedRow['装货地点']
    .split('|')
    .map((loc: string) => loc.trim())
    .filter((loc: string) => loc)
    .join('|');
}
```

### 5. 模板下载更新

#### 模板示例
- 文件：`src/pages/BusinessEntry/index.tsx`
- 更新内容：
  - 示例数据包含多地点格式
  - 装货地点：`北京仓库|天津仓库`
  - 卸货地点：`上海仓库|苏州仓库`

### 6. 表格显示优化

#### 多地点显示
- 装货地点和卸货地点分行显示
- 地点名称截取前2个字符
- 多个地点用逗号分隔
- 箭头指示装货到卸货的流向

## 使用方法

### 1. 新增运单
1. 点击"添加运单"按钮
2. 在装货地点和卸货地点字段中：
   - 从下拉列表选择现有地点
   - 点击"添加自定义地点"输入新地点
   - 可以添加多个地点（最多5个）
3. 保存运单

### 2. 编辑运单
1. 点击运单记录的"编辑"按钮
2. 系统自动解析现有地点并显示
3. 可以添加或删除地点
4. 保存修改

### 3. Excel导入
1. 下载最新模板
2. 在装货地点和卸货地点列中使用 `|` 分隔多个地点
3. 例如：`北京仓库|天津仓库|石家庄仓库`
4. 上传Excel文件进行导入

## 数据格式

### 数据库存储格式
```
装货地点: "北京仓库|天津仓库|石家庄仓库"
卸货地点: "上海仓库|苏州仓库|杭州仓库"
```

### Excel格式
```
装货地点: "北京仓库|天津仓库|石家庄仓库"
卸货地点: "上海仓库|苏州仓库|杭州仓库"
```

## 技术特点

### 1. 向后兼容
- 现有单地点数据无需修改
- 系统自动处理单地点和多地点格式
- 数据库字段保持TEXT类型

### 2. 数据验证
- 地点格式验证（不允许以|开头或结尾）
- 空地点自动过滤
- 重复地点自动去重

### 3. 性能优化
- GIN索引支持地点查询
- 地点解析函数优化
- 前端组件懒加载

### 4. 用户体验
- 直观的多地点选择界面
- 实时地点添加功能
- 清晰的视觉反馈
- 响应式设计

## 注意事项

1. **地点数量限制**：最多支持5个装货地点和5个卸货地点
2. **地点分隔符**：使用 `|` 作为地点分隔符，不要使用其他符号
3. **数据一致性**：编辑时确保地点ID和名称的一致性
4. **导入格式**：Excel导入时地点格式必须正确，否则可能导致数据错误

## 扩展性

该实现为未来功能扩展预留了空间：
- 可以轻松调整最大地点数量
- 支持更复杂的地点关系（如装货顺序）
- 可以添加地点类型分类
- 支持地点坐标和地图显示
