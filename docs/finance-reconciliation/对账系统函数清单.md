# å¯¹è´¦ç³»ç»Ÿå‡½æ•°æ¸…å•

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ—å‡ºäº†å¯¹è´¦ç³»ç»Ÿä¿®æ”¹æˆ–æ–°å¢çš„æ‰€æœ‰æ•°æ®åº“å‡½æ•°ã€‚

---

## ğŸ†• æ–°å¢å‡½æ•°

### 1. `reconcile_partner_costs_batch`

**åŠŸèƒ½**ï¼šæ‰¹é‡å¯¹è´¦åˆä½œæ–¹æˆæœ¬è®°å½•

**æ–‡ä»¶**ï¼š
- `supabase/migrations/20250131_add_reconciliation_to_partner_costs.sql`ï¼ˆåˆ›å»ºï¼Œæ—¥æœŸï¼š2025-11-16ï¼‰
- `supabase/migrations/20250131_migrate_reconciliation_permissions_to_unified_system.sql`ï¼ˆæ›´æ–°æƒé™æ£€æŸ¥ï¼Œæ—¥æœŸï¼š2025-11-16ï¼‰

**å‡½æ•°ç­¾å**ï¼š
```sql
CREATE OR REPLACE FUNCTION public.reconcile_partner_costs_batch(
    p_cost_ids UUID[],
    p_reconciliation_status TEXT DEFAULT 'Reconciled',
    p_reconciliation_notes TEXT DEFAULT NULL
)
RETURNS JSONB
```

**å‚æ•°è¯´æ˜**ï¼š
- `p_cost_ids`ï¼šæˆæœ¬è®°å½•IDæ•°ç»„ï¼ˆUUID[]ï¼‰
- `p_reconciliation_status`ï¼šå¯¹è´¦çŠ¶æ€ï¼ˆTEXTï¼Œé»˜è®¤ 'Reconciled'ï¼‰
  - å¯é€‰å€¼ï¼š`'Reconciled'`ï¼ˆå·²å¯¹è´¦ï¼‰ã€`'Unreconciled'`ï¼ˆæœªå¯¹è´¦ï¼‰ã€`'Exception'`ï¼ˆå¼‚å¸¸ï¼‰
- `p_reconciliation_notes`ï¼šå¯¹è´¦å¤‡æ³¨ï¼ˆTEXTï¼Œå¯é€‰ï¼‰

**è¿”å›å€¼**ï¼š
```json
{
  "success": true,
  "message": "æˆåŠŸå¯¹è´¦ X æ¡è®°å½•ï¼ŒçŠ¶æ€ï¼šå·²å¯¹è´¦",
  "count": 10
}
```

**æƒé™è¦æ±‚**ï¼š
- æƒé™é”®ï¼š`finance.reconcile`
- æ£€æŸ¥æ–¹å¼ï¼š`has_function_permission('finance.reconcile')`

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ‰¹é‡æ›´æ–°å¤šä¸ªæˆæœ¬è®°å½•çš„å¯¹è´¦çŠ¶æ€
- è‡ªåŠ¨è®°å½•å¯¹è´¦æ—¶é—´å’Œæ“ä½œäººï¼ˆå½“çŠ¶æ€ä¸º 'Reconciled' æ—¶ï¼‰
- æ”¯æŒæ‰¹é‡è®¾ç½®å¯¹è´¦å¤‡æ³¨

---

### 2. `reconcile_partner_cost`

**åŠŸèƒ½**ï¼šå•ä¸ªå¯¹è´¦åˆä½œæ–¹æˆæœ¬è®°å½•ï¼ˆé€šè¿‡è¿å•IDå’Œåˆä½œæ–¹IDï¼‰

**æ–‡ä»¶**ï¼š
- `supabase/migrations/20250131_add_reconciliation_to_partner_costs.sql`ï¼ˆåˆ›å»ºï¼Œæ—¥æœŸï¼š2025-11-16ï¼‰
- `supabase/migrations/20250131_migrate_reconciliation_permissions_to_unified_system.sql`ï¼ˆæ›´æ–°æƒé™æ£€æŸ¥ï¼Œæ—¥æœŸï¼š2025-11-16ï¼‰

**å‡½æ•°ç­¾å**ï¼š
```sql
CREATE OR REPLACE FUNCTION public.reconcile_partner_cost(
    p_logistics_record_id UUID,
    p_partner_id UUID,
    p_reconciliation_status TEXT DEFAULT 'Reconciled',
    p_reconciliation_notes TEXT DEFAULT NULL
)
RETURNS JSONB
```

**å‚æ•°è¯´æ˜**ï¼š
- `p_logistics_record_id`ï¼šè¿å•IDï¼ˆUUIDï¼‰
- `p_partner_id`ï¼šåˆä½œæ–¹IDï¼ˆUUIDï¼‰
- `p_reconciliation_status`ï¼šå¯¹è´¦çŠ¶æ€ï¼ˆTEXTï¼Œé»˜è®¤ 'Reconciled'ï¼‰
  - å¯é€‰å€¼ï¼š`'Reconciled'`ï¼ˆå·²å¯¹è´¦ï¼‰ã€`'Unreconciled'`ï¼ˆæœªå¯¹è´¦ï¼‰ã€`'Exception'`ï¼ˆå¼‚å¸¸ï¼‰
- `p_reconciliation_notes`ï¼šå¯¹è´¦å¤‡æ³¨ï¼ˆTEXTï¼Œå¯é€‰ï¼‰

**è¿”å›å€¼**ï¼š
```json
{
  "success": true,
  "message": "å¯¹è´¦æˆåŠŸï¼ŒçŠ¶æ€ï¼šå·²å¯¹è´¦",
  "cost_id": "uuid-here"
}
```

**æƒé™è¦æ±‚**ï¼š
- æƒé™é”®ï¼š`finance.reconcile`
- æ£€æŸ¥æ–¹å¼ï¼š`has_function_permission('finance.reconcile')`

**åŠŸèƒ½è¯´æ˜**ï¼š
- é€šè¿‡è¿å•IDå’Œåˆä½œæ–¹IDæŸ¥æ‰¾å¯¹åº”çš„æˆæœ¬è®°å½•
- æ›´æ–°è¯¥æˆæœ¬è®°å½•çš„å¯¹è´¦çŠ¶æ€
- è‡ªåŠ¨è®°å½•å¯¹è´¦æ—¶é—´å’Œæ“ä½œäººï¼ˆå½“çŠ¶æ€ä¸º 'Reconciled' æ—¶ï¼‰
- æ”¯æŒè®¾ç½®å¯¹è´¦å¤‡æ³¨

---

## ğŸ”„ ä¿®æ”¹å‡½æ•°

### 3. `get_finance_reconciliation_by_partner_1116`

**åŠŸèƒ½**ï¼šè¿è´¹å¯¹è´¦æŸ¥è¯¢å‡½æ•°ï¼ˆæ”¯æŒå¯¹è´¦çŠ¶æ€ç­›é€‰å’Œè¿”å›å¯¹è´¦ä¿¡æ¯ï¼‰

**æ–‡ä»¶**ï¼š
- `supabase/migrations/20250131_update_reconciliation_function_to_return_status.sql`ï¼ˆæ›´æ–°ï¼Œæ—¥æœŸï¼š2025-11-16ï¼‰

**å‡½æ•°ç­¾å**ï¼š
```sql
CREATE OR REPLACE FUNCTION public.get_finance_reconciliation_by_partner_1116(
    -- å¸¸è§„ç­›é€‰å‚æ•°
    p_project_id text DEFAULT NULL,
    p_start_date date DEFAULT NULL,
    p_end_date date DEFAULT NULL,
    p_partner_id uuid DEFAULT NULL,
    
    -- åˆ†é¡µå‚æ•°
    p_page_number integer DEFAULT 1,
    p_page_size integer DEFAULT 50,
    
    -- é«˜çº§ç­›é€‰å‚æ•°
    p_driver_name text DEFAULT NULL,
    p_license_plate text DEFAULT NULL,
    p_driver_phone text DEFAULT NULL,
    p_waybill_numbers text DEFAULT NULL,
    p_other_platform_name text DEFAULT NULL,
    
    -- å¯¹è´¦çŠ¶æ€ç­›é€‰ï¼ˆæ–°å¢ï¼‰
    p_reconciliation_status text DEFAULT NULL
)
RETURNS jsonb
```

**æ–°å¢å‚æ•°**ï¼š
- `p_reconciliation_status`ï¼šå¯¹è´¦çŠ¶æ€ç­›é€‰ï¼ˆTEXTï¼Œå¯é€‰ï¼‰
  - å¯é€‰å€¼ï¼š`'Unreconciled'`ï¼ˆæœªå¯¹è´¦ï¼‰ã€`'Reconciled'`ï¼ˆå·²å¯¹è´¦ï¼‰ã€`'Exception'`ï¼ˆå¼‚å¸¸ï¼‰
  - `NULL` æˆ–ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸ç­›é€‰

**è¿”å›å€¼å˜æ›´**ï¼š
åœ¨ `partner_costs` æ•°ç»„ä¸­ï¼Œæ¯ä¸ªåˆä½œæ–¹æˆæœ¬è®°å½•æ–°å¢ä»¥ä¸‹å­—æ®µï¼š
```json
{
  "partner_id": "uuid",
  "partner_name": "åˆä½œæ–¹åç§°",
  "level": 1,
  "payable_amount": 1000.00,
  "reconciliation_status": "Reconciled",        // âœ… æ–°å¢
  "reconciliation_date": "2025-11-16 10:00:00", // âœ… æ–°å¢
  "reconciliation_notes": "å¯¹è´¦å¤‡æ³¨",            // âœ… æ–°å¢
  "cost_id": "uuid"                              // âœ… æ–°å¢ï¼ˆç”¨äºå¯¹è´¦æ“ä½œï¼‰
}
```

**åŠŸèƒ½å˜æ›´**ï¼š
1. **æ–°å¢å¯¹è´¦çŠ¶æ€ç­›é€‰**ï¼š
   - æ”¯æŒæŒ‰å¯¹è´¦çŠ¶æ€ç­›é€‰è¿å•
   - å¦‚æœè¿å•çš„ä»»ä¸€åˆä½œæ–¹æˆæœ¬ç¬¦åˆç­›é€‰æ¡ä»¶ï¼Œè¯¥è¿å•ä¼šè¢«åŒ…å«åœ¨ç»“æœä¸­

2. **è¿”å›å¯¹è´¦ä¿¡æ¯**ï¼š
   - åœ¨ `partner_costs` ä¸­è¿”å›å¯¹è´¦çŠ¶æ€ã€æ—¥æœŸã€å¤‡æ³¨
   - è¿”å› `cost_id` ç”¨äºåç»­å¯¹è´¦æ“ä½œ

**æŸ¥è¯¢é€»è¾‘**ï¼š
```sql
-- å¯¹è´¦çŠ¶æ€ç­›é€‰é€»è¾‘
AND (p_reconciliation_status IS NULL OR p_reconciliation_status = '' OR
     EXISTS (
       SELECT 1 FROM public.logistics_partner_costs lpc
       WHERE lpc.logistics_record_id = lr.id
       AND lpc.reconciliation_status = p_reconciliation_status
     )
)
```

---

## ğŸ“Š å‡½æ•°åˆ†ç±»æ±‡æ€»

### æŒ‰åŠŸèƒ½åˆ†ç±»

| åˆ†ç±» | å‡½æ•°å | æ“ä½œç±»å‹ |
|------|--------|---------|
| **å¯¹è´¦æ“ä½œ** | `reconcile_partner_costs_batch` | æ–°å¢ |
| **å¯¹è´¦æ“ä½œ** | `reconcile_partner_cost` | æ–°å¢ |
| **æ•°æ®æŸ¥è¯¢** | `get_finance_reconciliation_by_partner_1116` | ä¿®æ”¹ |

### æŒ‰è¿ç§»æ–‡ä»¶åˆ†ç±»

| è¿ç§»æ–‡ä»¶ | å‡½æ•°å | æ“ä½œ |
|---------|--------|------|
| `20250131_add_reconciliation_to_partner_costs.sql` | `reconcile_partner_costs_batch` | åˆ›å»º |
| `20250131_add_reconciliation_to_partner_costs.sql` | `reconcile_partner_cost` | åˆ›å»º |
| `20250131_migrate_reconciliation_permissions_to_unified_system.sql` | `reconcile_partner_costs_batch` | æ›´æ–°æƒé™æ£€æŸ¥ |
| `20250131_migrate_reconciliation_permissions_to_unified_system.sql` | `reconcile_partner_cost` | æ›´æ–°æƒé™æ£€æŸ¥ |
| `20250131_update_reconciliation_function_to_return_status.sql` | `get_finance_reconciliation_by_partner_1116` | æ›´æ–°æŸ¥è¯¢é€»è¾‘ |

---

## ğŸ” æƒé™è¦æ±‚

### ç»Ÿä¸€æƒé™ç³»ç»Ÿ

æ‰€æœ‰å¯¹è´¦æ“ä½œå‡½æ•°éƒ½ä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿè¿›è¡Œæƒé™æ£€æŸ¥ï¼š

**æƒé™é”®**ï¼š`finance.reconcile`

**æ£€æŸ¥æ–¹å¼**ï¼š
```sql
IF NOT public.has_function_permission('finance.reconcile') THEN
    RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šæ‚¨æ²¡æœ‰è¿è´¹å¯¹è´¦æƒé™ã€‚éœ€è¦ finance.reconcile æƒé™';
END IF;
```

**é»˜è®¤é…ç½®**ï¼š
- `finance` è§’è‰²é»˜è®¤æ‹¥æœ‰ `finance.reconcile` æƒé™
- `admin` è§’è‰²è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™

**æƒé™ç®¡ç†**ï¼š
- é€šè¿‡ `role_permission_templates` è¡¨é…ç½®è§’è‰²æƒé™
- é€šè¿‡ `user_permissions` è¡¨ä¸ºç”¨æˆ·å•ç‹¬é…ç½®æƒé™

---

## ğŸ“ å‡½æ•°è°ƒç”¨ç¤ºä¾‹

### æ‰¹é‡å¯¹è´¦

```sql
-- æ‰¹é‡å¯¹è´¦å¤šä¸ªæˆæœ¬è®°å½•
SELECT public.reconcile_partner_costs_batch(
    ARRAY['uuid1', 'uuid2', 'uuid3']::UUID[],
    'Reconciled',
    'æ‰¹é‡å¯¹è´¦å¤‡æ³¨'
);
```

### å•ä¸ªå¯¹è´¦

```sql
-- å¯¹å•ä¸ªè¿å•çš„ç‰¹å®šåˆä½œæ–¹è¿›è¡Œå¯¹è´¦
SELECT public.reconcile_partner_cost(
    'logistics-record-uuid'::UUID,
    'partner-uuid'::UUID,
    'Reconciled',
    'å¯¹è´¦å¤‡æ³¨'
);
```

### æŸ¥è¯¢å¯¹è´¦æ•°æ®

```sql
-- æŸ¥è¯¢æœªå¯¹è´¦çš„è¿å•
SELECT public.get_finance_reconciliation_by_partner_1116(
    p_project_id := NULL,
    p_start_date := '2025-01-01'::date,
    p_end_date := '2025-11-16'::date,
    p_partner_id := NULL,
    p_page_number := 1,
    p_page_size := 50,
    p_reconciliation_status := 'Unreconciled'  -- âœ… æ–°å¢å‚æ•°
);
```

---

## ğŸ”„ å‡½æ•°ç‰ˆæœ¬å†å²

### `reconcile_partner_costs_batch`

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|---------|
| v1.0 | 2025-11-16 | åˆ›å»ºå‡½æ•°ï¼Œä½¿ç”¨ `is_finance_or_admin()` æƒé™æ£€æŸ¥ |
| v2.0 | 2025-11-16 | æ›´æ–°ä¸ºä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿ `has_function_permission('finance.reconcile')` |

### `reconcile_partner_cost`

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|---------|
| v1.0 | 2025-11-16 | åˆ›å»ºå‡½æ•°ï¼Œä½¿ç”¨ `is_finance_or_admin()` æƒé™æ£€æŸ¥ |
| v2.0 | 2025-11-16 | æ›´æ–°ä¸ºä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿ `has_function_permission('finance.reconcile')` |

### `get_finance_reconciliation_by_partner_1116`

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|---------|
| v1.0 | ä¹‹å‰ | åŸæœ‰æŸ¥è¯¢å‡½æ•° |
| v2.0 | 2025-11-16 | æ–°å¢å¯¹è´¦çŠ¶æ€ç­›é€‰å‚æ•° `p_reconciliation_status` |
| v2.0 | 2025-11-16 | åœ¨è¿”å›ç»“æœä¸­æ–°å¢å¯¹è´¦çŠ¶æ€ã€æ—¥æœŸã€å¤‡æ³¨ã€cost_id å­—æ®µ |

---

## âœ… æ€»ç»“

å¯¹è´¦ç³»ç»Ÿå…±æ¶‰åŠ **3ä¸ªå‡½æ•°**ï¼š

1. **æ–°å¢å‡½æ•°ï¼ˆ2ä¸ªï¼‰**ï¼š
   - `reconcile_partner_costs_batch`ï¼šæ‰¹é‡å¯¹è´¦
   - `reconcile_partner_cost`ï¼šå•ä¸ªå¯¹è´¦

2. **ä¿®æ”¹å‡½æ•°ï¼ˆ1ä¸ªï¼‰**ï¼š
   - `get_finance_reconciliation_by_partner_1116`ï¼šæŸ¥è¯¢å‡½æ•°ï¼ˆæ–°å¢å¯¹è´¦çŠ¶æ€ç­›é€‰å’Œè¿”å›å¯¹è´¦ä¿¡æ¯ï¼‰

æ‰€æœ‰å¯¹è´¦æ“ä½œå‡½æ•°éƒ½ä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿï¼ˆ`finance.reconcile`ï¼‰è¿›è¡Œæƒé™æ£€æŸ¥ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-11-16

