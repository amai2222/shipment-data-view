# 对账系统函数清单

## 📋 概述

本文档列出了对账系统修改或新增的所有数据库函数。

---

## 🆕 新增函数

### 自动对账函数

#### 1. `auto_reconcile_by_waybill_1116` ⭐ 推荐使用

**功能**：基于运单号精确匹配的自动对账功能

**文件**：
- `supabase/migrations/20250131_add_auto_reconciliation_function.sql`（创建，日期：2025-11-16）

**函数签名**：
```sql
CREATE OR REPLACE FUNCTION public.auto_reconcile_by_waybill_1116(
    p_partner_id UUID DEFAULT NULL
)
RETURNS JSONB
```

**参数说明**：
- `p_partner_id`：合作方ID（UUID，可选）
  - 如果为 `NULL`，对所有合作方自动对账
  - 如果指定合作方ID，只对该合作方自动对账

**返回值**：
```json
{
  "success": true,
  "matched_count": 100,
  "unmatched_count": 50,
  "message": "自动对账完成：已匹配 100 条记录，待处理 50 条记录"
}
```

**权限要求**：
- 权限键：`finance.reconcile`
- 检查方式：`has_function_permission('finance.reconcile')`

**匹配规则**：
- 运单号存在（`auto_number IS NOT NULL`）
- 运单号不为空（`TRIM(auto_number) != ''`）
- 应付金额 > 0
- 当前状态为未对账（`reconciliation_status = 'Unreconciled'`）

**匹配准确率**：100%

**使用场景**：
- 新导入的运单数据（有运单号）
- 日常对账（定期执行）
- 批量处理大量记录

---

#### 2. `auto_reconcile_smart_1116`

**功能**：智能自动对账功能（多维度匹配）

**文件**：
- `supabase/migrations/20250131_add_auto_reconciliation_function.sql`（创建，日期：2025-11-16）

**函数签名**：
```sql
CREATE OR REPLACE FUNCTION public.auto_reconcile_smart_1116(
    p_partner_id UUID DEFAULT NULL,
    p_auto_confirm_confidence NUMERIC DEFAULT 0.95
)
RETURNS JSONB
```

**参数说明**：
- `p_partner_id`：合作方ID（UUID，可选）
- `p_auto_confirm_confidence`：置信度阈值（NUMERIC，默认 0.95）
  - >= 0.95：自动对账
  - < 0.95：待审核

**返回值**：
```json
{
  "success": true,
  "exact_matched": 80,
  "waybill_matched": 20,
  "amount_matched": 0,
  "pending_review": 10,
  "total_matched": 100,
  "message": "自动对账完成：精确匹配 80 条，运单号匹配 20 条，待审核 10 条"
}
```

**权限要求**：
- 权限键：`finance.reconcile`
- 检查方式：`has_function_permission('finance.reconcile')`

**匹配优先级**：
1. 精确匹配（运单号 + 金额 + 日期）
2. 运单号匹配（运单号 + 金额）
3. 金额匹配（金额 + 日期范围）

**注意**：此函数为高级功能，当前版本主要使用 `auto_reconcile_by_waybill_1116`

---

### 手动对账函数

#### 3. `reconcile_partner_costs_batch`

**功能**：批量对账合作方成本记录

**文件**：
- `supabase/migrations/20250131_add_reconciliation_to_partner_costs.sql`（创建，日期：2025-11-16）
- `supabase/migrations/20250131_migrate_reconciliation_permissions_to_unified_system.sql`（更新权限检查，日期：2025-11-16）

**函数签名**：
```sql
CREATE OR REPLACE FUNCTION public.reconcile_partner_costs_batch(
    p_cost_ids UUID[],
    p_reconciliation_status TEXT DEFAULT 'Reconciled',
    p_reconciliation_notes TEXT DEFAULT NULL
)
RETURNS JSONB
```

**参数说明**：
- `p_cost_ids`：成本记录ID数组（UUID[]）
- `p_reconciliation_status`：对账状态（TEXT，默认 'Reconciled'）
  - 可选值：`'Reconciled'`（已对账）、`'Unreconciled'`（未对账）、`'Exception'`（异常）
- `p_reconciliation_notes`：对账备注（TEXT，可选）

**返回值**：
```json
{
  "success": true,
  "message": "成功对账 X 条记录，状态：已对账",
  "count": 10
}
```

**权限要求**：
- 权限键：`finance.reconcile`
- 检查方式：`has_function_permission('finance.reconcile')`

**功能说明**：
- 批量更新多个成本记录的对账状态
- 自动记录对账时间和操作人（当状态为 'Reconciled' 时）
- 支持批量设置对账备注

---

### 2. `reconcile_partner_cost`

**功能**：单个对账合作方成本记录（通过运单ID和合作方ID）

**文件**：
- `supabase/migrations/20250131_add_reconciliation_to_partner_costs.sql`（创建，日期：2025-11-16）
- `supabase/migrations/20250131_migrate_reconciliation_permissions_to_unified_system.sql`（更新权限检查，日期：2025-11-16）

**函数签名**：
```sql
CREATE OR REPLACE FUNCTION public.reconcile_partner_cost(
    p_logistics_record_id UUID,
    p_partner_id UUID,
    p_reconciliation_status TEXT DEFAULT 'Reconciled',
    p_reconciliation_notes TEXT DEFAULT NULL
)
RETURNS JSONB
```

**参数说明**：
- `p_logistics_record_id`：运单ID（UUID）
- `p_partner_id`：合作方ID（UUID）
- `p_reconciliation_status`：对账状态（TEXT，默认 'Reconciled'）
  - 可选值：`'Reconciled'`（已对账）、`'Unreconciled'`（未对账）、`'Exception'`（异常）
- `p_reconciliation_notes`：对账备注（TEXT，可选）

**返回值**：
```json
{
  "success": true,
  "message": "对账成功，状态：已对账",
  "cost_id": "uuid-here"
}
```

**权限要求**：
- 权限键：`finance.reconcile`
- 检查方式：`has_function_permission('finance.reconcile')`

**功能说明**：
- 通过运单ID和合作方ID查找对应的成本记录
- 更新该成本记录的对账状态
- 自动记录对账时间和操作人（当状态为 'Reconciled' 时）
- 支持设置对账备注

---

## 🔄 修改函数

### 3. `get_finance_reconciliation_by_partner_1116`

**功能**：运费对账查询函数（支持对账状态筛选和返回对账信息）

**文件**：
- `supabase/migrations/20250131_update_reconciliation_function_to_return_status.sql`（更新，日期：2025-11-16）

**函数签名**：
```sql
CREATE OR REPLACE FUNCTION public.get_finance_reconciliation_by_partner_1116(
    -- 常规筛选参数
    p_project_id text DEFAULT NULL,
    p_start_date date DEFAULT NULL,
    p_end_date date DEFAULT NULL,
    p_partner_id uuid DEFAULT NULL,
    
    -- 分页参数
    p_page_number integer DEFAULT 1,
    p_page_size integer DEFAULT 50,
    
    -- 高级筛选参数
    p_driver_name text DEFAULT NULL,
    p_license_plate text DEFAULT NULL,
    p_driver_phone text DEFAULT NULL,
    p_waybill_numbers text DEFAULT NULL,
    p_other_platform_name text DEFAULT NULL,
    
    -- 对账状态筛选（新增）
    p_reconciliation_status text DEFAULT NULL
)
RETURNS jsonb
```

**新增参数**：
- `p_reconciliation_status`：对账状态筛选（TEXT，可选）
  - 可选值：`'Unreconciled'`（未对账）、`'Reconciled'`（已对账）、`'Exception'`（异常）
  - `NULL` 或空字符串表示不筛选

**返回值变更**：
在 `partner_costs` 数组中，每个合作方成本记录新增以下字段：
```json
{
  "partner_id": "uuid",
  "partner_name": "合作方名称",
  "level": 1,
  "payable_amount": 1000.00,
  "reconciliation_status": "Reconciled",        // ✅ 新增
  "reconciliation_date": "2025-11-16 10:00:00", // ✅ 新增
  "reconciliation_notes": "对账备注",            // ✅ 新增
  "cost_id": "uuid"                              // ✅ 新增（用于对账操作）
}
```

**功能变更**：
1. **新增对账状态筛选**：
   - 支持按对账状态筛选运单
   - 如果运单的任一合作方成本符合筛选条件，该运单会被包含在结果中

2. **返回对账信息**：
   - 在 `partner_costs` 中返回对账状态、日期、备注
   - 返回 `cost_id` 用于后续对账操作

**查询逻辑**：
```sql
-- 对账状态筛选逻辑
AND (p_reconciliation_status IS NULL OR p_reconciliation_status = '' OR
     EXISTS (
       SELECT 1 FROM public.logistics_partner_costs lpc
       WHERE lpc.logistics_record_id = lr.id
       AND lpc.reconciliation_status = p_reconciliation_status
     )
)
```

---

## 📊 函数分类汇总

### 按功能分类

| 分类 | 函数名 | 操作类型 |
|------|--------|---------|
| **对账操作** | `reconcile_partner_costs_batch` | 新增 |
| **对账操作** | `reconcile_partner_cost` | 新增 |
| **数据查询** | `get_finance_reconciliation_by_partner_1116` | 修改 |

### 按迁移文件分类

| 迁移文件 | 函数名 | 操作 |
|---------|--------|------|
| `20250131_add_reconciliation_to_partner_costs.sql` | `reconcile_partner_costs_batch` | 创建 |
| `20250131_add_reconciliation_to_partner_costs.sql` | `reconcile_partner_cost` | 创建 |
| `20250131_migrate_reconciliation_permissions_to_unified_system.sql` | `reconcile_partner_costs_batch` | 更新权限检查 |
| `20250131_migrate_reconciliation_permissions_to_unified_system.sql` | `reconcile_partner_cost` | 更新权限检查 |
| `20250131_update_reconciliation_function_to_return_status.sql` | `get_finance_reconciliation_by_partner_1116` | 更新查询逻辑 |

---

## 🔐 权限要求

### 统一权限系统

所有对账操作函数都使用统一权限系统进行权限检查：

**权限键**：`finance.reconcile`

**检查方式**：
```sql
IF NOT public.has_function_permission('finance.reconcile') THEN
    RAISE EXCEPTION '权限不足：您没有运费对账权限。需要 finance.reconcile 权限';
END IF;
```

**默认配置**：
- `finance` 角色默认拥有 `finance.reconcile` 权限
- `admin` 角色自动拥有所有权限

**权限管理**：
- 通过 `role_permission_templates` 表配置角色权限
- 通过 `user_permissions` 表为用户单独配置权限

---

## 📝 函数调用示例

### 批量对账

```sql
-- 批量对账多个成本记录
SELECT public.reconcile_partner_costs_batch(
    ARRAY['uuid1', 'uuid2', 'uuid3']::UUID[],
    'Reconciled',
    '批量对账备注'
);
```

### 单个对账

```sql
-- 对单个运单的特定合作方进行对账
SELECT public.reconcile_partner_cost(
    'logistics-record-uuid'::UUID,
    'partner-uuid'::UUID,
    'Reconciled',
    '对账备注'
);
```

### 查询对账数据

```sql
-- 查询未对账的运单
SELECT public.get_finance_reconciliation_by_partner_1116(
    p_project_id := NULL,
    p_start_date := '2025-01-01'::date,
    p_end_date := '2025-11-16'::date,
    p_partner_id := NULL,
    p_page_number := 1,
    p_page_size := 50,
    p_reconciliation_status := 'Unreconciled'  -- ✅ 新增参数
);
```

---

## 🔄 函数版本历史

### `reconcile_partner_costs_batch`

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| v1.0 | 2025-11-16 | 创建函数，使用 `is_finance_or_admin()` 权限检查 |
| v2.0 | 2025-11-16 | 更新为使用统一权限系统 `has_function_permission('finance.reconcile')` |

### `reconcile_partner_cost`

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| v1.0 | 2025-11-16 | 创建函数，使用 `is_finance_or_admin()` 权限检查 |
| v2.0 | 2025-11-16 | 更新为使用统一权限系统 `has_function_permission('finance.reconcile')` |

### `get_finance_reconciliation_by_partner_1116`

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| v1.0 | 之前 | 原有查询函数 |
| v2.0 | 2025-11-16 | 新增对账状态筛选参数 `p_reconciliation_status` |
| v2.0 | 2025-11-16 | 在返回结果中新增对账状态、日期、备注、cost_id 字段 |

---

## ✅ 总结

对账系统共涉及 **3个函数**：

1. **新增函数（2个）**：
   - `reconcile_partner_costs_batch`：批量对账
   - `reconcile_partner_cost`：单个对账

2. **修改函数（1个）**：
   - `get_finance_reconciliation_by_partner_1116`：查询函数（新增对账状态筛选和返回对账信息）

所有对账操作函数都使用统一权限系统（`finance.reconcile`）进行权限检查。

---

**文档版本**：v1.0  
**最后更新**：2025-11-16

