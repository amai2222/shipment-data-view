# è¿è´¹å¯¹è´¦æƒé™è¿ç§»è¯´æ˜

## ğŸ“‹ è¿ç§»æ¦‚è¿°

å°†è¿è´¹å¯¹è´¦ç³»ç»Ÿçš„æƒé™æ£€æŸ¥ä»ç¡¬ç¼–ç è§’è‰²æ£€æŸ¥ï¼ˆ`is_finance_or_admin()`ï¼‰è¿ç§»åˆ°ç»Ÿä¸€æƒé™ç³»ç»Ÿï¼ˆ`has_function_permission()`ï¼‰ã€‚

## ğŸ¯ è¿ç§»ç›®æ ‡

- âœ… ç§»é™¤æ‰€æœ‰ç¡¬ç¼–ç çš„è§’è‰²æ£€æŸ¥
- âœ… ä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿ `has_function_permission()`
- âœ… æ‰€æœ‰æƒé™å¯é€šè¿‡æ•°æ®åº“é…ç½®ï¼ˆ`role_permission_templates` å’Œ `user_permissions` è¡¨ï¼‰
- âœ… æ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶

## ğŸ“ æƒé™é”®å®šä¹‰

### è¿è´¹å¯¹è´¦ç›¸å…³æƒé™

| æƒé™é”® | åŠŸèƒ½ | å‡½æ•° |
|--------|------|------|
| `finance.reconcile` | è¿è´¹å¯¹è´¦ | `reconcile_partner_costs_batch`<br>`reconcile_partner_cost` |

**è¯´æ˜**ï¼š
- `finance.reconcile` ç”¨äºè¿è´¹å¯¹è´¦ï¼ˆåˆä½œæ–¹åº”ä»˜é‡‘é¢å¯¹è´¦ï¼‰
- ä¸æ”¶æ¬¾å¯¹è´¦çš„ `finance.reconcile_receipt` æƒé™ä¸åŒï¼Œä¸¤è€…æ˜¯ç‹¬ç«‹çš„

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1ï¼šæ‰§è¡Œæƒé™è¿ç§»SQL

```sql
-- æ–‡ä»¶ï¼šsupabase/migrations/20250131_migrate_reconciliation_permissions_to_unified_system.sqlï¼ˆæ—¥æœŸï¼š2025-11-16ï¼‰
```

è¿™ä¸ªæ–‡ä»¶ä¼šï¼š
1. æ›´æ–°æ‰€æœ‰å¯¹è´¦ç›¸å…³å‡½æ•°ï¼Œä½¿ç”¨ `has_function_permission('finance.reconcile')` æ£€æŸ¥æƒé™
2. ä¸º `finance` è§’è‰²è‡ªåŠ¨é…ç½®è¿è´¹å¯¹è´¦æƒé™
3. `admin` è§’è‰²è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ˆå·²åœ¨ `has_function_permission()` ä¸­å®ç°ï¼‰

### æ­¥éª¤2ï¼šéªŒè¯è¿ç§»ç»“æœ

æ‰§è¡Œä»¥ä¸‹SQLéªŒè¯ï¼š

```sql
-- æ£€æŸ¥å‡½æ•°æ˜¯å¦å·²æ›´æ–°
SELECT 
    proname AS function_name,
    prosrc AS function_body
FROM pg_proc
WHERE proname IN (
    'reconcile_partner_costs_batch',
    'reconcile_partner_cost'
)
ORDER BY proname;

-- æ£€æŸ¥æƒé™é…ç½®
SELECT 
    role,
    function_permissions
FROM public.role_permission_templates
WHERE role = 'finance'
  AND 'finance.reconcile' = ANY(COALESCE(function_permissions, ARRAY[]::TEXT[]));
```

### æ­¥éª¤3ï¼šæµ‹è¯•æƒé™åŠŸèƒ½

1. **ä½¿ç”¨ finance è§’è‰²æµ‹è¯•**ï¼š
   - åº”è¯¥èƒ½å¤Ÿæ‰§è¡Œå¯¹è´¦æ“ä½œ
   - åº”è¯¥èƒ½å¤ŸæŸ¥çœ‹å¯¹è´¦çŠ¶æ€

2. **ä½¿ç”¨æ™®é€šä¸šåŠ¡è§’è‰²æµ‹è¯•**ï¼š
   - åº”è¯¥ä¸èƒ½æ‰§è¡Œå¯¹è´¦æ“ä½œï¼ˆä¼šæç¤ºæƒé™ä¸è¶³ï¼‰
   - åº”è¯¥èƒ½å¤ŸæŸ¥çœ‹å¯¹è´¦çŠ¶æ€ï¼ˆåªè¯»ï¼‰

3. **ä½¿ç”¨ admin è§’è‰²æµ‹è¯•**ï¼š
   - åº”è¯¥èƒ½å¤Ÿæ‰§è¡Œæ‰€æœ‰å¯¹è´¦æ“ä½œ

## ğŸ“Š è¿ç§»å‰åå¯¹æ¯”

### è¿ç§»å‰

```sql
-- ä½¿ç”¨ç¡¬ç¼–ç è§’è‰²æ£€æŸ¥
IF NOT public.is_finance_or_admin() THEN
    RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šåªæœ‰è´¢åŠ¡äººå‘˜æˆ–ç®¡ç†å‘˜å¯ä»¥å¯¹è´¦';
END IF;
```

**é—®é¢˜**ï¼š
- æƒé™æ£€æŸ¥ç¡¬ç¼–ç åœ¨å‡½æ•°ä¸­
- æ— æ³•çµæ´»é…ç½®æƒé™
- æ— æ³•ä¸ºç‰¹å®šç”¨æˆ·å•ç‹¬é…ç½®æƒé™

### è¿ç§»å

```sql
-- ä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿ
IF NOT public.has_function_permission('finance.reconcile') THEN
    RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šæ‚¨æ²¡æœ‰è¿è´¹å¯¹è´¦æƒé™ã€‚éœ€è¦ finance.reconcile æƒé™';
END IF;
```

**ä¼˜åŠ¿**ï¼š
- æƒé™æ£€æŸ¥é€šè¿‡ç»Ÿä¸€æƒé™ç³»ç»Ÿ
- å¯ä»¥é€šè¿‡æ•°æ®åº“é…ç½®æƒé™
- æ”¯æŒè§’è‰²æ¨¡æ¿å’Œç”¨æˆ·è‡ªå®šä¹‰æƒé™
- æ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶

## ğŸ”§ æƒé™é…ç½®æ–¹å¼

### æ–¹å¼1ï¼šé€šè¿‡è§’è‰²æ¨¡æ¿é…ç½®

```sql
-- ä¸º finance è§’è‰²æ·»åŠ è¿è´¹å¯¹è´¦æƒé™
UPDATE public.role_permission_templates
SET function_permissions = array_append(
    COALESCE(function_permissions, ARRAY[]::TEXT[]),
    'finance.reconcile'
)
WHERE role = 'finance';
```

### æ–¹å¼2ï¼šä¸ºç”¨æˆ·å•ç‹¬é…ç½®æƒé™

```sql
-- ä¸ºç‰¹å®šç”¨æˆ·æ·»åŠ è¿è´¹å¯¹è´¦æƒé™
INSERT INTO public.user_permissions (
    user_id,
    function_permissions
) VALUES (
    'user-uuid-here',
    ARRAY['finance.reconcile']
)
ON CONFLICT (user_id) 
DO UPDATE SET 
    function_permissions = array_append(
        COALESCE(user_permissions.function_permissions, ARRAY[]::TEXT[]),
        'finance.reconcile'
    );
```

### æ–¹å¼3ï¼šç§»é™¤ç”¨æˆ·æƒé™

```sql
-- ç§»é™¤ç”¨æˆ·çš„è¿è´¹å¯¹è´¦æƒé™
UPDATE public.user_permissions
SET function_permissions = array_remove(
    COALESCE(function_permissions, ARRAY[]::TEXT[]),
    'finance.reconcile'
)
WHERE user_id = 'user-uuid-here';
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æƒé™é”®åŒºåˆ†

- **è¿è´¹å¯¹è´¦**ï¼š`finance.reconcile`ï¼ˆæœ¬è¿ç§»ï¼‰
- **æ”¶æ¬¾å¯¹è´¦**ï¼š`finance.reconcile_receipt`ï¼ˆæ”¶æ¬¾ç³»ç»Ÿï¼‰
- ä¸¤è€…æ˜¯ç‹¬ç«‹çš„æƒé™ï¼Œéœ€è¦åˆ†åˆ«é…ç½®

### 2. å‘åå…¼å®¹

- `admin` è§’è‰²è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ˆåŒ…æ‹¬ `finance.reconcile`ï¼‰
- è¿ç§»ä¸ä¼šå½±å“ç°æœ‰ `admin` ç”¨æˆ·çš„å¯¹è´¦åŠŸèƒ½

### 3. æƒé™æ£€æŸ¥é¡ºåº

ç»Ÿä¸€æƒé™ç³»ç»ŸæŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥æƒé™ï¼š
1. æ£€æŸ¥ç”¨æˆ·è‡ªå®šä¹‰æƒé™ï¼ˆ`user_permissions` è¡¨ï¼‰
2. æ£€æŸ¥è§’è‰²æ¨¡æ¿æƒé™ï¼ˆ`role_permission_templates` è¡¨ï¼‰
3. æ£€æŸ¥æ˜¯å¦ä¸º `admin` è§’è‰²ï¼ˆè‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼‰

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [ç»Ÿä¸€æƒé™ç³»ç»Ÿè¯´æ˜](../../SYSTEM_DOCUMENTATION.md#ç»Ÿä¸€æƒé™ç³»ç»Ÿ)
- [è¿è´¹å¯¹è´¦é€»è¾‘è¯¦è§£](./è¿è´¹å¯¹è´¦é€»è¾‘è¯¦è§£.md)
- [æ”¶æ¬¾ç³»ç»Ÿæƒé™è¿ç§»è¯´æ˜](../../invoice-management/æ”¶æ¬¾ç³»ç»Ÿæƒé™è¿ç§»è¯´æ˜.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-11-16

