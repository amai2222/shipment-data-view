# å¯¹è´¦ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## ðŸ“‹ éƒ¨ç½²æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜Žå¦‚ä½•éƒ¨ç½²è¿è´¹å¯¹è´¦ç³»ç»Ÿåˆ°ç”Ÿäº§çŽ¯å¢ƒã€‚

## ðŸŽ¯ éƒ¨ç½²å‰å‡†å¤‡

### 1. æ£€æŸ¥ä¾èµ–

ç¡®ä¿ä»¥ä¸‹ç³»ç»Ÿå·²éƒ¨ç½²ï¼š
- âœ… ç»Ÿä¸€æƒé™ç³»ç»Ÿï¼ˆ`has_function_permission` å‡½æ•°ï¼‰
- âœ… `logistics_partner_costs` è¡¨å·²å­˜åœ¨
- âœ… `logistics_records` è¡¨å·²å­˜åœ¨
- âœ… `partners` è¡¨å·²å­˜åœ¨
- âœ… `auth.users` è¡¨å·²å­˜åœ¨

### 2. å¤‡ä»½æ•°æ®åº“

**é‡è¦**ï¼šåœ¨æ‰§è¡Œè¿ç§»å‰ï¼Œè¯·å…ˆå¤‡ä»½æ•°æ®åº“ï¼

```sql
-- å¤‡ä»½ç›¸å…³è¡¨
pg_dump -t logistics_partner_costs > backup_logistics_partner_costs.sql
```

## ðŸ“¦ SQL è¿ç§»æ–‡ä»¶æ‰§è¡Œé¡ºåº

### æ‰§è¡Œé¡ºåºï¼ˆé‡è¦ï¼ï¼‰

å¿…é¡»æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œ SQL æ–‡ä»¶ï¼š

#### ç¬¬ä¸€æ­¥ï¼šæ·»åŠ å¯¹è´¦å­—æ®µå’ŒåŸºç¡€å‡½æ•°

**æ–‡ä»¶**ï¼š`supabase/migrations/20250131_add_reconciliation_to_partner_costs.sql`

**åŠŸèƒ½**ï¼š
- ä¸º `logistics_partner_costs` è¡¨æ·»åŠ å¯¹è´¦ç›¸å…³å­—æ®µ
- åˆ›å»ºç´¢å¼•
- åˆ›å»ºå¯¹è´¦å‡½æ•°ï¼ˆä½¿ç”¨æ—§æƒé™æ£€æŸ¥ï¼‰

**æ‰§è¡Œå‘½ä»¤**ï¼š
```bash
# ä½¿ç”¨ Supabase CLI
supabase db execute -f supabase/migrations/20250131_add_reconciliation_to_partner_costs.sql

# æˆ–ç›´æŽ¥åœ¨æ•°æ®åº“å®¢æˆ·ç«¯æ‰§è¡Œ
psql -h your-host -U your-user -d your-database -f supabase/migrations/20250131_add_reconciliation_to_partner_costs.sql
```

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥å­—æ®µæ˜¯å¦æ·»åŠ æˆåŠŸ
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'logistics_partner_costs'
  AND column_name LIKE 'reconciliation%';

-- æ£€æŸ¥å‡½æ•°æ˜¯å¦åˆ›å»ºæˆåŠŸ
SELECT proname, prosrc
FROM pg_proc
WHERE proname IN ('reconcile_partner_costs_batch', 'reconcile_partner_cost');
```

---

#### ç¬¬äºŒæ­¥ï¼šè¿ç§»æƒé™ç³»ç»Ÿ

**æ–‡ä»¶**ï¼š`supabase/migrations/20250131_migrate_reconciliation_permissions_to_unified_system.sql`

**åŠŸèƒ½**ï¼š
- æ›´æ–°å¯¹è´¦å‡½æ•°ï¼Œä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿ
- ä¸º `finance` è§’è‰²é…ç½®å¯¹è´¦æƒé™

**æ‰§è¡Œå‘½ä»¤**ï¼š
```bash
supabase db execute -f supabase/migrations/20250131_migrate_reconciliation_permissions_to_unified_system.sql
```

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥å‡½æ•°æ˜¯å¦å·²æ›´æ–°ï¼ˆåº”è¯¥ä½¿ç”¨ has_function_permissionï¼‰
SELECT proname, prosrc
FROM pg_proc
WHERE proname = 'reconcile_partner_costs_batch'
  AND prosrc LIKE '%has_function_permission%';

-- æ£€æŸ¥æƒé™é…ç½®
SELECT role, function_permissions
FROM role_permission_templates
WHERE role = 'finance'
  AND 'finance.reconcile' = ANY(COALESCE(function_permissions, ARRAY[]::TEXT[]));
```

---

#### ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°æŸ¥è¯¢å‡½æ•°

**æ–‡ä»¶**ï¼š`supabase/migrations/20250131_update_reconciliation_function_to_return_status.sql`

**åŠŸèƒ½**ï¼š
- æ›´æ–° `get_finance_reconciliation_by_partner_1116` å‡½æ•°
- æ·»åŠ å¯¹è´¦çŠ¶æ€ç­›é€‰å‚æ•°
- è¿”å›žå¯¹è´¦çŠ¶æ€ä¿¡æ¯

**æ‰§è¡Œå‘½ä»¤**ï¼š
```bash
supabase db execute -f supabase/migrations/20250131_update_reconciliation_function_to_return_status.sql
```

**éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥å‡½æ•°å‚æ•°æ˜¯å¦åŒ…å«å¯¹è´¦çŠ¶æ€
SELECT 
    p.proname,
    pg_get_function_arguments(p.oid) as arguments
FROM pg_proc p
WHERE p.proname = 'get_finance_reconciliation_by_partner_1116';

-- æµ‹è¯•æŸ¥è¯¢å‡½æ•°
SELECT public.get_finance_reconciliation_by_partner_1116(
    p_project_id := NULL,
    p_start_date := CURRENT_DATE - INTERVAL '30 days',
    p_end_date := CURRENT_DATE,
    p_page_number := 1,
    p_page_size := 10,
    p_reconciliation_status := 'Unreconciled'
);
```

---

## ðŸ“Š å®Œæ•´æ‰§è¡Œæ¸…å•

### å¿«é€Ÿéƒ¨ç½²è„šæœ¬

åˆ›å»º `deploy_reconciliation_system.sql`ï¼š

```sql
-- ============================================================================
-- å¯¹è´¦ç³»ç»Ÿå®Œæ•´éƒ¨ç½²è„šæœ¬
-- æ‰§è¡Œæ—¥æœŸï¼š2025-11-16
-- ============================================================================

-- å¼€å§‹äº‹åŠ¡
BEGIN;

-- ============================================================================
-- ç¬¬ä¸€æ­¥ï¼šæ·»åŠ å¯¹è´¦å­—æ®µå’ŒåŸºç¡€å‡½æ•°
-- ============================================================================
\i supabase/migrations/20250131_add_reconciliation_to_partner_costs.sql

-- ============================================================================
-- ç¬¬äºŒæ­¥ï¼šè¿ç§»æƒé™ç³»ç»Ÿ
-- ============================================================================
\i supabase/migrations/20250131_migrate_reconciliation_permissions_to_unified_system.sql

-- ============================================================================
-- ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°æŸ¥è¯¢å‡½æ•°
-- ============================================================================
\i supabase/migrations/20250131_update_reconciliation_function_to_return_status.sql

-- æäº¤äº‹åŠ¡
COMMIT;

-- éªŒè¯éƒ¨ç½²
SELECT 'âœ… å¯¹è´¦ç³»ç»Ÿéƒ¨ç½²å®Œæˆ' AS status;
```

### ä½¿ç”¨ Supabase CLI éƒ¨ç½²

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/project

# 2. æŒ‰é¡ºåºæ‰§è¡Œè¿ç§»æ–‡ä»¶
supabase db execute -f supabase/migrations/20250131_add_reconciliation_to_partner_costs.sql
supabase db execute -f supabase/migrations/20250131_migrate_reconciliation_permissions_to_unified_system.sql
supabase db execute -f supabase/migrations/20250131_update_reconciliation_function_to_return_status.sql

# 3. éªŒè¯éƒ¨ç½²
supabase db execute -c "SELECT 'âœ… å¯¹è´¦ç³»ç»Ÿéƒ¨ç½²å®Œæˆ' AS status;"
```

---

## âœ… éƒ¨ç½²åŽéªŒè¯

### 1. æ£€æŸ¥æ•°æ®åº“ç»“æž„

```sql
-- æ£€æŸ¥è¡¨å­—æ®µ
SELECT 
    column_name,
    data_type,
    column_default,
    is_nullable
FROM information_schema.columns
WHERE table_name = 'logistics_partner_costs'
  AND column_name LIKE 'reconciliation%'
ORDER BY ordinal_position;

-- æ£€æŸ¥ç´¢å¼•
SELECT 
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename = 'logistics_partner_costs'
  AND indexname LIKE '%reconciliation%';
```

### 2. æ£€æŸ¥å‡½æ•°

```sql
-- æ£€æŸ¥æ‰€æœ‰å¯¹è´¦ç›¸å…³å‡½æ•°
SELECT 
    proname AS function_name,
    pg_get_function_arguments(oid) AS arguments,
    pg_get_function_result(oid) AS return_type
FROM pg_proc
WHERE proname IN (
    'reconcile_partner_costs_batch',
    'reconcile_partner_cost',
    'get_finance_reconciliation_by_partner_1116'
)
ORDER BY proname;
```

### 3. æ£€æŸ¥æƒé™é…ç½®

```sql
-- æ£€æŸ¥ finance è§’è‰²æƒé™
SELECT 
    role,
    function_permissions
FROM role_permission_templates
WHERE role = 'finance'
  AND 'finance.reconcile' = ANY(COALESCE(function_permissions, ARRAY[]::TEXT[]));
```

### 4. åŠŸèƒ½æµ‹è¯•

```sql
-- æµ‹è¯•æ‰¹é‡å¯¹è´¦å‡½æ•°ï¼ˆéœ€è¦ finance.reconcile æƒé™ï¼‰
SELECT public.reconcile_partner_costs_batch(
    ARRAY['test-uuid-1', 'test-uuid-2']::UUID[],
    'Reconciled',
    'æµ‹è¯•å¯¹è´¦'
);

-- æµ‹è¯•æŸ¥è¯¢å‡½æ•°
SELECT public.get_finance_reconciliation_by_partner_1116(
    p_project_id := NULL,
    p_start_date := CURRENT_DATE - INTERVAL '7 days',
    p_end_date := CURRENT_DATE,
    p_page_number := 1,
    p_page_size := 10,
    p_reconciliation_status := NULL
);
```

---

## ðŸ”§ æ•…éšœæŽ’é™¤

### é—®é¢˜1ï¼šå‡½æ•°åä¸å”¯ä¸€é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ERROR: 42725: function name "public.get_finance_reconciliation_by_partner_1116" is not unique
HINT: Specify the argument list to select the function unambiguously.
```

**åŽŸå› **ï¼šæ•°æ®åº“ä¸­å­˜åœ¨å¤šä¸ªåŒåä½†å‚æ•°ä¸åŒçš„å‡½æ•°ç‰ˆæœ¬ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ‰§è¡Œæ¸…ç†è„šæœ¬**ï¼š
```bash
psql -h your-host -U your-user -d your-database -f scripts/fix_reconciliation_function_conflict.sql
```

2. **æˆ–æ‰‹åŠ¨åˆ é™¤æ—§ç‰ˆæœ¬**ï¼š
```sql
-- åˆ é™¤æ²¡æœ‰ p_reconciliation_status å‚æ•°çš„æ—§ç‰ˆæœ¬
DROP FUNCTION IF EXISTS public.get_finance_reconciliation_by_partner_1116(
    text, date, date, uuid, integer, integer, text, text, text, text, text
);
```

3. **é‡æ–°æ‰§è¡Œè¿ç§»æ–‡ä»¶**ï¼š
```bash
supabase db execute -f supabase/migrations/20250131_update_reconciliation_function_to_return_status.sql
```

---

## ðŸ”„ å›žæ»šæ–¹æ¡ˆ

å¦‚æžœéƒ¨ç½²å¤±è´¥ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤å›žæ»šï¼š

### å›žæ»šæ­¥éª¤

```sql
-- 1. åˆ é™¤å‡½æ•°
DROP FUNCTION IF EXISTS public.reconcile_partner_costs_batch(UUID[], TEXT, TEXT);
DROP FUNCTION IF EXISTS public.reconcile_partner_cost(UUID, UUID, TEXT, TEXT);

-- 2. æ¢å¤ get_finance_reconciliation_by_partner_1116 å‡½æ•°ï¼ˆéœ€è¦ä»Žå¤‡ä»½æ¢å¤ï¼‰

-- 3. åˆ é™¤å­—æ®µï¼ˆè°¨æ…Žæ“ä½œï¼Œä¼šä¸¢å¤±æ•°æ®ï¼‰
ALTER TABLE public.logistics_partner_costs
DROP COLUMN IF EXISTS reconciliation_status,
DROP COLUMN IF EXISTS reconciliation_date,
DROP COLUMN IF EXISTS reconciliation_by,
DROP COLUMN IF EXISTS reconciliation_notes;

-- 4. åˆ é™¤ç´¢å¼•
DROP INDEX IF EXISTS idx_logistics_partner_costs_reconciliation_status;
DROP INDEX IF EXISTS idx_logistics_partner_costs_reconciliation_date;
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ‰§è¡Œé¡ºåº

**å¿…é¡»ä¸¥æ ¼æŒ‰ç…§é¡ºåºæ‰§è¡Œ**ï¼š
1. å…ˆæ·»åŠ å­—æ®µå’ŒåŸºç¡€å‡½æ•°
2. å†è¿ç§»æƒé™ç³»ç»Ÿ
3. æœ€åŽæ›´æ–°æŸ¥è¯¢å‡½æ•°

### 2. æƒé™è¦æ±‚

- æ‰§è¡Œè¿ç§»éœ€è¦æ•°æ®åº“ç®¡ç†å‘˜æƒé™
- ç¡®ä¿ `has_function_permission` å‡½æ•°å·²å­˜åœ¨
- ç¡®ä¿ `role_permission_templates` è¡¨å·²å­˜åœ¨

### 3. æ•°æ®å®‰å…¨

- **å¤‡ä»½æ•°æ®åº“**ï¼šæ‰§è¡Œå‰å¿…é¡»å¤‡ä»½
- **æµ‹è¯•çŽ¯å¢ƒ**ï¼šå»ºè®®å…ˆåœ¨æµ‹è¯•çŽ¯å¢ƒæ‰§è¡Œ
- **äº‹åŠ¡å¤„ç†**ï¼šå»ºè®®åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œä¾¿äºŽå›žæ»š

### 4. æ€§èƒ½å½±å“

- æ·»åŠ å­—æ®µæ—¶ï¼Œå¦‚æžœè¡¨æ•°æ®é‡å¤§ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
- åˆ›å»ºç´¢å¼•æ—¶ï¼Œå¯èƒ½ä¼šé”å®šè¡¨
- å»ºè®®åœ¨ä¸šåŠ¡ä½Žå³°æœŸæ‰§è¡Œ

---

## ðŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰

- [ ] å·²å¤‡ä»½æ•°æ®åº“
- [ ] å·²åœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯
- [ ] å·²ç¡®è®¤æ‰§è¡Œé¡ºåº
- [ ] å·²å‡†å¤‡å›žæ»šæ–¹æ¡ˆ

### éƒ¨ç½²ä¸­

- [ ] æ‰§è¡Œç¬¬ä¸€æ­¥ï¼šæ·»åŠ å­—æ®µå’ŒåŸºç¡€å‡½æ•°
- [ ] éªŒè¯ç¬¬ä¸€æ­¥æ‰§è¡ŒæˆåŠŸ
- [ ] æ‰§è¡Œç¬¬äºŒæ­¥ï¼šè¿ç§»æƒé™ç³»ç»Ÿ
- [ ] éªŒè¯ç¬¬äºŒæ­¥æ‰§è¡ŒæˆåŠŸ
- [ ] æ‰§è¡Œç¬¬ä¸‰æ­¥ï¼šæ›´æ–°æŸ¥è¯¢å‡½æ•°
- [ ] éªŒè¯ç¬¬ä¸‰æ­¥æ‰§è¡ŒæˆåŠŸ

### éƒ¨ç½²åŽ

- [ ] éªŒè¯æ•°æ®åº“ç»“æž„
- [ ] éªŒè¯å‡½æ•°åˆ›å»º
- [ ] éªŒè¯æƒé™é…ç½®
- [ ] åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] å‰ç«¯åŠŸèƒ½æ­£å¸¸

---

## ðŸš€ å¿«é€Ÿéƒ¨ç½²å‘½ä»¤

### ä¸€é”®éƒ¨ç½²ï¼ˆæŽ¨èï¼‰

```bash
# åˆ›å»ºéƒ¨ç½²è„šæœ¬
cat > deploy_reconciliation.sh << 'EOF'
#!/bin/bash
echo "å¼€å§‹éƒ¨ç½²å¯¹è´¦ç³»ç»Ÿ..."

echo "æ­¥éª¤ 1/3: æ·»åŠ å¯¹è´¦å­—æ®µå’ŒåŸºç¡€å‡½æ•°"
supabase db execute -f supabase/migrations/20250131_add_reconciliation_to_partner_costs.sql

echo "æ­¥éª¤ 2/3: è¿ç§»æƒé™ç³»ç»Ÿ"
supabase db execute -f supabase/migrations/20250131_migrate_reconciliation_permissions_to_unified_system.sql

echo "æ­¥éª¤ 3/3: æ›´æ–°æŸ¥è¯¢å‡½æ•°"
supabase db execute -f supabase/migrations/20250131_update_reconciliation_function_to_return_status.sql

echo "âœ… å¯¹è´¦ç³»ç»Ÿéƒ¨ç½²å®Œæˆï¼"
EOF

chmod +x deploy_reconciliation.sh
./deploy_reconciliation.sh
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-11-16  
**æœ€åŽæ›´æ–°**ï¼š2025-11-16

