# 运费对账逻辑详解

## 📅 创建日期
2025-11-16

## 🎯 对账的目的和意义

### 业务背景

在物流业务中，一个运单可能涉及多个合作方，形成合作链路：

```
项目（货主）
  ↓
一级合作方（中间商A）
  ↓
二级合作方（中间商B）
  ↓
三级合作方（实际承运方）
```

每个合作方都需要从上游获得应付金额，并向下游支付应付金额。

### 对账的目的

**对账**是指财务人员核对系统中记录的**合作方应付金额**是否与实际业务情况一致，包括：

1. **金额核对**：确认应付金额计算是否正确
2. **付款核对**：确认是否已向合作方付款
3. **异常处理**：发现并标记异常情况
4. **财务审计**：为财务审计提供对账记录

---

## 📊 对账对象

### 对账的最小单位

对账的最小单位是 **`logistics_partner_costs` 表中的一条记录**，即：

- **一个运单** × **一个合作方** = **一条对账记录**

### 数据结构

```sql
-- logistics_partner_costs 表结构
CREATE TABLE logistics_partner_costs (
    id UUID PRIMARY KEY,                    -- 成本记录ID（对账操作的单位）
    logistics_record_id UUID,              -- 运单ID
    partner_id UUID,                      -- 合作方ID
    level INTEGER,                         -- 合作方级别
    base_amount NUMERIC(12,2),            -- 基础金额
    payable_amount NUMERIC(12,2),        -- 应付金额（对账的核心数据）
    
    -- 对账相关字段
    reconciliation_status TEXT,           -- 对账状态
    reconciliation_date TIMESTAMP,        -- 对账日期
    reconciliation_by UUID,               -- 对账操作人
    reconciliation_notes TEXT,             -- 对账备注
    
    -- 其他状态字段
    invoice_status TEXT,                  -- 开票状态
    payment_status TEXT                   -- 付款状态
);
```

### 示例

假设一个运单有3个合作方：

```
运单编号：YD20251116-001
├── 一级合作方A：应付金额 ¥1,000.00  ← 对账记录1
├── 二级合作方B：应付金额 ¥1,200.00  ← 对账记录2
└── 三级合作方C：应付金额 ¥1,500.00  ← 对账记录3
```

这个运单有 **3条对账记录**，每条记录可以独立对账。

---

## 🔄 对账状态说明

### 三种对账状态

| 状态 | 英文值 | 中文显示 | 含义 | 使用场景 |
|------|--------|---------|------|---------|
| **未对账** | `Unreconciled` | 未对账 | 默认状态，尚未进行对账 | 新创建的运单，所有合作方成本默认为未对账 |
| **已对账** | `Reconciled` | 已对账 | 已核对确认，金额和付款都正确 | 财务人员核对后确认无误 |
| **异常** | `Exception` | 异常 | 对账时发现异常情况 | 金额不符、付款异常、需要进一步处理 |

### 状态流转

```
Unreconciled (未对账)
    ↓ [财务人员核对]
Reconciled (已对账) 或 Exception (异常)
    ↓ [重新核对]
Unreconciled (未对账)  ← 可以重置为未对账
```

**说明**：
- 对账状态可以多次修改
- 可以从未对账 → 已对账 → 异常 → 未对账（重新核对）
- 每次对账都会记录对账时间和操作人

---

## 💼 对账的业务流程

### 完整业务流程

```
1. 运单创建
   ↓
2. 系统自动计算合作方应付金额
   ↓
3. 生成 logistics_partner_costs 记录（默认 reconciliation_status = 'Unreconciled'）
   ↓
4. 财务人员查看运费对账页面
   ↓
5. 核对应付金额是否正确
   ↓
6. 核对是否已付款
   ↓
7. 执行对账操作
   ├── 如果正确 → reconciliation_status = 'Reconciled'
   └── 如果异常 → reconciliation_status = 'Exception'
   ↓
8. 记录对账时间和备注
```

### 对账操作步骤

#### 步骤1：查看对账数据

在**运费对账页面**（`/finance/reconciliation`）：

1. **筛选运单**：
   - 选择项目、日期范围、合作方等筛选条件
   - 可以按对账状态筛选（未对账/已对账/异常）

2. **查看应付金额**：
   - 表格中显示每个运单的每个合作方应付金额
   - 每个应付金额下方显示对账状态徽章

#### 步骤2：核对信息

财务人员需要核对：

1. **金额核对**：
   - 应付金额是否与合同/协议一致
   - 计算是否正确（税点、利润率等）

2. **付款核对**：
   - 是否已向该合作方付款
   - 付款金额是否与应付金额一致
   - 付款时间是否合理

3. **业务核对**：
   - 运单信息是否正确
   - 合作方是否正确
   - 是否有异常情况

#### 步骤3：执行对账

**方式A：单个运单对账**

1. 点击运单行的"对账"按钮
2. 选择对账状态（已对账/未对账/异常）
3. 输入对账备注（可选）
4. 确认对账

**方式B：批量对账**

1. 选择多个运单（支持跨页选择）
2. 点击"批量对账"按钮
3. 选择对账状态
4. 输入对账备注（可选）
5. 确认对账

---

## 🔗 对账与其他业务流程的关系

### 对账与付款流程

```
对账 ← 独立流程 → 付款申请
```

**关系说明**：
- **对账**：核对应付金额是否正确
- **付款申请**：向合作方申请付款
- **两者独立**：对账不影响付款，付款不影响对账

**典型场景**：
1. 先对账，确认金额正确后，再申请付款
2. 付款后，再对账确认付款金额是否正确

### 对账与开票流程

```
对账 ← 独立流程 → 开票申请
```

**关系说明**：
- **对账**：核对应付金额（我们付给合作方的金额）
- **开票申请**：向客户申请开票收款（客户付给我们的金额）
- **两者独立**：对账和开票是不同方向的业务

**典型场景**：
- 对账：核对我们应付给合作方的金额
- 开票：向客户开票收款

### 对账与收款流程

```
对账（运费对账） ← 不同对象 → 收款对账（开票收款）
```

**关系说明**：
- **运费对账**：对账对象是 `logistics_partner_costs`（合作方应付金额）
- **收款对账**：对账对象是 `invoice_requests`（开票申请单收款）
- **两者不同**：运费对账是核对我们应付给合作方的金额，收款对账是核对客户付给我们的金额

---

## 📋 对账状态字段详解

### reconciliation_status（对账状态）

**类型**：`TEXT`
**约束**：`CHECK (reconciliation_status IN ('Unreconciled', 'Reconciled', 'Exception'))`
**默认值**：`'Unreconciled'`

**状态值说明**：

1. **Unreconciled（未对账）**
   - 默认状态
   - 表示尚未进行对账
   - 新创建的运单，所有合作方成本默认为此状态

2. **Reconciled（已对账）**
   - 表示已核对确认
   - 金额和付款都正确
   - 设置此状态时，系统自动记录对账时间和操作人

3. **Exception（异常）**
   - 表示对账时发现异常
   - 需要在备注中说明异常原因
   - 需要进一步处理

### reconciliation_date（对账日期）

**类型**：`TIMESTAMP WITH TIME ZONE`
**说明**：
- 只有当 `reconciliation_status = 'Reconciled'` 时才会记录
- 记录对账确认的时间
- 用于财务审计和追溯

### reconciliation_by（对账操作人）

**类型**：`UUID`（引用 `auth.users.id`）
**说明**：
- 记录执行对账操作的用户ID
- 只有财务人员或管理员可以对账
- 用于责任追溯

### reconciliation_notes（对账备注）

**类型**：`TEXT`
**说明**：
- 可选字段
- 用于记录对账时的备注信息
- 特别适用于"异常"状态，需要说明异常原因

---

## 🎯 对账的业务场景

### 场景1：日常对账

**场景描述**：
财务人员每天/每周对已完成的运单进行对账，确认应付金额是否正确。

**操作流程**：
1. 筛选日期范围（如：本周的运单）
2. 筛选对账状态为"未对账"
3. 逐个核对应付金额
4. 确认无误后批量标记为"已对账"

### 场景2：付款前对账

**场景描述**：
在向合作方付款前，先对账确认应付金额，避免付款错误。

**操作流程**：
1. 筛选需要付款的合作方
2. 筛选对账状态为"未对账"
3. 核对应付金额
4. 确认无误后标记为"已对账"
5. 然后进行付款申请

### 场景3：异常处理

**场景描述**：
对账时发现金额不符或付款异常，标记为异常并记录原因。

**操作流程**：
1. 发现异常情况（如：金额计算错误、付款金额不符等）
2. 标记为"异常"状态
3. 在对账备注中详细说明异常原因
4. 通知相关人员处理
5. 处理完成后，重新对账并标记为"已对账"

### 场景4：财务审计

**场景描述**：
财务审计时，需要查看所有对账记录，确认对账是否及时、准确。

**操作流程**：
1. 筛选日期范围（如：本月的运单）
2. 查看对账状态分布
3. 检查是否有未对账的记录
4. 检查异常记录的处理情况
5. 导出对账报告

---

## 🔍 对账的查询和筛选

### 按对账状态筛选

在运费对账页面，可以通过"对账状态"筛选器筛选：

- **全部**：显示所有状态的记录
- **未对账**：只显示 `reconciliation_status = 'Unreconciled'` 的记录
- **已对账**：只显示 `reconciliation_status = 'Reconciled'` 的记录
- **异常**：只显示 `reconciliation_status = 'Exception'` 的记录

### 对账状态显示

在表格中，每个合作方应付金额下方会显示对账状态徽章：

- **未对账**：灰色徽章，显示"未对账"
- **已对账**：绿色徽章，显示"已对账"
- **异常**：红色徽章，显示"异常"

---

## ⚙️ 对账的技术实现

### 数据库层面

1. **字段定义**：
   - 在 `logistics_partner_costs` 表中添加对账相关字段
   - 添加索引以提高查询性能

2. **RPC函数**：
   - `reconcile_partner_costs_batch`：批量对账函数
   - `reconcile_partner_cost`：单个对账函数

3. **权限控制**：
   - **权限键**：`finance.reconcile`
   - **权限检查**：使用统一权限系统 `has_function_permission('finance.reconcile')`
   - **权限管理**：
     - 通过 `role_permission_templates` 表配置角色权限
     - 通过 `user_permissions` 表为用户单独配置权限
     - `admin` 角色自动拥有所有权限

### 前端层面

1. **对账状态显示**：
   - 在表格中显示对账状态徽章
   - 在运单详情中显示对账信息

2. **对账操作**：
   - 单个运单对账按钮
   - 批量对账按钮
   - 对账对话框

3. **对账状态筛选**：
   - 在筛选栏添加对账状态筛选器

---

## 📊 对账数据统计

### 对账状态统计

可以通过对账状态筛选器查看：

- **未对账数量**：需要处理的记录数
- **已对账数量**：已完成的记录数
- **异常数量**：需要处理的异常记录数

### 对账完成率

```
对账完成率 = (已对账数量 + 异常数量) / 总记录数 × 100%
```

---

## ⚠️ 注意事项

### 1. 对账与付款的关系

- **对账不影响付款**：对账状态不会阻止付款申请
- **对账不自动付款**：对账只是核对，不会自动触发付款
- **建议流程**：先对账确认金额，再申请付款

### 2. 对账与开票的关系

- **对账和开票是不同方向**：
  - 对账：核对我们应付给合作方的金额（支出）
  - 开票：向客户开票收款（收入）
- **两者独立**：对账不影响开票，开票不影响对账

### 3. 对账状态可以修改

- 对账状态可以多次修改
- 可以从未对账 → 已对账 → 异常 → 未对账（重新核对）
- 每次修改都会记录对账时间和操作人

### 4. 对账权限

- **权限键**：`finance.reconcile`
- **权限检查**：使用统一权限系统 `has_function_permission('finance.reconcile')`
- **默认配置**：
  - `finance` 角色默认拥有运费对账权限
  - `admin` 角色自动拥有所有权限
- **权限管理**：
  - 可通过 `role_permission_templates` 表配置角色权限
  - 可通过 `user_permissions` 表为用户单独配置权限
- **普通业务人员**：只能查看对账状态，不能执行对账操作

---

## 📝 总结

### 对账的核心逻辑

1. **对账对象**：每个运单的每个合作方成本记录（`logistics_partner_costs`）
2. **对账目的**：核对应付金额是否正确，是否已付款
3. **对账状态**：未对账（默认）→ 已对账/异常
4. **对账操作**：财务人员手动核对并标记状态
5. **对账记录**：记录对账时间、操作人、备注

### 对账在业务流程中的位置

```
运单创建
  ↓
计算合作方应付金额
  ↓
【对账】← 财务人员核对
  ↓
付款申请（如果需要）
  ↓
付款完成
```

**对账是财务管理的核心环节**，确保应付金额的准确性和付款的正确性。

---

**文档版本**：v1.0  
**最后更新**：2025-11-16

