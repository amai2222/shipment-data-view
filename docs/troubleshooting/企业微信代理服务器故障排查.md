# ä¼ä¸šå¾®ä¿¡ä»£ç†æœåŠ¡å™¨æ•…éšœæ’æŸ¥æŒ‡å—

## ğŸ”´ é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯ï¼š**
```
TypeError: error sending request for url (http://129.226.191.86:3000/cgi-bin/gettoken?corpid=...): 
client error (Connect): tcp connect error: Connection refused (os error 111): Connection refused
```

**é”™è¯¯ä»£ç ï¼š** `ECONNREFUSED`

**å«ä¹‰ï¼š** Supabase Edge Function æ— æ³•è¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨ `http://129.226.191.86:3000`

---

## ğŸ” æ•…éšœåŸå› åˆ†æ

### å¯èƒ½çš„åŸå› ï¼š

1. **ä»£ç†æœåŠ¡å™¨æœªå¯åŠ¨** â­ æœ€å¯èƒ½
   - ä»£ç†æœåŠ¡è¿›ç¨‹å·²åœæ­¢
   - éœ€è¦é‡æ–°å¯åŠ¨ä»£ç†æœåŠ¡

2. **é˜²ç«å¢™é˜»æ­¢è¿æ¥**
   - æœåŠ¡å™¨é˜²ç«å¢™æœªå¼€æ”¾ 3000 ç«¯å£
   - äº‘æœåŠ¡å•†å®‰å…¨ç»„æœªé…ç½®

3. **IPåœ°å€æˆ–ç«¯å£é”™è¯¯**
   - ä»£ç†æœåŠ¡å™¨IPå˜æ›´
   - ç«¯å£å·å˜æ›´

4. **ç½‘ç»œè¿æ¥é—®é¢˜**
   - Supabase Edge Function æ— æ³•è®¿é—®è¯¥å†…ç½‘IP
   - éœ€è¦æ£€æŸ¥ç½‘ç»œè¿é€šæ€§

---

## âœ… æ’æŸ¥æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ£€æŸ¥ä»£ç†æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ

#### åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š
```bash
# æ£€æŸ¥ 3000 ç«¯å£æ˜¯å¦åœ¨ç›‘å¬
netstat -tulnp | grep 3000

# æˆ–è€…ä½¿ç”¨ ss å‘½ä»¤
ss -tulnp | grep 3000

# æˆ–è€…ä½¿ç”¨ lsof
lsof -i :3000
```

**é¢„æœŸç»“æœï¼š** åº”è¯¥çœ‹åˆ°è¿›ç¨‹åœ¨ç›‘å¬ 3000 ç«¯å£

#### å¦‚æœæ²¡æœ‰è¿›ç¨‹åœ¨ç›‘å¬ï¼š
```bash
# å¯åŠ¨æ‚¨çš„ä»£ç†æœåŠ¡ï¼ˆæ ¹æ®æ‚¨çš„å®é™…æœåŠ¡æ›¿æ¢ï¼‰
# ç¤ºä¾‹ï¼ˆå¦‚æœæ˜¯ Node.js ä»£ç†ï¼‰ï¼š
cd /path/to/proxy
npm start

# æˆ–è€…ï¼ˆå¦‚æœæ˜¯ pm2 ç®¡ç†ï¼‰ï¼š
pm2 start proxy-server

# æˆ–è€…ï¼ˆå¦‚æœæ˜¯ systemd æœåŠ¡ï¼‰ï¼š
sudo systemctl start wechat-proxy
```

---

### æ­¥éª¤ 2ï¼šæ£€æŸ¥ä»£ç†æœåŠ¡å™¨æœ¬åœ°è®¿é—®

#### åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š
```bash
# æµ‹è¯•æœ¬åœ°è®¿é—®
curl http://localhost:3000/health

# æˆ–è€…æµ‹è¯•å®Œæ•´çš„ API è·¯å¾„
curl "http://localhost:3000/cgi-bin/gettoken?corpid=test&corpsecret=test"
```

**é¢„æœŸç»“æœï¼š** åº”è¯¥è¿”å›å“åº”ï¼ˆå³ä½¿æ˜¯é”™è¯¯å“åº”ä¹Ÿè¯´æ˜æœåŠ¡åœ¨è¿è¡Œï¼‰

---

### æ­¥éª¤ 3ï¼šæ£€æŸ¥é˜²ç«å¢™è®¾ç½®

#### æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€ï¼š
```bash
# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status

# æˆ–è€…
sudo firewall-cmd --list-all
```

#### å¦‚æœéœ€è¦å¼€æ”¾ 3000 ç«¯å£ï¼š
```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 3000/tcp
sudo ufw reload

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload
```

---

### æ­¥éª¤ 4ï¼šæ£€æŸ¥äº‘æœåŠ¡å•†å®‰å…¨ç»„

å¦‚æœæœåŠ¡å™¨åœ¨äº‘ä¸Šï¼ˆå¦‚è…¾è®¯äº‘ã€é˜¿é‡Œäº‘ã€AWSï¼‰ï¼Œéœ€è¦ï¼š

1. ç™»å½•äº‘æ§åˆ¶å°
2. æ‰¾åˆ°è¯¥æœåŠ¡å™¨çš„å®‰å…¨ç»„/é˜²ç«å¢™è§„åˆ™
3. æ·»åŠ å…¥ç«™è§„åˆ™ï¼š
   - **åè®®ï¼š** TCP
   - **ç«¯å£ï¼š** 3000
   - **æ¥æºï¼š** 
     - Supabase Edge Function IPï¼ˆå¦‚æœçŸ¥é“ï¼‰
     - æˆ–è€… 0.0.0.0/0ï¼ˆæ‰€æœ‰IPï¼Œæµ‹è¯•ç”¨ï¼‰

---

### æ­¥éª¤ 5ï¼šä»å¤–éƒ¨æµ‹è¯•è¿æ¥

#### ä»å…¶ä»–æœºå™¨æµ‹è¯•ï¼š
```bash
# æµ‹è¯•è¿æ¥
telnet 129.226.191.86 3000

# æˆ–è€…ä½¿ç”¨ curl
curl http://129.226.191.86:3000/health

# æˆ–è€…ä½¿ç”¨ nc
nc -zv 129.226.191.86 3000
```

**é¢„æœŸç»“æœï¼š** åº”è¯¥èƒ½è¿æ¥æˆåŠŸ

---

## ğŸ”§ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šä½¿ç”¨å®˜æ–¹APIï¼ˆæ— éœ€ä»£ç†ï¼‰

å¦‚æœä»£ç†æœåŠ¡å™¨æš‚æ—¶æ— æ³•ä¿®å¤ï¼Œå¯ä»¥ä¸´æ—¶ä½¿ç”¨ä¼ä¸šå¾®ä¿¡å®˜æ–¹APIï¼š

```typescript
// supabase/functions/work-wechat-auth/index.ts
// ä¿®æ”¹ä¸ºç›´æ¥ä½¿ç”¨å®˜æ–¹API
const tokenResponse = await fetch(
  `https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=${corpId}&corpsecret=${workWechatSecret}`
);
```

**æ³¨æ„ï¼š** éœ€è¦ç¡®ä¿ Supabase Edge Function èƒ½è®¿é—® `qyapi.weixin.qq.com`

---

### æ–¹æ¡ˆBï¼šé‡å¯ä»£ç†æœåŠ¡å™¨

```bash
# å¦‚æœä½¿ç”¨ pm2
pm2 restart wechat-proxy

# å¦‚æœä½¿ç”¨ systemd
sudo systemctl restart wechat-proxy

# å¦‚æœæ˜¯ç›´æ¥è¿è¡Œçš„ Node.js è¿›ç¨‹
# å…ˆæ‰¾åˆ°è¿›ç¨‹ID
ps aux | grep proxy
# ç„¶åé‡å¯
kill -9 <PID>
node proxy-server.js &
```

---

## ğŸ¯ æ¨èçš„ä»£ç†æœåŠ¡å™¨é…ç½®

### Node.js ä»£ç†ç¤ºä¾‹

```javascript
// proxy-server.js
const express = require('express');
const { createProxyMiddleware } = require('http-proxy-middleware');

const app = express();
const PORT = 3000;

// ä»£ç†é…ç½®
app.use('/cgi-bin', createProxyMiddleware({
  target: 'https://qyapi.weixin.qq.com',
  changeOrigin: true,
  onProxyReq: (proxyReq, req, res) => {
    console.log(`ä»£ç†è¯·æ±‚: ${req.method} ${req.url}`);
  },
  onError: (err, req, res) => {
    console.error('ä»£ç†é”™è¯¯:', err);
    res.status(500).send('ä»£ç†é”™è¯¯');
  }
}));

// å¥åº·æ£€æŸ¥ç«¯ç‚¹
app.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

app.listen(PORT, '0.0.0.0', () => {
  console.log(`ä¼ä¸šå¾®ä¿¡ä»£ç†æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT}`);
});
```

### ä½¿ç”¨ PM2 ç®¡ç†ï¼ˆæ¨èï¼‰

```bash
# å®‰è£… pm2
npm install -g pm2

# å¯åŠ¨ä»£ç†æœåŠ¡
pm2 start proxy-server.js --name wechat-proxy

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save

# æŸ¥çœ‹æ—¥å¿—
pm2 logs wechat-proxy

# æŸ¥çœ‹çŠ¶æ€
pm2 status
```

---

## ğŸ› è°ƒè¯•å»ºè®®

### 1. æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹

åœ¨ä»£ç†æœåŠ¡å™¨ä¸­æ·»åŠ ï¼š
```javascript
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});
```

### 2. æ·»åŠ è¯¦ç»†æ—¥å¿—

```javascript
app.use((req, res, next) => {
  console.log(`[${new Date().toISOString()}] ${req.method} ${req.url}`);
  console.log('Headers:', req.headers);
  next();
});
```

### 3. ç›‘æ§ä»£ç†çŠ¶æ€

```bash
# å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€
while true; do
  curl -s http://localhost:3000/health || echo "æœåŠ¡åœæ­¢"
  sleep 60
done
```

---

## ğŸ“ å¿«é€Ÿæ£€æŸ¥æ¸…å•

- [ ] ä»£ç†æœåŠ¡å™¨è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œï¼Ÿ
- [ ] 3000 ç«¯å£æ˜¯å¦åœ¨ç›‘å¬ï¼Ÿ
- [ ] é˜²ç«å¢™æ˜¯å¦å¼€æ”¾ 3000 ç«¯å£ï¼Ÿ
- [ ] äº‘æœåŠ¡å•†å®‰å…¨ç»„æ˜¯å¦é…ç½®ï¼Ÿ
- [ ] ä»å¤–éƒ¨èƒ½å¦è®¿é—®ä»£ç†æœåŠ¡å™¨ï¼Ÿ
- [ ] ä»£ç†æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯ï¼Ÿ

---

## ğŸš€ å¿«é€Ÿä¿®å¤å‘½ä»¤

```bash
# 1. è¿›å…¥ä»£ç†æœåŠ¡å™¨
ssh user@129.226.191.86

# 2. æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 status
# æˆ–è€…
systemctl status wechat-proxy

# 3. å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨æœåŠ¡
pm2 start wechat-proxy
# æˆ–è€…
systemctl start wechat-proxy

# 4. æ£€æŸ¥æ—¥å¿—
pm2 logs wechat-proxy
# æˆ–è€…
journalctl -u wechat-proxy -f

# 5. æµ‹è¯•æœ¬åœ°è®¿é—®
curl http://localhost:3000/health
```

---

**åˆ›å»ºæ—¥æœŸï¼š** 2025-11-20  
**é—®é¢˜ç±»å‹ï¼š** ä»£ç†æœåŠ¡å™¨è¿æ¥å¤±è´¥  
**é”™è¯¯ä»£ç ï¼š** ECONNREFUSED

