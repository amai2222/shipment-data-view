# 2025-11-20 单价和计件功能完整执行清单

## 📅 日期
2025-11-20

## 🎯 功能概述

本次更新包含两个主要功能：
1. **单价功能**：支持单价×有效数量自动计算运费
2. **计件模式支持**：支持按件计费（billing_type_id = 4）的完整功能

## 📋 SQL 文件执行顺序

请按以下顺序在 Supabase SQL Editor 中执行（共 7 个文件）：

### 1️⃣ 单价功能基础（必须）

```sql
supabase/migrations/20251120_create_unit_price_functions.sql
```

**功能**：
- 添加 `unit_price`、`effective_quantity`、`calculation_mode` 字段
- 创建 `get_effective_quantity_for_record_1120` 函数
- 创建 `auto_calculate_cost_from_unit_price_1120` 触发器函数
- 创建 `add_logistics_record_with_costs_1120` 函数
- 创建 `update_logistics_record_via_recalc_1120` 函数

### 2️⃣ 支持根据计费模式计算有效数量（必须）

```sql
supabase/migrations/20251120_fix_effective_quantity_by_billing_type.sql
```

**功能**：
- 修复 `get_effective_quantity_for_record_1120` 函数，支持根据 `billing_type_id` 计算
- 计车模式（type 2）固定为 1
- 其他模式根据项目配置计算
- 修复 `auto_calculate_cost_from_unit_price_1120` 触发器，传递 `chain_id` 参数

### 3️⃣ 扩展触发器触发条件（必须）

```sql
supabase/migrations/20251120_fix_trigger_update_effective_quantity.sql
```

**功能**：
- 扩展触发器触发条件，包含 `chain_id` 和 `project_id` 更新
- 手动更新现有记录的有效数量

### 4️⃣ 简化更新函数并禁用触发器（必须）

```sql
supabase/migrations/20251120_simple_fix_drop_and_recreate.sql
```

**功能**：
- 重新创建 `update_logistics_record_via_recalc_1120` 函数（简化版，显式计算）
- 禁用 BEFORE UPDATE 触发器，避免冲突

### 5️⃣ 添加计件模式（必须）

```sql
supabase/migrations/20251120_add_billing_type_4_by_piece.sql
```

**功能**：
- 添加 billing_type_id = 4（按件计费）
- 更新 `billing_types` 表注释

### 6️⃣ 统计函数支持计件（必须）

```sql
supabase/migrations/20251120_update_summary_support_pieces.sql
```

**功能**：
- 更新 `get_logistics_summary_and_records_enhanced_1120` 函数
- 添加 `totalPiecesLoading` 和 `totalPiecesUnloading` 统计字段

### 7️⃣ 更新筛选函数版本（必须）

```sql
supabase/migrations/20251120_update_all_filtered_records_function.sql
```

**功能**：
- 更新 `get_all_filtered_record_ids_1120` 函数
- 保持与 _1120 版本命名一致

### 🛠️ 手动修复工具（可选，仅在有效数量为 0 时使用）

```sql
supabase/migrations/20251120_manual_fix_existing_data.sql
```

**功能**：
- 手动更新所有有单价但有效数量为 0 的运单
- 重新计算有效数量和运费
- **注意**：正常情况下不需要执行此文件

## 🎨 前端修改（已自动完成）

以下文件已自动修改，无需手动操作：

### 1. 单价功能前端
- ✅ `src/pages/BusinessEntry/types.ts` - 添加单价相关字段类型
- ✅ `src/pages/BusinessEntry/components/LogisticsFormDialog.tsx` - 添加单价输入和自动计算逻辑

### 2. 计件模式前端
- ✅ `src/pages/BusinessEntry/components/LogisticsTable.tsx` - 添加 case 4 显示逻辑
- ✅ `src/pages/BusinessEntry/index.tsx` - 添加计件合计显示
- ✅ `src/pages/BusinessEntry/hooks/useLogisticsData.ts` - 更新类型和RPC调用
- ✅ `src/pages/BusinessEntry/hooks/useAllFilteredRecords.ts` - 更新RPC调用
- ✅ `src/utils/formatters.ts` - 支持计件格式化
- ✅ `src/pages/Home.tsx` - 支持计件统计
- ✅ `src/pages/Projects.tsx` - 添加计件选项

## ✅ 验证步骤

### 1. 验证单价功能

1. 新增运单，输入单价（例如：100）
2. 输入装货重量（例如：10.5）和卸货重量（例如：10.3）
3. 观察：
   - ✅ 有效数量自动显示（例如：10.3）
   - ✅ 运费自动计算（例如：100 × 10.3 = 1030.00）
   - ✅ 保存后数据库正确保存

4. 编辑运单，修改单价或重量
5. 观察：
   - ✅ 有效数量和运费自动重新计算
   - ✅ 保存后数据库正确更新

### 2. 验证计件模式

1. 创建一个链路，计费模式选择"计件"
2. 新增运单，选择该链路
3. 输入装货件数（例如：1256）和卸货件数（例如：1256）
4. 输入单价（例如：7.11）
5. 观察：
   - ✅ 有效数量显示为 1256
   - ✅ 运费计算为 7.11 × 1256 = 8930.16
   - ✅ 数量列显示 `1256 / 1256 件`
   - ✅ 统计栏显示 `计件合计: 装 1256件 / 卸 1256件`

### 3. 验证不同计费模式

测试以下计费模式：
- ✅ billing_type_id = 1（计重）：显示 `10.50 / 10.30 吨`
- ✅ billing_type_id = 2（计车）：显示 `1 车`，有效数量固定为 1
- ✅ billing_type_id = 3（计方）：显示 `10.50 / 10.30 立方`
- ✅ billing_type_id = 4（计件）：显示 `1256 / 1256 件`

### 4. 验证项目配置

测试项目的有效数量类型配置：
- ✅ `effective_quantity_type = 'loading'`：使用装货数量
- ✅ `effective_quantity_type = 'unloading'`：使用卸货数量
- ✅ `effective_quantity_type = 'min_value'`：使用两者较小值

## 📊 数据库字段说明

### logistics_records 表新增字段

| 字段名 | 类型 | 说明 | 示例 |
|-------|------|------|------|
| `unit_price` | NUMERIC(10,2) | 单价 | 7.11 |
| `effective_quantity` | NUMERIC(10,3) | 有效数量 | 1256.000 |
| `calculation_mode` | TEXT | 计算模式：auto/manual | 'auto' |

### billing_types 表新增记录

| billing_type_id | name | code |
|----------------|------|------|
| 4 | 按件 | piece |

## 🔍 问题排查

### 问题1：有效数量显示为 0

**原因**：可能是触发器没有正确执行或函数冲突

**解决**：
1. 执行 `20251120_manual_fix_existing_data.sql` 手动修复
2. 检查 Supabase Logs 查看错误信息

### 问题2：前端数量列显示 `-`

**原因**：前端没有正确刷新或SQL脚本未执行

**解决**：
1. 确认执行了 `20251120_update_summary_support_pieces.sql`
2. 刷新浏览器页面（Ctrl+Shift+R 强制刷新）

### 问题3：运费没有自动计算

**原因**：
- 单价未输入
- 有效数量为0
- 触发器被禁用

**解决**：
1. 确认单价已输入且 > 0
2. 确认装货或卸货重量已输入
3. 检查 `calculation_mode` 字段是否为 'auto'

### 问题4：统计栏不显示计件合计

**原因**：后端统计函数未更新

**解决**：
1. 确认执行了 `20251120_update_summary_support_pieces.sql`
2. 检查前端调用的是 `get_logistics_summary_and_records_enhanced_1120`

## 🎉 预期结果

完成所有步骤后，系统应该具备：

### 单价功能
- ✅ 支持单价输入
- ✅ 自动计算有效数量
- ✅ 自动计算运费（单价 × 有效数量）
- ✅ 支持手动模式和自动模式切换
- ✅ 编辑运单时正确显示和计算

### 计件模式
- ✅ 支持按件计费
- ✅ 数量列显示 `X / Y 件`
- ✅ 统计栏显示计件合计
- ✅ 有效数量正确计算
- ✅ 运费正确计算

### 兼容性
- ✅ 不影响现有数据
- ✅ 其他计费模式（计重、计车、计方）正常工作
- ✅ 所有筛选和统计功能正常

## 📝 注意事项

1. **执行顺序很重要**：请严格按照清单顺序执行SQL文件
2. **刷新缓存**：执行SQL后，建议强制刷新浏览器（Ctrl+Shift+R）
3. **备份数据**：执行前建议备份数据库
4. **版本一致**：确保前后端都使用 _1120 版本的函数
5. **日志查看**：如有问题，查看 Supabase Logs 中的 NOTICE 和 WARNING

## 📚 相关文档

- `docs/单价功能设计方案.md` - 单价功能设计文档
- `docs/单价功能SQL文件执行说明.md` - SQL文件详细说明
- `docs/单价功能最终修复说明.md` - 问题修复历史
- `docs/计费类型4按件功能设计说明.md` - 计件功能设计文档
- `docs/计件模式显示修复说明.md` - 计件显示修复说明

---

**创建时间**：2025-11-20  
**状态**：待执行  
**版本**：1.0

