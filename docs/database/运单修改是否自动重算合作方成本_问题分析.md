# 运单修改是否自动重算合作方成本 - 问题分析

## 📅 分析日期
2025-01-22

## ❓ 问题

**用户疑问**：修改运单时，会不会自动重新计算合作方成本？

---

## 🔍 代码分析

### 前端调用（编辑运单时）

**文件**：`src/pages/BusinessEntry/components/LogisticsFormDialog.tsx`

**代码**：
```typescript
if (editingRecord) {
  // 编辑运单时调用
  const { error } = await supabase.rpc('update_logistics_record_via_recalc', { 
    p_record_id: editingRecord.id, 
    p_project_id: finalProjectId,
    p_project_name: projects.find(p => p.id === finalProjectId)?.name || '',
    p_chain_id: formData.chainId || editingRecord.chain_id,
    p_driver_id: finalDriverId,
    // ... 其他参数
  });
}
```

**关键函数**：`update_logistics_record_via_recalc`

函数名含义：
- `update` - 更新
- `logistics_record` - 运单记录
- `via_recalc` - 通过重新计算（via recalculate）

**从函数名判断：应该会自动重新计算！** ✅

---

## ⚠️ 发现的问题

### 问题：函数不存在！

我搜索了整个代码库，**没有找到 `update_logistics_record_via_recalc` 函数的定义**！

**搜索范围**：
- ✅ supabase/migrations/*.sql
- ✅ scripts/*.sql  
- ✅ supabase/functions/*

**结果**：❌ 未找到

**这意味着**：
1. ❌ 编辑运单时可能会报错（调用不存在的函数）
2. ❌ 或者编辑根本不生效
3. ❌ 合作方成本不会被重新计算

---

## 💡 解决方案

需要创建缺失的数据库函数。让我基于现有的 `add_logistics_record_with_costs` 函数来创建更新版本。

---

## 📝 函数实现逻辑

### 应该实现的功能

```sql
CREATE OR REPLACE FUNCTION update_logistics_record_via_recalc(
  p_record_id UUID,
  p_project_id UUID,
  p_chain_id UUID,
  ... -- 其他参数
)
RETURNS VOID AS $$
BEGIN
  -- 1. 更新运单基础信息
  UPDATE logistics_records
  SET 
    project_id = p_project_id,
    chain_id = p_chain_id,
    loading_weight = p_loading_weight,
    current_cost = p_current_cost,
    ... -- 其他字段
  WHERE id = p_record_id;
  
  -- 2. 删除旧的合作方成本记录
  DELETE FROM logistics_partner_costs
  WHERE logistics_record_id = p_record_id;
  
  -- 3. 重新计算并插入新的合作方成本
  -- 根据最新的 project_partners 配置
  -- 计算每个合作方的应付金额
  INSERT INTO logistics_partner_costs (...)
  SELECT ... FROM project_partners
  WHERE project_id = p_project_id AND chain_id = p_chain_id;
  
END;
$$ LANGUAGE plpgsql;
```

---

## 🎯 当前状态判断

### 测试方法

1. **尝试编辑一个运单**
2. **观察是否报错**

**可能的结果**：

#### 情况A：报错

```
错误：function update_logistics_record_via_recalc does not exist
```

**说明**：函数确实不存在，编辑功能不可用

#### 情况B：成功但不重算

```
提示：运单已更新
```

**说明**：可能前端有错误处理，跳过了RPC调用，直接用简单UPDATE

**验证方式**：
- 修改运单的 current_cost
- 查看 logistics_partner_costs 表的 payable_amount 是否变化
- 如果不变化，说明没有重新计算

---

## ✅ 建议

### 1. 立即测试

编辑一个运单，观察：
- ✅ 能否成功保存？
- ✅ 是否有错误提示？
- ✅ logistics_partner_costs 是否更新？

### 2. 验证SQL

```sql
-- 检查函数是否存在
SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_name LIKE '%update%logistics%';

-- 查找所有运单相关函数
SELECT routine_name
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_name LIKE '%logistics%'
ORDER BY routine_name;
```

### 3. 如果函数不存在

我可以帮您创建这个函数。需要：
1. 创建 `update_logistics_record_via_recalc` 函数
2. 实现自动重算逻辑
3. 测试验证

---

## 📊 对比：创建 vs 编辑

### 创建运单

**函数**：`add_logistics_record_with_costs`

**流程**：
```
1. 插入 logistics_records ✅
2. 查询 project_partners ✅
3. 计算每个合作方成本 ✅
4. 插入 logistics_partner_costs ✅
```

**状态**：✅ 函数存在，功能正常

### 编辑运单

**函数**：`update_logistics_record_via_recalc`

**流程**：
```
1. 更新 logistics_records ？
2. 删除旧的 logistics_partner_costs ？
3. 重新计算合作方成本 ？
4. 插入新的 logistics_partner_costs ？
```

**状态**：❌ 函数可能不存在

---

## 🔄 临时解决方案

在函数创建之前，如果需要更新运单的合作方成本：

### 方案1：删除并重新创建运单

1. 记录运单信息
2. 删除运单
3. 重新创建运单
4. 新的成本会自动计算

**缺点**：
- ❌ 运单编号会变
- ❌ 操作繁琐

### 方案2：手动重算（推荐）

1. 编辑运单（仅更新基础信息）
2. 到运费对账页面
3. 找到该运单
4. 勾选后点击"批量重新计算"

**优点**：
- ✅ 保留运单编号
- ✅ 合作方成本会更新

---

## ✅ 总结

### 回答您的问题

**问：修改运单会不会自动重新计算？**

**答**：
- 📝 **代码意图**：应该会（函数名包含 `via_recalc`）
- ⚠️ **实际情况**：可能不会（函数可能不存在）
- 🎯 **需要验证**：测试编辑运单是否报错

### 下一步

1. **测试编辑运单功能**
2. **如果报错**：我来创建缺失的函数
3. **如果不报错但不重算**：调整逻辑启用重算
4. **临时方案**：使用运费对账的"批量重新计算"功能

---

**建议**：请先测试编辑一个运单，告诉我是否报错，我来帮您修复！

---

**分析时间**: 2025-01-22
**文档版本**: v1.0

