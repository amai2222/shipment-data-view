# åˆä½œé“¾è·¯æˆæœ¬é‡ç®—éªŒè¯è¯´æ˜

## ğŸ” **é—®é¢˜å‘ç°**

åœ¨æ£€æŸ¥åˆä½œé“¾è·¯æ›´æ–°åŠŸèƒ½æ—¶ï¼Œå‘ç°äº†ä¸€ä¸ªé‡è¦é—®é¢˜ï¼š

### **é—®é¢˜æè¿°ï¼š**
åˆä½œé“¾è·¯ä¿®æ”¹å‡½æ•°ä¸­è°ƒç”¨çš„æˆæœ¬é‡ç®—å‡½æ•°å‚æ•°ä¸åŒ¹é…ï¼Œå¯èƒ½å¯¼è‡´æˆæœ¬é‡ç®—å¤±è´¥ã€‚

### **å…·ä½“é—®é¢˜ï¼š**
```sql
-- å½“å‰è°ƒç”¨æ–¹å¼ï¼ˆé”™è¯¯ï¼‰
SELECT public.recalculate_costs_for_chain_safe(ARRAY[p_record_id]) INTO v_recalc_result;

-- å®é™…å‡½æ•°ç­¾å
CREATE OR REPLACE FUNCTION public.recalculate_costs_for_chain_safe(
    p_project_id UUID,
    p_chain_id UUID,
    p_only_unpaid BOOLEAN DEFAULT TRUE
)
```

## ğŸ”§ **é—®é¢˜åˆ†æ**

### **1. å‡½æ•°å‚æ•°ä¸åŒ¹é…**
- **è°ƒç”¨æ–¹å¼**ï¼š`recalculate_costs_for_chain_safe(ARRAY[p_record_id])`
- **å®é™…ç­¾å**ï¼š`recalculate_costs_for_chain_safe(project_id, chain_id, only_unpaid)`
- **ç»“æœ**ï¼šå‡½æ•°è°ƒç”¨å¤±è´¥ï¼Œæˆæœ¬é‡ç®—ä¸ä¼šæ‰§è¡Œ

### **2. å½±å“èŒƒå›´**
- **å•ä¸ªè®°å½•ä¿®æ”¹**ï¼š`modify_logistics_record_chain` å‡½æ•°
- **æ‰¹é‡ä¿®æ”¹**ï¼š`batch_modify_logistics_records_chain` å‡½æ•°
- **ç»“æœ**ï¼šåˆä½œé“¾è·¯æ›´æ–°åï¼Œåˆä½œæ–¹æˆæœ¬ä¸ä¼šè‡ªåŠ¨é‡ç®—

## ğŸ› ï¸ **è§£å†³æ–¹æ¡ˆ**

### **æ–¹æ¡ˆ1ï¼šä¿®å¤å‡½æ•°è°ƒç”¨ï¼ˆæ¨èï¼‰**

#### **ä¿®å¤å•ä¸ªè®°å½•ä¿®æ”¹å‡½æ•°ï¼š**
```sql
CREATE OR REPLACE FUNCTION public.modify_logistics_record_chain(
    p_record_id UUID,
    p_chain_name TEXT
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_result JSONB;
    v_updated_count INTEGER := 0;
    v_recalc_result JSONB;
    v_project_id UUID;
    v_chain_uuid UUID;
BEGIN
    -- æƒé™æ£€æŸ¥...
    
    -- è·å–è®°å½•çš„é¡¹ç›®ID
    SELECT project_id INTO v_project_id
    FROM public.logistics_records
    WHERE id = p_record_id;

    -- è·å–é“¾è·¯IDï¼ˆé€šè¿‡é“¾è·¯åç§°æŸ¥æ‰¾ï¼‰
    SELECT id INTO v_chain_uuid
    FROM public.partner_chains
    WHERE chain_name = p_chain_name
    AND project_id = v_project_id;

    -- æ›´æ–°è¿å•çš„åˆä½œé“¾è·¯
    UPDATE public.logistics_records
    SET 
        chain_id = p_chain_name,
        updated_at = NOW()
    WHERE id = p_record_id;
    
    GET DIAGNOSTICS v_updated_count = ROW_COUNT;

    -- é‡æ–°è®¡ç®—åˆä½œæ–¹æˆæœ¬ï¼ˆä½¿ç”¨æ­£ç¡®çš„å‚æ•°ï¼‰
    IF v_chain_uuid IS NOT NULL THEN
        SELECT public.recalculate_costs_for_chain_safe(v_project_id, v_chain_uuid, TRUE) INTO v_recalc_result;
    ELSE
        v_recalc_result := jsonb_build_object('success', false, 'message', 'æœªæ‰¾åˆ°å¯¹åº”çš„é“¾è·¯ID');
    END IF;

    -- æ„å»ºè¿”å›ç»“æœ...
END;
$$;
```

#### **ä¿®å¤æ‰¹é‡ä¿®æ”¹å‡½æ•°ï¼š**
```sql
CREATE OR REPLACE FUNCTION public.batch_modify_logistics_records_chain(
    p_record_ids UUID[],
    p_chain_name TEXT
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_result JSONB;
    v_updated_count INTEGER := 0;
    v_recalc_result JSONB;
    v_project_ids UUID[];
    v_unique_projects INTEGER;
    v_project_id UUID;
    v_chain_uuid UUID;
BEGIN
    -- æƒé™æ£€æŸ¥...
    
    -- è·å–é¡¹ç›®ID
    SELECT array_agg(DISTINCT project_id) INTO v_project_ids
    FROM public.logistics_records
    WHERE id = ANY(p_record_ids);
    
    v_project_id := v_project_ids[1];

    -- è·å–é“¾è·¯IDï¼ˆé€šè¿‡é“¾è·¯åç§°æŸ¥æ‰¾ï¼‰
    SELECT id INTO v_chain_uuid
    FROM public.partner_chains
    WHERE chain_name = p_chain_name
    AND project_id = v_project_id;

    -- æ‰¹é‡æ›´æ–°è¿å•çš„åˆä½œé“¾è·¯
    UPDATE public.logistics_records
    SET 
        chain_id = p_chain_name,
        updated_at = NOW()
    WHERE id = ANY(p_record_ids);
    
    GET DIAGNOSTICS v_updated_count = ROW_COUNT;

    -- é‡æ–°è®¡ç®—åˆä½œæ–¹æˆæœ¬ï¼ˆä½¿ç”¨æ­£ç¡®çš„å‚æ•°ï¼‰
    IF v_chain_uuid IS NOT NULL THEN
        SELECT public.recalculate_costs_for_chain_safe(v_project_id, v_chain_uuid, TRUE) INTO v_recalc_result;
    ELSE
        v_recalc_result := jsonb_build_object('success', false, 'message', 'æœªæ‰¾åˆ°å¯¹åº”çš„é“¾è·¯ID');
    END IF;

    -- æ„å»ºè¿”å›ç»“æœ...
END;
$$;
```

### **æ–¹æ¡ˆ2ï¼šåˆ›å»ºæ–°çš„é‡ç®—å‡½æ•°**

#### **åˆ›å»ºæ¥å—è®°å½•IDæ•°ç»„çš„é‡ç®—å‡½æ•°ï¼š**
```sql
CREATE OR REPLACE FUNCTION public.recalculate_costs_for_records_safe(
    p_record_ids UUID[]
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_record_id UUID;
    v_updated_count INTEGER := 0;
    v_skipped_count INTEGER := 0;
    v_total_count INTEGER := 0;
    v_project_id UUID;
    v_chain_id UUID;
    v_result JSONB;
BEGIN
    -- éå†æ‰€æœ‰è®°å½•ID
    FOREACH v_record_id IN ARRAY p_record_ids
    LOOP
        v_total_count := v_total_count + 1;
        
        -- è·å–è®°å½•çš„é¡¹ç›®IDå’Œé“¾è·¯ID
        SELECT project_id, chain_id INTO v_project_id, v_chain_id
        FROM logistics_records
        WHERE id = v_record_id;
        
        -- æ£€æŸ¥è®°å½•æ˜¯å¦å­˜åœ¨
        IF v_project_id IS NULL OR v_chain_id IS NULL THEN
            v_skipped_count := v_skipped_count + 1;
            CONTINUE;
        END IF;
        
        -- æ£€æŸ¥æ˜¯å¦å·²ä»˜æ¬¾ï¼ˆè·³è¿‡å·²ä»˜æ¬¾çš„è¿å•ï¼‰
        IF EXISTS(
            SELECT 1 FROM logistics_records 
            WHERE id = v_record_id 
            AND payment_status = 'Paid'
        ) THEN
            v_skipped_count := v_skipped_count + 1;
            CONTINUE;
        END IF;
        
        -- é‡æ–°è®¡ç®—è¯¥è®°å½•çš„åˆä½œæ–¹æˆæœ¬
        -- è¿™é‡Œéœ€è¦è°ƒç”¨å…·ä½“çš„é‡ç®—é€»è¾‘
        -- æš‚æ—¶ä½¿ç”¨ç®€å•çš„æ›´æ–°é€»è¾‘
        UPDATE logistics_partner_costs
        SET 
            payable_amount = (
                SELECT lr.payable_cost * pc.percentage / 100
                FROM logistics_records lr
                JOIN project_partners pp ON pp.project_id = lr.project_id AND pp.chain_id = lr.chain_id
                JOIN partner_costs pc ON pc.partner_id = pp.partner_id
                WHERE lr.id = v_record_id
                AND logistics_partner_costs.partner_id = pp.partner_id
                AND logistics_partner_costs.logistics_record_id = v_record_id
            ),
            updated_at = NOW()
        WHERE logistics_record_id = v_record_id;
        
        GET DIAGNOSTICS v_updated_count = ROW_COUNT;
        
    END LOOP;
    
    -- æ„å»ºè¿”å›ç»“æœ
    v_result := jsonb_build_object(
        'success', true,
        'message', 'åˆä½œæ–¹æˆæœ¬é‡ç®—å®Œæˆ',
        'total_records', v_total_count,
        'updated_records', v_updated_count,
        'skipped_records', v_skipped_count
    );
    
    RETURN v_result;
END;
$$;
```

## ğŸ“Š **æˆæœ¬é‡ç®—éªŒè¯**

### **1. éªŒè¯æ­¥éª¤**

#### **æ­¥éª¤1ï¼šæ£€æŸ¥å‡½æ•°è°ƒç”¨**
```sql
-- æ£€æŸ¥å½“å‰å‡½æ•°è°ƒç”¨æ˜¯å¦æ­£ç¡®
SELECT public.recalculate_costs_for_chain_safe('project_id', 'chain_id', true);
```

#### **æ­¥éª¤2ï¼šæµ‹è¯•åˆä½œé“¾è·¯ä¿®æ”¹**
```sql
-- æµ‹è¯•å•ä¸ªè®°å½•ä¿®æ”¹
SELECT public.modify_logistics_record_chain('record_id', 'new_chain_name');
```

#### **æ­¥éª¤3ï¼šéªŒè¯æˆæœ¬é‡ç®—ç»“æœ**
```sql
-- æ£€æŸ¥åˆä½œæ–¹æˆæœ¬æ˜¯å¦æ›´æ–°
SELECT 
    lr.auto_number,
    lr.chain_id,
    lpc.partner_id,
    lpc.payable_amount,
    lpc.updated_at
FROM logistics_records lr
JOIN logistics_partner_costs lpc ON lpc.logistics_record_id = lr.id
WHERE lr.id = 'record_id';
```

### **2. éªŒè¯æŒ‡æ ‡**

#### **æˆåŠŸæŒ‡æ ‡ï¼š**
- âœ… å‡½æ•°è°ƒç”¨ä¸æŠ¥é”™
- âœ… åˆä½œé“¾è·¯æ›´æ–°æˆåŠŸ
- âœ… åˆä½œæ–¹æˆæœ¬è‡ªåŠ¨é‡ç®—
- âœ… é‡ç®—ç»“æœåŒ…å«ç»Ÿè®¡ä¿¡æ¯

#### **å¤±è´¥æŒ‡æ ‡ï¼š**
- âŒ å‡½æ•°è°ƒç”¨æŠ¥é”™
- âŒ åˆä½œé“¾è·¯æ›´æ–°ä½†æˆæœ¬æœªé‡ç®—
- âŒ é‡ç®—ç»“æœä¸ºç©ºæˆ–å¤±è´¥

## ğŸ¯ **æ¨èå®æ–½æ­¥éª¤**

### **1. ç«‹å³ä¿®å¤ï¼ˆæ¨èæ–¹æ¡ˆ1ï¼‰**
```sql
-- æ‰§è¡Œä¿®å¤SQLæ–‡ä»¶
ä¿®å¤åˆä½œé“¾è·¯æˆæœ¬é‡ç®—_ç®€å•æ–¹æ¡ˆ.sql
```

### **2. éªŒè¯ä¿®å¤æ•ˆæœ**
- æµ‹è¯•å•ä¸ªè®°å½•ä¿®æ”¹
- æµ‹è¯•æ‰¹é‡ä¿®æ”¹
- éªŒè¯æˆæœ¬é‡ç®—ç»“æœ

### **3. ç›‘æ§å’Œæµ‹è¯•**
- ç›‘æ§ç”Ÿäº§ç¯å¢ƒä¸­çš„æˆæœ¬é‡ç®—
- å®šæœŸéªŒè¯æ•°æ®ä¸€è‡´æ€§
- å»ºç«‹æˆæœ¬é‡ç®—çš„å®¡è®¡æ—¥å¿—

## âœ… **ä¿®å¤æ•ˆæœé¢„æœŸ**

### **ä¿®å¤å‰ï¼š**
- âŒ åˆä½œé“¾è·¯æ›´æ–°æˆåŠŸ
- âŒ åˆä½œæ–¹æˆæœ¬ä¸ä¼šè‡ªåŠ¨é‡ç®—
- âŒ éœ€è¦æ‰‹åŠ¨è§¦å‘æˆæœ¬é‡ç®—

### **ä¿®å¤åï¼š**
- âœ… åˆä½œé“¾è·¯æ›´æ–°æˆåŠŸ
- âœ… åˆä½œæ–¹æˆæœ¬è‡ªåŠ¨é‡ç®—
- âœ… è·³è¿‡å·²ä»˜æ¬¾è¿å•ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰
- âœ… è¿”å›è¯¦ç»†çš„é‡ç®—ç»“æœ

## ğŸš¨ **é‡è¦æé†’**

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿®å¤å‰ä¿®æ”¹çš„åˆä½œé“¾è·¯å¯èƒ½æ²¡æœ‰é‡ç®—æˆæœ¬ï¼Œéœ€è¦æ‰‹åŠ¨æ£€æŸ¥
2. **æµ‹è¯•éªŒè¯**ï¼šä¿®å¤åå¿…é¡»è¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œç¡®ä¿æˆæœ¬é‡ç®—æ­£å¸¸å·¥ä½œ
3. **ç›‘æ§å‘Šè­¦**ï¼šå»ºè®®æ·»åŠ æˆæœ¬é‡ç®—å¤±è´¥çš„ç›‘æ§å‘Šè­¦
4. **å›æ»šå‡†å¤‡**ï¼šå¦‚æœä¿®å¤æœ‰é—®é¢˜ï¼Œéœ€è¦å‡†å¤‡å›æ»šæ–¹æ¡ˆ

---

**é—®é¢˜å‘ç°äºº**ï¼šAI Assistant  
**å‘ç°æ—¶é—´**ï¼š2025-01-22  
**ä¿®å¤çŠ¶æ€**ï¼šğŸ”„ å¾…ä¿®å¤  
**éªŒè¯çŠ¶æ€**ï¼šâ³ å¾…éªŒè¯
