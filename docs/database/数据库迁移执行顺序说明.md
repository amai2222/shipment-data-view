# æ•°æ®åº“è¿ç§»æ‰§è¡Œé¡ºåºè¯´æ˜

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-01-22

## âš ï¸ é‡è¦è¯´æ˜

ç”±äº PostgreSQL æšä¸¾ç±»å‹çš„é™åˆ¶ï¼Œå¿…é¡»**æŒ‰ç…§ç‰¹å®šé¡ºåº**æ‰§è¡Œè¿ç§»æ–‡ä»¶ã€‚

---

## ğŸ“‹ æ­£ç¡®çš„æ‰§è¡Œé¡ºåº

### 1ï¸âƒ£ ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæšä¸¾ç±»å‹å’ŒåŸºç¡€å­—æ®µ

**æ–‡ä»¶**ï¼š`supabase/migrations/20250122_add_partner_type.sql`

**åŠŸèƒ½**ï¼š
- åˆ›å»º `partner_type_enum` æšä¸¾ç±»å‹ï¼ˆåŒ…å«ï¼šè´§ä¸»ã€åˆä½œå•†ï¼‰
- æ·»åŠ  `partner_type` å­—æ®µåˆ° `partners` è¡¨
- è®¾ç½®é»˜è®¤å€¼ä¸º 'è´§ä¸»'
- åˆ›å»ºç´¢å¼•

**æ‰§è¡Œå‘½ä»¤**ï¼š
```bash
# ä½¿ç”¨ Supabase CLI
supabase db push

# æˆ–åœ¨ Supabase Dashboard SQL Editor ä¸­æ‰§è¡Œè¯¥æ–‡ä»¶å†…å®¹
```

**é¢„æœŸç»“æœ**ï¼š
```
âœ… æšä¸¾ç±»å‹ partner_type_enum å·²åˆ›å»ºï¼ˆè´§ä¸», åˆä½œå•†ï¼‰
âœ… partner_type å­—æ®µå·²æ·»åŠ 
âœ… ç´¢å¼•å·²åˆ›å»º
```

---

### 2ï¸âƒ£ ç¬¬äºŒæ­¥ï¼šæ·»åŠ æ–°çš„æšä¸¾å€¼

**æ–‡ä»¶**ï¼š`supabase/migrations/20250122_add_partner_type_values.sql`

**åŠŸèƒ½**ï¼š
- æ·»åŠ  'èµ„æ–¹' æšä¸¾å€¼
- æ·»åŠ  'æœ¬å…¬å¸' æšä¸¾å€¼

**æ‰§è¡Œå‘½ä»¤**ï¼š
```bash
# ä½¿ç”¨ Supabase CLI
supabase db push

# æˆ–åœ¨ Supabase Dashboard SQL Editor ä¸­æ‰§è¡Œè¯¥æ–‡ä»¶å†…å®¹
```

**é¢„æœŸç»“æœ**ï¼š
```
âœ… å·²æ·»åŠ æšä¸¾å€¼: èµ„æ–¹
âœ… å·²æ·»åŠ æšä¸¾å€¼: æœ¬å…¬å¸
âœ… å½“å‰æšä¸¾å€¼: è´§ä¸», åˆä½œå•†, èµ„æ–¹, æœ¬å…¬å¸
```

---

### 3ï¸âƒ£ ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°å±‚çº§ç®¡ç†åŠŸèƒ½

**æ–‡ä»¶**ï¼š`supabase/migrations/20250122_update_hierarchy_to_owner_only.sql`

**åŠŸèƒ½**ï¼š
- æ¸…ç†éè´§ä¸»ç±»å‹çš„å±‚çº§ä¿¡æ¯
- æ›´æ–°è§¦å‘å™¨ï¼ˆåªå¤„ç†è´§ä¸»ï¼‰
- æ›´æ–°æŸ¥è¯¢å‡½æ•°ï¼ˆåªè¿”å›è´§ä¸»ï¼‰
- æ›´æ–°è§†å›¾ï¼ˆåªæ˜¾ç¤ºè´§ä¸»ï¼‰

**æ‰§è¡Œå‘½ä»¤**ï¼š
```bash
# ä½¿ç”¨ Supabase CLI
supabase db push

# æˆ–åœ¨ Supabase Dashboard SQL Editor ä¸­æ‰§è¡Œè¯¥æ–‡ä»¶å†…å®¹
```

**é¢„æœŸç»“æœ**ï¼š
```
âœ… éè´§ä¸»ç±»å‹çš„å±‚çº§å­—æ®µå·²æ¸…ç©º
âœ… è§¦å‘å™¨å·²æ›´æ–°
âœ… æŸ¥è¯¢å‡½æ•°å·²æ›´æ–°
âœ… è§†å›¾å·²æ›´æ–°
```

---

## ğŸ¯ ä¸€é”®æ‰§è¡Œï¼ˆæ¨èï¼‰

å¦‚æœä½¿ç”¨ Supabase CLIï¼Œå¯ä»¥ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰è¿ç§»ï¼š

```bash
cd /path/to/your/project
supabase db push
```

Supabase CLI ä¼šè‡ªåŠ¨æŒ‰ç…§æ–‡ä»¶åé¡ºåºæ‰§è¡Œï¼š
1. `20250122_add_partner_type.sql`
2. `20250122_add_partner_type_values.sql`
3. `20250122_update_hierarchy_to_owner_only.sql`

---

## ğŸ” éªŒè¯è¿ç§»ç»“æœ

### 1. éªŒè¯æšä¸¾ç±»å‹

```sql
-- æŸ¥çœ‹æ‰€æœ‰æšä¸¾å€¼
SELECT enumlabel 
FROM pg_enum 
WHERE enumtypid = 'partner_type_enum'::regtype
ORDER BY enumsortorder;

-- é¢„æœŸç»“æœï¼š
-- è´§ä¸»
-- åˆä½œå•†
-- èµ„æ–¹
-- æœ¬å…¬å¸
```

### 2. éªŒè¯å­—æ®µå’Œç´¢å¼•

```sql
-- æŸ¥çœ‹å­—æ®µä¿¡æ¯
SELECT 
    column_name,
    data_type,
    column_default,
    is_nullable
FROM information_schema.columns
WHERE table_name = 'partners' 
  AND column_name = 'partner_type';

-- æŸ¥çœ‹ç´¢å¼•
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'partners' 
  AND indexname LIKE '%partner_type%';
```

### 3. éªŒè¯å±‚çº§åŠŸèƒ½

```sql
-- æŸ¥çœ‹è´§ä¸»ç»Ÿè®¡
SELECT 
    partner_type,
    COUNT(*) as total,
    COUNT(CASE WHEN is_root = TRUE THEN 1 END) as root_count,
    COUNT(CASE WHEN parent_partner_id IS NOT NULL THEN 1 END) as has_parent
FROM partners
GROUP BY partner_type;
```

---

## âŒ å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1ï¼šæšä¸¾å€¼ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ERROR: 22P02: invalid input value for enum partner_type_enum: "èµ„æ–¹"
```

**åŸå› **ï¼šæ²¡æœ‰æ‰§è¡Œç¬¬äºŒæ­¥çš„è¿ç§»æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ‰§è¡Œæ·»åŠ æšä¸¾å€¼çš„è¿ç§»
supabase db push

# æˆ–æ‰‹åŠ¨æ‰§è¡Œ
# supabase/migrations/20250122_add_partner_type_values.sql
```

### é”™è¯¯ 2ï¼šæšä¸¾ç±»å‹å·²å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ERROR: type "partner_type_enum" already exists
```

**åŸå› **ï¼šé‡å¤æ‰§è¡Œäº†ç¬¬ä¸€æ­¥çš„è¿ç§»

**è§£å†³æ–¹æ¡ˆ**ï¼š
è¿™æ˜¯æ­£å¸¸çš„ï¼Œè¿ç§»è„šæœ¬ä¸­æœ‰åˆ¤æ–­ï¼Œä¼šè‡ªåŠ¨è·³è¿‡ã€‚å¦‚æœæƒ³é‡æ–°åˆ›å»ºï¼š

```sql
-- 1. åˆ é™¤ä½¿ç”¨è¯¥æšä¸¾çš„å­—æ®µ
ALTER TABLE partners DROP COLUMN IF EXISTS partner_type;

-- 2. åˆ é™¤æšä¸¾ç±»å‹
DROP TYPE IF EXISTS partner_type_enum;

-- 3. é‡æ–°æ‰§è¡Œè¿ç§»
```

### é”™è¯¯ 3ï¼šALTER TYPE ADD VALUE åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ERROR: ALTER TYPE ... ADD VALUE cannot run inside a transaction block
```

**åŸå› **ï¼šåœ¨äº‹åŠ¡å—ï¼ˆBEGIN/COMMITï¼‰ä¸­æ‰§è¡Œäº† ALTER TYPE ADD VALUE

**è§£å†³æ–¹æ¡ˆ**ï¼š
æˆ‘ä»¬çš„è¿ç§»æ–‡ä»¶å·²ç»ä½¿ç”¨ DO $$ å—æ¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœä»ç„¶å‡ºç°ï¼š

1. ç¡®ä¿ä¸æ˜¯åœ¨æ˜¾å¼çš„äº‹åŠ¡å—ä¸­æ‰§è¡Œ
2. åˆ†åˆ«æ‰§è¡Œæ¯ä¸ªè¿ç§»æ–‡ä»¶

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœéœ€è¦å›æ»šè¿ç§»ï¼š

```sql
BEGIN;

-- åˆ é™¤ç´¢å¼•
DROP INDEX IF EXISTS idx_partners_type_created;
DROP INDEX IF EXISTS idx_partners_partner_type;

-- åˆ é™¤å­—æ®µ
ALTER TABLE partners DROP COLUMN IF EXISTS partner_type;

-- åˆ é™¤æšä¸¾ç±»å‹
DROP TYPE IF EXISTS partner_type_enum;

COMMIT;
```

---

## ğŸ“ è¿ç§»æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶å | åŠŸèƒ½ | ä¾èµ– | å¿…éœ€ |
|--------|------|------|------|
| `20250122_add_partner_type.sql` | åˆ›å»ºæšä¸¾å’Œå­—æ®µ | æ—  | âœ… æ˜¯ |
| `20250122_add_partner_type_values.sql` | æ·»åŠ æ–°æšä¸¾å€¼ | ç¬¬1ä¸ªæ–‡ä»¶ | âœ… æ˜¯ |
| `20250122_update_hierarchy_to_owner_only.sql` | æ›´æ–°å±‚çº§ç®¡ç† | å‰2ä¸ªæ–‡ä»¶ | âœ… æ˜¯ |

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

æ‰§è¡Œå®Œæ‰€æœ‰è¿ç§»åï¼Œè¯·ç¡®è®¤ï¼š

- [ ] æšä¸¾ç±»å‹åŒ…å« 4 ä¸ªå€¼ï¼ˆè´§ä¸»ã€åˆä½œå•†ã€èµ„æ–¹ã€æœ¬å…¬å¸ï¼‰
- [ ] `partners` è¡¨æœ‰ `partner_type` å­—æ®µ
- [ ] é»˜è®¤å€¼ä¸º 'è´§ä¸»'
- [ ] ç´¢å¼•å·²åˆ›å»º
- [ ] éè´§ä¸»ç±»å‹çš„å±‚çº§å­—æ®µä¸º NULL
- [ ] è§¦å‘å™¨æ­£å¸¸å·¥ä½œï¼ˆæµ‹è¯•åˆ›å»ºè´§ä¸»å’Œåˆä½œå•†ï¼‰
- [ ] è§†å›¾åªæ˜¾ç¤ºè´§ä¸»
- [ ] ç»Ÿè®¡å‡½æ•°åªç»Ÿè®¡è´§ä¸»

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. âœ… è¿ç§»æ–‡ä»¶æ‰§è¡Œé¡ºåºæ˜¯å¦æ­£ç¡®
2. âœ… æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
3. âœ… æ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™æ‰§è¡Œ DDL æ“ä½œ
4. âœ… æ˜¯å¦åœ¨äº‹åŠ¡å—å¤–æ‰§è¡Œï¼ˆå¯¹äº ALTER TYPE ADD VALUEï¼‰

---

**æ›´æ–°æ—¶é—´**: 2025-01-22
**ç‰ˆæœ¬**: v1.0

