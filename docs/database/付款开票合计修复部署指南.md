# ä»˜æ¬¾å’Œå¼€ç¥¨ç”³è¯·åˆè®¡é‡‘é¢ä¿®å¤éƒ¨ç½²æŒ‡å—

## ğŸ“‹ é—®é¢˜è¯´æ˜

ç­›é€‰"å·²ç”³è¯·æ”¯ä»˜"æˆ–"å¼€ç¥¨ä¸­"çŠ¶æ€æ—¶ï¼Œåº•éƒ¨åˆè®¡è¡Œæ˜¾ç¤ºÂ¥0.00ã€‚

---

## ğŸ”’ éƒ¨ç½²å‰å‡†å¤‡

### 1. å¤‡ä»½å·²å®Œæˆ âœ…

**å¤‡ä»½æ–‡ä»¶ä½ç½®**ï¼š
```
scripts/sql/backup/backup_payment_invoice_summary_functions.sql
```

**åŸå§‹å‡½æ•°ä½ç½®**ï¼š
- `supabase/migrations/20251029_fix_payment_request_data_sort_by_auto_number.sql`
- `supabase/migrations/20251029_fix_invoice_request_data_sort_by_auto_number.sql`

---

### 2. ä¿®å¤æ–‡ä»¶ä½ç½®

**ä¿®å¤è¿ç§»**ï¼š
```
supabase/migrations/20250131_fix_payment_invoice_summary_by_status.sql
```

**ä¿®å¤è¯´æ˜**ï¼š
```
docs/bug-fixes/ä»˜æ¬¾å¼€ç¥¨ç”³è¯·åˆè®¡é‡‘é¢ç­›é€‰çŠ¶æ€ä¸åŒ¹é…ä¿®å¤.md
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥å½“å‰çŠ¶æ€

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd supabase
```

---

### æ­¥éª¤2ï¼šè¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨Supabase CLIï¼ˆæ¨èï¼‰
supabase db push

# æ–¹æ³•2ï¼šåœ¨Supabase Dashboardæ‰§è¡Œ
# æ‰“å¼€ Supabase Dashboard â†’ SQL Editor
# å¤åˆ¶ 20250131_fix_payment_invoice_summary_by_status.sql çš„å†…å®¹
# æ‰§è¡ŒSQL
```

---

### æ­¥éª¤3ï¼šéªŒè¯ä¿®å¤

1. **æ‰“å¼€ä»˜æ¬¾ç”³è¯·é¡µé¢**
   ```
   å¯¼èˆªåˆ°ï¼šåˆä½œæ–¹ä»˜æ¬¾ç”³è¯·
   ç­›é€‰æ¡ä»¶ï¼šå·²ç”³è¯·æ”¯ä»˜
   ç‚¹å‡»ï¼šæœç´¢
   æ£€æŸ¥ï¼šåº•éƒ¨åˆè®¡è¡Œæ˜¯å¦æ­£å¸¸æ˜¾ç¤ºé‡‘é¢ï¼ˆä¸æ˜¯Â¥0.00ï¼‰
   ```

2. **æ‰“å¼€å¼€ç¥¨ç”³è¯·é¡µé¢**
   ```
   å¯¼èˆªåˆ°ï¼šåˆä½œæ–¹å¼€ç¥¨ç”³è¯·
   ç­›é€‰æ¡ä»¶ï¼šå¼€ç¥¨ä¸­
   ç‚¹å‡»ï¼šæœç´¢
   æ£€æŸ¥ï¼šåº•éƒ¨åˆè®¡è¡Œæ˜¯å¦æ­£å¸¸æ˜¾ç¤ºé‡‘é¢
   ```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å‡½æ•°é‡è½½é—®é¢˜

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ERROR: 42725: function name "public.get_invoice_request_data" is not unique
HINT: Specify the argument list to select the function unambiguously.
```

**åŸå› **ï¼š
- å¯èƒ½å­˜åœ¨å¤šä¸ªåŒåå‡½æ•°ï¼ˆå‚æ•°ä¸åŒï¼‰
- éœ€è¦å…ˆåˆ é™¤æ—§ç‰ˆæœ¬å†åˆ›å»ºæ–°ç‰ˆæœ¬

**è§£å†³æ–¹æ³•**ï¼š

è¿ç§»æ–‡ä»¶å·²åŒ…å«åˆ é™¤é€»è¾‘ï¼š
```sql
-- å…ˆåˆ é™¤æ‰€æœ‰ç‰ˆæœ¬
DROP FUNCTION IF EXISTS public.get_payment_request_data CASCADE;
DROP FUNCTION IF EXISTS public.get_invoice_request_data CASCADE;

-- å†åˆ›å»ºæ–°ç‰ˆæœ¬
CREATE OR REPLACE FUNCTION ...
```

---

## ğŸ”„ å¦‚æœéœ€è¦å›æ»š

### æ–¹æ³•1ï¼šä½¿ç”¨åŸå§‹è¿ç§»æ–‡ä»¶æ¢å¤

```bash
# 1. æ‰¾åˆ°åŸå§‹è¿ç§»æ–‡ä»¶
# supabase/migrations/20251029_fix_payment_request_data_sort_by_auto_number.sql

# 2. åœ¨Supabase Dashboard SQL Editorä¸­æ‰§è¡Œè¯¥æ–‡ä»¶
# è¿™ä¼šæ¢å¤åˆ°ä¿®å¤å‰çš„ç‰ˆæœ¬
```

---

### æ–¹æ³•2ï¼šæ‰‹åŠ¨ä¿®æ”¹WHEREæ¡ä»¶

```sql
-- æ¢å¤ä»˜æ¬¾ç”³è¯·çš„åˆè®¡è®¡ç®—ï¼ˆæ”¹å›åªç»Ÿè®¡Unpaidï¼‰
-- æ‰¾åˆ°å‡½æ•°å®šä¹‰ä¸­çš„åˆè®¡è®¡ç®—éƒ¨åˆ†ï¼Œä¿®æ”¹ä¸ºï¼š
WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
  AND lpc.payment_status = 'Unpaid'  -- æ¢å¤ç¡¬ç¼–ç 

-- æ¢å¤å¼€ç¥¨ç”³è¯·çš„åˆè®¡è®¡ç®—ï¼ˆæ”¹å›åªç»Ÿè®¡Uninvoicedï¼‰
WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
  AND lpc.invoice_status = 'Uninvoiced'  -- æ¢å¤ç¡¬ç¼–ç 
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰

```
ç­›é€‰"å·²ç”³è¯·æ”¯ä»˜"ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿å•åˆ—è¡¨ï¼š10æ¡è¿å•æ­£å¸¸æ˜¾ç¤º     â”‚
â”‚ åº•éƒ¨åˆè®¡ï¼š                     â”‚
â”‚   å¸æœºåº”æ”¶: Â¥33,423.08 âœ…     â”‚
â”‚   å±±è¥¿æˆæœ¬: Â¥0.00 âŒ          â”‚
â”‚   å¼ æµ·äº®:   Â¥0.00 âŒ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿®å¤å

```
ç­›é€‰"å·²ç”³è¯·æ”¯ä»˜"ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿å•åˆ—è¡¨ï¼š10æ¡è¿å•æ­£å¸¸æ˜¾ç¤º     â”‚
â”‚ åº•éƒ¨åˆè®¡ï¼š                     â”‚
â”‚   å¸æœºåº”æ”¶: Â¥33,423.08 âœ…     â”‚
â”‚   å±±è¥¿æˆæœ¬: Â¥4,293.40 âœ…      â”‚
â”‚   å¼ æµ·äº®:   Â¥4,224.68 âœ…      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### ä»˜æ¬¾ç”³è¯·æµ‹è¯•

- [ ] ç­›é€‰"æœªæ”¯ä»˜" â†’ åˆè®¡æ­£å¸¸
- [ ] ç­›é€‰"å·²ç”³è¯·æ”¯ä»˜" â†’ åˆè®¡æ­£å¸¸ï¼ˆä¿®å¤é‡ç‚¹ï¼‰
- [ ] ç­›é€‰"å·²å®Œæˆæ”¯ä»˜" â†’ åˆè®¡æ­£å¸¸ï¼ˆä¿®å¤é‡ç‚¹ï¼‰
- [ ] ç­›é€‰"å…¨éƒ¨" â†’ åˆè®¡æ­£å¸¸
- [ ] åˆ‡æ¢ä¸åŒé¡¹ç›® â†’ åˆè®¡æ­£å¸¸
- [ ] æ—¥æœŸèŒƒå›´ç­›é€‰ â†’ åˆè®¡æ­£å¸¸

---

### å¼€ç¥¨ç”³è¯·æµ‹è¯•

- [ ] ç­›é€‰"æœªå¼€ç¥¨" â†’ åˆè®¡æ­£å¸¸
- [ ] ç­›é€‰"å¼€ç¥¨ä¸­" â†’ åˆè®¡æ­£å¸¸ï¼ˆä¿®å¤é‡ç‚¹ï¼‰
- [ ] ç­›é€‰"å·²å¼€ç¥¨" â†’ åˆè®¡æ­£å¸¸ï¼ˆä¿®å¤é‡ç‚¹ï¼‰
- [ ] ç­›é€‰"å…¨éƒ¨" â†’ åˆè®¡æ­£å¸¸
- [ ] åˆ‡æ¢ä¸åŒé¡¹ç›® â†’ åˆè®¡æ­£å¸¸
- [ ] æ—¥æœŸèŒƒå›´ç­›é€‰ â†’ åˆè®¡æ­£å¸¸

---

## ğŸ“ éƒ¨ç½²è®°å½•

### éƒ¨ç½²ä¿¡æ¯

- **éƒ¨ç½²æ—¥æœŸ**ï¼š2025-01-31
- **è¿ç§»æ–‡ä»¶**ï¼š20250131_fix_payment_invoice_summary_by_status.sql
- **å¤‡ä»½æ–‡ä»¶**ï¼šscripts/sql/backup/backup_payment_invoice_summary_functions.sql
- **å½±å“èŒƒå›´**ï¼šåˆä½œæ–¹ä»˜æ¬¾ç”³è¯·ã€åˆä½œæ–¹å¼€ç¥¨ç”³è¯·åº•éƒ¨åˆè®¡è¡Œ

---

### éƒ¨ç½²å‰æ£€æŸ¥

- [x] å¤‡ä»½æ–‡ä»¶å·²åˆ›å»º
- [x] ä¿®å¤SQLå·²å‡†å¤‡
- [x] å½±å“èŒƒå›´å·²æ˜ç¡®
- [x] å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡

---

### éƒ¨ç½²åæ£€æŸ¥

- [ ] è¿ç§»æ‰§è¡ŒæˆåŠŸ
- [ ] å‡½æ•°åˆ›å»ºæˆåŠŸ
- [ ] æµ‹è¯•æ¸…å•å…¨éƒ¨é€šè¿‡
- [ ] æ— æ–°å¢é”™è¯¯
- [ ] æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™

---

## ğŸ¯ æ‰§è¡Œå‘½ä»¤

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd C:\Users\admin\Desktop\ä¸­ç§‘ç‰©æµè·Ÿè¸ªç³»ç»Ÿé€»è¾‘\github\shipment-data-view

# è¿è¡Œè¿ç§»
supabase db push

# æˆ–è€…åœ¨Supabase Dashboardä¸­æ‰‹åŠ¨æ‰§è¡Œ
# SQL Editor â†’ ç²˜è´´è¿ç§»æ–‡ä»¶å†…å®¹ â†’ Run
```

---

## ğŸ’¡ æŠ€æœ¯è¯´æ˜

### ä¿®å¤å…³é”®ä»£ç 

**ä¿®å¤å‰**ï¼ˆç¡¬ç¼–ç ï¼‰ï¼š
```sql
WHERE lpc.payment_status = 'Unpaid'  -- æ€»æ˜¯åªç»Ÿè®¡æœªæ”¯ä»˜
```

**ä¿®å¤å**ï¼ˆåŠ¨æ€ï¼‰ï¼š
```sql
WHERE (
  p_payment_status_array IS NULL OR  -- æ²¡æœ‰ç­›é€‰
  (
    CASE 
      WHEN 'Processing' = ANY(p_payment_status_array) 
        THEN lpc.payment_status = 'Processing'  -- ç­›é€‰ä»€ä¹ˆç»Ÿè®¡ä»€ä¹ˆ
      WHEN 'Paid' = ANY(p_payment_status_array) 
        THEN lpc.payment_status = 'Paid'
      ELSE lpc.payment_status = 'Unpaid'
    END
  )
)
```

---

## ğŸ“ é‡åˆ°é—®é¢˜ï¼Ÿ

### é—®é¢˜1ï¼šå‡½æ•°åç§°ä¸å”¯ä¸€é”™è¯¯

**è§£å†³**ï¼š
```sql
-- å…ˆåˆ é™¤æ‰€æœ‰ç‰ˆæœ¬
DROP FUNCTION IF EXISTS public.get_payment_request_data CASCADE;

-- å†åˆ›å»ºæ–°ç‰ˆæœ¬
CREATE OR REPLACE FUNCTION public.get_payment_request_data(...) ...
```

---

### é—®é¢˜2ï¼šä¿®å¤ååˆè®¡è¿˜æ˜¯0

**å¯èƒ½åŸå› **ï¼š
1. ç¼“å­˜é—®é¢˜ â†’ åˆ·æ–°é¡µé¢
2. æ•°æ®æœ¬èº«ä¸º0 â†’ æ£€æŸ¥æ•°æ®
3. è¿ç§»æœªç”Ÿæ•ˆ â†’ æ£€æŸ¥è¿ç§»è®°å½•

**æ£€æŸ¥æ–¹æ³•**ï¼š
```sql
-- æ‰‹åŠ¨æµ‹è¯•å‡½æ•°
SELECT * FROM get_payment_request_data(
  p_payment_status_array => ARRAY['Processing']
);

-- æ£€æŸ¥è¿”å›çš„partnerså­—æ®µä¸­çš„total_payable
```

---

### é—®é¢˜3ï¼šéœ€è¦å›æ»š

**æ‰§è¡Œ**ï¼š
```sql
-- æŸ¥çœ‹åŸå§‹è¿ç§»æ–‡ä»¶
-- supabase/migrations/20251029_fix_payment_request_data_sort_by_auto_number.sql

-- å¤åˆ¶åŸå§‹å‡½æ•°å®šä¹‰
-- åœ¨SQL Editorä¸­æ‰§è¡Œ
```

---

## âœ… éƒ¨ç½²å®Œæˆç¡®è®¤

- [ ] è¿ç§»æ–‡ä»¶å·²æ‰§è¡Œ
- [ ] å‡½æ•°åˆ›å»ºæˆåŠŸ
- [ ] æµ‹è¯•é€šè¿‡
- [ ] ç”¨æˆ·ç¡®è®¤åˆè®¡æ­£å¸¸æ˜¾ç¤º

---

**å‡†å¤‡å¥½åï¼Œæ‰§è¡Œ `supabase db push` è¿›è¡Œéƒ¨ç½²ï¼** ğŸš€

**éƒ¨ç½²æŒ‡å—ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-01-31  
**æ–‡ä»¶å½’æ¡£ä½ç½®**ï¼šdocs/database/ï¼ˆéµå¾ªæ–‡æ¡£è§„èŒƒï¼‰âœ…

