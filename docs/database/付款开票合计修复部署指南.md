# 付款和开票申请合计金额修复部署指南

## 📋 问题说明

筛选"已申请支付"或"开票中"状态时，底部合计行显示¥0.00。

---

## 🔒 部署前准备

### 1. 备份已完成 ✅

**备份文件位置**：
```
scripts/sql/backup/backup_payment_invoice_summary_functions.sql
```

**原始函数位置**：
- `supabase/migrations/20251029_fix_payment_request_data_sort_by_auto_number.sql`
- `supabase/migrations/20251029_fix_invoice_request_data_sort_by_auto_number.sql`

---

### 2. 修复文件位置

**修复迁移**：
```
supabase/migrations/20250131_fix_payment_invoice_summary_by_status.sql
```

**修复说明**：
```
docs/bug-fixes/付款开票申请合计金额筛选状态不匹配修复.md
```

---

## 🚀 部署步骤

### 步骤1：检查当前状态

```bash
# 在项目根目录执行
cd supabase
```

---

### 步骤2：运行数据库迁移

```bash
# 方法1：使用Supabase CLI（推荐）
supabase db push

# 方法2：在Supabase Dashboard执行
# 打开 Supabase Dashboard → SQL Editor
# 复制 20250131_fix_payment_invoice_summary_by_status.sql 的内容
# 执行SQL
```

---

### 步骤3：验证修复

1. **打开付款申请页面**
   ```
   导航到：合作方付款申请
   筛选条件：已申请支付
   点击：搜索
   检查：底部合计行是否正常显示金额（不是¥0.00）
   ```

2. **打开开票申请页面**
   ```
   导航到：合作方开票申请
   筛选条件：开票中
   点击：搜索
   检查：底部合计行是否正常显示金额
   ```

---

## ⚠️ 注意事项

### 函数重载问题

**错误信息**：
```
ERROR: 42725: function name "public.get_invoice_request_data" is not unique
HINT: Specify the argument list to select the function unambiguously.
```

**原因**：
- 可能存在多个同名函数（参数不同）
- 需要先删除旧版本再创建新版本

**解决方法**：

迁移文件已包含删除逻辑：
```sql
-- 先删除所有版本
DROP FUNCTION IF EXISTS public.get_payment_request_data CASCADE;
DROP FUNCTION IF EXISTS public.get_invoice_request_data CASCADE;

-- 再创建新版本
CREATE OR REPLACE FUNCTION ...
```

---

## 🔄 如果需要回滚

### 方法1：使用原始迁移文件恢复

```bash
# 1. 找到原始迁移文件
# supabase/migrations/20251029_fix_payment_request_data_sort_by_auto_number.sql

# 2. 在Supabase Dashboard SQL Editor中执行该文件
# 这会恢复到修复前的版本
```

---

### 方法2：手动修改WHERE条件

```sql
-- 恢复付款申请的合计计算（改回只统计Unpaid）
-- 找到函数定义中的合计计算部分，修改为：
WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
  AND lpc.payment_status = 'Unpaid'  -- 恢复硬编码

-- 恢复开票申请的合计计算（改回只统计Uninvoiced）
WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
  AND lpc.invoice_status = 'Uninvoiced'  -- 恢复硬编码
```

---

## 📊 预期效果

### 修复前

```
筛选"已申请支付"：
┌────────────────────────────────┐
│ 运单列表：10条运单正常显示     │
│ 底部合计：                     │
│   司机应收: ¥33,423.08 ✅     │
│   山西成本: ¥0.00 ❌          │
│   张海亮:   ¥0.00 ❌          │
└────────────────────────────────┘
```

### 修复后

```
筛选"已申请支付"：
┌────────────────────────────────┐
│ 运单列表：10条运单正常显示     │
│ 底部合计：                     │
│   司机应收: ¥33,423.08 ✅     │
│   山西成本: ¥4,293.40 ✅      │
│   张海亮:   ¥4,224.68 ✅      │
└────────────────────────────────┘
```

---

## 🧪 测试清单

### 付款申请测试

- [ ] 筛选"未支付" → 合计正常
- [ ] 筛选"已申请支付" → 合计正常（修复重点）
- [ ] 筛选"已完成支付" → 合计正常（修复重点）
- [ ] 筛选"全部" → 合计正常
- [ ] 切换不同项目 → 合计正常
- [ ] 日期范围筛选 → 合计正常

---

### 开票申请测试

- [ ] 筛选"未开票" → 合计正常
- [ ] 筛选"开票中" → 合计正常（修复重点）
- [ ] 筛选"已开票" → 合计正常（修复重点）
- [ ] 筛选"全部" → 合计正常
- [ ] 切换不同项目 → 合计正常
- [ ] 日期范围筛选 → 合计正常

---

## 📝 部署记录

### 部署信息

- **部署日期**：2025-01-31
- **迁移文件**：20250131_fix_payment_invoice_summary_by_status.sql
- **备份文件**：scripts/sql/backup/backup_payment_invoice_summary_functions.sql
- **影响范围**：合作方付款申请、合作方开票申请底部合计行

---

### 部署前检查

- [x] 备份文件已创建
- [x] 修复SQL已准备
- [x] 影响范围已明确
- [x] 回滚方案已准备

---

### 部署后检查

- [ ] 迁移执行成功
- [ ] 函数创建成功
- [ ] 测试清单全部通过
- [ ] 无新增错误
- [ ] 性能无明显下降

---

## 🎯 执行命令

```bash
# 进入项目目录
cd C:\Users\admin\Desktop\中科物流跟踪系统逻辑\github\shipment-data-view

# 运行迁移
supabase db push

# 或者在Supabase Dashboard中手动执行
# SQL Editor → 粘贴迁移文件内容 → Run
```

---

## 💡 技术说明

### 修复关键代码

**修复前**（硬编码）：
```sql
WHERE lpc.payment_status = 'Unpaid'  -- 总是只统计未支付
```

**修复后**（动态）：
```sql
WHERE (
  p_payment_status_array IS NULL OR  -- 没有筛选
  (
    CASE 
      WHEN 'Processing' = ANY(p_payment_status_array) 
        THEN lpc.payment_status = 'Processing'  -- 筛选什么统计什么
      WHEN 'Paid' = ANY(p_payment_status_array) 
        THEN lpc.payment_status = 'Paid'
      ELSE lpc.payment_status = 'Unpaid'
    END
  )
)
```

---

## 📞 遇到问题？

### 问题1：函数名称不唯一错误

**解决**：
```sql
-- 先删除所有版本
DROP FUNCTION IF EXISTS public.get_payment_request_data CASCADE;

-- 再创建新版本
CREATE OR REPLACE FUNCTION public.get_payment_request_data(...) ...
```

---

### 问题2：修复后合计还是0

**可能原因**：
1. 缓存问题 → 刷新页面
2. 数据本身为0 → 检查数据
3. 迁移未生效 → 检查迁移记录

**检查方法**：
```sql
-- 手动测试函数
SELECT * FROM get_payment_request_data(
  p_payment_status_array => ARRAY['Processing']
);

-- 检查返回的partners字段中的total_payable
```

---

### 问题3：需要回滚

**执行**：
```sql
-- 查看原始迁移文件
-- supabase/migrations/20251029_fix_payment_request_data_sort_by_auto_number.sql

-- 复制原始函数定义
-- 在SQL Editor中执行
```

---

## ✅ 部署完成确认

- [ ] 迁移文件已执行
- [ ] 函数创建成功
- [ ] 测试通过
- [ ] 用户确认合计正常显示

---

**准备好后，执行 `supabase db push` 进行部署！** 🚀

**部署指南版本**：v1.0  
**最后更新**：2025-01-31  
**文件归档位置**：docs/database/（遵循文档规范）✅

