# 运单管理 - 导出功能说明

## 📋 导出逻辑概述

运单管理页面提供了两种导出方式：

### 1. 导出筛选结果
- **触发方式**：点击"导出筛选"按钮
- **导出内容**：当前筛选条件下的所有记录
- **数据获取**：通过 RPC 函数 `get_logistics_summary_and_records_enhanced_1201` 分批获取
- **限制**：最多导出 100,000 条记录（防止内存溢出）
- **文件名格式**：`运单记录_项目-XXX_2025-01-01至2025-01-31.xlsx`

### 2. 导出勾选数据
- **触发方式**：选择记录后，点击"导出勾选"按钮
- **导出内容**：用户手动勾选的记录
- **数据获取**：通过 `logistics_records_view` 视图分批查询（每批 100 条）
- **限制**：无限制（分批查询，避免 URL 过长）
- **文件名格式**：`运单记录_勾选_123条_2025/1/1.xlsx`

## 🔧 技术实现

### 数据获取流程

#### 导出筛选结果
```typescript
1. 使用 RPC 函数分批获取数据（每批 1000 条）
2. 循环获取直到没有更多数据或达到 100,000 条限制
3. 合并所有批次的数据
4. 调用 exportRecordsToExcel 导出
```

#### 导出勾选数据
```typescript
1. 将选中的 ID 列表分批（每批 100 个）
2. 使用 .in('id', batchIds) 查询每批数据
3. 合并所有批次的数据
4. 调用 exportRecordsToExcel 导出
```

### 分批查询的原因

1. **URL 长度限制**：浏览器 URL 最大长度约 2048 字符
   - 当选择大量记录时，所有 ID 拼接在 URL 中会超过限制
   - 解决方案：分批查询，每批最多 100 个 ID

2. **内存优化**：避免一次性加载过多数据导致浏览器崩溃
   - 筛选结果：每批 1000 条
   - 勾选数据：每批 100 条

3. **性能优化**：分批查询可以显示进度，提升用户体验

## 📊 导出字段说明

### 当前导出的字段（共 22 个）

| 序号 | 字段名 | 数据来源 | 说明 |
|------|--------|----------|------|
| 1 | 运单编号 | `auto_number` | 系统自动生成的运单号 |
| 2 | 项目名称 | `project_name` | 所属项目名称 |
| 3 | 合作链路 | `chain_name` | 合作链路名称，默认为"默认" |
| 4 | 司机姓名 | `driver_name` | 司机姓名 |
| 5 | 车牌号 | `license_plate` | 车辆车牌号 |
| 6 | 司机电话 | `driver_phone` | 司机联系电话 |
| 7 | 装货地点 | `loading_location` | 装货地点 |
| 8 | 卸货地点 | `unloading_location` | 卸货地点 |
| 9 | 装货日期 | `loading_date` | 装货日期（中国时区） |
| 10 | 卸货日期 | `unloading_date` | 卸货日期（中国时区） |
| 11 | 运输类型 | `transport_type` | 实际运输/退货 |
| 12 | 装货重量 | `loading_weight` | 装货重量（吨） |
| 13 | 卸货重量 | `unloading_weight` | 卸货重量（吨） |
| 14 | 运费金额 | `current_cost` | 运费金额（元） |
| 15 | 额外费用 | `extra_cost` | 额外费用（元） |
| 16 | 司机应收 | `payable_cost` | 司机应收金额（元） |
| 17 | **单价** | `unit_price` | 单价（元/吨） |
| 18 | **有效数量** | `effective_quantity` | 有效数量（吨） |
| 19 | **计算模式** | `calculation_mode` | 自动计算/手动输入 |
| 20 | **开票状态** | `invoice_status` | 未开票/处理中/已审批/已开票 |
| 21 | **付款状态** | `payment_status` | 未付款/处理中/已审批/已付款 |
| 22 | **收款状态** | `receipt_status` | 未收款/已收款 |
| 23 | **其他平台** | `other_platform_names` | 其他平台名称（逗号分隔） |
| 24 | **外部运单号** | `external_tracking_numbers` | 外部运单号（逗号分隔） |
| 25 | 备注 | `remarks` | 备注信息 |

**注**：加粗字段为新增字段（2025-12-02 添加）

## ➕ 如何添加新字段

### 步骤 1：确认字段在数据中
确保 `LogisticsRecord` 类型中包含该字段，或从 `logistics_records_view` 视图中可以获取。

### 步骤 2：修改导出函数
在 `src/pages/BusinessEntry/index.tsx` 的 `exportRecordsToExcel` 函数中添加字段：

```typescript
const dataToExport = records.map((r: LogisticsRecord) => ({
  // ... 现有字段 ...
  '新字段名': r.新字段名 || '默认值',
}));
```

### 步骤 3：字段格式化（如需要）
- **日期字段**：使用 `formatChinaDateForExport()` 转换为中国时区
- **数组字段**：使用 `.join(', ')` 转换为逗号分隔的字符串
- **状态字段**：使用三元表达式转换为中文显示

### 示例：添加新字段

```typescript
const dataToExport = records.map((r: LogisticsRecord) => ({
  // ... 现有字段 ...
  '创建时间': formatChinaDateForExport(r.created_at) || '',
  '创建人ID': r.created_by_user_id || '',
  '项目ID': r.project_id || '',
}));
```

## 🎯 字段选择建议

### 常用字段（已包含）
- ✅ 基本信息：运单编号、项目名称、司机信息
- ✅ 地点信息：装货地点、卸货地点
- ✅ 日期信息：装货日期、卸货日期
- ✅ 数量信息：装货重量、卸货重量
- ✅ 金额信息：运费金额、额外费用、司机应收
- ✅ 状态信息：开票状态、付款状态、收款状态

### 可选字段（可根据需要添加）
- `id`：记录ID（UUID）
- `project_id`：项目ID
- `chain_id`：合作链路ID
- `driver_id`：司机ID
- `billing_type_id`：计费类型ID
- `created_at`：创建时间
- `created_by_user_id`：创建人ID
- `loading_weighbridge_image_url`：装货磅单图片URL
- `unloading_weighbridge_image_url`：卸货磅单图片URL

## ⚠️ 注意事项

1. **字段顺序**：字段在对象中的顺序决定了 Excel 中的列顺序
2. **空值处理**：使用 `|| ''` 或 `|| 0` 处理空值，避免导出 `null` 或 `undefined`
3. **日期格式**：必须使用 `formatChinaDateForExport()` 转换日期，确保时区正确
4. **数组字段**：数组字段需要转换为字符串，使用 `.join(', ')`
5. **性能考虑**：添加过多字段可能影响导出性能，建议只添加必要的字段

## 📝 更新日志

- **2025-12-02**：添加了单价、有效数量、计算模式、开票状态、付款状态、收款状态、其他平台、外部运单号等 8 个新字段

---

**最后更新**：2025-12-02  
**维护者**：开发团队

