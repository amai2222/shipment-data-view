# 一键开票申请自动切分功能说明

## 功能概述

✅ **后端已实现按最高级合作方自动切分开票申请单**

当您使用"一键开票申请"功能时，系统会自动：
1. 找出所有运单中的**最高级别合作方**
2. **按不同的最高级合作方自动分组**
3. **为每个最高级合作方创建一个独立的开票申请单**

## 实现位置

### 后端函数
文件：`supabase/migrations/20250116_fix_save_invoice_request_update_logistics_records.sql`

函数：`save_invoice_request(p_record_ids uuid[])`

### 核心逻辑（第30-47行）

```sql
-- 1. 找出最高级别
SELECT MAX(level) INTO v_max_level
FROM public.logistics_partner_costs
WHERE logistics_record_id = ANY(p_record_ids)
  AND invoice_status = 'Uninvoiced';

-- 2. 按合作方分组处理（关键！）
FOR v_partner_id IN
    SELECT DISTINCT partner_id  -- 获取不同的最高级合作方
    FROM public.logistics_partner_costs
    WHERE logistics_record_id = ANY(p_record_ids)
      AND level = v_max_level   -- 只选最高级
      AND invoice_status = 'Uninvoiced'
LOOP
    -- 3. 为每个合作方创建一个独立的开票申请单
    -- ... 创建逻辑 ...
END LOOP;
```

## 工作流程

### 示例场景

假设您选中了10条运单：
- 5条运单的最高级合作方是 **中粮集团**
- 3条运单的最高级合作方是 **可乐公司**
- 2条运单的最高级合作方是 **盼盼集团**

### 系统自动处理

1. **识别最高级别**: 系统找出level=1（假设最高级是1）
2. **分组**:
   - 组1: 5条运单 → 中粮集团
   - 组2: 3条运单 → 可乐公司
   - 组3: 2条运单 → 盼盼集团

3. **创建申请单**:
   - 创建开票申请单 #1: 中粮集团，5条运单，总金额 ¥XXX
   - 创建开票申请单 #2: 可乐公司，3条运单，总金额 ¥XXX
   - 创建开票申请单 #3: 盼盼集团，2条运单，总金额 ¥XXX

### 返回结果

```json
{
  "success": true,
  "message": "开票申请创建成功",
  "created_requests": [
    {
      "request_id": "uuid-1",
      "request_number": "KP20251027-0001",
      "partner_id": "中粮集团ID",
      "partner_name": "中粮集团有限公司",
      "total_amount": 50000,
      "record_count": 5
    },
    {
      "request_id": "uuid-2",
      "request_number": "KP20251027-0002",
      "partner_id": "可乐公司ID",
      "partner_name": "可乐食品有限公司",
      "total_amount": 30000,
      "record_count": 3
    },
    {
      "request_id": "uuid-3",
      "request_number": "KP20251027-0003",
      "partner_id": "盼盼集团ID",
      "partner_name": "盼盼食品集团股份有限公司",
      "total_amount": 20000,
      "record_count": 2
    }
  ],
  "total_requests": 3,
  "processed_record_ids": [...]
}
```

## 前端调用

### 开票申请页面
文件：`src/pages/InvoiceRequest.tsx` (第544-576行)

```typescript
const handleSaveInvoiceRequest = async () => {
  const { data, error } = await supabase.rpc('save_invoice_request', {
    p_record_ids: finalInvoiceData.all_record_ids  // 传入运单ID数组
  });

  if (error) throw error;

  toast({
    title: "成功",
    description: `开票申请已成功创建，共处理 ${finalInvoiceData.all_record_ids.length} 条运单`,
    variant: "default"
  });
}
```

## 优化建议

### 改进提示信息

当前提示信息没有明确告知用户创建了多少个申请单，建议优化：

```typescript
const handleSaveInvoiceRequest = async () => {
  const { data, error } = await supabase.rpc('save_invoice_request', {
    p_record_ids: finalInvoiceData.all_record_ids
  });

  if (error) throw error;

  const result = data as { 
    success: boolean; 
    created_requests: any[]; 
    total_requests: number; 
  };

  toast({
    title: "成功",
    description: result.total_requests > 1 
      ? `已为 ${result.total_requests} 个最高级合作方创建开票申请单，共处理 ${finalInvoiceData.all_record_ids.length} 条运单`
      : `开票申请已成功创建，共处理 ${finalInvoiceData.all_record_ids.length} 条运单`,
    variant: "default"
  });
}
```

## 注意事项

### 1. 最高级合作方的定义
- 系统使用 `MAX(level)` 找出最高级别
- **level越小，级别越高**（level=1是最高级）
- 只为最高级合作方创建开票申请

### 2. 状态更新
函数会同时更新：
- ✅ `logistics_partner_costs.invoice_status` → 'Processing'
- ✅ `logistics_records.invoice_status` → 'Processing'
- ✅ 设置 `invoice_request_id` 和 `invoice_applied_at`

### 3. 权限检查
需要财务人员或管理员权限：
```sql
IF NOT public.is_finance_or_admin_for_invoice() THEN
    RAISE EXCEPTION '权限不足：只有财务人员或管理员可以创建开票申请';
END IF;
```

### 4. 数据验证
- 运单必须处于 `Uninvoiced` 状态
- 如果没有符合条件的运单，会抛出异常

## 测试步骤

### 测试自动切分功能

1. **准备数据**
   - 选择至少2个不同最高级合作方的运单
   - 确认运单状态都是"未开票"

2. **执行开票申请**
   - 勾选这些运单
   - 点击"一键开票申请"
   - 点击"确认并保存"

3. **验证结果**
   - 查看成功提示
   - 进入"财务开票"页面
   - 确认创建了多个申请单，每个对应一个最高级合作方

4. **检查详情**
   - 打开每个申请单
   - 验证运单分组正确
   - 验证金额计算正确

## 常见问题

### Q1: 为什么有些运单没有被包含在申请单中？
**A**: 可能原因：
- 运单不是最高级合作方的
- 运单已经申请过开票
- 运单状态不是"Uninvoiced"

### Q2: 如何知道创建了几个申请单？
**A**: 当前版本需要查看后端返回的 `total_requests` 字段。建议前端显示详细信息。

### Q3: 可以手动指定合作方吗？
**A**: 当前版本自动识别最高级合作方，不支持手动指定。这是为了保证业务逻辑的一致性。

### Q4: 如果需要给非最高级合作方开票怎么办？
**A**: 需要使用其他开票功能，或者调整合作链路配置。

## 相关文档

- 付款申请也使用类似的逻辑，参考：`src/pages/PaymentRequest.tsx`
- 合作方层级管理：相关配置和说明
- 开票申请单管理：`src/pages/InvoiceRequestManagement.tsx`

---

最后更新：2025-10-27
功能状态：✅ 已实现并正常工作

