# ğŸ’° è´¢åŠ¡æ”¶æ¬¾ï¼ˆè´¢åŠ¡æ”¶è´§ï¼‰æµç¨‹è¯¦è§£

## ğŸ“‹ ç›®å½•
- [æµç¨‹æ¦‚è¿°](#æµç¨‹æ¦‚è¿°)
- [å‰ç½®æ¡ä»¶](#å‰ç½®æ¡ä»¶)
- [å‰ç«¯æ“ä½œæµç¨‹](#å‰ç«¯æ“ä½œæµç¨‹)
- [åç«¯å¤„ç†é€»è¾‘](#åç«¯å¤„ç†é€»è¾‘)
- [æ•°æ®æµè½¬è¿‡ç¨‹](#æ•°æ®æµè½¬è¿‡ç¨‹)
- [çŠ¶æ€å˜æ›´è¯´æ˜](#çŠ¶æ€å˜æ›´è¯´æ˜)
- [è´§ä¸»ä½™é¢æ›´æ–°](#è´§ä¸»ä½™é¢æ›´æ–°)
- [å®Œæ•´æµç¨‹å›¾](#å®Œæ•´æµç¨‹å›¾)

---

## ğŸ¯ æµç¨‹æ¦‚è¿°

è´¢åŠ¡æ”¶æ¬¾æ˜¯æŒ‡è´¢åŠ¡äººå‘˜åœ¨æ”¶åˆ°å®¢æˆ·ï¼ˆè´§ä¸»ï¼‰çš„ä»˜æ¬¾åï¼Œåœ¨ç³»ç»Ÿä¸­ç™»è®°æ”¶æ¬¾ä¿¡æ¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
1. æ›´æ–°å¼€ç¥¨ç”³è¯·å•çŠ¶æ€ä¸º"å·²æ”¶æ¬¾"
2. æ›´æ–°ç›¸å…³è¿å•çš„**æ”¶æ¬¾çŠ¶æ€**ä¸º"å·²æ”¶æ¬¾"ï¼ˆ**ä¸æ›´æ–°å¼€ç¥¨çŠ¶æ€**ï¼‰
3. **ä¸ºè´§ä¸»è´¦å·å……å€¼**ï¼ˆå¢åŠ ä½™é¢ï¼‰

**é‡è¦è¯´æ˜**ï¼šæ”¶æ¬¾çŠ¶æ€ä¸å¼€ç¥¨çŠ¶æ€æ˜¯ç‹¬ç«‹çš„ä¸¤ä¸ªå­—æ®µï¼Œè´¢åŠ¡æ”¶æ¬¾æ“ä½œåªæ›´æ–°æ”¶æ¬¾çŠ¶æ€ï¼Œä¸ä¼šå½±å“è¿å•çš„å¼€ç¥¨çŠ¶æ€ã€‚

---

## âœ… å‰ç½®æ¡ä»¶

### 1. å¼€ç¥¨ç”³è¯·å•çŠ¶æ€
- âœ… `invoice_requests.status` = `'Completed'`ï¼ˆå·²å¼€ç¥¨ï¼‰
- âŒ ä¸èƒ½æ˜¯ `'Pending'`ï¼ˆå¾…å®¡æ ¸ï¼‰
- âŒ ä¸èƒ½æ˜¯ `'Approved'`ï¼ˆå·²å®¡æ‰¹å¾…å¼€ç¥¨ï¼‰
- âŒ ä¸èƒ½æ˜¯ `'Rejected'`ï¼ˆå·²é©³å›ï¼‰
- âŒ ä¸èƒ½æ˜¯ `'Voided'`ï¼ˆå·²ä½œåºŸï¼‰

### 2. è¿å•æ”¶æ¬¾çŠ¶æ€
- âœ… `logistics_records.receipt_status` = `'Unreceived'`ï¼ˆæœªæ”¶æ¬¾ï¼‰
- âŒ ä¸èƒ½æ˜¯ `'Received'`ï¼ˆå·²æ”¶æ¬¾ï¼‰

**æ³¨æ„**ï¼šæ”¶æ¬¾çŠ¶æ€ä¸å¼€ç¥¨çŠ¶æ€ï¼ˆ`invoice_status`ï¼‰æ˜¯ç‹¬ç«‹çš„ï¼Œæ”¶æ¬¾æ“ä½œä¸æ£€æŸ¥å¼€ç¥¨çŠ¶æ€ã€‚

### 4. ç”¨æˆ·æƒé™
- âœ… å¿…é¡»æ˜¯è´¢åŠ¡äººå‘˜æˆ–ç®¡ç†å‘˜
- âœ… é€šè¿‡ `is_finance_or_admin()` æƒé™æ£€æŸ¥

---

## ğŸ–¥ï¸ å‰ç«¯æ“ä½œæµç¨‹

### æ“ä½œé¡µé¢
**è´¢åŠ¡æ”¶æ¬¾**ï¼ˆè´¢åŠ¡ç®¡ç† â†’ è´¢åŠ¡æ”¶æ¬¾ï¼‰

### æ“ä½œæ­¥éª¤

#### 1. é€‰æ‹©æ”¶æ¬¾ç”³è¯·å•
- åœ¨åˆ—è¡¨ä¸­ç­›é€‰çŠ¶æ€ä¸º"å·²å¼€ç¥¨"ï¼ˆ`Completed`ï¼‰çš„ç”³è¯·å•
- ç‚¹å‡»ç”³è¯·å•çš„"æ”¶æ¬¾"æŒ‰é’®

#### 2. å¡«å†™æ”¶æ¬¾ä¿¡æ¯
æ‰“å¼€æ”¶æ¬¾å¯¹è¯æ¡†ï¼Œå¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| **æ”¶æ¬¾å•å·** | æ–‡æœ¬ | å¯é€‰ | é“¶è¡Œå›å•å•å·æˆ–å…¶ä»–æ”¶æ¬¾å‡­è¯å· |
| **æ”¶æ¬¾é“¶è¡Œ** | æ–‡æœ¬ | å¯é€‰ | æ”¶æ¬¾é“¶è¡Œåç§° |
| **æ”¶æ¬¾é‡‘é¢** | æ•°å­— | **å¿…å¡«** | å®é™…æ”¶åˆ°çš„é‡‘é¢ï¼ˆé»˜è®¤ç­‰äºå¼€ç¥¨é‡‘é¢ï¼‰ |
| **é“¶è¡Œå›å•å›¾ç‰‡** | å›¾ç‰‡æ•°ç»„ | å¯é€‰ | æ”¯æŒä¸Šä¼ å¤šå¼ é“¶è¡Œå›å•å›¾ç‰‡ |

#### 3. ä¸Šä¼ é“¶è¡Œå›å•ï¼ˆå¯é€‰ï¼‰
- ç‚¹å‡»"ä¸Šä¼ é“¶è¡Œå›å•å›¾ç‰‡"æŒ‰é’®
- é€‰æ‹©ä¸€å¼ æˆ–å¤šå¼ å›¾ç‰‡æ–‡ä»¶
- ç³»ç»Ÿè‡ªåŠ¨ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘å­˜å‚¨
- å›¾ç‰‡å‘½åæ ¼å¼ï¼š`æ”¶æ¬¾å›å•-{ç”³è¯·å•å·}-{æ—¶é—´æˆ³}`

#### 4. ç¡®è®¤æ”¶æ¬¾
- ç‚¹å‡»"ç¡®è®¤æ”¶æ¬¾"æŒ‰é’®
- ç³»ç»Ÿæ‰§è¡Œæ”¶æ¬¾æ“ä½œ
- æ˜¾ç¤ºæˆåŠŸæç¤º

### å‰ç«¯ä»£ç æµç¨‹

```typescript
// 1. ç”¨æˆ·ç‚¹å‡»"æ”¶æ¬¾"æŒ‰é’®
handleReceipt() {
  // 2. éªŒè¯è¾“å…¥
  if (!receiptAmount || parseFloat(receiptAmount) <= 0) {
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    return;
  }
  
  // 3. ä¸Šä¼ é“¶è¡Œå›å•å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
  if (receiptImages.length > 0) {
    // è½¬æ¢ä¸ºbase64
    // è°ƒç”¨ä¸ƒç‰›äº‘ä¸Šä¼ å‡½æ•°
    // è·å–å›¾ç‰‡URLæ•°ç»„
  }
  
  // 4. è°ƒç”¨åç«¯RPCå‡½æ•°
  await supabase.rpc('receive_invoice_payment', {
    p_request_number: selectedReceiptRequest.request_number,
    p_receipt_number: receiptNumber || null,
    p_receipt_bank: receiptBank || null,
    p_received_amount: parseFloat(receiptAmount),
    p_receipt_images: receiptImageUrls.length > 0 ? receiptImageUrls : null
  });
  
  // 5. å¤„ç†ç»“æœ
  if (success) {
    // æ¸…ç©ºè¡¨å•
    // åˆ·æ–°åˆ—è¡¨
    // æ˜¾ç¤ºæˆåŠŸæç¤º
  }
}
```

---

## âš™ï¸ åç«¯å¤„ç†é€»è¾‘

### RPCå‡½æ•°
**å‡½æ•°å**ï¼š`receive_invoice_payment`

**å‚æ•°**ï¼š
```sql
p_request_number TEXT,           -- ç”³è¯·å•å·ï¼ˆå¿…å¡«ï¼‰
p_receipt_number TEXT,           -- æ”¶æ¬¾å•å·ï¼ˆå¯é€‰ï¼‰
p_receipt_bank TEXT,             -- æ”¶æ¬¾é“¶è¡Œï¼ˆå¯é€‰ï¼‰
p_received_amount NUMERIC,       -- æ”¶æ¬¾é‡‘é¢ï¼ˆå¿…å¡«ï¼‰
p_receipt_images TEXT[]          -- é“¶è¡Œå›å•å›¾ç‰‡URLæ•°ç»„ï¼ˆå¯é€‰ï¼‰
```

### å¤„ç†æ­¥éª¤

#### æ­¥éª¤1ï¼šæƒé™æ£€æŸ¥
```sql
IF NOT public.is_finance_or_admin() THEN
    RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šåªæœ‰è´¢åŠ¡äººå‘˜æˆ–ç®¡ç†å‘˜å¯ä»¥ç™»è®°æ”¶æ¬¾';
END IF;
```

#### æ­¥éª¤2ï¼šéªŒè¯ç”³è¯·å•
```sql
-- è·å–ç”³è¯·å•ä¿¡æ¯
SELECT * INTO v_request
FROM public.invoice_requests
WHERE request_number = p_request_number;

-- æ£€æŸ¥ç”³è¯·å•æ˜¯å¦å­˜åœ¨
IF NOT FOUND THEN
    RAISE EXCEPTION 'å¼€ç¥¨ç”³è¯·ä¸å­˜åœ¨: %', p_request_number;
END IF;

-- æ£€æŸ¥ç”³è¯·å•çŠ¶æ€
IF v_request.status != 'Completed' THEN
    RAISE EXCEPTION 'åªèƒ½å¯¹å·²å¼€ç¥¨çŠ¶æ€çš„ç”³è¯·å•è¿›è¡Œæ”¶æ¬¾ï¼Œå½“å‰çŠ¶æ€: %', v_request.status;
END IF;
```

#### æ­¥éª¤3ï¼šè·å–å…³è”è¿å•ID
```sql
SELECT ARRAY_AGG(DISTINCT logistics_record_id)
INTO v_record_ids
FROM public.invoice_request_details
WHERE invoice_request_id = v_request.id;
```

#### æ­¥éª¤4ï¼šæ›´æ–°å¼€ç¥¨ç”³è¯·å•
```sql
UPDATE public.invoice_requests 
SET 
    status = 'Received',                    -- çŠ¶æ€ï¼šå·²æ”¶æ¬¾
    receipt_number = p_receipt_number,     -- æ”¶æ¬¾å•å·
    receipt_bank = p_receipt_bank,          -- æ”¶æ¬¾é“¶è¡Œ
    received_amount = p_received_amount,    -- æ”¶æ¬¾é‡‘é¢
    received_at = NOW(),                    -- æ”¶æ¬¾æ—¶é—´
    received_by = v_user_id,                -- æ”¶æ¬¾æ“ä½œäººID
    receipt_images = COALESCE(p_receipt_images, ARRAY[]::TEXT[]),  -- é“¶è¡Œå›å•å›¾ç‰‡
    updated_at = NOW()
WHERE request_number = p_request_number;
```

#### æ­¥éª¤5ï¼šæ›´æ–°è¿å•æ”¶æ¬¾çŠ¶æ€ï¼ˆä¸æ›´æ–°å¼€ç¥¨çŠ¶æ€ï¼‰â­
```sql
UPDATE public.logistics_records
SET 
    receipt_status = 'Received',  -- æ”¶æ¬¾çŠ¶æ€ï¼šå·²æ”¶æ¬¾ï¼ˆç‹¬ç«‹äºå¼€ç¥¨çŠ¶æ€ï¼‰
    updated_at = NOW()
WHERE id = ANY(v_record_ids)
  AND receipt_status = 'Unreceived';  -- åªæ›´æ–°æœªæ”¶æ¬¾çŠ¶æ€çš„è¿å•
```

**é‡è¦**ï¼šæ­¤æ“ä½œåªæ›´æ–° `receipt_status`ï¼ˆæ”¶æ¬¾çŠ¶æ€ï¼‰ï¼Œä¸æ›´æ–° `invoice_status`ï¼ˆå¼€ç¥¨çŠ¶æ€ï¼‰ã€‚

#### æ­¥éª¤6ï¼šç»™è´§ä¸»è´¦å·å……å€¼ â­
```sql
IF v_request.invoicing_partner_id IS NOT NULL THEN
    PERFORM public.update_partner_balance(
        p_partner_id := v_request.invoicing_partner_id,
        p_amount := p_received_amount,      -- æ­£æ•°è¡¨ç¤ºå……å€¼
        p_transaction_type := 'recharge',   -- äº¤æ˜“ç±»å‹ï¼šå……å€¼
        p_transaction_category := 'invoice_receipt',  -- äº¤æ˜“ç±»åˆ«ï¼šè´¢åŠ¡æ”¶æ¬¾
        p_reference_type := 'invoice_receipt',
        p_reference_id := v_request.id,
        p_reference_number := p_request_number,
        p_description := format('å¼€ç¥¨æ”¶æ¬¾ï¼šç”³è¯·å• %sï¼Œæ”¶æ¬¾é‡‘é¢ Â¥%s', p_request_number, p_received_amount)
    );
END IF;
```

---

## ğŸ“Š æ•°æ®æµè½¬è¿‡ç¨‹

### 1. å¼€ç¥¨ç”³è¯·å•è¡¨ï¼ˆinvoice_requestsï¼‰

| å­—æ®µ | å˜æ›´å‰ | å˜æ›´å | è¯´æ˜ |
|------|--------|--------|------|
| `status` | `'Completed'` | `'Received'` | çŠ¶æ€ï¼šå·²å¼€ç¥¨ â†’ å·²æ”¶æ¬¾ |
| `receipt_number` | `NULL` | `p_receipt_number` | æ”¶æ¬¾å•å· |
| `receipt_bank` | `NULL` | `p_receipt_bank` | æ”¶æ¬¾é“¶è¡Œ |
| `received_amount` | `NULL` | `p_received_amount` | æ”¶æ¬¾é‡‘é¢ |
| `received_at` | `NULL` | `NOW()` | æ”¶æ¬¾æ—¶é—´ |
| `received_by` | `NULL` | `auth.uid()` | æ”¶æ¬¾æ“ä½œäººID |
| `receipt_images` | `'{}'` | `p_receipt_images` | é“¶è¡Œå›å•å›¾ç‰‡URLæ•°ç»„ |
| `updated_at` | æ—§æ—¶é—´ | `NOW()` | æœ€åæ›´æ–°æ—¶é—´ |

### 2. è¿å•è¡¨ï¼ˆlogistics_recordsï¼‰

| å­—æ®µ | å˜æ›´å‰ | å˜æ›´å | è¯´æ˜ |
|------|--------|--------|------|
| `receipt_status` | `'Unreceived'` | `'Received'` | **æ”¶æ¬¾çŠ¶æ€**ï¼šæœªæ”¶æ¬¾ â†’ å·²æ”¶æ¬¾ |
| `invoice_status` | **ä¸å˜** | **ä¸å˜** | **å¼€ç¥¨çŠ¶æ€ä¸å—å½±å“**ï¼ˆä¿æŒåŸå€¼ï¼‰ |
| `updated_at` | æ—§æ—¶é—´ | `NOW()` | æœ€åæ›´æ–°æ—¶é—´ |

**æ¡ä»¶**ï¼šåªæ›´æ–° `receipt_status = 'Unreceived'` çš„è¿å•

**é‡è¦**ï¼šæ”¶æ¬¾çŠ¶æ€ï¼ˆ`receipt_status`ï¼‰ä¸å¼€ç¥¨çŠ¶æ€ï¼ˆ`invoice_status`ï¼‰æ˜¯ç‹¬ç«‹çš„ä¸¤ä¸ªå­—æ®µï¼Œæ”¶æ¬¾æ“ä½œä¸ä¿®æ”¹å¼€ç¥¨çŠ¶æ€ã€‚

### 3. è´§ä¸»ä½™é¢è¡¨ï¼ˆpartner_balanceï¼‰â­

| å­—æ®µ | å˜æ›´å‰ | å˜æ›´å | è¯´æ˜ |
|------|--------|--------|------|
| `balance` | `æ—§ä½™é¢` | `æ—§ä½™é¢ + p_received_amount` | ä½™é¢å¢åŠ ï¼ˆå……å€¼ï¼‰ |
| `updated_at` | æ—§æ—¶é—´ | `NOW()` | æœ€åæ›´æ–°æ—¶é—´ |

**æ¡ä»¶**ï¼š`partner_id = v_request.invoicing_partner_id`

### 4. è´§ä¸»ä½™é¢æµæ°´è¡¨ï¼ˆpartner_balance_transactionsï¼‰â­

**æ–°å¢ä¸€æ¡æµæ°´è®°å½•**ï¼š

| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|-----|------|
| `partner_id` | `v_request.invoicing_partner_id` | è´§ä¸»ID |
| `transaction_type` | `'recharge'` | äº¤æ˜“ç±»å‹ï¼šå……å€¼ |
| `transaction_category` | `'invoice_receipt'` | äº¤æ˜“ç±»åˆ«ï¼šè´¢åŠ¡æ”¶æ¬¾ |
| `amount` | `p_received_amount` | äº¤æ˜“é‡‘é¢ï¼ˆæ­£æ•°ï¼‰ |
| `balance_before` | `æ—§ä½™é¢` | äº¤æ˜“å‰ä½™é¢ |
| `balance_after` | `æ—§ä½™é¢ + p_received_amount` | äº¤æ˜“åä½™é¢ |
| `reference_type` | `'invoice_receipt'` | å…³è”ç±»å‹ï¼šå¼€ç¥¨æ”¶æ¬¾ |
| `reference_id` | `v_request.id` | å…³è”IDï¼šç”³è¯·å•ID |
| `reference_number` | `p_request_number` | å…³è”ç¼–å·ï¼šç”³è¯·å•å· |
| `description` | `'å¼€ç¥¨æ”¶æ¬¾ï¼šç”³è¯·å• {ç”³è¯·å•å·}ï¼Œæ”¶æ¬¾é‡‘é¢ Â¥{é‡‘é¢}'` | äº¤æ˜“æè¿° |
| `created_by` | `auth.uid()` | æ“ä½œäººID |
| `created_at` | `NOW()` | åˆ›å»ºæ—¶é—´ |

---

## ğŸ”„ çŠ¶æ€å˜æ›´è¯´æ˜

### å¼€ç¥¨ç”³è¯·å•çŠ¶æ€æµè½¬

```
Pending (å¾…å®¡æ ¸)
    â†“ [å®¡æ‰¹]
Approved (å·²å®¡æ‰¹å¾…å¼€ç¥¨)
    â†“ [å¼€ç¥¨]
Completed (å·²å¼€ç¥¨)  â† æ”¶æ¬¾æ“ä½œçš„å‰ç½®çŠ¶æ€
    â†“ [æ”¶æ¬¾] â­
Received (å·²æ”¶æ¬¾)  â† æ”¶æ¬¾æ“ä½œåçš„çŠ¶æ€
```

### è¿å•æ”¶æ¬¾çŠ¶æ€æµè½¬ï¼ˆç‹¬ç«‹äºå¼€ç¥¨çŠ¶æ€ï¼‰

```
Unreceived (æœªæ”¶æ¬¾)  â† é»˜è®¤çŠ¶æ€
    â†“ [è´¢åŠ¡æ”¶æ¬¾] â­
Received (å·²æ”¶æ¬¾)  â† æ”¶æ¬¾æ“ä½œåçš„çŠ¶æ€
```

**é‡è¦**ï¼šæ”¶æ¬¾çŠ¶æ€ä¸å¼€ç¥¨çŠ¶æ€æ˜¯ç‹¬ç«‹çš„ï¼Œæ”¶æ¬¾æ“ä½œä¸å½±å“å¼€ç¥¨çŠ¶æ€ã€‚

### è¿å•å¼€ç¥¨çŠ¶æ€æµè½¬ï¼ˆä¸å—æ”¶æ¬¾å½±å“ï¼‰

```
Uninvoiced (æœªå¼€ç¥¨)
    â†“ [ç”³è¯·å¼€ç¥¨]
Processing (å·²ç”³è¯·å¼€ç¥¨)
    â†“ [å®¡æ‰¹]
Approved (å¼€ç¥¨å®¡æ ¸é€šè¿‡)
    â†“ [å¼€ç¥¨]
Invoiced (å·²å¼€ç¥¨)  â† æ”¶æ¬¾æ“ä½œä¸æ”¹å˜æ­¤çŠ¶æ€
```

**è¯´æ˜**ï¼šå¼€ç¥¨çŠ¶æ€å’Œæ”¶æ¬¾çŠ¶æ€å¯ä»¥ç‹¬ç«‹å˜åŒ–ï¼Œä¾‹å¦‚ï¼š
- å·²å¼€ç¥¨ä½†æœªæ”¶æ¬¾ï¼š`invoice_status = 'Invoiced'`, `receipt_status = 'Unreceived'`
- å·²å¼€ç¥¨ä¸”å·²æ”¶æ¬¾ï¼š`invoice_status = 'Invoiced'`, `receipt_status = 'Received'`

---

## ğŸ’µ è´§ä¸»ä½™é¢æ›´æ–°

### æ›´æ–°é€»è¾‘

è´¢åŠ¡æ”¶æ¬¾è§†åŒ**ç»™è´§ä¸»è´¦å·å……å€¼**ï¼ˆæ­£æ•°æ“ä½œï¼‰ï¼š

1. **è·å–è´§ä¸»ID**
   - ä» `invoice_requests.invoicing_partner_id` è·å–å¼€ç¥¨æ–¹ï¼ˆè´§ä¸»ï¼‰ID

2. **è°ƒç”¨ä½™é¢æ›´æ–°å‡½æ•°**
   ```sql
   PERFORM public.update_partner_balance(
       p_partner_id := v_request.invoicing_partner_id,
       p_amount := p_received_amount,  -- æ­£æ•°è¡¨ç¤ºå……å€¼
       p_transaction_type := 'recharge',
       p_transaction_category := 'invoice_receipt',
       ...
   );
   ```

3. **ä½™é¢è®¡ç®—**
   ```
   æ–°ä½™é¢ = æ—§ä½™é¢ + æ”¶æ¬¾é‡‘é¢
   ```

4. **è®°å½•æµæ°´**
   - åœ¨ `partner_balance_transactions` è¡¨ä¸­æ’å…¥ä¸€æ¡å……å€¼æµæ°´
   - äº¤æ˜“ç±»åˆ«ï¼š`'invoice_receipt'`ï¼ˆè´¢åŠ¡æ”¶æ¬¾ï¼‰
   - äº¤æ˜“ç±»å‹ï¼š`'recharge'`ï¼ˆå……å€¼ï¼‰

### ä½™é¢æµæ°´ç¤ºä¾‹

å‡è®¾ï¼š
- è´§ä¸»IDï¼š`uuid-123`
- ç”³è¯·å•å·ï¼š`INVOICE-20251114-001`
- æ”¶æ¬¾é‡‘é¢ï¼š`Â¥10,000.00`
- æ—§ä½™é¢ï¼š`Â¥50,000.00`

**æ›´æ–°å**ï¼š
- æ–°ä½™é¢ï¼š`Â¥60,000.00`
- æµæ°´è®°å½•ï¼š
  ```
  äº¤æ˜“ç±»å‹ï¼šå……å€¼
  äº¤æ˜“ç±»åˆ«ï¼šè´¢åŠ¡æ”¶æ¬¾
  äº¤æ˜“é‡‘é¢ï¼š+Â¥10,000.00
  äº¤æ˜“å‰ä½™é¢ï¼šÂ¥50,000.00
  äº¤æ˜“åä½™é¢ï¼šÂ¥60,000.00
  å…³è”ä¿¡æ¯ï¼šç”³è¯·å• INVOICE-20251114-001
  æè¿°ï¼šå¼€ç¥¨æ”¶æ¬¾ï¼šç”³è¯·å• INVOICE-20251114-001ï¼Œæ”¶æ¬¾é‡‘é¢ Â¥10000.00
  ```

---

## ğŸ“ˆ å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è´¢åŠ¡æ”¶æ¬¾å®Œæ•´æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€å‰ç«¯æ“ä½œã€‘
    â”‚
    â”œâ”€ 1. é€‰æ‹©"å·²å¼€ç¥¨"çŠ¶æ€çš„ç”³è¯·å•
    â”‚
    â”œâ”€ 2. ç‚¹å‡»"æ”¶æ¬¾"æŒ‰é’®
    â”‚
    â”œâ”€ 3. å¡«å†™æ”¶æ¬¾ä¿¡æ¯
    â”‚   â”œâ”€ æ”¶æ¬¾å•å·ï¼ˆå¯é€‰ï¼‰
    â”‚   â”œâ”€ æ”¶æ¬¾é“¶è¡Œï¼ˆå¯é€‰ï¼‰
    â”‚   â”œâ”€ æ”¶æ¬¾é‡‘é¢ï¼ˆå¿…å¡«ï¼‰
    â”‚   â””â”€ é“¶è¡Œå›å•å›¾ç‰‡ï¼ˆå¯é€‰ï¼Œæ”¯æŒå¤šå›¾ï¼‰
    â”‚
    â”œâ”€ 4. ä¸Šä¼ é“¶è¡Œå›å•åˆ°ä¸ƒç‰›äº‘ï¼ˆå¦‚æœæœ‰ï¼‰
    â”‚   â””â”€ è·å–å›¾ç‰‡URLæ•°ç»„
    â”‚
    â””â”€ 5. è°ƒç”¨åç«¯RPCå‡½æ•°
        â”‚
        â–¼
ã€åç«¯å¤„ç†ã€‘
    â”‚
    â”œâ”€ æ­¥éª¤1ï¼šæƒé™æ£€æŸ¥
    â”‚   â””â”€ is_finance_or_admin()
    â”‚
    â”œâ”€ æ­¥éª¤2ï¼šéªŒè¯ç”³è¯·å•
    â”‚   â”œâ”€ æ£€æŸ¥ç”³è¯·å•æ˜¯å¦å­˜åœ¨
    â”‚   â””â”€ æ£€æŸ¥çŠ¶æ€æ˜¯å¦ä¸º 'Completed'
    â”‚
    â”œâ”€ æ­¥éª¤3ï¼šè·å–å…³è”è¿å•ID
    â”‚   â””â”€ ä» invoice_request_details è¡¨æŸ¥è¯¢
    â”‚
    â”œâ”€ æ­¥éª¤4ï¼šæ›´æ–°å¼€ç¥¨ç”³è¯·å• â­
    â”‚   â””â”€ invoice_requests
    â”‚       â”œâ”€ status: 'Completed' â†’ 'Received'
    â”‚       â”œâ”€ receipt_number: æ”¶æ¬¾å•å·
    â”‚       â”œâ”€ receipt_bank: æ”¶æ¬¾é“¶è¡Œ
    â”‚       â”œâ”€ received_amount: æ”¶æ¬¾é‡‘é¢
    â”‚       â”œâ”€ received_at: æ”¶æ¬¾æ—¶é—´
    â”‚       â”œâ”€ received_by: æ“ä½œäººID
    â”‚       â””â”€ receipt_images: é“¶è¡Œå›å•å›¾ç‰‡URLæ•°ç»„
    â”‚
    â”œâ”€ æ­¥éª¤5ï¼šæ›´æ–°è¿å•æ”¶æ¬¾çŠ¶æ€ â­
    â”‚   â””â”€ logistics_records
    â”‚       â””â”€ receipt_status: 'Unreceived' â†’ 'Received'
    â”‚       â””â”€ invoice_status: ä¿æŒä¸å˜ï¼ˆä¸ä¿®æ”¹å¼€ç¥¨çŠ¶æ€ï¼‰
    â”‚
    â””â”€ æ­¥éª¤6ï¼šç»™è´§ä¸»è´¦å·å……å€¼ â­â­
        â””â”€ partner_balance
            â”œâ”€ balance: æ—§ä½™é¢ + æ”¶æ¬¾é‡‘é¢
            â””â”€ partner_balance_transactions
                â””â”€ æ’å…¥ä¸€æ¡å……å€¼æµæ°´è®°å½•
                    â”œâ”€ transaction_type: 'recharge'
                    â”œâ”€ transaction_category: 'invoice_receipt'
                    â”œâ”€ amount: æ”¶æ¬¾é‡‘é¢ï¼ˆæ­£æ•°ï¼‰
                    â””â”€ description: 'å¼€ç¥¨æ”¶æ¬¾ï¼šç”³è¯·å• {ç”³è¯·å•å·}ï¼Œæ”¶æ¬¾é‡‘é¢ Â¥{é‡‘é¢}'
        â”‚
        â–¼
ã€è¿”å›ç»“æœã€‘
    â”‚
    â””â”€ è¿”å›æˆåŠŸæ¶ˆæ¯
        â”œâ”€ success: true
        â”œâ”€ message: 'æ”¶æ¬¾ç™»è®°æˆåŠŸï¼Œå·²æ›´æ–° X æ¡è¿å•çŠ¶æ€ä¸ºå·²æ”¶æ¬¾ï¼Œå·²ä¸ºè´§ä¸»è´¦å·å……å€¼ Â¥X'
        â””â”€ updated_count: æ›´æ–°çš„è¿å•æ•°é‡
```

---

## ğŸ” å…³é”®ç‚¹è¯´æ˜

### 1. çŠ¶æ€æ£€æŸ¥
- âœ… åªèƒ½å¯¹ `'Completed'`ï¼ˆå·²å¼€ç¥¨ï¼‰çŠ¶æ€çš„ç”³è¯·å•è¿›è¡Œæ”¶æ¬¾
- âœ… åªæ›´æ–° `'Unreceived'`ï¼ˆæœªæ”¶æ¬¾ï¼‰çŠ¶æ€çš„è¿å•
- âœ… **æ”¶æ¬¾çŠ¶æ€ä¸å¼€ç¥¨çŠ¶æ€ç‹¬ç«‹**ï¼Œæ”¶æ¬¾æ“ä½œä¸æ£€æŸ¥æˆ–ä¿®æ”¹å¼€ç¥¨çŠ¶æ€

### 2. è´§ä¸»ä½™é¢æ›´æ–°
- âœ… è´¢åŠ¡æ”¶æ¬¾è§†åŒ**å……å€¼**æ“ä½œï¼ˆæ­£æ•°ï¼‰
- âœ… è‡ªåŠ¨è®°å½•ä½™é¢æµæ°´
- âœ… äº¤æ˜“ç±»åˆ«ï¼š`'invoice_receipt'`ï¼ˆè´¢åŠ¡æ”¶æ¬¾ï¼‰

### 3. æ•°æ®ä¸€è‡´æ€§
- âœ… ç”³è¯·å•çŠ¶æ€å’Œè¿å•æ”¶æ¬¾çŠ¶æ€åŒæ­¥æ›´æ–°
- âœ… æ‰€æœ‰æ›´æ–°æ“ä½œåœ¨åŒä¸€äº‹åŠ¡ä¸­å®Œæˆ
- âœ… å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ•´ä¸ªæ“ä½œå›æ»š
- âœ… **æ”¶æ¬¾çŠ¶æ€ä¸å¼€ç¥¨çŠ¶æ€ç‹¬ç«‹ç®¡ç†**ï¼Œäº’ä¸å½±å“

### 4. æƒé™æ§åˆ¶
- âœ… åªæœ‰è´¢åŠ¡äººå‘˜æˆ–ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ”¶æ¬¾æ“ä½œ
- âœ… é€šè¿‡ `is_finance_or_admin()` å‡½æ•°æ£€æŸ¥

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- **æ•°æ®åº“è¿ç§»**ï¼š`supabase/migrations/20251114_add_invoice_receipt_functionality.sql`
- **å‰ç«¯é¡µé¢**ï¼š`src/pages/PaymentInvoice.tsx`
- **ä½™é¢ç³»ç»Ÿ**ï¼š`supabase/migrations/20251114_add_partner_balance_system.sql`

---

**æœ€åæ›´æ–°**ï¼š2025-11-14

