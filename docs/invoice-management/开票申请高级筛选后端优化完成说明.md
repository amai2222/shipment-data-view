# å¼€ç¥¨ç”³è¯·é«˜çº§ç­›é€‰åç«¯ä¼˜åŒ–å®Œæˆè¯´æ˜

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

å°†å¼€ç¥¨ç”³è¯·çš„é«˜çº§ç­›é€‰ä»å®¢æˆ·ç«¯ç­›é€‰æ”¹ä¸ºåç«¯ç­›é€‰ï¼Œæä¾›æ›´å¥½çš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚

## âœ… å®Œæˆçš„ä¿®æ”¹

### 1. åç«¯å‡½æ•°ä¼˜åŒ–

**æ–°å¢è¿ç§»æ–‡ä»¶**: `supabase/migrations/20250116_add_advanced_filtering_to_invoice_request_data.sql`

**å‡½æ•°å‚æ•°æ‰©å±•**:
```sql
CREATE OR REPLACE FUNCTION public.get_invoice_request_data(
    p_project_id uuid DEFAULT NULL::uuid, 
    p_start_date date DEFAULT NULL::date, 
    p_end_date date DEFAULT NULL::date, 
    p_partner_id uuid DEFAULT NULL::uuid, 
    p_invoice_status_array text[] DEFAULT NULL::text[], 
    p_page_size integer DEFAULT 50, 
    p_page_number integer DEFAULT 1,
    -- æ–°å¢é«˜çº§ç­›é€‰å‚æ•°
    p_waybill_numbers text DEFAULT NULL::text,
    p_driver_name text DEFAULT NULL::text,
    p_license_plate text DEFAULT NULL::text,
    p_driver_phone text DEFAULT NULL::text,
    p_driver_receivable text DEFAULT NULL::text
)
```

### 2. åç«¯ç­›é€‰é€»è¾‘å®ç°

**å‚æ•°è§£æ**:
```sql
-- è§£æé«˜çº§ç­›é€‰å‚æ•°
IF p_waybill_numbers IS NOT NULL AND p_waybill_numbers != '' THEN
    waybill_array := string_to_array(p_waybill_numbers, ',');
    -- å»é™¤ç©ºç™½å­—ç¬¦
    waybill_array := array_remove(array_trim(waybill_array), '');
END IF;
```

**ç­›é€‰æ¡ä»¶**:
```sql
-- é«˜çº§ç­›é€‰æ¡ä»¶
(waybill_array IS NULL OR v.auto_number = ANY(waybill_array) OR 
 EXISTS (SELECT 1 FROM unnest(waybill_array) AS wb WHERE v.auto_number ILIKE '%' || wb || '%')) AND
(driver_array IS NULL OR v.driver_name = ANY(driver_array) OR 
 EXISTS (SELECT 1 FROM unnest(driver_array) AS dr WHERE v.driver_name ILIKE '%' || dr || '%')) AND
(license_array IS NULL OR v.license_plate = ANY(license_array) OR 
 EXISTS (SELECT 1 FROM unnest(license_array) AS lp WHERE v.license_plate ILIKE '%' || lp || '%')) AND
(phone_array IS NULL OR v.driver_phone = ANY(phone_array) OR 
 EXISTS (SELECT 1 FROM unnest(phone_array) AS ph WHERE v.driver_phone ILIKE '%' || ph || '%')) AND
(receivable_array IS NULL OR 
 EXISTS (SELECT 1 FROM unnest(receivable_array) AS rc WHERE v.current_cost::text ILIKE '%' || rc || '%'))
```

### 3. å‰ç«¯ä»£ç ä¼˜åŒ–

**RPCè°ƒç”¨å‚æ•°**:
```typescript
const { data, error } = await supabase.rpc('get_invoice_request_data', {
  p_project_id: activeFilters.projectId === 'all' ? null : activeFilters.projectId,
  p_start_date: activeFilters.startDate || null,
  p_end_date: activeFilters.endDate || null,
  p_partner_id: activeFilters.partnerId === 'all' ? null : activeFilters.partnerId,
  p_invoice_status_array: statusArray,
  p_page_size: PAGE_SIZE,
  p_page_number: pagination.currentPage,
  // æ–°å¢é«˜çº§ç­›é€‰å‚æ•°
  p_waybill_numbers: activeFilters.waybillNumbers || null,
  p_driver_name: activeFilters.driverName || null,
  p_license_plate: activeFilters.licensePlate || null,
  p_driver_phone: activeFilters.driverPhone || null,
  p_driver_receivable: activeFilters.driverReceivable || null,
});
```

**ç§»é™¤å®¢æˆ·ç«¯ç­›é€‰é€»è¾‘**:
- åˆ é™¤äº†å¤æ‚çš„å®¢æˆ·ç«¯ç­›é€‰ä»£ç 
- ç®€åŒ–äº†æ•°æ®å¤„ç†é€»è¾‘
- æ¢å¤äº†æ­£å¸¸çš„åˆ†é¡µå¤„ç†

## ğŸ”§ æŠ€æœ¯ä¼˜åŠ¿

### æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®åº“å±‚é¢ç­›é€‰**: åœ¨æ•°æ®åº“å±‚é¢è¿›è¡Œç­›é€‰ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
2. **ç´¢å¼•åˆ©ç”¨**: æ•°æ®åº“ç´¢å¼•å¯ä»¥åŠ é€Ÿç­›é€‰æŸ¥è¯¢
3. **å†…å­˜ä¼˜åŒ–**: ä¸éœ€è¦åœ¨å‰ç«¯åŠ è½½å¤§é‡æ•°æ®è¿›è¡Œç­›é€‰
4. **åˆ†é¡µä¼˜åŒ–**: åç«¯ç›´æ¥è¿”å›åˆ†é¡µç»“æœ

### åŠŸèƒ½å¢å¼º

1. **ç²¾ç¡®åŒ¹é…**: æ”¯æŒç²¾ç¡®åŒ¹é…å’Œæ¨¡ç³ŠåŒ¹é…
2. **å¤šå€¼ç­›é€‰**: æ”¯æŒé€—å·åˆ†éš”çš„å¤šä¸ªå€¼ç­›é€‰
3. **ç©ºå€¼å¤„ç†**: è‡ªåŠ¨è¿‡æ»¤ç©ºå€¼å’Œç©ºç™½å­—ç¬¦
4. **ç±»å‹å®‰å…¨**: åç«¯å‚æ•°ç±»å‹æ£€æŸ¥

### ç”¨æˆ·ä½“éªŒ

1. **å“åº”é€Ÿåº¦**: åç«¯ç­›é€‰æ¯”å®¢æˆ·ç«¯ç­›é€‰æ›´å¿«
2. **æ•°æ®å‡†ç¡®æ€§**: æ•°æ®åº“ç­›é€‰ç»“æœæ›´å‡†ç¡®
3. **å†…å­˜ä½¿ç”¨**: å‡å°‘å‰ç«¯å†…å­˜å ç”¨
4. **ç½‘ç»œä¼ è¾“**: å‡å°‘ä¸å¿…è¦çš„æ•°æ®ä¼ è¾“

## ğŸ“‹ ä¿®æ”¹æ¸…å•

### åç«¯ä¿®æ”¹
- [x] åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶
- [x] æ‰©å±•`get_invoice_request_data`å‡½æ•°å‚æ•°
- [x] å®ç°é«˜çº§ç­›é€‰é€»è¾‘
- [x] æ·»åŠ å‚æ•°è§£æå’ŒéªŒè¯
- [x] æ›´æ–°å‡½æ•°æ³¨é‡Š

### å‰ç«¯ä¿®æ”¹
- [x] æ›´æ–°RPCè°ƒç”¨å‚æ•°
- [x] ç§»é™¤å®¢æˆ·ç«¯ç­›é€‰é€»è¾‘
- [x] æ¢å¤æ­£å¸¸åˆ†é¡µå¤„ç†
- [x] æ›´æ–°å…¨é€‰æ¨¡å¼é€»è¾‘
- [x] éªŒè¯è¯­æ³•æ­£ç¡®æ€§

## ğŸ¯ ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä¼˜åŒ–å‰ï¼ˆå®¢æˆ·ç«¯ç­›é€‰ï¼‰
- âŒ éœ€è¦è·å–å¤§é‡æ•°æ®ï¼ˆ1000æ¡ï¼‰
- âŒ å‰ç«¯å†…å­˜å ç”¨é«˜
- âŒ ç½‘ç»œä¼ è¾“é‡å¤§
- âŒ ç­›é€‰æ€§èƒ½å·®
- âŒ åˆ†é¡µé€»è¾‘å¤æ‚

### ä¼˜åŒ–åï¼ˆåç«¯ç­›é€‰ï¼‰
- âœ… åªè·å–éœ€è¦çš„æ•°æ®
- âœ… å‰ç«¯å†…å­˜å ç”¨ä½
- âœ… ç½‘ç»œä¼ è¾“é‡å°
- âœ… ç­›é€‰æ€§èƒ½å¥½
- âœ… åˆ†é¡µé€»è¾‘ç®€å•

## ğŸš€ éƒ¨ç½²è¯´æ˜

### æ•°æ®åº“è¿ç§»
```bash
# åº”ç”¨æ–°çš„è¿ç§»æ–‡ä»¶
supabase db push
```

### å‰ç«¯éƒ¨ç½²
- å‰ç«¯ä»£ç å·²æ›´æ–°ï¼Œæ— éœ€é¢å¤–é…ç½®
- å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**: éœ€è¦åº”ç”¨æ–°çš„è¿ç§»æ–‡ä»¶
2. **å‘åå…¼å®¹**: æ–°å‚æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œä¸å½±å“ç°æœ‰è°ƒç”¨
3. **æ€§èƒ½ç›‘æ§**: å»ºè®®ç›‘æ§ç­›é€‰æŸ¥è¯¢çš„æ€§èƒ½
4. **ç´¢å¼•ä¼˜åŒ–**: å¦‚æœç­›é€‰æ€§èƒ½ä¸ä½³ï¼Œå¯ä»¥è€ƒè™‘æ·»åŠ ç´¢å¼•

## ğŸ” æµ‹è¯•å»ºè®®

1. **åŸºæœ¬ç­›é€‰**: æµ‹è¯•é¡¹ç›®ã€æ—¥æœŸã€çŠ¶æ€ç­›é€‰
2. **é«˜çº§ç­›é€‰**: æµ‹è¯•è¿å•ç¼–å·ã€å¸æœºã€è½¦ç‰Œå·ã€ç”µè¯ã€åº”æ”¶ç­›é€‰
3. **ç»„åˆç­›é€‰**: æµ‹è¯•åŸºæœ¬ç­›é€‰å’Œé«˜çº§ç­›é€‰çš„ç»„åˆ
4. **åˆ†é¡µåŠŸèƒ½**: æµ‹è¯•ç­›é€‰åçš„åˆ†é¡µåŠŸèƒ½
5. **å…¨é€‰æ¨¡å¼**: æµ‹è¯•å…¨é€‰æ¨¡å¼ä¸‹çš„ç­›é€‰åŠŸèƒ½

---

**ä¼˜åŒ–æ—¶é—´**: 2025-01-16  
**ä¼˜åŒ–çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: â³ å¾…æµ‹è¯•  
**éƒ¨ç½²çŠ¶æ€**: â³ å¾…éƒ¨ç½²
