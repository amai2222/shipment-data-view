# 开票审核页面函数检查报告

## 🔍 检查结果

### ✅ 已存在的函数

#### 1. `get_invoice_requests_filtered`
**位置**：`supabase/migrations/20250126_create_invoice_requests_filtered_function.sql`

**参数匹配度检查**：

| 参数 | InvoiceAudit调用 | 函数定义 | 状态 |
|------|----------------|---------|------|
| p_request_number | ✅ 使用 | ✅ 支持 | ✅ 匹配 |
| p_waybill_number | ✅ 使用 | ✅ 支持 | ✅ 匹配 |
| p_driver_name | ✅ 使用 | ✅ 支持 | ✅ 匹配 |
| p_loading_date | ✅ 使用 | ✅ 支持 | ✅ 匹配 |
| p_status | ✅ 使用 | ✅ 支持 | ✅ 匹配 |
| p_project_id | ✅ 使用 | ✅ 支持 | ✅ 匹配 |
| p_license_plate | ❌ 未使用 | ✅ 支持 | ⚠️ 需添加 |
| p_phone_number | ❌ 未使用 | ✅ 支持 | ⚠️ 需添加 |
| p_platform_name | ❌ 未使用 | ✅ 支持 | ⚠️ 需添加 |
| p_limit | ✅ 使用 | ✅ 支持 | ✅ 匹配 |
| p_offset | ✅ 使用 | ✅ 支持 | ✅ 匹配 |

**结论**：✅ 函数已存在，但前端没有使用全部参数

---

### ❌ 缺少的函数

#### 2. 批量审批函数（可选）
**当前实现**：前端直接UPDATE数据库
```typescript
await supabase
  .from('invoice_requests')
  .update({ status: 'Processing' })
  .in('request_number', selectedRequestNumbers);
```

**建议**：✅ 当前实现已足够，不需要专门的RPC函数

#### 3. 取消审批函数（可选）
**当前实现**：前端直接UPDATE数据库
```typescript
await supabase
  .from('invoice_requests')
  .update({ status: 'Pending' })
  .eq('request_number', requestNumber);
```

**建议**：✅ 当前实现已足够，不需要专门的RPC函数

#### 4. 批量作废函数（可选）
**当前实现**：前端直接UPDATE数据库
```typescript
await supabase
  .from('invoice_requests')
  .update({ status: 'Rejected' })
  .in('request_number', idsToCancel);
```

**建议**：✅ 当前实现已足够，不需要专门的RPC函数

---

## 🔧 需要修改的地方

### 修改1：添加缺失的筛选参数到前端

当前 `InvoiceAudit.tsx` 没有传递这些参数：
- `p_license_plate`
- `p_phone_number`
- `p_platform_name`

但是这些参数在 filters 中已经定义了！只需要在RPC调用时传递即可。

**需要修改的代码**：

```typescript
// 当前（第104-113行）
const { data, error } = await supabase.rpc('get_invoice_requests_filtered', {
  p_request_number: filters.requestNumber || null,
  p_waybill_number: filters.waybillNumber || null,
  p_driver_name: filters.driverName || null,
  p_loading_date: filters.loadingDate ? format(filters.loadingDate, 'yyyy-MM-dd') : null,
  p_status: filters.status || null,
  p_project_id: filters.projectId || null,
  p_limit: pageSize,
  p_offset: (currentPage - 1) * pageSize
});

// 应该改为
const { data, error } = await supabase.rpc('get_invoice_requests_filtered', {
  p_request_number: filters.requestNumber || null,
  p_waybill_number: filters.waybillNumber || null,
  p_driver_name: filters.driverName || null,
  p_loading_date: filters.loadingDate ? format(filters.loadingDate, 'yyyy-MM-dd') : null,
  p_status: filters.status || null,
  p_project_id: filters.projectId || null,
  p_license_plate: filters.licensePlate || null,      // ✅ 添加
  p_phone_number: filters.phoneNumber || null,        // ✅ 添加
  p_platform_name: filters.platformName || null,      // ✅ 添加
  p_limit: pageSize,
  p_offset: (currentPage - 1) * pageSize
});
```

### 修改2：修复详情查询逻辑

当前详情查询的问题：
```typescript
// 问题：logistics_record_ids 在主列表中是空数组
logistics_record_ids: [], // 需要从详情中获取
```

**两种解决方案**：

**方案A（推荐）**：在 `get_invoice_requests_filtered` 函数中返回 logistics_record_ids

**方案B**：在点击详情时，先查询 invoice_request_details 获取运单IDs

---

## 📋 修改建议

### 优先级1：必须修改（否则高级筛选不work）

修改 `src/pages/InvoiceAudit.tsx` 第104-113行：

```typescript
const { data, error } = await supabase.rpc('get_invoice_requests_filtered', {
  p_request_number: filters.requestNumber || null,
  p_waybill_number: filters.waybillNumber || null,
  p_driver_name: filters.driverName || null,
  p_loading_date: filters.loadingDate ? format(filters.loadingDate, 'yyyy-MM-dd') : null,
  p_status: filters.status || null,
  p_project_id: filters.projectId || null,
  p_license_plate: filters.licensePlate || null,      // ✅ 添加
  p_phone_number: filters.phoneNumber || null,        // ✅ 添加
  p_platform_name: filters.platformName || null,      // ✅ 添加
  p_limit: pageSize,
  p_offset: (currentPage - 1) * pageSize
});
```

### 优先级2：可选优化（详情功能完善）

修改 `get_invoice_requests_filtered` 函数，返回 logistics_record_ids：

```sql
-- 在 SELECT 中添加
(
  SELECT array_agg(ird.logistics_record_id)
  FROM invoice_request_details ird
  WHERE ird.invoice_request_id = ir.id
) as logistics_record_ids
```

或者在前端查询详情时，先获取运单IDs：

```typescript
// 在 handleViewDetails 中
const { data: detailsData } = await supabase
  .from('invoice_request_details')
  .select('logistics_record_id')
  .eq('invoice_request_id', request.id);

const recordIds = detailsData.map(d => d.logistics_record_id);
// 然后使用这些IDs查询详情
```

---

## 🎯 总结

### 数据库函数
- ✅ `get_invoice_requests_filtered` - 已存在，完全可用
- ✅ 表结构 - 完整，支持所有功能
- ❌ 不需要创建新的RPC函数

### 前端代码
- ⚠️ 需要修改：添加3个缺失的筛选参数
- ⚠️ 可选优化：改进详情查询逻辑

### 立即可用程度
- ✅ 基础功能：100%可用（列表、基础筛选、审批）
- ⚠️ 高级筛选：60%可用（车牌号、电话、平台筛选暂不work）
- ✅ 批量操作：100%可用
- ✅ 详情查看：90%可用（可以查看，但金额汇总简化）

---

## 📝 推荐行动

### 方案A：立即使用（不修改）
**优点**：立即可用，基础功能完整  
**缺点**：车牌号、电话、平台筛选不生效

### 方案B：修改前端（推荐）⭐
**优点**：高级筛选完全可用  
**缺点**：需要修改1处代码

### 方案C：全面优化
**优点**：功能最完善  
**缺点**：需要修改数据库函数和前端代码

---

## ✨ 我的建议

**立即执行修改B**：只需修改前端1处代码，添加3个参数，就能让高级筛选完全可用。

需要我帮你修改吗？

