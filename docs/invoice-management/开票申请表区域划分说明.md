# 开票申请表区域划分说明

## 完整区域划分图

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                    【打印按钮】（右上角）                  ┃
┃                                                            ┃
┃ ═══════════════════════════════════════════════════════ ┃
┃                      【1. 标题区】                         ┃
┃ ═══════════════════════════════════════════════════════ ┃
┃          中科智运（云南）供应链科技有限公司开票申请表      ┃
┃                                                            ┃
┃ 货主单位：厦门本质盼盼食品有限公司                        ┃
┃ 申请时间：2025-10-21                                       ┃
┃ 申请编号：3002025102109382098978019641112                 ┃
┃                                                            ┃
┃ ═══════════════════════════════════════════════════════ ┃
┃                      【2. 表头区】                         ┃
┃ ═══════════════════════════════════════════════════════ ┃
┃ ┌────┬──────────┬───────────┬──────┬──────────┬────────┬────────┬──────────┐
┃ │序号│ 申请日期 │  开票抬头  │ 货物 │ 业务期限 │ 目的地 │ 运单数 │ 开票金额 │
┃ └────┴──────────┴───────────┴──────┴──────────┴────────┴────────┴──────────┘
┃                                                            ┃
┃ ═══════════════════════════════════════════════════════ ┃
┃                      【3. 数据区】                         ┃
┃ ═══════════════════════════════════════════════════════ ┃
┃ ┌────┬──────────┬───────────────────┬──────┬──────────┬──────────┬────┬─────────┐
┃ │ 1  │2025-10-21│厦门本质盼盼食品   │ 食品 │2025年08月│福建省... │ 2  │  ¥500   │
┃ ├────┴──────────┴───────────────────┴──────┴──────────┴──────────┴────┼─────────┤
┃ │ 备注：李伟力中科物流2025年8月配送至福建省.泉州市.洛江区，共计25.50吨 │ 合计：  │
┃ ├───────────────────────────────────────────────────────────────────┼─────────┤
┃ │                                                       运单数：2     │  ¥500   │
┃ └───────────────────────────────────────────────────────────────────┴─────────┘
┃                                                            ┃
┃ ═══════════════════════════════════════════════════════ ┃
┃                      【4. 签字区】                         ┃
┃ ═══════════════════════════════════════════════════════ ┃
┃                                                            ┃
┃ 事项说明：                                                ┃
┃ ┌────────────────────────────────────────────────────┐ ┃
┃ │ [这里显示 request.remarks 的内容]                   │ ┃
┃ │                                                      │ ┃
┃ └────────────────────────────────────────────────────┘ ┃
┃                                                            ┃
┃  ___________      ___________      ___________      ___________  ┃
┃  信息部专员      业务部审核          客户          财务部审核  ┃
┃    签字：          签字：          签字：            签字：    ┃
┃                                                            ┃
┃ 以上相关内容经本人(申请人)与客户充分沟通，并保证所提供  ┃
┃ 相关资料的准确与完整，如因资料不符或约定不清等原因造成  ┃
┃ 退票，其责任损失将由开票申请人负责。                    ┃
┃                                                            ┃
┃ ┌─ 发票信息 ────────────────────────────────────┐    ┃
┃ │ 发票号码：_____________  领票日期：_____________  │    ┃
┃ │ 领票人：_______________  发票开具情况：_________  │    ┃
┃ └────────────────────────────────────────────────┘    ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

---

## 1️⃣ 标题区 (Header Section)

### 代码位置
**行数**: 第953-970行

### HTML结构
```html
<div class="header">
  <div class="company-name">中科智运（云南）供应链科技有限公司开票申请表</div>
</div>

<div class="info-row">
  <div class="info-item">
    <span class="info-label">货主单位：</span>
    <span>厦门本质盼盼食品有限公司</span>
  </div>
  <div class="info-item">
    <span class="info-label">申请时间：</span>
    <span>2025-10-21</span>
  </div>
  <div class="info-item">
    <span class="info-label">申请编号：</span>
    <span>3002025102109382098978019641112</span>
  </div>
</div>
```

### 包含内容
| 元素 | 数据来源 | 格式 | 说明 |
|------|----------|------|------|
| **公司名称** | 固定文本 | 18px加粗 | 中科智运（云南）供应链科技有限公司开票申请表 |
| **货主单位** | `request.partner_full_name` 或 `partner_name` | 14px | 开票对象的全称 |
| **申请时间** | `request.created_at` | yyyy-MM-dd | 申请单创建日期 |
| **申请编号** | `request.request_number` | 14px | 系统自动生成的唯一编号 |

### 样式特点
- 居中显示
- 公司名称最大最醒目
- 三个信息项横排显示（flexbox布局）
- 标签加粗，数据正常字重

---

## 2️⃣ 表头区 (Table Header)

### 代码位置
**行数**: 第1038-1049行

### HTML结构
```html
<table>
  <thead>
    <tr>
      <th style="width: 40px;">序号</th>
      <th style="width: 100px;">申请日期</th>
      <th>开票抬头</th>
      <th style="width: 80px;">货物</th>
      <th style="width: 100px;">业务期限</th>
      <th>目的地</th>
      <th style="width: 60px;">运单数</th>
      <th style="width: 120px;">开票金额</th>
    </tr>
  </thead>
</table>
```

### 列定义详情

| 序号 | 列名 | 宽度 | 对齐方式 | 说明 |
|------|------|------|----------|------|
| 1 | **序号** | 40px | 居中 | 固定序号，从1开始 |
| 2 | **申请日期** | 100px | 居中 | yyyy-MM-dd格式 |
| 3 | **开票抬头** | 自适应 | 居中 | 接受发票的公司名称 |
| 4 | **货物** | 80px | 居中 | 货物类型（如：食品） |
| 5 | **业务期限** | 100px | 居中 | yyyy年MM月格式 |
| 6 | **目的地** | 自适应 | 居中 | 卸货地点 |
| 7 | **运单数** | 60px | 居中 | 该行包含的运单数量 |
| 8 | **开票金额** | 120px | 居中 | 开票总金额 |

### 样式特点
- 黑色实线边框（1px）
- 表头背景色：#f0f0f0（浅灰色）
- 表头文字加粗
- 内边距：8px
- 文字大小：12px

---

## 3️⃣ 数据区 (Table Body - Data Rows)

### 代码位置
**行数**: 第1051-1078行

### HTML结构
```html
<tbody>
  <!-- 第一行：主数据 -->
  <tr>
    <td>1</td>
    <td>2025-10-21</td>
    <td class="text-left">厦门本质盼盼食品有限公司</td>
    <td>食品</td>
    <td>2025年08月</td>
    <td class="text-left">福建省.泉州市.洛江区</td>
    <td>2</td>
    <td class="text-right">¥500</td>
  </tr>
  
  <!-- 第二行：备注和合计标签 -->
  <tr>
    <td colspan="7" class="text-left" style="padding-left: 20px;">
      <strong>备注：李伟力中科物流2025年8月配送至福建省.泉州市.洛江区，共计25.50吨</strong>
    </td>
    <td class="text-right">
      <strong>合计：</strong>
    </td>
  </tr>
  
  <!-- 第三行：运单数和总金额 -->
  <tr>
    <td colspan="7" class="text-right" style="padding-right: 20px;">
      <strong>运单数：2</strong>
    </td>
    <td class="text-right">
      <strong>¥500</strong>
    </td>
  </tr>
</tbody>
```

### 三行数据详解

#### 第一行：主数据行
| 单元格 | 数据来源 | 对齐 | 说明 |
|--------|----------|------|------|
| 序号 | 固定`1` | 居中 | 当前版本简化为单行 |
| 申请日期 | `request.created_at` | 居中 | yyyy-MM-dd |
| 开票抬头 | `request.partner_full_name` | **左对齐** | 公司全称 |
| 货物 | 固定`"食品"` | 居中 | 可改为动态 |
| 业务期限 | `request.created_at` | 居中 | yyyy年MM月 |
| 目的地 | `details[0].unloading_location` | **左对齐** | 第一条运单目的地 |
| 运单数 | `request.record_count` | 居中 | 总运单数 |
| 开票金额 | `request.total_amount` | **右对齐** | 带千分位 |

#### 第二行：备注和合计标签行
| 单元格 | 内容 | 对齐 | 说明 |
|--------|------|------|------|
| 列1-7（合并） | **备注：[AI动态总结]** | **左对齐** | 智能生成的业务描述 |
| 列8 | **合计：** | **右对齐** | 合计标签 |

**AI动态总结格式**:
```
备注：[司机][项目][日期范围][配送信息]，共计[重量]吨

实例：
备注：李伟力中科物流2025年8月配送至福建省.泉州市.洛江区，共计25.50吨
```

#### 第三行：汇总数据行
| 单元格 | 内容 | 对齐 | 说明 |
|--------|------|------|------|
| 列1-7（合并） | **运单数：2** | **右对齐** | 总运单数量 |
| 列8 | **¥500** | **右对齐** | 总金额（加粗） |

---

## 4️⃣ 签字区 (Signature Section)

### 代码位置
**行数**: 第1080-1124行

### 完整结构

```
┌────────────────────────────────────────────────────┐
│ 【4.1 事项说明】                                    │
├────────────────────────────────────────────────────┤
│ 事项说明：                                          │
│ ┌────────────────────────────────────────────────┐ │
│ │ [申请单备注内容 - request.remarks]              │ │
│ │ 最小高度：80px                                  │ │
│ └────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────┐
│ 【4.2 四个签字栏】（横排Grid布局）                  │
├────────────────────────────────────────────────────┤
│  ____________   ____________   ____________   ____________  │
│  信息部专员     业务部审核         客户       财务部审核  │
│    签字：         签字：         签字：         签字：    │
└────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────┐
│ 【4.3 免责声明】                                    │
├────────────────────────────────────────────────────┤
│ 以上相关内容经本人(申请人)与客户充分沟通，并保证    │
│ 所提供相关资料的准确与完整，如因资料不符或约定不清  │
│ 等原因造成退票，其责任损失将由开票申请人负责。      │
└────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────┐
│ 【4.4 发票信息】                                    │
├────────────────────────────────────────────────────┤
│ ┌──────────────┬───────────┬──────────────┬───────────┐
│ │ 发票号码：   │ _________ │ 领票日期：   │ _________ │
│ ├──────────────┼───────────┼──────────────┼───────────┤
│ │ 领票人：     │ _________ │ 发票开具情况：│ _________ │
│ └──────────────┴───────────┴──────────────┴───────────┘
└────────────────────────────────────────────────────┘
```

### 4.1 事项说明（第1080-1088行）
```html
<div class="remarks">
  <div><strong>事项说明：</strong></div>
  <div class="remarks-content">
    ${request.remarks || ''}
  </div>
</div>
```

**数据来源**: `request.remarks`（申请单的备注字段）  
**样式**: 边框框起来，最小高度80px，内边距10px

### 4.2 四个签字栏（第1090-1107行）
```html
<div class="signatures">
  <div class="signature-item">
    <div class="signature-line"></div>
    <div>信息部专员签字：</div>
  </div>
  <div class="signature-item">
    <div class="signature-line"></div>
    <div>业务部审核签字：</div>
  </div>
  <div class="signature-item">
    <div class="signature-line"></div>
    <div>客户签字：</div>
  </div>
  <div class="signature-item">
    <div class="signature-line"></div>
    <div>财务部审核签字：</div>
  </div>
</div>
```

**布局**: Grid布局，4列，间距20px  
**签字线**: 黑色下划线，高度50px  
**对齐**: 每个签字栏居中

### 4.3 免责声明（第1109-1111行）
```html
<div class="disclaimer">
  以上相关内容经本人(申请人)与客户充分沟通，并保证所提供相关资料的准确与完整，
  如因资料不符或约定不清等原因造成退票，其责任损失将由开票申请人负责。
</div>
```

**样式**: 11px字体，行高1.8，上边距20px

### 4.4 发票信息（第1113-1124行）
```html
<div class="invoice-info">
  <div class="invoice-info-row">
    <div class="invoice-info-label">发票号码：</div>
    <div class="invoice-info-value">[已开票则显示发票号]</div>
    <div class="invoice-info-label">领票日期：</div>
    <div class="invoice-info-value"></div>
  </div>
  <div class="invoice-info-row">
    <div class="invoice-info-label">领票人：</div>
    <div class="invoice-info-value"></div>
    <div class="invoice-info-label">发票开具情况：</div>
    <div class="invoice-info-value"></div>
  </div>
</div>
```

**数据来源**: `request.invoice_number`（如果已开票）  
**样式**: 边框框起来，flexbox布局，填写线用下划线

---

## 完整区域对照表

| 区域 | 代码行 | 主要元素 | 数据类型 | 是否可编辑 |
|------|--------|----------|----------|-----------|
| **1. 标题区** | 953-970 | 公司名、货主、时间、编号 | 基础信息 | ❌ 自动填充 |
| **2. 表头区** | 1038-1049 | 8个表头列 | 固定列名 | ❌ 固定不变 |
| **3. 数据区** | 1051-1078 | 3行数据（主数据+备注+汇总） | 运单数据 | ❌ 自动计算 |
| **3.1** 主数据行 | 1051-1061 | 8个数据单元格 | 运单统计 | ❌ 自动填充 |
| **3.2** 备注行 | 1062-1069 | AI动态总结 + 合计标签 | **智能生成** | ✅ 动态 |
| **3.3** 汇总行 | 1070-1077 | 运单数 + 总金额 | 统计数据 | ❌ 自动计算 |
| **4. 签字区** | 1080-1124 | 说明+签字+声明+发票 | 手工填写 | ✅ 可填写 |
| **4.1** 事项说明 | 1080-1088 | 备注输入框 | 文本内容 | ✅ 可编辑 |
| **4.2** 签字栏 | 1090-1107 | 4个签字位 | 手写签名 | ✅ 打印后签 |
| **4.3** 免责声明 | 1109-1111 | 标准条款 | 固定文本 | ❌ 固定不变 |
| **4.4** 发票信息 | 1113-1124 | 发票号等信息 | 开票后填写 | ✅ 手工填写 |

---

## 关键区域说明

### 🎯 数据区第二行（备注行）- 核心改进

**这是本次的重点修改！**

#### 修改前
```html
<strong>备注：李伟力中科物流7-8月京超配送：500吨</strong>
```
❌ 固定文本，所有申请单都一样

#### 修改后
```html
<strong>备注：${dynamicSummary}</strong>
```
✅ AI动态生成，每个申请单根据实际数据生成不同的总结

#### 动态总结示例

**场景A**（单一项目）:
```
备注：李伟力中科物流2025年8月配送至福建省.泉州市.洛江区，共计25.50吨
```

**场景B**（多项目）:
```
备注：张三等3个项目2025年7月-8月配送至北京市.朝阳区等5个地点，共计150.00吨
```

**场景C**（跨年）:
```
备注：王师傅京超配送2024年12月-2025年1月配送至上海市.浦东新区，共计80.30吨
```

---

## 打印效果

### A4纸张布局

```
┌─────────────────────────────────────────┐
│ [上边距 1cm]                             │
│ ┌─────────────────────────────────────┐ │
│ │  标题区（公司名+基本信息）           │ │ ← 约3cm
│ ├─────────────────────────────────────┤ │
│ │  表头区（8列）                       │ │ ← 约1cm
│ ├─────────────────────────────────────┤ │
│ │  数据区（3行）                       │ │ ← 约3cm
│ │  - 主数据行                          │ │
│ │  - 备注行（AI动态）                  │ │
│ │  - 汇总行                            │ │
│ ├─────────────────────────────────────┤ │
│ │  签字区                              │ │ ← 约15cm
│ │  - 事项说明（2cm）                   │ │
│ │  - 签字栏（4个，3cm）                │ │
│ │  - 免责声明（2cm）                   │ │
│ │  - 发票信息（2cm）                   │ │
│ └─────────────────────────────────────┘ │
│ [下边距 1cm]                             │
└─────────────────────────────────────────┘
  ← A4纸张 (21cm × 29.7cm) →
```

---

## 与图2的对比

### 相同点 ✅
- ✅ 公司名称和标题格式
- ✅ 三项基本信息（货主、时间、编号）
- ✅ 8列表头结构
- ✅ 3行数据区布局
- ✅ 4个签字栏
- ✅ 免责声明
- ✅ 发票信息区

### 改进点 🌟
- 🌟 **备注自动生成**（不再是固定文本）
- 🌟 智能识别司机、项目、日期
- 🌟 自动计算总重量
- 🌟 自动适应单/多项目场景
- 🌟 自动处理日期范围（同月/跨月）

---

## 使用流程

1. **点击按钮** → 操作列的蓝色"查看申请单"按钮
2. **系统查询** → 获取申请单详情和运单数据
3. **AI分析** → 自动提取关键信息
4. **生成总结** → 智能拼接备注描述
5. **打开窗口** → 显示完整的申请表
6. **打印** → 点击"打印申请表"按钮

---

## 技术要点

### 数据提取
```typescript
const projectNames = [...new Set(details.map(d => d.project_name).filter(Boolean))];
```
- 去重：使用 `Set`
- 过滤：移除空值
- 转换：转为数组

### 日期处理
```typescript
const dates = details.map(d => d.loading_date).filter(Boolean).sort();
const startDate = new Date(dates[0]);
const endDate = new Date(dates[dates.length - 1]);
```
- 排序：时间顺序
- 取首尾：最早和最晚

### 格式化
```typescript
format(startDate, 'yyyy年M月')  // 2025年8月
totalWeight.toFixed(2)           // 25.50
total_amount.toLocaleString()    // 50,000
```

---

**文档更新**: 2025-10-27  
**功能状态**: ✅ 已完成并测试

