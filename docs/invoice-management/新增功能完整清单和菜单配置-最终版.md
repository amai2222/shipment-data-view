# 新增功能完整清单和菜单配置（最终版）

## 📅 创建日期
2025-11-14

## ✅ 已完成的工作

### 1. 新增页面清单

#### ✅ 货主余额管理页面

| 项目 | 内容 | 状态 |
|------|------|------|
| **页面名称** | 货主余额管理 | ✅ 已完成 |
| **文件路径** | `src/pages/PartnerBalance.tsx` | ✅ |
| **路由路径** | `/partner-balance` | ✅ |
| **移动端路由** | `/m/partner-balance` | ✅ |
| **权限要求** | `finance.partner_balance` | ✅ |
| **PC端菜单** | ✅ 已添加到财务管理分组 |
| **移动端菜单** | ✅ 已添加到财务管理分组 |
| **权限配置** | ✅ 已添加到新版本和旧版本 |
| **路由配置** | ✅ 已配置PC端和移动端 |

**功能特性**：
- 显示货主账号余额
- 显示余额流水记录（充值、扣款、运单应付等）
- 手动充值功能
- 费用扣款功能（服务费、逾期费等）
- 按日期范围筛选流水

---

#### ✅ 收款报表页面

| 项目 | 内容 | 状态 |
|------|------|------|
| **页面名称** | 收款报表 | ✅ 已完成 |
| **文件路径** | `src/pages/ReceiptReport.tsx` | ✅ |
| **路由路径** | `/finance/receipt-report` | ✅ |
| **权限要求** | `finance.payment_invoice` | ✅ |
| **PC端菜单** | ✅ 已添加到财务管理分组 |
| **移动端菜单** | ✅ 已添加到财务管理分组 |
| **权限配置** | ✅ 已添加到新版本和旧版本 |
| **路由配置** | ✅ 已配置 |

**功能特性**：
- 收款统计卡片（6个统计指标）
- 筛选功能（日期范围、货主、状态）
- 明细表格（支持分页）
- 逾期分析

---

#### ✅ 财务收款页面（增强版）

| 项目 | 内容 | 状态 |
|------|------|------|
| **页面名称** | 付款与开票（财务收款） | ✅ 已完成 |
| **文件路径** | `src/pages/PaymentInvoice.tsx` | ✅ |
| **路由路径** | `/finance/payment-invoice` | ✅ |
| **权限要求** | `finance.payment_invoice` | ✅ |
| **菜单配置** | ✅ 已存在 |

**新增功能**：
- ✅ 收款功能（支持部分收款）
- ✅ 退款功能
- ✅ 对账功能
- ✅ 收款记录查看
- ✅ 收款金额校验
- ✅ 收款凭证上传（多图）

---

### 2. 新增功能清单

#### ✅ 货主账号余额系统

**数据库表**：
- `partner_balance` - 货主余额表
- `partner_balance_transactions` - 余额流水表

**RPC函数**：
- `get_partner_balance` - 查询货主余额
- `get_partner_balance_transactions` - 查询余额流水
- `update_partner_balance` - 更新余额（内部函数）
- `manual_recharge_partner_balance` - 手动充值
- `deduct_service_fee` - 扣减服务费
- `deduct_overdue_fee` - 扣减逾期费
- `deduct_partner_fee` - 扣减其他费用

**自动化**：
- 触发器：`trigger_deduct_balance_on_cost_insert` - 运单成本插入时自动扣减
- 触发器：`trigger_recalculate_balance_on_cost_update` - 运单成本更新时重新计算

**前端页面**：
- `src/pages/PartnerBalance.tsx` - 货主余额管理页面

**集成点**：
- `src/pages/Partners.tsx` - 在"货主"标签页显示余额，提供"余额"按钮跳转

---

#### ✅ 财务收款功能增强

**数据库扩展**：
- `invoice_requests` 表新增字段（支持部分收款、对账、提醒）
- `invoice_receipt_records` 表 - 收款记录表（支持多次收款）
- `logistics_records` 表新增字段：`receipt_status` - 收款状态（独立于开票状态）

**RPC函数（_1114版本）**：
- `receive_invoice_payment_1114` - 登记收款（支持部分收款）
- `refund_invoice_receipt_1114` - 处理退款
- `reconcile_invoice_receipt_1114` - 对账
- `send_receipt_reminders_1114` - 发送收款提醒 ✅ **已集成到通知系统**
- `get_receipt_statistics_1114` - 获取收款统计
- `get_receipt_details_report_1114` - 获取收款明细报表
- `get_receipt_records_1114` - 查询收款记录

**前端页面**：
- `src/pages/PaymentInvoice.tsx` - 财务收款页面（增强版）
- `src/pages/ReceiptReport.tsx` - 收款报表页面

---

### 3. 收款提醒功能 ✅ **已集成到通知系统**

**实现方式**：
- 后端函数：`send_receipt_reminders_1114` 
  - 更新数据库字段（`reminder_count`、`last_reminder_at`、`overdue_days`）
  - ✅ **创建通知记录**：在 `notifications` 表中为财务人员创建通知

**通知内容**：
- 通知类型：`warning`（逾期）或 `info`（即将到期）
- 通知分类：`finance`
- 通知标题：包含申请单号
- 通知消息：包含逾期天数/到期天数、未收款金额
- 通知链接：跳转到收款页面
- 关联ID：申请单ID

**通知接收人**：
- 角色为 `admin` 或 `finance` 的用户
- 或拥有 `finance.payment_invoice` 权限的用户

**通知显示**：
- 移动端：`src/pages/mobile/MobileNotifications.tsx` - 通知中心
- 使用 `get_user_notifications` RPC 函数获取通知

---

## 📋 菜单配置完成清单

### ✅ PC端菜单（`src/components/AppSidebar.tsx`）

财务管理分组已包含：
- 运费对账
- 付款与开票
- 财务开票
- 财务付款
- 收款报表 ✅
- 货主余额 ✅

### ✅ 移动端菜单（`src/components/mobile/MobileLayout.tsx`）

财务管理分组已包含：
- 运费对账
- 付款与开票
- 财务开票
- 财务付款
- 收款报表 ✅
- 货主余额 ✅

### ✅ 权限配置（`src/config/permissionsNew.ts`）

财务管理分组已包含：
- `finance.reconciliation` - 运费对账
- `finance.payment_invoice` - 付款与开票
- `finance.invoice_request_management` - 开票申请单管理
- `finance.payment_requests` - 付款申请单管理
- `finance.receipt_report` - 收款报表 ✅
- `finance.partner_balance` - 货主余额 ✅

### ✅ 权限配置（`src/config/permissions.ts`）

财务管理分组已包含：
- `finance.reconciliation` - 运费对账
- `finance.payment_invoice` - 付款与开票
- `finance.invoice_request_management` - 财务开票
- `finance.payment_requests` - 付款申请单管理
- `finance.receipt_report` - 收款报表 ✅
- `finance.partner_balance` - 货主余额 ✅

### ✅ 路由配置（`src/App.tsx`）

**PC端路由**：
- `/partner-balance` ✅
- `/finance/receipt-report` ✅

**移动端路由**：
- `/m/partner-balance` ✅
- `/m/finance/receipt-report` ✅（如果使用相同组件）

---

## 🔔 通知系统集成详情

### 通知表结构

```sql
CREATE TABLE public.notifications (
    id uuid PRIMARY KEY,
    user_id uuid,              -- 接收通知的用户ID
    type text NOT NULL,        -- 通知类型：'info', 'warning', 'success', 'error'
    category text NOT NULL,    -- 通知分类：'system', 'business', 'finance', 'contract'
    title text NOT NULL,       -- 通知标题
    message text NOT NULL,      -- 通知消息
    link text,                  -- 跳转链接
    is_read boolean DEFAULT false,
    read_at timestamp with time zone,
    related_id uuid,           -- 关联ID（如申请单ID）
    metadata jsonb DEFAULT '{}',
    created_at timestamp with time zone DEFAULT now()
);
```

### 收款提醒通知创建逻辑

在 `send_receipt_reminders_1114` 函数中：

1. **查找需要提醒的申请单**（逾期或即将到期）
2. **更新申请单提醒字段**（`reminder_count`、`last_reminder_at`、`overdue_days`）
3. **为财务人员创建通知**：
   - 通知类型：逾期为 `warning`，即将到期为 `info`
   - 通知分类：`finance`
   - 通知标题：包含申请单号
   - 通知消息：包含逾期天数/到期天数、未收款金额
   - 通知链接：`/finance/payment-invoice?requestNumber=xxx`
   - 关联ID：申请单ID

4. **通知接收人筛选**：
   - 角色为 `admin` 或 `finance` 的用户
   - 或拥有 `finance.payment_invoice` 权限的用户

### 通知显示位置

- **移动端**：`src/pages/mobile/MobileNotifications.tsx`
- **使用函数**：`get_user_notifications` RPC
- **通知分类**：`finance` 分类下的通知

---

## 📝 待办事项（可选优化）

### 中优先级

- [ ] **创建定时任务调用收款提醒**
  - [ ] 配置 Supabase Edge Functions 或 Cron Job
  - [ ] 每天自动调用 `send_receipt_reminders_1114`
  - [ ] 建议时间：每天上午9点

- [ ] **优化收款提醒通知内容**
  - [ ] 添加货主名称
  - [ ] 添加开票金额
  - [ ] 添加累计已收款金额
  - [ ] 添加快速操作按钮（跳转到收款页面）

- [ ] **PC端通知中心**
  - [ ] 如果PC端有通知中心，确保收款提醒也能显示

---

## ✅ 完成状态总结

### 页面和菜单
- ✅ 货主余额管理页面已创建并添加到菜单
- ✅ 收款报表页面已创建并添加到菜单
- ✅ 财务收款页面功能已增强

### 功能实现
- ✅ 货主账号余额系统已实现
- ✅ 财务收款功能增强已实现
- ✅ 收款提醒已集成到通知系统

### 菜单配置
- ✅ PC端菜单已更新
- ✅ 移动端菜单已更新
- ✅ 权限配置已更新（新版本和旧版本）
- ✅ 路由配置已更新（PC端和移动端）

### 通知系统
- ✅ 收款提醒已集成到通知系统
- ✅ 通知创建逻辑已实现
- ✅ 通知接收人筛选已实现

---

**最后更新**：2025-11-14  
**状态**：✅ 所有功能已完成并集成

