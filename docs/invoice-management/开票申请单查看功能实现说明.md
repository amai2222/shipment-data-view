# 开票申请单查看功能实现说明

## 功能概述

为"财务开票"页面添加了**查看申请单**功能，点击蓝色的"查看申请单"按钮即可在新窗口打开标准格式的开票申请表，支持直接打印。

## 实现位置

**文件**: `src/pages/InvoiceRequestManagement.tsx`

**新增功能**:
1. `viewInvoiceRequestForm` 函数（第738-821行）- 查询数据并打开打印窗口
2. `generateInvoiceRequestFormHTML` 函数（第823-1009行）- 生成标准格式的HTML
3. 操作列添加"查看申请单"按钮（第1729-1737行）

## 申请表格式

### 标题区域
```
中科智运（云南）供应链科技有限公司开票申请表
```

### 基本信息行
```
货主单位：厦门本质盼盼食品有限公司   申请时间：2025-10-21   申请编号：3002025102109382098978019641112
```

### 主表格
| 序号 | 申请日期 | 开票抬头 | 货物 | 业务期限 | 目的地 | 运单数 | 开票金额 |
|------|----------|----------|------|----------|--------|--------|----------|
| 1 | 2025-10-21 | 厦门本质盼盼食品有限公司 | 食品 | 2025年08月 | 福建省.泉州市.洛江区 | 2 | ¥500 |

### 汇总行
```
备注：李伟力中科物流7-8月京超配送：XX.XX吨     合计：
                                        运单数：2    ¥500
```

### 签字区域
```
信息部专员签字：_______  业务部审核签字：_______  客户签字：_______  财务部审核签字：_______
```

### 免责声明
```
以上相关内容经本人(申请人)与客户充分沟通，并保证所提供相关资料的准确与完整，
如因资料不符或约定不清等原因造成退票，其责任损失将由开票申请人负责。
```

### 发票信息
```
发票号码：_______________  领票日期：_______________
领票人：_________________  发票开具情况：___________
```

## 使用方法

### 桌面端

1. 打开"财务开票"页面
2. 在开票申请单列表中，找到要查看的申请单
3. 点击操作列中的**蓝色文档图标**按钮（第一个按钮）
4. 系统会在新窗口中打开标准格式的申请表
5. 点击窗口右上角的"打印申请表"按钮即可打印

### 按钮说明

操作列按钮从左到右：
1. 📄 **查看申请单**（蓝色） - 打开标准格式申请表
2. ✓ **审批**（绿色，仅待审核状态显示）
3. ✏️ **编辑** - 修改状态和备注
4. ❌ **作废** - 作废申请单

## 数据来源

### 查询逻辑
```typescript
// 1. 查询申请单详情
const { data: detailsData } = await supabase
  .from('invoice_request_details')
  .select('*')
  .eq('invoice_request_id', request.id);

// 2. 批量查询运单信息
const { data: logisticsData } = await supabase
  .from('logistics_records')
  .select('id, auto_number, project_id, driver_id, loading_location, unloading_location, loading_date, loading_weight')
  .in('id', logisticsRecordIds);

// 3. 查询项目和司机信息
// ...

// 4. 组合数据
```

### 数据字段映射

| 表格列 | 数据来源 | 说明 |
|--------|----------|------|
| 序号 | 固定值1 | 当前版本简化处理 |
| 申请日期 | `request.created_at` | 申请单创建时间 |
| 开票抬头 | `request.partner_full_name` 或 `partner_name` | 合作方全称 |
| 货物 | 固定"食品" | 可后续优化为动态字段 |
| 业务期限 | `request.created_at` (年月) | 取申请月份 |
| 目的地 | `details[0].unloading_location` | 第一条运单的卸货地点 |
| 运单数 | `request.record_count` | 申请单包含的运单数量 |
| 开票金额 | `request.total_amount` | 申请单总金额 |

### 备注生成
```typescript
// 示例格式
备注：李伟力中科物流7-8月京超配送：{totalWeight}吨

// totalWeight计算
const totalWeight = details.reduce((sum, d) => 
  sum + (d.logistics_record.loading_weight || 0), 0
);
```

## 样式特性

### 打印优化
```css
@media print {
  @page { margin: 1cm; }
  body { margin: 0; }
  .no-print { display: none; }  /* 隐藏打印按钮 */
}
```

### 响应式设计
- 表格自动适应页面宽度
- 文字使用宋体，确保打印效果
- 边框1px黑色实线，清晰可见

### 打印按钮
- 固定在右上角
- 打印时自动隐藏
- 蓝色背景，白色文字

## 技术细节

### 窗口打开方式
```typescript
const printWindow = window.open('', '_blank');
printWindow.document.write(htmlContent);
printWindow.document.close();
```

### 错误处理
```typescript
if (!printWindow) {
  toast({
    title: "无法打开窗口",
    description: "请允许弹出窗口以查看申请表",
    variant: "destructive",
  });
  return;
}
```

### 数据安全
- 避免嵌套查询（防止关系冲突）
- 使用分步查询
- 完整的错误处理机制

## 后续优化建议

### 1. 动态货物类型
```typescript
// 当前：固定"食品"
<td>食品</td>

// 建议：从运单数据获取
<td>${logisticsRecord.cargo_type || '食品'}</td>
```

### 2. 多运单明细
当前版本简化为一行汇总，后续可以展开为多行明细：

```html
<tr>
  <td>1</td>
  <td>2025-10-21</td>
  <td>运单号1</td>
  <td>食品</td>
  <td>...</td>
</tr>
<tr>
  <td>2</td>
  <td>2025-10-21</td>
  <td>运单号2</td>
  <td>食品</td>
  <td>...</td>
</tr>
```

### 3. 备注自定义
```typescript
// 当前：固定格式
备注：李伟力中科物流7-8月京超配送：XX吨

// 建议：使用申请单的remarks字段
备注：${request.remarks || ''}
```

### 4. PDF导出
可以集成 PDF 生成库（如 jsPDF）：
```typescript
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';

const exportToPDF = async () => {
  // 生成PDF
};
```

## 测试步骤

### 1. 基本查看功能
1. 打开"财务开票"页面
2. 点击任意申请单的"查看申请单"按钮（蓝色文档图标）
3. 确认新窗口打开，显示格式化的申请表
4. 检查所有信息显示正确：
   - ✓ 货主单位
   - ✓ 申请时间
   - ✓ 申请编号
   - ✓ 开票抬头
   - ✓ 运单数
   - ✓ 开票金额

### 2. 打印功能
1. 在申请表页面，点击右上角"打印申请表"按钮
2. 确认打印预览正确
3. 打印按钮在打印预览中不显示
4. 页面边距和排版适合A4纸张

### 3. 数据准确性
1. 对比申请单详情对话框和打印表格
2. 确认金额一致
3. 确认运单数量一致
4. 确认合作方信息一致

### 4. 不同状态测试
- ✓ 待审核状态
- ✓ 已审核状态
- ✓ 已作废状态
- ✓ 已完成状态

### 5. 边界情况
- ✓ 无运单明细的申请单
- ✓ 大量运单的申请单（50+条）
- ✓ 空备注的申请单

## 常见问题

### Q1: 为什么点击按钮没有反应？
**A**: 检查浏览器是否阻止了弹出窗口。请在浏览器地址栏允许弹出窗口权限。

### Q2: 打印时如何调整页面大小？
**A**: 在打印预览中，选择"更多设置"，调整缩放比例或页边距。

### Q3: 可以保存为PDF吗？
**A**: 
- **方法1**: 打印时选择"另存为PDF"
- **方法2**: 使用浏览器的"打印到PDF"功能
- **方法3**: 等待后续PDF导出功能开发

### Q4: 备注内容来自哪里？
**A**: 
- 主要备注：计算总重量显示
- 事项说明：使用申请单的`remarks`字段
- 可以在编辑申请单时修改

### Q5: 为什么货物类型固定是"食品"？
**A**: 当前版本简化处理，后续版本会从运单的`cargo_type`字段动态获取。

## 权限要求

- 查看功能：所有能访问"财务开票"页面的用户
- 打印功能：浏览器允许弹出窗口

## 相关功能

- **财务开票**: 主页面，管理所有开票申请单
- **批量操作**: 批量确认、拒绝、作废
- **详情查看**: 查看运单明细
- **导出功能**: 导出所有申请单（HTML格式）

## 与付款申请单的对比

| 功能 | 付款申请单 | 开票申请单 | 说明 |
|------|------------|------------|------|
| 查看申请单 | ✓ | ✓ | 都支持 |
| 打印功能 | ✓ | ✓ | 都支持 |
| 格式标准 | 中科智运付款申请表 | 中科智运开票申请表 | 不同模板 |
| 签字区域 | 4个签字位 | 4个签字位 | 相同 |
| 免责声明 | 付款相关 | 开票相关 | 内容不同 |

## 技术实现

### 核心代码结构

```typescript
// 1. 按钮添加
<Button
  variant="ghost"
  size="sm"
  onClick={() => viewInvoiceRequestForm(request)}
  title="查看申请单"
  className="text-blue-600"
>
  <FileText className="h-4 w-4" />
</Button>

// 2. 数据查询
const viewInvoiceRequestForm = async (request: InvoiceRequest) => {
  // 查询详情数据
  const details = await loadDetailsData();
  
  // 生成HTML
  const html = generateInvoiceRequestFormHTML(request, details);
  
  // 打开新窗口
  const printWindow = window.open('', '_blank');
  printWindow.document.write(html);
  printWindow.document.close();
};

// 3. HTML生成
const generateInvoiceRequestFormHTML = (request, details) => {
  // 计算总重量
  const totalWeight = details.reduce(...);
  
  // 生成HTML字符串
  return `<!DOCTYPE html>...`;
};
```

### 数据流程

```
用户点击按钮
    ↓
查询 invoice_request_details
    ↓
查询 logistics_records (批量)
    ↓
查询 projects, drivers (批量)
    ↓
组合数据
    ↓
生成 HTML
    ↓
打开新窗口
    ↓
显示申请表
```

## 更新记录

- **2025-10-27**: 初始实现，参考图片格式创建标准申请表
- 支持查看和打印功能
- 自动计算总重量
- 完整的签字和免责声明区域

## 下一步计划

- [ ] 优化多运单明细展示
- [ ] 动态货物类型
- [ ] PDF直接导出功能
- [ ] 批量打印多个申请单
- [ ] 自定义备注模板

---

实现日期：2025-10-27  
实现文件：`src/pages/InvoiceRequestManagement.tsx`  
功能状态：✅ 已完成并可用

