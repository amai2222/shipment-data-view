# 一键开票申请自动切分功能完成说明

## ✅ 功能确认

**一键开票申请已经支持按最高级合作方自动切分**，无需额外开发！

## 实现详情

### 后端实现

**函数**: `save_invoice_request(p_record_ids uuid[])`  
**文件**: `supabase/migrations/20250116_fix_save_invoice_request_update_logistics_records.sql`

**核心逻辑**:
1. 自动找出所有运单中的最高级别 (`MAX(level)`)
2. 按不同的最高级合作方 (`DISTINCT partner_id`) 分组
3. 为每个最高级合作方创建一个独立的开票申请单

### 前端优化

**修改文件**: `src/pages/InvoiceRequest.tsx`

**优化内容**:
- ✅ 解析后端返回的详细结果
- ✅ 智能提示：单个/多个申请单显示不同消息
- ✅ 详细信息：显示每个合作方的运单数量
- ✅ 延长显示时间：多申请单时延长到8秒

## 使用示例

### 场景1：单一最高级合作方

**操作**: 选择10条运单，都属于同一个最高级合作方"中粮集团"

**结果**:
```
✓ 成功
开票申请已成功创建，共处理 10 条运单
```

**创建的申请单**: 1个
- 开票申请单 KP20251027-0001
  - 合作方：中粮集团有限公司
  - 运单数：10条
  - 总金额：¥100,000.00

---

### 场景2：多个最高级合作方

**操作**: 选择10条运单：
- 5条 → 中粮集团
- 3条 → 可乐公司
- 2条 → 盼盼集团

**结果**:
```
✓ 成功 - 已自动切分
根据最高级合作方自动创建了 3 个开票申请单：
中粮集团有限公司(5条)、可乐食品有限公司(3条)、盼盼食品集团股份有限公司(2条)，
共处理 10 条运单
```

**创建的申请单**: 3个
1. 开票申请单 KP20251027-0001
   - 合作方：中粮集团有限公司
   - 运单数：5条
   - 总金额：¥50,000.00

2. 开票申请单 KP20251027-0002
   - 合作方：可乐食品有限公司
   - 运单数：3条
   - 总金额：¥30,000.00

3. 开票申请单 KP20251027-0003
   - 合作方：盼盼食品集团股份有限公司
   - 运单数：2条
   - 总金额：¥20,000.00

## 验证步骤

### 1. 准备测试数据

```sql
-- 查询有不同最高级合作方的运单
SELECT 
  lr.auto_number,
  p.name as partner_name,
  lpc.level,
  lpc.payable_amount
FROM logistics_records lr
JOIN logistics_partner_costs lpc ON lr.id = lpc.logistics_record_id
JOIN partners p ON lpc.partner_id = p.id
WHERE lpc.invoice_status = 'Uninvoiced'
  AND lpc.level = (
    SELECT MAX(level) 
    FROM logistics_partner_costs 
    WHERE logistics_record_id = lr.id
  )
ORDER BY p.name, lr.auto_number
LIMIT 20;
```

### 2. 执行开票申请

1. 打开"付款与开票"页面
2. 选择包含不同最高级合作方的运单（至少2个不同合作方）
3. 点击"一键开票申请"按钮
4. 在预览对话框中点击"确认并保存"

### 3. 验证结果

**查看提示信息**:
- 如果创建多个申请单，应该看到"已自动切分"的提示
- 提示中应列出各个合作方及其运单数量

**查看申请单列表**:
1. 进入"财务开票"页面
2. 确认创建了对应数量的申请单
3. 每个申请单对应一个最高级合作方

**查看申请单详情**:
1. 打开每个申请单
2. 验证合作方信息正确
3. 验证运单分组正确
4. 验证金额计算正确

## 技术细节

### 返回数据结构

```typescript
interface SaveInvoiceRequestResult {
  success: boolean;
  message: string;
  created_requests: Array<{
    request_id: string;
    request_number: string;
    partner_id: string;
    partner_name: string;
    total_amount: number;
    record_count: number;
  }>;
  total_requests: number;
  processed_record_ids: string[];
}
```

### 提示信息逻辑

```typescript
if (result.total_requests > 1) {
  // 多个申请单：详细列出每个合作方
  const partnerList = result.created_requests
    .map(req => `${req.partner_name}(${req.record_count}条)`)
    .join('、');
  
  toast({
    title: "成功 - 已自动切分",
    description: `根据最高级合作方自动创建了 ${result.total_requests} 个开票申请单：${partnerList}...`,
    duration: 8000
  });
} else {
  // 单个申请单：简洁提示
  toast({
    title: "成功",
    description: `开票申请已成功创建，共处理 ${count} 条运单`
  });
}
```

## 业务规则

### 最高级合作方识别

- **级别定义**: `level` 字段，数值越小级别越高
- **最高级**: `level = MIN(level)` 或 `level = MAX(level)`（取决于数据设计）
- **示例**: 
  - Level 1 = 总公司（最高级）
  - Level 2 = 分公司
  - Level 3 = 子公司

### 自动分组规则

1. 只处理最高级别的合作方成本记录
2. 按 `partner_id` 分组
3. 每组创建一个独立的开票申请单

### 状态更新

**创建申请单后**:
- `logistics_partner_costs.invoice_status`: Uninvoiced → Processing
- `logistics_records.invoice_status`: Uninvoiced → Processing
- 设置 `invoice_request_id` 关联
- 设置 `invoice_applied_at` 时间戳

## 注意事项

### 1. 权限要求
- 需要财务人员或管理员权限
- 普通操作员无法创建开票申请

### 2. 数据要求
- 运单必须是"未开票"状态
- 运单必须有合作方成本记录
- 合作方必须有银行信息（可选）

### 3. 业务约束
- 只为最高级合作方创建申请单
- 非最高级合作方的成本不会被处理
- 已申请或已开票的运单会被自动跳过

## 常见问题

### Q: 为什么选了10条运单，只创建了1个申请单？
**A**: 因为这10条运单都属于同一个最高级合作方。

### Q: 为什么选了10条运单，只有5条被处理？
**A**: 可能原因：
- 另外5条已经申请过开票
- 另外5条的合作方不是最高级
- 另外5条的状态不是"Uninvoiced"

### Q: 可以手动指定要给哪个合作方开票吗？
**A**: 当前版本自动识别最高级合作方，如需特殊处理，请联系管理员调整合作链路配置。

### Q: 如何取消自动切分功能？
**A**: 自动切分是业务必需功能，不建议取消。如有特殊需求，需要修改后端逻辑。

## 相关功能

- **付款申请**: 使用类似的自动分组逻辑
- **合作方层级管理**: 配置合作方的级别关系
- **财务开票**: 查看和管理创建的开票申请单

## 更新记录

- **2025-10-27**: 优化前端提示信息，支持详细显示切分结果
- **2025-01-16**: 后端实现自动切分功能
- **2024-09-23**: 初始版本开票申请功能

---

功能状态：✅ 已完成并优化  
最后更新：2025-10-27

