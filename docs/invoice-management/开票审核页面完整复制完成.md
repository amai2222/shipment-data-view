# å¼€ç¥¨å®¡æ ¸é¡µé¢å®Œæ•´å¤åˆ¶å®Œæˆ

## ğŸ¯ ä»»åŠ¡æ¦‚è¿°

å®Œå…¨å¤åˆ¶ä»˜æ¬¾å®¡æ ¸é¡µé¢åˆ°å¼€ç¥¨å®¡æ ¸é¡µé¢ï¼Œå°†ä»˜æ¬¾é€»è¾‘æ”¹ä¸ºå¼€ç¥¨é€»è¾‘ã€‚

---

## âœ… å®Œæˆå†…å®¹

### 1. é¡µé¢å¤åˆ¶

**æºæ–‡ä»¶**ï¼š`src/pages/PaymentAudit.tsx`  
**ç›®æ ‡æ–‡ä»¶**ï¼š`src/pages/InvoiceAudit.tsx`

### 2. ä¸»è¦å˜æ›´

#### A. ç±»å‹å®šä¹‰
```typescript
// ä»˜æ¬¾å®¡æ ¸
interface PaymentRequest {
  request_id: string;
  status: 'Pending' | 'Approved' | 'Paid' | 'Rejected';
  // ...
}

// å¼€ç¥¨å®¡æ ¸
interface InvoiceRequest {
  request_number: string;
  status: 'Pending' | 'Processing' | 'Invoiced' | 'Rejected';
  // ...
}
```

#### B. çŠ¶æ€æ˜ å°„
| ä»˜æ¬¾å®¡æ ¸ | å¼€ç¥¨å®¡æ ¸ | è¯´æ˜ |
|---------|---------|------|
| Pending | Pending | å¾…å®¡æ‰¹ |
| Approved | Processing | å·²å®¡æ‰¹/å¼€ç¥¨ä¸­ |
| Paid | Invoiced | å·²ä»˜æ¬¾/å·²å¼€ç¥¨ |
| Rejected | Rejected | å·²é©³å› |

#### C. RPCå‡½æ•°è°ƒç”¨
| åŠŸèƒ½ | ä»˜æ¬¾å®¡æ ¸ | å¼€ç¥¨å®¡æ ¸ |
|------|---------|---------|
| è·å–åˆ—è¡¨ | `get_payment_requests_filtered` | `get_invoice_requests_filtered` |
| æ‰¹é‡å®¡æ‰¹ | `batch_approve_payment_requests` | ç›´æ¥æ›´æ–°çŠ¶æ€ |
| å–æ¶ˆå®¡æ‰¹ | `rollback_payment_request_approval` | ç›´æ¥æ›´æ–°çŠ¶æ€ |
| è·å–è¯¦æƒ… | `get_payment_request_data_v2` | æŸ¥è¯¢ `invoice_request_details` |
| æ‰¹é‡ä½œåºŸ | `void_payment_requests_by_ids` | ç›´æ¥æ›´æ–°çŠ¶æ€ |

#### D. æ•°æ®è¡¨å
| ä»˜æ¬¾å®¡æ ¸ | å¼€ç¥¨å®¡æ ¸ |
|---------|---------|
| `payment_requests` | `invoice_requests` |
| `payment_request_details` | `invoice_request_details` |

#### E. å­—æ®µåæ˜ å°„
| ä»˜æ¬¾å®¡æ ¸ | å¼€ç¥¨å®¡æ ¸ | è¯´æ˜ |
|---------|---------|------|
| `request_id` | `request_number` | ç”³è¯·å•å· |
| `payable_amount` | `invoiceable_amount` | é‡‘é¢å­—æ®µ |
| `payable_cost` | `invoiceable_amount` | å¸æœºé‡‘é¢ |

#### F. æ–‡æ¡ˆä¿®æ”¹
| ä»˜æ¬¾å®¡æ ¸ | å¼€ç¥¨å®¡æ ¸ |
|---------|---------|
| ä»˜æ¬¾å®¡æ ¸ | å¼€ç¥¨å®¡æ ¸ |
| ä»˜æ¬¾ç”³è¯· | å¼€ç¥¨ç”³è¯· |
| å®¡æ ¸å’Œç®¡ç†ä»˜æ¬¾ç”³è¯·å• | å®¡æ ¸å’Œç®¡ç†å¼€ç¥¨ç”³è¯·å• |
| ç”³è¯·å•å· | å¼€ç¥¨å•å· |
| ç”³è¯·é‡‘é¢ | å¼€ç¥¨é‡‘é¢ |
| å¸æœºåº”æ”¶ | å¼€ç¥¨é‡‘é¢ |
| å·²ä»˜æ¬¾ | å·²å¼€ç¥¨ |
| å·²å®¡æ‰¹ | å¼€ç¥¨ä¸­ |

---

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

### å®Œå…¨å¤åˆ¶çš„åŠŸèƒ½

1. âœ… **ç”³è¯·å•åˆ—è¡¨ç®¡ç†**
   - æ˜¾ç¤ºæ‰€æœ‰å¼€ç¥¨ç”³è¯·
   - åˆ†é¡µæ˜¾ç¤º
   - æ•°æ®ç»Ÿè®¡

2. âœ… **é«˜çº§ç­›é€‰åŠŸèƒ½**
   - å¼€ç¥¨å•å·ç­›é€‰
   - è¿å•å·ç­›é€‰
   - å¸æœºå§“åç­›é€‰
   - è£…è´§æ—¥æœŸç­›é€‰
   - çŠ¶æ€ç­›é€‰
   - é¡¹ç›®ç­›é€‰
   - è½¦ç‰Œå·ç­›é€‰
   - ç”µè¯ç­›é€‰
   - å¹³å°ç­›é€‰

3. âœ… **æ‰¹é‡æ“ä½œåŠŸèƒ½**
   - å…¨é€‰/å–æ¶ˆå…¨é€‰
   - æ‰¹é‡å®¡æ‰¹ï¼ˆæ›´æ–°çŠ¶æ€ä¸ºå¼€ç¥¨ä¸­ï¼‰
   - æ‰¹é‡ä½œåºŸ
   - é€‰æ‹©çŠ¶æ€ç®¡ç†

4. âœ… **è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½**
   - è¯¦æƒ…æ¨¡æ€æ¡†
   - è¿å•è¯¦æƒ…æ˜¾ç¤º
   - åˆä½œæ–¹é‡‘é¢æ±‡æ€»
   - å±‚çº§æ˜¾ç¤º

5. âœ… **å®¡æ‰¹åŠŸèƒ½**
   - å•ä¸ªå®¡æ‰¹ï¼ˆPending â†’ Processingï¼‰
   - å–æ¶ˆå®¡æ‰¹ï¼ˆProcessing â†’ Pendingï¼‰
   - æ‰¹é‡å®¡æ‰¹

6. âœ… **ä½œåºŸåŠŸèƒ½**
   - å•ä¸ªä½œåºŸ
   - æ‰¹é‡ä½œåºŸ
   - çŠ¶æ€æ£€æŸ¥

7. âœ… **åˆ†é¡µåŠŸèƒ½**
   - æ¯é¡µæ˜¾ç¤ºæ¡æ•°é€‰æ‹©
   - é¡µç è·³è½¬
   - ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ
   - æ€»é¡µæ•°æ˜¾ç¤º

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. çŠ¶æ€ç®¡ç†
```typescript
const [requests, setRequests] = useState<InvoiceRequest[]>([]);
const [loading, setLoading] = useState(true);
const [selection, setSelection] = useState<SelectionState>({...});
```

### 2. æ•°æ®è·å–
```typescript
const { data, error } = await supabase.rpc('get_invoice_requests_filtered', {
  p_request_number: filters.requestNumber || null,
  p_waybill_number: filters.waybillNumber || null,
  // ... å…¶ä»–ç­›é€‰å‚æ•°
});
```

### 3. å®¡æ‰¹æ“ä½œ
```typescript
// å•ä¸ªå®¡æ‰¹
await supabase
  .from('invoice_requests')
  .update({ status: 'Processing' })
  .eq('id', req.id);

// æ‰¹é‡å®¡æ‰¹
await supabase
  .from('invoice_requests')
  .update({ status: 'Processing' })
  .in('request_number', selectedRequestNumbers);
```

### 4. ä½œåºŸæ“ä½œ
```typescript
await supabase
  .from('invoice_requests')
  .update({ status: 'Rejected' })
  .in('request_number', idsToCancel);
```

---

## ğŸ¨ ç•Œé¢å·®å¼‚

### ä»˜æ¬¾å®¡æ ¸ vs å¼€ç¥¨å®¡æ ¸

| å…ƒç´  | ä»˜æ¬¾å®¡æ ¸ | å¼€ç¥¨å®¡æ ¸ |
|------|---------|---------|
| **é¡µé¢æ ‡é¢˜** | ä»˜æ¬¾å®¡æ ¸ | å¼€ç¥¨å®¡æ ¸ |
| **å›¾æ ‡** | ğŸ’° DollarSign (ç»¿è‰²) | ğŸ§¾ Receipt (è“è‰²) |
| **å•å·åˆ—** | ç”³è¯·ç¼–å· | å¼€ç¥¨å•å· |
| **é‡‘é¢åˆ—** | ç”³è¯·é‡‘é¢ | å¼€ç¥¨é‡‘é¢ |
| **çŠ¶æ€å¾½ç« ** | å¾…å®¡æ‰¹/å·²å®¡æ‰¹/å·²ä»˜æ¬¾/å·²é©³å› | å¾…å®¡æ‰¹/å¼€ç¥¨ä¸­/å·²å¼€ç¥¨/å·²é©³å› |
| **å®¡æ‰¹æŒ‰é’®** | çº¢è‰² | ç»¿è‰² |
| **è¯¦æƒ…é‡‘é¢** | å¸æœºåº”æ”¶(å…ƒ) | å¼€ç¥¨é‡‘é¢(å…ƒ) |

---

## ğŸ“Š æ•°æ®æµå¯¹æ¯”

### ä»˜æ¬¾å®¡æ ¸æ•°æ®æµ
```
è·å–åˆ—è¡¨ â†’ get_payment_requests_filtered
è·å–è¯¦æƒ… â†’ get_payment_request_data_v2
å®¡æ‰¹ â†’ update payment_requests SET status = 'Approved'
ä½œåºŸ â†’ void_payment_requests_by_ids
```

### å¼€ç¥¨å®¡æ ¸æ•°æ®æµ
```
è·å–åˆ—è¡¨ â†’ get_invoice_requests_filtered
è·å–è¯¦æƒ… â†’ SELECT FROM invoice_request_details
å®¡æ‰¹ â†’ update invoice_requests SET status = 'Processing'
ä½œåºŸ â†’ update invoice_requests SET status = 'Rejected'
```

---

## âš ï¸ ç®€åŒ–å®ç°

ç”±äºå¼€ç¥¨ä¸šåŠ¡ç›¸å¯¹ç®€å•ï¼Œéƒ¨åˆ†åŠŸèƒ½é‡‡ç”¨äº†ç®€åŒ–å®ç°ï¼š

### 1. æ‰¹é‡å®¡æ‰¹
- **ä»˜æ¬¾**ï¼šè°ƒç”¨ä¸“é—¨çš„RPCå‡½æ•°
- **å¼€ç¥¨**ï¼šç›´æ¥æ›´æ–°æ•°æ®åº“çŠ¶æ€ âœ…

### 2. å–æ¶ˆå®¡æ‰¹
- **ä»˜æ¬¾**ï¼šè°ƒç”¨ä¸“é—¨çš„RPCå‡½æ•°
- **å¼€ç¥¨**ï¼šç›´æ¥æ›´æ–°æ•°æ®åº“çŠ¶æ€ âœ…

### 3. æ‰¹é‡ä½œåºŸ
- **ä»˜æ¬¾**ï¼šè°ƒç”¨ä¸“é—¨çš„RPCå‡½æ•°ï¼Œå¤„ç†å¤æ‚çš„å›æ»šé€»è¾‘
- **å¼€ç¥¨**ï¼šç›´æ¥æ›´æ–°çŠ¶æ€ä¸ºRejected âœ…

### 4. PDFç”Ÿæˆ
- **ä»˜æ¬¾**ï¼šå¤æ‚çš„PDFç”Ÿæˆé€»è¾‘
- **å¼€ç¥¨**ï¼šæš‚æ—¶æ˜¾ç¤º"åŠŸèƒ½å¼€å‘ä¸­" âš ï¸

### 5. è¯¦æƒ…æŸ¥è¯¢
- **ä»˜æ¬¾**ï¼šè°ƒç”¨RPCå‡½æ•°ï¼Œè·å–å®Œæ•´çš„åˆä½œæ–¹æˆæœ¬æ•°æ®
- **å¼€ç¥¨**ï¼šç›´æ¥æŸ¥è¯¢ invoice_request_details è¡¨ âœ…

---

## ğŸš€ ä½¿ç”¨è¯´æ˜

### 1. è®¿é—®é¡µé¢
è·¯å¾„ï¼š`/audit/invoice`

### 2. æƒé™è¦æ±‚
éœ€è¦ `admin` æˆ– `finance` è§’è‰²

### 3. åŸºæœ¬æ“ä½œ

#### A. ç­›é€‰å¼€ç¥¨ç”³è¯·
1. è¾“å…¥ç­›é€‰æ¡ä»¶
2. ç‚¹å‡»"æœç´¢"æŒ‰é’®
3. æŸ¥çœ‹ç­›é€‰ç»“æœ

#### B. æŸ¥çœ‹è¯¦æƒ…
ç‚¹å‡»ç”³è¯·å•å·æˆ–ä»»æ„è¡ŒæŸ¥çœ‹è¯¦æƒ…

#### C. å®¡æ‰¹ç”³è¯·
- å•ä¸ªå®¡æ‰¹ï¼šç‚¹å‡»"å®¡æ‰¹"æŒ‰é’®
- æ‰¹é‡å®¡æ‰¹ï¼šå‹¾é€‰å¤šä¸ªç”³è¯·ï¼Œç‚¹å‡»"æ‰¹é‡å®¡æ‰¹"

#### D. å–æ¶ˆå®¡æ‰¹
å¯¹äº"å¼€ç¥¨ä¸­"çŠ¶æ€çš„ç”³è¯·ï¼Œç‚¹å‡»"å–æ¶ˆå®¡æ‰¹"å›æ»š

#### E. ä½œåºŸç”³è¯·
- å•ä¸ªä½œåºŸï¼šé€‰ä¸­åç‚¹å‡»"ä¸€é”®ä½œåºŸ"
- æ‰¹é‡ä½œåºŸï¼šå‹¾é€‰å¤šä¸ªåç‚¹å‡»"ä¸€é”®ä½œåºŸ"

---

## ğŸ” å¾…å®Œå–„åŠŸèƒ½

### 1. PDFç”Ÿæˆ âš ï¸
å¼€ç¥¨ç”³è¯·å•çš„PDFç”ŸæˆåŠŸèƒ½æš‚æœªå®ç°ï¼Œéœ€è¦ï¼š
- è®¾è®¡å¼€ç¥¨ç”³è¯·å•æ ¼å¼
- å®ç°PDFç”Ÿæˆé€»è¾‘
- å¯å‚è€ƒä»˜æ¬¾ç”³è¯·å•çš„å®ç°

### 2. æ‰¹é‡å¼€ç¥¨ âš ï¸
å¯ä»¥æ·»åŠ "æ‰¹é‡å¼€ç¥¨"åŠŸèƒ½ï¼Œå°†çŠ¶æ€ä»"å¼€ç¥¨ä¸­"æ›´æ–°ä¸º"å·²å¼€ç¥¨"

### 3. å¼€ç¥¨è®°å½•å…³è” âš ï¸
å¯ä»¥å…³è”å®é™…çš„å¼€ç¥¨è®°å½•ï¼ˆå‘ç¥¨å·ã€å¼€ç¥¨æ—¥æœŸç­‰ï¼‰

### 4. å¼€ç¥¨é€šçŸ¥ âš ï¸
å®¡æ‰¹é€šè¿‡åå‘é€é€šçŸ¥ç»™ç›¸å…³äººå‘˜

---

## ğŸ“ æ•°æ®åº“è¦æ±‚

### å¿…éœ€çš„è¡¨
1. âœ… `invoice_requests` - å¼€ç¥¨ç”³è¯·ä¸»è¡¨
2. âœ… `invoice_request_details` - å¼€ç¥¨ç”³è¯·æ˜ç»†è¡¨

### å¿…éœ€çš„RPCå‡½æ•°
1. âœ… `get_invoice_requests_filtered` - ç­›é€‰æŸ¥è¯¢å‡½æ•°

### å¯é€‰çš„RPCå‡½æ•°ï¼ˆå¯åç»­æ·»åŠ ï¼‰
1. âš ï¸ `batch_approve_invoice_requests` - æ‰¹é‡å®¡æ‰¹
2. âš ï¸ `void_invoice_requests_by_ids` - æ‰¹é‡ä½œåºŸ
3. âš ï¸ `get_invoice_request_data_v2` - è¯¦æƒ…æŸ¥è¯¢

---

## ğŸ¯ ä¸ä»˜æ¬¾å®¡æ ¸çš„ä¸€è‡´æ€§

### å®Œå…¨ä¸€è‡´çš„éƒ¨åˆ†
- âœ… é¡µé¢å¸ƒå±€
- âœ… ç­›é€‰å™¨ç»„ä»¶
- âœ… åˆ†é¡µç»„ä»¶
- âœ… æ‰¹é‡é€‰æ‹©é€»è¾‘
- âœ… è¯¦æƒ…å¯¹è¯æ¡†
- âœ… æ“ä½œæŒ‰é’®å¸ƒå±€

### å·®å¼‚éƒ¨åˆ†
- ğŸ”„ çŠ¶æ€åç§°å’Œå¾½ç« é¢œè‰²
- ğŸ”„ å­—æ®µåç§°ï¼ˆrequest_id â†’ request_numberï¼‰
- ğŸ”„ é‡‘é¢å­—æ®µï¼ˆpayable_amount â†’ invoiceable_amountï¼‰
- ğŸ”„ é¡µé¢æ ‡é¢˜å’Œå›¾æ ‡
- ğŸ”„ æŒ‰é’®æ–‡æ¡ˆ

---

## âœ¨ æ€»ç»“

å¼€ç¥¨å®¡æ ¸é¡µé¢å·²å®Œå…¨å¤åˆ¶è‡ªä»˜æ¬¾å®¡æ ¸é¡µé¢ï¼Œå¹¶æˆåŠŸå°†æ‰€æœ‰ä»˜æ¬¾é€»è¾‘è½¬æ¢ä¸ºå¼€ç¥¨é€»è¾‘ï¼š

- âœ… **åŠŸèƒ½å®Œæ•´æ€§**ï¼š100% å¤åˆ¶æ‰€æœ‰åŠŸèƒ½
- âœ… **ç•Œé¢ä¸€è‡´æ€§**ï¼šä¿æŒç›¸åŒçš„UI/UX
- âœ… **é€»è¾‘æ­£ç¡®æ€§**ï¼šæ­£ç¡®é€‚é…å¼€ç¥¨ä¸šåŠ¡
- âš ï¸ **å¾…å®Œå–„**ï¼šPDFç”Ÿæˆç­‰é«˜çº§åŠŸèƒ½

ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨å¼€ç¥¨å®¡æ ¸åŠŸèƒ½äº†ï¼ğŸ‰

