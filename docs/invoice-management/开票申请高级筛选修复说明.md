# å¼€ç¥¨ç”³è¯·é«˜çº§ç­›é€‰ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆå¼€ç¥¨ç”³è¯·é¡µé¢çš„é«˜çº§ç­›é€‰åŠŸèƒ½æ— æ•ˆï¼Œè¾“å…¥ç­›é€‰æ¡ä»¶åæ²¡æœ‰ç”Ÿæ•ˆã€‚

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
1. **åç«¯RPCå‡½æ•°ä¸æ”¯æŒé«˜çº§ç­›é€‰å‚æ•°**: `get_invoice_request_data`å‡½æ•°åªæ”¯æŒåŸºæœ¬ç­›é€‰å‚æ•°ï¼ˆé¡¹ç›®ã€æ—¥æœŸã€åˆä½œæ–¹ã€å¼€ç¥¨çŠ¶æ€ï¼‰ï¼Œä¸æ”¯æŒé«˜çº§ç­›é€‰å‚æ•°ï¼ˆè¿å•ç¼–å·ã€å¸æœºã€è½¦ç‰Œå·ã€å¸æœºç”µè¯ã€å¸æœºåº”æ”¶ï¼‰ã€‚

2. **å‰ç«¯æœªå®ç°å®¢æˆ·ç«¯ç­›é€‰**: å‰ç«¯åªå°†é«˜çº§ç­›é€‰å‚æ•°å­˜å‚¨åœ¨çŠ¶æ€ä¸­ï¼Œä½†æ²¡æœ‰åœ¨æ•°æ®è·å–åè¿›è¡Œå®¢æˆ·ç«¯ç­›é€‰ã€‚

3. **RPCå‡½æ•°è°ƒç”¨ä¸å®Œæ•´**: `get_filtered_uninvoiced_record_ids`å‡½æ•°ä¸å­˜åœ¨ï¼Œå¯¼è‡´å…¨é€‰æ¨¡å¼ä¸‹çš„ç­›é€‰é€»è¾‘å¤±è´¥ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. å®¢æˆ·ç«¯é«˜çº§ç­›é€‰å®ç°

**ä¿®æ”¹æ•°æ®è·å–é€»è¾‘**:
```typescript
// è·å–æ›´å¤šæ•°æ®ç”¨äºå®¢æˆ·ç«¯ç­›é€‰
p_page_size: 1000, // è·å–æ›´å¤šæ•°æ®ç”¨äºå®¢æˆ·ç«¯ç­›é€‰
p_page_number: 1,
```

**æ·»åŠ å®¢æˆ·ç«¯ç­›é€‰é€»è¾‘**:
```typescript
// å®¢æˆ·ç«¯é«˜çº§ç­›é€‰
let filteredData = data;
if (data && data.records && Array.isArray(data.records)) {
  let filteredRecords = data.records;
  
  // è¿å•ç¼–å·ç­›é€‰
  if (activeFilters.waybillNumbers && activeFilters.waybillNumbers.trim()) {
    const waybillNumbers = activeFilters.waybillNumbers.split(',').map(n => n.trim()).filter(n => n);
    if (waybillNumbers.length > 0) {
      filteredRecords = filteredRecords.filter(record => 
        waybillNumbers.some(num => record.auto_number?.includes(num))
      );
    }
  }
  
  // å¸æœºå§“åç­›é€‰
  if (activeFilters.driverName && activeFilters.driverName.trim()) {
    const driverNames = activeFilters.driverName.split(',').map(n => n.trim()).filter(n => n);
    if (driverNames.length > 0) {
      filteredRecords = filteredRecords.filter(record => 
        driverNames.some(name => record.driver_name?.includes(name))
      );
    }
  }
  
  // è½¦ç‰Œå·ç­›é€‰
  if (activeFilters.licensePlate && activeFilters.licensePlate.trim()) {
    const licensePlates = activeFilters.licensePlate.split(',').map(n => n.trim()).filter(n => n);
    if (licensePlates.length > 0) {
      filteredRecords = filteredRecords.filter(record => 
        licensePlates.some(plate => record.license_plate?.includes(plate))
      );
    }
  }
  
  // å¸æœºç”µè¯ç­›é€‰
  if (activeFilters.driverPhone && activeFilters.driverPhone.trim()) {
    const driverPhones = activeFilters.driverPhone.split(',').map(n => n.trim()).filter(n => n);
    if (driverPhones.length > 0) {
      filteredRecords = filteredRecords.filter(record => 
        driverPhones.some(phone => record.driver_phone?.includes(phone))
      );
    }
  }
  
  // å¸æœºåº”æ”¶ç­›é€‰
  if (activeFilters.driverReceivable && activeFilters.driverReceivable.trim()) {
    const receivableAmounts = activeFilters.driverReceivable.split(',').map(n => n.trim()).filter(n => n);
    if (receivableAmounts.length > 0) {
      filteredRecords = filteredRecords.filter(record => 
        receivableAmounts.some(amount => {
          const recordAmount = record.current_cost || 0;
          return recordAmount.toString().includes(amount);
        })
      );
    }
  }
  
  // åˆ†é¡µå¤„ç†
  const totalFiltered = filteredRecords.length;
  const startIndex = (pagination.currentPage - 1) * PAGE_SIZE;
  const endIndex = startIndex + PAGE_SIZE;
  const paginatedRecords = filteredRecords.slice(startIndex, endIndex);
  
  filteredData = {
    ...data,
    records: paginatedRecords,
    count: totalFiltered
  };
}
```

### 2. å…¨é€‰æ¨¡å¼ç­›é€‰ä¿®å¤

**ä¿®å¤å‰**: ä½¿ç”¨ä¸å­˜åœ¨çš„RPCå‡½æ•°
```typescript
const { data: allFilteredIds, error: idError } = await supabase.rpc('get_filtered_uninvoiced_record_ids', {
  // å‚æ•°...
});
```

**ä¿®å¤å**: ä½¿ç”¨ç›¸åŒçš„RPCå‡½æ•°å¹¶åº”ç”¨å®¢æˆ·ç«¯ç­›é€‰
```typescript
const { data: allData, error: allError } = await supabase.rpc('get_invoice_request_data', {
  p_project_id: activeFilters.projectId === 'all' ? null : activeFilters.projectId,
  p_start_date: activeFilters.startDate || null,
  p_end_date: activeFilters.endDate || null,
  p_partner_id: activeFilters.partnerId === 'all' ? null : activeFilters.partnerId,
  p_invoice_status_array: null, // è·å–æ‰€æœ‰çŠ¶æ€
  p_page_size: 1000,
  p_page_number: 1,
});

// åº”ç”¨å®¢æˆ·ç«¯é«˜çº§ç­›é€‰
let allFilteredRecords = allData?.records || [];
// ... åº”ç”¨ç›¸åŒçš„ç­›é€‰é€»è¾‘
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ç­›é€‰é€»è¾‘ç‰¹ç‚¹

1. **å¤šå€¼æ”¯æŒ**: æ”¯æŒé€—å·åˆ†éš”çš„å¤šä¸ªå€¼ç­›é€‰
2. **æ¨¡ç³ŠåŒ¹é…**: ä½¿ç”¨`includes`è¿›è¡Œæ¨¡ç³ŠåŒ¹é…
3. **ç©ºå€¼å¤„ç†**: è‡ªåŠ¨è¿‡æ»¤ç©ºå€¼å’Œç©ºç™½å­—ç¬¦
4. **åˆ†é¡µå…¼å®¹**: ç­›é€‰åæ­£ç¡®è®¡ç®—åˆ†é¡µä¿¡æ¯

### ç­›é€‰å­—æ®µæ˜ å°„

| å‰ç«¯å­—æ®µ | åç«¯å­—æ®µ | ç­›é€‰é€»è¾‘ |
|----------|----------|----------|
| `waybillNumbers` | `auto_number` | æ¨¡ç³ŠåŒ¹é…è¿å•ç¼–å· |
| `driverName` | `driver_name` | æ¨¡ç³ŠåŒ¹é…å¸æœºå§“å |
| `licensePlate` | `license_plate` | æ¨¡ç³ŠåŒ¹é…è½¦ç‰Œå· |
| `driverPhone` | `driver_phone` | æ¨¡ç³ŠåŒ¹é…å¸æœºç”µè¯ |
| `driverReceivable` | `current_cost` | æ•°å€¼åŒ¹é…å¸æœºåº”æ”¶ |

### æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®é‡æ§åˆ¶**: é™åˆ¶è·å–1000æ¡è®°å½•è¿›è¡Œå®¢æˆ·ç«¯ç­›é€‰
2. **åˆ†é¡µå¤„ç†**: ç­›é€‰åé‡æ–°è®¡ç®—åˆ†é¡µ
3. **çŠ¶æ€ç®¡ç†**: æ­£ç¡®ç»´æŠ¤ç­›é€‰çŠ¶æ€å’Œåˆ†é¡µçŠ¶æ€

## ğŸ“‹ ä¿®å¤æ¸…å•

- [x] ä¿®æ”¹æ•°æ®è·å–é€»è¾‘ï¼Œå¢åŠ æ•°æ®é‡
- [x] æ·»åŠ è¿å•ç¼–å·ç­›é€‰é€»è¾‘
- [x] æ·»åŠ å¸æœºå§“åç­›é€‰é€»è¾‘
- [x] æ·»åŠ è½¦ç‰Œå·ç­›é€‰é€»è¾‘
- [x] æ·»åŠ å¸æœºç”µè¯ç­›é€‰é€»è¾‘
- [x] æ·»åŠ å¸æœºåº”æ”¶ç­›é€‰é€»è¾‘
- [x] ä¿®å¤å…¨é€‰æ¨¡å¼ä¸‹çš„ç­›é€‰é€»è¾‘
- [x] å®ç°åˆ†é¡µå¤„ç†
- [x] éªŒè¯è¯­æ³•æ­£ç¡®æ€§

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ é«˜çº§ç­›é€‰è¾“å…¥æ— æ•ˆ
- âŒ ç­›é€‰æ¡ä»¶ä¸ç”Ÿæ•ˆ
- âŒ å…¨é€‰æ¨¡å¼ç­›é€‰å¤±è´¥

### ä¿®å¤å
- âœ… è¿å•ç¼–å·ç­›é€‰æ­£å¸¸å·¥ä½œ
- âœ… å¸æœºå§“åç­›é€‰æ­£å¸¸å·¥ä½œ
- âœ… è½¦ç‰Œå·ç­›é€‰æ­£å¸¸å·¥ä½œ
- âœ… å¸æœºç”µè¯ç­›é€‰æ­£å¸¸å·¥ä½œ
- âœ… å¸æœºåº”æ”¶ç­›é€‰æ­£å¸¸å·¥ä½œ
- âœ… å…¨é€‰æ¨¡å¼ç­›é€‰æ­£å¸¸å·¥ä½œ
- âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ

## ğŸš€ éƒ¨ç½²çŠ¶æ€

- **å¼€å‘ç¯å¢ƒ**: âœ… å·²ä¿®å¤
- **ä»£ç è´¨é‡**: âœ… æ— è¯­æ³•é”™è¯¯
- **åŠŸèƒ½éªŒè¯**: âœ… é«˜çº§ç­›é€‰æ­£å¸¸å·¥ä½œ
- **æ€§èƒ½æµ‹è¯•**: âœ… å®¢æˆ·ç«¯ç­›é€‰æ€§èƒ½è‰¯å¥½

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®é‡é™åˆ¶**: å®¢æˆ·ç«¯ç­›é€‰é™åˆ¶åœ¨1000æ¡è®°å½•å†…
2. **æ€§èƒ½è€ƒè™‘**: å¤§é‡æ•°æ®æ—¶å»ºè®®ä½¿ç”¨åç«¯ç­›é€‰
3. **ç­›é€‰é€»è¾‘**: ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…ï¼Œæ”¯æŒéƒ¨åˆ†åŒ¹é…
4. **åˆ†é¡µå¤„ç†**: ç­›é€‰åé‡æ–°è®¡ç®—æ€»é¡µæ•°

---

**ä¿®å¤æ—¶é—´**: 2025-01-16  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… å·²é€šè¿‡  
**éƒ¨ç½²çŠ¶æ€**: âœ… å·²éƒ¨ç½²
