# 开票申请管理功能

## 📋 功能概述

新增开票申请管理功能，实现基于合作方成本记录的开票申请流程，与现有 `invoice_records` 表完美整合。

## 🎯 核心特点

- ✅ **操作对象**: 合作方成本记录 (`logistics_partner_costs`)
- ✅ **申请流程**: 申请 → 审批 → 完成开票
- ✅ **状态管理**: 合作方级别的精确状态控制
- ✅ **向后兼容**: 保持现有开票功能不变
- ✅ **自动整合**: 完成开票时自动创建 `invoice_records` 记录

## 🚀 部署方式

### 方式1：Supabase SQL编辑器（推荐）
1. 打开 Supabase 控制台 → SQL 编辑器
2. 复制 `supabase_sql_commands.sql` 文件的全部内容
3. 粘贴到 SQL 编辑器中执行

### 方式2：Supabase CLI
```bash
supabase db push
```

## 🗃️ 数据库变更

### 新增表
- `invoice_requests` - 开票申请表
- `invoice_request_details` - 开票申请明细表

### 新增字段
- `logistics_partner_costs.invoice_status` - 开票状态
- `logistics_partner_costs.payment_status` - 付款状态
- `logistics_partner_costs.invoice_request_id` - 关联申请ID
- 相关时间戳字段

### 新增函数
- `get_invoice_request_data()` - 获取开票申请数据
- `save_invoice_request()` - 保存开票申请
- `approve_invoice_request()` - 审批开票申请
- `complete_invoice_request()` - 完成开票
- `delete_invoice_request()` - 删除开票申请

## 🔄 业务流程

```
1. 选择合作方成本记录 → 创建开票申请
2. 管理员审批申请 → 批准/拒绝
3. 财务完成开票 → 自动创建 invoice_records 记录
4. 状态同步更新 → 完整的审计轨迹
```

## 📱 前端功能

- **页面路径**: `/invoice-request`
- **权限要求**: `admin`, `finance` 角色
- **主要功能**: 
  - 合作方成本记录列表
  - 批量开票申请创建
  - 开票申请预览确认
  - 详细信息查看

## 🧪 验证部署

执行以下SQL验证部署结果：

```sql
-- 检查新字段
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'logistics_partner_costs' 
AND column_name IN ('invoice_status', 'payment_status');

-- 检查新表
SELECT table_name FROM information_schema.tables 
WHERE table_name IN ('invoice_requests', 'invoice_request_details');

-- 测试函数
SELECT generate_invoice_request_number();
```

## 🎉 部署完成

部署成功后，开票申请管理功能将完全可用，与现有系统无缝整合！
