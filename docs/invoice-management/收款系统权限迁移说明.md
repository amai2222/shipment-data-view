# æ”¶æ¬¾ç³»ç»Ÿæƒé™è¿ç§»è¯´æ˜

## ğŸ“‹ è¿ç§»æ¦‚è¿°

å°†æ”¶æ¬¾ç³»ç»Ÿçš„æƒé™æ£€æŸ¥ä»ç¡¬ç¼–ç è§’è‰²æ£€æŸ¥ï¼ˆ`is_finance_or_admin()`ï¼‰è¿ç§»åˆ°ç»Ÿä¸€æƒé™ç³»ç»Ÿï¼ˆ`has_function_permission()`ï¼‰ã€‚

## ğŸ¯ è¿ç§»ç›®æ ‡

- âœ… ç§»é™¤æ‰€æœ‰ç¡¬ç¼–ç çš„è§’è‰²æ£€æŸ¥
- âœ… ä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿ `has_function_permission()`
- âœ… æ‰€æœ‰æƒé™å¯é€šè¿‡æ•°æ®åº“é…ç½®ï¼ˆ`role_permission_templates` å’Œ `user_permissions` è¡¨ï¼‰
- âœ… æ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶

## ğŸ“ æƒé™é”®å®šä¹‰

### æ”¶æ¬¾ç›¸å…³æƒé™

| æƒé™é”® | åŠŸèƒ½ | å‡½æ•° |
|--------|------|------|
| `finance.receive_payment` | è´¢åŠ¡æ”¶æ¬¾ | `receive_invoice_payment_1114` |
| `finance.refund_receipt` | é€€æ¬¾ | `refund_invoice_receipt_1114` |
| `finance.reconcile_receipt` | å¯¹è´¦ | `reconcile_invoice_receipt_1114` |
| `finance.send_reminders` | å‘é€æé†’ | `send_receipt_reminders_1114` |
| `finance.view_receipt_statistics` | æŸ¥çœ‹ç»Ÿè®¡ | `get_receipt_statistics_1114` |
| `finance.view_receipt_report` | æŸ¥çœ‹æŠ¥è¡¨ | `get_receipt_details_report_1114` |
| `finance.view_receipt_records` | æŸ¥çœ‹è®°å½• | `get_receipt_records_1114` |

### ä½™é¢ç®¡ç†æƒé™

| æƒé™é”® | åŠŸèƒ½ | å‡½æ•° |
|--------|------|------|
| `finance.manual_recharge` | æ‰‹åŠ¨å……å€¼ | `manual_recharge_partner_balance` |
| `finance.deduct_service_fee` | æ‰£å‡æœåŠ¡è´¹ | `deduct_service_fee` |
| `finance.deduct_overdue_fee` | æ‰£å‡é€¾æœŸè´¹ | `deduct_overdue_fee` |
| `finance.deduct_partner_fee` | æ‰£å‡è´¹ç”¨ | `deduct_partner_fee` |

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1ï¼šæ‰§è¡Œæƒé™è¿ç§»SQL

```sql
-- æ–‡ä»¶ï¼šsupabase/migrations/20251114_migrate_receipt_permissions_to_unified_system.sql
```

è¿™ä¸ªæ–‡ä»¶ä¼šï¼š
1. æ›´æ–°æ‰€æœ‰æ”¶æ¬¾ç›¸å…³å‡½æ•°ï¼Œä½¿ç”¨ `has_function_permission()` æ£€æŸ¥æƒé™
2. ä¸º `finance` è§’è‰²è‡ªåŠ¨é…ç½®æ‰€æœ‰æ”¶æ¬¾ç›¸å…³æƒé™
3. `admin` è§’è‰²è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ˆå·²åœ¨ `has_function_permission()` ä¸­å®ç°ï¼‰

### æ­¥éª¤2ï¼šéªŒè¯è¿ç§»ç»“æœ

æ‰§è¡Œä»¥ä¸‹SQLéªŒè¯ï¼š

```sql
-- 1. æ£€æŸ¥å‡½æ•°æ˜¯å¦å·²æ›´æ–°
SELECT routine_name, routine_definition
FROM information_schema.routines
WHERE routine_name IN (
    'receive_invoice_payment_1114',
    'refund_invoice_receipt_1114',
    'reconcile_invoice_receipt_1114',
    'send_receipt_reminders_1114',
    'get_receipt_statistics_1114',
    'get_receipt_details_report_1114',
    'get_receipt_records_1114',
    'manual_recharge_partner_balance',
    'deduct_service_fee',
    'deduct_overdue_fee',
    'deduct_partner_fee'
)
AND routine_schema = 'public';

-- 2. æ£€æŸ¥æƒé™é…ç½®
SELECT role, function_permissions
FROM role_permission_templates
WHERE role = 'finance';

-- 3. æµ‹è¯•æƒé™æ£€æŸ¥
SELECT has_function_permission('finance.receive_payment');
```

## ğŸ“Š æƒé™é…ç½®ç¤ºä¾‹

### ä¸ºè§’è‰²é…ç½®æƒé™

```sql
-- ä¸º finance è§’è‰²æ·»åŠ æ”¶æ¬¾æƒé™ï¼ˆè¿ç§»SQLä¼šè‡ªåŠ¨æ‰§è¡Œï¼‰
UPDATE role_permission_templates
SET function_permissions = array_append(
    COALESCE(function_permissions, ARRAY[]::TEXT[]),
    'finance.receive_payment',
    'finance.refund_receipt',
    'finance.reconcile_receipt'
)
WHERE role = 'finance';
```

### ä¸ºç”¨æˆ·é…ç½®è‡ªå®šä¹‰æƒé™

```sql
-- ä¸ºç‰¹å®šç”¨æˆ·æˆäºˆæ”¶æ¬¾æƒé™ï¼ˆä¸æ”¹å˜è§’è‰²ï¼‰
INSERT INTO user_permissions (user_id, function_permissions)
VALUES (
    'user-uuid-here',
    ARRAY['finance.receive_payment', 'finance.view_receipt_records']
)
ON CONFLICT (user_id) 
DO UPDATE SET 
    function_permissions = array_agg(DISTINCT elem)
    FROM (
        SELECT unnest(COALESCE(user_permissions.function_permissions, ARRAY[]::TEXT[])) AS elem
        UNION
        SELECT unnest(ARRAY['finance.receive_payment', 'finance.view_receipt_records'])
    ) AS combined;
```

### ç§»é™¤ç”¨æˆ·æƒé™

```sql
-- ç§»é™¤ç”¨æˆ·çš„æ”¶æ¬¾æƒé™
UPDATE user_permissions
SET function_permissions = array_remove(
    function_permissions,
    'finance.receive_payment'
)
WHERE user_id = 'user-uuid-here';
```

## âœ… è¿ç§»å‰åå¯¹æ¯”

### è¿ç§»å‰ï¼ˆç¡¬ç¼–ç ï¼‰

```sql
-- ç¡¬ç¼–ç è§’è‰²æ£€æŸ¥
IF NOT public.is_finance_or_admin() THEN
    RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šåªæœ‰è´¢åŠ¡äººå‘˜æˆ–ç®¡ç†å‘˜å¯ä»¥ç™»è®°æ”¶æ¬¾';
END IF;
```

**é—®é¢˜**ï¼š
- âŒ åªèƒ½æ£€æŸ¥ `admin` æˆ– `finance` è§’è‰²
- âŒ æ— æ³•é€šè¿‡æƒé™è¡¨é…ç½®
- âŒ ä¸æ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶

### è¿ç§»åï¼ˆç»Ÿä¸€æƒé™ç³»ç»Ÿï¼‰

```sql
-- ä½¿ç”¨ç»Ÿä¸€æƒé™ç³»ç»Ÿ
IF NOT public.has_function_permission('finance.receive_payment') THEN
    RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šæ‚¨æ²¡æœ‰è´¢åŠ¡æ”¶æ¬¾æƒé™ã€‚éœ€è¦ finance.receive_payment æƒé™';
END IF;
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ”¯æŒè§’è‰²æ¨¡æ¿æƒé™ï¼ˆ`role_permission_templates`ï¼‰
- âœ… æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æƒé™ï¼ˆ`user_permissions`ï¼‰
- âœ… æ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶
- âœ… `admin` è§’è‰²è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™
- âœ… å¯é€šè¿‡æ•°æ®åº“é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 

## ğŸ”§ å…¼å®¹æ€§è¯´æ˜

### admin è§’è‰²

- `admin` è§’è‰²åœ¨ `has_function_permission()` å‡½æ•°ä¸­è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™
- æ— éœ€é¢å¤–é…ç½®

### finance è§’è‰²

- è¿ç§»SQLä¼šè‡ªåŠ¨ä¸º `finance` è§’è‰²é…ç½®æ‰€æœ‰æ”¶æ¬¾ç›¸å…³æƒé™
- å¦‚æœ `finance` è§’è‰²ä¸å­˜åœ¨ï¼Œä¼šåˆ›å»ºæ–°çš„æƒé™æ¨¡æ¿

### å…¶ä»–è§’è‰²

- å¯ä»¥é€šè¿‡ `role_permission_templates` è¡¨ä¸ºå…¶ä»–è§’è‰²é…ç½®æƒé™
- å¯ä»¥é€šè¿‡ `user_permissions` è¡¨ä¸ºç‰¹å®šç”¨æˆ·é…ç½®æƒé™

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ‰§è¡Œé¡ºåº**ï¼š
   - å…ˆæ‰§è¡Œ `20251114_merged_all_receipt_and_balance_functions.sql`ï¼ˆåˆ›å»ºåŸºç¡€åŠŸèƒ½ï¼‰
   - å†æ‰§è¡Œ `20251114_migrate_receipt_permissions_to_unified_system.sql`ï¼ˆè¿ç§»æƒé™ï¼‰

2. **å‘åå…¼å®¹**ï¼š
   - è¿ç§»åï¼Œæ‰€æœ‰ `finance` è§’è‰²ç”¨æˆ·ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨æ”¶æ¬¾åŠŸèƒ½
   - `admin` è§’è‰²ç”¨æˆ·è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™

3. **æƒé™éªŒè¯**ï¼š
   - è¿ç§»åï¼Œå‰ç«¯ä»ç„¶éœ€è¦æ£€æŸ¥ç”¨æˆ·è§’è‰²
   - åç«¯å‡½æ•°ä¼šè‡ªåŠ¨éªŒè¯æƒé™ï¼Œæ— éœ€å‰ç«¯é¢å¤–å¤„ç†

## ğŸ“ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šæƒé™æ£€æŸ¥å¤±è´¥

**é”™è¯¯**ï¼š`æƒé™ä¸è¶³ï¼šæ‚¨æ²¡æœ‰è´¢åŠ¡æ”¶æ¬¾æƒé™`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦ä¸º `admin`ï¼ˆè‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼‰
2. æ£€æŸ¥ `role_permission_templates` è¡¨ä¸­æ˜¯å¦æœ‰ `finance` è§’è‰²çš„æƒé™é…ç½®
3. æ£€æŸ¥ `user_permissions` è¡¨ä¸­æ˜¯å¦æœ‰ç”¨æˆ·çš„è‡ªå®šä¹‰æƒé™é…ç½®

### é—®é¢˜2ï¼šå‡½æ•°æœªæ›´æ–°

**é”™è¯¯**ï¼šå‡½æ•°ä»ç„¶ä½¿ç”¨ `is_finance_or_admin()`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤å·²æ‰§è¡Œ `20251114_migrate_receipt_permissions_to_unified_system.sql`
2. æ£€æŸ¥å‡½æ•°å®šä¹‰ï¼š
   ```sql
   SELECT pg_get_functiondef(oid)
   FROM pg_proc
   WHERE proname = 'receive_invoice_payment_1114';
   ```

### é—®é¢˜3ï¼šæƒé™é…ç½®æœªç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `has_function_permission()` å‡½æ•°æ˜¯å¦å­˜åœ¨
2. éªŒè¯æƒé™é”®æ˜¯å¦æ­£ç¡®ï¼ˆå¦‚ `finance.receive_payment`ï¼‰
3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼ˆ`auth.uid()` ä¸ä¸º NULLï¼‰

---

**æœ€åæ›´æ–°**ï¼š2025-11-14

