# 开票申请函数重载冲突修复说明

## 🐛 错误信息

```
Could not choose the best candidate function between:
  public.save_invoice_request(p_invoice_data => json)
  public.save_invoice_request(p_invoice_data => jsonb)
```

## 📍 问题分析

### 根本原因

数据库中存在**两个**同名函数 `save_invoice_request`，但参数类型不同：
- 一个接受 `json` 类型参数
- 一个接受 `jsonb` 类型参数

当前端调用时，PostgreSQL无法确定使用哪个函数，导致报错。

### 为什么会有两个函数？

可能原因：
1. 历史遗留：之前的迁移创建了json版本
2. 后续更新：新的迁移创建了jsonb版本
3. 未清理：旧版本未被删除

### 调用代码

```typescript
// src/pages/InvoiceRequest.tsx
const { data, error } = await supabase.rpc('save_invoice_request', {
  p_invoice_data: invoiceData  // ← PostgreSQL不知道用哪个函数
});
```

---

## ✅ 解决方案

### 修复策略

**删除所有版本，只保留一个jsonb版本**

**原因选择jsonb：**
- jsonb是PostgreSQL推荐的二进制JSON格式
- 性能更好
- 支持索引
- 是现代PostgreSQL的标准

### 修复步骤

```sql
-- 1. 删除所有可能的重载版本
DROP FUNCTION IF EXISTS public.save_invoice_request(json);
DROP FUNCTION IF EXISTS public.save_invoice_request(jsonb);
DROP FUNCTION IF EXISTS public.save_invoice_request(p_invoice_data json);
DROP FUNCTION IF EXISTS public.save_invoice_request(p_invoice_data jsonb);

-- 2. 重新创建唯一版本（jsonb）
CREATE OR REPLACE FUNCTION public.save_invoice_request(p_invoice_data jsonb)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
AS $function$
  -- 函数实现...
$function$;
```

---

## 🔧 修复文件

**文件名：** `supabase/migrations/20250816_fix_invoice_request_function_overload.sql`

**修复内容：**
1. 删除所有版本的 `save_invoice_request` 函数
2. 重新创建唯一的jsonb版本
3. 添加完整的函数实现
4. 添加注释说明

---

## 📋 函数功能说明

### save_invoice_request 函数

**功能：** 创建开票申请

**参数：**
```typescript
p_invoice_data: {
  sheets: [
    {
      invoicing_partner_id: string,
      invoicing_partner_full_name: string,
      total_invoiceable: number,
      partner_costs: [
        {
          id: string,  // logistics_partner_cost_id
          ...
        }
      ]
    }
  ],
  all_partner_cost_ids: string[]
}
```

**返回值：**
```typescript
{
  success: true,
  created_requests: [
    {
      request_id: string,
      request_number: string,  // INV-20250816-0001
      partner_name: string,
      total_amount: number
    }
  ],
  total_requests: number
}
```

**处理逻辑：**
1. 验证用户权限（财务或管理员）
2. 验证合作方成本未开票
3. 为每个开票合作方创建开票申请
4. 生成开票申请编号（INV-YYYYMMDD-XXXX）
5. 插入开票明细记录
6. 更新合作方成本的开票状态为"Requested"
7. 返回创建结果

---

## 🎯 相关表结构

### invoice_requests表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| request_number | TEXT | 申请编号 |
| invoicing_partner_id | UUID | 开票合作方ID |
| invoicing_partner_full_name | TEXT | 合作方全名 |
| total_amount | NUMERIC | 总金额 |
| status | TEXT | 状态 |
| created_by | UUID | 创建人 |
| user_id | UUID | 用户ID |

### partner_invoice_items表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| invoice_request_id | UUID | 开票申请ID |
| logistics_partner_cost_id | UUID | 合作方成本ID |
| user_id | UUID | 用户ID |

### logistics_partner_costs表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| logistics_record_id | UUID | 运单ID |
| partner_id | UUID | 合作方ID |
| payable_amount | NUMERIC | 应付金额 |
| invoice_status | TEXT | 开票状态 |

---

## 🚀 应用修复

### 步骤

1. **应用迁移文件**
   ```bash
   # 在Supabase SQL Editor中执行
   # 或使用 CLI: supabase db push
   ```

2. **验证修复**
   ```sql
   -- 检查save_invoice_request函数
   SELECT 
     proname AS 函数名,
     pg_get_function_arguments(oid) AS 参数,
     pg_get_function_result(oid) AS 返回值
   FROM pg_proc 
   WHERE proname = 'save_invoice_request';
   
   -- 应该只返回一行结果
   ```

3. **测试功能**
   - 选择运单
   - 点击"开票申请"
   - 查看预览
   - 点击"保存开票申请" ← 应该成功

---

## 📊 需要应用的迁移文件汇总

现在共有**3个迁移文件**需要应用：

| # | 文件名 | 修复内容 | 优先级 |
|---|--------|---------|--------|
| 1 | `20250816_fix_driver_project_association_in_import.sql` | 司机项目关联 | 中 |
| 2 | `20250816_fix_payment_request_notification_trigger.sql` | 付款申请通知触发器 | 高 |
| 3 | `20250816_fix_invoice_request_function_overload.sql` | 开票申请函数重载冲突 | **🔴 高** |

---

## ⚠️ 注意事项

### 关于函数重载

**PostgreSQL的函数重载规则：**
- 允许同名函数，但参数数量或类型必须不同
- json 和 jsonb 被认为是"相似"类型
- 调用时如果参数类型模糊，会报错

**避免冲突的方法：**
1. 使用不同的函数名
2. 或只保留一个版本（推荐）
3. 或显式指定参数类型

### 关于json vs jsonb

**推荐使用jsonb：**
- ✅ 二进制存储，性能更好
- ✅ 支持索引
- ✅ 支持更多操作符
- ✅ PostgreSQL推荐

**json的使用场景：**
- 需要保留原始格式
- 不需要查询内部字段
- 仅用于存储和传输

---

## 🧪 测试清单

### 开票申请功能测试

- [ ] 可以选择运单
- [ ] 可以点击"一键开票申请"
- [ ] 可以查看开票预览
- [ ] 显示合作方列表
- [ ] 显示运单数量和金额
- [ ] 点击"保存开票申请"成功
- [ ] 不再出现函数重载错误
- [ ] 开票申请成功创建
- [ ] 运单状态更新为"已申请开票"

---

## 📝 相关错误修复

今天修复的所有问题：

1. ✅ 运单编辑验证逻辑
2. ✅ TypeScript类型定义
3. ✅ 司机搜索功能
4. ✅ Excel导入司机项目关联
5. ✅ 运单管理导入功能移除
6. ✅ 运单维护增强版验重
7. ✅ 强制导入重复可勾选
8. ✅ **付款申请通知触发器** ← 刚修复
9. ✅ **开票申请函数重载冲突** ← 当前修复

---

**修复文件：** `supabase/migrations/20250816_fix_invoice_request_function_overload.sql`  
**错误级别：** 🔴 高（阻止开票申请创建）  
**修复状态：** ✅ 已创建修复迁移  
**需要应用：** 是

