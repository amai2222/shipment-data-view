# 收款系统功能入口总结

## 📋 文档说明

本文档详细列出了收款系统和货主余额系统的所有新增页面、功能入口、菜单配置和权限要求。

**创建日期**：2025-11-14  
**最后更新**：2025-11-14

---

## 🎯 新增功能概览

### 1. 收款管理系统
- **收款记录管理**：记录每笔收款，支持部分收款、退款、对账
- **收款提醒**：自动发送逾期提醒通知
- **收款报表**：统计分析和详细报表
- **收款对账**：财务对账功能

### 2. 货主余额系统
- **余额查询**：实时查看货主账户余额
- **交易记录**：查看所有余额变动历史
- **手动充值**：财务人员为货主充值
- **费用扣除**：服务费、逾期费等自动扣除

### 3. 货主移动端应用
- **货主首页**：余额概览、待付款提醒
- **待付款列表**：查看待付款申请单
- **充值功能**：货主自主充值
- **提交收款凭证**：上传银行回单通知财务
- **运单查询**：查询相关运单信息
- **交易记录**：查看余额变动历史

---

## 🖥️ PC端页面入口

### 1. 收款报表 (`/finance/receipt-report`)

**菜单位置**：`财务管理` → `收款报表`

**权限要求**：`finance.receipt_report`

**功能说明**：
- 收款统计概览（总收款、待收款、已收款等）
- 收款明细列表（支持筛选、搜索、分页）
- 收款趋势分析
- 导出收款报表

**路由配置**：
```typescript
<Route path="/finance/receipt-report" element={
  <ProtectedRoute requiredPermission="finance.receipt_report">
    <AppLayout><ReceiptReport /></AppLayout>
  </ProtectedRoute>
} />
```

---

### 2. 货主余额 (`/partner-balance`)

**菜单位置**：`财务管理` → `货主余额`

**权限要求**：`finance.partner_balance`

**功能说明**：
- 货主余额查询（支持按货主筛选）
- 余额交易记录列表
- 手动充值功能（财务人员）
- 费用扣除功能（服务费、逾期费等）
- 余额变动统计

**路由配置**：
```typescript
<Route path="/partner-balance" element={
  <ProtectedRoute requiredPermission="finance.partner_balance">
    <AppLayout><PartnerBalance /></AppLayout>
  </ProtectedRoute>
} />
```

**其他入口**：
- 从 `合作方管理` (`/partners`) 页面，点击货主的"账号余额"列，可跳转到该货主的余额详情页

---

### 3. 财务收款 (`/finance/payment-invoice`)

**菜单位置**：`财务管理` → `财务收款`

**权限要求**：`finance.payment_invoice`

**功能说明**：
- **收款功能**：对已开票的申请单进行收款操作
  - 收款金额（默认填充开票金额，支持部分收款）
  - 收款单号
  - 收款银行
  - 收款凭证（支持多张图片上传）
  - 备注信息
- **退款功能**：对已收款进行退款操作
- **对账功能**：标记申请单为已对账状态
- **收款记录查看**：查看每个申请单的收款历史记录
- **筛选和搜索**：支持按申请单号、运单号、司机、状态等筛选

**路由配置**：
```typescript
<Route path="/finance/payment-invoice" element={
  <ProtectedRoute requiredPermission="finance.payment_invoice">
    <AppLayout><PaymentInvoice /></AppLayout>
  </ProtectedRoute>
} />
```

**相关RPC函数**：
- `receive_invoice_payment_1114`：收款
- `refund_invoice_receipt_1114`：退款
- `reconcile_invoice_receipt_1114`：对账
- `get_receipt_records_1114`：获取收款记录

---

## 📱 移动端页面入口

### 1. 收款报表（移动端）(`/m/finance/receipt-report`)

**菜单位置**：`财务管理` → `收款报表`

**权限要求**：`finance.receipt_report`

**路由配置**：
```typescript
<Route path="/m/finance/receipt-report" element={
  <ProtectedRoute requiredPermission="finance.receipt_report">
    <MobileLayout><ReceiptReport /></MobileLayout>
  </ProtectedRoute>
} />
```

---

### 2. 货主余额（移动端）(`/m/partner-balance`)

**菜单位置**：`财务管理` → `货主余额`

**权限要求**：`finance.partner_balance`

**路由配置**：
```typescript
<Route path="/m/partner-balance" element={
  <ProtectedRoute requiredPermission="finance.partner_balance">
    <MobileLayout><PartnerBalance /></MobileLayout>
  </ProtectedRoute>
} />
```

---

### 3. 货主移动端应用（`/m/shipper/*`）

**适用角色**：`partner`（货主）

**入口路径**：`/m/shipper`

**菜单结构**：
- **首页** (`/m/shipper`)
  - 余额概览
  - 待付款提醒
  - 快捷操作入口

- **待付款列表** (`/m/shipper/pending-payments`)
  - 查看所有待付款申请单
  - 点击查看详情
  - 支持搜索和筛选

- **充值** (`/m/shipper/recharge`)
  - 快速金额选择
  - 自定义金额输入
  - 提交充值申请

- **提交收款凭证** (`/m/shipper/submit-receipt`)
  - 选择申请单
  - 上传银行回单图片（多张）
  - 填写收款信息
  - 提交通知财务

- **运单查询** (`/m/shipper/waybills`)
  - 查询相关运单
  - 查看运单详情

- **交易记录** (`/m/shipper/transactions`)
  - 查看余额变动历史
  - 按类型筛选（充值、扣款、退款等）

- **设置** (`/m/shipper/settings`)
  - 账户信息
  - 退出登录

**路由配置**：
```typescript
<Route path="/m/shipper" element={<MobileShipperHome />} />
<Route path="/m/shipper/pending-payments" element={<MobileShipperPendingPayments />} />
<Route path="/m/shipper/pending-payments/:id" element={<MobileShipperPendingPayments />} />
<Route path="/m/shipper/recharge" element={<MobileShipperRecharge />} />
<Route path="/m/shipper/submit-receipt" element={<MobileShipperSubmitReceipt />} />
<Route path="/m/shipper/waybills" element={<MobileShipperWaybills />} />
<Route path="/m/shipper/transactions" element={<MobileShipperTransactions />} />
<Route path="/m/shipper/settings" element={<MobileShipperSettings />} />
```

**权限检查**：
- 货主移动端页面使用 `ShipperMobileLayout` 组件
- 自动检查用户角色是否为 `partner`
- 自动检查用户是否关联了货主合作方
- 未满足条件时显示无权限提示

---

## 🔐 权限配置

### 权限键列表

| 权限键 | 权限名称 | 说明 | 默认角色 |
|--------|---------|------|---------|
| `finance.receipt_report` | 收款报表 | 查看收款报表和分析 | `finance`, `admin` |
| `finance.partner_balance` | 货主余额 | 查看和管理货主余额 | `finance`, `admin` |
| `finance.payment_invoice` | 付款与开票 | 财务收款功能（集成在财务开票页面） | `finance`, `admin` |

### 函数权限（RPC函数）

以下RPC函数使用统一权限系统检查：

| 函数名 | 权限键 | 说明 |
|--------|--------|------|
| `receive_invoice_payment_1114` | `finance.receive_payment` | 收款 |
| `refund_invoice_receipt_1114` | `finance.refund_receipt` | 退款 |
| `reconcile_invoice_receipt_1114` | `finance.reconcile_receipt` | 对账 |
| `manual_recharge_partner_balance` | `finance.manual_recharge` | 手动充值 |
| `deduct_service_fee` | `finance.deduct_service_fee` | 扣除服务费 |
| `deduct_overdue_fee` | `finance.deduct_overdue_fee` | 扣除逾期费 |
| `deduct_partner_fee` | `finance.deduct_partner_fee` | 扣除其他费用 |
| `send_receipt_reminders_1114` | `finance.send_reminders` | 发送收款提醒 |
| `get_receipt_records_1114` | `finance.view_receipt_records` | 查看收款记录 |
| `get_receipt_statistics_1114` | `finance.view_receipt_statistics` | 查看收款统计 |
| `get_receipt_details_report_1114` | `finance.view_receipt_report` | 查看收款报表 |

**注意**：所有函数权限都通过 `has_function_permission()` 统一检查，不再使用硬编码的 `is_finance_or_admin()`。

---

## 📊 数据库表结构

### 新增表

1. **`partner_balance`**：货主余额表
   - `partner_id`：货主ID
   - `balance`：当前余额
   - `updated_at`：最后更新时间

2. **`partner_balance_transactions`**：余额交易记录表
   - `partner_id`：货主ID
   - `amount`：交易金额
   - `transaction_type`：交易类型（`recharge`/`deduct`）
   - `transaction_category`：交易类别（`invoice_receipt`/`manual_recharge`/`waybill`/`service_fee`/`overdue_fee`/`refund`/`other`）
   - `reference_type`：关联类型
   - `reference_id`：关联ID
   - `description`：描述

3. **`invoice_receipt_records`**：收款记录表
   - `invoice_request_id`：开票申请单ID
   - `received_amount`：收款金额
   - `receipt_number`：收款单号
   - `receipt_bank`：收款银行
   - `receipt_images`：收款凭证图片
   - `notes`：备注
   - `created_by`：创建人

### 扩展表

1. **`invoice_requests`**：新增字段
   - `receipt_number`：收款单号
   - `receipt_bank`：收款银行
   - `total_received_amount`：累计收款金额
   - `payment_due_date`：收款期限
   - `overdue_days`：逾期天数
   - `reminder_count`：提醒次数
   - `last_reminder_at`：最后提醒时间
   - `reconciliation_status`：对账状态
   - `reconciliation_date`：对账日期
   - `reconciliation_by`：对账人
   - `reconciliation_notes`：对账备注

2. **`logistics_records`**：新增字段
   - `receipt_status`：收款状态（`Unreceived`/`Received`）

---

## 🔧 SQL迁移文件

### 执行顺序

请按以下顺序执行SQL迁移文件：

1. **主迁移文件**（必须）
2. **权限迁移文件**（必须）
3. **菜单配置文件**（必须）

---

### 1. 主迁移文件

**文件路径**：`supabase/migrations/20251114_merged_all_receipt_and_balance_functions.sql`

**包含内容**：
- 所有数据库表结构（新建和扩展）
- 所有RPC函数（带 `_1114` 后缀）
- 所有触发器
- 所有注释和说明

**执行步骤**：
1. 在Supabase Dashboard中打开SQL Editor
2. 复制整个迁移文件内容
3. 执行SQL脚本
4. 检查是否有错误（如有，根据错误信息修复）

---

### 2. 权限迁移文件

**文件路径**：`supabase/migrations/20251114_migrate_receipt_permissions_to_unified_system.sql`

**包含内容**：
- 将所有硬编码的 `is_finance_or_admin()` 替换为 `has_function_permission()`
- 自动为 `finance` 角色配置所有新权限

**执行步骤**：
1. 在主迁移文件执行成功后执行
2. 确保 `finance` 角色已正确配置权限

---

### 3. 菜单配置文件（新增）

**文件路径**：`supabase/migrations/20251114_add_receipt_and_balance_menu.sql`

**包含内容**：
- 添加"收款报表"菜单（`finance.receipt_report`）
- 添加"货主余额"菜单（`finance.partner_balance`）
- 更新"财务收款"菜单标题（从"付款开票"改为"财务收款"）
- 自动同步管理员权限

**执行步骤**：
1. 在权限迁移文件执行成功后执行
2. 验证菜单是否成功添加

**验证SQL**：
```sql
-- 检查菜单是否添加成功
SELECT key, title, url, is_active 
FROM menu_config 
WHERE key IN ('finance.receipt_report', 'finance.partner_balance', 'finance.payment_invoice')
ORDER BY order_index;

-- 应该看到3条记录：
-- finance.payment_invoice | 财务收款 | /finance/payment-invoice
-- finance.receipt_report   | 收款报表 | /finance/receipt-report
-- finance.partner_balance  | 货主余额 | /partner-balance
```

**注意**：
- 如果菜单已存在，SQL会跳过插入（使用 `WHERE NOT EXISTS`）
- 执行后会自动同步管理员权限
- 其他角色需要手动在"角色模板"中配置权限

---

## 🐛 已修复的问题

### 1. SQL函数错误修复

**问题**：`get_invoice_requests_filtered_1114` 函数中使用了不存在的 `lpc.partner_type` 列

**修复**：
- 通过 JOIN `partners` 表获取 `partner_type`
- 使用条件聚合 `SUM(CASE WHEN p.partner_type = '货主' THEN lpc.payable_amount ELSE 0 END)` 计算货主应付金额

**修复文件**：`supabase/migrations/20251114_merged_all_receipt_and_balance_functions.sql` (第1469-1474行)

---

### 2. 菜单权限映射修复

**问题**：`AppSidebar.tsx` 中缺少 `/finance/receipt-report` 和 `/partner-balance` 的权限键映射

**修复**：
- 在 `getMenuKey` 函数中添加了这两个路由的权限键映射
- 修复了PC端路由的权限检查（从 `finance.payment_invoice` 改为 `finance.receipt_report`）
- 添加了移动端收款报表路由

**修复文件**：
- `src/components/AppSidebar.tsx` (第160-161行)
- `src/App.tsx` (第439行, 第726-730行)

---

## 📝 使用说明

### 财务人员收款流程

1. **进入财务开票页面** (`/invoice-request-management`)
2. **选择申请单**，点击"收款"按钮
3. **填写收款信息**：
   - 收款金额（支持部分收款）
   - 收款单号
   - 收款银行
   - 上传收款凭证（多张图片）
   - 备注信息
4. **提交收款**，系统自动：
   - 更新申请单状态和收款金额
   - 更新运单收款状态
   - 增加货主余额（如果是货主应付）
   - 创建收款记录

### 货主使用流程

1. **登录系统**（角色：`partner`）
2. **查看余额**：在首页查看当前余额
3. **查看待付款**：进入"待付款列表"查看需要支付的申请单
4. **充值**：进入"充值"页面，选择金额或自定义金额
5. **提交收款凭证**：支付后，进入"提交收款凭证"，上传银行回单并填写信息，通知财务
6. **查看交易记录**：在"交易记录"中查看所有余额变动

### 财务查看报表

1. **进入收款报表** (`/finance/receipt-report`)
2. **查看统计概览**：总收款、待收款、已收款等
3. **筛选和搜索**：按日期、状态、货主等条件筛选
4. **查看明细**：点击申请单查看详细收款记录
5. **导出报表**：支持导出Excel报表

---

## ✅ 验证清单

- [x] PC端菜单已添加"收款报表"和"货主余额"
- [x] 移动端菜单已添加"收款报表"和"货主余额"
- [x] 所有路由已正确配置
- [x] 权限检查已配置
- [x] 货主移动端应用路由已配置
- [x] SQL函数错误已修复
- [x] 菜单权限映射已修复
- [x] 所有RPC函数已重命名（`_1114` 后缀）
- [x] 权限系统已迁移到统一权限系统

---

## 📞 技术支持

如有问题，请检查：
1. 数据库迁移是否成功执行
2. 权限配置是否正确
3. 用户角色是否正确
4. 浏览器控制台是否有错误信息

---

**文档版本**：v1.0  
**最后更新**：2025-11-14

