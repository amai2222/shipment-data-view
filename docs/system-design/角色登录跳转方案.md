# è§’è‰²ç™»å½•è·³è½¬æ–¹æ¡ˆ

## ğŸ¯ éœ€æ±‚

1. âœ… å¤ç”¨ç°æœ‰ç™»å½•ç³»ç»Ÿ
2. âœ… æ·»åŠ è½¦é˜Ÿé•¿ï¼ˆfleet_managerï¼‰å’Œå¸æœºï¼ˆdriverï¼‰è§’è‰²
3. âœ… ç™»å½•åæ ¹æ®è§’è‰²è‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”é¦–é¡µ

---

## ğŸ‘¥ è§’è‰²ä¸é»˜è®¤é¦–é¡µ

| è§’è‰² | è§’è‰²Key | é»˜è®¤é¦–é¡µï¼ˆPCç«¯ï¼‰ | é»˜è®¤é¦–é¡µï¼ˆç§»åŠ¨ç«¯ï¼‰ | è¯´æ˜ |
|-----|---------|--------------|--------------|------|
| ç®¡ç†å‘˜ | admin | `/` | `/m/` | è¿è¾“æ¦‚è§ˆ |
| è´¢åŠ¡ | finance | `/dashboard/financial` | `/m/dashboard/financial` | è´¢åŠ¡çœ‹æ¿ |
| ä¸šåŠ¡ | business | `/` | `/m/` | è¿è¾“æ¦‚è§ˆ |
| æ“ä½œå‘˜ | operator | `/business-entry` | `/m/business-entry` | è¿å•ç®¡ç† |
| æŸ¥çœ‹è€… | viewer | `/` | `/m/` | è¿è¾“æ¦‚è§ˆ |
| è´§ä¸» | partner | `/dashboard/shipper` | `/m/dashboard/shipper` | è´§ä¸»çœ‹æ¿ â­å·²å®ç° |
| **è½¦é˜Ÿé•¿** | **fleet_manager** | **/internal/vehicles** | **/m/internal/vehicles** | **è½¦è¾†ç®¡ç†** â­æ–°å¢ |
| **å¸æœº** | **driver** | **/internal/my-expenses** | **/m/internal/my-expenses** | **æˆ‘çš„è´¹ç”¨ç”³è¯·** â­æ–°å¢ |

---

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆï¼šä¿®æ”¹ Auth.tsx çš„è·³è½¬é€»è¾‘

**å‚è€ƒç°æœ‰çš„ partner è§’è‰²è·³è½¬**ï¼š

```typescript:29:39:src/pages/Auth.tsx
// å¦‚æœå·²ç»ç™»å½•ï¼Œæ ¹æ®è§’è‰²é‡å®šå‘åˆ°ç›®æ ‡é¡µé¢
if (user) {
  // ç‰¹æ®Šå¤„ç†ï¼špartnerï¼ˆè´§ä¸»ï¼‰è§’è‰²ç›´æ¥è·³è½¬åˆ°è´§ä¸»çœ‹æ¿
  if (profile?.role === 'partner') {
    // æ ¹æ®è®¾å¤‡ç±»å‹è·³è½¬åˆ°å¯¹åº”çš„è´§ä¸»çœ‹æ¿
    const shipperPath = isMobile() ? '/m/dashboard/shipper' : '/dashboard/shipper';
    return <Navigate to={shipperPath} replace />;
  }
  const from = location.state?.from?.pathname || '/';
  return <Navigate to={from} replace />;
}
```

**æ‰©å±•ä¸ºå¤šè§’è‰²è·³è½¬**ï¼š

```typescript
// å¦‚æœå·²ç»ç™»å½•ï¼Œæ ¹æ®è§’è‰²é‡å®šå‘åˆ°ç›®æ ‡é¡µé¢
if (user && profile) {
  // å®šä¹‰è§’è‰²é»˜è®¤é¦–é¡µ
  const roleHomePage: Record<string, { pc: string; mobile: string }> = {
    partner: {
      pc: '/dashboard/shipper',
      mobile: '/m/dashboard/shipper'
    },
    fleet_manager: {
      pc: '/internal/vehicles',
      mobile: '/m/internal/vehicles'
    },
    driver: {
      pc: '/internal/my-expenses',
      mobile: '/m/internal/my-expenses'
    },
    finance: {
      pc: '/dashboard/financial',
      mobile: '/m/dashboard/financial'
    },
    operator: {
      pc: '/business-entry',
      mobile: '/m/business-entry'
    }
  };
  
  // è·å–è¯¥è§’è‰²çš„é»˜è®¤é¦–é¡µ
  const defaultHome = roleHomePage[profile.role];
  
  if (defaultHome) {
    const targetPath = isMobile() ? defaultHome.mobile : defaultHome.pc;
    return <Navigate to={targetPath} replace />;
  }
  
  // å…¶ä»–è§’è‰²ä½¿ç”¨åŸæ¥çš„è·³è½¬é€»è¾‘
  const from = location.state?.from?.pathname || '/';
  return <Navigate to={from} replace />;
}
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šæ·»åŠ è§’è‰²åˆ°æ•°æ®åº“ âœ…

æ‰§è¡Œè¿ç§»è„šæœ¬ï¼š
```sql
-- supabase/migrations/20251104_add_fleet_manager_driver_roles.sql
ALTER TYPE app_role ADD VALUE 'fleet_manager';
ALTER TYPE app_role ADD VALUE 'driver';
```

### æ­¥éª¤2ï¼šæ›´æ–° TypeScript ç±»å‹å®šä¹‰

**æ–‡ä»¶**ï¼š`src/contexts/AuthContext.tsx`

```typescript
// ä¿®æ”¹ç¬¬13è¡Œ
export type UserRole = 'admin' | 'finance' | 'business' | 'partner' | 'operator' | 'viewer' | 'fleet_manager' | 'driver';
```

### æ­¥éª¤3ï¼šä¿®æ”¹ Auth.tsx è·³è½¬é€»è¾‘

**æ–‡ä»¶**ï¼š`src/pages/Auth.tsx`

æ·»åŠ è§’è‰²è·³è½¬æ˜ å°„è¡¨ï¼ˆè§ä¸Šé¢çš„ä»£ç ï¼‰

### æ­¥éª¤4ï¼šåˆ›å»ºæµ‹è¯•ç”¨æˆ·

```sql
-- åˆ›å»ºè½¦é˜Ÿé•¿æµ‹è¯•è´¦å·
INSERT INTO auth.users (email, encrypted_password) VALUES (...);
INSERT INTO profiles (id, email, full_name, role) 
VALUES (
    'xxx',
    'fleet_manager@test.com',
    'è½¦é˜Ÿé•¿å¼ ä¸‰',
    'fleet_manager'
);

-- åˆ›å»ºå¸æœºæµ‹è¯•è´¦å·
INSERT INTO profiles (id, email, full_name, role) 
VALUES (
    'xxx',
    'driver@test.com',
    'å¸æœºæå››',
    'driver'
);
```

---

## ğŸ¬ ç™»å½•æµç¨‹æ¼”ç¤º

### åœºæ™¯1ï¼šè½¦é˜Ÿé•¿ç™»å½•

```
1. æ‰“å¼€ç™»å½•é¡µ /auth
   â†“
2. è¾“å…¥è´¦å·å¯†ç ï¼ˆè½¦é˜Ÿé•¿è´¦å·ï¼‰
   â†“
3. ç‚¹å‡»ç™»å½•
   â†“
4. Auth.tsx æ£€æµ‹åˆ° profile.role = 'fleet_manager'
   â†“
5. è‡ªåŠ¨è·³è½¬åˆ° /internal/vehiclesï¼ˆè½¦è¾†ç®¡ç†é¡µï¼‰
   â†“
6. è½¦é˜Ÿé•¿çœ‹åˆ°è½¦è¾†åˆ—è¡¨å’Œç®¡ç†åŠŸèƒ½
```

### åœºæ™¯2ï¼šå¸æœºç™»å½•

```
1. æ‰“å¼€ç™»å½•é¡µ /authï¼ˆç§»åŠ¨ç«¯ï¼‰
   â†“
2. è¾“å…¥è´¦å·å¯†ç ï¼ˆå¸æœºè´¦å·ï¼‰
   â†“
3. ç‚¹å‡»ç™»å½•
   â†“
4. Auth.tsx æ£€æµ‹åˆ° profile.role = 'driver' + isMobile()
   â†“
5. è‡ªåŠ¨è·³è½¬åˆ° /m/internal/my-expensesï¼ˆæˆ‘çš„è´¹ç”¨ç”³è¯·ï¼‰
   â†“
6. å¸æœºçœ‹åˆ°è´¹ç”¨ç”³è¯·è¡¨å•å’Œè‡ªå·±çš„å·¥èµ„
```

---

## ğŸ” æƒé™æ§åˆ¶

### è½¦é˜Ÿé•¿æƒé™èŒƒå›´

```typescript
fleet_manager å¯ä»¥è®¿é—®ï¼š
  âœ… æ‰€æœ‰å†…éƒ¨è½¦è¾†ç®¡ç†é¡µé¢
  âœ… å®¡æ ¸è´¹ç”¨ç”³è¯·
  âœ… å½•å…¥è½¦è¾†æ”¶å…¥
  âœ… æŸ¥çœ‹è´¢åŠ¡æŠ¥è¡¨
  âœ… åˆ›å»º/ç¼–è¾‘è¿å•
  âŒ ç³»ç»Ÿè®¾ç½®ï¼ˆä»… adminï¼‰
```

### å¸æœºæƒé™èŒƒå›´

```typescript
driver å¯ä»¥è®¿é—®ï¼š
  âœ… æˆ‘çš„è´¹ç”¨ç”³è¯·
  âœ… æˆ‘çš„å·¥èµ„è®°å½•
  âœ… åˆ›å»ºè¿å•ï¼ˆè‡ªå·±çš„ï¼‰
  âŒ æŸ¥çœ‹å…¶ä»–å¸æœºä¿¡æ¯
  âŒ å®¡æ ¸è´¹ç”¨
  âŒ è´¢åŠ¡ç›¸å…³
```

---

## ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–

### å¸æœºç«¯ï¼ˆä¸»è¦åœºæ™¯ï¼‰

å¸æœºé€šå¸¸ä½¿ç”¨**ç§»åŠ¨ç«¯**ï¼š
- ğŸ“± ç™»å½•åç›´æ¥è¿›å…¥"æˆ‘çš„è´¹ç”¨ç”³è¯·"
- ğŸ“± å¯ä»¥å¿«é€Ÿæ‹ç…§ä¸Šä¼ å‘ç¥¨
- ğŸ“± æŸ¥çœ‹å·¥èµ„å’Œå‡ºè½¦è®°å½•

### è½¦é˜Ÿé•¿ç«¯ï¼ˆPC + ç§»åŠ¨ç«¯ï¼‰

è½¦é˜Ÿé•¿ä¸¤ç«¯éƒ½ç”¨ï¼š
- ğŸ’» PCç«¯ï¼šè½¦è¾†æ¡£æ¡ˆç®¡ç†ã€å®¡æ ¸è´¹ç”¨
- ğŸ“± ç§»åŠ¨ç«¯ï¼šå¤–å‡ºæ—¶å®¡æ ¸è´¹ç”¨ã€æŸ¥çœ‹è½¦è¾†çŠ¶æ€

---

## âœ… ç°æœ‰ç³»ç»Ÿå·²æ”¯æŒçš„åŠŸèƒ½

æ ¹æ® Auth.tsx ä»£ç ï¼š
1. âœ… **è®¾å¤‡æ£€æµ‹**ï¼š`isMobile()` è‡ªåŠ¨åˆ¤æ–­ PC/ç§»åŠ¨ç«¯
2. âœ… **è§’è‰²è·³è½¬**ï¼šå·²æœ‰ partner è§’è‰²çš„è·³è½¬ç¤ºä¾‹
3. âœ… **ä¼ä¸šå¾®ä¿¡ç™»å½•**ï¼šæ”¯æŒä¼ä¸šå¾®ä¿¡æ‰«ç ç™»å½•
4. âœ… **ç”¨æˆ·å/é‚®ç®±ç™»å½•**ï¼šä¸¤ç§æ–¹å¼éƒ½æ”¯æŒ

**åªéœ€è¦æ‰©å±•è·³è½¬æ˜ å°„è¡¨å³å¯ï¼**

