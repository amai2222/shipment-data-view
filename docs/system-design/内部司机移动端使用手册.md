# 内部司机移动端使用手册

## 👤 用户身份

**角色**：内部司机（driver）  
**适用对象**：公司自有司机（区别于外部合作司机）  
**使用设备**：手机（移动端优先）

---

## 🔐 登录方式

### 账号信息
- **账号类型**：系统账号（由车队长在后台创建）
- **邮箱格式**：`driver1@test.com` 或 `wangsf@test.com`
- **密码**：由车队长设置或首次登录后自行修改
- **角色**：司机（driver）

### 登录后自动跳转
```
司机登录（移动端）
  ↓
系统检测：role = 'driver' + 移动设备
  ↓
自动跳转到：/m/internal/my-expenses（我的费用申请）
```

---

## 📱 司机移动端完整功能

### 🏠 首页：我的费用申请
**路由**：`/m/internal/my-expenses`（登录默认页）

**顶部统计卡片**：
```
┌───────────┬───────────┬───────────┐
│ 待审核    │ 已通过    │ 本月累计  │
│    3      │    5      │ ¥1,200   │
└───────────┴───────────┴───────────┘
```

**快捷操作按钮**（3个）：
```
┌─────────────┬─────────────┬─────────────┐
│ 🚗 录入运单 │ ➕ 费用申请 │ 💰 我的工资 │
└─────────────┴─────────────┴─────────────┘
```

**我的车辆信息**：
```
┌─────────────────────────────────┐
│ 🚗 我的车辆           [申请换车] │
│  主车：云F97310（东风天龙）      │
│  备用：云F66789（福田欧曼）      │
└─────────────────────────────────┘
```

**申请记录列表**：
```
┌─────────────────────────────────┐
│ 🛢️ 加油费  ✅ 已通过            │
│ 2025-11-03                      │
│ 2月份公司加油            ¥551   │
│ 申请单号：FY20251103-0001       │
├─────────────────────────────────┤
│ 🅿️ 停车费  ⏰ 待审核            │
│ 2025-11-02                      │
│ 市区停车费               ¥50    │
└─────────────────────────────────┘
```

**可操作内容**：
- ✅ 新增费用申请（8种类型：加油、停车、过路、维修、罚款、餐费、住宿、其他）
- ✅ 上传凭证照片（拍照或选择相册）
- ✅ 查看申请状态（待审核/已通过/已驳回/已付款）
- ✅ 查看审核意见
- ✅ 删除待审核的申请

---

### 🚗 录入运单
**路由**：`/m/internal/quick-entry`

**自动显示司机信息**：
```
┌─────────────────────────────────┐
│ 👤 司机：王师傅   🚗 主车：云F97310│
└─────────────────────────────────┘
```

**录入表单**：
```
运输项目：[天兴芦花 ▼]（常跑项目）
装货地：  [天兴芦花站 ▼]（常用地点）
卸货地：  [中粮扎兰屯 ▼]（常用地点）
装货数量：[66.5] 吨
卸货数量：[65.8] 吨（可选，默认等于装货）
备注：    [ 输入备注... ]

[✓ 提交运单]
```

**系统自动填充**（无需司机输入）：
- ✅ 司机姓名：王师傅
- ✅ 车牌号：云F97310
- ✅ 电话：13800001111
- ✅ 装货日期：今天
- ✅ 卸货日期：今天
- ✅ 项目名称：天兴芦花

**提交后**：
- ✅ 插入 `logistics_records` 表
- ✅ 生成运单号：天兴芦花-000123
- ✅ 显示成功提示
- ✅ 显示最近7天运单记录

**最近运单列表**：
```
┌─────────────────────────────────┐
│ 天兴芦花-000123     [已付款]    │
│ 📍 天兴芦花站 → 中粮扎兰屯      │
│ 装货：66.5吨          11-04     │
├─────────────────────────────────┤
│ 天兴芦花-000122     [待付款]    │
│ 📍 天兴芦花站 → 中粮扎兰屯      │
│ 装货：68.2吨          11-03     │
└─────────────────────────────────┘
```

---

### 💰 我的工资
**路由**：`/m/internal/driver-salary`

**本月工资卡片**（蓝色渐变）：
```
┌─────────────────────────────────┐
│ 💰 本月工资          [核算中]   │
│                                 │
│          应发工资                │
│        ¥6,649.00                │
│                                 │
│ ─────────────────────────────── │
│ 基本工资  ¥6,000  出车  18车次  │
│ 车次提成  ¥1,200  扣款  ¥551    │
└─────────────────────────────────┘
```

**上月工资对比**：
```
┌─────────────────────────────────┐
│ 📅 上月工资          [已发放]   │
│ ¥6,820.00              22车次   │
│ 环比上月  ⬇️ -¥171.00           │
└─────────────────────────────────┘
```

**工资构成说明**：
- 基本工资：固定月薪
- 车次提成：按出车次数计算（如果有提成制度）
- 费用扣款：已审核通过的费用申请（加油、停车等）
- **应发工资 = 基本工资 + 车次提成 - 费用扣款**

**可操作**：
- ✅ 查看本月和上月工资
- ✅ 环比分析
- ✅ 跳转到"查看历史工资记录"

---

### 🚗 我的车辆
**路由**：`/m/internal/my-vehicles`

**主车卡片**（蓝色）：
```
┌─────────────────────────────────┐
│ 🚗 我的主车                      │
│                                 │
│       云F97310            [主车] │
│       厢式货车                   │
│                                 │
│       [➡️ 申请换车]              │
└─────────────────────────────────┘
```

**备用车**：
```
┌─────────────────────────────────┐
│ 备用车辆                         │
│ 云F66789  厢式货车      [备用]  │
└─────────────────────────────────┘
```

**换车申请记录**：
```
┌─────────────────────────────────┐
│ 换车申请记录                     │
│ ┌───────────────────────────┐   │
│ │ ⏰ 待审批      11-04 10:30 │   │
│ │ 云F97310 → 云F88520        │   │
│ │ 原因：原车辆需要大修       │   │
│ └───────────────────────────┘   │
│ ┌───────────────────────────┐   │
│ │ ✅ 已通过      11-01 15:20 │   │
│ │ 云F66789 → 云F97310        │   │
│ │ 原因：调整线路             │   │
│ │ 审批意见：同意             │   │
│ └───────────────────────────┘   │
└─────────────────────────────────┘
```

**换车申请流程**：
1. 点击"申请换车"
2. 选择要换的车辆
3. 填写换车原因
4. 提交申请
5. 等待车队长审批
6. **审批通过后，主车自动更新**

**限制**：
- ❌ 司机不能自己修改车辆关联
- ✅ 必须通过申请流程
- ✅ 需要车队长审批

---

### 📊 工资发放记录
**路由**：`/m/internal/salary-records`

**统计卡片**：
```
┌─────────────┬─────────────┐
│ 累计收入    │ 月均工资    │
│ ¥81,240    │ ¥6,770     │
└─────────────┴─────────────┘
```

**月份筛选器**：
```
查询月份：[最近3个月 ▼]
         [2025年11月]
         [2025年10月]
         ...
```

**工资明细列表**：
```
┌─────────────────────────────────┐
│ 2025年11月          [已发放] ✅ │
│                                 │
│          实发工资                │
│        ¥6,649.00                │
│   环比上月 ⬇️ -¥171.00          │
│                                 │
│ 基本工资  ¥6,000  出车  18车次  │
│ 车次提成  ¥1,200  扣款  ¥551    │
│ 发放日期：2025-11-05            │
├─────────────────────────────────┤
│ 2025年10月          [已发放] ✅ │
│        ¥6,820.00                │
│   环比上月 ⬆️ +¥320.00          │
│ ...                             │
└─────────────────────────────────┘
```

---

## 🔐 数据安全

### 司机只能看到自己的数据：

| 数据类型 | 可见范围 | 实现方式 |
|---------|---------|---------|
| 费用申请 | ✅ 只能看自己提交的 | RLS策略 + `get_current_driver_id()` |
| 工资记录 | ✅ 只能看自己的 | RLS策略 |
| 运单记录 | ✅ 只能看自己跑的 | 通过姓名匹配 |
| 车辆信息 | ✅ 只能看关联自己的车 | `get_my_vehicles()` |
| 换车申请 | ✅ 只能看自己的申请 | RLS策略 |

**保证**：
- ❌ 王师傅看不到李师傅的数据
- ❌ 司机看不到其他司机的工资
- ❌ 司机不能修改车辆关联
- ✅ 所有数据自动过滤

---

## 📋 司机完整操作流程

### 场景1：每日出车前
```
1. 打开手机，登录系统
2. 进入"录入运单"
3. 选择项目：天兴芦花（我常跑的）
4. 选择装货地：天兴芦花站
5. 选择卸货地：中粮扎兰屯
6. 填写装货数量：66.5吨
7. 点击"提交运单"
8. 系统自动生成运单号：天兴芦花-000123
9. 完成！开始运输
```

### 场景2：产生费用后
```
1. 打开"我的费用申请"（首页）
2. 点击"费用申请"按钮
3. 选择费用类型：加油费
4. 填写金额：551元
5. 填写说明：2月份公司加油
6. 拍照上传发票
7. 提交申请
8. 等待车队长审批
9. 审批通过后，自动计入工资扣款
```

### 场景3：查看工资
```
1. 点击"我的工资"
2. 查看本月工资：
   - 基本工资：¥6,000
   - 出车18次，提成：¥1,200
   - 费用扣款：¥551
   - 应发：¥6,649
3. 查看上月对比
4. 点击"查看历史工资记录"
5. 按月份查询历史工资
```

### 场景4：申请换车
```
1. 点击"我的车辆"
2. 当前主车：云F97310
3. 点击"申请换车"
4. 选择要换的车：云F88520
5. 填写原因：原车需要大修
6. 提交申请
7. 等待车队长审批
8. 审批通过后，主车自动变更为云F88520
```

---

## 🎯 司机能做什么

### ✅ 可以做的：

1. **录入运单**
   - 选择常跑项目和线路
   - 填写装货数量
   - 查看最近运单

2. **费用申请**
   - 提交各类费用申请
   - 上传发票凭证
   - 查看审批进度
   - 删除待审核的申请

3. **查看工资**
   - 查看本月工资明细
   - 查看历史工资
   - 环比分析

4. **换车申请**
   - 查看当前车辆
   - 申请更换车辆
   - 查看申请状态

### ❌ 不能做的：

1. **不能看其他司机数据**
   - 看不到别人的工资
   - 看不到别人的费用申请
   - 看不到别人的车辆

2. **不能自己改车辆**
   - 不能直接修改车辆关联
   - 必须通过申请流程
   - 需要车队长审批

3. **不能修改已审批的申请**
   - 已通过/已驳回的费用申请不能修改
   - 已审批的换车申请不能撤销

---

## 🔗 与系统其他部分的关系

### 数据关联方式：

**司机账号 → 司机档案**：
```
profiles 表（登录账号）
  ↓ full_name = '王师傅'
internal_drivers 表（司机档案）
  ↓ name = '王师傅'
自动匹配 ✅
```

**司机档案 → 运单记录**：
```
internal_drivers.name = '王师傅'
  ↓
logistics_records.driver_name = '王师傅'
  ↓
司机能看到自己所有运单 ✅
```

**司机档案 → 车辆**：
```
internal_drivers (王师傅)
  ↓
internal_driver_vehicle_relations
  ↓
internal_vehicles (云F97310)
  ↓
运单自动使用主车牌号 ✅
```

---

## 📊 司机数据统计（示例）

### 王师傅的11月数据：
- **出车次数**：18 车次
- **基本工资**：¥6,000
- **车次提成**：¥1,200（每车次¥66.67）
- **费用申请**：
  - 加油费：¥551（已通过）
  - 停车费：¥50（待审核）
- **应发工资**：¥6,649
- **主车**：云F97310（东风天龙）
- **备用车**：云F66789

---

## ⚠️ 重要说明

### 1. 账号创建
- 由车队长或管理员在后台创建
- **姓名必须与司机档案完全一致**
- 例如：账号姓名 = "王师傅"，档案姓名 = "王师傅"

### 2. 项目线路配置
- 由车队长配置司机的常跑项目
- 配置常用装货地和卸货地
- 配置后司机才能快速录入运单

### 3. 车辆分配
- 由车队长分配主车和备用车
- 司机不能自己修改
- 换车需要申请审批

---

## 📱 移动端界面特点

### 优化设计：
- ✅ 大按钮（适合手指点击）
- ✅ 渐变卡片（视觉美观）
- ✅ 颜色编码（绿色=录单、蓝色=费用、黄色=待审核）
- ✅ 快捷操作（首页3个按钮直达）
- ✅ 自动填充（减少输入）
- ✅ 拍照上传（方便凭证）

### 数据实时性：
- ✅ 提交后立即显示
- ✅ 审批后实时更新
- ✅ 工资每月自动核算

---

## 🎉 总结

**内部司机系统 = 简化 + 自动化 + 移动优先**

司机只需要：
1. 📱 打开手机
2. 🔐 登录系统
3. 🚗 录入运单（3步完成）
4. 💰 提交费用（拍照即可）
5. 💵 查看工资（自动核算）

**所有复杂操作都由系统自动完成！**

