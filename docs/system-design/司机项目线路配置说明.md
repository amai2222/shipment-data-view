# 司机项目线路配置说明

## 📋 数据绑定逻辑

### 1. 司机 ↔ 项目绑定

**数据表**：`internal_driver_project_routes`

**字段说明**：
| 字段 | 类型 | 说明 |
|-----|------|------|
| driver_id | UUID | 内部司机ID |
| project_id | UUID | 项目ID |
| is_primary_route | BOOLEAN | 是否为主线路（司机最常跑的） |
| common_loading_location_ids | UUID[] | 常用装货地点ID数组 |
| common_unloading_location_ids | UUID[] | 常用卸货地点ID数组 |

**作用**：
- ✅ 控制司机录入运单时能选择哪些项目
- ✅ 显示该项目的常用装卸货地点（简化录入）

---

### 2. 车队长 ↔ 司机关系

**方式**：通过角色和权限控制

| 角色 | 权限范围 |
|-----|---------|
| 车队长（fleet_manager） | 可以查看和管理**所有**内部司机 |
| 司机（driver） | 只能查看**自己**的数据 |

**没有显式的"车队"概念**：
- 一个系统只有一个车队（所有内部司机）
- 车队长管理所有司机
- 如果需要多车队，需要添加"车队"表

---

## 🛠️ 维护方式

### 方式1：车队长在后台配置（需要开发）

**页面**：`/m/internal/driver-route-config`（已创建模板）

**操作流程**：
```
车队长登录
  ↓
进入"司机线路配置"页面
  ↓
点击"新增配置"
  ↓
1. 选择司机：王师傅
2. 选择项目：天兴芦花
3. 设为主线路：✅ 勾选
4. 选择常用装货地：天兴芦花站
5. 选择常用卸货地：中粮扎兰屯、云南朵嗑源车队
  ↓
保存
  ↓
王师傅登录后，录单时只能看到"天兴芦花"项目
```

---

### 方式2：直接用SQL配置（临时方案）

**示例SQL**：

```sql
-- 为王师傅配置天兴芦花项目线路
INSERT INTO internal_driver_project_routes (
    driver_id,
    project_id,
    is_primary_route,
    common_loading_location_ids,
    common_unloading_location_ids
) VALUES (
    (SELECT id FROM internal_drivers WHERE name = '王师傅'),
    (SELECT id FROM projects WHERE name LIKE '%天兴芦花%' LIMIT 1),
    true,  -- 主线路
    ARRAY[
        (SELECT id FROM locations WHERE name LIKE '%天兴芦花站%' LIMIT 1)
    ],
    ARRAY[
        (SELECT id FROM locations WHERE name LIKE '%中粮扎兰屯%' LIMIT 1),
        (SELECT id FROM locations WHERE name LIKE '%云南朵嗑源%' LIMIT 1)
    ]
);

-- 为李师傅配置铁路配送项目
INSERT INTO internal_driver_project_routes (
    driver_id,
    project_id,
    is_primary_route,
    common_loading_location_ids,
    common_unloading_location_ids
) VALUES (
    (SELECT id FROM internal_drivers WHERE name = '李师傅'),
    (SELECT id FROM projects WHERE name LIKE '%铁路%' LIMIT 1),
    true,
    ARRAY[
        (SELECT id FROM locations WHERE name LIKE '%火车站%' LIMIT 1)
    ],
    ARRAY[
        (SELECT id FROM locations WHERE name LIKE '%配送中心%' LIMIT 1)
    ]
);
```

---

## 📊 完整的数据流程

### 司机录入运单的完整流程：

```
车队长配置（一次性）：
  王师傅 → 天兴芦花项目
    装货地：天兴芦花站
    卸货地：中粮扎兰屯、云南朵嗑源
  ↓
保存到 internal_driver_project_routes 表
  ↓
王师傅登录移动端
  ↓
点击"录入运单"
  ↓
调用 get_my_project_routes() 函数
  ↓
只显示：天兴芦花（他配置的项目）
  ↓
选择项目后，装货地下拉框只显示：
  - 天兴芦花站
  ↓
卸货地下拉框只显示：
  - 中粮扎兰屯
  - 云南朵嗑源
  ↓
填写装货数量
  ↓
调用 driver_quick_create_waybill() 函数
  ↓
自动填充：
  - 司机：王师傅
  - 车牌：云F97310（从主车获取）
  - 电话：13800001111
  - 装货日期：今天
  ↓
插入 logistics_records 表 ✅
```

---

## 🎯 推荐的维护方式

### 短期（临时）：
使用SQL直接配置（见上面示例）

### 长期（完整）：
开发车队长的"司机线路配置"页面（我已创建模板）

---

## ⚠️ 当前状态

**已创建**：
- ✅ 数据库表：`internal_driver_project_routes`
- ✅ 查询函数：`get_my_project_routes()`
- ✅ 录单函数：`driver_quick_create_waybill()`
- ✅ 页面模板：`MobileDriverRouteConfig.tsx`

**待完成**：
- ⏳ 完善配置页面的列表显示
- ⏳ 添加编辑、删除功能
- ⏳ 添加到车队长菜单和路由

---

**您现在可以用SQL临时配置，或者我继续开发完整的配置界面？**

