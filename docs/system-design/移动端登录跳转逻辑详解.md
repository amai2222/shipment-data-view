# ç§»åŠ¨ç«¯ç™»å½•è·³è½¬é€»è¾‘è¯¦è§£

## ğŸ” ç™»å½•æµç¨‹æ¶æ„

```
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
  â†“
Auth.tsx - signIn() å‡½æ•°
  â†“
Supabase è®¤è¯
  â†“
onAuthStateChange è§¦å‘
  â†“
åŠ è½½ profiles è¡¨ï¼ˆè·å–è§’è‰²ï¼‰
  â†“
Auth.tsx æ£€æµ‹ç™»å½•çŠ¶æ€
  â†“
isMobile() åˆ¤æ–­è®¾å¤‡
  â†“
æ ¹æ®è§’è‰²è·³è½¬åˆ°å¯¹åº”é¦–é¡µ
  â†“
ProtectedRoute æƒé™æ£€æŸ¥
  â†“
æ˜¾ç¤ºç›®æ ‡é¡µé¢
```

---

## ğŸ“± æ ¸å¿ƒä»£ç åˆ†æ

### 1. Auth.tsxï¼ˆç™»å½•é¡µé¢ï¼‰- ç¬¬29-73è¡Œ

**å…³é”®ä»£ç **ï¼š
```typescript
// å¦‚æœå·²ç»ç™»å½•ï¼Œæ ¹æ®è§’è‰²é‡å®šå‘åˆ°ç›®æ ‡é¡µé¢
if (user && profile) {
  // è°ƒè¯•æ—¥å¿—
  console.log('Auth.tsx - ç”¨æˆ·å·²ç™»å½•ï¼Œå‡†å¤‡è·³è½¬');
  console.log('  è§’è‰²:', profile.role);
  console.log('  æ˜¯å¦ç§»åŠ¨ç«¯:', isMobile());
  
  // å®šä¹‰è§’è‰²é»˜è®¤é¦–é¡µæ˜ å°„
  const roleHomePage: Record<string, { pc: string; mobile: string }> = {
    partner: {
      pc: '/dashboard/shipper',
      mobile: '/m/dashboard/shipper'
    },
    fleet_manager: {
      pc: '/m/internal/fleet-dashboard',  // PCç«¯æš‚æ—¶ä¹Ÿç”¨ç§»åŠ¨ç«¯
      mobile: '/m/internal/fleet-dashboard'
    },
    driver: {
      pc: '/m/internal/my-expenses',  // PCç«¯æš‚æ—¶ä¹Ÿç”¨ç§»åŠ¨ç«¯
      mobile: '/m/internal/my-expenses'
    },
    finance: {
      pc: '/dashboard/financial',
      mobile: '/m/dashboard/financial'
    },
    operator: {
      pc: '/business-entry',
      mobile: '/m/business-entry'
    }
  };
  
  // è·å–è¯¥è§’è‰²çš„é»˜è®¤é¦–é¡µ
  const defaultHome = roleHomePage[profile.role];
  
  if (defaultHome) {
    const targetPath = isMobile() ? defaultHome.mobile : defaultHome.pc;
    console.log('  è·³è½¬è·¯å¾„:', targetPath);
    return <Navigate to={targetPath} replace />;
  }
  
  // å…¶ä»–è§’è‰²ï¼ˆadmin, business, viewerï¼‰ä½¿ç”¨åŸæ¥çš„è·³è½¬é€»è¾‘
  console.log('  æœªåŒ¹é…è§’è‰²ï¼Œä½¿ç”¨é»˜è®¤è·³è½¬');
  const from = location.state?.from?.pathname || '/';
  return <Navigate to={from} replace />;
}
```

---

## ğŸ¯ è§’è‰²è·³è½¬æ˜ å°„è¡¨

| è§’è‰² | è§’è‰²Key | ç§»åŠ¨ç«¯è·³è½¬ | PCç«¯è·³è½¬ | è¯´æ˜ |
|-----|---------|-----------|---------|------|
| **å¸æœº** | driver | `/m/internal/my-expenses` | `/m/internal/my-expenses` | è´¹ç”¨ç”³è¯·é¦–é¡µ |
| **è½¦é˜Ÿé•¿** | fleet_manager | `/m/internal/fleet-dashboard` | `/m/internal/fleet-dashboard` | è½¦é˜Ÿå·¥ä½œå° |
| **è´§ä¸»** | partner | `/m/dashboard/shipper` | `/dashboard/shipper` | è´§ä¸»çœ‹æ¿ |
| **è´¢åŠ¡** | finance | `/m/dashboard/financial` | `/dashboard/financial` | è´¢åŠ¡çœ‹æ¿ |
| **æ“ä½œå‘˜** | operator | `/m/business-entry` | `/business-entry` | è¿å•ç®¡ç† |
| **ç®¡ç†å‘˜** | admin | `/` | `/` | è¿è¾“æ¦‚è§ˆ |
| **ä¸šåŠ¡** | business | `/` | `/` | è¿è¾“æ¦‚è§ˆ |
| **æŸ¥çœ‹è€…** | viewer | `/` | `/` | è¿è¾“æ¦‚è§ˆ |

---

## ğŸ” è®¾å¤‡æ£€æµ‹é€»è¾‘

### isMobile() å‡½æ•°ï¼ˆsrc/utils/device.tsï¼‰

```typescript
export const isMobile = (): boolean => {
  // 1. æ£€æŸ¥ User-Agent
  const ua = navigator.userAgent.toLowerCase();
  const mobileKeywords = ['mobile', 'android', 'iphone', 'ipad'];
  const isMobileUA = mobileKeywords.some(keyword => ua.includes(keyword));
  
  // 2. æ£€æŸ¥å±å¹•å®½åº¦
  const isSmallScreen = window.innerWidth < 768;
  
  // 3. æ£€æŸ¥è§¦æ‘¸å±
  const hasTouchScreen = 'ontouchstart' in window;
  
  // ç»¼åˆåˆ¤æ–­
  return isMobileUA || isSmallScreen;
};
```

**åˆ¤æ–­ä¾æ®**ï¼š
- âœ… User-Agent åŒ…å« mobile/android/iphone
- âœ… å±å¹•å®½åº¦ < 768px
- âœ… ä»»ä¸€æ¡ä»¶æ»¡è¶³å³ä¸ºç§»åŠ¨ç«¯

---

## ğŸ›¡ï¸ æƒé™æ£€æŸ¥æµç¨‹

### ProtectedRoute ç»„ä»¶ï¼ˆsrc/components/ProtectedRoute.tsxï¼‰

```typescript
// ç¬¬1å±‚ï¼šæ£€æŸ¥æ˜¯å¦ç™»å½•
if (!user || !profile) {
  return <Navigate to="/auth" state={{ from: location }} replace />;
}

// ç¬¬2å±‚ï¼šæ£€æŸ¥æƒé™
if (requiredPermission) {
  // å¯¹äº internal.* æƒé™ï¼Œç›´æ¥é€šè¿‡ï¼ˆæ–°åŠŸèƒ½ï¼Œæš‚ä¸æ£€æŸ¥æ•°æ®åº“ï¼‰
  const isInternalPermission = requiredPermission.startsWith('internal.');
  
  if (!isInternalPermission && !hasPageAccess(requiredPermission)) {
    // æ— æƒé™ï¼Œå°è¯•è·³è½¬åˆ°è´§ä¸»çœ‹æ¿
    if (hasPageAccess('dashboard.shipper')) {
      return <Navigate to={shipperPath} replace />;
    } else {
      // æ˜¾ç¤º"è®¿é—®è¢«æ‹’ç»"é¡µé¢ï¼ˆå¸¦é€€å‡ºç™»å½•æŒ‰é’®ï¼‰
      return <AccessDeniedPage />;
    }
  }
}

// ç¬¬3å±‚ï¼šé€šè¿‡æ£€æŸ¥ï¼Œæ¸²æŸ“é¡µé¢
return <>{children}</>;
```

---

## ğŸ“Š å®Œæ•´ç™»å½•æµç¨‹ç¤ºä¾‹

### åœºæ™¯1ï¼šå¸æœºï¼ˆç‹å¸ˆå‚…ï¼‰ç§»åŠ¨ç«¯ç™»å½•

```
1. æ‰“å¼€æ‰‹æœºæµè§ˆå™¨
   URL: https://your-domain.com/
   â†“
2. MobileRedirectæ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡
   è‡ªåŠ¨è·³è½¬: /m/
   â†“
3. æœªç™»å½•ï¼ŒProtectedRouteæ‹¦æˆª
   è·³è½¬: /auth
   â†“
4. è¾“å…¥è´¦å·å¯†ç 
   é‚®ç®±: wangsf@test.com
   å¯†ç : Driver123
   â†“
5. ç‚¹å‡»"ç™»å½•"
   è°ƒç”¨: signIn(usernameOrEmail, password)
   â†“
6. Supabaseè®¤è¯æˆåŠŸ
   è¿”å›: user å’Œ session
   â†“
7. onAuthStateChangeè§¦å‘
   åŠ è½½: profilesè¡¨ï¼Œè·å– role = 'driver'
   â†“
8. Auth.tsxæ£€æµ‹åˆ°ç™»å½•
   user âœ…
   profile âœ… { role: 'driver' }
   â†“
9. æŸ¥æ‰¾roleHomePageæ˜ å°„
   driver: { mobile: '/m/internal/my-expenses' }
   â†“
10. isMobile() = true
   targetPath = '/m/internal/my-expenses'
   â†“
11. <Navigate to="/m/internal/my-expenses" />
   â†“
12. è·¯ç”±è·³è½¬åˆ° MobileMyExpenses ç»„ä»¶
   â†“
13. ProtectedRouteæ£€æŸ¥æƒé™
   requiredPermission = 'internal.my_expenses'
   isInternalPermission = true
   ç›´æ¥é€šè¿‡ âœ…
   â†“
14. æ¸²æŸ“ MobileMyExpenses ç»„ä»¶
   â†“
15. å¸æœºçœ‹åˆ°ï¼š
   - è“è‰²æ¬¢è¿å¡ç‰‡
   - ç»Ÿè®¡æ•°æ®
   - å¿«æ·æŒ‰é’®
   - è½¦è¾†ä¿¡æ¯
   - ç”³è¯·è®°å½•
```

---

### åœºæ™¯2ï¼šè½¦é˜Ÿé•¿ï¼ˆè°­ç‰é¾™ï¼‰ç§»åŠ¨ç«¯ç™»å½•

```
1-7. åŒä¸Šï¼ˆç™»å½•è®¤è¯ï¼‰
   â†“
8. Auth.tsxæ£€æµ‹åˆ°ç™»å½•
   profile.role = 'fleet_manager'
   â†“
9. æŸ¥æ‰¾roleHomePageæ˜ å°„
   fleet_manager: { mobile: '/m/internal/fleet-dashboard' }
   â†“
10. isMobile() = true
   targetPath = '/m/internal/fleet-dashboard'
   â†“
11. <Navigate to="/m/internal/fleet-dashboard" />
   â†“
12. è·¯ç”±è·³è½¬åˆ° MobileFleetDashboard ç»„ä»¶
   â†“
13. ProtectedRouteæ£€æŸ¥æƒé™
   requiredPermission = 'internal.vehicles'
   isInternalPermission = true
   ç›´æ¥é€šè¿‡ âœ…
   â†“
14. æ¸²æŸ“ MobileFleetDashboard ç»„ä»¶
   â†“
15. è½¦é˜Ÿé•¿çœ‹åˆ°ï¼š
   - æ¬¢è¿å¡ç‰‡
   - å¾…åŠäº‹é¡¹ï¼ˆçº¢è‰²å¾½ç« ï¼‰
   - è½¦è¾†å¸æœºæ¦‚è§ˆ
   - å¿«æ·åŠŸèƒ½æŒ‰é’®
```

---

## ğŸ”„ ç‰¹æ®Šæƒ…å†µå¤„ç†

### æƒ…å†µ1ï¼šç”¨æˆ·è®¿é—®æ— æƒé™çš„é¡µé¢

```
å¸æœºè®¿é—® /dashboard/financialï¼ˆè´¢åŠ¡çœ‹æ¿ï¼‰
  â†“
ProtectedRouteæ£€æŸ¥
  requiredPermission = 'dashboard.financial'
  isInternalPermission = false
  hasPageAccess('dashboard.financial') = false
  â†“
æ£€æŸ¥æ˜¯å¦æœ‰è´§ä¸»çœ‹æ¿æƒé™
  hasPageAccess('dashboard.shipper') = false
  â†“
æ˜¾ç¤º"è®¿é—®è¢«æ‹’ç»"é¡µé¢
  - ğŸš« å›¾æ ‡
  - éœ€è¦æƒé™: dashboard.financial
  - [é€€å‡ºç™»å½•] æŒ‰é’®
  - [è¿”å›ä¸Šä¸€é¡µ] æŒ‰é’®
  - å½“å‰ç”¨æˆ·: ç‹å¸ˆå‚… (driver)
```

---

### æƒ…å†µ2ï¼šPCç«¯è®¿é—®ç§»åŠ¨ç«¯è·¯ç”±

```
åœ¨PCç«¯è¾“å…¥: /m/internal/my-expenses
  â†“
isMobile() = falseï¼ˆPCç«¯ï¼‰
  â†“
ä½†è·¯ç”±å­˜åœ¨ï¼Œç›´æ¥æ˜¾ç¤º
  â†“
MobileLayouté€‚é…PCç«¯æ˜¾ç¤º
  ï¼ˆå“åº”å¼è®¾è®¡ï¼ŒPCç«¯ä¹Ÿèƒ½ç”¨ï¼‰
```

---

### æƒ…å†µ3ï¼šç§»åŠ¨ç«¯è®¿é—®PCç«¯è·¯ç”±

```
æ‰‹æœºè®¿é—®: /dashboard/financial
  â†“
isMobile() = true
  â†“
è·¯ç”±å­˜åœ¨ï¼Œæ˜¾ç¤ºé¡µé¢
  â†“
MobileRedirectå¯èƒ½ä¼šæ£€æµ‹å¹¶å»ºè®®åˆ‡æ¢
```

---

## ğŸ¯ å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|-----|------|------|------|
| ç™»å½•è·³è½¬ | src/pages/Auth.tsx | 29-73 | è§’è‰²æ˜ å°„è¡¨ |
| è®¾å¤‡æ£€æµ‹ | src/utils/device.ts | å…¨æ–‡ | isMobile() |
| æƒé™æ£€æŸ¥ | src/components/ProtectedRoute.tsx | 40-113 | è·¯ç”±ä¿æŠ¤ |
| èœå•è¿‡æ»¤ | src/components/mobile/MobileLayout.tsx | 326-346 | èœå•æ˜¾ç¤º |
| è§’è‰²ç±»å‹ | src/contexts/AuthContext.tsx | 13 | ç±»å‹å®šä¹‰ |

---

## âœ… å½“å‰ç³»ç»Ÿæ”¯æŒçš„ç™»å½•åœºæ™¯

### ç§»åŠ¨ç«¯ï¼ˆ8ç§è§’è‰²ï¼‰ï¼š
| è§’è‰² | è·³è½¬é¡µé¢ | åŠŸèƒ½ |
|-----|---------|------|
| å¸æœº | è´¹ç”¨ç”³è¯· | å½•å•ã€è´¹ç”¨ã€å·¥èµ„ |
| è½¦é˜Ÿé•¿ | è½¦é˜Ÿå·¥ä½œå° | å®¡æ‰¹ã€ç®¡ç†è½¦è¾† |
| è´§ä¸» | è´§ä¸»çœ‹æ¿ | æŸ¥çœ‹æ•°æ® |
| è´¢åŠ¡ | è´¢åŠ¡çœ‹æ¿ | è´¢åŠ¡ç®¡ç† |
| æ“ä½œå‘˜ | è¿å•ç®¡ç† | å½•å…¥è¿å• |
| ç®¡ç†å‘˜ | è¿è¾“æ¦‚è§ˆ | å…¨éƒ¨åŠŸèƒ½ |
| ä¸šåŠ¡ | è¿è¾“æ¦‚è§ˆ | ä¸šåŠ¡ç®¡ç† |
| æŸ¥çœ‹è€… | è¿è¾“æ¦‚è§ˆ | åªè¯» |

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è·³è½¬æ—¥å¿—ï¼š

```javascript
Auth.tsx - ç”¨æˆ·å·²ç™»å½•ï¼Œå‡†å¤‡è·³è½¬
  è§’è‰²: driver
  æ˜¯å¦ç§»åŠ¨ç«¯: true
  è·³è½¬è·¯å¾„: /m/internal/my-expenses
```

**å¦‚æœçœ‹ä¸åˆ°æ—¥å¿—**ï¼šè¯´æ˜ä»£ç è¿˜æ²¡éƒ¨ç½²ï¼

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å¸æœºç™»å½•åè·³è½¬åˆ°è´§ä¸»çœ‹æ¿ï¼Ÿ
**A**: ProtectedRouteæŠŠå¸æœºæ‹¦æˆªäº†ï¼Œå› ä¸º `internal.*` æƒé™æ²¡æ”¾è¡Œã€‚
**è§£å†³**: ç¬¬42-46è¡Œå·²æ·»åŠ æ”¾è¡Œé€»è¾‘ã€‚

### Q2: è½¦é˜Ÿé•¿ç™»å½•å404ï¼Ÿ
**A**: PCç«¯è·¯ç”± `/internal/vehicles` ä¸å­˜åœ¨ã€‚
**è§£å†³**: æ”¹ä¸ºè·³è½¬ `/m/internal/fleet-dashboard`ã€‚

### Q3: ç™»å½•åç™½å±ï¼Ÿ
**A**: ç»„ä»¶ç¼ºå°‘å¯¼å…¥æˆ–æœ‰è¿è¡Œæ—¶é”™è¯¯ã€‚
**è§£å†³**: æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ï¼Œè¡¥å……å¯¼å…¥ã€‚

---

**ç§»åŠ¨ç«¯ç™»å½•è·³è½¬é€»è¾‘å°±æ˜¯è¿™æ ·ï¼æ ¸å¿ƒæ˜¯Auth.tsxçš„è§’è‰²æ˜ å°„è¡¨ã€‚** ğŸ“±

