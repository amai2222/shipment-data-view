# æƒé™é‡ç½®é€»è¾‘ä¼˜åŒ–

## ğŸ¯ é—®é¢˜æè¿°

**åŸå§‹é—®é¢˜**ï¼šæƒé™é‡ç½®åŠŸèƒ½ä½¿ç”¨ç¡¬ç¼–ç çš„ `DEFAULT_ROLE_PERMISSIONS`ï¼Œå¯¼è‡´ï¼š
- è§’è‰²æ¨¡æ¿æƒé™å˜åŒ–åï¼Œé‡ç½®åŠŸèƒ½ä»ä½¿ç”¨æ—§çš„ç¡¬ç¼–ç æƒé™
- æ— æ³•åæ˜ æ•°æ®åº“ä¸­æœ€æ–°çš„è§’è‰²æ¨¡æ¿æƒé™
- æƒé™ç®¡ç†ä¸ä¸€è‡´

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. **ä¿®æ”¹æƒé™é‡ç½®é€»è¾‘**

**ä¿®æ”¹å‰**ï¼š
```typescript
// ä½¿ç”¨ç¡¬ç¼–ç æƒé™
const defaultPermissions = DEFAULT_ROLE_PERMISSIONS[userRole];
```

**ä¿®æ”¹å**ï¼š
```typescript
// ä»æ•°æ®åº“è¯»å–è§’è‰²æ¨¡æ¿æƒé™
const { data: roleTemplate } = await supabase
  .from('role_permission_templates')
  .select('menu_permissions, function_permissions, project_permissions, data_permissions')
  .eq('role', userRole)
  .single();
```

### 2. **æ–°çš„é‡ç½®æµç¨‹**

1. **è·å–ç”¨æˆ·è§’è‰²**ï¼šä» `profiles` è¡¨è¯»å–ç”¨æˆ·è§’è‰²
2. **è¯»å–è§’è‰²æ¨¡æ¿**ï¼šä» `role_permission_templates` è¡¨è¯»å–æœ€æ–°æƒé™
3. **åˆ é™¤è‡ªå®šä¹‰æƒé™**ï¼šæ¸…é™¤ `user_permissions` è¡¨ä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰æƒé™
4. **åº”ç”¨æ¨¡æ¿æƒé™**ï¼šå°†è§’è‰²æ¨¡æ¿æƒé™åº”ç”¨åˆ°ç”¨æˆ·

### 3. **ä¿ç•™çš„ç¡¬ç¼–ç ä½¿ç”¨**

**ä»…ç”¨äºç³»ç»Ÿåˆå§‹åŒ–**ï¼š
```typescript
// ä»…ç”¨äºç³»ç»Ÿåˆå§‹åŒ–æˆ–ç´§æ€¥æ¢å¤
static async resetRoleTemplateToSystemDefault(role: UserRole): Promise<void>
```

## ğŸ”„ æƒé™åŒæ­¥æœºåˆ¶

### è§’è‰²æ¨¡æ¿æƒé™å˜åŒ– â†’ ç”¨æˆ·æƒé™é‡ç½®

1. **ç®¡ç†å‘˜ä¿®æ”¹è§’è‰²æ¨¡æ¿**ï¼šåœ¨è§’è‰²æ¨¡æ¿ç®¡ç†ç•Œé¢ä¿®æ”¹æƒé™
2. **æƒé™ç«‹å³ç”Ÿæ•ˆ**ï¼šæ–°ç”¨æˆ·è‡ªåŠ¨è·å¾—æ–°æƒé™
3. **ç°æœ‰ç”¨æˆ·é‡ç½®**ï¼šä½¿ç”¨é‡ç½®åŠŸèƒ½è·å¾—æœ€æ–°æƒé™

### ç¤ºä¾‹åœºæ™¯

**åœºæ™¯**ï¼šç®¡ç†å‘˜ä¸º `operator` è§’è‰²æ·»åŠ äº†æ–°çš„èœå•æƒé™

1. **ä¿®æ”¹å‰**ï¼š
   - è§’è‰²æ¨¡æ¿ï¼š`operator` æœ‰ 10 ä¸ªèœå•æƒé™
   - ç”¨æˆ· Aï¼šæœ‰ 10 ä¸ªèœå•æƒé™
   - é‡ç½®åï¼šä»ç„¶æ˜¯ 10 ä¸ªæƒé™ï¼ˆä½¿ç”¨ç¡¬ç¼–ç ï¼‰

2. **ä¿®æ”¹å**ï¼š
   - è§’è‰²æ¨¡æ¿ï¼š`operator` æœ‰ 15 ä¸ªèœå•æƒé™
   - ç”¨æˆ· Aï¼šæœ‰ 10 ä¸ªèœå•æƒé™
   - é‡ç½®åï¼šè·å¾— 15 ä¸ªæƒé™ï¼ˆä»æ•°æ®åº“è¯»å–ï¼‰

## ğŸ¯ ä¼˜åŠ¿

### 1. **æƒé™ä¸€è‡´æ€§**
- âœ… é‡ç½®åŠŸèƒ½å§‹ç»ˆä½¿ç”¨æœ€æ–°çš„è§’è‰²æ¨¡æ¿æƒé™
- âœ… è§’è‰²æ¨¡æ¿å˜åŒ–ç«‹å³åæ˜ åˆ°é‡ç½®åŠŸèƒ½
- âœ… æ¶ˆé™¤ç¡¬ç¼–ç ä¸æ•°æ®åº“ä¸ä¸€è‡´çš„é—®é¢˜

### 2. **åŠ¨æ€æƒé™ç®¡ç†**
- âœ… æ”¯æŒåŠ¨æ€è§’è‰²ç³»ç»Ÿ
- âœ… æ–°åˆ›å»ºçš„è§’è‰²è‡ªåŠ¨æ”¯æŒé‡ç½®åŠŸèƒ½
- âœ… æƒé™æ¨¡æ¿ä¿®æ”¹æ— éœ€ä»£ç æ›´æ–°

### 3. **ç”¨æˆ·ä½“éªŒ**
- âœ… é‡ç½®åŠŸèƒ½æ›´åŠ ç›´è§‚å’Œå¯é¢„æµ‹
- âœ… ç®¡ç†å‘˜å¯ä»¥å®‰å…¨åœ°ä¿®æ”¹è§’è‰²æ¨¡æ¿
- âœ… ç”¨æˆ·æƒé™å§‹ç»ˆä¸è§’è‰²æ¨¡æ¿ä¿æŒåŒæ­¥

## ğŸ”§ å®ç°ç»†èŠ‚

### æ ¸å¿ƒæ–¹æ³•

```typescript
// æ–°çš„é‡ç½®æ–¹æ³•
static async resetUserToRoleDefault(userId: string): Promise<void> {
  // 1. è·å–ç”¨æˆ·è§’è‰²
  const userProfile = await supabase.from('profiles').select('role').eq('id', userId).single();
  
  // 2. ä»æ•°æ®åº“è¯»å–è§’è‰²æ¨¡æ¿æƒé™
  const roleTemplate = await supabase
    .from('role_permission_templates')
    .select('menu_permissions, function_permissions, project_permissions, data_permissions')
    .eq('role', userProfile.role)
    .single();
  
  // 3. åˆ é™¤ç”¨æˆ·è‡ªå®šä¹‰æƒé™
  await supabase.from('user_permissions').delete().eq('user_id', userId);
  
  // 4. åº”ç”¨è§’è‰²æ¨¡æ¿æƒé™
  await supabase.from('user_permissions').upsert({
    user_id: userId,
    menu_permissions: roleTemplate.menu_permissions,
    function_permissions: roleTemplate.function_permissions,
    project_permissions: roleTemplate.project_permissions,
    data_permissions: roleTemplate.data_permissions,
    created_by: currentUserId
  });
}
```

### é”™è¯¯å¤„ç†

- âœ… è§’è‰²æ¨¡æ¿ä¸å­˜åœ¨æ—¶è·³è¿‡é‡ç½®
- âœ… ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡ºé”™è¯¯
- âœ… æ•°æ®åº“æ“ä½œå¤±è´¥æ—¶å›æ»š

## ğŸ‰ æ€»ç»“

**æƒé™é‡ç½®é€»è¾‘å·²å®Œå…¨ä¼˜åŒ–**ï¼š

- âœ… **æ¶ˆé™¤ç¡¬ç¼–ç **ï¼šé‡ç½®åŠŸèƒ½ä¸å†ä½¿ç”¨ç¡¬ç¼–ç æƒé™
- âœ… **åŠ¨æ€åŒæ­¥**ï¼šæƒé™é‡ç½®å§‹ç»ˆä½¿ç”¨æœ€æ–°çš„è§’è‰²æ¨¡æ¿æƒé™
- âœ… **ä¸€è‡´æ€§ä¿è¯**ï¼šè§’è‰²æ¨¡æ¿å˜åŒ–ç«‹å³åæ˜ åˆ°é‡ç½®åŠŸèƒ½
- âœ… **å‘åå…¼å®¹**ï¼šä¿ç•™ç³»ç»Ÿåˆå§‹åŒ–åŠŸèƒ½

ç°åœ¨æƒé™ç®¡ç†ç³»ç»Ÿå®Œå…¨åŸºäºæ•°æ®åº“ï¼Œå®ç°äº†çœŸæ­£çš„åŠ¨æ€æƒé™ç®¡ç†ï¼
