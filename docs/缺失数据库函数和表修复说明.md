# 缺失数据库函数和表修复说明

## 问题描述

数据库缺失以下函数和表：
- **缺失函数**：`get_available_platforms`、`add_custom_platform`、`batch_import_logistics_records`
- **缺失表**：`import_templates`、`import_field_mappings`、`import_fixed_mappings`

## 解决方案

### 1. 创建的文件

#### **完整版脚本**
- `scripts/create-missing-functions-and-tables.sql` - 完整功能版本
- `scripts/test-missing-functions-and-tables.sql` - 完整测试脚本

#### **简化版脚本**
- `scripts/simple-create-missing-functions.sql` - 简化功能版本

### 2. 创建的表结构

#### **import_templates 表**
```sql
CREATE TABLE public.import_templates (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  platform_type VARCHAR(100) NOT NULL, -- waybill, scale, finance等
  template_config JSONB DEFAULT '{}'::jsonb,
  field_mappings JSONB DEFAULT '[]'::jsonb,
  is_active BOOLEAN DEFAULT true,
  is_system BOOLEAN DEFAULT false,
  created_by_user_id UUID,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

#### **import_field_mappings 表**
```sql
CREATE TABLE public.import_field_mappings (
  id UUID PRIMARY KEY,
  template_id UUID REFERENCES import_templates(id),
  excel_column VARCHAR(100) NOT NULL,
  database_field VARCHAR(100) NOT NULL,
  field_type VARCHAR(50) NOT NULL,
  is_required BOOLEAN DEFAULT false,
  validation_rules JSONB DEFAULT '{}'::jsonb,
  default_value TEXT,
  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

#### **import_fixed_mappings 表**
```sql
CREATE TABLE public.import_fixed_mappings (
  id UUID PRIMARY KEY,
  template_id UUID REFERENCES import_templates(id),
  mapping_type VARCHAR(50) NOT NULL, -- location, driver, project等
  excel_value TEXT NOT NULL,
  database_value TEXT NOT NULL,
  is_case_sensitive BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

### 3. 创建的函数

#### **get_available_platforms()**
- **功能**：获取所有使用过的平台列表
- **返回**：平台名称、使用次数、最后使用时间
- **数据源**：从 `external_tracking_numbers` 和 `other_platform_names` 字段提取

#### **add_custom_platform(platform_name, description)**
- **功能**：添加自定义平台
- **参数**：平台名称、描述（可选）
- **返回**：平台ID
- **验证**：检查平台是否已存在

#### **batch_import_logistics_records(records)**
- **功能**：批量导入物流记录
- **参数**：记录JSON数组
- **返回**：JSON对象包含成功数量、错误数量、错误详情
- **特性**：
  - 自动获取项目ID和合作链路ID
  - 自动创建司机记录（如果不存在）
  - 自动生成运单号
  - 支持平台字段（external_tracking_numbers, other_platform_names）
  - 自动重新计算费用
  - 完整的错误处理和日志记录

### 4. 辅助函数

#### **get_import_templates(platform_type)**
- **功能**：获取导入模板列表
- **参数**：平台类型（可选）
- **返回**：模板信息列表

#### **get_template_field_mappings(template_id)**
- **功能**：获取模板字段映射
- **参数**：模板ID
- **返回**：字段映射配置

#### **get_template_fixed_mappings(template_id, mapping_type)**
- **功能**：获取模板固定映射
- **参数**：模板ID、映射类型（可选）
- **返回**：固定映射配置

## 使用方法

### 1. 执行创建脚本

#### **推荐：使用简化版**
```sql
-- 在 Supabase SQL 编辑器中执行
\i scripts/simple-create-missing-functions.sql
```

#### **完整版（如果需要完整功能）**
```sql
-- 在 Supabase SQL 编辑器中执行
\i scripts/create-missing-functions-and-tables.sql
```

### 2. 验证创建结果

```sql
-- 执行测试脚本
\i scripts/test-missing-functions-and-tables.sql
```

### 3. 使用示例

#### **获取可用平台列表**
```sql
SELECT * FROM public.get_available_platforms();
```

#### **添加自定义平台**
```sql
SELECT public.add_custom_platform('新平台', '平台描述');
```

#### **批量导入记录**
```sql
SELECT public.batch_import_logistics_records(
  '[
    {
      "project_name": "测试项目",
      "chain_name": "测试合作链路",
      "driver_name": "测试司机",
      "license_plate": "京A12345",
      "driver_phone": "13800138000",
      "loading_location": "北京仓库",
      "unloading_location": "上海仓库",
      "loading_date": "2025-01-20 10:00:00",
      "unloading_date": "2025-01-21 15:00:00",
      "loading_weight": 1000,
      "unloading_weight": 950,
      "transport_type": "实际运输",
      "current_cost": 500,
      "extra_cost": 50,
      "remarks": "测试备注",
      "external_tracking_numbers": [
        {"platform": "顺丰", "tracking_number": "SF123456789", "status": "pending", "created_at": "2025-01-20T10:00:00Z"}
      ],
      "other_platform_names": ["顺丰"]
    }
  ]'::jsonb
);
```

## 默认数据

### 1. 系统模板
- **名称**：标准运单导入模板
- **类型**：waybill
- **字段映射**：包含运单号、项目名称、司机姓名等核心字段
- **状态**：系统模板，不可删除

### 2. 字段映射配置
- 支持必填字段验证
- 支持数据类型转换
- 支持默认值设置
- 支持显示顺序控制

## 安全设置

### 1. 行级安全 (RLS)
- 所有表都启用了 RLS
- 创建了基本的访问策略
- 支持用户级别的数据隔离

### 2. 权限控制
- 函数使用 `SECURITY DEFINER`
- 支持用户身份验证
- 防止 SQL 注入攻击

## 性能优化

### 1. 索引创建
- 主键索引
- 外键索引
- 查询字段索引
- JSONB 字段 GIN 索引

### 2. 查询优化
- 使用适当的 JOIN 策略
- 避免全表扫描
- 优化 JSONB 查询

## 故障排除

### 1. 常见错误

#### **权限错误**
```sql
-- 检查 RLS 策略
SELECT * FROM pg_policies WHERE tablename = 'import_templates';
```

#### **函数不存在**
```sql
-- 检查函数是否存在
SELECT routine_name FROM information_schema.routines 
WHERE routine_schema = 'public' 
  AND routine_name IN ('get_available_platforms', 'add_custom_platform', 'batch_import_logistics_records');
```

#### **表不存在**
```sql
-- 检查表是否存在
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('import_templates', 'import_field_mappings', 'import_fixed_mappings');
```

### 2. 回滚方案

如果需要回滚，可以执行以下命令：

```sql
-- 删除函数
DROP FUNCTION IF EXISTS public.get_available_platforms();
DROP FUNCTION IF EXISTS public.add_custom_platform(TEXT, TEXT);
DROP FUNCTION IF EXISTS public.batch_import_logistics_records(JSONB, UUID, BOOLEAN);
DROP FUNCTION IF EXISTS public.get_import_templates(VARCHAR);
DROP FUNCTION IF EXISTS public.get_template_field_mappings(UUID);
DROP FUNCTION IF EXISTS public.get_template_fixed_mappings(UUID, VARCHAR);

-- 删除表
DROP TABLE IF EXISTS public.import_fixed_mappings;
DROP TABLE IF EXISTS public.import_field_mappings;
DROP TABLE IF EXISTS public.import_templates;
```

## 更新日志

- **2025-01-20**: 创建缺失的数据库函数和表
- **2025-01-20**: 添加完整的测试脚本
- **2025-01-20**: 创建使用说明文档
- **2025-01-20**: 添加故障排除指南

## 结论

通过执行这些脚本，您的数据库将拥有完整的平台管理、导入模板和批量导入功能。建议先使用简化版脚本进行测试，确认功能正常后再考虑使用完整版功能。
