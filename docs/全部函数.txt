| ?column?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -- 函数: public.add_custom_platform
CREATE OR REPLACE FUNCTION public.add_custom_platform(p_platform_name text, p_description text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  platform_id UUID;
BEGIN
  -- 检查平台是否已存在
  IF EXISTS (
    SELECT 1 FROM public.get_available_platforms() 
    WHERE platform_name ILIKE p_platform_name
  ) THEN
    RAISE EXCEPTION '平台 "%" 已存在', p_platform_name;
  END IF;
  
  -- 这里可以扩展为存储到专门的平台表中
  -- 目前只是返回一个模拟的ID
  platform_id := gen_random_uuid();
  
  -- 记录日志（可选）
  INSERT INTO public.import_templates (
    name, 
    description, 
    platform_type, 
    template_config,
    is_system,
    created_by_user_id
  ) VALUES (
    '自定义平台: ' || p_platform_name,
    COALESCE(p_description, '用户自定义平台'),
    'custom_platform',
    jsonb_build_object('platform_name', p_platform_name),
    false,
    auth.uid()
  );
  
  RETURN platform_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- 函数: public.add_enum_value
CREATE OR REPLACE FUNCTION public.add_enum_value(enum_name text, enum_value text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    type_oid oid;
    sql_statement text;
BEGIN
    -- 获取枚举类型的 OID
    SELECT oid INTO type_oid
    FROM pg_type 
    WHERE typname = enum_name;
    
    IF type_oid IS NULL THEN
        RAISE EXCEPTION '枚举类型 % 不存在', enum_name;
    END IF;
    
    -- 检查值是否已存在
    IF EXISTS(
        SELECT 1 FROM pg_enum 
        WHERE enumtypid = type_oid 
        AND enumlabel = enum_value
    ) THEN
        RAISE EXCEPTION '枚举值 % 已存在于类型 % 中', enum_value, enum_name;
    END IF;
    
    -- 使用动态 SQL 添加枚举值
    sql_statement := format('ALTER TYPE %I ADD VALUE %L', enum_name, enum_value);
    EXECUTE sql_statement;
    
    RAISE NOTICE '成功添加枚举值 % 到类型 %', enum_value, enum_name;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.add_external_tracking_number
CREATE OR REPLACE FUNCTION public.add_external_tracking_number(p_logistics_record_id uuid, p_platform text, p_tracking_number text, p_status text DEFAULT 'pending'::text, p_remarks text DEFAULT NULL::text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_external_tracking JSONB;
  v_new_tracking JSONB;
BEGIN
  -- 获取当前的外部运单号数组
  SELECT external_tracking_numbers INTO v_external_tracking
  FROM public.logistics_records
  WHERE id = p_logistics_record_id;
  
  -- 创建新的运单号对象
  v_new_tracking := jsonb_build_object(
    'platform', p_platform,
    'tracking_number', p_tracking_number,
    'status', p_status,
    'created_at', now()::text,
    'remarks', p_remarks
  );
  
  -- 添加到数组中
  v_external_tracking := v_external_tracking || jsonb_build_array(v_new_tracking);
  
  -- 更新数据库记录
  UPDATE public.logistics_records
  SET external_tracking_numbers = v_external_tracking
  WHERE id = p_logistics_record_id;
  
  RETURN TRUE;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.add_logistics_record_with_costs
CREATE OR REPLACE FUNCTION public.add_logistics_record_with_costs(p_project_id uuid, p_project_name text, p_chain_id uuid, p_driver_id uuid, p_driver_name text, p_loading_location text, p_unloading_location text, p_loading_date text, p_loading_weight numeric, p_unloading_weight numeric, p_current_cost numeric, p_license_plate text, p_driver_phone text, p_transport_type text, p_extra_cost numeric, p_remarks text, p_unloading_date text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  new_record_id uuid;
  driver_payable numeric;
  v_project_code text;
  v_auto_number text;
BEGIN
  -- 【核心修复】在插入运单前，先检查并确保项目有 `auto_code`
  SELECT auto_code INTO v_project_code FROM public.projects WHERE id = p_project_id;
  IF v_project_code IS NULL OR v_project_code = '' THEN
    v_project_code := UPPER(SUBSTRING(p_project_name, 1, 4));
    UPDATE public.projects SET auto_code = v_project_code WHERE id = p_project_id;
  END IF;

  -- 【关键修复】生成运单自动编号
  v_auto_number := public.generate_auto_number(p_loading_date);

  driver_payable := (COALESCE(p_current_cost, 0) + COALESCE(p_extra_cost, 0));

  INSERT INTO public.logistics_records (
    auto_number,
    project_id,
    project_name,
    chain_id,
    driver_id,
    driver_name,
    loading_location,
    unloading_location,
    loading_date,
    unloading_date,
    loading_weight,
    unloading_weight,
    current_cost,
    extra_cost,
    payable_cost,
    license_plate,
    driver_phone,
    transport_type,
    remarks,
    created_by_user_id
  ) VALUES (
    v_auto_number,
    p_project_id,
    p_project_name,
    p_chain_id,
    p_driver_id,
    p_driver_name,
    p_loading_location,
    p_unloading_location,
    p_loading_date,
    p_unloading_date,
    p_loading_weight,
    p_unloading_weight,
    p_current_cost,
    p_extra_cost,
    driver_payable,
    p_license_plate,
    p_driver_phone,
    p_transport_type,
    p_remarks,
    'user'
  ) RETURNING id INTO new_record_id;

  -- 使用更新后的重算函数
  PERFORM public.recalculate_and_update_costs_for_record(new_record_id);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.add_logistics_record_with_costs_v2
CREATE OR REPLACE FUNCTION public.add_logistics_record_with_costs_v2(p_project_id uuid, p_project_name text, p_chain_id uuid, p_driver_id uuid, p_driver_name text, p_loading_location text, p_unloading_location text, p_loading_date text, p_loading_weight numeric, p_unloading_weight numeric, p_current_cost numeric, p_license_plate text, p_driver_phone text, p_transport_type text, p_extra_cost numeric, p_driver_payable_cost numeric, p_remarks text, p_unloading_date text DEFAULT NULL::text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  new_record_id uuid;
  total_payable_cost numeric;
  loading_location_ids uuid[];
  unloading_location_ids uuid[];
BEGIN
  -- 计算总应付费用
  total_payable_cost := COALESCE(p_current_cost, 0) + COALESCE(p_extra_cost, 0);
  
  -- 批量获取或创建装货地点
  loading_location_ids := public.get_or_create_locations_from_string_v2(p_loading_location);
  
  -- 批量获取或创建卸货地点
  unloading_location_ids := public.get_or_create_locations_from_string_v2(p_unloading_location);
  
  -- 创建运单记录
  INSERT INTO public.logistics_records (
    auto_number, project_id, project_name, chain_id, driver_id, driver_name,
    license_plate, loading_location, unloading_location, loading_date, unloading_date,
    loading_weight, unloading_weight, transport_type, current_cost, extra_cost,
    payable_cost, remarks, created_by_user_id, user_id
  ) VALUES (
    'AUTO_' || to_char(now(), 'YYYYMMDD') || '_' || lpad(nextval('logistics_auto_number_seq')::text, 4, '0'),
    p_project_id, p_project_name, p_chain_id, p_driver_id, p_driver_name,
    p_license_plate, p_loading_location, p_unloading_location, 
    p_loading_date::date, 
    CASE WHEN p_unloading_date IS NOT NULL AND p_unloading_date != '' THEN p_unloading_date::date ELSE NULL END,
    p_loading_weight, p_unloading_weight, p_transport_type, p_current_cost, p_extra_cost,
    total_payable_cost, p_remarks, auth.uid(), auth.uid()
  ) RETURNING id INTO new_record_id;
  
  -- 关联装货地点与项目
  IF array_length(loading_location_ids, 1) > 0 THEN
    INSERT INTO public.location_projects (location_id, project_id, user_id)
    SELECT unnest(loading_location_ids), p_project_id, auth.uid()
    ON CONFLICT (location_id, project_id) DO NOTHING;
  END IF;
  
  -- 关联卸货地点与项目
  IF array_length(unloading_location_ids, 1) > 0 THEN
    INSERT INTO public.location_projects (location_id, project_id, user_id)
    SELECT unnest(unloading_location_ids), p_project_id, auth.uid()
    ON CONFLICT (location_id, project_id) DO NOTHING;
  END IF;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.add_logistics_record_with_costs_v2
CREATE OR REPLACE FUNCTION public.add_logistics_record_with_costs_v2(p_project_id uuid, p_chain_id uuid, p_driver_id uuid, p_project_name text, p_chain_name text, p_driver_name text, p_license_plate text, p_driver_phone text, p_loading_location text, p_unloading_location text, p_loading_date text, p_loading_weight numeric, p_transport_type text, p_loading_cost numeric, p_unloading_cost numeric, p_user_id uuid)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    new_record_id uuid;
    loading_location_ids text[];
    unloading_location_ids text[];
BEGIN
    -- 获取或创建地点ID
    loading_location_ids := public.get_or_create_locations_from_string_v2(p_loading_location);
    unloading_location_ids := public.get_or_create_locations_from_string_v2(p_unloading_location);
    
    -- 插入运单记录
    INSERT INTO public.logistics_records (
        auto_number, project_id, chain_id, driver_id, project_name, driver_name,
        license_plate, driver_phone, loading_location, unloading_location, loading_location_ids,
        unloading_location_ids, loading_date, loading_weight, transport_type,
        loading_cost, unloading_cost, user_id, created_by_user_id, created_at
    ) VALUES (
        public.generate_auto_number(p_loading_date), p_project_id, p_chain_id, p_driver_id, p_project_name, p_driver_name,
        p_license_plate, p_driver_phone, p_loading_location, p_unloading_location, loading_location_ids,
        unloading_location_ids, p_loading_date::date, p_loading_weight, p_transport_type,
        p_loading_cost, p_unloading_cost, p_user_id, p_user_id, NOW()
    ) RETURNING id INTO new_record_id;
    
    -- 重新计算成本
    PERFORM public.recalculate_and_update_costs_for_records(ARRAY[new_record_id]);
    
    RETURN new_record_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.apply_standard_rls_policies
CREATE OR REPLACE FUNCTION public.apply_standard_rls_policies(p_table_name text, p_user_id_column text)
 RETURNS void
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
BEGIN
    EXECUTE format('ALTER TABLE public.%I ENABLE ROW LEVEL SECURITY;', p_table_name);
    EXECUTE format('DROP POLICY IF EXISTS "Allow authenticated access" ON public.%I;', p_table_name);
    EXECUTE format('DROP POLICY IF EXISTS "Admins can manage all %s" ON public.%I;', p_table_name, p_table_name);
    EXECUTE format('DROP POLICY IF EXISTS "Users can manage their own %s" ON public.%I;', p_table_name, p_table_name);
    EXECUTE format('CREATE POLICY "Admins can manage all %s" ON public.%I FOR ALL TO authenticated USING (is_admin()) WITH CHECK (is_admin());', p_table_name, p_table_name);
    EXECUTE format('CREATE POLICY "Users can manage their own %s" ON public.%I FOR ALL TO authenticated USING ((auth.uid() = %I)) WITH CHECK ((auth.uid() = %I));', p_table_name, p_table_name, p_user_id_column, p_user_id_column);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.approve_invoice_request
CREATE OR REPLACE FUNCTION public.approve_invoice_request(p_request_id uuid, p_action text, p_remarks text DEFAULT NULL::text)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_request invoice_requests%ROWTYPE;
    v_new_status text;
    result_json json;
BEGIN
    SELECT * INTO v_request FROM invoice_requests WHERE id = p_request_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION '开票申请不存在';
    END IF;

    IF v_request.status != 'Pending' THEN
        RAISE EXCEPTION '只能审批待审批状态的申请';
    END IF;

    IF p_action = 'approve' THEN
        v_new_status := 'Approved';
    ELSIF p_action = 'reject' THEN
        v_new_status := 'Rejected';
    ELSE
        RAISE EXCEPTION '无效的操作类型，只支持 approve 或 reject';
    END IF;

    UPDATE invoice_requests 
    SET 
        status = v_new_status,
        approved_by = auth.uid(),
        approved_at = NOW(),
        remarks = COALESCE(p_remarks, remarks)
    WHERE id = p_request_id;

    IF p_action = 'reject' THEN
        UPDATE logistics_partner_costs 
        SET 
            invoice_status = 'Uninvoiced',
            invoice_request_id = NULL,
            invoice_applied_at = NULL
        WHERE invoice_request_id = p_request_id;
    END IF;

    result_json := json_build_object(
        'success', true,
        'message', CASE 
            WHEN p_action = 'approve' THEN '开票申请已批准'
            ELSE '开票申请已拒绝，相关合作方成本记录状态已恢复'
        END,
        'request_id', p_request_id,
        'new_status', v_new_status
    );

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.auto_assign_new_project_to_users
CREATE OR REPLACE FUNCTION public.auto_assign_new_project_to_users()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- 为新项目分配给所有现有用户
  -- 检查 role 列是否存在
  IF EXISTS (
    SELECT 1 
    FROM information_schema.columns 
    WHERE table_schema = 'public' 
    AND table_name = 'user_projects' 
    AND column_name = 'role'
  ) THEN
    INSERT INTO public.user_projects (user_id, project_id, role, can_view, can_edit, can_delete, created_by)
    SELECT 
      p.id,
      NEW.id,
      'operator'::app_role, -- 默认角色
      true,
      true,
      false,
      (SELECT id FROM public.profiles WHERE role = 'admin' LIMIT 1)
    FROM public.profiles p
    WHERE NOT EXISTS (
      SELECT 1 FROM public.user_projects up 
      WHERE up.user_id = p.id AND up.project_id = NEW.id
    );
  ELSE
    INSERT INTO public.user_projects (user_id, project_id, can_view, can_edit, can_delete, created_by)
    SELECT 
      p.id,
      NEW.id,
      true,
      true,
      false,
      (SELECT id FROM public.profiles WHERE role = 'admin' LIMIT 1)
    FROM public.profiles p
    WHERE NOT EXISTS (
      SELECT 1 FROM public.user_projects up 
      WHERE up.user_id = p.id AND up.project_id = NEW.id
    );
  END IF;
  
  RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.auto_assign_projects_to_new_user
CREATE OR REPLACE FUNCTION public.auto_assign_projects_to_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- 为新用户分配所有现有项目
  -- 检查 role 列是否存在
  IF EXISTS (
    SELECT 1 
    FROM information_schema.columns 
    WHERE table_schema = 'public' 
    AND table_name = 'user_projects' 
    AND column_name = 'role'
  ) THEN
    INSERT INTO public.user_projects (user_id, project_id, role, can_view, can_edit, can_delete, created_by)
    SELECT 
      NEW.id,
      p.id,
      'operator'::app_role, -- 默认角色
      true,
      true,
      false,
      (SELECT id FROM public.profiles WHERE role = 'admin' LIMIT 1)
    FROM public.projects p
    WHERE NOT EXISTS (
      SELECT 1 FROM public.user_projects up 
      WHERE up.user_id = NEW.id AND up.project_id = p.id
    );
  ELSE
    INSERT INTO public.user_projects (user_id, project_id, can_view, can_edit, can_delete, created_by)
    SELECT 
      NEW.id,
      p.id,
      true,
      true,
      false,
      (SELECT id FROM public.profiles WHERE role = 'admin' LIMIT 1)
    FROM public.projects p
    WHERE NOT EXISTS (
      SELECT 1 FROM public.user_projects up 
      WHERE up.user_id = NEW.id AND up.project_id = p.id
    );
  END IF;
  
  RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.auto_create_contract_owner_permissions
CREATE OR REPLACE FUNCTION public.auto_create_contract_owner_permissions()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF NEW.user_id IS NOT NULL THEN
        INSERT INTO public.contract_owner_permissions (contract_id, owner_id)
        VALUES (NEW.id, NEW.user_id)
        ON CONFLICT (contract_id) DO NOTHING;
    END IF;
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.batch_associate_driver_projects
CREATE OR REPLACE FUNCTION public.batch_associate_driver_projects(p_driver_ids uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_result jsonb;
    v_updated_count integer := 0;
    v_skipped_count integer := 0;
    driver_info RECORD;
    v_project_id uuid; -- 明确指定变量名，避免与字段名冲突
    v_current_user_id uuid;
BEGIN
    -- 获取当前用户ID
    v_current_user_id := auth.uid();
    
    -- 检查用户是否已登录
    IF v_current_user_id IS NULL THEN
        RAISE EXCEPTION '用户未登录，无法执行批量关联操作';
    END IF;

    -- 查找每个司机对应的项目
    FOR driver_info IN 
        SELECT * FROM public.find_driver_projects(p_driver_ids)
    LOOP
        -- 如果找到项目，在driver_projects表中创建关联
        IF array_length(driver_info.project_ids, 1) > 0 THEN
            -- 先删除该司机的现有项目关联
            DELETE FROM public.driver_projects 
            WHERE driver_id = driver_info.driver_id;
            
            -- 插入新的项目关联，包含user_id
            FOREACH v_project_id IN ARRAY driver_info.project_ids
            LOOP
                INSERT INTO public.driver_projects (driver_id, project_id, user_id)
                VALUES (driver_info.driver_id, v_project_id, v_current_user_id)
                ON CONFLICT (driver_id, project_id) DO NOTHING;
            END LOOP;
            
            v_updated_count := v_updated_count + 1;
        ELSE
            v_skipped_count := v_skipped_count + 1;
        END IF;
    END LOOP;

    -- 返回结果
    SELECT jsonb_build_object(
        'success', true,
        'updated_count', v_updated_count,
        'skipped_count', v_skipped_count,
        'total_processed', array_length(p_driver_ids, 1),
        'message', format('成功更新 %s 个司机的项目关联，跳过 %s 个未找到项目的司机', v_updated_count, v_skipped_count)
    ) INTO v_result;

    RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.batch_cancel_by_filter
CREATE OR REPLACE FUNCTION public.batch_cancel_by_filter(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid)
 RETURNS integer
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    updated_count integer;
    ids_to_update uuid[];
BEGIN
    -- 步骤 1: 找出所有符合筛选条件且状态为 'Processing' 的记录ID
    SELECT ARRAY_AGG(v.id)
    INTO ids_to_update
    FROM public.logistics_records_view AS v
    JOIN public.logistics_records lr ON v.id = lr.id
    WHERE
        lr.payment_status = 'Processing' AND
        (p_project_id IS NULL OR v.project_id = p_project_id) AND
        (p_start_date IS NULL OR v.loading_date::date >= p_start_date) AND
        (p_end_date IS NULL OR v.loading_date::date <= p_end_date) AND
        (p_partner_id IS NULL OR EXISTS (
            SELECT 1 FROM public.logistics_partner_costs lpc
            WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
        ));

    -- 如果没有找到任何需要更新的记录，则直接返回0
    IF ids_to_update IS NULL OR array_length(ids_to_update, 1) IS NULL THEN
        RETURN 0;
    END IF;

    -- 步骤 2: 更新这些记录的状态
    WITH updated_rows AS (
        UPDATE public.logistics_records
        SET payment_status = 'Unpaid'
        WHERE id = ANY(ids_to_update)
        RETURNING 1
    )
    SELECT count(*) INTO updated_count FROM updated_rows;

    RETURN updated_count;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.batch_cancel_payment_application
CREATE OR REPLACE FUNCTION public.batch_cancel_payment_application(p_record_ids uuid[])
 RETURNS integer
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    updated_count integer;
BEGIN
    WITH updated_rows AS (
        UPDATE public.logistics_records
        SET payment_status = 'Unpaid'
        WHERE id = ANY(p_record_ids) AND payment_status = 'Processing'
        RETURNING 1
    )
    SELECT count(*) INTO updated_count FROM updated_rows;

    RETURN updated_count;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.batch_import_logistics_records
CREATE OR REPLACE FUNCTION public.batch_import_logistics_records(p_records jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_success_count integer := 0;
    v_error_count integer := 0;
    v_errors jsonb := '[]'::jsonb;
    record_data jsonb;
    v_auto_number text;
    v_project_id uuid;
    v_driver_id uuid;
    v_chain_id uuid;
    v_loading_date_formatted text;
    v_unloading_date_formatted text;
    v_new_record_id uuid;
    v_driver_payable numeric;
    v_external_tracking_numbers jsonb;
    v_other_platform_names jsonb;
    v_error_message text;
BEGIN
    -- 逐条处理记录
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        BEGIN
            -- 提取基本字段
            v_loading_date_formatted := (record_data->>'loading_date')::text;
            v_unloading_date_formatted := COALESCE(NULLIF(record_data->>'unloading_date', ''), record_data->>'loading_date')::text;
            
            -- 处理外部跟踪号
            IF record_data->>'external_tracking_numbers' IS NOT NULL AND record_data->>'external_tracking_numbers' != '' THEN
                v_external_tracking_numbers := to_jsonb(string_to_array(record_data->>'external_tracking_numbers', ','));
            ELSE
                v_external_tracking_numbers := '[]'::jsonb;
            END IF;
            
            -- 处理平台名称
            IF record_data->>'other_platform_names' IS NOT NULL AND record_data->>'other_platform_names' != '' THEN
                v_other_platform_names := to_jsonb(string_to_array(record_data->>'other_platform_names', ','));
            ELSE
                v_other_platform_names := '[]'::jsonb;
            END IF;
            
            -- 1. 查找或创建项目
            SELECT id INTO v_project_id 
            FROM public.projects 
            WHERE name = (record_data->>'project_name')::text;
            
            IF v_project_id IS NULL THEN
                v_error_message := '项目不存在: ' || (record_data->>'project_name');
                v_errors := v_errors || jsonb_build_object('error', v_error_message);
                v_error_count := v_error_count + 1;
                CONTINUE;
            END IF;
            
            -- 2. 查找或创建司机
            SELECT id INTO v_driver_id 
            FROM public.drivers 
            WHERE name = (record_data->>'driver_name')::text 
            AND license_plate = (record_data->>'license_plate')::text;
            
            IF v_driver_id IS NULL THEN
                INSERT INTO public.drivers (name, license_plate, phone, user_id)
                VALUES (
                    (record_data->>'driver_name')::text,
                    (record_data->>'license_plate')::text,
                    (record_data->>'driver_phone')::text,
                    auth.uid()
                )
                RETURNING id INTO v_driver_id;
                
                -- 关联司机到项目
                INSERT INTO public.driver_projects (driver_id, project_id, user_id)
                VALUES (v_driver_id, v_project_id, auth.uid())
                ON CONFLICT (driver_id, project_id) DO NOTHING;
            END IF;
            
            -- 3. 查找或创建地点
            INSERT INTO public.locations (name, user_id)
            VALUES ((record_data->>'loading_location')::text, auth.uid())
            ON CONFLICT (name) DO NOTHING;
            
            INSERT INTO public.locations (name, user_id)
            VALUES ((record_data->>'unloading_location')::text, auth.uid())
            ON CONFLICT (name) DO NOTHING;
            
            -- 关联地点到项目
            INSERT INTO public.location_projects (location_id, project_id, user_id)
            SELECT l.id, v_project_id, auth.uid()
            FROM public.locations l
            WHERE l.name IN (
                (record_data->>'loading_location')::text,
                (record_data->>'unloading_location')::text
            )
            ON CONFLICT (location_id, project_id) DO NOTHING;
            
            -- 4. 查找链路
            IF record_data->>'chain_name' IS NOT NULL AND record_data->>'chain_name' != '' THEN
                SELECT id INTO v_chain_id 
                FROM public.partner_chains 
                WHERE chain_name = (record_data->>'chain_name')::text 
                AND project_id = v_project_id;
            END IF;
            
            -- 5. 使用统一的运单编号生成函数
            v_auto_number := public.generate_auto_number(v_loading_date_formatted);
            
            -- 6. 计算费用
            v_driver_payable := COALESCE((record_data->>'current_cost')::numeric, 0) + 
                              COALESCE((record_data->>'extra_cost')::numeric, 0);
            
            -- 7. 插入物流记录
            INSERT INTO public.logistics_records (
                auto_number,
                project_id,
                project_name,
                chain_id,
                driver_id,
                driver_name,
                loading_location,
                unloading_location,
                loading_date,
                unloading_date,
                loading_weight,
                unloading_weight,
                current_cost,
                extra_cost,
                license_plate,
                driver_phone,
                transport_type,
                remarks,
                payable_cost,
                external_tracking_numbers,
                other_platform_names,
                created_by_user_id
            ) VALUES (
                v_auto_number,
                v_project_id,
                (record_data->>'project_name')::text,
                v_chain_id,
                v_driver_id,
                (record_data->>'driver_name')::text,
                (record_data->>'loading_location')::text,
                (record_data->>'unloading_location')::text,
                v_loading_date_formatted::date,
                v_unloading_date_formatted::date,
                NULLIF(record_data->>'loading_weight', '')::numeric,
                NULLIF(record_data->>'unloading_weight', '')::numeric,
                COALESCE((record_data->>'current_cost')::numeric, 0),
                COALESCE((record_data->>'extra_cost')::numeric, 0),
                (record_data->>'license_plate')::text,
                (record_data->>'driver_phone')::text,
                COALESCE(record_data->>'transport_type', '实际运输')::text,
                (record_data->>'remarks')::text,
                v_driver_payable,
                v_external_tracking_numbers,
                v_other_platform_names,
                auth.uid()
            )
            ON CONFLICT (auto_number) DO NOTHING
            RETURNING id INTO v_new_record_id;
            
            -- 如果插入成功
            IF v_new_record_id IS NOT NULL THEN
                v_success_count := v_success_count + 1;
            ELSE
                v_error_message := '运单编号冲突: ' || v_auto_number;
                v_errors := v_errors || jsonb_build_object('error', v_error_message);
                v_error_count := v_error_count + 1;
            END IF;
            
        EXCEPTION WHEN OTHERS THEN
            v_error_message := '记录处理失败: ' || SQLERRM;
            v_errors := v_errors || jsonb_build_object('error', v_error_message);
            v_error_count := v_error_count + 1;
        END;
    END LOOP;
    
    -- 返回结果
    RETURN jsonb_build_object(
        'success_count', v_success_count,
        'error_count', v_error_count,
        'errors', v_errors
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.batch_import_logistics_records_backup_base
CREATE OR REPLACE FUNCTION public.batch_import_logistics_records_backup_base(p_records jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$DECLARE
    record_data jsonb;
    success_count integer := 0;
    error_count integer := 0;
    errors_json jsonb := '[]'::jsonb;
    project_record record;
    driver_result record;
    chain_id_val uuid;
    loading_date_formatted text;
    unloading_date_formatted text;
    new_record_id uuid;
    v_auto_number text;
    driver_payable numeric;
BEGIN
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        BEGIN
            -- Get project
            SELECT id, name INTO project_record
            FROM public.projects WHERE name = (record_data->>'project_name') LIMIT 1;
            
            -- Get or create driver
            SELECT driver_id, driver_name INTO driver_result
            FROM public.get_or_create_driver(
                (record_data->>'driver_name'), 
                (record_data->>'license_plate'), 
                (record_data->>'driver_phone'), 
                project_record.id
            ) LIMIT 1;
            
            -- Get or create locations
            PERFORM public.get_or_create_location((record_data->>'loading_location'), project_record.id);
            PERFORM public.get_or_create_location((record_data->>'unloading_location'), project_record.id);

            -- Get chain ID
            chain_id_val := NULL;
            IF (record_data->>'chain_name') IS NOT NULL AND (record_data->>'chain_name') != '' THEN
                SELECT id INTO chain_id_val
                FROM public.partner_chains 
                WHERE project_id = project_record.id AND chain_name = (record_data->>'chain_name') 
                LIMIT 1;
            END IF;

            -- Prepare dates
            loading_date_formatted := (record_data->>'loading_date');
            unloading_date_formatted := COALESCE(NULLIF(record_data->>'unloading_date', ''), loading_date_formatted);
            
            -- Generate auto number
            v_auto_number := EXTRACT(YEAR FROM loading_date_formatted::date)::text || 
                             LPAD(EXTRACT(MONTH FROM loading_date_formatted::date)::text, 2, '0') || 
                             LPAD(EXTRACT(DAY FROM loading_date_formatted::date)::text, 2, '0') || 
                             LPAD((EXTRACT(EPOCH FROM NOW()) % 86400)::integer::text, 5, '0');
            
            -- Calculate driver payable
            driver_payable := COALESCE((record_data->>'current_cost')::numeric, 0) + 
                              COALESCE((record_data->>'extra_cost')::numeric, 0);

            -- Insert record
            INSERT INTO public.logistics_records (
                auto_number, project_id, project_name, chain_id, driver_id, driver_name, 
                loading_location, unloading_location, loading_date, unloading_date, 
                loading_weight, unloading_weight, current_cost, extra_cost,
                license_plate, driver_phone, transport_type, remarks, payable_cost, 
                created_by_user_id
            ) VALUES (
                v_auto_number, project_record.id, project_record.name, chain_id_val, 
                driver_result.driver_id, driver_result.driver_name,
                (record_data->>'loading_location'), (record_data->>'unloading_location'),
                loading_date_formatted::timestamptz, unloading_date_formatted::timestamptz,
                NULLIF((record_data->>'loading_weight')::text, '')::numeric, 
                NULLIF((record_data->>'unloading_weight')::text, '')::numeric,
                COALESCE((record_data->>'current_cost')::numeric, 0), 
                COALESCE((record_data->>'extra_cost')::numeric, 0),
                (record_data->>'license_plate'), (record_data->>'driver_phone'),
                COALESCE((record_data->>'transport_type'),'实际运输'), (record_data->>'remarks'),
                driver_payable, 'batch_import_user'
            ) RETURNING id INTO new_record_id;

            -- Recalculate partner costs
            PERFORM public.recalculate_and_update_costs_for_record(new_record_id);
            success_count := success_count + 1;

        EXCEPTION WHEN OTHERS THEN
            errors_json := errors_json || jsonb_build_object('record', record_data, 'error', SQLERRM);
            error_count := error_count + 1;
        END;
    END LOOP;

    RETURN jsonb_build_object(
        'success_count', success_count, 
        'error_count', error_count, 
        'errors', errors_json
    );
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.batch_import_logistics_records_with_update
CREATE OR REPLACE FUNCTION public.batch_import_logistics_records_with_update(p_records jsonb, p_update_mode boolean DEFAULT false)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_success_count integer := 0;
    v_error_count integer := 0;
    v_insert_count integer := 0;
    v_update_count integer := 0;
    v_inserted_ids uuid[] := '{}';
    v_updated_ids uuid[] := '{}';
    v_error_details jsonb := '[]'::jsonb;
    v_record_index integer := 0;
    record_data jsonb;
    existing_record_id uuid;
    chain_id_val uuid;
    project_id_val uuid;
    driver_id_val uuid;
    auto_number_val text;
    inserted_record_id uuid;
    update_result record;
    effective_billing_type_id bigint;
    v_other_platform_names text[];
    v_external_tracking_numbers text[];
BEGIN
    -- 处理每条记录
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        v_record_index := v_record_index + 1;
        BEGIN
            -- 1. 获取项目ID
            SELECT id INTO project_id_val
            FROM public.projects 
            WHERE name = TRIM(record_data->>'project_name')
            LIMIT 1;

            IF project_id_val IS NULL THEN
                RAISE EXCEPTION '项目不存在: %', record_data->>'project_name';
            END IF;

            -- 2. 处理链路和计费类型
            chain_id_val := NULL;
            effective_billing_type_id := 1; -- 默认值

            IF record_data->>'chain_name' IS NOT NULL AND TRIM(record_data->>'chain_name') != '' THEN
                -- 先查找指定链路
                SELECT id, billing_type_id INTO chain_id_val, effective_billing_type_id
                FROM public.partner_chains 
                WHERE chain_name = TRIM(record_data->>'chain_name')
                AND project_id = project_id_val
                LIMIT 1;

                -- 如果找不到，使用默认链路
                IF chain_id_val IS NULL THEN
                    SELECT id, billing_type_id INTO chain_id_val, effective_billing_type_id
                    FROM public.partner_chains 
                    WHERE project_id = project_id_val AND is_default = true
                    LIMIT 1;
                    
                    -- 如果连默认链路都没有，报错
                    IF chain_id_val IS NULL THEN
                        RAISE EXCEPTION '项目 % 没有配置合作链路，请先创建链路', record_data->>'project_name';
                    END IF;
                END IF;
            ELSE
                -- 如果没有指定链路名称，使用默认链路
                SELECT id, billing_type_id INTO chain_id_val, effective_billing_type_id
                FROM public.partner_chains 
                WHERE project_id = project_id_val AND is_default = true
                LIMIT 1;
                
                IF chain_id_val IS NULL THEN
                    RAISE EXCEPTION '项目 % 没有配置默认链路，请先创建链路', record_data->>'project_name';
                END IF;
            END IF;

            -- 3. 处理司机信息
            SELECT id INTO driver_id_val
            FROM public.drivers 
            WHERE name = TRIM(record_data->>'driver_name')
            AND license_plate = TRIM(record_data->>'license_plate')
            LIMIT 1;

            IF driver_id_val IS NULL THEN
                INSERT INTO public.drivers (name, license_plate, phone, user_id)
                VALUES (
                    TRIM(record_data->>'driver_name'),
                    TRIM(record_data->>'license_plate'),
                    TRIM(record_data->>'driver_phone'),
                    auth.uid()
                )
                RETURNING id INTO driver_id_val;
            END IF;

            -- 4. 处理 other_platform_names 字段（修正类型转换）
            v_other_platform_names := '{}'::text[];
            IF record_data->'other_platform_names' IS NOT NULL THEN
                -- 将 jsonb 数组转换为 text[] 数组
                SELECT array_agg(value::text) INTO v_other_platform_names
                FROM jsonb_array_elements_text(record_data->'other_platform_names')
                WHERE value::text != '';
                
                -- 如果转换后为空，设置为空数组
                IF v_other_platform_names IS NULL THEN
                    v_other_platform_names := '{}'::text[];
                END IF;
            END IF;

            -- 5. 处理 external_tracking_numbers 字段（存储为TEXT[]数组，每个元素可能包含|分隔的多个运单号）
            v_external_tracking_numbers := '{}'::text[];
            IF record_data->'external_tracking_numbers' IS NOT NULL THEN
                -- 将 jsonb 数组转换为 text[] 数组
                -- Excel格式：2021615278|2021615821
                -- 数据库格式：{"2021615278|2021615821"} (TEXT[]数组)
                SELECT array_agg(value::text) INTO v_external_tracking_numbers
                FROM jsonb_array_elements_text(record_data->'external_tracking_numbers')
                WHERE value::text != '';
                
                -- 如果转换后为空，设置为空数组
                IF v_external_tracking_numbers IS NULL THEN
                    v_external_tracking_numbers := '{}'::text[];
                END IF;
            END IF;

            -- 6. 检查是否存在重复记录
            SELECT id INTO existing_record_id
            FROM public.logistics_records
            WHERE project_name = TRIM(record_data->>'project_name')
            AND driver_name = TRIM(record_data->>'driver_name')
            AND license_plate = TRIM(record_data->>'license_plate')
            AND loading_location = TRIM(record_data->>'loading_location')
            AND unloading_location = TRIM(record_data->>'unloading_location')
            AND loading_date = (record_data->>'loading_date')::timestamptz
            AND loading_weight = (record_data->>'loading_weight')::numeric;

            IF existing_record_id IS NOT NULL AND p_update_mode THEN
                -- 更新模式：更新现有记录
                UPDATE public.logistics_records SET
                    project_id = project_id_val,
                    project_name = TRIM(record_data->>'project_name'),
                    chain_id = chain_id_val,
                    billing_type_id = effective_billing_type_id,
                    driver_id = driver_id_val,
                    driver_name = TRIM(record_data->>'driver_name'),
                    license_plate = TRIM(record_data->>'license_plate'),
                    driver_phone = TRIM(record_data->>'driver_phone'),
                    loading_location = TRIM(record_data->>'loading_location'),
                    unloading_location = TRIM(record_data->>'unloading_location'),
                    loading_date = (record_data->>'loading_date')::timestamptz,
                    unloading_date = CASE WHEN record_data->>'unloading_date' IS NOT NULL AND TRIM(record_data->>'unloading_date') != '' 
                                         THEN (record_data->>'unloading_date')::timestamptz ELSE NULL END,
                    loading_weight = (record_data->>'loading_weight')::numeric,
                    unloading_weight = CASE WHEN record_data->>'unloading_weight' IS NOT NULL AND TRIM(record_data->>'unloading_weight') != '' 
                                           THEN (record_data->>'unloading_weight')::numeric ELSE NULL END,
                    current_cost = CASE WHEN record_data->>'current_cost' IS NOT NULL AND TRIM(record_data->>'current_cost') != '' 
                                       THEN (record_data->>'current_cost')::numeric ELSE 0 END,
                    extra_cost = CASE WHEN record_data->>'extra_cost' IS NOT NULL AND TRIM(record_data->>'extra_cost') != '' 
                                     THEN (record_data->>'extra_cost')::numeric ELSE 0 END,
                    payable_cost = CASE WHEN record_data->>'current_cost' IS NOT NULL AND TRIM(record_data->>'current_cost') != '' 
                                       THEN (record_data->>'current_cost')::numeric ELSE 0 END +
                                  CASE WHEN record_data->>'extra_cost' IS NOT NULL AND TRIM(record_data->>'extra_cost') != '' 
                                       THEN (record_data->>'extra_cost')::numeric ELSE 0 END, -- payable_cost = current_cost + extra_cost
                    transport_type = COALESCE(TRIM(record_data->>'transport_type'), '实际运输'),
                    remarks = TRIM(record_data->>'remarks'),
                    external_tracking_numbers = v_external_tracking_numbers,
                    other_platform_names = v_other_platform_names
                WHERE id = existing_record_id
                RETURNING id INTO update_result.id;

                v_updated_ids := v_updated_ids || existing_record_id;
                v_update_count := v_update_count + 1;

                -- 重新计算成本
                PERFORM public.recalculate_and_update_costs_for_record(existing_record_id);
            ELSE
                -- 创建模式：插入新记录
                auto_number_val := public.generate_auto_number(record_data->>'loading_date');

                INSERT INTO public.logistics_records (
                    auto_number, project_id, project_name, chain_id, billing_type_id,
                    driver_id, driver_name, loading_location, unloading_location,
                    loading_date, unloading_date, loading_weight, unloading_weight,
                    current_cost, extra_cost, payable_cost, license_plate, driver_phone,
                    transport_type, remarks, created_by_user_id, user_id,
                    external_tracking_numbers, other_platform_names
                ) VALUES (
                    auto_number_val, project_id_val, TRIM(record_data->>'project_name'),
                    chain_id_val, effective_billing_type_id,
                    driver_id_val, TRIM(record_data->>'driver_name'),
                    TRIM(record_data->>'loading_location'), TRIM(record_data->>'unloading_location'),
                    (record_data->>'loading_date')::timestamptz,
                    CASE WHEN record_data->>'unloading_date' IS NOT NULL AND TRIM(record_data->>'unloading_date') != '' 
                         THEN (record_data->>'unloading_date')::timestamptz ELSE NULL END,
                    (record_data->>'loading_weight')::numeric,
                    CASE WHEN record_data->>'unloading_weight' IS NOT NULL AND TRIM(record_data->>'unloading_weight') != '' 
                         THEN (record_data->>'unloading_weight')::numeric ELSE NULL END,
                    CASE WHEN record_data->>'current_cost' IS NOT NULL AND TRIM(record_data->>'current_cost') != '' 
                         THEN (record_data->>'current_cost')::numeric ELSE 0 END,
                    CASE WHEN record_data->>'extra_cost' IS NOT NULL AND TRIM(record_data->>'extra_cost') != '' 
                         THEN (record_data->>'extra_cost')::numeric ELSE 0 END,
                    CASE WHEN record_data->>'current_cost' IS NOT NULL AND TRIM(record_data->>'current_cost') != '' 
                         THEN (record_data->>'current_cost')::numeric ELSE 0 END +
                    CASE WHEN record_data->>'extra_cost' IS NOT NULL AND TRIM(record_data->>'extra_cost') != '' 
                         THEN (record_data->>'extra_cost')::numeric ELSE 0 END, -- payable_cost = current_cost + extra_cost
                    TRIM(record_data->>'license_plate'),
                    TRIM(record_data->>'driver_phone'),
                    COALESCE(TRIM(record_data->>'transport_type'), '实际运输'),
                    TRIM(record_data->>'remarks'),
                    auth.uid(),
                    auth.uid(),
                    v_external_tracking_numbers,
                    v_other_platform_names
                )
                RETURNING id INTO inserted_record_id;

                v_inserted_ids := v_inserted_ids || inserted_record_id;
                v_insert_count := v_insert_count + 1;

                -- 重新计算成本
                PERFORM public.recalculate_and_update_costs_for_record(inserted_record_id);
            END IF;

            v_success_count := v_success_count + 1;

        EXCEPTION WHEN OTHERS THEN
            v_error_count := v_error_count + 1;
            v_error_details := v_error_details || jsonb_build_object(
                'record_index', v_record_index,
                'error_message', SQLERRM,
                'record_data', record_data
            );
        END;
    END LOOP;

    -- 返回结果
    RETURN jsonb_build_object(
        'success_count', v_success_count,
        'error_count', v_error_count,
        'insert_count', v_insert_count,
        'update_count', v_update_count,
        'inserted_ids', v_inserted_ids,
        'updated_ids', v_updated_ids,
        'error_details', v_error_details
    );
END;
$function$
;
 |
| -- 函数: public.batch_import_logistics_records_with_update
CREATE OR REPLACE FUNCTION public.batch_import_logistics_records_with_update(p_records jsonb, p_update_options jsonb DEFAULT '{}'::jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_inserted_ids uuid[];
    v_updated_ids uuid[];
    v_success_count integer;
    v_error_count integer;
    v_update_count integer;
    record_data jsonb;
    update_option jsonb;
    existing_record_id uuid;
    existing_auto_number text;
    chain_id_val uuid;
    project_id_val uuid;
    chain_name_val text;
    loading_date_formatted text;
BEGIN
    -- 初始化计数器
    v_success_count := 0;
    v_error_count := 0;
    v_update_count := 0;
    v_inserted_ids := ARRAY[]::uuid[];
    v_updated_ids := ARRAY[]::uuid[];

    -- 处理每条记录
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        BEGIN
            -- 获取项目ID
            SELECT id INTO project_id_val FROM public.projects WHERE name = TRIM(record_data->>'project_name');
            
            -- 获取合作链路ID
            chain_name_val := TRIM(record_data->>'chain_name');
            IF chain_name_val IS NOT NULL AND chain_name_val != '' THEN
                SELECT id INTO chain_id_val 
                FROM public.partner_chains 
                WHERE chain_name = chain_name_val AND project_id = project_id_val;
            ELSE
                chain_id_val := NULL;
            END IF;

            -- 日期处理
            loading_date_formatted := TRIM(record_data->>'loading_date');

            -- 检查是否为重复记录
            SELECT 
                lr.id,
                lr.auto_number
            INTO existing_record_id, existing_auto_number
            FROM public.logistics_records lr
            WHERE
                TRIM(lr.project_name) = TRIM(record_data->>'project_name')
                AND lr.chain_id = chain_id_val
                AND TRIM(lr.driver_name) = TRIM(record_data->>'driver_name')
                AND TRIM(lr.license_plate) = TRIM(record_data->>'license_plate')
                AND TRIM(lr.loading_location) = TRIM(record_data->>'loading_location')
                AND TRIM(lr.unloading_location) = TRIM(record_data->>'unloading_location')
                AND lr.loading_date::date = loading_date_formatted::date
                AND lr.loading_weight = (record_data->>'loading_weight')::numeric
            LIMIT 1;

            -- 如果是重复记录，检查更新选项
            IF existing_record_id IS NOT NULL THEN
                -- 查找对应的更新选项
                update_option := p_update_options->existing_record_id::text;
                
                IF update_option IS NOT NULL AND (update_option->>'action') = 'update' THEN
                    -- 执行更新操作
                    UPDATE public.logistics_records SET
                        unloading_date = CASE 
                            WHEN (record_data->>'unloading_date') IS NOT NULL AND (record_data->>'unloading_date') != '' 
                            THEN ((record_data->>'unloading_date') || ' 00:00:00+08:00')::timestamptz AT TIME ZONE 'UTC'
                            ELSE unloading_date
                        END,
                        unloading_weight = CASE 
                            WHEN (record_data->>'unloading_weight') IS NOT NULL AND (record_data->>'unloading_weight') != '' 
                            THEN (record_data->>'unloading_weight')::numeric
                            ELSE unloading_weight
                        END,
                        current_cost = CASE 
                            WHEN (record_data->>'current_cost') IS NOT NULL AND (record_data->>'current_cost') != '' 
                            THEN (record_data->>'current_cost')::numeric
                            ELSE current_cost
                        END,
                        extra_cost = CASE 
                            WHEN (record_data->>'extra_cost') IS NOT NULL AND (record_data->>'extra_cost') != '' 
                            THEN (record_data->>'extra_cost')::numeric
                            ELSE extra_cost
                        END,
                        transport_type = CASE 
                            WHEN (record_data->>'transport_type') IS NOT NULL AND (record_data->>'transport_type') != '' 
                            THEN (record_data->>'transport_type')
                            ELSE transport_type
                        END,
                        remarks = CASE 
                            WHEN (record_data->>'remarks') IS NOT NULL AND (record_data->>'remarks') != '' 
                            THEN (record_data->>'remarks')
                            ELSE remarks
                        END,
                        platform_trackings = CASE 
                            WHEN (record_data->>'platform_trackings') IS NOT NULL 
                            THEN (record_data->>'platform_trackings')::jsonb
                            ELSE platform_trackings
                        END,
                        payable_cost = CASE 
                            WHEN (record_data->>'current_cost') IS NOT NULL AND (record_data->>'current_cost') != '' 
                                 AND (record_data->>'extra_cost') IS NOT NULL AND (record_data->>'extra_cost') != ''
                            THEN ((record_data->>'current_cost')::numeric + (record_data->>'extra_cost')::numeric)
                            ELSE payable_cost
                        END,
                        updated_at = NOW()
                    WHERE id = existing_record_id;
                    
                    v_updated_ids := array_append(v_updated_ids, existing_record_id);
                    v_update_count := v_update_count + 1;
                ELSE
                    -- 创建新记录（默认行为或明确选择创建新记录）
                    -- 这里可以调用原有的插入逻辑
                    -- 为了简化，这里先跳过，实际实现时需要完整的插入逻辑
                    v_error_count := v_error_count + 1;
                END IF;
            ELSE
                -- 新记录，执行插入操作
                -- 这里需要完整的插入逻辑，为了简化先跳过
                v_success_count := v_success_count + 1;
            END IF;

        EXCEPTION WHEN OTHERS THEN
            v_error_count := v_error_count + 1;
        END;
    END LOOP;

    -- 返回结果
    RETURN jsonb_build_object(
        'success_count', v_success_count,
        'update_count', v_update_count,
        'error_count', v_error_count,
        'inserted_ids', v_inserted_ids,
        'updated_ids', v_updated_ids
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.batch_import_logistics_records—buneng
CREATE OR REPLACE FUNCTION public."batch_import_logistics_records—buneng"(p_records jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$DECLARE
    record_data jsonb;
    success_count integer := 0;
    error_count integer := 0;
    errors_json jsonb := '[]'::jsonb;
    project_record record; -- 现在会包含 billing_type_id
    driver_result record;
    chain_id_val uuid;
    loading_date_formatted text;
    unloading_date_formatted text;
    new_record_id uuid;
    v_auto_number text;
    driver_payable numeric;
BEGIN
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        BEGIN
            -- 步骤 1: 获取项目信息，这次也一并获取 billing_type_id
            SELECT id, name, billing_type_id INTO project_record
            FROM public.projects WHERE name = (record_data->>'project_name') LIMIT 1;

            -- 如果找不到项目，则跳过这条记录
            IF project_record.id IS NULL THEN
                RAISE EXCEPTION 'Project not found: %', (record_data->>'project_name');
            END IF;
            
            -- Get or create driver
            SELECT driver_id, driver_name INTO driver_result
            FROM public.get_or_create_driver(
                (record_data->>'driver_name'), 
                (record_data->>'license_plate'), 
                (record_data->>'driver_phone'), 
                project_record.id
            ) LIMIT 1;
            
            -- Get or create locations
            PERFORM public.get_or_create_location((record_data->>'loading_location'), project_record.id);
            PERFORM public.get_or_create_location((record_data->>'unloading_location'), project_record.id);

            -- Get chain ID
            chain_id_val := NULL;
            IF (record_data->>'chain_name') IS NOT NULL AND (record_data->>'chain_name') != '' THEN
                SELECT id INTO chain_id_val
                FROM public.partner_chains 
                WHERE project_id = project_record.id AND chain_name = (record_data->>'chain_name') 
                LIMIT 1;
            END IF;

            -- Prepare dates
            loading_date_formatted := (record_data->>'loading_date');
            unloading_date_formatted := COALESCE(NULLIF(record_data->>'unloading_date', ''), loading_date_formatted);
            
            -- Generate auto number
            v_auto_number := EXTRACT(YEAR FROM loading_date_formatted::date)::text || 
                             LPAD(EXTRACT(MONTH FROM loading_date_formatted::date)::text, 2, '0') || 
                             LPAD(EXTRACT(DAY FROM loading_date_formatted::date)::text, 2, '0') || 
                             LPAD((EXTRACT(EPOCH FROM NOW()) % 86400)::integer::text, 5, '0');
            
            -- Calculate driver payable
            driver_payable := COALESCE((record_data->>'current_cost')::numeric, 0) + 
                              COALESCE((record_data->>'extra_cost')::numeric, 0);

            -- 步骤 2: 在 INSERT 语句中加入 billing_type_id 字段
            INSERT INTO public.logistics_records (
                auto_number, project_id, project_name, chain_id, driver_id, driver_name, 
                loading_location, unloading_location, loading_date, unloading_date, 
                loading_weight, unloading_weight, current_cost, extra_cost,
                license_plate, driver_phone, transport_type, remarks, payable_cost, 
                created_by_user_id, billing_type_id -- ★★★ 新增字段 ★★★
            ) VALUES (
                v_auto_number, project_record.id, project_record.name, chain_id_val, 
                driver_result.driver_id, driver_result.driver_name,
                (record_data->>'loading_location'), (record_data->>'unloading_location'),
                loading_date_formatted::timestamptz, unloading_date_formatted::timestamptz,
                NULLIF((record_data->>'loading_weight')::text, '')::numeric, 
                NULLIF((record_data->>'unloading_weight')::text, '')::numeric,
                COALESCE((record_data->>'current_cost')::numeric, 0), 
                COALESCE((record_data->>'extra_cost')::numeric, 0),
                (record_data->>'license_plate'), (record_data->>'driver_phone'),
                COALESCE((record_data->>'transport_type'),'实际运输'), (record_data->>'remarks'),
                driver_payable, 'batch_import_user',
                project_record.billing_type_id -- ★★★ 插入从项目中获取的值 ★★★
            ) RETURNING id INTO new_record_id;

            -- Recalculate partner costs
            PERFORM public.recalculate_and_update_costs_for_record(new_record_id);
            success_count := success_count + 1;

        EXCEPTION WHEN OTHERS THEN
            errors_json := errors_json || jsonb_build_object('record', record_data, 'error', SQLERRM);
            error_count := error_count + 1;
        END;
    END LOOP;

    RETURN jsonb_build_object(
        'success_count', success_count, 
        'error_count', error_count, 
        'errors', errors_json
    );
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.batch_recalculate_by_filter
CREATE OR REPLACE FUNCTION public.batch_recalculate_by_filter(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    filtered_record_ids uuid[];
BEGIN
    -- 步骤 1: 根据传入的筛选条件，获取所有需要重算的运单ID
    SELECT ARRAY_AGG(v.id)
    INTO filtered_record_ids
    FROM public.logistics_records_view AS v
    WHERE
        (p_project_id IS NULL OR v.project_id = p_project_id) AND
        (p_start_date IS NULL OR v.loading_date::date >= p_start_date::date) AND
        (p_end_date IS NULL OR v.loading_date::date <= p_end_date::date) AND
        (p_partner_id IS NULL OR EXISTS (
            SELECT 1 FROM public.logistics_partner_costs lpc
            WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
        ));

    -- 如果没有找到记录，则提前退出
    IF COALESCE(array_length(filtered_record_ids, 1), 0) = 0 THEN
        RETURN;
    END IF;

    -- 步骤 2: 使用批量计算函数
    PERFORM public.bulk_calculate_partner_costs(filtered_record_ids);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.batch_recalculate_by_filter
CREATE OR REPLACE FUNCTION public.batch_recalculate_by_filter(p_project_id uuid, p_partner_id uuid, p_start_date text, p_end_date text)
 RETURNS void
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    filtered_record_ids uuid[];
BEGIN
    -- 步骤 1: 根据传入的筛选条件，获取所有需要重算的运单ID (此部分逻辑不变)
    SELECT ARRAY_AGG(v.id)
    INTO filtered_record_ids
    FROM public.logistics_records_view AS v
    WHERE
        (p_project_id IS NULL OR v.project_id = p_project_id) AND
        (p_start_date IS NULL OR v.loading_date::date >= p_start_date::date) AND
        (p_end_date IS NULL OR v.loading_date::date <= p_end_date::date) AND
        (p_partner_id IS NULL OR EXISTS (
            SELECT 1 FROM public.logistics_partner_costs lpc
            WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
        ));

    -- 如果没有找到记录，则提前退出
    IF COALESCE(array_length(filtered_record_ids, 1), 0) = 0 THEN
        RETURN;
    END IF;

    -- 步骤 2: [已重构] 执行集合式操作，不再使用循环

    -- 2.1: 一次性删除所有相关运单的现有合作方成本
    DELETE FROM public.logistics_partner_costs
    WHERE logistics_record_id = ANY(filtered_record_ids);

    -- 2.2: [核心重构] 使用一个 CTE (公共表表达式) 和一个 INSERT ... SELECT 语句，
    --      一次性为所有相关运单计算并插入新的成本。
    WITH records_to_process AS (
        -- 这个 CTE 预处理所有需要计算的运单，并准备好所有基础数据
        SELECT
            lr.id,
            lr.project_id,
            -- [逻辑翻译] 确定有效链路ID: 优先用运单自带的，否则用项目的默认链路
            COALESCE(lr.chain_id, dc.id) AS effective_chain_id,
            -- [逻辑翻译] 计算基础应付金额
            (COALESCE(lr.current_cost, 0) + COALESCE(lr.extra_cost, 0)) AS base_payable_amount,
            -- [逻辑翻译] 计算有效重量
            COALESCE(
                NULLIF(LEAST(COALESCE(lr.loading_weight, 999999), COALESCE(lr.unloading_weight, 999999)), 999999),
                COALESCE(lr.loading_weight, lr.unloading_weight, 0)
            ) AS effective_weight
        FROM
            public.logistics_records lr
        -- 左连接到默认链路表，以便在运单没有指定链路时使用
        LEFT JOIN
            public.partner_chains dc ON lr.project_id = dc.project_id AND dc.is_default = true
        WHERE
            lr.id = ANY(filtered_record_ids)
    )
    -- [逻辑翻译] 将计算结果一次性插入成本表
    INSERT INTO public.logistics_partner_costs
        (logistics_record_id, partner_id, level, base_amount, payable_amount, tax_rate, created_at, updated_at)
    SELECT
        rec.id AS logistics_record_id,
        pp.partner_id,
        pp.level,
        rec.base_payable_amount AS base_amount,
        -- [逻辑翻译] 这是最核心的成本计算逻辑，使用 CASE 语句完美复刻了您的 IF/ELSE 逻辑
        CASE
            WHEN pp.calculation_method = 'profit' THEN
                CASE
                    WHEN rec.effective_weight > 0 THEN
                        rec.base_payable_amount + (COALESCE(pp.profit_rate, 0) * rec.effective_weight)
                    ELSE
                        rec.base_payable_amount + COALESCE(pp.profit_rate, 0)
                END
            ELSE -- 默认为税点法
                CASE
                    WHEN pp.tax_rate IS NOT NULL AND pp.tax_rate <> 1 THEN
                        rec.base_payable_amount / (1 - pp.tax_rate)
                    ELSE
                        rec.base_payable_amount
                END
        END AS payable_amount,
        pp.tax_rate,
        now() as created_at,
        now() as updated_at
    FROM
        records_to_process rec
    -- 将处理好的运单记录，与其有效链路上的所有合作方进行连接
    JOIN
        public.project_partners pp ON rec.effective_chain_id = pp.chain_id
    -- 确保只处理有有效链路的记录
    WHERE
        rec.effective_chain_id IS NOT NULL AND rec.base_payable_amount > 0;

END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- 函数: public.batch_recalculate_partner_costs
CREATE OR REPLACE FUNCTION public.batch_recalculate_partner_costs(p_record_ids uuid[])
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    record_id uuid;
BEGIN
    -- 使用批量计算函数而不是循环单个计算
    PERFORM public.bulk_calculate_partner_costs(p_record_ids);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.batch_update_location_geocoding
CREATE OR REPLACE FUNCTION public.batch_update_location_geocoding(p_locations jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    location_item JSONB;
    result JSONB := '{"success": 0, "failed": 0, "errors": []}';
    success_count INTEGER := 0;
    failed_count INTEGER := 0;
    errors JSONB := '[]';
BEGIN
    -- 遍历每个地点
    FOR location_item IN SELECT * FROM jsonb_array_elements(p_locations) LOOP
        BEGIN
            PERFORM public.update_location_geocoding(
                (location_item->>'id')::UUID,
                location_item->>'address',
                (location_item->>'latitude')::DECIMAL,
                (location_item->>'longitude')::DECIMAL,
                location_item->>'formatted_address',
                location_item->>'province',
                location_item->>'city',
                location_item->>'district',
                location_item->>'township',
                location_item->>'street',
                location_item->>'street_number',
                location_item->>'adcode',
                location_item->>'citycode',
                COALESCE((location_item->>'status')::geocoding_status, 'success'),
                location_item->>'error'
            );
            
            success_count := success_count + 1;
        EXCEPTION
            WHEN OTHERS THEN
                failed_count := failed_count + 1;
                errors := errors || jsonb_build_object(
                    'location_id', location_item->>'id',
                    'error', SQLERRM
                );
        END;
    END LOOP;
    
    result := jsonb_build_object(
        'success', success_count,
        'failed', failed_count,
        'errors', errors
    );
    
    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.batch_update_permissions
CREATE OR REPLACE FUNCTION public.batch_update_permissions(p_permissions jsonb)
 RETURNS TABLE(updated_count integer, inserted_count integer, error_count integer)
 LANGUAGE plpgsql
AS $function$
DECLARE
    perm_record JSONB;
    updated_count integer := 0;
    inserted_count integer := 0;
    error_count integer := 0;
BEGIN
    -- 遍历权限数据
    FOR perm_record IN SELECT * FROM jsonb_array_elements(p_permissions)
    LOOP
        BEGIN
            -- 使用 UPSERT 更新或插入权限
            INSERT INTO user_permissions (
                user_id,
                project_id,
                menu_permissions,
                function_permissions,
                project_permissions,
                data_permissions,
                created_by
            ) VALUES (
                (perm_record->>'user_id')::uuid,
                CASE 
                    WHEN perm_record->>'project_id' IS NOT NULL 
                    THEN (perm_record->>'project_id')::uuid 
                    ELSE NULL 
                END,
                CASE 
                    WHEN perm_record->'menu_permissions' IS NOT NULL 
                    THEN (perm_record->'menu_permissions')::text[]
                    ELSE '{}'::text[]
                END,
                CASE 
                    WHEN perm_record->'function_permissions' IS NOT NULL 
                    THEN (perm_record->'function_permissions')::text[]
                    ELSE '{}'::text[]
                END,
                CASE 
                    WHEN perm_record->'project_permissions' IS NOT NULL 
                    THEN (perm_record->'project_permissions')::text[]
                    ELSE '{}'::text[]
                END,
                CASE 
                    WHEN perm_record->'data_permissions' IS NOT NULL 
                    THEN (perm_record->'data_permissions')::text[]
                    ELSE '{}'::text[]
                END,
                auth.uid()
            )
            ON CONFLICT (user_id, project_id) 
            DO UPDATE SET
                menu_permissions = EXCLUDED.menu_permissions,
                function_permissions = EXCLUDED.function_permissions,
                project_permissions = EXCLUDED.project_permissions,
                data_permissions = EXCLUDED.data_permissions,
                updated_at = NOW();
            
            -- 检查是否是新插入还是更新
            IF FOUND THEN
                IF (perm_record->>'user_id')::uuid IN (SELECT user_id FROM user_permissions WHERE user_id = (perm_record->>'user_id')::uuid) THEN
                    updated_count := updated_count + 1;
                ELSE
                    inserted_count := inserted_count + 1;
                END IF;
            END IF;
            
        EXCEPTION WHEN OTHERS THEN
            error_count := error_count + 1;
            RAISE WARNING 'Error processing permission record: %', SQLERRM;
        END;
    END LOOP;
    
    RETURN QUERY SELECT updated_count, inserted_count, error_count;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.bulk_calculate_partner_costs
CREATE OR REPLACE FUNCTION public.bulk_calculate_partner_costs(p_record_ids uuid[])
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    -- 删除现有的合作方成本记录
    DELETE FROM public.logistics_partner_costs
    WHERE logistics_record_id = ANY(p_record_ids);

    INSERT INTO public.logistics_partner_costs
        (logistics_record_id, partner_id, level, base_amount, payable_amount, tax_rate, user_id)
    SELECT
        records_and_chains.record_id,
        partner_record.partner_id,
        partner_record.level,
        records_and_chains.base_payable_amount,
        CASE
            WHEN partner_record.calculation_method = 'profit' THEN
                records_and_chains.base_payable_amount +
                (COALESCE(partner_record.profit_rate, 0) * records_and_chains.effective_quantity)
            ELSE
                CASE
                    WHEN partner_record.tax_rate IS NOT NULL AND partner_record.tax_rate <> 1 THEN
                        records_and_chains.base_payable_amount / (1 - partner_record.tax_rate)
                    ELSE
                        records_and_chains.base_payable_amount
                END
        END AS payable_amount,
        partner_record.tax_rate,
        auth.uid()
    FROM (
        SELECT
            lr.id as record_id,
            lr.project_id,
            COALESCE(lr.chain_id, pc_default.id) as final_chain_id,
            (COALESCE(lr.current_cost, 0) + COALESCE(lr.extra_cost, 0)) as base_payable_amount,
            -- 使用项目配置的有效数量类型计算有效数量
            public.calculate_effective_quantity(
                lr.loading_weight, 
                lr.unloading_weight, 
                COALESCE(p.effective_quantity_type, 'min_value')
            ) as effective_quantity
        FROM public.logistics_records lr
        LEFT JOIN public.partner_chains pc_default
            ON lr.project_id = pc_default.project_id AND pc_default.is_default = true
        LEFT JOIN public.projects p
            ON lr.project_id = p.id
        WHERE lr.id = ANY(p_record_ids)
    ) AS records_and_chains
    JOIN public.project_partners partner_record
        ON records_and_chains.project_id = partner_record.project_id
        AND records_and_chains.final_chain_id = partner_record.chain_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.calculate_effective_quantity
CREATE OR REPLACE FUNCTION public.calculate_effective_quantity(p_loading_quantity numeric, p_unloading_quantity numeric, p_effective_quantity_type effective_quantity_type)
 RETURNS numeric
 LANGUAGE plpgsql
 IMMUTABLE
AS $function$
BEGIN
  CASE p_effective_quantity_type
    WHEN 'min_value' THEN
      -- 取装货数量和卸货数量的较小值
      RETURN COALESCE(
        NULLIF(LEAST(
          COALESCE(p_loading_quantity, 999999), 
          COALESCE(p_unloading_quantity, 999999)
        ), 999999),
        COALESCE(p_loading_quantity, p_unloading_quantity, 0)
      );
    WHEN 'loading' THEN
      -- 取装货数量
      RETURN COALESCE(p_loading_quantity, 0);
    WHEN 'unloading' THEN
      -- 取卸货数量
      RETURN COALESCE(p_unloading_quantity, 0);
    ELSE
      -- 默认取较小值
      RETURN COALESCE(
        NULLIF(LEAST(
          COALESCE(p_loading_quantity, 999999), 
          COALESCE(p_unloading_quantity, 999999)
        ), 999999),
        COALESCE(p_loading_quantity, p_unloading_quantity, 0)
      );
  END CASE;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.calculate_partner_costs
CREATE OR REPLACE FUNCTION public.calculate_partner_costs(p_base_amount numeric, p_project_id uuid)
 RETURNS TABLE(partner_id uuid, partner_name text, level integer, base_amount numeric, payable_amount numeric, tax_rate numeric)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  partner_record RECORD;
BEGIN
  -- 按级别顺序获取项目的合作方，使用项目特定的税率
  FOR partner_record IN 
    SELECT 
      pp.partner_id,
      p.name as partner_name,
      pp.level,
      pp.tax_rate  -- 使用项目特定的税率，而不是合作方默认税率
    FROM public.project_partners pp
    JOIN public.partners p ON pp.partner_id = p.id
    WHERE pp.project_id = p_project_id
    ORDER BY pp.level ASC
  LOOP
    -- 每个合作方的应付款都基于原始运费金额计算：运费金额 / (1 - 税点)
    partner_id := partner_record.partner_id;
    partner_name := partner_record.partner_name;
    level := partner_record.level;
    base_amount := p_base_amount;  -- 基础金额始终是原始运费金额
    tax_rate := partner_record.tax_rate;  -- 使用项目特定税率
    payable_amount := p_base_amount / (1 - partner_record.tax_rate);  -- 基于项目特定税率计算
    
    RETURN NEXT;
  END LOOP;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.calculate_partner_costs_for_project_v2
CREATE OR REPLACE FUNCTION public.calculate_partner_costs_for_project_v2(p_base_amount numeric, p_project_id uuid, p_loading_weight numeric DEFAULT NULL::numeric, p_unloading_weight numeric DEFAULT NULL::numeric)
 RETURNS TABLE(partner_id uuid, partner_name text, level integer, base_amount numeric, payable_amount numeric, tax_rate numeric, calculation_method text, profit_rate numeric)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  partner_record RECORD;
  effective_weight numeric;
BEGIN
  -- 计算有效重量：取不为空且不为0的最小值
  effective_weight := COALESCE(
    NULLIF(LEAST(
      COALESCE(p_loading_weight, 999999), 
      COALESCE(p_unloading_weight, 999999)
    ), 999999),
    COALESCE(p_loading_weight, p_unloading_weight, 0)
  );

  -- 按级别顺序获取项目的合作方，包含计算方法信息
  FOR partner_record IN 
    SELECT 
      pp.partner_id,
      p.name as partner_name,
      pp.level,
      pp.tax_rate,
      pp.calculation_method,
      COALESCE(pp.profit_rate, 0) as profit_rate
    FROM public.project_partners pp
    JOIN public.partners p ON pp.partner_id = p.id
    WHERE pp.project_id = p_project_id
    ORDER BY pp.level ASC
  LOOP
    partner_id := partner_record.partner_id;
    partner_name := partner_record.partner_name;
    level := partner_record.level;
    base_amount := p_base_amount;
    tax_rate := partner_record.tax_rate;
    calculation_method := partner_record.calculation_method;
    profit_rate := partner_record.profit_rate;
    
    -- 根据计算方法计算应付金额
    IF partner_record.calculation_method = 'profit' THEN
      -- 利润计算方法：重量 * (司机运费/重量 + 设置的利润)
      IF effective_weight > 0 THEN
        payable_amount := effective_weight * ((p_base_amount / effective_weight) + partner_record.profit_rate);
      ELSE
        payable_amount := p_base_amount + partner_record.profit_rate;
      END IF;
    ELSE
      -- 税点计算方法：运费金额 / (1 - 税点)
      payable_amount := p_base_amount / (1 - partner_record.tax_rate);
    END IF;
    
    RETURN NEXT;
  END LOOP;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.calculate_partner_costs_v2
CREATE OR REPLACE FUNCTION public.calculate_partner_costs_v2(p_base_amount numeric, p_project_id uuid, p_chain_id uuid, p_loading_weight numeric, p_unloading_weight numeric)
 RETURNS TABLE(partner_id uuid, partner_name text, level integer, base_amount numeric, payable_amount numeric, tax_rate numeric, calculation_method text, profit_rate numeric)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  partner_record RECORD;
  effective_weight numeric;
  chain_to_use uuid;
BEGIN
  IF p_chain_id IS NOT NULL THEN
    chain_to_use := p_chain_id;
  ELSE
    SELECT id INTO chain_to_use FROM public.partner_chains WHERE project_id = p_project_id AND is_default = true LIMIT 1;
  END IF;

  IF chain_to_use IS NULL THEN
    RETURN;
  END IF;

  effective_weight := COALESCE(NULLIF(LEAST(COALESCE(p_loading_weight, 999999), COALESCE(p_unloading_weight, 999999)), 999999), COALESCE(p_loading_weight, p_unloading_weight, 0));

  FOR partner_record IN
    SELECT pp.partner_id, p.name as partner_name, pp.level, pp.tax_rate, pp.calculation_method, COALESCE(pp.profit_rate, 0) as profit_rate
    FROM public.project_partners pp JOIN public.partners p ON pp.partner_id = p.id
    WHERE pp.project_id = p_project_id AND pp.chain_id = chain_to_use
    ORDER BY pp.level ASC
  LOOP
    partner_id := partner_record.partner_id;
    partner_name := partner_record.partner_name;
    level := partner_record.level;
    base_amount := p_base_amount;
    tax_rate := partner_record.tax_rate;
    calculation_method := partner_record.calculation_method;
    profit_rate := partner_record.profit_rate;

    IF partner_record.calculation_method = 'profit' THEN
      IF effective_weight > 0 THEN
        payable_amount := effective_weight * ((p_base_amount / effective_weight) + partner_record.profit_rate);
      ELSE
        payable_amount := p_base_amount + partner_record.profit_rate;
      END IF;
    ELSE
      payable_amount := p_base_amount / (1 - partner_record.tax_rate);
    END IF;

    RETURN NEXT;
  END LOOP;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.cancel_payment_requests_by_ids
CREATE OR REPLACE FUNCTION public.cancel_payment_requests_by_ids(p_request_ids text[])
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    target_record_ids uuid[];
    updated_row_count integer;
BEGIN
    -- 1. 【终极修复】使用子查询来安全地合并所有运单ID
    SELECT array_agg(DISTINCT record_id)
    INTO target_record_ids
    FROM (
        SELECT unnest(logistics_record_ids) AS record_id
        FROM public.payment_requests
        WHERE request_id = ANY(p_request_ids)
    ) AS subquery;

    IF target_record_ids IS NULL OR array_length(target_record_ids, 1) IS NULL THEN
        RETURN 0;
    END IF;

    -- 2. 将这些运单的状态回滚为 'Unpaid'
    --    只回滚状态为 'Pending' 或 'Approved' 的，防止已支付的被错误作废
    UPDATE public.logistics_records
    SET payment_status = 'Unpaid'
    WHERE id = ANY(target_record_ids) AND payment_status IN ('Processing', 'Approved');
    
    GET DIAGNOSTICS updated_row_count = ROW_COUNT;

    -- 3. 删除【多个】付款申请单本身
    DELETE FROM public.payment_requests
    WHERE request_id = ANY(p_request_ids);

    RETURN updated_row_count;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.check_enum_value
CREATE OR REPLACE FUNCTION public.check_enum_value(enum_name text, enum_value text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    result boolean;
BEGIN
    SELECT EXISTS(
        SELECT 1 FROM pg_enum 
        JOIN pg_type ON pg_enum.enumtypid = pg_type.oid 
        WHERE pg_type.typname = enum_name 
        AND enumlabel = enum_value
    ) INTO result;
    
    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.check_existing_waybills
CREATE OR REPLACE FUNCTION public.check_existing_waybills(p_fingerprints waybill_fingerprint[])
 RETURNS SETOF waybill_fingerprint
 LANGUAGE sql
 STABLE
 SET search_path TO 'public'
AS $function$
    -- [您的原始逻辑 - 开始]
    -- 我已将您的逻辑原封不动地放在这里
    SELECT
        fp.project_name_check,
        fp.driver_name_check,
        fp.loading_location_check,
        fp.unloading_location_check,
        fp.loading_date_check,
        fp.loading_weight_check
    FROM 
        unnest(p_fingerprints) AS fp
    WHERE 
        EXISTS (
            SELECT 1
            FROM public.logistics_records lr
            WHERE
                lr.project_name = fp.project_name_check AND
                lr.driver_name = fp.driver_name_check AND
                lr.loading_location = fp.loading_location_check AND
                lr.unloading_location = fp.unloading_location_check AND
                lr.loading_date::date = fp.loading_date_check AND -- 假设传入的已经是date类型
                lr.loading_weight = fp.loading_weight_check
        );
    -- [您的原始逻辑 - 结束]
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.check_expiring_contracts
CREATE OR REPLACE FUNCTION public.check_expiring_contracts()
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_contract record;
  v_user_record record;
  v_days_until_expiry integer;
BEGIN
  -- 查找30天内到期的合同
  FOR v_contract IN 
    SELECT id, contract_number, end_date, responsible_person
    FROM public.contracts
    WHERE status = 'active'
    AND end_date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '30 days'
  LOOP
    v_days_until_expiry := (v_contract.end_date - CURRENT_DATE);
    
    -- 通知负责人和管理员
    FOR v_user_record IN 
      SELECT id FROM public.profiles 
      WHERE (role = 'admin' OR full_name = v_contract.responsible_person)
      AND is_active = true
    LOOP
      -- 检查是否已经发送过通知（避免重复）
      IF NOT EXISTS (
        SELECT 1 FROM public.notifications
        WHERE user_id = v_user_record.id
        AND related_id = v_contract.id
        AND created_at > CURRENT_DATE - INTERVAL '7 days'
      ) THEN
        PERFORM public.create_contract_expiry_notification(
          v_user_record.id,
          v_contract.id,
          v_contract.contract_number,
          v_days_until_expiry
        );
      END IF;
    END LOOP;
  END LOOP;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.check_logistics_record_deletion
CREATE OR REPLACE FUNCTION public.check_logistics_record_deletion()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_invoice_count integer := 0;
    v_payment_count integer := 0;
    v_invoice_request_count integer := 0;
    v_payment_request_count integer := 0;
BEGIN
    -- 检查是否有开票申请明细
    SELECT COUNT(*) INTO v_invoice_count
    FROM public.invoice_request_details
    WHERE logistics_record_id = OLD.id;
    
    -- 检查是否有付款申请明细
    SELECT COUNT(*) INTO v_payment_count
    FROM public.payment_request_items
    WHERE logistics_record_id = OLD.id;
    
    -- 检查是否有开票申请单
    SELECT COUNT(*) INTO v_invoice_request_count
    FROM public.invoice_requests ir
    JOIN public.invoice_request_details ird ON ir.id = ird.invoice_request_id
    WHERE ird.logistics_record_id = OLD.id;
    
    -- 检查是否有付款申请单
    SELECT COUNT(*) INTO v_payment_request_count
    FROM public.payment_requests pr
    JOIN public.payment_request_items pri ON pr.id = pri.payment_request_id
    WHERE pri.logistics_record_id = OLD.id;
    
    -- 如果有相关的财务申请，阻止删除并抛出错误
    IF v_invoice_count > 0 OR v_payment_count > 0 THEN
        RAISE EXCEPTION 
            '无法删除运单 "%": 该运单已关联 % 个开票申请明细和 % 个付款申请明细。请先处理相关财务申请。',
            OLD.auto_number, v_invoice_count, v_payment_count;
    END IF;
    
    -- 记录删除操作到日志表（可选）
    INSERT INTO public.operation_logs (
        operation_type,
        table_name,
        record_id,
        record_info,
        operated_by,
        operated_at
    ) VALUES (
        'DELETE',
        'logistics_records',
        OLD.id,
        json_build_object(
            'auto_number', OLD.auto_number,
            'project_name', OLD.project_name,
            'driver_name', OLD.driver_name,
            'loading_location', OLD.loading_location,
            'unloading_location', OLD.unloading_location
        ),
        auth.uid(),
        NOW()
    );
    
    RETURN OLD;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.check_logistics_record_duplicate
CREATE OR REPLACE FUNCTION public.check_logistics_record_duplicate(p_driver_name text, p_license_plate text, p_driver_phone text, p_loading_location text, p_unloading_location text, p_loading_date date, p_loading_weight numeric, p_exclude_id uuid DEFAULT NULL::uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.logistics_records
    WHERE driver_name = p_driver_name
    AND license_plate = p_license_plate
    AND driver_phone = p_driver_phone
    AND loading_location = p_loading_location
    AND unloading_location = p_unloading_location
    AND loading_date::date = p_loading_date
    AND loading_weight = p_loading_weight
    AND (p_exclude_id IS NULL OR id != p_exclude_id)
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.check_logistics_record_duplicate
CREATE OR REPLACE FUNCTION public.check_logistics_record_duplicate(p_project_name text, p_chain_name text, p_driver_name text, p_license_plate text, p_loading_location text, p_unloading_location text, p_loading_date text, p_loading_weight numeric)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    is_duplicate boolean;
BEGIN
    SELECT EXISTS (
        SELECT 1 FROM public.logistics_records lr
        LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
        WHERE lr.project_name = p_project_name
        AND COALESCE(pc.chain_name, '') = COALESCE(p_chain_name, '')
        AND lr.driver_name = p_driver_name
        AND COALESCE(lr.license_plate, '') = COALESCE(p_license_plate, '')
        AND public.compare_location_arrays(lr.loading_location, p_loading_location)
        AND public.compare_location_arrays(lr.unloading_location, p_unloading_location)
        AND lr.loading_date::date = p_loading_date::date
        AND COALESCE(lr.loading_weight, 0) = COALESCE(p_loading_weight, 0)
    ) INTO is_duplicate;
    
    RETURN is_duplicate;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.check_logistics_record_duplicate
CREATE OR REPLACE FUNCTION public.check_logistics_record_duplicate(p_project_name text, p_chain_id uuid, p_driver_name text, p_license_plate text, p_loading_location text, p_unloading_location text, p_loading_date date, p_loading_weight numeric, p_exclude_id uuid DEFAULT NULL::uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.logistics_records
    WHERE project_name = p_project_name                    -- 1. 项目名称
    AND chain_id = p_chain_id                             -- 2. 合作链路ID
    AND driver_name = p_driver_name                       -- 3. 司机姓名
    AND license_plate = p_license_plate                   -- 4. 车牌号
    AND loading_location = p_loading_location             -- 5. 装货地点
    AND unloading_location = p_unloading_location         -- 6. 卸货地点
    AND loading_date::date = p_loading_date               -- 7. 装货日期
    AND loading_weight = p_loading_weight                 -- 8. 装货数量
    AND (p_exclude_id IS NULL OR id != p_exclude_id)
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.check_logistics_record_duplicate_v2
CREATE OR REPLACE FUNCTION public.check_logistics_record_duplicate_v2(p_project_name text, p_chain_name text, p_driver_name text, p_license_plate text, p_loading_location text, p_unloading_location text, p_loading_date text, p_loading_weight numeric)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    is_duplicate boolean;
BEGIN
    SELECT EXISTS (
        SELECT 1 FROM public.logistics_records lr
        LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
        WHERE lr.project_name = p_project_name
        AND COALESCE(pc.chain_name, '') = COALESCE(p_chain_name, '')
        AND lr.driver_name = p_driver_name
        AND COALESCE(lr.license_plate, '') = COALESCE(p_license_plate, '')
        AND public.compare_location_arrays_v2(lr.loading_location, p_loading_location)
        AND public.compare_location_arrays_v2(lr.unloading_location, p_unloading_location)
        AND lr.loading_date::date = p_loading_date::date
        AND COALESCE(lr.loading_weight, 0) = COALESCE(p_loading_weight, 0)
    ) INTO is_duplicate;
    
    RETURN is_duplicate;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.check_logistics_record_duplicate_v2
CREATE OR REPLACE FUNCTION public.check_logistics_record_duplicate_v2(p_project_name text, p_chain_id uuid, p_driver_name text, p_license_plate text, p_loading_location text, p_unloading_location text, p_loading_date date, p_loading_weight numeric, p_exclude_id uuid DEFAULT NULL::uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.logistics_records
    WHERE TRIM(project_name) = TRIM(p_project_name)                    -- 1. 项目名称
    AND chain_id = p_chain_id                                         -- 2. 合作链路ID
    AND TRIM(driver_name) = TRIM(p_driver_name)                       -- 3. 司机姓名
    AND TRIM(license_plate) = TRIM(p_license_plate)                   -- 4. 车牌号
    AND compare_location_arrays_v2(loading_location, p_loading_location)  -- 5. 装货地点（多地点比较）
    AND compare_location_arrays_v2(unloading_location, p_unloading_location) -- 6. 卸货地点（多地点比较）
    AND loading_date::date = p_loading_date                           -- 7. 装货日期
    AND loading_weight = p_loading_weight                             -- 8. 装货数量
    AND (p_exclude_id IS NULL OR id != p_exclude_id)
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.check_permission_inheritance
CREATE OR REPLACE FUNCTION public.check_permission_inheritance()
 RETURNS TABLE(user_id uuid, user_email text, user_role text, permission_type text, permission_source text, menu_count integer, function_count integer, project_count integer, data_count integer)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        p.id,
        p.email,
        p.role::text as user_role,
        CASE 
            WHEN up.user_id IS NULL THEN 'role_template'
            WHEN up.inherit_role = true THEN 'inherited'
            ELSE 'custom'
        END as permission_type,
        CASE 
            WHEN up.user_id IS NULL THEN rpt.name
            ELSE '用户特定权限'
        END as permission_source,
        COALESCE(array_length(COALESCE(up.menu_permissions, rpt.menu_permissions), 1), 0) as menu_count,
        COALESCE(array_length(COALESCE(up.function_permissions, rpt.function_permissions), 1), 0) as function_count,
        COALESCE(array_length(COALESCE(up.project_permissions, rpt.project_permissions), 1), 0) as project_count,
        COALESCE(array_length(COALESCE(up.data_permissions, rpt.data_permissions), 1), 0) as data_count
    FROM public.profiles p
    LEFT JOIN public.user_permissions up ON p.id = up.user_id AND up.project_id IS NULL
    LEFT JOIN public.role_permission_templates rpt ON rpt.role::text = p.role::text
    ORDER BY p.role::text, p.email;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.clean_platform_names
CREATE OR REPLACE FUNCTION public.clean_platform_names()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- 清理空字符串和null值
  IF NEW.other_platform_names IS NOT NULL THEN
    NEW.other_platform_names := ARRAY(
      SELECT DISTINCT trim(name) 
      FROM unnest(NEW.other_platform_names) AS name 
      WHERE trim(name) != ''
    );
    
    -- 如果清理后为空数组，设置为NULL
    IF array_length(NEW.other_platform_names, 1) IS NULL THEN
      NEW.other_platform_names := NULL;
    END IF;
  END IF;
  
  RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.cleanup_logistics_related_data
CREATE OR REPLACE FUNCTION public.cleanup_logistics_related_data()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    -- 删除相关的合作方成本记录（这些应该通过外键CASCADE自动删除，但为了确保）
    DELETE FROM public.logistics_partner_costs 
    WHERE logistics_record_id = OLD.id;
    
    -- 更新相关的开票申请单状态（如果有孤立记录）
    UPDATE public.invoice_requests 
    SET status = 'Cancelled',
        remarks = COALESCE(remarks, '') || ' [运单已删除]'
    WHERE id IN (
        SELECT DISTINCT ir.id 
        FROM public.invoice_requests ir
        JOIN public.invoice_request_details ird ON ir.id = ird.invoice_request_id
        WHERE ird.logistics_record_id = OLD.id
    );
    
    -- 更新相关的付款申请单状态（如果有孤立记录）
    UPDATE public.payment_requests 
    SET status = 'Cancelled',
        remarks = COALESCE(remarks, '') || ' [运单已删除]'
    WHERE id IN (
        SELECT DISTINCT pr.id 
        FROM public.payment_requests pr
        JOIN public.payment_request_items pri ON pr.id = pri.payment_request_id
        WHERE pri.logistics_record_id = OLD.id
    );
    
    RETURN OLD;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.cleanup_permissions
CREATE OR REPLACE FUNCTION public.cleanup_permissions()
 RETURNS TABLE(cleaned_count integer, orphaned_count integer)
 LANGUAGE plpgsql
AS $function$
DECLARE
    cleaned_count integer := 0;
    orphaned_count integer := 0;
BEGIN
    -- 清理无效的用户权限（用户不存在）
    WITH deleted_perms AS (
        DELETE FROM user_permissions 
        WHERE user_id NOT IN (SELECT id FROM profiles)
        RETURNING id
    )
    SELECT COUNT(*) INTO orphaned_count FROM deleted_perms;
    
    -- 清理重复的权限记录（保留最新的）
    WITH ranked_perms AS (
        SELECT id,
               ROW_NUMBER() OVER (
                   PARTITION BY user_id, project_id 
                   ORDER BY created_at DESC
               ) as rn
        FROM user_permissions
    ),
    deleted_duplicates AS (
        DELETE FROM user_permissions 
        WHERE id IN (
            SELECT id FROM ranked_perms WHERE rn > 1
        )
        RETURNING id
    )
    SELECT COUNT(*) INTO cleaned_count FROM deleted_duplicates;
    
    RETURN QUERY SELECT cleaned_count, orphaned_count;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.compare_location_arrays
CREATE OR REPLACE FUNCTION public.compare_location_arrays(locations1 text, locations2 text)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
DECLARE
    arr1 text[];
    arr2 text[];
    loc1 text;
    loc2 text;
    found boolean;
BEGIN
    -- 处理空值
    IF locations1 IS NULL OR locations1 = '' THEN
        locations1 := '';
    END IF;
    IF locations2 IS NULL OR locations2 = '' THEN
        locations2 := '';
    END IF;
    
    -- 如果两个都是空，认为相等
    IF locations1 = '' AND locations2 = '' THEN
        RETURN true;
    END IF;
    
    -- 分割字符串为数组
    arr1 := string_to_array(locations1, '|');
    arr2 := string_to_array(locations2, '|');
    
    -- 去除空白字符
    FOR i IN 1..array_length(arr1, 1) LOOP
        arr1[i] := trim(arr1[i]);
    END LOOP;
    FOR i IN 1..array_length(arr2, 1) LOOP
        arr2[i] := trim(arr2[i]);
    END LOOP;
    
    -- 过滤空字符串
    arr1 := array_remove(arr1, '');
    arr2 := array_remove(arr2, '');
    
    -- 如果数组长度不同，直接返回false
    IF array_length(arr1, 1) != array_length(arr2, 1) THEN
        RETURN false;
    END IF;
    
    -- 检查arr1中的每个元素是否都在arr2中
    FOREACH loc1 IN ARRAY arr1 LOOP
        found := false;
        FOREACH loc2 IN ARRAY arr2 LOOP
            IF loc1 = loc2 THEN
                found := true;
                EXIT;
            END IF;
        END LOOP;
        IF NOT found THEN
            RETURN false;
        END IF;
    END LOOP;
    
    RETURN true;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.compare_location_arrays_v2
CREATE OR REPLACE FUNCTION public.compare_location_arrays_v2(locations1 text, locations2 text)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
DECLARE
    arr1 text[];
    arr2 text[];
    loc1 text;
    loc2 text;
    found boolean;
BEGIN
    -- 处理空值
    IF locations1 IS NULL OR locations1 = '' THEN
        locations1 := '';
    END IF;
    IF locations2 IS NULL OR locations2 = '' THEN
        locations2 := '';
    END IF;
    
    -- 如果两个都是空，认为相等
    IF locations1 = '' AND locations2 = '' THEN
        RETURN true;
    END IF;
    
    -- 分割字符串为数组
    arr1 := string_to_array(locations1, '|');
    arr2 := string_to_array(locations2, '|');
    
    -- 去除空白字符
    FOR i IN 1..array_length(arr1, 1) LOOP
        arr1[i] := trim(arr1[i]);
    END LOOP;
    FOR i IN 1..array_length(arr2, 1) LOOP
        arr2[i] := trim(arr2[i]);
    END LOOP;
    
    -- 过滤空字符串
    arr1 := array_remove(arr1, '');
    arr2 := array_remove(arr2, '');
    
    -- 如果数组长度不同，直接返回false
    IF array_length(arr1, 1) != array_length(arr2, 1) THEN
        RETURN false;
    END IF;
    
    -- 检查arr1中的每个元素是否都在arr2中
    FOREACH loc1 IN ARRAY arr1 LOOP
        found := false;
        FOREACH loc2 IN ARRAY arr2 LOOP
            IF loc1 = loc2 THEN
                found := true;
                EXIT;
            END IF;
        END LOOP;
        IF NOT found THEN
            RETURN false;
        END IF;
    END LOOP;
    
    RETURN true;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.complete_invoice_request
CREATE OR REPLACE FUNCTION public.complete_invoice_request(p_request_id uuid, p_invoice_number text, p_invoice_date date)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_request invoice_requests%ROWTYPE;
    v_detail RECORD;
    result_json json;
    created_records_count integer := 0;
BEGIN
    SELECT * INTO v_request FROM invoice_requests WHERE id = p_request_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION '开票申请不存在';
    END IF;

    IF v_request.status != 'Approved' THEN
        RAISE EXCEPTION '只能完成已批准的开票申请';
    END IF;

    -- 为每个运单创建开票记录
    FOR v_detail IN 
        SELECT ird.logistics_record_id, ird.amount, lpc.partner_id
        FROM invoice_request_details ird
        JOIN logistics_partner_costs lpc ON ird.logistics_record_id = lpc.logistics_record_id 
            AND lpc.invoice_request_id = p_request_id
        WHERE ird.invoice_request_id = p_request_id
    LOOP
        -- 在现有的invoice_records表中创建记录
        INSERT INTO invoice_records (
            logistics_record_id,
            partner_id,
            invoice_amount,
            invoice_number,
            invoice_date,
            remarks,
            user_id
        ) VALUES (
            v_detail.logistics_record_id,
            v_detail.partner_id,
            v_detail.amount,
            p_invoice_number,
            p_invoice_date,
            '来自开票申请: ' || v_request.request_number,
            auth.uid()
        );
        
        created_records_count := created_records_count + 1;
    END LOOP;

    -- 更新申请状态
    UPDATE invoice_requests 
    SET 
        status = 'Invoiced',
        invoice_number = p_invoice_number,
        invoice_date = p_invoice_date
    WHERE id = p_request_id;

    -- 更新合作方成本记录状态
    UPDATE logistics_partner_costs 
    SET 
        invoice_status = 'Invoiced',
        invoice_number = p_invoice_number,
        invoice_completed_at = NOW()
    WHERE invoice_request_id = p_request_id;

    result_json := json_build_object(
        'success', true,
        'message', '开票完成，已创建 ' || created_records_count || ' 条开票记录',
        'request_id', p_request_id,
        'invoice_number', p_invoice_number,
        'invoice_date', p_invoice_date,
        'created_records_count', created_records_count
    );

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.create_contract_expiry_notification
CREATE OR REPLACE FUNCTION public.create_contract_expiry_notification(p_user_id uuid, p_contract_id uuid, p_contract_number text, p_days_until_expiry integer)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  INSERT INTO public.notifications (
    user_id,
    type,
    category,
    title,
    message,
    link,
    related_id
  ) VALUES (
    p_user_id,
    'warning',
    'contract',
    '合同即将到期',
    format('合同"%s"将于%s天后到期，请及时处理', p_contract_number, p_days_until_expiry::text),
    '/m/contracts',
    p_contract_id
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.create_contract_permission
CREATE OR REPLACE FUNCTION public.create_contract_permission(p_contract_id uuid, p_permission_type text, p_user_id uuid DEFAULT NULL::uuid, p_role_id uuid DEFAULT NULL::uuid, p_department_id uuid DEFAULT NULL::uuid, p_expires_at timestamp with time zone DEFAULT NULL::timestamp with time zone, p_description text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
AS $function$
DECLARE
    permission_id UUID;
BEGIN
    -- 验证权限类型
    IF p_permission_type NOT IN ('view', 'download', 'edit', 'delete', 'manage', 'sensitive', 'approve', 'archive', 'audit') THEN
        RAISE EXCEPTION '无效的权限类型: %', p_permission_type;
    END IF;
    
    -- 确保至少指定一个目标（用户、角色或部门）
    IF p_user_id IS NULL AND p_role_id IS NULL AND p_department_id IS NULL THEN
        RAISE EXCEPTION '必须指定用户、角色或部门中的至少一个';
    END IF;
    
    -- 创建权限记录
    INSERT INTO public.contract_permissions (
        contract_id,
        user_id,
        role_id,
        department_id,
        permission_type,
        expires_at,
        description,
        granted_by,
        granted_at,
        is_active
    ) VALUES (
        p_contract_id,
        p_user_id,
        p_role_id,
        p_department_id,
        p_permission_type,
        p_expires_at,
        p_description,
        auth.uid(),
        NOW(),
        true
    ) RETURNING id INTO permission_id;
    
    RETURN permission_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.create_payment_request_notification
CREATE OR REPLACE FUNCTION public.create_payment_request_notification(p_user_id uuid, p_request_id uuid, p_amount numeric, p_project_name text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  INSERT INTO public.notifications (
    user_id,
    type,
    category,
    title,
    message,
    link,
    related_id
  ) VALUES (
    p_user_id,
    'warning',
    'finance',
    '新的付款申请',
    format('项目"%s"有新的付款申请，金额¥%s', p_project_name, p_amount::text),
    '/m/payment-requests-management',
    p_request_id
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.create_project_completion_notification
CREATE OR REPLACE FUNCTION public.create_project_completion_notification(p_user_id uuid, p_project_id uuid, p_project_name text, p_total_tonnage numeric)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  INSERT INTO public.notifications (
    user_id,
    type,
    category,
    title,
    message,
    link,
    related_id
  ) VALUES (
    p_user_id,
    'success',
    'business',
    '项目已完成',
    format('项目"%s"已顺利完成，总运量达到%s吨', p_project_name, p_total_tonnage::text),
    format('/m/projects/detail/%s', p_project_id::text),
    p_project_id
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.create_role_complete
CREATE OR REPLACE FUNCTION public.create_role_complete(role_key text, role_label text, role_color text DEFAULT 'bg-gray-500'::text, role_description text DEFAULT ''::text, menu_permissions text[] DEFAULT '{}'::text[], function_permissions text[] DEFAULT '{}'::text[], project_permissions text[] DEFAULT '{}'::text[], data_permissions text[] DEFAULT '{}'::text[])
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    admin_user_id uuid;
BEGIN
    -- 1. 检查角色是否已存在
    IF check_enum_value('app_role', role_key) THEN
        RAISE EXCEPTION '角色 % 已存在', role_key;
    END IF;
    
    -- 2. 添加角色到枚举类型
    PERFORM add_enum_value('app_role', role_key);
    
    -- 3. 创建权限模板
    INSERT INTO public.role_permission_templates (
        role,
        menu_permissions,
        function_permissions,
        project_permissions,
        data_permissions,
        created_at,
        updated_at
    ) VALUES (
        role_key,
        menu_permissions,
        function_permissions,
        project_permissions,
        data_permissions,
        NOW(),
        NOW()
    );
    
    -- 4. 获取管理员用户ID
    SELECT id INTO admin_user_id
    FROM public.profiles
    WHERE role = 'admin'
    LIMIT 1;
    
    -- 5. 为新角色创建默认项目分配
    IF admin_user_id IS NOT NULL THEN
        INSERT INTO public.user_projects (
            user_id,
            project_id,
            role,
            can_view,
            can_edit,
            can_delete,
            created_by
        )
        SELECT 
            admin_user_id,
            p.id,
            role_key::app_role,
            true,  -- 默认可以查看
            CASE 
                WHEN role_key = 'admin' THEN true
                ELSE false
            END,  -- 根据角色设置编辑权限
            CASE 
                WHEN role_key = 'admin' THEN true
                ELSE false
            END,  -- 根据角色设置删除权限
            admin_user_id
        FROM public.projects p
        WHERE NOT EXISTS (
            SELECT 1 FROM public.user_projects up 
            WHERE up.user_id = admin_user_id 
            AND up.project_id = p.id 
            AND up.role = role_key::app_role
        );
    END IF;
    
    RAISE NOTICE '角色 % 创建成功', role_key;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.create_single_logistics_record
CREATE OR REPLACE FUNCTION public.create_single_logistics_record(p_record jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    -- [修改] 直接从 p_record 中获取 ID
    v_project_id uuid := (p_record->>'project_id')::uuid;
    v_driver_id uuid := (p_record->>'driver_id')::uuid;
    v_loading_location_id uuid := (p_record->>'loading_location_id')::uuid;
    v_unloading_location_id uuid := (p_record->>'unloading_location_id')::uuid;
    v_chain_id uuid := (p_record->>'chain_id')::uuid;
    
    -- [修改] 通过 ID 反查名称用于冗余存储
    v_project_name text;
    v_driver_name text;
    v_loading_location_name text;
    v_unloading_location_name text;

    loading_date_formatted timestamp;
    unloading_date_formatted timestamp;
    new_record_id uuid;
    v_auto_number text;
    driver_payable numeric;
    v_billing_type_id bigint;
    v_counter integer;
    new_logistics_record jsonb;
BEGIN
    -- [修改] 通过 ID 查询名称和其他信息
    SELECT name INTO v_project_name FROM public.projects WHERE id = v_project_id;
    IF v_project_name IS NULL THEN RAISE EXCEPTION '项目ID无效: %', v_project_id; END IF;

    SELECT name INTO v_driver_name FROM public.drivers WHERE id = v_driver_id;
    IF v_driver_name IS NULL THEN RAISE EXCEPTION '司机ID无效: %', v_driver_id; END IF;

    SELECT name INTO v_loading_location_name FROM public.locations WHERE id = v_loading_location_id;
    IF v_loading_location_name IS NULL THEN RAISE EXCEPTION '装货地点ID无效: %', v_loading_location_id; END IF;

    SELECT name INTO v_unloading_location_name FROM public.locations WHERE id = v_unloading_location_id;
    IF v_unloading_location_name IS NULL THEN RAISE EXCEPTION '卸货地点ID无效: %', v_unloading_location_id; END IF;

    -- 确定计费方式
    SELECT billing_type_id INTO v_billing_type_id FROM public.partner_chains WHERE id = v_chain_id;
    v_billing_type_id := COALESCE(v_billing_type_id, 1); -- 默认为1

    -- 准备日期和费用
    loading_date_formatted := (p_record->>'loading_date')::timestamp;
    unloading_date_formatted := COALESCE(NULLIF(p_record->>'unloading_date', ''), p_record->>'loading_date')::timestamp;
    driver_payable := COALESCE((p_record->>'current_cost')::numeric, 0) + COALESCE((p_record->>'extra_cost')::numeric, 0);

    -- 生成运单号
    SELECT COALESCE(MAX(substring(auto_number from 13)::integer), 0) + 1 INTO v_counter FROM public.logistics_records WHERE loading_date::date = loading_date_formatted::date AND auto_number LIKE 'YDN%';
    v_auto_number := 'YDN' || to_char(loading_date_formatted, 'YYYYMMDD') || '-' || lpad(v_counter::text, 3, '0');

    -- 插入记录
    INSERT INTO public.logistics_records (
        auto_number, project_id, project_name, chain_id, billing_type_id, driver_id, driver_name, loading_location, unloading_location,
        loading_date, unloading_date, loading_weight, unloading_weight, current_cost, extra_cost, license_plate, driver_phone,
        transport_type, remarks, payable_cost, created_by_user_id, user_id
    ) VALUES (
        v_auto_number, v_project_id, v_project_name, v_chain_id, v_billing_type_id, v_driver_id, v_driver_name, v_loading_location_name, v_unloading_location_name,
        loading_date_formatted, unloading_date_formatted, NULLIF((p_record->>'loading_weight')::text, '')::numeric, NULLIF((p_record->>'unloading_weight')::text, '')::numeric,
        COALESCE((p_record->>'current_cost')::numeric, 0), COALESCE((p_record->>'extra_cost')::numeric, 0), (p_record->>'license_plate'), (p_record->>'driver_phone'),
        COALESCE((p_record->>'transport_type'), '实际运输'), (p_record->>'remarks'), driver_payable, auth.uid(), auth.uid()
    ) RETURNING id, to_jsonb(logistics_records) INTO new_record_id, new_logistics_record;

    PERFORM public.recalculate_and_update_costs_for_records(ARRAY[new_record_id]);
    RETURN new_logistics_record;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.create_waybill_with_check
CREATE OR REPLACE FUNCTION public.create_waybill_with_check(p_project_name text, p_driver_name text, p_cooperative_partner text, p_license_plate text, p_loading_location text, p_unloading_location text, p_loading_date date, p_loading_weight numeric, p_unloading_weight numeric, p_freight_cost numeric, p_force_create boolean DEFAULT false)
 RETURNS json
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    v_duplicate_count INT;
    v_new_record_id uuid;
    v_created_record JSON;
BEGIN
    IF NOT p_force_create THEN
        SELECT count(*)
        INTO v_duplicate_count
        FROM public.logistics_records
        WHERE 
            project_name = p_project_name AND
            driver_name = p_driver_name AND
            loading_location = p_loading_location AND
            unloading_location = p_unloading_location AND
            loading_date = p_loading_date AND
            loading_weight = p_loading_weight;

        IF v_duplicate_count > 0 THEN
            RETURN json_build_object(
                'status', 'conflict',
                'message', 'A record with the same key fields already exists.'
            );
        END IF;
    END IF;

    -- 【加固点】
    INSERT INTO public.logistics_records (
        user_id, -- <<-- 已加固
        project_name, driver_name, license_plate,
        loading_location, unloading_location, loading_date, loading_weight,
        unloading_weight, current_cost
    ) VALUES (
        auth.uid(), -- <<-- 已加固
        p_project_name, p_driver_name, p_license_plate,
        p_loading_location, p_unloading_location, p_loading_date, p_loading_weight,
        p_unloading_weight, p_freight_cost
    ) RETURNING id INTO v_new_record_id;

    SELECT row_to_json(lr)
    INTO v_created_record
    FROM public.logistics_records lr
    WHERE id = v_new_record_id;

    RETURN json_build_object(
        'status', 'success',
        'data', v_created_record
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.delete_invoice_request
CREATE OR REPLACE FUNCTION public.delete_invoice_request(p_request_id uuid)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_request invoice_requests%ROWTYPE;
    result_json json;
BEGIN
    SELECT * INTO v_request FROM invoice_requests WHERE id = p_request_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION '开票申请不存在';
    END IF;

    IF v_request.status != 'Pending' THEN
        RAISE EXCEPTION '只能删除待审批状态的申请';
    END IF;

    -- 恢复合作方成本记录状态
    UPDATE logistics_partner_costs 
    SET 
        invoice_status = 'Uninvoiced',
        invoice_request_id = NULL,
        invoice_applied_at = NULL
    WHERE invoice_request_id = p_request_id;

    -- 删除申请（级联删除明细）
    DELETE FROM invoice_requests WHERE id = p_request_id;

    result_json := json_build_object(
        'success', true,
        'message', '开票申请已删除，相关合作方成本记录状态已恢复',
        'request_id', p_request_id
    );

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.delete_notification
CREATE OR REPLACE FUNCTION public.delete_notification(p_notification_id uuid, p_user_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  DELETE FROM public.notifications
  WHERE id = p_notification_id AND user_id = p_user_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.delete_records_by_project_name
CREATE OR REPLACE FUNCTION public.delete_records_by_project_name(p_project_name text)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_project_id uuid;
    v_record_ids uuid[];
    v_deleted_costs_count integer;
    v_deleted_records_count integer;
BEGIN
    -- 步骤 1: 【核心修复】使用一个更“智能”的方式，来查找项目ID
    -- `lower(trim(...))` 会先移除项目名称前后的所有空格，然后将所有字母都转换为小写，
    -- 从而彻底解决了因大小写或空格问题而导致的“找不到项目”的BUG。
    SELECT id INTO v_project_id 
    FROM public.projects 
    WHERE lower(trim(name)) = lower(trim(p_project_name));

    -- 步骤 2: 安全检查
    IF NOT FOUND THEN
        RETURN FORMAT('未找到名为 "%s" 的项目，操作已取消。请检查项目名称是否正确。', p_project_name);
    END IF;

    -- 步骤 3: 找到该项目下所有运单记录的ID
    SELECT ARRAY_AGG(id) INTO v_record_ids 
    FROM public.logistics_records 
    WHERE project_id = v_project_id;

    IF v_record_ids IS NULL OR array_length(v_record_ids, 1) IS NULL THEN
        RETURN FORMAT('项目 "%s" 下没有需要删除的运单记录。', p_project_name);
    END IF;

    -- 步骤 4: 按照正确的顺序，开始删除
    DELETE FROM public.logistics_partner_costs WHERE logistics_record_id = ANY(v_record_ids);
    GET DIAGNOSTICS v_deleted_costs_count = ROW_COUNT;

    DELETE FROM public.logistics_records WHERE id = ANY(v_record_ids);
    GET DIAGNOSTICS v_deleted_records_count = ROW_COUNT;

    -- 步骤 5: 返回一份清晰的操作报告
    RETURN FORMAT('操作成功！已为项目 "%s" 删除 %s 条运单记录，以及 %s 条相关的财务对账数据。', 
                  p_project_name, 
                  v_deleted_records_count, 
                  v_deleted_costs_count);

END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.delete_role_complete
CREATE OR REPLACE FUNCTION public.delete_role_complete(role_key text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    user_count integer;
BEGIN
    -- 1. 检查是否有用户使用该角色
    SELECT COUNT(*) INTO user_count
    FROM public.profiles
    WHERE role = role_key;
    
    IF user_count > 0 THEN
        RAISE WARNING '有 % 个用户正在使用角色 %，将自动改为操作员角色', user_count, role_key;
        
        -- 更新用户角色为操作员
        UPDATE public.profiles
        SET role = 'operator'
        WHERE role = role_key;
    END IF;
    
    -- 2. 删除权限模板
    DELETE FROM public.role_permission_templates
    WHERE role = role_key;
    
    -- 3. 删除项目分配
    DELETE FROM public.user_projects
    WHERE role = role_key::app_role;
    
    -- 注意：无法从枚举类型中删除值，这是 PostgreSQL 的限制
    RAISE WARNING '角色 % 已从系统中删除，但枚举类型中的值需要手动清理', role_key;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.delete_waybills_by_project
CREATE OR REPLACE FUNCTION public.delete_waybills_by_project(p_project_name text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    -- 用于存储操作过程中的中间数据和计数
    v_project_id UUID;
    v_deleted_logistics_ids UUID[];
    v_deleted_logistics_count INT;
    v_deleted_costs_count INT;
    v_result JSONB;
BEGIN
    -- 首先，根据项目名称找到项目ID
    SELECT id INTO v_project_id FROM public.projects WHERE name = p_project_name;

    -- 如果找不到项目ID，则返回错误
    IF v_project_id IS NULL THEN
        RETURN jsonb_build_object(
            'success', false,
            'error', '找不到名为 "' || p_project_name || '" 的项目',
            'deleted_logistics_count', 0,
            'deleted_costs_count', 0
        );
    END IF;

    -- 第1步：找出所有属于该项目的运单记录ID
    SELECT array_agg(id)
    INTO v_deleted_logistics_ids
    FROM public.logistics_records
    WHERE project_id = v_project_id;

    -- 如果没有找到任何运单记录，则返回提示
    IF v_deleted_logistics_ids IS NULL OR array_length(v_deleted_logistics_ids, 1) = 0 THEN
        RETURN jsonb_build_object(
            'success', true,
            'message', '项目 "' || p_project_name || '" 下没有找到任何运单记录，无需删除',
            'deleted_logistics_count', 0,
            'deleted_costs_count', 0
        );
    END IF;

    -- 第2步：使用捕获到的ID，删除所有相关的【物流合作方成本】记录
    WITH deleted_rows AS (
        DELETE FROM public.logistics_partner_costs
        WHERE logistics_record_id = ANY(v_deleted_logistics_ids)
        RETURNING 1
    )
    SELECT count(*) INTO v_deleted_costs_count FROM deleted_rows;

    -- 第3步：使用相同的ID数组，删除所有【运单记录】本身
    WITH deleted_rows AS (
        DELETE FROM public.logistics_records
        WHERE id = ANY(v_deleted_logistics_ids)
        RETURNING 1
    )
    SELECT count(*) INTO v_deleted_logistics_count FROM deleted_rows;

    -- 第4步：返回执行结果
    RETURN jsonb_build_object(
        'success', true,
        'message', '删除操作成功完成',
        'project_name', p_project_name,
        'deleted_logistics_count', v_deleted_logistics_count,
        'deleted_costs_count', v_deleted_costs_count
    );

EXCEPTION WHEN OTHERS THEN
    -- 如果发生任何错误，返回错误信息
    RETURN jsonb_build_object(
        'success', false,
        'error', '删除操作失败: ' || SQLERRM,
        'deleted_logistics_count', 0,
        'deleted_costs_count', 0
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.execute_import_v2
CREATE OR REPLACE FUNCTION public.execute_import_v2(p_records_to_insert jsonb, p_records_to_update jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    insert_count integer := 0;
    update_count integer := 0;
    rec_to_insert jsonb;
    rec_to_update jsonb;
    v_id integer;
BEGIN
    -- 1. 处理待插入的记录
    IF jsonb_array_length(p_records_to_insert) > 0 THEN
        -- 使用 jsonb_populate_recordset 可以更高效地批量插入
        -- 注意：这要求JSON对象的键与表的列名完全匹配
        INSERT INTO logistics_records (
            project_name, chain_name, driver_name, license_plate, driver_phone,
            loading_location, unloading_location, loading_date, unloading_date,
            loading_weight, unloading_weight, current_cost, extra_cost,
            transport_type, remarks
        )
        SELECT
            p->>'project_name',
            p->>'chain_name',
            p->>'driver_name',
            p->>'license_plate',
            p->>'driver_phone',
            p->>'loading_location',
            p->>'unloading_location',
            (p->>'loading_date')::date,
            (p->>'unloading_date')::date,
            (p->>'loading_weight')::numeric,
            (p->>'unloading_weight')::numeric,
            (p->>'current_cost')::numeric,
            (p->>'extra_cost')::numeric,
            p->>'transport_type',
            p->>'remarks'
        FROM jsonb_array_elements(p_records_to_insert) AS p;
        
        GET DIAGNOSTICS insert_count = ROW_COUNT;
    END IF;

    -- 2. 处理待更新的记录
    IF jsonb_array_length(p_records_to_update) > 0 THEN
        FOR rec_to_update IN SELECT * FROM jsonb_array_elements(p_records_to_update)
        LOOP
            v_id := (rec_to_update->>'id')::integer;
            
            UPDATE logistics_records
            SET
                project_name = rec_to_update->>'project_name',
                chain_name = rec_to_update->>'chain_name',
                driver_name = rec_to_update->>'driver_name',
                license_plate = rec_to_update->>'license_plate',
                driver_phone = rec_to_update->>'driver_phone',
                loading_location = rec_to_update->>'loading_location',
                unloading_location = rec_to_update->>'unloading_location',
                loading_date = (rec_to_update->>'loading_date')::date,
                unloading_date = (rec_to_update->>'unloading_date')::date,
                loading_weight = (rec_to_update->>'loading_weight')::numeric,
                unloading_weight = (rec_to_update->>'unloading_weight')::numeric,
                current_cost = (rec_to_update->>'current_cost')::numeric,
                extra_cost = (rec_to_update->>'extra_cost')::numeric,
                transport_type = rec_to_update->>'transport_type',
                remarks = rec_to_update->>'remarks'
            WHERE id = v_id;
            
            update_count := update_count + 1;
        END LOOP;
    END IF;

    RETURN jsonb_build_object(
        'success', true,
        'inserted_count', insert_count,
        'updated_count', update_count
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- 函数: public.fetch_comprehensive_project_report
CREATE OR REPLACE FUNCTION public.fetch_comprehensive_project_report(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_start_date date := p_report_date - interval '6 days';
    v_end_date date := p_report_date;
BEGIN
    RETURN (
        WITH project_base AS (
            -- 1. 获取所有项目详情，用于下拉列表
            SELECT json_agg(p.*) as details
            FROM projects p
        ),
        trips_in_project AS (
            -- 2. 筛选出当前项目的所有运单记录，作为后续计算的基础
            SELECT *
            FROM trips
            WHERE project_id = p_selected_project_id
        ),
        summary_stats AS (
            -- 3. 计算整个项目的汇总统计
            SELECT
                COUNT(*) AS total_trips,
                COALESCE(SUM(net_weight), 0) AS total_tonnage,
                COALESCE(SUM(driver_receivable), 0) AS total_cost,
                -- 安全地计算平均成本，避免除以零
                CASE
                    WHEN COALESCE(SUM(net_weight), 0) > 0 THEN COALESCE(SUM(driver_receivable), 0) / COALESCE(SUM(net_weight), 0)
                    ELSE 0
                END AS avg_cost
            FROM trips_in_project
        ),
        daily_report AS (
            -- 4. 计算指定报告日的日报数据
            SELECT
                COUNT(*) AS trip_count,
                COALESCE(SUM(net_weight), 0) AS total_tonnage,
                COALESCE(SUM(driver_receivable), 0) AS driver_receivable,
                COALESCE(SUM(partner_payable), 0) AS partner_payable
            FROM trips_in_project
            WHERE unloading_time::date = p_report_date
        ),
        date_series AS (
            -- 5. 生成最近7天的日期序列，用于图表
            SELECT generate_series(v_start_date, v_end_date, '1 day'::interval)::date as date
        ),
        seven_day_trend AS (
            -- 6. 计算7日趋势图数据
            SELECT
                to_char(ds.date, 'YYYY-MM-DD') AS date,
                COUNT(t.id) AS trips,
                COALESCE(SUM(t.net_weight), 0) AS weight,
                COALESCE(SUM(t.driver_receivable), 0) AS receivable
            FROM date_series ds
            LEFT JOIN trips_in_project t ON ds.date = t.unloading_time::date
            GROUP BY ds.date
            ORDER BY ds.date
        ),
        driver_daily_stats AS (
            -- 7. 计算每个司机在报告日的统计
            SELECT
                driver_id,
                COUNT(*) as trip_count,
                COALESCE(SUM(net_weight), 0) as total_tonnage,
                COALESCE(SUM(driver_receivable), 0) as total_driver_receivable,
                COALESCE(SUM(partner_payable), 0) as total_partner_payable
            FROM trips_in_project
            WHERE unloading_time::date = p_report_date
            GROUP BY driver_id
        ),
        driver_project_stats AS (
            -- 8. 计算每个司机在整个项目中的总统计
            SELECT
                driver_id,
                COUNT(*) as total_trips_in_project,
                COALESCE(SUM(driver_receivable), 0) as total_receivable_in_project
            FROM trips_in_project
            GROUP BY driver_id
        ),
        driver_report_table AS (
            -- 9. 组合司机日报和总报，并加入司机信息
            SELECT
                d.name AS driver_name,
                d.phone,
                d.license_plate,
                dds.trip_count,
                dds.total_tonnage,
                dds.total_driver_receivable,
                dds.total_partner_payable,
                dps.total_trips_in_project,
                dps.total_receivable_in_project
            FROM driver_daily_stats dds
            JOIN drivers d ON dds.driver_id = d.id
            LEFT JOIN driver_project_stats dps ON dds.driver_id = dps.driver_id
        ),
        daily_logistics_records AS (
            -- 10. 获取报告日当天的详细运单记录，用于弹窗
            SELECT
                t.id::text,
                d.name as driver_name,
                d.license_plate,
                t.net_weight,
                t.unloading_time::text as timestamp
            FROM trips_in_project t
            JOIN drivers d ON t.driver_id = d.id
            WHERE t.unloading_time::date = p_report_date
        )
        -- 11. 将所有计算结果组合成一个JSON对象
        SELECT json_build_object(
            'project_details', (SELECT details FROM project_base),
            'summary_stats', (SELECT row_to_json(ss) FROM summary_stats ss),
            'daily_report', (SELECT row_to_json(dr) FROM daily_report dr),
            'seven_day_trend', (SELECT json_agg(sdt) FROM seven_day_trend sdt),
            'driver_report_table', (SELECT json_agg(drt) FROM driver_report_table drt),
            'daily_logistics_records', (SELECT json_agg(dlr) FROM daily_logistics_records dlr)
        )
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.fetch_comprehensive_project_report_final_v2
CREATE OR REPLACE FUNCTION public.fetch_comprehensive_project_report_final_v2(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_start_date date := p_report_date - interval '6 days';
    v_end_date date := p_report_date;
    result_json json; -- ★★★ 核心结构修正: 声明一个变量来存储结果 ★★★
BEGIN
    -- ★★★ 核心结构修正: 使用 WITH ... SELECT ... INTO ... 的稳健结构 ★★★
    WITH project_base AS (
        SELECT DISTINCT ON (p.id)
            p.*,
            pa.name as partner_name
        FROM projects p
        LEFT JOIN project_partners pp ON p.id = pp.project_id
        LEFT JOIN partners pa ON pp.partner_id = pa.id
    ),
    logistics_in_project AS (
        SELECT *
        FROM logistics_records
        WHERE project_id = p_selected_project_id
    ),
    summary_stats AS (
        SELECT
            COUNT(*) AS total_trips,
            COALESCE(SUM(unloading_weight), 0) AS total_tonnage,
            COALESCE(SUM(payable_cost), 0) AS total_cost,
            CASE
                WHEN COALESCE(SUM(unloading_weight), 0) > 0 THEN COALESCE(SUM(payable_cost), 0) / NULLIF(SUM(unloading_weight), 0)
                ELSE 0
            END AS avg_cost
        FROM logistics_in_project
    ),
    daily_report AS (
        SELECT
            COUNT(*) AS trip_count,
            COALESCE(SUM(lr.unloading_weight), 0) AS total_tonnage,
            COALESCE(SUM(lr.payable_cost), 0) AS driver_receivable,
            (SELECT COALESCE(SUM(lpc.payable_amount), 0) 
             FROM logistics_partner_costs lpc 
             JOIN logistics_in_project lip ON lpc.logistics_record_id = lip.id
             WHERE lip.unloading_date::date = p_report_date) AS partner_payable
        FROM logistics_in_project lr
        WHERE lr.unloading_date::date = p_report_date
    ),
    date_series AS (
        SELECT generate_series(v_start_date, v_end_date, '1 day'::interval)::date as date
    ),
    seven_day_trend AS (
        SELECT
            to_char(ds.date, 'YYYY-MM-DD') AS date,
            COUNT(lr.id) AS trips,
            COALESCE(SUM(lr.unloading_weight), 0) AS weight,
            COALESCE(SUM(lr.payable_cost), 0) AS receivable
        FROM date_series ds
        LEFT JOIN logistics_in_project lr ON ds.date = lr.unloading_date::date
        GROUP BY ds.date
        ORDER BY ds.date
    ),
    driver_daily_stats AS (
        SELECT
            driver_name, driver_phone, license_plate,
            COUNT(*) as trip_count,
            COALESCE(SUM(unloading_weight), 0) as total_tonnage,
            COALESCE(SUM(payable_cost), 0) as total_driver_receivable
        FROM logistics_in_project
        WHERE unloading_date::date = p_report_date
        GROUP BY driver_name, driver_phone, license_plate
    ),
    driver_project_stats AS (
        SELECT
            driver_name, driver_phone, license_plate,
            COUNT(*) as total_trips_in_project,
            COALESCE(SUM(payable_cost), 0) as total_receivable_in_project
        FROM logistics_in_project
        GROUP BY driver_name, driver_phone, license_plate
    ),
    driver_report_table AS (
        SELECT
            dds.driver_name,
            dds.driver_phone AS phone,
            dds.license_plate,
            dds.trip_count,
            dds.total_tonnage,
            dds.total_driver_receivable,
            0 as total_partner_payable,
            dps.total_trips_in_project,
            dps.total_receivable_in_project
        FROM driver_daily_stats dds
        LEFT JOIN driver_project_stats dps ON dds.driver_name = dps.driver_name AND dds.driver_phone = dps.driver_phone AND dds.license_plate = dps.license_plate
    ),
    daily_logistics_records AS (
        SELECT
            id::text,
            driver_name,
            license_plate,
            unloading_weight as net_weight,
            unloading_date::text as timestamp
        FROM logistics_in_project
        WHERE unloading_date::date = p_report_date
    )
    SELECT json_build_object(
        'project_details', (SELECT json_agg(pb) FROM project_base pb),
        'summary_stats', (SELECT row_to_json(ss) FROM summary_stats ss),
        'daily_report', (SELECT row_to_json(dr) FROM daily_report dr),
        'seven_day_trend', (SELECT json_agg(sdt) FROM seven_day_trend sdt),
        'driver_report_table', (SELECT COALESCE(json_agg(drt), '[]'::json) FROM driver_report_table drt),
        'daily_logistics_records', (SELECT COALESCE(json_agg(dlr), '[]'::json) FROM daily_logistics_records dlr)
    )
    INTO result_json;

    RETURN result_json; -- ★★★ 核心结构修正: 返回存储结果的变量 ★★★
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.fetch_comprehensive_project_report_final_v3
CREATE OR REPLACE FUNCTION public.fetch_comprehensive_project_report_final_v3(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_start_date date := p_report_date - interval '6 days';
    v_end_date date := p_report_date;
    result_json json;
BEGIN
    WITH 
    -- ★★★ 核心终极修复: 不再查询所有项目，只精确查找当前选择的项目 ★★★
    project_base AS (
        SELECT 
            p.*,
            pa.name as partner_name
        FROM projects p
        LEFT JOIN project_partners pp ON p.id = pp.project_id
        LEFT JOIN partners pa ON pp.partner_id = pa.id
        WHERE p.id = p_selected_project_id
        LIMIT 1
    ),
    logistics_in_project AS (
        SELECT *
        FROM logistics_records
        WHERE project_id = p_selected_project_id
    ),
    summary_stats AS (
        SELECT
            COUNT(*) AS total_trips,
            COALESCE(SUM(unloading_weight), 0) AS total_tonnage,
            COALESCE(SUM(payable_cost), 0) AS total_cost,
            CASE
                WHEN COALESCE(SUM(unloading_weight), 0) > 0 THEN COALESCE(SUM(payable_cost), 0) / NULLIF(SUM(unloading_weight), 0)
                ELSE 0
            END AS avg_cost
        FROM logistics_in_project
    ),
    daily_report AS (
        SELECT
            COUNT(*) AS trip_count,
            COALESCE(SUM(lr.unloading_weight), 0) AS total_tonnage,
            COALESCE(SUM(lr.payable_cost), 0) AS driver_receivable,
            (SELECT COALESCE(SUM(lpc.payable_amount), 0) 
             FROM logistics_partner_costs lpc 
             JOIN logistics_in_project lip ON lpc.logistics_record_id = lip.id
             WHERE lip.unloading_date::date = p_report_date) AS partner_payable
        FROM logistics_in_project lr
        WHERE lr.unloading_date::date = p_report_date
    ),
    date_series AS (
        SELECT generate_series(v_start_date, v_end_date, '1 day'::interval)::date as date
    ),
    seven_day_trend AS (
        SELECT
            to_char(ds.date, 'YYYY-MM-DD') AS date,
            COUNT(lr.id) AS trips,
            COALESCE(SUM(lr.unloading_weight), 0) AS weight,
            COALESCE(SUM(lr.payable_cost), 0) AS receivable
        FROM date_series ds
        LEFT JOIN logistics_in_project lr ON ds.date = lr.unloading_date::date
        GROUP BY ds.date
        ORDER BY ds.date
    ),
    driver_daily_stats AS (
        SELECT
            driver_name, driver_phone, license_plate,
            COUNT(*) as trip_count,
            COALESCE(SUM(unloading_weight), 0) as total_tonnage,
            COALESCE(SUM(payable_cost), 0) as total_driver_receivable
        FROM logistics_in_project
        WHERE unloading_date::date = p_report_date
        GROUP BY driver_name, driver_phone, license_plate
    ),
    driver_project_stats AS (
        SELECT
            driver_name, driver_phone, license_plate,
            COUNT(*) as total_trips_in_project,
            COALESCE(SUM(payable_cost), 0) as total_receivable_in_project
        FROM logistics_in_project
        GROUP BY driver_name, driver_phone, license_plate
    ),
    driver_report_table AS (
        SELECT
            dds.driver_name,
            dds.driver_phone AS phone,
            dds.license_plate,
            dds.trip_count,
            dds.total_tonnage,
            dds.total_driver_receivable,
            0 as total_partner_payable,
            dps.total_trips_in_project,
            dps.total_receivable_in_project
        FROM driver_daily_stats dds
        LEFT JOIN driver_project_stats dps ON dds.driver_name = dps.driver_name AND dds.driver_phone = dps.driver_phone AND dds.license_plate = dps.license_plate
    ),
    daily_logistics_records AS (
        SELECT
            id::text,
            driver_name,
            license_plate,
            unloading_weight as net_weight,
            unloading_date::text as timestamp
        FROM logistics_in_project
        WHERE unloading_date::date = p_report_date
    )
    SELECT json_build_object(
        -- ★★★ 核心终极修复: 返回单个项目对象，而不是数组 ★★★
        'project_details', (SELECT row_to_json(pb) FROM project_base pb),
        'summary_stats', (SELECT row_to_json(ss) FROM summary_stats ss),
        'daily_report', (SELECT row_to_json(dr) FROM daily_report dr),
        'seven_day_trend', (SELECT json_agg(sdt) FROM seven_day_trend sdt),
        'driver_report_table', (SELECT COALESCE(json_agg(drt), '[]'::json) FROM driver_report_table drt),
        'daily_logistics_records', (SELECT COALESCE(json_agg(dlr), '[]'::json) FROM daily_logistics_records dlr)
    )
    INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.fetch_comprehensive_project_report_final_v4
CREATE OR REPLACE FUNCTION public.fetch_comprehensive_project_report_final_v4(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_start_date date := p_report_date - interval '6 days';
    v_end_date date := p_report_date;
    result_json json;
BEGIN
    WITH 
    project_base AS (
        SELECT 
            -- ★★★ 核心终极修复: 放弃 p.*, 明确指定需要的每一个字段 ★★★
            p.id,
            p.name,
            p.start_date,
            p.planned_total_tons,
            p.billing_type_id,
            pa.name as partner_name
        FROM projects p
        LEFT JOIN project_partners pp ON p.id = pp.project_id
        LEFT JOIN partners pa ON pp.partner_id = pa.id
        WHERE p.id = p_selected_project_id
        LIMIT 1
    ),
    logistics_in_project AS (
        SELECT *
        FROM logistics_records
        WHERE project_id = p_selected_project_id
    ),
    summary_stats AS (
        SELECT
            COUNT(*) AS total_trips,
            COALESCE(SUM(unloading_weight), 0) AS total_tonnage,
            COALESCE(SUM(payable_cost), 0) AS total_cost,
            CASE
                WHEN COALESCE(SUM(unloading_weight), 0) > 0 THEN COALESCE(SUM(payable_cost), 0) / NULLIF(SUM(unloading_weight), 0)
                ELSE 0
            END AS avg_cost
        FROM logistics_in_project
    ),
    daily_report AS (
        SELECT
            COUNT(*) AS trip_count,
            COALESCE(SUM(lr.unloading_weight), 0) AS total_tonnage,
            COALESCE(SUM(lr.payable_cost), 0) AS driver_receivable,
            (SELECT COALESCE(SUM(lpc.payable_amount), 0) 
             FROM logistics_partner_costs lpc 
             JOIN logistics_in_project lip ON lpc.logistics_record_id = lip.id
             WHERE lip.unloading_date::date = p_report_date) AS partner_payable
        FROM logistics_in_project lr
        WHERE lr.unloading_date::date = p_report_date
    ),
    date_series AS (
        SELECT generate_series(v_start_date, v_end_date, '1 day'::interval)::date as date
    ),
    seven_day_trend AS (
        SELECT
            to_char(ds.date, 'YYYY-MM-DD') AS date,
            COUNT(lr.id) AS trips,
            COALESCE(SUM(lr.unloading_weight), 0) AS weight,
            COALESCE(SUM(lr.payable_cost), 0) AS receivable
        FROM date_series ds
        LEFT JOIN logistics_in_project lr ON ds.date = lr.unloading_date::date
        GROUP BY ds.date
        ORDER BY ds.date
    ),
    driver_daily_stats AS (
        SELECT
            driver_name, driver_phone, license_plate,
            COUNT(*) as trip_count,
            COALESCE(SUM(unloading_weight), 0) as total_tonnage,
            COALESCE(SUM(payable_cost), 0) as total_driver_receivable
        FROM logistics_in_project
        WHERE unloading_date::date = p_report_date
        GROUP BY driver_name, driver_phone, license_plate
    ),
    driver_project_stats AS (
        SELECT
            driver_name, driver_phone, license_plate,
            COUNT(*) as total_trips_in_project,
            COALESCE(SUM(payable_cost), 0) as total_receivable_in_project
        FROM logistics_in_project
        GROUP BY driver_name, driver_phone, license_plate
    ),
    driver_report_table AS (
        SELECT
            dds.driver_name,
            dds.driver_phone AS phone,
            dds.license_plate,
            dds.trip_count,
            dds.total_tonnage,
            dds.total_driver_receivable,
            0 as total_partner_payable,
            dps.total_trips_in_project,
            dps.total_receivable_in_project
        FROM driver_daily_stats dds
        LEFT JOIN driver_project_stats dps ON dds.driver_name = dps.driver_name AND dds.driver_phone = dps.driver_phone AND dds.license_plate = dps.license_plate
    ),
    daily_logistics_records AS (
        SELECT
            id::text,
            driver_name,
            license_plate,
            unloading_weight as net_weight,
            unloading_date::text as timestamp
        FROM logistics_in_project
        WHERE unloading_date::date = p_report_date
    )
    SELECT json_build_object(
        'project_details', (SELECT row_to_json(pb) FROM project_base pb),
        'summary_stats', (SELECT row_to_json(ss) FROM summary_stats ss),
        'daily_report', (SELECT row_to_json(dr) FROM daily_report dr),
        'seven_day_trend', (SELECT json_agg(sdt) FROM seven_day_trend sdt),
        'driver_report_table', (SELECT COALESCE(json_agg(drt), '[]'::json) FROM driver_report_table drt),
        'daily_logistics_records', (SELECT COALESCE(json_agg(dlr), '[]'::json) FROM daily_logistics_records dlr)
    )
    INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.fetch_comprehensive_project_report_final_v5
CREATE OR REPLACE FUNCTION public.fetch_comprehensive_project_report_final_v5(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_start_date date := p_report_date - interval '6 days';
    v_end_date date := p_report_date;
    result_json json;
BEGIN
    WITH 
    project_base AS (
        SELECT 
            p.id,
            p.name,
            p.start_date,
            p.planned_total_tons,
            -- ★★★ 核心终极修复: 从 logistics_records 动态查询最新的 billing_type_id ★★★
            -- 如果项目没有任何运单，则默认计费类型为 1 (吨)
            COALESCE(
                (SELECT lr.billing_type_id 
                 FROM logistics_records lr 
                 WHERE lr.project_id = p.id 
                 ORDER BY lr.unloading_date DESC, lr.created_at DESC 
                 LIMIT 1), 
                1
            ) AS billing_type_id,
            pa.name as partner_name
        FROM projects p
        LEFT JOIN project_partners pp ON p.id = pp.project_id
        LEFT JOIN partners pa ON pp.partner_id = pa.id
        WHERE p.id = p_selected_project_id
        LIMIT 1
    ),
    logistics_in_project AS (
        SELECT *
        FROM logistics_records
        WHERE project_id = p_selected_project_id
    ),
    summary_stats AS (
        SELECT
            COUNT(*) AS total_trips,
            COALESCE(SUM(unloading_weight), 0) AS total_tonnage,
            COALESCE(SUM(payable_cost), 0) AS total_cost,
            CASE
                WHEN COALESCE(SUM(unloading_weight), 0) > 0 THEN COALESCE(SUM(payable_cost), 0) / NULLIF(SUM(unloading_weight), 0)
                ELSE 0
            END AS avg_cost
        FROM logistics_in_project
    ),
    daily_report AS (
        SELECT
            COUNT(*) AS trip_count,
            COALESCE(SUM(lr.unloading_weight), 0) AS total_tonnage,
            COALESCE(SUM(lr.payable_cost), 0) AS driver_receivable,
            (SELECT COALESCE(SUM(lpc.payable_amount), 0) 
             FROM logistics_partner_costs lpc 
             JOIN logistics_in_project lip ON lpc.logistics_record_id = lip.id
             WHERE lip.unloading_date::date = p_report_date) AS partner_payable
        FROM logistics_in_project lr
        WHERE lr.unloading_date::date = p_report_date
    ),
    date_series AS (
        SELECT generate_series(v_start_date, v_end_date, '1 day'::interval)::date as date
    ),
    seven_day_trend AS (
        SELECT
            to_char(ds.date, 'YYYY-MM-DD') AS date,
            COUNT(lr.id) AS trips,
            COALESCE(SUM(lr.unloading_weight), 0) AS weight,
            COALESCE(SUM(lr.payable_cost), 0) AS receivable
        FROM date_series ds
        LEFT JOIN logistics_in_project lr ON ds.date = lr.unloading_date::date
        GROUP BY ds.date
        ORDER BY ds.date
    ),
    driver_daily_stats AS (
        SELECT
            driver_name, driver_phone, license_plate,
            COUNT(*) as trip_count,
            COALESCE(SUM(unloading_weight), 0) as total_tonnage,
            COALESCE(SUM(payable_cost), 0) as total_driver_receivable
        FROM logistics_in_project
        WHERE unloading_date::date = p_report_date
        GROUP BY driver_name, driver_phone, license_plate
    ),
    driver_project_stats AS (
        SELECT
            driver_name, driver_phone, license_plate,
            COUNT(*) as total_trips_in_project,
            COALESCE(SUM(payable_cost), 0) as total_receivable_in_project
        FROM logistics_in_project
        GROUP BY driver_name, driver_phone, license_plate
    ),
    driver_report_table AS (
        SELECT
            dds.driver_name,
            dds.driver_phone AS phone,
            dds.license_plate,
            dds.trip_count,
            dds.total_tonnage,
            dds.total_driver_receivable,
            0 as total_partner_payable,
            dps.total_trips_in_project,
            dps.total_receivable_in_project
        FROM driver_daily_stats dds
        LEFT JOIN driver_project_stats dps ON dds.driver_name = dps.driver_name AND dds.driver_phone = dps.driver_phone AND dds.license_plate = dps.license_plate
    ),
    daily_logistics_records AS (
        SELECT
            id::text,
            driver_name,
            license_plate,
            unloading_weight as net_weight,
            unloading_date::text as timestamp
        FROM logistics_in_project
        WHERE unloading_date::date = p_report_date
    )
    SELECT json_build_object(
        'project_details', (SELECT row_to_json(pb) FROM project_base pb),
        'summary_stats', (SELECT row_to_json(ss) FROM summary_stats ss),
        'daily_report', (SELECT row_to_json(dr) FROM daily_report dr),
        'seven_day_trend', (SELECT json_agg(sdt) FROM seven_day_trend sdt),
        'driver_report_table', (SELECT COALESCE(json_agg(drt), '[]'::json) FROM driver_report_table drt),
        'daily_logistics_records', (SELECT COALESCE(json_agg(dlr), '[]'::json) FROM daily_logistics_records dlr)
    )
    INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.fetch_comprehensive_project_report_v2
CREATE OR REPLACE FUNCTION public.fetch_comprehensive_project_report_v2(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_start_date date := p_report_date - interval '6 days';
    v_end_date date := p_report_date;
BEGIN
    RETURN (
        WITH project_base AS (
            -- 1. 获取所有项目详情，并连接 partners 表获取合作方名称
            SELECT
                p.*,
                pa.name as partner_name
            FROM projects p
            LEFT JOIN project_partners pp ON p.id = pp.project_id
            LEFT JOIN partners pa ON pp.partner_id = pa.id
        ),
        logistics_in_project AS (
            -- 2. 核心: 使用正确的表名 `logistics_records`
            SELECT *
            FROM logistics_records
            WHERE project_id = p_selected_project_id
        ),
        summary_stats AS (
            -- 3. 计算项目汇总统计
            SELECT
                COUNT(*) AS total_trips,
                COALESCE(SUM(unloading_weight), 0) AS total_tonnage, -- 使用 unloading_weight
                COALESCE(SUM(driver_payable_cost), 0) AS total_cost, -- 使用 driver_payable_cost
                CASE
                    WHEN COALESCE(SUM(unloading_weight), 0) > 0 THEN COALESCE(SUM(driver_payable_cost), 0) / COALESCE(SUM(unloading_weight), 0)
                    ELSE 0
                END AS avg_cost
            FROM logistics_in_project
        ),
        daily_report AS (
            -- 4. 计算日报数据
            SELECT
                COUNT(*) AS trip_count,
                COALESCE(SUM(lr.unloading_weight), 0) AS total_tonnage,
                COALESCE(SUM(lr.driver_payable_cost), 0) AS driver_receivable,
                -- 从 logistics_partner_costs 计算合作方应付
                (SELECT COALESCE(SUM(lpc.payable_amount), 0) 
                 FROM logistics_partner_costs lpc 
                 JOIN logistics_in_project lip ON lpc.logistics_record_id = lip.id
                 WHERE lip.unloading_date::date = p_report_date) AS partner_payable
            FROM logistics_in_project lr
            WHERE lr.unloading_date::date = p_report_date -- 使用 unloading_date
        ),
        date_series AS (
            -- 5. 生成7日日期序列
            SELECT generate_series(v_start_date, v_end_date, '1 day'::interval)::date as date
        ),
        seven_day_trend AS (
            -- 6. 计算7日趋势图数据
            SELECT
                to_char(ds.date, 'YYYY-MM-DD') AS date,
                COUNT(lr.id) AS trips,
                COALESCE(SUM(lr.unloading_weight), 0) AS weight,
                COALESCE(SUM(lr.driver_payable_cost), 0) AS receivable
            FROM date_series ds
            LEFT JOIN logistics_in_project lr ON ds.date = lr.unloading_date::date
            GROUP BY ds.date
            ORDER BY ds.date
        ),
        driver_daily_stats AS (
            -- 7. 计算司机日报 (因无独立司机表，按司机姓名/电话/车牌分组)
            SELECT
                driver_name, driver_phone, license_plate,
                COUNT(*) as trip_count,
                COALESCE(SUM(unloading_weight), 0) as total_tonnage,
                COALESCE(SUM(driver_payable_cost), 0) as total_driver_receivable
            FROM logistics_in_project
            WHERE unloading_date::date = p_report_date
            GROUP BY driver_name, driver_phone, license_plate
        ),
        driver_project_stats AS (
            -- 8. 计算司机在项目中的总统计
            SELECT
                driver_name,
                COUNT(*) as total_trips_in_project,
                COALESCE(SUM(driver_payable_cost), 0) as total_receivable_in_project
            FROM logistics_in_project
            GROUP BY driver_name
        ),
        driver_report_table AS (
            -- 9. 组合司机报告
            SELECT
                dds.driver_name,
                dds.driver_phone AS phone,
                dds.license_plate,
                dds.trip_count,
                dds.total_tonnage,
                dds.total_driver_receivable,
                -- 合作方应付逻辑较为复杂，此处暂留空或设为0，可根据业务需求调整
                0 as total_partner_payable,
                dps.total_trips_in_project,
                dps.total_receivable_in_project
            FROM driver_daily_stats dds
            LEFT JOIN driver_project_stats dps ON dds.driver_name = dps.driver_name
        ),
        daily_logistics_records AS (
            -- 10. 获取当日详细运单记录
            SELECT
                id::text,
                driver_name,
                license_plate,
                unloading_weight as net_weight, -- 别名匹配前端
                unloading_date::text as timestamp
            FROM logistics_in_project
            WHERE unloading_date::date = p_report_date
        )
        -- 11. 最终组合
        SELECT json_build_object(
            'project_details', (SELECT json_agg(pb) FROM project_base pb),
            'summary_stats', (SELECT row_to_json(ss) FROM summary_stats ss),
            'daily_report', (SELECT row_to_json(dr) FROM daily_report dr),
            'seven_day_trend', (SELECT json_agg(sdt) FROM seven_day_trend sdt),
            'driver_report_table', (SELECT COALESCE(json_agg(drt), '[]'::json) FROM driver_report_table drt),
            'daily_logistics_records', (SELECT COALESCE(json_agg(dlr), '[]'::json) FROM daily_logistics_records dlr)
        )
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- 函数: public.fetch_comprehensive_project_report_v3
CREATE OR REPLACE FUNCTION public.fetch_comprehensive_project_report_v3(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_start_date date := p_report_date - interval '6 days';
    v_end_date date := p_report_date;
BEGIN
    RETURN (
        WITH project_base AS (
            SELECT DISTINCT ON (p.id)
                p.*,
                pa.name as partner_name
            FROM projects p
            LEFT JOIN project_partners pp ON p.id = pp.project_id
            LEFT JOIN partners pa ON pp.partner_id = pa.id
        ),
        logistics_in_project AS (
            SELECT *
            FROM logistics_records
            WHERE project_id = p_selected_project_id
        ),
        summary_stats AS (
            SELECT
                COUNT(*) AS total_trips,
                COALESCE(SUM(unloading_weight), 0) AS total_tonnage,
                COALESCE(SUM(driver_payable_cost), 0) AS total_cost,
                CASE
                    WHEN COALESCE(SUM(unloading_weight), 0) > 0 THEN COALESCE(SUM(driver_payable_cost), 0) / COALESCE(SUM(unloading_weight), 0)
                    ELSE 0
                END AS avg_cost
            FROM logistics_in_project
        ),
        daily_report AS (
            SELECT
                COUNT(*) AS trip_count,
                COALESCE(SUM(lr.unloading_weight), 0) AS total_tonnage,
                COALESCE(SUM(lr.driver_payable_cost), 0) AS driver_receivable,
                (SELECT COALESCE(SUM(lpc.payable_amount), 0) 
                 FROM logistics_partner_costs lpc 
                 JOIN logistics_in_project lip ON lpc.logistics_record_id = lip.id
                 WHERE lip.unloading_date::date = p_report_date) AS partner_payable
            FROM logistics_in_project lr
            WHERE lr.unloading_date::date = p_report_date
        ),
        date_series AS (
            SELECT generate_series(v_start_date, v_end_date, '1 day'::interval)::date as date
        ),
        seven_day_trend AS (
            SELECT
                to_char(ds.date, 'YYYY-MM-DD') AS date,
                COUNT(lr.id) AS trips,
                COALESCE(SUM(lr.unloading_weight), 0) AS weight,
                COALESCE(SUM(lr.driver_payable_cost), 0) AS receivable
            FROM date_series ds
            LEFT JOIN logistics_in_project lr ON ds.date = lr.unloading_date::date
            GROUP BY ds.date
            ORDER BY ds.date
        ),
        driver_daily_stats AS (
            SELECT
                driver_name, driver_phone, license_plate,
                COUNT(*) as trip_count,
                COALESCE(SUM(unloading_weight), 0) as total_tonnage,
                COALESCE(SUM(driver_payable_cost), 0) as total_driver_receivable
            FROM logistics_in_project
            WHERE unloading_date::date = p_report_date
            GROUP BY driver_name, driver_phone, license_plate
        ),
        driver_project_stats AS (
            SELECT
                driver_name, driver_phone, license_plate,
                COUNT(*) as total_trips_in_project,
                COALESCE(SUM(driver_payable_cost), 0) as total_receivable_in_project
            FROM logistics_in_project
            GROUP BY driver_name, driver_phone, license_plate
        ),
        driver_report_table AS (
            SELECT
                dds.driver_name,
                dds.driver_phone AS phone,
                dds.license_plate,
                dds.trip_count,
                dds.total_tonnage,
                dds.total_driver_receivable,
                0 as total_partner_payable,
                dps.total_trips_in_project,
                dps.total_receivable_in_project
            FROM driver_daily_stats dds
            LEFT JOIN driver_project_stats dps ON dds.driver_name = dps.driver_name AND dds.driver_phone = dps.driver_phone AND dds.license_plate = dps.license_plate
        ),
        daily_logistics_records AS (
            SELECT
                id::text,
                driver_name,
                license_plate,
                unloading_weight as net_weight,
                unloading_date::text as timestamp
            FROM logistics_in_project
            WHERE unloading_date::date = p_report_date
        )
        -- The final JSON object construction
        SELECT json_build_object(
            'project_details', (SELECT json_agg(pb) FROM project_base pb),
            'summary_stats', (SELECT row_to_json(ss) FROM summary_stats ss),
            'daily_report', (SELECT row_to_json(dr) FROM daily_report dr),
            'seven_day_trend', (SELECT json_agg(sdt) FROM seven_day_trend sdt),
            -- ★★★ CORE FIX: Corrected 'driver_report table' to 'driver_report_table' ★★★
            'driver_report_table', (SELECT COALESCE(json_agg(drt), '[]'::json) FROM driver_report_table drt),
            'daily_logistics_records', (SELECT COALESCE(json_agg(dlr), '[]'::json) FROM daily_logistics_records dlr)
        )
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.find_driver_projects
CREATE OR REPLACE FUNCTION public.find_driver_projects(p_driver_ids uuid[])
 RETURNS TABLE(driver_id uuid, driver_name text, license_plate text, project_ids uuid[], project_names text[], record_count bigint)
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        d.id as driver_id,
        d.name as driver_name,
        d.license_plate,
        COALESCE(
            ARRAY_AGG(DISTINCT lr.project_id) FILTER (WHERE lr.project_id IS NOT NULL),
            '{}'::uuid[]
        ) as project_ids,
        COALESCE(
            ARRAY_AGG(DISTINCT lr.project_name) FILTER (WHERE lr.project_name IS NOT NULL),
            '{}'::text[]
        ) as project_names,
        COUNT(lr.id) as record_count
    FROM public.drivers d
    LEFT JOIN public.logistics_records lr ON (
        lr.driver_name = d.name 
        OR lr.license_plate = d.license_plate
        OR lr.driver_phone = d.phone
    )
    WHERE d.id = ANY(p_driver_ids)
    GROUP BY d.id, d.name, d.license_plate;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.generate_auto_number
CREATE OR REPLACE FUNCTION public.generate_auto_number(loading_date_input text)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    date_part TEXT;
    next_number INTEGER;
    padded_number TEXT;
    final_number TEXT;
    max_attempts INTEGER := 1000;
    attempt_count INTEGER := 0;
    existing_count INTEGER;
BEGIN
    -- 验证输入日期格式
    IF loading_date_input IS NULL OR loading_date_input = '' THEN
        RAISE EXCEPTION '装货日期不能为空';
    END IF;
    
    -- 提取日期部分 (YYYYMMDD格式)
    BEGIN
        date_part := to_char(to_date(loading_date_input, 'YYYY-MM-DD'), 'YYYYMMDD');
    EXCEPTION WHEN OTHERS THEN
        RAISE EXCEPTION '日期格式错误: %', loading_date_input;
    END;
    
    LOOP
        attempt_count := attempt_count + 1;
        
        -- 获取当天的下一个序号（修复：正确提取序号）
        -- YDN20250818-001 格式：从第13位开始提取3位数字
        SELECT COALESCE(MAX(CAST(substring(auto_number from 13 for 3) AS INTEGER)), 0) + 1
        INTO next_number
        FROM public.logistics_records
        WHERE auto_number LIKE 'YDN' || date_part || '-%'
        AND auto_number ~ '^YDN[0-9]{8}-[0-9]{3}$'  -- 严格匹配标准格式
        AND loading_date::date = loading_date_input::date;
        
        -- 补零到3位数（确保从001开始）
        padded_number := LPAD(next_number::TEXT, 3, '0');
        
        -- 生成完整编号：YDN + 日期 + - + 3位序号
        final_number := 'YDN' || date_part || '-' || padded_number;
        
        -- 检查编号是否已存在
        SELECT COUNT(*) INTO existing_count
        FROM public.logistics_records 
        WHERE auto_number = final_number;
        
        IF existing_count = 0 THEN
            RETURN final_number;
        END IF;
        
        -- 如果编号已存在，增加序号重试
        next_number := next_number + 1;
        
        -- 防止无限循环
        IF attempt_count >= max_attempts THEN
            RAISE EXCEPTION '无法在 % 天内找到可用的运单编号，已尝试 % 次', 
                date_part, max_attempts;
        END IF;
    END LOOP;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.generate_invoice_request_number
CREATE OR REPLACE FUNCTION public.generate_invoice_request_number()
 RETURNS text
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_date_part text;
    v_seq_part text;
    v_max_seq integer;
BEGIN
    -- 日期部分：YYYYMMDD
    v_date_part := to_char(CURRENT_DATE, 'YYYYMMDD');
    
    -- 获取当天的最大序号
    SELECT COALESCE(
        MAX(
            CASE 
                WHEN ir.request_number ~ ('^KP' || v_date_part || '-[0-9]+$')
                THEN substring(ir.request_number from '[0-9]+$')::integer
                ELSE 0
            END
        ), 
        0
    ) + 1
    INTO v_max_seq
    FROM invoice_requests ir
    WHERE ir.request_number LIKE 'KP' || v_date_part || '%';
    
    -- 序号部分：4位数字，左补零
    v_seq_part := lpad(v_max_seq::text, 4, '0');
    
    -- 返回完整单号：KP + YYYYMMDD + - + 序号
    RETURN 'KP' || v_date_part || '-' || v_seq_part;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.generate_project_code
CREATE OR REPLACE FUNCTION public.generate_project_code()
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    date_part TEXT;
    next_number INTEGER;
    padded_number TEXT;
BEGIN
    -- 提取日期部分 (YYYYMMDD格式)
    date_part := to_char(now(), 'YYYYMMDD');
    
    -- 获取当天的下一个序号
    SELECT COALESCE(MAX(CAST(RIGHT(auto_code, 4) AS INTEGER)), 0) + 1
    INTO next_number
    FROM public.projects
    WHERE auto_code LIKE date_part || '%';
    
    -- 补零到4位数
    padded_number := LPAD(next_number::TEXT, 4, '0');
    
    RETURN date_part || padded_number;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_all_filtered_record_ids
CREATE OR REPLACE FUNCTION public.get_all_filtered_record_ids(p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_project_name text DEFAULT NULL::text, p_driver_name text DEFAULT NULL::text, p_license_plate text DEFAULT NULL::text, p_driver_phone text DEFAULT NULL::text, p_other_platform_name text DEFAULT NULL::text, p_waybill_numbers text DEFAULT NULL::text, p_has_scale_record text DEFAULT NULL::text)
 RETURNS jsonb
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_result jsonb;
    v_waybill_array text[];
BEGIN
    -- 解析运单编号字符串为数组
    IF p_waybill_numbers IS NOT NULL AND p_waybill_numbers != '' THEN
        v_waybill_array := string_to_array(p_waybill_numbers, ',');
        -- 去除每个元素的前后空格
        v_waybill_array := array(SELECT trim(unnest(v_waybill_array)));
    END IF;

    WITH filtered_records AS (
        SELECT lr.id,
               lr.auto_number,
               lr.project_name,
               lr.driver_name,
               lr.license_plate,
               lr.loading_date
        FROM public.logistics_records lr
        LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
        WHERE
            (p_start_date IS NULL OR p_start_date = '' OR lr.loading_date >= p_start_date::date) AND
            (p_end_date IS NULL OR p_end_date = '' OR lr.loading_date <= p_end_date::date) AND
            (p_project_name IS NULL OR p_project_name = '' OR lr.project_name = p_project_name) AND
            (p_driver_name IS NULL OR p_driver_name = '' OR lr.driver_name ILIKE '%' || p_driver_name || '%') AND
            (p_license_plate IS NULL OR p_license_plate = '' OR lr.license_plate ILIKE '%' || p_license_plate || '%') AND
            (p_driver_phone IS NULL OR p_driver_phone = '' OR lr.driver_phone ILIKE '%' || p_driver_phone || '%') AND
            -- 其他平台名称筛选：为空则查询本平台（other_platform_names为空或null），不为空则查询包含该平台名称的记录
            (p_other_platform_name IS NULL OR p_other_platform_name = '' OR 
             CASE 
                 WHEN p_other_platform_name = '本平台' THEN 
                     (lr.other_platform_names IS NULL OR array_length(lr.other_platform_names, 1) IS NULL)
                 ELSE 
                     EXISTS (SELECT 1 FROM unnest(lr.other_platform_names) AS platform_name 
                            WHERE platform_name ILIKE '%' || p_other_platform_name || '%')
             END) AND
            -- 运单编号筛选：支持多个运单编号查询
            (p_waybill_numbers IS NULL OR p_waybill_numbers = '' OR 
             lr.auto_number = ANY(v_waybill_array)) AND
            -- 磅单筛选：根据是否有磅单进行筛选
            (p_has_scale_record IS NULL OR p_has_scale_record = '' OR
             CASE 
                 WHEN p_has_scale_record = 'yes' THEN 
                     EXISTS (SELECT 1 FROM public.scale_records sr WHERE sr.logistics_number = lr.auto_number)
                 WHEN p_has_scale_record = 'no' THEN 
                     NOT EXISTS (SELECT 1 FROM public.scale_records sr WHERE sr.logistics_number = lr.auto_number)
                 ELSE true
             END)
    )
    SELECT jsonb_build_object(
        'recordIds', COALESCE(jsonb_agg(fr.id ORDER BY fr.loading_date DESC), '[]'::jsonb),
        'totalCount', COUNT(*),
        'summary', jsonb_build_object(
            'projectNames', COALESCE(jsonb_agg(DISTINCT fr.project_name ORDER BY fr.project_name), '[]'::jsonb),
            'driverNames', COALESCE(jsonb_agg(DISTINCT fr.driver_name ORDER BY fr.driver_name), '[]'::jsonb),
            'dateRange', jsonb_build_object(
                'earliest', MIN(fr.loading_date),
                'latest', MAX(fr.loading_date)
            )
        )
    ) INTO v_result
    FROM filtered_records fr;
    
    RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.get_all_projects_overview_data
CREATE OR REPLACE FUNCTION public.get_all_projects_overview_data(p_report_date date, p_project_ids uuid[] DEFAULT NULL::uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE
AS $function$
BEGIN
  -- 调用优化版本
  RETURN public.get_all_projects_overview_data_optimized(p_report_date, p_project_ids);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.get_all_projects_overview_data_0827
CREATE OR REPLACE FUNCTION public.get_all_projects_overview_data_0827(p_report_date date)
 RETURNS jsonb
 LANGUAGE sql
 SET search_path TO 'public'
AS $function$WITH
  -- ★★★ 1. 新增CTE：筛选出每个项目的主要合作方 ★★★
  -- 我们假设 level 数字越小，级别越高。此CTE确保每个 project_id 只返回一行记录。
  primary_project_partners AS (
    SELECT DISTINCT ON (project_id)
      project_id,
      partner_id,
      chain_id
    FROM project_partners
    ORDER BY project_id, level ASC -- 对于每个project_id，只取level最小的那一行
  ),

  -- ★★★ 2. 修改active_projects：使用筛选出的主要合作方进行关联 ★★★
  active_projects AS (
    SELECT
      proj.id,
      proj.name,
      part.name AS partner_name,
      proj.start_date,
      proj.planned_total_tons,
      pc.billing_type_id
    FROM 
      projects proj
    -- 不再直接关联 project_partners，而是关联我们预处理好的 primary_project_partners
    LEFT JOIN 
      primary_project_partners ppp ON proj.id = ppp.project_id
    LEFT JOIN 
      partners part ON ppp.partner_id = part.id
    LEFT JOIN
      partner_chains pc ON ppp.chain_id = pc.id
    WHERE 
      proj.project_status = '进行中'
  ),

  -- (以下部分无需修改，因为源头数据已经正确)

  -- 2. 计算每个项目在指定日期的日报指标
  daily_metrics AS (
    SELECT
      project_id,
      COUNT(*) AS trip_count,
      COALESCE(SUM(unloading_weight), 0) AS total_tonnage,
      COALESCE(SUM(driver_payable_cost), 0) AS driver_receivable,
      COALESCE(SUM(payable_cost), 0) AS partner_payable
    FROM logistics_records
    WHERE 
      loading_date::date = p_report_date
      AND project_id IN (SELECT id FROM active_projects)
    GROUP BY project_id
  ),

  -- 3. 计算每个项目的累计汇总指标
  summary_metrics AS (
    SELECT
      project_id,
      COUNT(*) AS total_trips,
      COALESCE(SUM(payable_cost), 0) AS total_cost,
      COALESCE(SUM(unloading_weight), 0) AS total_tonnage
    FROM logistics_records
    WHERE project_id IN (SELECT id FROM active_projects)
    GROUP BY project_id
  ),

  -- 4. 将上述数据整合成每个项目的“数据包”
  project_packages AS (
    SELECT
      ap.id,
      jsonb_build_object(
        'project_details', jsonb_build_object(
          'id', ap.id,
          'name', ap.name,
          'partner_name', ap.partner_name,
          'start_date', ap.start_date,
          'planned_total_tons', ap.planned_total_tons,
          'billing_type_id', ap.billing_type_id
        ),
        'daily_report', jsonb_build_object(
          'trip_count', COALESCE(dm.trip_count, 0),
          'total_tonnage', COALESCE(dm.total_tonnage, 0),
          'driver_receivable', COALESCE(dm.driver_receivable, 0),
          'partner_payable', COALESCE(dm.partner_payable, 0)
        ),
        'summary_stats', jsonb_build_object(
          'total_trips', COALESCE(sm.total_trips, 0),
          'total_cost', COALESCE(sm.total_cost, 0),
          'total_tonnage', COALESCE(sm.total_tonnage, 0),
          'avg_cost', (CASE WHEN COALESCE(sm.total_tonnage, 0) > 0 THEN COALESCE(sm.total_cost, 0) / sm.total_tonnage ELSE 0 END)
        )
      ) AS package
    FROM active_projects ap
    LEFT JOIN daily_metrics dm ON ap.id = dm.project_id
    LEFT JOIN summary_metrics sm ON ap.id = sm.project_id
  ),

  -- 5. 计算全局的近7日应收趋势
  daily_trend_source AS (
    SELECT
      d.date,
      COALESCE(SUM(lr.driver_payable_cost), 0) AS daily_receivable
    FROM 
      generate_series(p_report_date - interval '6 days', p_report_date, '1 day'::interval) d(date)
    LEFT JOIN 
      logistics_records lr ON lr.loading_date::date = d.date AND lr.project_id IN (SELECT id FROM active_projects)
    GROUP BY 
      d.date
  ),
  global_seven_day_trend AS (
    SELECT
      jsonb_agg(
        jsonb_build_object(
          'date', to_char(date, 'YYYY-MM-DD'),
          'receivable', daily_receivable
        ) ORDER BY date
      ) AS trend
    FROM 
      daily_trend_source
  ),

  -- 6. 计算全局的司机工作量总榜
  driver_daily_summary AS (
    SELECT
      driver_name,
      COUNT(*) AS trip_count,
      SUM(unloading_weight) AS total_tonnage,
      SUM(driver_payable_cost) AS total_driver_receivable
    FROM logistics_records
    WHERE 
      loading_date::date = p_report_date
      AND project_id IN (SELECT id FROM active_projects)
    GROUP BY 
      driver_name
  ),
  global_driver_report_table AS (
    SELECT
      jsonb_agg(
        jsonb_build_object(
          'driver_name', driver_name,
          'trip_count', trip_count,
          'total_tonnage', total_tonnage,
          'total_driver_receivable', total_driver_receivable
        ) ORDER BY total_driver_receivable DESC
      ) AS report
    FROM 
      driver_daily_summary
  )

-- 7. 最终组装成一个完整的JSON对象
SELECT jsonb_build_object(
  'all_projects_data', (SELECT jsonb_agg(package) FROM project_packages),
  'global_seven_day_trend', (SELECT trend FROM global_seven_day_trend),
  'global_driver_report_table', (SELECT report FROM global_driver_report_table),
  'global_summary', (
    SELECT jsonb_build_object(
      'total_projects', COUNT(*),
      'total_receivable', SUM(sm.total_cost),
      'total_trips', SUM(sm.total_trips)
    ) FROM active_projects ap JOIN summary_metrics sm ON ap.id = sm.project_id
  )
);$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.get_all_projects_overview_data_optimized
CREATE OR REPLACE FUNCTION public.get_all_projects_overview_data_optimized(p_report_date date, p_project_ids uuid[] DEFAULT NULL::uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE
AS $function$
DECLARE
  v_result jsonb;
BEGIN
  -- 使用单次查询获取所有数据，避免循环
  WITH 
  -- 1. 获取项目基础信息
  project_base AS (
    SELECT 
      p.id,
      p.name,
      p.planned_total_tons,
      COALESCE(pc.billing_type_id, 1) AS billing_type_id,
      COALESCE(pt.name, '未知合作方') AS partner_name,
      COALESCE(min_lr.start_date, CURRENT_DATE) AS start_date
    FROM projects p
    LEFT JOIN LATERAL (
      SELECT billing_type_id 
      FROM partner_chains 
      WHERE project_id = p.id 
      LIMIT 1
    ) pc ON true
    LEFT JOIN LATERAL (
      SELECT pt.name
      FROM project_partners pp
      JOIN partners pt ON pp.partner_id = pt.id
      WHERE pp.project_id = p.id
      ORDER BY pp.level DESC
      LIMIT 1
    ) pt ON true
    LEFT JOIN LATERAL (
      SELECT MIN(loading_date)::date AS start_date
      FROM logistics_records
      WHERE project_id = p.id
    ) min_lr ON true
    WHERE p_project_ids IS NULL OR p.id = ANY(p_project_ids)
  ),
  
  -- 2. 批量获取所有项目的日报数据（当天）
  daily_reports AS (
    SELECT 
      lr.project_id,
      COUNT(*) AS trip_count,
      COALESCE(SUM(COALESCE(lr.unloading_weight, lr.loading_weight)), 0) AS total_tonnage,
      COALESCE(SUM(lpc_driver.base_amount), 0) AS driver_receivable,
      COALESCE(SUM(lpc_top.payable_amount), 0) AS partner_payable
    FROM logistics_records lr
    LEFT JOIN logistics_partner_costs lpc_driver 
      ON lr.id = lpc_driver.logistics_record_id AND lpc_driver.level = 1
    LEFT JOIN LATERAL (
      SELECT payable_amount
      FROM logistics_partner_costs
      WHERE logistics_record_id = lr.id
      ORDER BY level DESC
      LIMIT 1
    ) lpc_top ON true
    WHERE lr.loading_date::date = p_report_date
    AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id
  ),
  
  -- 3. 批量获取所有项目的汇总统计（截至报告日期）
  -- 分两步：先聚合，再计算（避免嵌套聚合错误）
  summary_stats_base AS (
    SELECT 
      lr.project_id,
      COUNT(*) AS total_trips,
      SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS total_tonnage,
      SUM(lpc_top.payable_amount) AS total_cost
    FROM logistics_records lr
    LEFT JOIN LATERAL (
      SELECT payable_amount
      FROM logistics_partner_costs
      WHERE logistics_record_id = lr.id
      ORDER BY level DESC
      LIMIT 1
    ) lpc_top ON true
    WHERE lr.loading_date::date <= p_report_date
    AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id
  ),
  summary_stats AS (
    SELECT 
      project_id,
      total_trips,
      COALESCE(total_tonnage, 0) AS total_tonnage,
      COALESCE(total_cost, 0) AS total_cost,
      CASE 
        WHEN COALESCE(total_tonnage, 0) > 0 
        THEN COALESCE(total_cost, 0) / total_tonnage
        ELSE 0
      END AS avg_cost
    FROM summary_stats_base
  ),
  
  -- 4. 批量获取7日趋势（所有项目）
  seven_day_trend AS (
    SELECT 
      lr.project_id,
      TO_CHAR(lr.loading_date::date, 'MM-DD') AS date,
      COALESCE(SUM(lpc.base_amount), 0) AS receivable
    FROM logistics_records lr
    LEFT JOIN logistics_partner_costs lpc 
      ON lr.id = lpc.logistics_record_id AND lpc.level = 1
    WHERE lr.loading_date::date BETWEEN p_report_date - INTERVAL '6 days' AND p_report_date
    AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id, lr.loading_date::date
  ),
  
  -- 5. 批量获取司机工作量（当天）
  driver_reports AS (
    SELECT 
      lr.project_id,
      d.name AS driver_name,
      COUNT(lr.id) AS trip_count,
      SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS total_tonnage,
      SUM(lpc.base_amount) AS total_driver_receivable
    FROM logistics_records lr
    JOIN drivers d ON lr.driver_id = d.id
    LEFT JOIN logistics_partner_costs lpc 
      ON lr.id = lpc.logistics_record_id AND lpc.level = 1
    WHERE lr.loading_date::date = p_report_date
    AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id, d.name
  ),
  
  -- 6. 组装每个项目的数据
  projects_data AS (
    SELECT jsonb_agg(
      jsonb_build_object(
        'project_details', jsonb_build_object(
          'id', pb.id,
          'name', pb.name,
          'partner_name', pb.partner_name,
          'start_date', pb.start_date,
          'planned_total_tons', COALESCE(pb.planned_total_tons, 0),
          'billing_type_id', pb.billing_type_id
        ),
        'daily_report', COALESCE(
          jsonb_build_object(
            'trip_count', dr.trip_count,
            'total_tonnage', dr.total_tonnage,
            'driver_receivable', dr.driver_receivable,
            'partner_payable', dr.partner_payable
          ),
          '{"trip_count":0,"total_tonnage":0,"driver_receivable":0,"partner_payable":0}'::jsonb
        ),
        'summary_stats', COALESCE(
          jsonb_build_object(
            'total_trips', ss.total_trips,
            'total_tonnage', ss.total_tonnage,
            'total_cost', ss.total_cost,
            'avg_cost', ss.avg_cost
          ),
          '{"total_trips":0,"total_tonnage":0,"total_cost":0,"avg_cost":0}'::jsonb
        ),
        'seven_day_trend', COALESCE(
          (SELECT jsonb_agg(
            jsonb_build_object('date', sdt.date, 'receivable', sdt.receivable)
            ORDER BY sdt.date
          )
          FROM seven_day_trend sdt
          WHERE sdt.project_id = pb.id),
          '[]'::jsonb
        ),
        'driver_report_table', COALESCE(
          (SELECT jsonb_agg(
            jsonb_build_object(
              'driver_name', drep.driver_name,
              'trip_count', drep.trip_count,
              'total_tonnage', drep.total_tonnage,
              'total_driver_receivable', drep.total_driver_receivable
            )
            ORDER BY drep.driver_name
          )
          FROM driver_reports drep
          WHERE drep.project_id = pb.id),
          '[]'::jsonb
        )
      )
    ) AS all_projects_data
    FROM project_base pb
    LEFT JOIN daily_reports dr ON pb.id = dr.project_id
    LEFT JOIN summary_stats ss ON pb.id = ss.project_id
  ),
  
  -- 7. 全局7日趋势
  global_trend AS (
    SELECT jsonb_agg(
      jsonb_build_object('date', ds.date, 'receivable', COALESCE(trend_sum.receivable, 0))
      ORDER BY ds.date
    ) AS global_seven_day_trend
    FROM (
      SELECT TO_CHAR(generate_series(
        p_report_date - INTERVAL '6 days', 
        p_report_date, 
        '1 day'::interval
      )::date, 'MM-DD') AS date
    ) ds
    LEFT JOIN (
      SELECT date, SUM(receivable) AS receivable
      FROM seven_day_trend
      GROUP BY date
    ) trend_sum ON ds.date = trend_sum.date
  ),
  
  -- 8. 全局司机报表
  -- 分两步：先聚合司机数据，再转换为jsonb
  global_drivers_agg AS (
    SELECT 
      driver_name,
      SUM(trip_count) AS trip_count,
      SUM(total_tonnage) AS total_tonnage,
      SUM(total_driver_receivable) AS total_driver_receivable
    FROM driver_reports
    GROUP BY driver_name
  ),
  global_drivers AS (
    SELECT jsonb_agg(
      jsonb_build_object(
        'driver_name', driver_name,
        'trip_count', trip_count,
        'total_tonnage', total_tonnage,
        'total_driver_receivable', total_driver_receivable
      )
      ORDER BY total_driver_receivable DESC
    ) AS global_driver_report_table
    FROM global_drivers_agg
  ),
  
  -- 9. 全局汇总
  global_summary_data AS (
    SELECT jsonb_build_object(
      'total_projects', COUNT(DISTINCT pb.id),
      'total_receivable', COALESCE(SUM(ss.total_cost), 0),
      'total_trips', COALESCE(SUM(ss.total_trips), 0)
    ) AS global_summary
    FROM project_base pb
    LEFT JOIN summary_stats ss ON pb.id = ss.project_id
  )
  
  -- 10. 组装最终结果
  SELECT jsonb_build_object(
    'all_projects_data', COALESCE(pd.all_projects_data, '[]'::jsonb),
    'global_seven_day_trend', COALESCE(gt.global_seven_day_trend, '[]'::jsonb),
    'global_driver_report_table', COALESCE(gd.global_driver_report_table, '[]'::jsonb),
    'global_summary', gs.global_summary
  )
  INTO v_result
  FROM projects_data pd, global_trend gt, global_drivers gd, global_summary_data gs;
  
  RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.get_all_projects_overview_data_v3
CREATE OR REPLACE FUNCTION public.get_all_projects_overview_data_v3(p_report_date date, p_project_ids uuid[] DEFAULT NULL::uuid[])
 RETURNS json
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result json;
BEGIN
    WITH project_base AS (
        SELECT id FROM projects
        WHERE (p_project_ids IS NULL OR id = ANY(p_project_ids))
    ),
    project_data AS (
        SELECT
            p.id,
            jsonb_build_object(
                'id', p.id,
                'name', p.name,
                'partner_name', pt.name,
                'start_date', p.start_date,
                'planned_total_tons', p.planned_total_tons,
                'billing_type_id', p.billing_type_id
            ) AS project_details,
            -- Daily Report
            (SELECT jsonb_build_object(
                'trip_count', COUNT(lr.id),
                'total_tonnage', SUM(COALESCE(lr.unloading_weight, lr.loading_weight, 0)),
                'driver_receivable', SUM(lr.payable_cost)
            ) FROM logistics_records lr WHERE lr.project_id = p.id AND lr.loading_date = p_report_date) AS daily_report,
            -- Summary Stats
            (SELECT jsonb_build_object(
                'total_trips', COUNT(lr.id),
                'total_tonnage', SUM(COALESCE(lr.unloading_weight, lr.loading_weight, 0)),
                'total_cost', SUM(lr.payable_cost)
            ) FROM logistics_records lr WHERE lr.project_id = p.id) AS summary_stats,
            -- Driver Report Table
            (SELECT COALESCE(jsonb_agg(d_rep), '[]'::jsonb) FROM (
                SELECT
                    d.name AS driver_name,
                    COUNT(lr.id) AS trip_count,
                    SUM(COALESCE(lr.unloading_weight, lr.loading_weight, 0)) AS total_tonnage,
                    SUM(lr.payable_cost) AS total_driver_receivable
                FROM logistics_records lr JOIN drivers d ON lr.driver_id = d.id
                WHERE lr.project_id = p.id AND lr.loading_date = p_report_date
                GROUP BY d.name
                ORDER BY trip_count DESC
            ) d_rep) AS driver_report_table,
            -- ★★★ 最终修正版的 15日项目追踪图表数据逻辑 ★★★
            (
                SELECT COALESCE(jsonb_agg(trend_data), '[]'::jsonb)
                FROM (
                    WITH date_series AS (
                        SELECT generate_series(p_report_date - interval '14 days', p_report_date, '1 day')::date AS day
                    ),
                    top_partner_calc AS (
                        SELECT lr.partner_id, pa.name as partner_name
                        FROM logistics_records lr JOIN partners pa ON lr.partner_id = pa.id
                        WHERE lr.project_id = p.id
                          AND lr.loading_date BETWEEN p_report_date - interval '14 days' AND p_report_date
                          AND lr.payable_cost > 0
                        GROUP BY lr.partner_id, pa.name
                        ORDER BY SUM(lr.payable_cost) DESC
                        LIMIT 1
                    )
                    SELECT
                        to_char(ds.day, 'YYYY-MM-DD') AS "date",
                        COALESCE(SUM(lr.payable_cost), 0)::numeric AS payable_amount,
                        COUNT(lr.id)::bigint AS trip_count,
                        -- 修正后的逻辑：如果 top_partner_calc 有结果，就用它的名字，否则用项目主合作方的名字
                        COALESCE((SELECT partner_name FROM top_partner_calc), pt.name) AS partner_name
                    FROM date_series ds
                    LEFT JOIN logistics_records lr ON lr.loading_date = ds.day
                        AND lr.project_id = p.id
                        -- 修正后的逻辑：如果 top_partner_calc 有结果，就用它的ID，否则用项目主合作方的ID
                        AND lr.partner_id = COALESCE((SELECT partner_id FROM top_partner_calc), p.partner_id)
                    GROUP BY ds.day
                    ORDER BY ds.day
                ) trend_data
            ) AS fifteen_day_partner_trend
        FROM
            projects p
        JOIN
            partners pt ON p.partner_id = pt.id
        WHERE
            p.id IN (SELECT id FROM project_base)
    )
    SELECT json_build_object(
        'all_projects_data', COALESCE((SELECT json_agg(pd) FROM project_data pd), '[]'::json),
        'global_summary', (SELECT json_build_object(
            'total_projects', COUNT(p.id),
            'total_receivable', SUM(lr.payable_cost),
            'total_trips', COUNT(lr.id)
        )
        FROM projects p
        LEFT JOIN logistics_records lr ON p.id = lr.project_id
        WHERE p.id IN (SELECT id FROM project_base))
    ) INTO result;

    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.get_all_projects_overview_data_with_driver_receivable
CREATE OR REPLACE FUNCTION public.get_all_projects_overview_data_with_driver_receivable(p_report_date date, p_project_ids uuid[] DEFAULT NULL::uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE
AS $function$
BEGIN
  RETURN get_projects_overview_with_driver_receivable(
    p_report_date::text,
    NULL,
    p_project_ids
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_all_roles
CREATE OR REPLACE FUNCTION public.get_all_roles()
 RETURNS TABLE(role_key text, role_label text, user_count bigint, template_exists boolean)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        e.enumlabel::text as role_key,
        COALESCE(r.label, e.enumlabel::text) as role_label,
        COALESCE(p.user_count, 0) as user_count,
        CASE WHEN rt.role IS NOT NULL THEN true ELSE false END as template_exists
    FROM pg_enum e
    JOIN pg_type t ON e.enumtypid = t.oid
    LEFT JOIN (
        SELECT role, COUNT(*) as user_count
        FROM public.profiles
        GROUP BY role
    ) p ON e.enumlabel = p.role
    LEFT JOIN public.role_permission_templates rt ON e.enumlabel = rt.role
    LEFT JOIN (
        SELECT 'admin' as role, '系统管理员' as label
        UNION ALL SELECT 'finance', '财务人员'
        UNION ALL SELECT 'business', '业务人员'
        UNION ALL SELECT 'operator', '操作员'
        UNION ALL SELECT 'partner', '合作方'
        UNION ALL SELECT 'viewer', '查看者'
    ) r ON e.enumlabel = r.role
    WHERE t.typname = 'app_role'
    ORDER BY e.enumsortorder;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.get_all_used_platforms
CREATE OR REPLACE FUNCTION public.get_all_used_platforms()
 RETURNS TABLE(platform_name text, usage_count bigint)
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    platform_name,
    COUNT(*) as usage_count
  FROM (
    SELECT unnest(other_platform_names) as platform_name
    FROM public.logistics_records
    WHERE other_platform_names IS NOT NULL
    AND array_length(other_platform_names, 1) > 0
  ) t
  GROUP BY platform_name
  ORDER BY usage_count DESC;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_available_platforms
CREATE OR REPLACE FUNCTION public.get_available_platforms()
 RETURNS TABLE(platform_name text, usage_count bigint, last_used timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    platform_name,
    usage_count,
    MAX(last_used) as last_used
  FROM (
    -- 从external_tracking_numbers字段获取平台信息
    SELECT 
      (item->>'platform') as platform_name,
      COUNT(*) as usage_count,
      MAX(lr.created_at) as last_used
    FROM public.logistics_records lr,
         jsonb_array_elements(lr.external_tracking_numbers) AS item
    WHERE lr.external_tracking_numbers IS NOT NULL
      AND jsonb_array_length(lr.external_tracking_numbers) > 0
      AND (item->>'platform') IS NOT NULL
      AND (item->>'platform') != ''
    GROUP BY (item->>'platform')
    
    UNION ALL
    
    -- 从other_platform_names字段获取平台信息
    SELECT 
      unnest(lr.other_platform_names) as platform_name,
      COUNT(*) as usage_count,
      MAX(lr.created_at) as last_used
    FROM public.logistics_records lr
    WHERE lr.other_platform_names IS NOT NULL
      AND array_length(lr.other_platform_names, 1) > 0
    GROUP BY unnest(lr.other_platform_names)
  ) combined
  WHERE platform_name IS NOT NULL AND platform_name != ''
  GROUP BY platform_name, usage_count
  ORDER BY usage_count DESC, last_used DESC;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.get_cached_permissions
CREATE OR REPLACE FUNCTION public.get_cached_permissions(p_cache_key text)
 RETURNS jsonb
 LANGUAGE plpgsql
AS $function$
DECLARE
    cached_data JSONB;
BEGIN
    SELECT cache_data INTO cached_data
    FROM permission_cache
    WHERE cache_key = p_cache_key 
    AND expires_at > NOW();
    
    RETURN cached_data;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.get_contract_category_templates
CREATE OR REPLACE FUNCTION public.get_contract_category_templates()
 RETURNS TABLE(id uuid, category contract_category, template_name text, description text, default_permissions text[], role_permissions jsonb, is_active boolean, created_at timestamp with time zone, updated_at timestamp with time zone)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        ccpt.id,
        ccpt.category,
        ccpt.template_name,
        ccpt.description,
        ccpt.default_permissions,
        ccpt.role_permissions,
        ccpt.is_active,
        ccpt.created_at,
        ccpt.updated_at
    FROM public.contract_category_permission_templates ccpt
    WHERE ccpt.is_active = true
    ORDER BY ccpt.category, ccpt.created_at DESC;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.get_contract_owner_permissions
CREATE OR REPLACE FUNCTION public.get_contract_owner_permissions()
 RETURNS TABLE(id uuid, contract_id uuid, owner_id uuid, permissions text[], created_at timestamp with time zone, updated_at timestamp with time zone, owner_name text, contract_title text, contract_category contract_category)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        cop.id,
        cop.contract_id,
        cop.owner_id,
        cop.permissions,
        cop.created_at,
        cop.updated_at,
        COALESCE(p.full_name, '未知用户') as owner_name,
        CONCAT(COALESCE(c.counterparty_company, '未知公司'), ' - ', COALESCE(c.our_company, '未知公司')) as contract_title,
        c.category as contract_category
    FROM public.contract_owner_permissions cop
    LEFT JOIN public.profiles p ON cop.owner_id = p.id
    LEFT JOIN public.contracts c ON cop.contract_id = c.id
    ORDER BY cop.created_at DESC;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.get_contract_permission_stats
CREATE OR REPLACE FUNCTION public.get_contract_permission_stats()
 RETURNS TABLE(total_permissions bigint, active_permissions bigint, expired_permissions bigint, user_permissions bigint, role_permissions bigint, department_permissions bigint, owner_permissions bigint)
 LANGUAGE plpgsql
AS $function$
DECLARE
    has_is_active_column BOOLEAN;
BEGIN
    -- 检查is_active字段是否存在
    SELECT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'contract_permissions' 
        AND column_name = 'is_active' 
        AND table_schema = 'public'
    ) INTO has_is_active_column;
    
    RETURN QUERY
    SELECT 
        (SELECT COUNT(*) FROM contract_permissions) as total_permissions,
        CASE 
            WHEN has_is_active_column THEN
                (SELECT COUNT(*) FROM contract_permissions 
                 WHERE is_active = true AND (expires_at IS NULL OR expires_at > NOW()))
            ELSE
                (SELECT COUNT(*) FROM contract_permissions 
                 WHERE expires_at IS NULL OR expires_at > NOW())
        END as active_permissions,
        (SELECT COUNT(*) FROM contract_permissions WHERE expires_at IS NOT NULL AND expires_at <= NOW()) as expired_permissions,
        (SELECT COUNT(*) FROM contract_permissions WHERE user_id IS NOT NULL) as user_permissions,
        (SELECT COUNT(*) FROM contract_permissions WHERE role_id IS NOT NULL) as role_permissions,
        (SELECT COUNT(*) FROM contract_permissions WHERE department_id IS NOT NULL) as department_permissions,
        (SELECT COUNT(*) FROM contract_owner_permissions) as owner_permissions;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.get_dashboard_quick_stats
CREATE OR REPLACE FUNCTION public.get_dashboard_quick_stats(p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_project_id uuid DEFAULT NULL::uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result jsonb;
    default_start_date date;
    default_end_date date;
BEGIN
    -- 设置默认日期范围：最近30天
    default_start_date := COALESCE(p_start_date, CURRENT_DATE - INTERVAL '30 days');
    default_end_date := COALESCE(p_end_date, CURRENT_DATE);
    
    WITH filtered_records AS (
        SELECT 
            lr.*,
            COALESCE(lr.billing_type_id, 1) as billing_type
        FROM logistics_records lr
        WHERE 
            lr.loading_date >= default_start_date
            AND lr.loading_date <= default_end_date
            AND (p_project_id IS NULL OR lr.project_id = p_project_id)
    ),
    overview_stats AS (
        SELECT 
            COUNT(*) as total_records,
            COALESCE(SUM(
                CASE 
                    WHEN billing_type = 1 THEN COALESCE(unloading_weight, loading_weight, 0)
                    ELSE 0 
                END
            ), 0) as total_weight,
            COALESCE(SUM(
                CASE 
                    WHEN billing_type = 3 THEN COALESCE(loading_weight, 0)
                    ELSE 0 
                END
            ), 0) as total_volume,
            COUNT(
                CASE 
                    WHEN billing_type = 2 THEN 1
                    ELSE NULL 
                END
            ) as total_trips,
            COALESCE(SUM(payable_cost), 0) as total_cost,
            COUNT(CASE WHEN transport_type = '实际运输' THEN 1 END) as actual_transport_count,
            COUNT(CASE WHEN transport_type = '退货' THEN 1 END) as return_count
        FROM filtered_records
    ),
    type_stats AS (
        SELECT 
            billing_type,
            COUNT(*) as record_count,
            COALESCE(SUM(
                CASE 
                    WHEN billing_type = 1 THEN COALESCE(unloading_weight, loading_weight, 0)
                    WHEN billing_type = 3 THEN COALESCE(loading_weight, 0)
                    ELSE 0 
                END
            ), 0) as total_quantity
        FROM filtered_records
        GROUP BY billing_type
    )
    SELECT jsonb_build_object(
        'overview', (
            SELECT jsonb_build_object(
                'totalRecords', total_records,
                'totalWeight', total_weight,
                'totalVolume', total_volume,
                'totalTrips', total_trips,
                'totalCost', total_cost,
                'actualTransportCount', actual_transport_count,
                'returnCount', return_count
            )
            FROM overview_stats
        ),
        'totalQuantityByType', (
            SELECT jsonb_object_agg(
                billing_type::text, 
                total_quantity
            )
            FROM type_stats
        ),
        'dateRange', jsonb_build_object(
            'startDate', default_start_date,
            'endDate', default_end_date
        )
    )
    INTO result;

    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_dashboard_stats
CREATE OR REPLACE FUNCTION public.get_dashboard_stats(start_date_param date, end_date_param date, project_id_param uuid DEFAULT NULL::uuid)
 RETURNS json
 LANGUAGE sql
 SET search_path TO 'public'
AS $function$
-- 步骤1: 使用索引高效筛选出在指定日期范围和项目内的记录
WITH filtered_records AS (
    SELECT
        id,
        project_id,
        project_name,
        loading_date,
        loading_weight,
        unloading_weight,
        transport_type,
        COALESCE(current_cost, 0) AS current_fee,
        COALESCE(extra_cost, 0) AS extra_fee,
        COALESCE(driver_payable_cost, 0) AS payable_fee,
        auto_number,
        driver_name,
        license_plate,
        loading_location,
        unloading_location,
        remarks
    FROM
        public.logistics_records
    WHERE
        loading_date >= start_date_param
        AND loading_date <= end_date_param
        AND (project_id_param IS NULL OR project_id = project_id_param)
),
-- 步骤2: 对筛选后的记录进行每日聚合计算
daily_stats AS (
    SELECT
        loading_date::date AS "date",
        SUM(CASE WHEN transport_type = '实际运输' THEN loading_weight ELSE 0 END) AS "actualTransport",
        SUM(CASE WHEN transport_type = '退货' THEN loading_weight ELSE 0 END) AS "returns",
        SUM(current_fee + extra_fee) AS "totalCost",
        COUNT(*) AS "count"
    FROM
        filtered_records
    GROUP BY
        loading_date::date
),
-- 步骤3: 对筛选后的记录进行总览聚合计算
overview_stats AS (
    SELECT
        COUNT(*) AS "totalRecords",
        SUM(loading_weight) AS "totalWeight",
        SUM(current_fee + extra_fee) AS "totalCost",
        SUM(CASE WHEN transport_type = '实际运输' THEN 1 ELSE 0 END) AS "actualTransportCount",
        SUM(CASE WHEN transport_type = '退货' THEN 1 ELSE 0 END) AS "returnCount"
    FROM
        filtered_records
)
-- 步骤4: [核心性能优化] 将所有聚合数据构建成一个轻量级的JSON对象返回。
-- 注意：这里不再包含 'records' 字段，从而避免了巨大的数据传输。
SELECT json_build_object(
    'overview', (SELECT to_json(overview_stats) FROM overview_stats),
    'dailyTransportStats', (SELECT json_agg(daily_stats.* ORDER BY date) FROM daily_stats),
    'dailyCostStats', (SELECT json_agg(json_build_object('date', date, 'totalCost', "totalCost") ORDER BY date) FROM daily_stats),
    'dailyCountStats', (SELECT json_agg(json_build_object('date', date, 'count', "count") ORDER BY date) FROM daily_stats)
);
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.get_dashboard_stats_v2
CREATE OR REPLACE FUNCTION public.get_dashboard_stats_v2(p_start_date date, p_end_date date, p_project_id uuid DEFAULT NULL::uuid)
 RETURNS jsonb
 LANGUAGE sql
 SET search_path TO 'public'
AS $function$
WITH filtered_records AS (
  -- 步骤1: 筛选出在指定日期范围和项目内的所有相关记录
  SELECT
    id,
    payable_cost,
    transport_type,
    billing_type_id,
    loading_date AS date,
    COALESCE(unloading_weight, loading_weight) AS quantity
  FROM
    logistics_records
  WHERE
    loading_date BETWEEN p_start_date AND p_end_date
    AND (p_project_id IS NULL OR project_id = p_project_id)
    AND billing_type_id IN (1, 2, 3) -- 只关注这三种计费类型
),
overview_stats AS (
  -- 步骤2: 计算顶部的全局概览统计数据
  SELECT
    count(*) AS "totalRecords",
    sum(payable_cost) AS "totalCost",
    count(*) FILTER (WHERE transport_type = '实际运输') AS "actualTransportCount",
    count(*) FILTER (WHERE transport_type = '退货') AS "returnCount"
  FROM
    filtered_records
),
quantity_by_type_stats AS (
  -- 步骤3: 按计费类型计算总运输量 (用于动态汇总卡片)
  SELECT
    jsonb_object_agg(
      billing_type_id,
      total_quantity
    ) AS data
  FROM (
    SELECT
      billing_type_id,
      sum(quantity) AS total_quantity
    FROM
      filtered_records
    GROUP BY
      billing_type_id
  ) as stats
),
daily_summary AS (
  -- 步骤4: 按天和计费类型(单位)进行分组统计
  SELECT
    date,
    billing_type_id,
    sum(CASE WHEN transport_type = '实际运输' THEN quantity ELSE 0 END) AS "actualTransport",
    sum(CASE WHEN transport_type = '退货' THEN quantity ELSE 0 END) AS "returns"
  FROM
    filtered_records
  GROUP BY
    date,
    billing_type_id
),
daily_stats_by_type AS (
  -- 步骤5: 将每日统计数据按计费类型聚合成JSON对象
  SELECT
    jsonb_object_agg(
      billing_type_id,
      jsonb_build_object(
        'stats', stats,
        'totalActual', total_actual,
        'totalReturns', total_returns
      )
    ) AS data
  FROM (
    SELECT
      billing_type_id,
      jsonb_agg(jsonb_build_object('date', date, 'actualTransport', "actualTransport", 'returns', "returns") ORDER BY date) AS stats,
      sum("actualTransport") AS total_actual,
      sum("returns") AS total_returns
    FROM daily_summary
    GROUP BY billing_type_id
  ) AS grouped_by_type
),
daily_cost_stats AS (
  -- 步骤6: 计算每日总费用
  SELECT
    jsonb_agg(jsonb_build_object('date', date, 'totalCost', total_cost) ORDER BY date) AS data
  FROM (
    SELECT date, sum(payable_cost) AS total_cost
    FROM filtered_records
    GROUP BY date
  ) AS cost_summary
),
daily_count_stats AS (
  -- 步骤7: 计算每日运输次数
  SELECT
    jsonb_agg(jsonb_build_object('date', date, 'count', count) ORDER BY date) AS data
  FROM (
    SELECT date, count(*) AS count
    FROM filtered_records
    GROUP BY date
  ) AS count_summary
)
-- 步骤8: 将所有计算结果组装成最终的JSON对象
SELECT
  jsonb_build_object(
    'overview', to_jsonb(ov.*),
    'totalQuantityByType', COALESCE(qts.data, '{}'::jsonb),
    'daily_stats_by_type', COALESCE(dst.data, '{}'::jsonb),
    'dailyCostStats', COALESCE(dcs.data, '[]'::jsonb),
    'dailyCountStats', COALESCE(dcs_count.data, '[]'::jsonb)
  )
FROM
  overview_stats ov,
  quantity_by_type_stats qts,
  daily_stats_by_type dst,
  daily_cost_stats dcs,
  daily_count_stats dcs_count;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.get_dashboard_stats_with_billing_types
CREATE OR REPLACE FUNCTION public.get_dashboard_stats_with_billing_types(p_start_date date, p_end_date date, p_project_id uuid DEFAULT NULL::uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result jsonb;
BEGIN
    WITH filtered_records AS (
        SELECT 
            lr.*,
            COALESCE(lr.billing_type_id, 1) as billing_type
        FROM logistics_records lr
        WHERE 
            lr.loading_date >= p_start_date
            AND lr.loading_date <= p_end_date
            AND (p_project_id IS NULL OR lr.project_id = p_project_id)
    )
    SELECT jsonb_build_object(
        'overview', (
            SELECT jsonb_build_object(
                'totalRecords', COUNT(*),
                'totalWeight', COALESCE(SUM(
                    CASE 
                        WHEN billing_type = 1 THEN COALESCE(unloading_weight, loading_weight, 0)
                        ELSE 0 
                    END
                ), 0),
                'totalVolume', COALESCE(SUM(
                    CASE 
                        WHEN billing_type = 3 THEN COALESCE(loading_weight, 0)
                        ELSE 0 
                    END
                ), 0),
                'totalTrips', COUNT(
                    CASE 
                        WHEN billing_type = 2 THEN 1
                        ELSE NULL 
                    END
                ),
                'totalCost', COALESCE(SUM(payable_cost), 0),
                'actualTransportCount', COUNT(CASE WHEN transport_type = '实际运输' THEN 1 END),
                'returnCount', COUNT(CASE WHEN transport_type = '退货' THEN 1 END),
                'weightRecordsCount', COUNT(CASE WHEN billing_type = 1 THEN 1 END),
                'tripRecordsCount', COUNT(CASE WHEN billing_type = 2 THEN 1 END),
                'volumeRecordsCount', COUNT(CASE WHEN billing_type = 3 THEN 1 END)
            )
            FROM filtered_records
        ),
        'dailyTransportStats', (
            SELECT COALESCE(jsonb_agg(
                jsonb_build_object(
                    'date', to_char(series_date, 'YYYY-MM-DD'),
                    'actualTransport', COALESCE(stats.actual_transport, 0),
                    'returns', COALESCE(stats.returns, 0)
                ) ORDER BY series_date
            ), '[]'::jsonb)
            FROM generate_series(p_start_date, p_end_date, '1 day'::interval) series_date
            LEFT JOIN (
                SELECT 
                    DATE(loading_date) as loading_date_only,
                    SUM(
                        CASE 
                            WHEN billing_type = 1 AND transport_type = '实际运输' 
                            THEN COALESCE(unloading_weight, loading_weight, 0)
                            ELSE 0 
                        END
                    ) as actual_transport,
                    SUM(
                        CASE 
                            WHEN billing_type = 1 AND transport_type = '退货' 
                            THEN COALESCE(unloading_weight, loading_weight, 0)
                            ELSE 0 
                        END
                    ) as returns
                FROM filtered_records 
                WHERE billing_type = 1
                GROUP BY DATE(loading_date)
            ) stats ON DATE(series_date) = stats.loading_date_only
        ),
        'dailyTripStats', (
            SELECT COALESCE(jsonb_agg(
                jsonb_build_object(
                    'date', to_char(series_date, 'YYYY-MM-DD'),
                    'actualTransport', COALESCE(stats.actual_transport, 0),
                    'returns', COALESCE(stats.returns, 0)
                ) ORDER BY series_date
            ), '[]'::jsonb)
            FROM generate_series(p_start_date, p_end_date, '1 day'::interval) series_date
            LEFT JOIN (
                SELECT 
                    DATE(loading_date) as loading_date_only,
                    COUNT(
                        CASE 
                            WHEN billing_type = 2 AND transport_type = '实际运输' 
                            THEN 1 
                            ELSE NULL 
                        END
                    ) as actual_transport,
                    COUNT(
                        CASE 
                            WHEN billing_type = 2 AND transport_type = '退货' 
                            THEN 1 
                            ELSE NULL 
                        END
                    ) as returns
                FROM filtered_records 
                WHERE billing_type = 2
                GROUP BY DATE(loading_date)
            ) stats ON DATE(series_date) = stats.loading_date_only
        ),
        'dailyVolumeStats', (
            SELECT COALESCE(jsonb_agg(
                jsonb_build_object(
                    'date', to_char(series_date, 'YYYY-MM-DD'),
                    'actualTransport', COALESCE(stats.actual_transport, 0),
                    'returns', COALESCE(stats.returns, 0)
                ) ORDER BY series_date
            ), '[]'::jsonb)
            FROM generate_series(p_start_date, p_end_date, '1 day'::interval) series_date
            LEFT JOIN (
                SELECT 
                    DATE(loading_date) as loading_date_only,
                    SUM(
                        CASE 
                            WHEN billing_type = 3 AND transport_type = '实际运输' 
                            THEN COALESCE(loading_weight, 0)
                            ELSE 0 
                        END
                    ) as actual_transport,
                    SUM(
                        CASE 
                            WHEN billing_type = 3 AND transport_type = '退货' 
                            THEN COALESCE(loading_weight, 0)
                            ELSE 0 
                        END
                    ) as returns
                FROM filtered_records 
                WHERE billing_type = 3
                GROUP BY DATE(loading_date)
            ) stats ON DATE(series_date) = stats.loading_date_only
        ),
        'dailyCostStats', (
            SELECT COALESCE(jsonb_agg(
                jsonb_build_object(
                    'date', to_char(series_date, 'YYYY-MM-DD'),
                    'totalCost', COALESCE(stats.total_cost, 0)
                ) ORDER BY series_date
            ), '[]'::jsonb)
            FROM generate_series(p_start_date, p_end_date, '1 day'::interval) series_date
            LEFT JOIN (
                SELECT 
                    DATE(loading_date) as loading_date_only,
                    SUM(payable_cost) as total_cost
                FROM filtered_records
                GROUP BY DATE(loading_date)
            ) stats ON DATE(series_date) = stats.loading_date_only
        ),
        'dailyCountStats', (
            SELECT COALESCE(jsonb_agg(
                jsonb_build_object(
                    'date', to_char(series_date, 'YYYY-MM-DD'),
                    'count', COALESCE(stats.record_count, 0)
                ) ORDER BY series_date
            ), '[]'::jsonb)
            FROM generate_series(p_start_date, p_end_date, '1 day'::interval) series_date
            LEFT JOIN (
                SELECT 
                    DATE(loading_date) as loading_date_only,
                    COUNT(*) as record_count
                FROM filtered_records
                GROUP BY DATE(loading_date)
            ) stats ON DATE(series_date) = stats.loading_date_only
        )
    )
    INTO result;

    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.get_detailed_records_for_chart
CREATE OR REPLACE FUNCTION public.get_detailed_records_for_chart(p_filter_type text, p_filter_value text, p_page_size integer, p_page_number integer)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result JSON;
BEGIN
    WITH highest_level_costs AS (
        SELECT
            DISTINCT ON (lpc.logistics_record_id)
            lpc.logistics_record_id, lr.loading_date, lr.payment_status,
            lr.project_name, COALESCE(p.name, '未知合作方') AS partner_name
        FROM public.logistics_partner_costs lpc
        JOIN public.logistics_records lr ON lpc.logistics_record_id = lr.id
        LEFT JOIN public.partners p ON lpc.partner_id = p.id
        ORDER BY lpc.logistics_record_id, lpc.level DESC
    ),
    filtered_records AS (
        SELECT hlc.logistics_record_id
        FROM highest_level_costs hlc
        WHERE
            (p_filter_type = 'monthly_trend' AND to_char(hlc.loading_date, 'YYYY-MM') = p_filter_value) OR
            (p_filter_type = 'partner_ranking' AND hlc.partner_name = p_filter_value) OR
            (p_filter_type = 'project_contribution' AND hlc.project_name = p_filter_value) OR
            (p_filter_type = 'financial_status' AND (
                (p_filter_value = '待开票' AND (hlc.payment_status IS NULL OR hlc.payment_status NOT IN ('Unpaid', 'Processing'))) OR
                (p_filter_value = '待付款' AND hlc.payment_status = 'Unpaid') OR
                (p_filter_value = '已支付' AND hlc.payment_status = 'Processing')
            ))
    )
    SELECT INTO result json_build_object(
        'records', (
            SELECT json_agg(t) FROM (
                -- 【已修正】这里只选择您需要的11个字段
                SELECT
                    lr.id, lr.auto_number, lr.project_name, lr.driver_name, lr.license_plate,
                    lr.loading_location, lr.unloading_location, lr.loading_weight, lr.unloading_weight,
                    lr.transport_type, lr.payable_cost, lr.remarks
                FROM public.logistics_records lr
                WHERE lr.id IN (SELECT logistics_record_id FROM filtered_records)
                ORDER BY lr.loading_date DESC
                LIMIT p_page_size
                OFFSET (p_page_number - 1) * p_page_size
            ) t
        ),
        'total_count', (SELECT COUNT(*) FROM filtered_records)
    );
    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.get_distinct_drivers_for_project
CREATE OR REPLACE FUNCTION public.get_distinct_drivers_for_project(p_project_id uuid)
 RETURNS SETOF drivers
 LANGUAGE sql
 SET search_path TO 'public'
AS $function$
    SELECT DISTINCT d.* FROM public.drivers d JOIN public.logistics_records lr ON d.id = lr.driver_id WHERE lr.project_id = p_project_id;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.get_distinct_locations_for_project
CREATE OR REPLACE FUNCTION public.get_distinct_locations_for_project(p_project_id uuid)
 RETURNS SETOF text
 LANGUAGE sql
 SET search_path TO 'public'
AS $function$
    SELECT DISTINCT location FROM (SELECT loading_location AS location FROM public.logistics_records WHERE project_id = p_project_id AND loading_location IS NOT NULL UNION SELECT unloading_location AS location FROM public.logistics_records WHERE project_id = p_project_id AND unloading_location IS NOT NULL) AS all_locations ORDER BY location;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.get_drivers_for_project
CREATE OR REPLACE FUNCTION public.get_drivers_for_project(p_project_id uuid)
 RETURNS TABLE(id uuid, name text, license_plate text, phone text)
 LANGUAGE sql
 STABLE
 SET search_path TO 'public'
AS $function$
  SELECT 
    d.id, 
    d.name, 
    d.license_plate, 
    d.phone
  FROM public.drivers d
  JOIN public.driver_projects dp ON d.id = dp.driver_id
  WHERE dp.project_id = p_project_id;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- 函数: public.get_drivers_paginated
CREATE OR REPLACE FUNCTION public.get_drivers_paginated(p_page_number integer DEFAULT 1, p_page_size integer DEFAULT 30, p_search_text text DEFAULT ''::text)
 RETURNS TABLE(id uuid, name text, license_plate text, phone text, project_ids uuid[], id_card_photos jsonb, driver_license_photos jsonb, qualification_certificate_photos jsonb, driving_license_photos jsonb, transport_license_photos jsonb, created_at timestamp with time zone, total_records bigint)
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_offset integer;
    v_total_count bigint;
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;
    
    -- 获取总记录数（考虑RLS策略）
    SELECT COUNT(*) INTO v_total_count
    FROM public.drivers d
    WHERE p_search_text = '' OR p_search_text IS NULL OR (
        d.name ILIKE '%' || p_search_text || '%' OR
        d.license_plate ILIKE '%' || p_search_text || '%' OR
        d.phone ILIKE '%' || p_search_text || '%'
    );
    
    -- 返回分页数据，包含所有照片字段
    RETURN QUERY
    SELECT 
        d.id,
        d.name,
        d.license_plate,
        d.phone,
        COALESCE(
            ARRAY_AGG(dp.project_id) FILTER (WHERE dp.project_id IS NOT NULL),
            '{}'::uuid[]
        ) as project_ids,
        COALESCE(d.id_card_photos, '[]'::jsonb) as id_card_photos,
        COALESCE(d.driver_license_photos, '[]'::jsonb) as driver_license_photos,
        COALESCE(d.qualification_certificate_photos, '[]'::jsonb) as qualification_certificate_photos,
        COALESCE(d.driving_license_photos, '[]'::jsonb) as driving_license_photos,
        COALESCE(d.transport_license_photos, '[]'::jsonb) as transport_license_photos,
        d.created_at,
        v_total_count as total_records
    FROM public.drivers d
    LEFT JOIN public.driver_projects dp ON d.id = dp.driver_id
    WHERE p_search_text = '' OR p_search_text IS NULL OR (
        d.name ILIKE '%' || p_search_text || '%' OR
        d.license_plate ILIKE '%' || p_search_text || '%' OR
        d.phone ILIKE '%' || p_search_text || '%'
    )
    GROUP BY d.id, d.name, d.license_plate, d.phone, d.created_at, 
             d.id_card_photos, d.driver_license_photos, d.qualification_certificate_photos,
             d.driving_license_photos, d.transport_license_photos
    ORDER BY d.created_at DESC
    LIMIT p_page_size OFFSET v_offset;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_drivers_paginated_0827
CREATE OR REPLACE FUNCTION public.get_drivers_paginated_0827(p_filter text, p_page_size integer, p_page_number integer)
 RETURNS paginated_drivers_result
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$DECLARE
    v_offset integer;
    v_total_count integer;
    v_drivers json;
    v_filter_query text;
BEGIN
    -- 计算偏移量
    v_offset := (p_page_number - 1) * p_page_size;

    -- [修正] 构建动态WHERE子句，使用正确的 snake_case 列名
    v_filter_query := 'WHERE 
        name ILIKE ''%' || p_filter || '%'' OR 
        license_plate ILIKE ''%' || p_filter || '%'' OR 
        phone ILIKE ''%' || p_filter || '%''';

    -- 首先，计算满足筛选条件的总记录数
    EXECUTE 'SELECT count(*) FROM public.drivers ' || v_filter_query
    INTO v_total_count;

    -- [修正] 获取分页后的数据，SELECT 和 ORDER BY 都使用正确的 snake_case 列名
    EXECUTE '
        SELECT COALESCE(json_agg(t), ''[]''::json)
        FROM (
            SELECT 
                d.id,
                d.name,
                d.license_plate AS "licensePlate", -- 在这里使用 AS 为前端重命名
                d.phone,
                d.created_at AS "createdAt",     -- 在这里使用 AS 为前端重命名
                (
                    SELECT json_agg(dp.project_id)
                    FROM public.driver_projects dp
                    WHERE dp.driver_id = d.id
                ) as "projectIds" -- 在这里使用 AS 为前端重命名
            FROM public.drivers d '
            || v_filter_query ||
           'ORDER BY d.created_at DESC
            LIMIT ' || p_page_size || '
            OFFSET ' || v_offset || '
        ) t'
    INTO v_drivers;

    -- 返回包含数据和总数的复合类型结果
    RETURN (v_drivers, v_total_count)::public.paginated_drivers_result;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.get_filtered_logistics_records_fixed
CREATE OR REPLACE FUNCTION public.get_filtered_logistics_records_fixed(p_project_id uuid DEFAULT NULL::uuid, p_driver_id uuid DEFAULT NULL::uuid, p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_limit integer DEFAULT 1000, p_offset integer DEFAULT 0)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    v_result jsonb;
    v_start_date date;
    v_end_date date;
BEGIN
    -- Convert text dates to date type safely
    v_start_date := CASE 
        WHEN p_start_date IS NOT NULL AND p_start_date != '' 
        THEN p_start_date::date 
        ELSE NULL 
    END;
    
    v_end_date := CASE 
        WHEN p_end_date IS NOT NULL AND p_end_date != '' 
        THEN p_end_date::date 
        ELSE NULL 
    END;

    WITH filtered_records AS (
        SELECT 
            lr.id::text as id,
            lr.auto_number,
            lr.project_name,
            lr.driver_name,
            lr.loading_location,
            lr.unloading_location,
            lr.loading_date,
            lr.unloading_date,
            lr.loading_weight,
            lr.unloading_weight,
            lr.transport_type,
            lr.current_cost,
            lr.extra_cost,
            lr.payable_cost,
            lr.license_plate,
            lr.driver_phone,
            lr.remarks,
            COALESCE(lr.billing_type_id, 1) as billing_type_id,
            pc.chain_name
        FROM logistics_records lr
        LEFT JOIN partner_chains pc ON lr.chain_id = pc.id
        WHERE 
            (p_project_id IS NULL OR lr.project_id = p_project_id)
            AND (p_driver_id IS NULL OR lr.driver_id = p_driver_id)
            AND (v_start_date IS NULL OR lr.loading_date::date >= v_start_date)
            AND (v_end_date IS NULL OR lr.loading_date::date <= v_end_date)
        ORDER BY lr.loading_date DESC, lr.created_at DESC
    ),
    paginated_records AS (
        SELECT *
        FROM filtered_records
        LIMIT p_limit
        OFFSET p_offset
    ),
    total_count AS (
        SELECT COUNT(*) as count FROM filtered_records
    )
    SELECT jsonb_build_object(
        'records', COALESCE(jsonb_agg(pr.* ORDER BY pr.loading_date DESC, pr.auto_number DESC), '[]'::jsonb),
        'totalCount', (SELECT count FROM total_count)
    )
    INTO v_result
    FROM paginated_records pr, total_count;

    RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.get_filtered_logistics_records_v2
CREATE OR REPLACE FUNCTION public.get_filtered_logistics_records_v2(p_project_id uuid, p_driver_id uuid, p_start_date text, p_end_date text, p_limit integer, p_offset integer, p_billing_type_id integer)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    v_result jsonb;
    v_start_date date;
    v_end_date date;
BEGIN
    -- Convert text dates to date type safely
    v_start_date := CASE 
        WHEN p_start_date IS NOT NULL AND p_start_date != '' 
        THEN p_start_date::date 
        ELSE NULL 
    END;
    
    v_end_date := CASE 
        WHEN p_end_date IS NOT NULL AND p_end_date != '' 
        THEN p_end_date::date 
        ELSE NULL 
    END;

    WITH filtered_records AS (
        SELECT 
            lr.id,
            lr.auto_number,
            lr.project_id,
            lr.project_name,
            lr.chain_id,
            lr.driver_id,
            lr.driver_name,
            lr.loading_location,
            lr.unloading_location,
            lr.loading_date,
            lr.unloading_date,
            lr.loading_weight,
            lr.unloading_weight,
            lr.transport_type,
            lr.current_cost,
            lr.extra_cost,
            lr.driver_payable_cost, -- 修正：使用正确的字段名
            lr.license_plate,
            lr.driver_phone,
            lr.remarks,
            lr.created_at,
            COALESCE(lr.billing_type_id, 1) as billing_type_id,
            pc.chain_name
        FROM logistics_records lr
        LEFT JOIN partner_chains pc ON lr.chain_id = pc.id
        WHERE 
            (p_project_id IS NULL OR lr.project_id = p_project_id)
            AND (p_driver_id IS NULL OR lr.driver_id = p_driver_id)
            AND (v_start_date IS NULL OR lr.loading_date >= v_start_date)
            AND (v_end_date IS NULL OR lr.loading_date <= v_end_date)
            -- ★★★ 核心修改：增加对 billing_type_id 的筛选 ★★★
            AND (p_billing_type_id IS NULL OR lr.billing_type_id = p_billing_type_id)
        ORDER BY lr.loading_date DESC, lr.created_at DESC
    ),
    paginated_records AS (
        SELECT *
        FROM filtered_records
        LIMIT p_limit
        OFFSET p_offset
    ),
    total_count AS (
        SELECT COUNT(*) as count FROM filtered_records
    )
    SELECT jsonb_build_object(
        'records', COALESCE(jsonb_agg(pr.*), '[]'::jsonb),
        'totalCount', (SELECT count FROM total_count)
    )
    INTO v_result
    FROM paginated_records pr;

    RETURN COALESCE(v_result, '{"records": [], "totalCount": 0}'::jsonb);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.get_filtered_logistics_records_with_billing
CREATE OR REPLACE FUNCTION public.get_filtered_logistics_records_with_billing(p_project_id uuid DEFAULT NULL::uuid, p_driver_id uuid DEFAULT NULL::uuid, p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_limit integer DEFAULT 100, p_offset integer DEFAULT 0)
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
    total_count integer;
BEGIN
    -- 获取总数
    SELECT COUNT(*)
    INTO total_count
    FROM public.logistics_records lr
    LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
    WHERE 
        (p_project_id IS NULL OR lr.project_id = p_project_id)
        AND (p_driver_id IS NULL OR lr.driver_id = p_driver_id)
        AND (p_start_date IS NULL OR lr.loading_date::date >= p_start_date::date)
        AND (p_end_date IS NULL OR lr.loading_date::date <= p_end_date::date);

    -- 获取分页记录
    WITH paginated_records AS (
        SELECT 
            lr.*,
            pc.chain_name,
            COALESCE(pc.billing_type_id, 1) as billing_type_id
        FROM public.logistics_records lr
        LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
        WHERE 
            (p_project_id IS NULL OR lr.project_id = p_project_id)
            AND (p_driver_id IS NULL OR lr.driver_id = p_driver_id)
            AND (p_start_date IS NULL OR lr.loading_date::date >= p_start_date::date)
            AND (p_end_date IS NULL OR lr.loading_date::date <= p_end_date::date)
        ORDER BY lr.loading_date DESC, lr.created_at DESC
        LIMIT p_limit
        OFFSET p_offset
    )
    SELECT jsonb_build_object(
        'records', COALESCE(jsonb_agg(
            jsonb_build_object(
                'id', id,
                'auto_number', auto_number,
                'project_id', project_id,
                'project_name', project_name,
                'chain_id', chain_id,
                'loading_date', loading_date,
                'loading_location', loading_location,
                'unloading_location', unloading_location,
                'driver_id', driver_id,
                'driver_name', driver_name,
                'license_plate', license_plate,
                'driver_phone', driver_phone,
                'loading_weight', loading_weight,
                'unloading_date', unloading_date,
                'unloading_weight', unloading_weight,
                'transport_type', transport_type,
                'current_cost', current_cost,
                'extra_cost', extra_cost,
                'payable_cost', payable_cost,
                'remarks', remarks,
                'created_at', created_at,
                'created_by_user_id', created_by_user_id,
                'chain_name', chain_name,
                'billing_type_id', billing_type_id
            )
        ), '[]'::jsonb),
        'total_count', total_count
    )
    INTO result_json
    FROM paginated_records;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.get_filtered_logistics_with_billing
CREATE OR REPLACE FUNCTION public.get_filtered_logistics_with_billing(p_project_id uuid DEFAULT NULL::uuid, p_driver_name text DEFAULT NULL::text, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_limit integer DEFAULT 50, p_offset integer DEFAULT 0)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    v_result jsonb;
BEGIN
    WITH filtered_records AS (
        SELECT 
            lr.id,
            lr.auto_number,
            lr.project_name,
            lr.driver_name,
            lr.loading_location,
            lr.unloading_location,
            lr.loading_date,
            lr.unloading_date,
            lr.loading_weight,
            lr.unloading_weight,
            lr.transport_type,
            lr.current_cost,
            lr.extra_cost,
            lr.payable_cost,
            lr.license_plate,
            lr.driver_phone,
            lr.remarks,
            COALESCE(lr.billing_type_id, 1) as billing_type_id,
            pc.chain_name
        FROM logistics_records lr
        LEFT JOIN partner_chains pc ON lr.chain_id = pc.id
        WHERE 
            (p_project_id IS NULL OR lr.project_id = p_project_id)
            AND (p_driver_name IS NULL OR lr.driver_name ILIKE '%' || p_driver_name || '%')
            AND (p_start_date IS NULL OR lr.loading_date >= p_start_date)
            AND (p_end_date IS NULL OR lr.loading_date <= p_end_date)
        ORDER BY lr.loading_date DESC, lr.created_at DESC
    ),
    paginated_records AS (
        SELECT *
        FROM filtered_records
        LIMIT p_limit
        OFFSET p_offset
    ),
    total_count AS (
        SELECT COUNT(*) as count FROM filtered_records
    )
    SELECT jsonb_build_object(
        'records', COALESCE(jsonb_agg(pr.* ORDER BY pr.loading_date DESC, pr.auto_number DESC), '[]'::jsonb),
        'totalCount', (SELECT count FROM total_count)
    )
    INTO v_result
    FROM paginated_records pr, total_count;

    RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.get_filtered_payment_requests
CREATE OR REPLACE FUNCTION public.get_filtered_payment_requests(p_request_id text, p_project_id uuid, p_driver_query text, p_start_date timestamp with time zone, p_end_date timestamp with time zone, p_application_start_date timestamp with time zone, p_application_end_date timestamp with time zone, p_record_autonumbers text[])
 RETURNS SETOF payment_requests
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    SELECT *
    FROM public.payment_requests pr
    WHERE
        -- 申请单号筛选
        (p_request_id IS NULL OR p_request_id = '' OR pr.request_id ILIKE '%' || p_request_id || '%')
    AND
        -- 申请日期范围筛选
        (p_application_start_date IS NULL OR pr.created_at >= p_application_start_date)
    AND
        (p_application_end_date IS NULL OR pr.created_at <= p_application_end_date)
    AND
        -- 关联筛选逻辑
        (
            (p_project_id IS NULL AND p_driver_query IS NULL AND p_start_date IS NULL AND p_end_date IS NULL AND p_record_autonumbers IS NULL)
            OR
            pr.logistics_record_ids && ARRAY(
                SELECT lr.id
                FROM public.logistics_records lr
                WHERE
                    (p_project_id IS NULL OR lr.project_id = p_project_id)
                AND
                    -- 核心修改：多字段模糊搜索
                    (
                        p_driver_query IS NULL OR p_driver_query = '' OR
                        lr.driver_name ILIKE '%' || p_driver_query || '%' OR
                        lr.license_plate ILIKE '%' || p_driver_query || '%' OR
                        lr.driver_phone ILIKE '%' || p_driver_query || '%'
                    )
                AND
                    (p_start_date IS NULL OR lr.loading_date >= p_start_date)
                AND
                    (p_end_date IS NULL OR lr.loading_date <= p_end_date)
                AND
                    (p_record_autonumbers IS NULL OR lr.auto_number = ANY(p_record_autonumbers))
            )
        )
    ORDER BY pr.created_at DESC;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.get_filtered_payment_requests_0827
CREATE OR REPLACE FUNCTION public.get_filtered_payment_requests_0827(p_request_id text, p_project_id uuid, p_driver_name text, p_start_date timestamp with time zone, p_end_date timestamp with time zone)
 RETURNS SETOF payment_requests
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$BEGIN
    -- 使用 RETURN QUERY 来返回一个查询的结果集
    RETURN QUERY
    SELECT *
    FROM public.payment_requests pr
    WHERE
        -- 1. 按申请单号进行筛选 (如果不为空)
        (p_request_id IS NULL OR p_request_id = '' OR pr.request_id ILIKE '%' || p_request_id || '%')
    AND
        -- 2. 检查是否存在任何需要关联 logistics_records 的筛选条件
        (
            -- 如果所有关联筛选器都为 NULL，则此条件为真，不执行子查询
            (p_project_id IS NULL AND p_driver_name IS NULL AND p_start_date IS NULL AND p_end_date IS NULL)
            OR
            -- 否则，执行子查询并检查数组重叠
            pr.logistics_record_ids && ARRAY(
                SELECT lr.id
                FROM public.logistics_records lr
                WHERE
                    (p_project_id IS NULL OR lr.project_id = p_project_id)
                AND
                    (p_driver_name IS NULL OR lr.driver_name = p_driver_name)
                AND
                    (p_start_date IS NULL OR lr.loading_date >= p_start_date)
                AND
                    (p_end_date IS NULL OR lr.loading_date <= p_end_date)
            )
        )
    ORDER BY pr.created_at DESC;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.get_filtered_uninvoiced_partner_cost_ids
CREATE OR REPLACE FUNCTION public.get_filtered_uninvoiced_partner_cost_ids(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid)
 RETURNS uuid[]
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result_ids uuid[];
BEGIN
    SELECT array_agg(lpc.id)
    INTO result_ids
    FROM logistics_partner_costs lpc
    JOIN logistics_records lr ON lpc.logistics_record_id = lr.id
    WHERE
        lpc.invoice_status = 'Uninvoiced' AND
        (p_project_id IS NULL OR lr.project_id = p_project_id) AND
        (p_start_date IS NULL OR lr.loading_date >= p_start_date) AND
        (p_end_date IS NULL OR lr.loading_date <= p_end_date) AND
        (p_partner_id IS NULL OR lpc.partner_id = p_partner_id);

    RETURN COALESCE(result_ids, ARRAY[]::uuid[]);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.get_filtered_uninvoiced_record_ids
CREATE OR REPLACE FUNCTION public.get_filtered_uninvoiced_record_ids(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid)
 RETURNS text[]
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN ARRAY(
        SELECT r.id::text
        FROM logistics_records r
        WHERE
            (p_project_id IS NULL OR r.project_id = p_project_id) AND
            (p_start_date IS NULL OR r.loading_date >= p_start_date) AND
            (p_end_date IS NULL OR r.loading_date <= p_end_date) AND
            (p_partner_id IS NULL OR EXISTS (
                SELECT 1 FROM logistics_partner_costs lpc
                WHERE lpc.logistics_record_id = r.id AND lpc.partner_id = p_partner_id
            )) AND
            COALESCE(r.invoice_status, 'Uninvoiced') = 'Uninvoiced'
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.get_filtered_uninvoiced_record_ids
CREATE OR REPLACE FUNCTION public.get_filtered_uninvoiced_record_ids(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid, p_invoice_status_array text[] DEFAULT NULL::text[])
 RETURNS uuid[]
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result_ids uuid[];
BEGIN
    SELECT array_agg(v.id)
    INTO result_ids
    FROM public.logistics_records_view AS v
    JOIN public.logistics_records lr ON v.id = lr.id
    WHERE
        (p_project_id IS NULL OR v.project_id = p_project_id) AND
        (p_start_date IS NULL OR v.loading_date::date >= p_start_date) AND
        (p_end_date IS NULL OR v.loading_date::date <= p_end_date) AND
        (
            p_invoice_status_array IS NULL OR
            array_length(p_invoice_status_array, 1) IS NULL OR
            LOWER(COALESCE(lr.invoice_status, 'Uninvoiced')) = ANY(ARRAY(SELECT lower(unnest) FROM unnest(p_invoice_status_array)))
        ) AND
        (p_partner_id IS NULL OR EXISTS (
            SELECT 1 FROM public.logistics_partner_costs lpc
            WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
        ));

    RETURN COALESCE(result_ids, '{}'::uuid[]);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.get_filtered_unpaid_ids
CREATE OR REPLACE FUNCTION public.get_filtered_unpaid_ids(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid)
 RETURNS uuid[]
 LANGUAGE sql
 STABLE
 SET search_path TO 'public'
AS $function$
    -- 此查询的 WHERE 子句已根据您提供的 logistics_records_view 定义确认无误。
    SELECT array_agg(v.id)
    FROM public.logistics_records_view AS v
    -- JOIN 回基表以获取 payment_status，这是确保数据准确性的关键
    JOIN public.logistics_records lr ON v.id = lr.id
    WHERE
        -- 核心职责：强制只查找“未支付”的记录
        lr.payment_status = 'Unpaid'
        -- 以下筛选条件与您的主列表逻辑完全一致
        AND (p_project_id IS NULL OR v.project_id = p_project_id)
        AND (p_start_date IS NULL OR v.loading_date::date >= p_start_date)
        AND (p_end_date IS NULL OR v.loading_date::date <= p_end_date)
        AND (p_partner_id IS NULL OR EXISTS (
            SELECT 1 FROM public.logistics_partner_costs lpc
            WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
        ));
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- 函数: public.get_finance_reconciliation_by_partner
CREATE OR REPLACE FUNCTION public.get_finance_reconciliation_by_partner(p_project_id uuid, p_start_date text, p_end_date text, p_partner_id uuid, p_page_number integer, p_page_size integer)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
-- [最终修正版] 修正函数语言为 plpgsql，并优化 partner_payables 的排序逻辑
DECLARE
  v_offset INTEGER;
  v_result JSONB;
BEGIN
  v_offset := (p_page_number - 1) * p_page_size;

  WITH filtered_logistics AS (
    SELECT 
      lr.id,
      lr.auto_number,
      lr.project_name,
      lr.driver_name,
      lr.loading_location,
      lr.unloading_location,
      lr.loading_date,
      lr.unloading_date,
      lr.loading_weight,
      lr.unloading_weight,
      lr.current_cost,
      lr.extra_cost,
      lr.payable_cost,
      lr.billing_type_id
    FROM logistics_records lr
    WHERE 
      (p_project_id IS NULL OR lr.project_id = p_project_id) AND
      (p_start_date IS NULL OR lr.loading_date >= p_start_date::date) AND
      (p_end_date IS NULL OR lr.loading_date <= p_end_date::date) AND
      (p_partner_id IS NULL OR EXISTS (
        SELECT 1 FROM logistics_partner_costs lpc
        WHERE lpc.logistics_record_id = lr.id AND lpc.partner_id = p_partner_id
      ))
  ),
  paginated_records AS (
    SELECT *
    FROM filtered_logistics
    ORDER BY loading_date DESC, auto_number DESC
    LIMIT p_page_size
    OFFSET v_offset
  ),
  total_count AS (
    SELECT COUNT(*) as count FROM filtered_logistics
  ),
  overview_stats AS (
    SELECT 
      COUNT(*) as total_records,
      COALESCE(SUM(current_cost), 0) as total_current_cost,
      COALESCE(SUM(extra_cost), 0) as total_extra_cost,
      COALESCE(SUM(payable_cost), 0) as total_payable_cost
    FROM filtered_logistics
  ),
  partner_summary_data AS (
    SELECT 
      lpc.partner_id,
      p.name as partner_name,
      MIN(lpc.level) as level,
      SUM(lpc.payable_amount) as total_payable,
      COUNT(DISTINCT lpc.logistics_record_id) as records_count
    FROM filtered_logistics fl
    JOIN logistics_partner_costs lpc ON fl.id = lpc.logistics_record_id
    JOIN partners p ON lpc.partner_id = p.id
    GROUP BY lpc.partner_id, p.name
  ),
  records_with_partners AS (
    SELECT 
      pr.*,
      COALESCE(
        (SELECT jsonb_agg(
          jsonb_build_object(
            'partner_id', lpc.partner_id,
            'partner_name', p.name,
            'level', lpc.level,
            'payable_amount', lpc.payable_amount
          ) ORDER BY lpc.level
        )
        FROM logistics_partner_costs lpc
        JOIN partners p ON lpc.partner_id = p.id
        WHERE lpc.logistics_record_id = pr.id),
        '[]'::jsonb
      ) as partner_costs
    FROM paginated_records pr
  )
  SELECT jsonb_build_object(
    'records', COALESCE((
      SELECT jsonb_agg(
        jsonb_build_object(
          'id', rwp.id,
          'auto_number', rwp.auto_number,
          'project_name', rwp.project_name,
          'driver_name', rwp.driver_name,
          'loading_location', rwp.loading_location,
          'unloading_location', rwp.unloading_location,
          'loading_date', TO_CHAR(rwp.loading_date, 'YYYY-MM-DD'),
          'unloading_date', CASE WHEN rwp.unloading_date IS NOT NULL THEN TO_CHAR(rwp.unloading_date, 'YYYY-MM-DD') ELSE NULL END,
          'loading_weight', rwp.loading_weight,
          'unloading_weight', rwp.unloading_weight,
          'current_cost', rwp.current_cost,
          'extra_cost', rwp.extra_cost,
          'payable_cost', rwp.payable_cost,
          'billing_type_id', rwp.billing_type_id,
          'partner_costs', rwp.partner_costs
        ) ORDER BY rwp.loading_date DESC, rwp.auto_number DESC
      )
      FROM records_with_partners rwp
    ), '[]'::jsonb),
    'count', (SELECT count FROM total_count),
    'total_pages', CASE 
      WHEN (SELECT count FROM total_count) = 0 THEN 1 
      ELSE CEIL((SELECT count FROM total_count)::float / p_page_size::float)::integer 
    END,
    'overview', (
      SELECT jsonb_build_object(
        'total_records', os.total_records,
        'total_current_cost', os.total_current_cost,
        'total_extra_cost', os.total_extra_cost,
        'total_payable_cost', os.total_payable_cost
      )
      FROM overview_stats os
    ),
    'partner_payables', COALESCE((
      SELECT jsonb_agg(
        jsonb_build_object(
          'partner_id', psd.partner_id,
          'partner_name', psd.partner_name,
          'level', psd.level,
          'total_payable', psd.total_payable,
          'records_count', psd.records_count
        ) ORDER BY psd.level DESC, psd.total_payable DESC
      )
      FROM partner_summary_data psd
    ), '[]'::jsonb)
  )
  INTO v_result;

  RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- 函数: public.get_finance_reconciliation_by_partner_old
CREATE OR REPLACE FUNCTION public.get_finance_reconciliation_by_partner_old(p_project_id uuid DEFAULT NULL::uuid, p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_partner_id uuid DEFAULT NULL::uuid, p_page_number integer DEFAULT 1, p_page_size integer DEFAULT 50)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$DECLARE
  v_offset INTEGER;
  v_result JSONB;
BEGIN
  v_offset := (p_page_number - 1) * p_page_size;

  WITH filtered_logistics AS (
    SELECT 
      lr.id,
      lr.auto_number,
      lr.project_name,
      lr.driver_name,
      lr.loading_location,
      lr.unloading_location,
      lr.loading_date,
      lr.unloading_date,
      lr.loading_weight,
      lr.unloading_weight,
      lr.current_cost,
      lr.extra_cost,
      lr.payable_cost,
      lr.billing_type_id
    FROM logistics_records lr
    WHERE 
      (p_project_id IS NULL OR lr.project_id = p_project_id) AND
      (p_start_date IS NULL OR lr.loading_date >= p_start_date::date) AND
      (p_end_date IS NULL OR lr.loading_date <= p_end_date::date) AND
      (p_partner_id IS NULL OR EXISTS (
        SELECT 1 FROM logistics_partner_costs lpc
        WHERE lpc.logistics_record_id = lr.id AND lpc.partner_id = p_partner_id
      ))
  ),
  paginated_records AS (
    SELECT *
    FROM filtered_logistics
    ORDER BY loading_date DESC, auto_number DESC
    LIMIT p_page_size
    OFFSET v_offset
  ),
  total_count AS (
    SELECT COUNT(*) as count FROM filtered_logistics
  ),
  overview_stats AS (
    SELECT 
      COUNT(*) as total_records,
      COALESCE(SUM(current_cost), 0) as total_current_cost,
      COALESCE(SUM(extra_cost), 0) as total_extra_cost,
      COALESCE(SUM(payable_cost), 0) as total_payable_cost
    FROM filtered_logistics
  ),
  partner_summary_data AS (
    SELECT 
      lpc.partner_id,
      p.name as partner_name,
      MIN(lpc.level) as level,
      SUM(lpc.payable_amount) as total_payable,
      COUNT(DISTINCT lpc.logistics_record_id) as records_count
    FROM filtered_logistics fl
    JOIN logistics_partner_costs lpc ON fl.id = lpc.logistics_record_id
    JOIN partners p ON lpc.partner_id = p.id
    GROUP BY lpc.partner_id, p.name
  ),
  records_with_partners AS (
    SELECT 
      pr.*,
      COALESCE(
        (SELECT jsonb_agg(
          jsonb_build_object(
            'partner_id', lpc.partner_id,
            'partner_name', p.name,
            'level', lpc.level,
            'payable_amount', lpc.payable_amount
          ) ORDER BY lpc.level
        )
        FROM logistics_partner_costs lpc
        JOIN partners p ON lpc.partner_id = p.id
        WHERE lpc.logistics_record_id = pr.id),
        '[]'::jsonb
      ) as partner_costs
    FROM paginated_records pr
  )
  SELECT jsonb_build_object(
    'records', COALESCE((
      SELECT jsonb_agg(
        jsonb_build_object(
          'id', rwp.id,
          'auto_number', rwp.auto_number,
          'project_name', rwp.project_name,
          'driver_name', rwp.driver_name,
          'loading_location', rwp.loading_location,
          'unloading_location', rwp.unloading_location,
          'loading_date', TO_CHAR(rwp.loading_date, 'YYYY-MM-DD'),
          'unloading_date', CASE WHEN rwp.unloading_date IS NOT NULL THEN TO_CHAR(rwp.unloading_date, 'YYYY-MM-DD') ELSE NULL END,
          'loading_weight', rwp.loading_weight,
          'unloading_weight', rwp.unloading_weight,
          'current_cost', rwp.current_cost,
          'extra_cost', rwp.extra_cost,
          'payable_cost', rwp.payable_cost,
          'billing_type_id', rwp.billing_type_id,
          'partner_costs', rwp.partner_costs
        ) ORDER BY rwp.loading_date DESC, rwp.auto_number DESC
      )
      FROM records_with_partners rwp
    ), '[]'::jsonb),
    'count', (SELECT count FROM total_count),
    'total_pages', CASE 
      WHEN (SELECT count FROM total_count) = 0 THEN 1 
      ELSE CEIL((SELECT count FROM total_count)::float / p_page_size::float)::integer 
    END,
    'overview', (
      SELECT jsonb_build_object(
        'total_records', os.total_records,
        'total_current_cost', os.total_current_cost,
        'total_extra_cost', os.total_extra_cost,
        'total_payable_cost', os.total_payable_cost
      )
      FROM overview_stats os
    ),
    'partner_payables', COALESCE((
      SELECT jsonb_agg(
        jsonb_build_object(
          'partner_id', psd.partner_id,
          'partner_name', psd.partner_name,
          'level', psd.level,
          'total_payable', psd.total_payable,
          'records_count', psd.records_count
        ) ORDER BY psd.partner_name
      )
      FROM partner_summary_data psd
    ), '[]'::jsonb)
  )
  INTO v_result;

  RETURN v_result;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- 函数: public.get_finance_reconciliation_data
CREATE OR REPLACE FUNCTION public.get_finance_reconciliation_data(p_project_id uuid DEFAULT NULL::uuid, p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_partner_id uuid DEFAULT NULL::uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
    filtered_record_ids uuid[];
BEGIN
    -- 找出所有符合条件的运单ID，明确指定表别名
    SELECT ARRAY_AGG(lr.id)
    INTO filtered_record_ids
    FROM public.logistics_records lr
    LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
    WHERE
        (p_project_id IS NULL OR lr.project_id = p_project_id) AND
        (p_start_date IS NULL OR lr.loading_date::date >= p_start_date::date) AND
        (p_end_date IS NULL OR lr.loading_date::date <= p_end_date::date) AND
        (p_partner_id IS NULL OR EXISTS (
            SELECT 1 FROM public.logistics_partner_costs lpc
            WHERE lpc.logistics_record_id = lr.id AND lpc.partner_id = p_partner_id
        ));

    -- 构建包含所有结果的单一JSON对象
    SELECT jsonb_build_object(
        'overview', (
            SELECT jsonb_build_object(
                'total_records', COALESCE(COUNT(*), 0),
                'total_current_cost', COALESCE(SUM(current_cost), 0),
                'total_extra_cost', COALESCE(SUM(extra_cost), 0),
                'total_payable_cost', COALESCE(SUM(payable_cost), 0)
            )
            FROM public.logistics_records
            WHERE id = ANY(COALESCE(filtered_record_ids, '{}'))
        ),
        'partner_payables', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.partner_name), '[]'::jsonb) FROM (
                SELECT
                    lpc.partner_id, p.name AS partner_name,
                    COUNT(lpc.logistics_record_id) AS records_count,
                    SUM(lpc.payable_amount) AS total_payable
                FROM public.logistics_partner_costs lpc
                JOIN public.partners p ON lpc.partner_id = p.id
                WHERE lpc.logistics_record_id = ANY(COALESCE(filtered_record_ids, '{}'))
                GROUP BY lpc.partner_id, p.name
            ) t
        ),
        'records', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.loading_date DESC), '[]'::jsonb) FROM (
                SELECT
                    lr.id, lr.auto_number, lr.project_name, lr.driver_name, 
                    lr.loading_location, lr.unloading_location,
                    to_char(lr.loading_date, 'YYYY-MM-DD') AS loading_date,
                    to_char(lr.unloading_date, 'YYYY-MM-DD') AS unloading_date,
                    lr.loading_weight, lr.unloading_weight, lr.current_cost, 
                    lr.payable_cost, lr.extra_cost, lr.license_plate, 
                    lr.driver_phone, lr.transport_type, lr.remarks,
                    lr.billing_type_id, -- 明确指定来自lr表
                    pc.chain_name,
                    (SELECT COALESCE(jsonb_agg(sub ORDER BY sub.level), '[]'::jsonb) FROM (
                        SELECT lpc.partner_id, par.name AS partner_name, lpc.level, lpc.payable_amount
                        FROM public.logistics_partner_costs lpc
                        JOIN public.partners par ON lpc.partner_id = par.id
                        WHERE lpc.logistics_record_id = lr.id
                     ) sub
                    ) AS partner_costs
                FROM public.logistics_records lr
                LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
                WHERE lr.id = ANY(COALESCE(filtered_record_ids, '{}'))
            ) t
        ),
        'count', COALESCE(array_length(filtered_record_ids, 1), 0)
    )
    INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.get_finance_reconciliation_data2
CREATE OR REPLACE FUNCTION public.get_finance_reconciliation_data2(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid, p_payment_status_array text[] DEFAULT NULL::text[], p_page_size integer DEFAULT 50, p_page_number integer DEFAULT 1)
 RETURNS json
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$DECLARE
    result_json json;
    v_offset integer;
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;

    WITH filtered_records AS (
        SELECT r.*
        FROM logistics_records r
        LEFT JOIN project_partner_chains ppc ON r.chain_id = ppc.id
        WHERE
            (p_project_id IS NULL OR r.project_id = p_project_id) AND
            (p_start_date IS NULL OR r.loading_date >= p_start_date) AND
            (p_end_date IS NULL OR r.loading_date <= p_end_date) AND
            (p_partner_id IS NULL OR EXISTS (
                SELECT 1 FROM jsonb_to_populate_recordset(null::partner_cost_type, r.partner_costs) AS pc
                WHERE pc.partner_id = p_partner_id::text
            )) AND
            -- 核心修复：确保函数能处理 text[] 类型的数组参数
            (p_payment_status_array IS NULL OR array_length(p_payment_status_array, 1) IS NULL OR r.payment_status = ANY(p_payment_status_array))
    ),
    total_count AS (
        SELECT count(*) as count FROM filtered_records
    )
    SELECT json_build_object(
        'count', (SELECT count FROM total_count),
        'records', COALESCE((
            SELECT json_agg(
                json_build_object(
                    'id', fr.id,
                    'auto_number', fr.auto_number,
                    'project_name', p.name,
                    'driver_id', fr.driver_id,
                    'driver_name', d.name,
                    'loading_location', fr.loading_location,
                    'unloading_location', fr.unloading_location,
                    'loading_date', fr.loading_date,
                    'unloading_date', fr.unloading_date,
                    'license_plate', d.license_plate,
                    'driver_phone', d.phone,
                    'payable_cost', fr.payable_cost,
                    'partner_costs', fr.partner_costs,
                    'payment_status', fr.payment_status,
                    'current_cost', fr.current_cost,
                    'extra_cost', fr.extra_cost,
                    'chain_name', ppc.name
                )
            )
            FROM (
                SELECT * FROM filtered_records
                ORDER BY loading_date DESC, auto_number DESC
                LIMIT p_page_size OFFSET v_offset
            ) fr
            JOIN projects p ON fr.project_id = p.id
            JOIN drivers d ON fr.driver_id = d.id
            LEFT JOIN project_partner_chains ppc ON fr.chain_id = ppc.id
        ), '[]'::json),
        'overview', (
            SELECT json_build_object(
                'total_records', count(*),
                'total_current_cost', COALESCE(sum(current_cost), 0),
                'total_extra_cost', COALESCE(sum(extra_cost), 0),
                'total_payable_cost', COALESCE(sum(payable_cost), 0)
            ) FROM filtered_records
        ),
        'partner_payables', COALESCE((
            SELECT json_agg(t) FROM (
                SELECT
                    pc.partner_id,
                    pc.partner_name,
                    count(*) as records_count,
                    sum(pc.payable_amount) as total_payable
                FROM filtered_records,
                LATERAL jsonb_to_populate_recordset(null::partner_cost_type, partner_costs) AS pc
                GROUP BY pc.partner_id, pc.partner_name
                ORDER BY sum(pc.payable_amount) DESC
            ) t
        ), '[]'::json)
    ) INTO result_json;

    RETURN result_json;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.get_finance_reconciliation_data_optimized
CREATE OR REPLACE FUNCTION public.get_finance_reconciliation_data_optimized(p_project_id uuid DEFAULT NULL::uuid, p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_partner_id uuid DEFAULT NULL::uuid, p_page_number integer DEFAULT 1, p_page_size integer DEFAULT 50)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
  v_offset INTEGER;
  v_result JSONB;
BEGIN
  v_offset := (p_page_number - 1) * p_page_size;

  WITH filtered_logistics AS (
    SELECT 
      lr.id,
      lr.auto_number,
      lr.project_name,
      lr.driver_name,
      lr.loading_location,
      lr.unloading_location,
      lr.loading_date,
      lr.unloading_date,
      lr.loading_weight,
      lr.unloading_weight,
      lr.current_cost,
      lr.extra_cost,
      lr.payable_cost,
      lr.billing_type_id
    FROM logistics_records lr
    WHERE 
      (p_project_id IS NULL OR lr.project_id = p_project_id) AND
      (p_start_date IS NULL OR lr.loading_date >= p_start_date::date) AND
      (p_end_date IS NULL OR lr.loading_date <= p_end_date::date) AND
      (p_partner_id IS NULL OR EXISTS (
        SELECT 1 FROM logistics_partner_costs lpc
        WHERE lpc.logistics_record_id = lr.id AND lpc.partner_id = p_partner_id
      ))
  ),
  paginated_records AS (
    SELECT *
    FROM filtered_logistics
    ORDER BY loading_date DESC, auto_number DESC
    LIMIT p_page_size
    OFFSET v_offset
  ),
  total_count AS (
    SELECT COUNT(*) as count FROM filtered_logistics
  ),
  overview_stats AS (
    SELECT 
      COUNT(*) as total_records,
      COALESCE(SUM(current_cost), 0) as total_current_cost,
      COALESCE(SUM(extra_cost), 0) as total_extra_cost,
      COALESCE(SUM(payable_cost), 0) as total_payable_cost
    FROM filtered_logistics
  ),
  partner_summary_data AS (
    SELECT 
      lpc.partner_id,
      p.name as partner_name,
      lpc.level,
      SUM(lpc.payable_amount) as total_payable,
      COUNT(DISTINCT lpc.logistics_record_id) as records_count
    FROM filtered_logistics fl
    JOIN logistics_partner_costs lpc ON fl.id = lpc.logistics_record_id
    JOIN partners p ON lpc.partner_id = p.id
    GROUP BY lpc.partner_id, p.name, lpc.level
  ),
  records_with_partners AS (
    SELECT 
      pr.*,
      COALESCE(
        (SELECT jsonb_agg(
          jsonb_build_object(
            'partner_id', lpc.partner_id,
            'partner_name', p.name,
            'level', lpc.level,
            'payable_amount', lpc.payable_amount
          ) ORDER BY lpc.level
        )
        FROM logistics_partner_costs lpc
        JOIN partners p ON lpc.partner_id = p.id
        WHERE lpc.logistics_record_id = pr.id),
        '[]'::jsonb
      ) as partner_costs
    FROM paginated_records pr
  )
  SELECT jsonb_build_object(
    'records', COALESCE((
      SELECT jsonb_agg(
        jsonb_build_object(
          'id', rwp.id,
          'auto_number', rwp.auto_number,
          'project_name', rwp.project_name,
          'driver_name', rwp.driver_name,
          'loading_location', rwp.loading_location,
          'unloading_location', rwp.unloading_location,
          'loading_date', TO_CHAR(rwp.loading_date, 'YYYY-MM-DD'),
          'unloading_date', CASE WHEN rwp.unloading_date IS NOT NULL THEN TO_CHAR(rwp.unloading_date, 'YYYY-MM-DD') ELSE NULL END,
          'loading_weight', rwp.loading_weight,
          'unloading_weight', rwp.unloading_weight,
          'current_cost', rwp.current_cost,
          'extra_cost', rwp.extra_cost,
          'payable_cost', rwp.payable_cost,
          'billing_type_id', rwp.billing_type_id,
          'partner_costs', rwp.partner_costs
        ) ORDER BY rwp.loading_date DESC, rwp.auto_number DESC
      )
      FROM records_with_partners rwp
    ), '[]'::jsonb),
    'count', (SELECT count FROM total_count),
    'total_pages', CASE 
      WHEN (SELECT count FROM total_count) = 0 THEN 1 
      ELSE CEIL((SELECT count FROM total_count)::float / p_page_size::float)::integer 
    END,
    'overview', (
      SELECT jsonb_build_object(
        'total_records', os.total_records,
        'total_current_cost', os.total_current_cost,
        'total_extra_cost', os.total_extra_cost,
        'total_payable_cost', os.total_payable_cost
      )
      FROM overview_stats os
    ),
    'partner_payables', COALESCE((
      SELECT jsonb_agg(
        jsonb_build_object(
          'partner_id', psd.partner_id,
          'partner_name', psd.partner_name,
          'level', psd.level,
          'total_payable', psd.total_payable,
          'records_count', psd.records_count
        ) ORDER BY psd.level
      )
      FROM partner_summary_data psd
    ), '[]'::jsonb)
  )
  INTO v_result;

  RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.get_finance_reconciliation_data_paginated
CREATE OR REPLACE FUNCTION public.get_finance_reconciliation_data_paginated(p_project_id uuid DEFAULT NULL::uuid, p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_partner_id uuid DEFAULT NULL::uuid, p_page_number integer DEFAULT 1, p_page_size integer DEFAULT 50)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
    v_offset integer;
    total_count integer;
    filtered_record_ids uuid[];
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;
    
    -- 1. 首先获取过滤后的总记录数和ID列表（用于概览统计）
    WITH filtered_base AS (
        SELECT lr.id
        FROM logistics_records lr
        LEFT JOIN partner_chains pc ON lr.chain_id = pc.id
        WHERE
            (p_project_id IS NULL OR lr.project_id = p_project_id) AND
            (p_start_date IS NULL OR lr.loading_date::date >= p_start_date::date) AND
            (p_end_date IS NULL OR lr.loading_date::date <= p_end_date::date) AND
            (p_partner_id IS NULL OR EXISTS (
                SELECT 1 FROM logistics_partner_costs lpc
                WHERE lpc.logistics_record_id = lr.id AND lpc.partner_id = p_partner_id
            ))
    )
    SELECT 
        COUNT(*),
        ARRAY_AGG(id)
    INTO total_count, filtered_record_ids
    FROM filtered_base;

    -- 2. 构建分页结果
    SELECT jsonb_build_object(
        'overview', (
            SELECT jsonb_build_object(
                'total_records', COALESCE(total_count, 0),
                'total_current_cost', COALESCE(SUM(current_cost), 0),
                'total_extra_cost', COALESCE(SUM(extra_cost), 0),
                'total_payable_cost', COALESCE(SUM(payable_cost), 0)
            )
            FROM logistics_records
            WHERE id = ANY(COALESCE(filtered_record_ids, '{}'))
        ),
        'partner_payables', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.partner_name), '[]'::jsonb) FROM (
                SELECT
                    lpc.partner_id, p.name AS partner_name,
                    COUNT(lpc.logistics_record_id) AS records_count,
                    SUM(lpc.payable_amount) AS total_payable
                FROM logistics_partner_costs lpc
                JOIN partners p ON lpc.partner_id = p.id
                WHERE lpc.logistics_record_id = ANY(COALESCE(filtered_record_ids, '{}'))
                GROUP BY lpc.partner_id, p.name
            ) t
        ),
        'records', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.loading_date DESC), '[]'::jsonb) FROM (
                SELECT
                    lr.id, lr.auto_number, lr.project_name, lr.driver_name, 
                    lr.loading_location, lr.unloading_location,
                    to_char(lr.loading_date, 'YYYY-MM-DD') AS loading_date,
                    to_char(lr.unloading_date, 'YYYY-MM-DD') AS unloading_date,
                    lr.loading_weight, lr.unloading_weight, lr.current_cost, 
                    lr.payable_cost, lr.extra_cost, lr.license_plate, 
                    lr.driver_phone, lr.transport_type, lr.remarks,
                    lr.billing_type_id,
                    pc.chain_name,
                    (SELECT COALESCE(jsonb_agg(sub ORDER BY sub.level), '[]'::jsonb) FROM (
                        SELECT lpc.partner_id, par.name AS partner_name, lpc.level, lpc.payable_amount
                        FROM logistics_partner_costs lpc
                        JOIN partners par ON lpc.partner_id = par.id
                        WHERE lpc.logistics_record_id = lr.id
                     ) sub
                    ) AS partner_costs
                FROM logistics_records lr
                LEFT JOIN partner_chains pc ON lr.chain_id = pc.id
                WHERE lr.id = ANY(COALESCE(filtered_record_ids, '{}'))
                ORDER BY lr.loading_date DESC
                LIMIT p_page_size
                OFFSET v_offset
            ) t
        ),
        'count', COALESCE(total_count, 0),
        'total_pages', CASE 
            WHEN total_count = 0 THEN 1 
            ELSE CEIL(total_count::float / p_page_size::float)::integer 
        END,
        'current_page', p_page_number
    )
    INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.get_financial_overview
CREATE OR REPLACE FUNCTION public.get_financial_overview()
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN (
        -- 步骤1：定义所有需要用到的 CTE (临时表)
        WITH 
        -- CTE 1: 基础数据源，包含每个运单的最高级合作方成本
        highest_level_costs AS (
            SELECT
                DISTINCT ON (lpc.logistics_record_id)
                lpc.logistics_record_id,
                lr.loading_date,
                lr.payment_status,
                lr.project_name,
                COALESCE(p.name, '未知合作方') AS partner_name,
                lpc.payable_amount
            FROM
                public.logistics_partner_costs lpc
            JOIN
                public.logistics_records lr ON lpc.logistics_record_id = lr.id
            LEFT JOIN
                public.partners p ON lpc.partner_id = p.id
            ORDER BY
                lpc.logistics_record_id,
                lpc.level DESC -- level 越大，级别越高
        ),
        -- CTE 2: 卡片指标的聚合结果
        stats_agg AS (
            SELECT json_build_object(
                'totalReceivables', COALESCE(SUM(payable_amount), 0),
                'monthlyReceivables', COALESCE(SUM(CASE WHEN loading_date >= date_trunc('month', NOW()) AND loading_date < date_trunc('month', NOW()) + interval '1 month' THEN payable_amount ELSE 0 END), 0),
                'pendingPayment', COALESCE(SUM(CASE WHEN payment_status = 'Unpaid' THEN payable_amount ELSE 0 END), 0),
                'pendingInvoice', COALESCE(SUM(CASE WHEN payment_status IS NULL OR payment_status NOT IN ('Unpaid', 'Processing') THEN payable_amount ELSE 0 END), 0)
            ) AS stats 
            FROM highest_level_costs
        ),
        -- CTE 3: 月度趋势图的聚合结果
        monthly_trend_agg AS (
            SELECT json_agg(t) AS monthly_trend FROM (
                WITH months AS (SELECT date_trunc('month', generate_series(NOW() - interval '11 months', NOW(), '1 month'))::date AS month_date),
                monthly_data AS (SELECT date_trunc('month', loading_date)::date as month, SUM(payable_amount) as total FROM highest_level_costs WHERE loading_date >= date_trunc('month', NOW() - interval '11 months') GROUP BY 1)
                SELECT to_char(m.month_date, 'YYYY-MM') AS month_start, COALESCE(md.total, 0) AS total_receivables FROM months m LEFT JOIN monthly_data md ON m.month_date = md.month ORDER BY m.month_date
            ) t
        ),
        -- CTE 4: 合作方排名图的聚合结果
        partner_ranking_agg AS (
            SELECT json_agg(t) AS partner_ranking FROM (
                SELECT partner_name, SUM(payable_amount) AS total_payable FROM highest_level_costs GROUP BY partner_name HAVING SUM(payable_amount) > 0 ORDER BY total_payable DESC LIMIT 10
            ) t
        ),
        -- CTE 5: 项目贡献度图的聚合结果
        project_contribution_agg AS (
            SELECT json_agg(t) AS project_contribution FROM (
                SELECT project_name, SUM(payable_amount) AS total_receivables FROM highest_level_costs WHERE project_name IS NOT NULL GROUP BY project_name HAVING SUM(payable_amount) > 0 ORDER BY total_receivables DESC
            ) t
        )
        -- 步骤2：在一个SELECT语句中将所有聚合结果组合成最终的JSON对象
        SELECT json_build_object(
            'stats', stats_agg.stats,
            'monthlyTrend', monthly_trend_agg.monthly_trend,
            'partnerRanking', partner_ranking_agg.partner_ranking,
            'projectContribution', project_contribution_agg.project_contribution
        )
        FROM
            stats_agg,
            monthly_trend_agg,
            partner_ranking_agg,
            project_contribution_agg
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.get_import_templates
CREATE OR REPLACE FUNCTION public.get_import_templates(p_platform_type character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id uuid, name character varying, description text, platform_type character varying, template_config jsonb, field_mappings jsonb, is_active boolean, is_system boolean, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    it.id,
    it.name,
    it.description,
    it.platform_type,
    it.template_config,
    it.field_mappings,
    it.is_active,
    it.is_system,
    it.created_at
  FROM public.import_templates it
  WHERE it.is_active = true
    AND (p_platform_type IS NULL OR it.platform_type = p_platform_type)
  ORDER BY it.is_system DESC, it.created_at DESC;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- 函数: public.get_invoice_data_by_record_ids
CREATE OR REPLACE FUNCTION public.get_invoice_data_by_record_ids(p_record_ids uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
    v_can_view boolean := public.is_finance_or_admin();
BEGIN
    SELECT jsonb_build_object(
        'records', COALESCE(jsonb_agg(
            jsonb_build_object(
                'id', v.id,
                'auto_number', v.auto_number,
                'project_name', v.project_name,
                'driver_name', v.driver_name,
                'loading_location', v.loading_location,
                'unloading_location', v.unloading_location,
                'loading_date', to_char(v.loading_date, 'YYYY-MM-DD'),
                'unloading_date', COALESCE(to_char(v.unloading_date, 'YYYY-MM-DD'), null),
                'loading_weight', v.loading_weight,
                'unloading_weight', v.unloading_weight,
                'current_cost', v.current_cost,
                'extra_cost', v.extra_cost,
                'payable_cost', v.payable_cost,
                'license_plate', v.license_plate,
                'driver_phone', v.driver_phone,
                'transport_type', v.transport_type,
                'remarks', v.remarks,
                'chain_name', v.chain_name,
                'cargo_type', lr.cargo_type,
                'invoice_status', COALESCE(lr.invoice_status, 'Uninvoiced'),
                'partner_costs', (
                    SELECT COALESCE(jsonb_agg(
                        jsonb_build_object(
                            'partner_id', lpc.partner_id,
                            'partner_name', p.name,
                            'level', lpc.level,
                            'payable_amount', lpc.payable_amount,
                            'full_name', CASE WHEN v_can_view THEN p.full_name ELSE NULL END
                        ) ORDER BY lpc.level
                    ), '[]'::jsonb)
                    FROM public.logistics_partner_costs lpc
                    JOIN public.partners p ON lpc.partner_id = p.id
                    WHERE lpc.logistics_record_id = v.id
                )
            ) ORDER BY v.loading_date DESC
        ), '[]'::jsonb)
    )
    INTO result_json
    FROM public.logistics_records_view v
    JOIN public.logistics_records lr ON v.id = lr.id
    WHERE v.id = ANY(p_record_ids);

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.get_invoice_request_data
CREATE OR REPLACE FUNCTION public.get_invoice_request_data(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid, p_invoice_status_array text[] DEFAULT NULL::text[], p_page_size integer DEFAULT 50, p_page_number integer DEFAULT 1)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json json;
    v_offset integer;
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;

    WITH filtered_records AS (
        SELECT v.*, lr.invoice_status
        FROM public.logistics_records_view AS v
        JOIN public.logistics_records lr ON v.id = lr.id
        WHERE
            (p_project_id IS NULL OR v.project_id = p_project_id) AND
            (p_start_date IS NULL OR v.loading_date::date >= p_start_date) AND
            (p_end_date IS NULL OR v.loading_date::date <= p_end_date) AND
            (p_invoice_status_array IS NULL OR lr.invoice_status = ANY(p_invoice_status_array)) AND
            (p_partner_id IS NULL OR EXISTS (
                SELECT 1 FROM public.logistics_partner_costs lpc
                WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
            ))
    ),
    paginated_records AS (
        SELECT id
        FROM filtered_records
        ORDER BY auto_number DESC, loading_date DESC
        LIMIT p_page_size
        OFFSET v_offset
    )
    SELECT jsonb_build_object(
        'count', (SELECT COUNT(*) FROM filtered_records),
        'overview', (
            SELECT jsonb_build_object(
                'total_records', COALESCE(COUNT(*), 0),
                'total_current_cost', COALESCE(SUM(current_cost), 0),
                'total_extra_cost', COALESCE(SUM(extra_cost), 0),
                'total_payable_cost', COALESCE(SUM(payable_cost), 0)
            )
            FROM filtered_records
        ),
        'partner_invoiceables', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.partner_name), '[]'::jsonb) FROM (
                SELECT
                    lpc.partner_id, p.name AS partner_name,
                    COUNT(DISTINCT lpc.logistics_record_id) AS records_count,
                    SUM(lpc.payable_amount) AS total_payable
                FROM public.logistics_partner_costs lpc
                JOIN public.partners p ON lpc.partner_id = p.id
                WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
                GROUP BY lpc.partner_id, p.name
            ) t
        ),
        'records', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.auto_number DESC, t.loading_date DESC), '[]'::jsonb) FROM (
                SELECT
                    v.id, v.auto_number, v.project_name, v.driver_name, v.loading_location, v.unloading_location,
                    to_char(v.loading_date, 'YYYY-MM-DD') AS loading_date,
                    to_char(v.unloading_date, 'YYYY-MM-DD') AS unloading_date,
                    v.loading_weight, v.unloading_weight, v.current_cost, v.payable_cost, v.extra_cost,
                    v.license_plate, v.driver_phone, v.transport_type, v.remarks, v.chain_name,
                    lr.invoice_status AS invoice_status,
                    v.billing_type_id,
                    COALESCE((
                        SELECT jsonb_agg(
                            jsonb_build_object(
                                'partner_id', lpc.partner_id,
                                'partner_name', p.name,
                                'level', lpc.level,
                                'base_amount', lpc.base_amount,
                                'payable_amount', lpc.payable_amount,
                                'tax_rate', lpc.tax_rate,
                                'invoice_status', lpc.invoice_status,
                                'payment_status', lpc.payment_status
                            )
                        )
                        FROM public.logistics_partner_costs lpc
                        JOIN public.partners p ON lpc.partner_id = p.id
                        WHERE lpc.logistics_record_id = v.id
                    ), '[]'::jsonb) AS partner_costs
                FROM public.logistics_records_view v
                JOIN public.logistics_records lr ON v.id = lr.id
                WHERE v.id IN (SELECT id FROM paginated_records)
            ) t
        )
    ) INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.get_invoice_request_data_latest
CREATE OR REPLACE FUNCTION public.get_invoice_request_data_latest(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid, p_invoice_status_array text[] DEFAULT NULL::text[], p_page_size integer DEFAULT 50, p_page_number integer DEFAULT 1)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN public.get_invoice_request_data(
        p_project_id,
        p_start_date,
        p_end_date,
        p_partner_id,
        p_invoice_status_array,
        p_page_size,
        p_page_number
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.get_invoice_request_data_v2
CREATE OR REPLACE FUNCTION public.get_invoice_request_data_v2(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid, p_invoice_status_array text[] DEFAULT NULL::text[], p_page_size integer DEFAULT 50, p_page_number integer DEFAULT 1)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN public.get_invoice_request_data(
        p_project_id,
        p_start_date,
        p_end_date,
        p_partner_id,
        p_invoice_status_array,
        p_page_size,
        p_page_number
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.get_invoice_request_data_v2
CREATE OR REPLACE FUNCTION public.get_invoice_request_data_v2(p_record_ids text[])
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
    v_can_view boolean := public.is_finance_or_admin();
BEGIN
    SELECT jsonb_build_object(
        'records', COALESCE(jsonb_agg(
            jsonb_build_object(
                'id', lr.id,
                'auto_number', lr.auto_number,
                'project_name', lr.project_name,
                'driver_name', lr.driver_name,
                'loading_location', lr.loading_location,
                'unloading_location', lr.unloading_location,
                'loading_date', to_char(lr.loading_date, 'YYYY-MM-DD'),
                'unloading_date', COALESCE(to_char(lr.unloading_date, 'YYYY-MM-DD'), null),
                'loading_weight', lr.loading_weight,
                'unloading_weight', lr.unloading_weight,
                'current_cost', lr.current_cost,
                'extra_cost', lr.extra_cost,
                'payable_cost', lr.payable_cost,
                'license_plate', lr.license_plate,
                'driver_phone', lr.driver_phone,
                'transport_type', lr.transport_type,
                'remarks', lr.remarks,
                'chain_name', lr.chain_name,
                'cargo_type', lr.cargo_type,
                'invoice_status', COALESCE(lr.invoice_status, 'Uninvoiced'),
                'partner_costs', (
                    SELECT COALESCE(jsonb_agg(
                        jsonb_build_object(
                            'partner_id', lpc.partner_id,
                            'partner_name', p.name,
                            'level', lpc.level,
                            'payable_amount', lpc.payable_amount,
                            'full_name', CASE WHEN v_can_view THEN p.full_name ELSE NULL END,
                            'bank_account', CASE WHEN v_can_view THEN bd.bank_account ELSE NULL END,
                            'bank_name', CASE WHEN v_can_view THEN bd.bank_name ELSE NULL END,
                            'branch_name', CASE WHEN v_can_view THEN bd.branch_name ELSE NULL END
                        ) ORDER BY lpc.level
                    ), '[]'::jsonb)
                    FROM public.logistics_partner_costs lpc
                    JOIN public.partners p ON lpc.partner_id = p.id
                    LEFT JOIN public.partner_bank_details bd ON bd.partner_id = p.id
                    WHERE lpc.logistics_record_id = lr.id
                )
            ) ORDER BY lr.loading_date DESC, lr.auto_number DESC
        ), '[]'::jsonb)
    )
    INTO result_json
    FROM public.logistics_records lr
    WHERE lr.id::text = ANY(p_record_ids);

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.get_invoice_request_data_v2
CREATE OR REPLACE FUNCTION public.get_invoice_request_data_v2(p_record_ids uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
BEGIN
    -- 权限检查
    IF NOT public.is_finance_or_admin_for_invoice() THEN
        RAISE EXCEPTION '权限不足';
    END IF;
    
    SELECT jsonb_build_object(
        'records', COALESCE(jsonb_agg(
            jsonb_build_object(
                'id', lr.id,
                'auto_number', lr.auto_number,
                'project_name', p.name,
                'driver_name', d.name,
                'loading_location', lr.loading_location,
                'unloading_location', lr.unloading_location,
                'loading_date', lr.loading_date,
                'unloading_date', lr.unloading_date,
                'license_plate', lr.license_plate,
                'driver_phone', d.phone,
                'cargo_type', lr.cargo_type,
                'loading_weight', lr.loading_weight,
                'unloading_weight', lr.unloading_weight,
                'remarks', lr.remarks,
                'billing_type_id', lr.billing_type_id,
                'current_cost', lr.current_cost,
                'extra_cost', lr.extra_cost,
                'payable_cost', COALESCE(lr.current_cost, 0) + COALESCE(lr.extra_cost, 0),
                'partner_costs', (
                    SELECT COALESCE(jsonb_agg(
                        jsonb_build_object(
                            'id', lpc.id,
                            'partner_id', lpc.partner_id,
                            'partner_name', pt.name,
                            'level', lpc.level,
                            'base_amount', lpc.base_amount,
                            'payable_amount', lpc.payable_amount,
                            'tax_rate', lpc.tax_rate,
                            'invoice_status', lpc.invoice_status,
                            'payment_status', lpc.payment_status,
                            'full_name', pt.full_name,
                            'tax_number', COALESCE(pt.tax_number, ''),
                            'company_address', COALESCE(pt.company_address, ''),
                            'bank_name', COALESCE(pbd.bank_name, ''),
                            'bank_account', COALESCE(pbd.bank_account, ''),
                            'branch_name', COALESCE(pbd.branch_name, '')
                        ) ORDER BY lpc.level
                    ), '[]'::jsonb)
                    FROM logistics_partner_costs lpc
                    JOIN partners pt ON lpc.partner_id = pt.id
                    LEFT JOIN partner_bank_details pbd ON pt.id = pbd.partner_id
                    WHERE lpc.logistics_record_id = lr.id
                      AND lpc.invoice_status = 'Uninvoiced'
                )
            )
        ), '[]'::jsonb)
    )
    INTO result_json
    FROM logistics_records lr
    LEFT JOIN projects p ON lr.project_id = p.id
    LEFT JOIN drivers d ON lr.driver_id = d.id
    WHERE lr.id = ANY(p_record_ids);

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.get_locations_for_geocoding
CREATE OR REPLACE FUNCTION public.get_locations_for_geocoding(p_limit integer DEFAULT 50)
 RETURNS TABLE(id uuid, name text, address text, geocoding_status geocoding_status, geocoding_updated_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        l.id,
        l.name,
        l.address,
        l.geocoding_status,
        l.geocoding_updated_at
    FROM public.locations l
    WHERE l.geocoding_status IN ('pending', 'failed')
    ORDER BY 
        CASE 
            WHEN l.geocoding_status = 'failed' THEN 1
            WHEN l.geocoding_status = 'pending' THEN 2
        END,
        l.created_at ASC
    LIMIT p_limit;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.get_locations_for_project
CREATE OR REPLACE FUNCTION public.get_locations_for_project(p_project_id uuid)
 RETURNS TABLE(id uuid, name text)
 LANGUAGE sql
 STABLE
 SET search_path TO 'public'
AS $function$
  SELECT 
    l.id, 
    l.name
  FROM public.locations l
  JOIN public.location_projects lp ON l.id = lp.location_id
  WHERE lp.project_id = p_project_id;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.get_logistics_record_by_external_tracking
CREATE OR REPLACE FUNCTION public.get_logistics_record_by_external_tracking(p_tracking_number text)
 RETURNS TABLE(id uuid, auto_number text, project_name text, driver_name text, loading_location text, loading_date timestamp with time zone, external_tracking_numbers jsonb)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    lr.id,
    lr.auto_number,
    lr.project_name,
    lr.driver_name,
    lr.loading_location,
    lr.loading_date,
    lr.external_tracking_numbers
  FROM public.logistics_records lr
  WHERE lr.external_tracking_numbers @> jsonb_build_array(
    jsonb_build_object('tracking_number', p_tracking_number)
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- 函数: public.get_logistics_records_by_platform
CREATE OR REPLACE FUNCTION public.get_logistics_records_by_platform(p_platform_name text)
 RETURNS TABLE(id uuid, auto_number text, project_name text, driver_name text, loading_location text, loading_date timestamp with time zone, other_platform_names text[])
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    lr.id,
    lr.auto_number,
    lr.project_name,
    lr.driver_name,
    lr.loading_location,
    lr.loading_date,
    lr.other_platform_names
  FROM public.logistics_records lr
  WHERE p_platform_name = ANY(lr.other_platform_names);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.get_logistics_records_paginated
CREATE OR REPLACE FUNCTION public.get_logistics_records_paginated(p_start_date text, p_end_date text, p_page_number integer, p_page_size integer, p_project_name text DEFAULT NULL::text, p_search_term text DEFAULT NULL::text)
 RETURNS TABLE(id uuid, auto_number text, project_name text, driver_name text, loading_location text, unloading_location text, loading_date text, unloading_date text, loading_weight numeric, unloading_weight numeric, current_cost numeric, payable_cost numeric, license_plate text, cooperative_partner text, remarks text)
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
DECLARE
    v_offset integer;
BEGIN
    -- [您的原始逻辑 - 开始]
    v_offset := (p_page_number - 1) * p_page_size;

    RETURN QUERY
    SELECT
        lr.id,
        lr.auto_number,
        lr.project_name,
        lr.driver_name,
        lr.loading_location,
        lr.unloading_location,
        lr.loading_date::text,
        lr.unloading_date::text,
        lr.loading_weight,
        lr.unloading_weight,
        lr.current_cost,
        lr.payable_cost,
        lr.license_plate,
        NULL::text as cooperative_partner,
        lr.remarks
    FROM
        public.logistics_records AS lr
    WHERE
        lr.loading_date >= p_start_date::date
        AND lr.loading_date <= p_end_date::date
        AND (p_project_name IS NULL OR lr.project_name = p_project_name)
        AND (
            p_search_term IS NULL OR
            lr.driver_name ILIKE '%' || p_search_term || '%' OR
            lr.license_plate ILIKE '%' || p_search_term || '%' OR
            lr.loading_location ILIKE '%' || p_search_term || '%' OR
            lr.unloading_location ILIKE '%' || p_search_term || '%'
        )
    ORDER BY
        lr.loading_date DESC, lr.created_at DESC
    LIMIT p_page_size
    OFFSET v_offset;
    -- [您的原始逻辑 - 结束]
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.get_logistics_records_paginated_old_sig
CREATE OR REPLACE FUNCTION public.get_logistics_records_paginated_old_sig(p_start_date text, p_end_date text, p_project_name text, p_search_term text, p_page_number integer, p_page_size integer)
 RETURNS TABLE(id uuid, auto_number text, project_name text, driver_name text, loading_location text, unloading_location text, loading_date text, unloading_date text, loading_weight numeric, unloading_weight numeric, current_cost numeric, payable_cost numeric, license_plate text, cooperative_partner text, remarks text)
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    v_offset integer;
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;

    RETURN QUERY
    SELECT
        lr.id,
        lr.auto_number,
        lr.project_name,
        lr.driver_name,
        lr.loading_location,
        lr.unloading_location,
        lr.loading_date::text,
        lr.unloading_date::text,
        lr.loading_weight,
        lr.unloading_weight,
        lr.current_cost,
        lr.payable_cost,
        lr.license_plate,
        -- 【核心修复】: 因为该列不存在，我们直接返回一个 NULL 值来“伪造”它，以满足前端代码的需求
        NULL::text as cooperative_partner,
        lr.remarks
    FROM
        public.logistics_records AS lr
    WHERE
        lr.loading_date >= p_start_date::date
        AND lr.loading_date <= p_end_date::date
        AND (p_project_name IS NULL OR lr.project_name = p_project_name)
        AND (
            p_search_term IS NULL OR
            lr.driver_name ILIKE '%' || p_search_term || '%' OR
            lr.license_plate ILIKE '%' || p_search_term || '%' OR
            lr.loading_location ILIKE '%' || p_search_term || '%' OR
            lr.unloading_location ILIKE '%' || p_search_term || '%'
        )
    ORDER BY
        lr.loading_date DESC, lr.created_at DESC
    LIMIT p_page_size
    OFFSET v_offset;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.get_logistics_summary_and_records
CREATE OR REPLACE FUNCTION public.get_logistics_summary_and_records(p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_project_name text DEFAULT NULL::text, p_driver_name text DEFAULT NULL::text, p_license_plate text DEFAULT NULL::text, p_driver_phone text DEFAULT NULL::text, p_page_number integer DEFAULT 1, p_page_size integer DEFAULT 25, p_sort_field text DEFAULT 'auto_number'::text, p_sort_direction text DEFAULT 'desc'::text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_records jsonb;
    v_summary jsonb;
    v_total_count integer;
    v_offset integer;
    v_order_clause text;
BEGIN
    -- 计算偏移量
    v_offset := (p_page_number - 1) * p_page_size;
    
    -- 构建排序子句
    CASE p_sort_field
        WHEN 'auto_number' THEN
            v_order_clause := 'lr.auto_number ' || p_sort_direction;
        WHEN 'project_name' THEN
            v_order_clause := 'lr.project_name ' || p_sort_direction;
        WHEN 'loading_date' THEN
            v_order_clause := 'lr.loading_date ' || p_sort_direction;
        WHEN 'driver_name' THEN
            v_order_clause := 'lr.driver_name ' || p_sort_direction;
        WHEN 'current_cost' THEN
            v_order_clause := 'lr.current_cost ' || p_sort_direction;
        WHEN 'payable_cost' THEN
            v_order_clause := 'lr.payable_cost ' || p_sort_direction;
        ELSE
            v_order_clause := 'lr.auto_number ' || p_sort_direction;
    END CASE;
    
    -- 获取记录总数
    SELECT COUNT(*) INTO v_total_count
    FROM public.logistics_records lr
    WHERE (p_start_date IS NULL OR lr.loading_date::date >= p_start_date::date)
    AND (p_end_date IS NULL OR lr.loading_date::date <= p_end_date::date)
    AND (p_project_name IS NULL OR lr.project_name ILIKE '%' || p_project_name || '%')
    AND (p_driver_name IS NULL OR lr.driver_name ILIKE '%' || p_driver_name || '%')
    AND (p_license_plate IS NULL OR lr.license_plate ILIKE '%' || p_license_plate || '%')
    AND (p_driver_phone IS NULL OR lr.driver_phone ILIKE '%' || p_driver_phone || '%');
    
    -- 获取分页记录（确保运单编号格式正确，不拼接外部跟踪号）
    EXECUTE format('
        WITH filtered_records AS (
            SELECT 
                lr.id,
                lr.auto_number,
                lr.project_id,
                lr.project_name,
                lr.chain_id,
                COALESCE(pc.chain_name, '''') as chain_name,
                COALESCE(lr.billing_type_id, 1) as billing_type_id,
                lr.driver_id,
                lr.driver_name,
                lr.loading_location,
                lr.unloading_location,
                lr.loading_date,
                lr.unloading_date,
                lr.loading_weight,
                lr.unloading_weight,
                lr.current_cost,
                lr.payable_cost,
                lr.driver_payable_cost,
                lr.license_plate,
                lr.driver_phone,
                lr.transport_type,
                lr.extra_cost,
                lr.remarks,
                lr.external_tracking_numbers,
                lr.other_platform_names,
                lr.created_at
            FROM public.logistics_records lr
            LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
            WHERE (p_start_date IS NULL OR lr.loading_date::date >= p_start_date::date)
            AND (p_end_date IS NULL OR lr.loading_date::date <= p_end_date::date)
            AND (p_project_name IS NULL OR lr.project_name ILIKE ''%%'' || p_project_name || ''%%'')
            AND (p_driver_name IS NULL OR lr.driver_name ILIKE ''%%'' || p_driver_name || ''%%'')
            AND (p_license_plate IS NULL OR lr.license_plate ILIKE ''%%'' || p_license_plate || ''%%'')
            AND (p_driver_phone IS NULL OR lr.driver_phone ILIKE ''%%'' || p_driver_phone || ''%%'')
            ORDER BY %s
            LIMIT %s OFFSET %s
        )
        SELECT jsonb_agg(
            jsonb_build_object(
                ''id'', id,
                ''auto_number'', auto_number,
                ''project_id'', project_id,
                ''project_name'', project_name,
                ''chain_id'', chain_id,
                ''chain_name'', chain_name,
                ''billing_type_id'', billing_type_id,
                ''driver_id'', driver_id,
                ''driver_name'', driver_name,
                ''loading_location'', loading_location,
                ''unloading_location'', unloading_location,
                ''loading_date'', loading_date,
                ''unloading_date'', unloading_date,
                ''loading_weight'', loading_weight,
                ''unloading_weight'', unloading_weight,
                ''current_cost'', current_cost,
                ''payable_cost'', payable_cost,
                ''driver_payable_cost'', driver_payable_cost,
                ''license_plate'', license_plate,
                ''driver_phone'', driver_phone,
                ''transport_type'', transport_type,
                ''extra_cost'', extra_cost,
                ''remarks'', remarks,
                ''external_tracking_numbers'', external_tracking_numbers,
                ''other_platform_names'', other_platform_names,
                ''created_at'', created_at
            )
        )
        FROM filtered_records',
        v_order_clause, p_page_size, v_offset
    ) INTO v_records;
    
    -- 获取汇总数据
    SELECT jsonb_build_object(
        'totalCurrentCost', COALESCE(SUM(lr.current_cost), 0),
        'totalExtraCost', COALESCE(SUM(lr.extra_cost), 0),
        'totalDriverPayableCost', COALESCE(SUM(lr.payable_cost), 0),
        'actualCount', COUNT(CASE WHEN lr.transport_type = '实际运输' THEN 1 END),
        'returnCount', COUNT(CASE WHEN lr.transport_type = '退货' THEN 1 END),
        'totalWeightLoading', COALESCE(SUM(lr.loading_weight), 0),
        'totalWeightUnloading', COALESCE(SUM(lr.unloading_weight), 0),
        'totalTripsLoading', COALESCE(SUM(CASE WHEN lr.billing_type_id = 2 THEN lr.loading_weight ELSE 0 END), 0),
        'totalVolumeLoading', COALESCE(SUM(CASE WHEN lr.billing_type_id = 3 THEN lr.loading_weight ELSE 0 END), 0),
        'totalVolumeUnloading', COALESCE(SUM(CASE WHEN lr.billing_type_id = 3 THEN lr.unloading_weight ELSE 0 END), 0)
    ) INTO v_summary
    FROM public.logistics_records lr
    WHERE (p_start_date IS NULL OR lr.loading_date::date >= p_start_date::date)
    AND (p_end_date IS NULL OR lr.loading_date::date <= p_end_date::date)
    AND (p_project_name IS NULL OR lr.project_name ILIKE '%' || p_project_name || '%')
    AND (p_driver_name IS NULL OR lr.driver_name ILIKE '%' || p_driver_name || '%')
    AND (p_license_plate IS NULL OR lr.license_plate ILIKE '%' || p_license_plate || '%')
    AND (p_driver_phone IS NULL OR lr.driver_phone ILIKE '%' || p_driver_phone || '%');
    
    -- 返回结果
    RETURN jsonb_build_object(
        'records', COALESCE(v_records, '[]'::jsonb),
        'summary', v_summary,
        'totalCount', v_total_count
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.get_logistics_summary_and_records_backup
CREATE OR REPLACE FUNCTION public.get_logistics_summary_and_records_backup(p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_project_name text DEFAULT NULL::text, p_driver_name text DEFAULT NULL::text, p_license_plate text DEFAULT NULL::text, p_driver_phone text DEFAULT NULL::text, p_page_number integer DEFAULT 1, p_page_size integer DEFAULT 25)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_records jsonb;
    v_summary jsonb;
    v_total_count integer;
    v_offset integer;
BEGIN
    -- 计算偏移量
    v_offset := (p_page_number - 1) * p_page_size;
    
    -- 获取记录总数
    SELECT COUNT(*) INTO v_total_count
    FROM public.logistics_records lr
    WHERE (p_start_date IS NULL OR lr.loading_date::date >= p_start_date::date)
    AND (p_end_date IS NULL OR lr.loading_date::date <= p_end_date::date)
    AND (p_project_name IS NULL OR lr.project_name ILIKE '%' || p_project_name || '%')
    AND (p_driver_name IS NULL OR lr.driver_name ILIKE '%' || p_driver_name || '%')
    AND (p_license_plate IS NULL OR lr.license_plate ILIKE '%' || p_license_plate || '%')
    AND (p_driver_phone IS NULL OR lr.driver_phone ILIKE '%' || p_driver_phone || '%');
    
    -- 获取分页记录（包含平台字段）
    SELECT jsonb_agg(
        jsonb_build_object(
            'id', lr.id,
            'auto_number', lr.auto_number,
            'project_id', lr.project_id,
            'project_name', lr.project_name,
            'chain_id', lr.chain_id,
            'chain_name', lr.chain_name,
            'billing_type_id', lr.billing_type_id,
            'driver_id', lr.driver_id,
            'driver_name', lr.driver_name,
            'loading_location', lr.loading_location,
            'unloading_location', lr.unloading_location,
            'loading_date', lr.loading_date,
            'unloading_date', lr.unloading_date,
            'loading_weight', lr.loading_weight,
            'unloading_weight', lr.unloading_weight,
            'current_cost', lr.current_cost,
            'payable_cost', lr.payable_cost,
            'driver_payable_cost', lr.driver_payable_cost,
            'license_plate', lr.license_plate,
            'driver_phone', lr.driver_phone,
            'transport_type', lr.transport_type,
            'extra_cost', lr.extra_cost,
            'remarks', lr.remarks,
            'external_tracking_numbers', lr.external_tracking_numbers,
            'other_platform_names', lr.other_platform_names,
            'created_at', lr.created_at
        )
    ) INTO v_records
    FROM public.logistics_records lr
    WHERE (p_start_date IS NULL OR lr.loading_date::date >= p_start_date::date)
    AND (p_end_date IS NULL OR lr.loading_date::date <= p_end_date::date)
    AND (p_project_name IS NULL OR lr.project_name ILIKE '%' || p_project_name || '%')
    AND (p_driver_name IS NULL OR lr.driver_name ILIKE '%' || p_driver_name || '%')
    AND (p_license_plate IS NULL OR lr.license_plate ILIKE '%' || p_license_plate || '%')
    AND (p_driver_phone IS NULL OR lr.driver_phone ILIKE '%' || p_driver_phone || '%')
    ORDER BY lr.auto_number DESC
    LIMIT p_page_size OFFSET v_offset;
    
    -- 获取汇总数据
    SELECT jsonb_build_object(
        'totalCurrentCost', COALESCE(SUM(lr.current_cost), 0),
        'totalExtraCost', COALESCE(SUM(lr.extra_cost), 0),
        'totalDriverPayableCost', COALESCE(SUM(lr.payable_cost), 0),
        'actualCount', COUNT(CASE WHEN lr.transport_type = '实际运输' THEN 1 END),
        'returnCount', COUNT(CASE WHEN lr.transport_type = '退货' THEN 1 END),
        'totalWeightLoading', COALESCE(SUM(lr.loading_weight), 0),
        'totalWeightUnloading', COALESCE(SUM(lr.unloading_weight), 0),
        'totalTripsLoading', COALESCE(SUM(CASE WHEN lr.billing_type_id = 2 THEN lr.loading_weight ELSE 0 END), 0),
        'totalVolumeLoading', COALESCE(SUM(CASE WHEN lr.billing_type_id = 3 THEN lr.loading_weight ELSE 0 END), 0),
        'totalVolumeUnloading', COALESCE(SUM(CASE WHEN lr.billing_type_id = 3 THEN lr.unloading_weight ELSE 0 END), 0)
    ) INTO v_summary
    FROM public.logistics_records lr
    WHERE (p_start_date IS NULL OR lr.loading_date::date >= p_start_date::date)
    AND (p_end_date IS NULL OR lr.loading_date::date <= p_end_date::date)
    AND (p_project_name IS NULL OR lr.project_name ILIKE '%' || p_project_name || '%')
    AND (p_driver_name IS NULL OR lr.driver_name ILIKE '%' || p_driver_name || '%')
    AND (p_license_plate IS NULL OR lr.license_plate ILIKE '%' || p_license_plate || '%')
    AND (p_driver_phone IS NULL OR lr.driver_phone ILIKE '%' || p_driver_phone || '%');
    
    -- 返回结果
    RETURN jsonb_build_object(
        'records', COALESCE(v_records, '[]'::jsonb),
        'summary', v_summary,
        'totalCount', v_total_count
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.get_logistics_summary_and_records_bak
CREATE OR REPLACE FUNCTION public.get_logistics_summary_and_records_bak(p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_project_name text DEFAULT NULL::text, p_driver_name text DEFAULT NULL::text, p_license_plate text DEFAULT NULL::text, p_driver_phone text DEFAULT NULL::text, p_page_number integer DEFAULT 1, p_page_size integer DEFAULT 25)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$DECLARE
    v_offset integer;
    v_result jsonb;
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;

    WITH filtered_records AS (
        SELECT lr.*,
               pc.chain_name
        FROM public.logistics_records lr
        LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
        WHERE
            (p_start_date IS NULL OR p_start_date = '' OR lr.loading_date >= p_start_date::date) AND
            (p_end_date IS NULL OR p_end_date = '' OR lr.loading_date <= p_end_date::date) AND
            (p_project_name IS NULL OR p_project_name = '' OR lr.project_name = p_project_name) AND
            (p_driver_name IS NULL OR p_driver_name = '' OR lr.driver_name ILIKE '%' || p_driver_name || '%') AND
            (p_license_plate IS NULL OR p_license_plate = '' OR lr.license_plate ILIKE '%' || p_license_plate || '%') AND
            (p_driver_phone IS NULL OR p_driver_phone = '' OR lr.driver_phone ILIKE '%' || p_driver_phone || '%')
    )
    SELECT jsonb_build_object(
        'summary', (
            SELECT jsonb_build_object(
                'totalLoadingWeight', COALESCE(SUM(loading_weight), 0),
                'totalUnloadingWeight', COALESCE(SUM(unloading_weight), 0),
                'totalCurrentCost', COALESCE(SUM(current_cost), 0),
                'totalExtraCost', COALESCE(SUM(extra_cost), 0),
                'totalDriverPayableCost', COALESCE(SUM(payable_cost), 0),
                'actualCount', COUNT(*) FILTER (WHERE transport_type = '实际运输'),
                'returnCount', COUNT(*) FILTER (WHERE transport_type = '退货')
            )
            FROM filtered_records
        ),
        'records', (
            SELECT COALESCE(jsonb_agg(fr.* ORDER BY fr.loading_date DESC, fr.created_at DESC), '[]'::jsonb)
            FROM (
                SELECT *
                FROM filtered_records
                ORDER BY loading_date DESC, created_at DESC
                LIMIT p_page_size
                OFFSET v_offset
            ) fr
        ),
        'count', (SELECT COUNT(*) FROM filtered_records)
    )
    INTO v_result;

    RETURN v_result;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.get_logistics_summary_and_records_enhanced
CREATE OR REPLACE FUNCTION public.get_logistics_summary_and_records_enhanced(p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_project_name text DEFAULT NULL::text, p_driver_name text DEFAULT NULL::text, p_license_plate text DEFAULT NULL::text, p_driver_phone text DEFAULT NULL::text, p_other_platform_name text DEFAULT NULL::text, p_waybill_numbers text DEFAULT NULL::text, p_has_scale_record text DEFAULT NULL::text, p_page_number integer DEFAULT 1, p_page_size integer DEFAULT 25, p_sort_field text DEFAULT 'auto_number'::text, p_sort_direction text DEFAULT 'desc'::text)
 RETURNS jsonb
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_offset integer;
    v_result jsonb;
    v_waybill_array text[];
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;
    
    -- 解析运单编号字符串为数组
    IF p_waybill_numbers IS NOT NULL AND p_waybill_numbers != '' THEN
        v_waybill_array := string_to_array(p_waybill_numbers, ',');
        -- 去除每个元素的前后空格
        v_waybill_array := array(SELECT trim(unnest(v_waybill_array)));
    END IF;

    WITH filtered_records AS (
        SELECT lr.*,
               pc.chain_name,
               CASE 
                   WHEN EXISTS (SELECT 1 FROM public.scale_records sr WHERE sr.logistics_number = lr.auto_number) 
                   THEN true 
                   ELSE false 
               END as has_scale_record
        FROM public.logistics_records lr
        LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
        WHERE
            (p_start_date IS NULL OR p_start_date = '' OR lr.loading_date >= p_start_date::date) AND
            (p_end_date IS NULL OR p_end_date = '' OR lr.loading_date <= p_end_date::date) AND
            (p_project_name IS NULL OR p_project_name = '' OR lr.project_name = p_project_name) AND
            (p_driver_name IS NULL OR p_driver_name = '' OR lr.driver_name ILIKE '%' || p_driver_name || '%') AND
            (p_license_plate IS NULL OR p_license_plate = '' OR lr.license_plate ILIKE '%' || p_license_plate || '%') AND
            (p_driver_phone IS NULL OR p_driver_phone = '' OR lr.driver_phone ILIKE '%' || p_driver_phone || '%') AND
            -- 其他平台名称筛选：为空则查询本平台（other_platform_names为空或null），不为空则查询包含该平台名称的记录
            (p_other_platform_name IS NULL OR p_other_platform_name = '' OR 
             CASE 
                 WHEN p_other_platform_name = '本平台' THEN 
                     (lr.other_platform_names IS NULL OR array_length(lr.other_platform_names, 1) IS NULL)
                 ELSE 
                     EXISTS (SELECT 1 FROM unnest(lr.other_platform_names) AS platform_name 
                            WHERE platform_name ILIKE '%' || p_other_platform_name || '%')
             END) AND
            -- 运单编号筛选：支持多个运单编号查询
            (p_waybill_numbers IS NULL OR p_waybill_numbers = '' OR 
             lr.auto_number = ANY(v_waybill_array)) AND
            -- 磅单筛选：根据是否有磅单进行筛选
            (p_has_scale_record IS NULL OR p_has_scale_record = '' OR
             CASE 
                 WHEN p_has_scale_record = 'yes' THEN 
                     EXISTS (SELECT 1 FROM public.scale_records sr WHERE sr.logistics_number = lr.auto_number)
                 WHEN p_has_scale_record = 'no' THEN 
                     NOT EXISTS (SELECT 1 FROM public.scale_records sr WHERE sr.logistics_number = lr.auto_number)
                 ELSE true
             END)
    )
    SELECT jsonb_build_object(
        'summary', (
            SELECT jsonb_build_object(
                'totalCurrentCost', COALESCE(SUM(current_cost), 0),
                'totalExtraCost', COALESCE(SUM(extra_cost), 0),
                'totalDriverPayableCost', COALESCE(SUM(payable_cost), 0),
                'actualCount', COUNT(*) FILTER (WHERE transport_type = '实际运输'),
                'returnCount', COUNT(*) FILTER (WHERE transport_type = '退货'),
                'totalWeightLoading', COALESCE(SUM(loading_weight), 0),
                'totalWeightUnloading', COALESCE(SUM(unloading_weight), 0),
                'totalTripsLoading', COUNT(*) FILTER (WHERE billing_type_id = 2),
                'totalVolumeLoading', COALESCE(SUM(loading_weight) FILTER (WHERE billing_type_id = 3), 0),
                'totalVolumeUnloading', COALESCE(SUM(unloading_weight) FILTER (WHERE billing_type_id = 3), 0)
            )
            FROM filtered_records
        ),
        'records', (
            SELECT COALESCE(jsonb_agg(fr.* ORDER BY 
                CASE WHEN p_sort_field = 'auto_number' AND p_sort_direction = 'asc' THEN fr.auto_number END ASC,
                CASE WHEN p_sort_field = 'auto_number' AND p_sort_direction = 'desc' THEN fr.auto_number END DESC,
                CASE WHEN p_sort_field = 'loading_date' AND p_sort_direction = 'asc' THEN fr.loading_date END ASC,
                CASE WHEN p_sort_field = 'loading_date' AND p_sort_direction = 'desc' THEN fr.loading_date END DESC,
                CASE WHEN p_sort_field = 'driver_name' AND p_sort_direction = 'asc' THEN fr.driver_name END ASC,
                CASE WHEN p_sort_field = 'driver_name' AND p_sort_direction = 'desc' THEN fr.driver_name END DESC,
                CASE WHEN p_sort_field = 'current_cost' AND p_sort_direction = 'asc' THEN fr.current_cost END ASC,
                CASE WHEN p_sort_field = 'current_cost' AND p_sort_direction = 'desc' THEN fr.current_cost END DESC,
                CASE WHEN p_sort_field = 'payable_cost' AND p_sort_direction = 'asc' THEN fr.payable_cost END ASC,
                CASE WHEN p_sort_field = 'payable_cost' AND p_sort_direction = 'desc' THEN fr.payable_cost END DESC,
                fr.loading_date DESC, fr.created_at DESC
            ), '[]'::jsonb)
            FROM (
                SELECT *
                FROM filtered_records
                ORDER BY 
                    CASE WHEN p_sort_field = 'auto_number' AND p_sort_direction = 'asc' THEN auto_number END ASC,
                    CASE WHEN p_sort_field = 'auto_number' AND p_sort_direction = 'desc' THEN auto_number END DESC,
                    CASE WHEN p_sort_field = 'loading_date' AND p_sort_direction = 'asc' THEN loading_date END ASC,
                    CASE WHEN p_sort_field = 'loading_date' AND p_sort_direction = 'desc' THEN loading_date END DESC,
                    CASE WHEN p_sort_field = 'driver_name' AND p_sort_direction = 'asc' THEN driver_name END ASC,
                    CASE WHEN p_sort_field = 'driver_name' AND p_sort_direction = 'desc' THEN driver_name END DESC,
                    CASE WHEN p_sort_field = 'current_cost' AND p_sort_direction = 'asc' THEN current_cost END ASC,
                    CASE WHEN p_sort_field = 'current_cost' AND p_sort_direction = 'desc' THEN current_cost END DESC,
                    CASE WHEN p_sort_field = 'payable_cost' AND p_sort_direction = 'asc' THEN payable_cost END ASC,
                    CASE WHEN p_sort_field = 'payable_cost' AND p_sort_direction = 'desc' THEN payable_cost END DESC,
                    loading_date DESC, created_at DESC
                LIMIT p_page_size OFFSET v_offset
            ) fr
        ),
        'totalCount', (
            SELECT COUNT(*)
            FROM filtered_records
        )
    ) INTO v_result;
    
    RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- 函数: public.get_monthly_receivables
CREATE OR REPLACE FUNCTION public.get_monthly_receivables()
 RETURNS numeric
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    total_amount NUMERIC;
BEGIN
    WITH highest_level_costs AS (
        SELECT
            DISTINCT ON (lpc.logistics_record_id)
            lpc.logistics_record_id,
            lpc.payable_amount
        FROM
            public.logistics_partner_costs lpc
        JOIN
            public.logistics_records lr ON lpc.logistics_record_id = lr.id
        WHERE
            lr.created_at >= date_trunc('month', NOW()) AND
            lr.created_at < date_trunc('month', NOW()) + interval '1 month'
        ORDER BY
            lpc.logistics_record_id,
            lpc.level DESC -- 按 level 降序排序
    )
    SELECT INTO total_amount SUM(h.payable_amount)
    FROM highest_level_costs h;

    RETURN COALESCE(total_amount, 0);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.get_monthly_trends
CREATE OR REPLACE FUNCTION public.get_monthly_trends()
 RETURNS TABLE(month_start text, total_receivables numeric)
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    WITH months AS (
        SELECT date_trunc('month', generate_series(NOW() - interval '11 months', NOW(), '1 month'))::date AS month_date
    ),
    highest_level_costs AS (
        SELECT
            DISTINCT ON (lpc.logistics_record_id)
            lr.created_at,
            lpc.payable_amount
        FROM
            public.logistics_partner_costs lpc
        JOIN
            public.logistics_records lr ON lpc.logistics_record_id = lr.id
        ORDER BY
            lpc.logistics_record_id,
            lpc.level DESC -- level 越大，级别越高
    )
    SELECT
        to_char(m.month_date, 'YYYY-MM') AS month_start,
        COALESCE(SUM(h.payable_amount), 0) AS total_receivables
    FROM
        months m
    LEFT JOIN
        highest_level_costs h ON date_trunc('month', h.created_at) = m.month_date
    GROUP BY
        m.month_date
    ORDER BY
        m.month_date;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- 函数: public.get_my_claim
CREATE OR REPLACE FUNCTION public.get_my_claim(claim text)
 RETURNS text
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  claims jsonb;
BEGIN
  claims := current_setting('request.jwt.claims', true)::jsonb;
  IF claims IS NULL THEN
    RETURN NULL;
  END IF;
  RETURN claims ->> claim;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.get_my_role
CREATE OR REPLACE FUNCTION public.get_my_role()
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN get_my_claim('role')::text;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.get_or_create_driver
CREATE OR REPLACE FUNCTION public.get_or_create_driver(p_driver_name text, p_license_plate text, p_phone text, p_project_id uuid)
 RETURNS TABLE(driver_id uuid, driver_name text)
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    v_driver_id uuid;
BEGIN
    -- 步骤 1: 使用姓名和车牌号的组合来精确查找司机
    SELECT id INTO v_driver_id
    FROM public.drivers
    WHERE name = p_driver_name AND license_plate = p_license_plate
    LIMIT 1;

    -- 步骤 2: 如果找不到司机，则创建一个新的
    IF v_driver_id IS NULL THEN
        -- 如果司机名为空，则直接返回，不创建
        IF p_driver_name IS NULL OR p_driver_name = '' THEN
            RETURN;
        END IF;
        
        INSERT INTO public.drivers (name, license_plate, phone, user_id)
        VALUES (p_driver_name, p_license_plate, p_phone, auth.uid())
        RETURNING id INTO v_driver_id;
    END IF;
    
    -- 步骤 3 (关键): 使用 ON CONFLICT 高效地确保司机和当前项目已经关联
    IF p_project_id IS NOT NULL THEN
        INSERT INTO public.driver_projects (driver_id, project_id, user_id)
        VALUES (v_driver_id, p_project_id, auth.uid())
        ON CONFLICT (driver_id, project_id) DO NOTHING;
    END IF;

    -- 步骤 4: 返回找到的或新创建的司机ID和姓名
    RETURN QUERY
    SELECT v_driver_id, p_driver_name;

END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_or_create_driver_and_link_project
CREATE OR REPLACE FUNCTION public.get_or_create_driver_and_link_project(p_driver_name text, p_license_plate text, p_phone text, p_project_id uuid, p_user_id uuid DEFAULT auth.uid())
 RETURNS uuid
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    v_driver_id uuid;
BEGIN
    -- 1. 尝试根据名称查找现有司机
    SELECT id INTO v_driver_id FROM drivers WHERE name = p_driver_name LIMIT 1;

    -- 2. 如果找不到，则创建新司机
    IF v_driver_id IS NULL THEN
        INSERT INTO drivers (name, license_plate, phone, user_id)
        VALUES (p_driver_name, p_license_plate, p_phone, p_user_id)
        RETURNING id INTO v_driver_id;
    END IF;

    -- 3. 确保司机与项目的关联存在
    INSERT INTO driver_projects (driver_id, project_id, user_id)
    VALUES (v_driver_id, p_project_id, p_user_id)
    ON CONFLICT (driver_id, project_id) DO NOTHING;

    -- 4. 返回最终的司机ID
    RETURN v_driver_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.get_or_create_driver_with_project
CREATE OR REPLACE FUNCTION public.get_or_create_driver_with_project(p_driver_name text, p_license_plate text, p_phone text, p_project_id uuid)
 RETURNS TABLE(driver_id uuid, driver_name text)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  found_driver_id uuid;
BEGIN
  IF p_driver_name IS NULL OR p_driver_name = '' THEN RETURN; END IF;
  
  SELECT d.id INTO found_driver_id 
  FROM public.drivers d
  WHERE d.name = p_driver_name 
  LIMIT 1;
  
  IF found_driver_id IS NULL THEN
    INSERT INTO public.drivers (name, license_plate, phone, user_id) 
    VALUES (p_driver_name, p_license_plate, p_phone, auth.uid()) 
    RETURNING id INTO found_driver_id;
  END IF;
  
  -- 【加固点】
  INSERT INTO public.driver_projects (driver_id, project_id, user_id)
  VALUES (found_driver_id, p_project_id, auth.uid())
  ON CONFLICT (driver_id, project_id) DO NOTHING;
  
  RETURN QUERY SELECT found_driver_id, p_driver_name;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.get_or_create_location
CREATE OR REPLACE FUNCTION public.get_or_create_location(p_location_name text, p_project_id uuid)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_location_id uuid;
BEGIN
  IF p_location_name IS NULL OR p_location_name = '' THEN RETURN NULL; END IF;

  SELECT id INTO v_location_id FROM public.locations WHERE name = p_location_name LIMIT 1;

  IF v_location_id IS NULL THEN
    INSERT INTO public.locations (name, user_id) 
    VALUES (p_location_name, auth.uid()) 
    RETURNING id INTO v_location_id;
  END IF;

  IF p_project_id IS NOT NULL THEN
    PERFORM 1 FROM public.location_projects lp WHERE lp.location_id = v_location_id AND lp.project_id = p_project_id;
    IF NOT FOUND THEN
      -- 【加固点】
      INSERT INTO public.location_projects (location_id, project_id, user_id) 
      VALUES (v_location_id, p_project_id, auth.uid());
    END IF;
  END IF;

  RETURN v_location_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.get_or_create_location_and_link_project
CREATE OR REPLACE FUNCTION public.get_or_create_location_and_link_project(p_location_name text, p_project_id uuid, p_user_id uuid DEFAULT auth.uid())
 RETURNS void
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    v_location_id uuid;
BEGIN
    -- 1. 尝试根据名称查找现有地点
    SELECT id INTO v_location_id FROM locations WHERE name = p_location_name LIMIT 1;

    -- 2. 如果找不到，则创建新地点
    IF v_location_id IS NULL THEN
        INSERT INTO locations (name, user_id)
        VALUES (p_location_name, p_user_id)
        RETURNING id INTO v_location_id;
    END IF;

    -- 3. 确保地点与项目的关联存在
    INSERT INTO location_projects (location_id, project_id, user_id)
    VALUES (v_location_id, p_project_id, p_user_id)
    ON CONFLICT (location_id, project_id) DO NOTHING;

END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.get_or_create_location_with_project
CREATE OR REPLACE FUNCTION public.get_or_create_location_with_project(p_location_name text, p_project_id uuid)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  location_id uuid;
BEGIN
  IF p_location_name IS NULL OR p_location_name = '' THEN RETURN NULL; END IF;
  
  SELECT id INTO location_id 
  FROM public.locations 
  WHERE name = p_location_name 
  LIMIT 1;
  
  IF location_id IS NULL THEN
    -- 【加固点 1】
    INSERT INTO public.locations (name, user_id) 
    VALUES (p_location_name, auth.uid()) 
    RETURNING id INTO location_id;
  END IF;
  
  -- 【加固点 2】
  INSERT INTO public.location_projects (location_id, project_id, user_id)
  VALUES (location_id, p_project_id, auth.uid())
  ON CONFLICT (location_id, project_id) DO NOTHING;
  
  RETURN location_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.get_or_create_locations_batch
CREATE OR REPLACE FUNCTION public.get_or_create_locations_batch(p_location_strings text[])
 RETURNS text[]
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result text[][] := ARRAY[]::text[][];
    location_string text;
    location_ids text[];
BEGIN
    -- 处理每个地点字符串
    FOREACH location_string IN ARRAY p_location_strings LOOP
        location_ids := public.get_or_create_locations_from_string(location_string);
        result := result || location_ids;
    END LOOP;
    
    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- 函数: public.get_or_create_locations_batch_v2
CREATE OR REPLACE FUNCTION public.get_or_create_locations_batch_v2(p_location_strings text[])
 RETURNS text[]
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result text[][] := ARRAY[]::text[][];
    location_string text;
    location_ids text[];
BEGIN
    -- 处理每个地点字符串
    FOREACH location_string IN ARRAY p_location_strings LOOP
        location_ids := public.get_or_create_locations_from_string_v2(location_string);
        result := result || location_ids;
    END LOOP;
    
    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.get_or_create_locations_from_string
CREATE OR REPLACE FUNCTION public.get_or_create_locations_from_string(p_location_string text)
 RETURNS text[]
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    location_names text[];
    location_ids text[] := ARRAY[]::text[];
    location_name text;
    location_id text;
    existing_location record;
BEGIN
    -- 解析地点字符串
    location_names := public.parse_location_string(p_location_string);
    
    -- 处理每个地点
    FOREACH location_name IN ARRAY location_names LOOP
        -- 查找现有地点
        SELECT id INTO existing_location
        FROM public.locations 
        WHERE name = location_name;
        
        IF existing_location IS NOT NULL THEN
            -- 地点已存在，使用现有ID
            location_id := existing_location.id::text;
        ELSE
            -- 地点不存在，创建新地点（只使用存在的字段）
            INSERT INTO public.locations (name, created_at)
            VALUES (location_name, NOW())
            RETURNING id::text INTO location_id;
        END IF;
        
        -- 添加到结果数组
        location_ids := location_ids || location_id;
    END LOOP;
    
    RETURN location_ids;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.get_or_create_locations_from_string_v2
CREATE OR REPLACE FUNCTION public.get_or_create_locations_from_string_v2(p_location_string text)
 RETURNS text[]
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    location_names text[];
    location_ids text[] := ARRAY[]::text[];
    location_name text;
    location_id text;
    existing_location record;
BEGIN
    -- 解析地点字符串
    location_names := public.parse_location_string_v2(p_location_string);
    
    -- 处理每个地点
    FOREACH location_name IN ARRAY location_names LOOP
        -- 查找现有地点
        SELECT id INTO existing_location
        FROM public.locations 
        WHERE name = location_name;
        
        IF existing_location IS NOT NULL THEN
            -- 地点已存在，使用现有ID
            location_id := existing_location.id::text;
        ELSE
            -- 地点不存在，创建新地点（只使用存在的字段）
            INSERT INTO public.locations (name, created_at)
            VALUES (location_name, NOW())
            RETURNING id::text INTO location_id;
        END IF;
        
        -- 添加到结果数组
        location_ids := location_ids || location_id;
    END LOOP;
    
    RETURN location_ids;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.get_paginated_logistics_records
CREATE OR REPLACE FUNCTION public.get_paginated_logistics_records(p_page_size integer, p_offset integer, p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_search_query text DEFAULT NULL::text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
    v_total_count integer;
    search_query_like text;
BEGIN
    -- Prepare search query for LIKE operations
    search_query_like := '%' || COALESCE(p_search_query, '') || '%';

    -- Count total records matching filters
    SELECT COUNT(*)
    INTO v_total_count
    FROM public.logistics_records_view v
    WHERE
        (p_start_date IS NULL OR v.loading_date >= p_start_date::timestamp with time zone) AND
        (p_end_date IS NULL OR v.loading_date <= (p_end_date::date + interval '1 day - 1 second')::timestamp with time zone) AND
        (p_search_query IS NULL OR p_search_query = '' OR (
            v.auto_number ILIKE search_query_like OR
            v.project_name ILIKE search_query_like OR
            v.driver_name ILIKE search_query_like OR
            v.loading_location ILIKE search_query_like OR
            v.unloading_location ILIKE search_query_like
        ));

    -- Get paginated records
    SELECT jsonb_build_object(
        'total_count', v_total_count,
        'records', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.created_at DESC), '[]'::jsonb)
            FROM (
                SELECT *
                FROM public.logistics_records_view v
                WHERE
                    (p_start_date IS NULL OR v.loading_date >= p_start_date::timestamp with time zone) AND
                    (p_end_date IS NULL OR v.loading_date <= (p_end_date::date + interval '1 day - 1 second')::timestamp with time zone) AND
                    (p_search_query IS NULL OR p_search_query = '' OR (
                        v.auto_number ILIKE search_query_like OR
                        v.project_name ILIKE search_query_like OR
                        v.driver_name ILIKE search_query_like OR
                        v.loading_location ILIKE search_query_like OR
                        v.unloading_location ILIKE search_query_like
                    ))
                ORDER BY v.created_at DESC
                LIMIT p_page_size
                OFFSET p_offset
            ) t
        )
    )
    INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_paginated_logistics_records_with_filters
CREATE OR REPLACE FUNCTION public.get_paginated_logistics_records_with_filters(p_page_size integer, p_offset integer, p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_search_query text DEFAULT NULL::text, p_project_id uuid DEFAULT NULL::uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
    v_total_count integer;
    search_query_like text;
BEGIN
    -- Prepare search query for LIKE operations
    search_query_like := '%' || COALESCE(p_search_query, '') || '%';

    -- Count total records matching filters
    SELECT COUNT(*)
    INTO v_total_count
    FROM public.logistics_records_view v
    WHERE
        (p_start_date IS NULL OR v.loading_date >= p_start_date::timestamp with time zone) AND
        (p_end_date IS NULL OR v.loading_date <= (p_end_date::date + interval '1 day - 1 second')::timestamp with time zone) AND
        (p_project_id IS NULL OR v.project_id = p_project_id) AND
        (p_search_query IS NULL OR p_search_query = '' OR (
            v.auto_number ILIKE search_query_like OR
            v.project_name ILIKE search_query_like OR
            v.driver_name ILIKE search_query_like OR
            v.loading_location ILIKE search_query_like OR
            v.unloading_location ILIKE search_query_like
        ));

    -- Get paginated records
    SELECT jsonb_build_object(
        'total_count', v_total_count,
        'records', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.created_at DESC), '[]'::jsonb)
            FROM (
                SELECT *
                FROM public.logistics_records_view v
                WHERE
                    (p_start_date IS NULL OR v.loading_date >= p_start_date::timestamp with time zone) AND
                    (p_end_date IS NULL OR v.loading_date <= (p_end_date::date + interval '1 day - 1 second')::timestamp with time zone) AND
                    (p_project_id IS NULL OR v.project_id = p_project_id) AND
                    (p_search_query IS NULL OR p_search_query = '' OR (
                        v.auto_number ILIKE search_query_like OR
                        v.project_name ILIKE search_query_like OR
                        v.driver_name ILIKE search_query_like OR
                        v.loading_location ILIKE search_query_like OR
                        v.unloading_location ILIKE search_query_like
                    ))
                ORDER BY v.created_at DESC
                LIMIT p_page_size
                OFFSET p_offset
            ) t
        )
    )
    INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_partner_payables_summary
CREATE OR REPLACE FUNCTION public.get_partner_payables_summary(p_project_id uuid DEFAULT NULL::uuid, p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_partner_id uuid DEFAULT NULL::uuid)
 RETURNS TABLE(partner_id uuid, partner_name text, level integer, total_payable numeric, records_count bigint)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    lpc.partner_id,
    p.name as partner_name,
    lpc.level,
    SUM(lpc.payable_amount) as total_payable,
    COUNT(DISTINCT lpc.logistics_record_id) as records_count
  FROM public.logistics_partner_costs lpc
  JOIN public.partners p ON lpc.partner_id = p.id
  JOIN public.logistics_records lr ON lpc.logistics_record_id = lr.id
  WHERE 
    (p_project_id IS NULL OR lr.project_id = p_project_id) AND
    (p_start_date IS NULL OR lr.loading_date >= p_start_date) AND
    (p_end_date IS NULL OR lr.loading_date <= p_end_date) AND
    (p_partner_id IS NULL OR lpc.partner_id = p_partner_id)
  GROUP BY lpc.partner_id, p.name, lpc.level
  ORDER BY lpc.level ASC;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.get_partner_ranking
CREATE OR REPLACE FUNCTION public.get_partner_ranking()
 RETURNS TABLE(partner_name text, total_payable numeric)
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    WITH highest_level_costs AS (
        SELECT
            DISTINCT ON (lpc.logistics_record_id)
            lpc.partner_id,
            lpc.payable_amount
        FROM
            public.logistics_partner_costs lpc
        ORDER BY
            lpc.logistics_record_id,
            lpc.level DESC
    )
    SELECT
        p.name AS partner_name,
        SUM(h.payable_amount) AS total_payable
    FROM
        highest_level_costs h
    JOIN
        public.partners p ON h.partner_id = p.id
    GROUP BY
        p.name
    ORDER BY
        total_payable DESC
    LIMIT 10;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.get_payment_invoice_data
CREATE OR REPLACE FUNCTION public.get_payment_invoice_data(p_project_ids uuid[] DEFAULT NULL::uuid[], p_partner_ids uuid[] DEFAULT NULL::uuid[], p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_page_number integer DEFAULT 1, p_page_size integer DEFAULT 50)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_offset INTEGER;
  v_result JSONB;
BEGIN
  v_offset := (p_page_number - 1) * p_page_size;

  WITH logistics_with_payments AS (
    SELECT 
      lr.id,
      lr.auto_number,
      lr.project_name,
      lr.driver_name,
      lr.loading_location,
      lr.unloading_location,
      lr.loading_date,
      lr.loading_weight,
      lr.unloading_weight,
      -- 合作方成本信息
      lpc.partner_id,
      p.name as partner_name,
      lpc.level,
      lpc.payable_amount as partner_payable,
      -- 付款信息汇总
      COALESCE(payment_summary.total_paid, 0) as paid_amount,
      COALESCE(payment_summary.latest_payment_date, NULL) as latest_payment_date,
      -- 开票信息汇总  
      COALESCE(invoice_summary.total_invoiced, 0) as invoiced_amount,
      COALESCE(invoice_summary.latest_invoice_date, NULL) as latest_invoice_date,
      -- 状态计算
      CASE 
        WHEN COALESCE(payment_summary.total_paid, 0) >= lpc.payable_amount THEN '已付款'
        WHEN COALESCE(payment_summary.total_paid, 0) > 0 THEN '部分付款'
        ELSE '待付款'
      END as payment_status,
      CASE 
        WHEN COALESCE(invoice_summary.total_invoiced, 0) >= lpc.payable_amount THEN '已开票'
        WHEN COALESCE(invoice_summary.total_invoiced, 0) > 0 THEN '部分开票'
        ELSE '待开票'
      END as invoice_status
    FROM logistics_records lr
    LEFT JOIN logistics_partner_costs lpc ON lr.id = lpc.logistics_record_id
    LEFT JOIN partners p ON lpc.partner_id = p.id
    -- 付款汇总子查询
    LEFT JOIN (
      SELECT 
        logistics_record_id,
        partner_id,
        SUM(payment_amount) as total_paid,
        MAX(payment_date) as latest_payment_date
      FROM payment_records 
      GROUP BY logistics_record_id, partner_id
    ) payment_summary ON lr.id = payment_summary.logistics_record_id AND lpc.partner_id = payment_summary.partner_id
    -- 开票汇总子查询
    LEFT JOIN (
      SELECT 
        logistics_record_id,
        partner_id,
        SUM(invoice_amount) as total_invoiced,
        MAX(invoice_date) as latest_invoice_date
      FROM invoice_records 
      GROUP BY logistics_record_id, partner_id
    ) invoice_summary ON lr.id = invoice_summary.logistics_record_id AND lpc.partner_id = invoice_summary.partner_id
    WHERE 
      (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids)) AND
      (p_partner_ids IS NULL OR lpc.partner_id = ANY(p_partner_ids)) AND
      (p_start_date IS NULL OR lr.loading_date >= p_start_date::date) AND
      (p_end_date IS NULL OR lr.loading_date <= p_end_date::date)
  ),
  paginated_records AS (
    SELECT *
    FROM logistics_with_payments
    ORDER BY loading_date DESC, auto_number DESC
    LIMIT p_page_size
    OFFSET v_offset
  ),
  total_count AS (
    SELECT COUNT(*) as count FROM logistics_with_payments
  )
  SELECT JSONB_BUILD_OBJECT(
    'records', COALESCE(JSONB_AGG(
      JSONB_BUILD_OBJECT(
        'id', pr.id,
        'auto_number', pr.auto_number,
        'project_name', pr.project_name,
        'partner_id', pr.partner_id,
        'partner_name', pr.partner_name,
        'driver_name', pr.driver_name,
        'loading_date', TO_CHAR(pr.loading_date, 'YYYY-MM-DD'),
        'route', CONCAT(pr.loading_location, ' → ', pr.unloading_location),
        'loading_weight', pr.loading_weight,
        'partner_payable', pr.partner_payable,
        'paid_amount', pr.paid_amount,
        'invoiced_amount', pr.invoiced_amount,
        'pending_payment', (pr.partner_payable - pr.paid_amount),
        'pending_invoice', (pr.partner_payable - pr.invoiced_amount),
        'payment_status', pr.payment_status,
        'invoice_status', pr.invoice_status,
        'latest_payment_date', pr.latest_payment_date,
        'latest_invoice_date', pr.latest_invoice_date,
        'level', pr.level
      )
    ), '[]'::JSONB),
    'total_count', (SELECT count FROM total_count),
    'summary', (
      SELECT JSONB_BUILD_OBJECT(
        'total_records', COUNT(*),
        'total_payable', SUM(partner_payable),
        'total_paid', SUM(paid_amount),
        'total_invoiced', SUM(invoiced_amount),
        'total_pending_payment', SUM(partner_payable - paid_amount),
        'total_pending_invoice', SUM(partner_payable - invoiced_amount)
      )
      FROM logistics_with_payments
    )
  )
  INTO v_result
  FROM paginated_records pr, total_count;

  RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.get_payment_invoice_data_optimized
CREATE OR REPLACE FUNCTION public.get_payment_invoice_data_optimized(p_project_ids uuid[] DEFAULT NULL::uuid[], p_partner_ids uuid[] DEFAULT NULL::uuid[], p_start_date text DEFAULT NULL::text, p_end_date text DEFAULT NULL::text, p_page_number integer DEFAULT 1, p_page_size integer DEFAULT 20)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
  v_offset INTEGER;
  v_result JSONB;
BEGIN
  v_offset := (p_page_number - 1) * p_page_size;

  WITH logistics_with_payments AS (
    SELECT 
      lr.id,
      lr.auto_number,
      lr.project_name,
      lr.driver_name,
      lr.loading_location,
      lr.unloading_location,
      lr.loading_date,
      lr.loading_weight,
      lr.unloading_weight,
      lr.billing_type_id, -- 添加billing_type_id字段
      -- 合作方成本信息
      lpc.partner_id,
      p.name as partner_name,
      lpc.level,
      lpc.payable_amount as partner_payable,
      -- 付款信息汇总
      COALESCE(payment_summary.total_paid, 0) as paid_amount,
      COALESCE(payment_summary.latest_payment_date, NULL) as latest_payment_date,
      -- 开票信息汇总  
      COALESCE(invoice_summary.total_invoiced, 0) as invoiced_amount,
      COALESCE(invoice_summary.latest_invoice_date, NULL) as latest_invoice_date,
      -- 状态计算
      CASE 
        WHEN COALESCE(payment_summary.total_paid, 0) >= lpc.payable_amount THEN '已付款'
        WHEN COALESCE(payment_summary.total_paid, 0) > 0 THEN '部分付款'
        ELSE '待付款'
      END as payment_status,
      CASE 
        WHEN COALESCE(invoice_summary.total_invoiced, 0) >= lpc.payable_amount THEN '已开票'
        WHEN COALESCE(invoice_summary.total_invoiced, 0) > 0 THEN '部分开票'
        ELSE '待开票'
      END as invoice_status
    FROM logistics_records lr
    LEFT JOIN logistics_partner_costs lpc ON lr.id = lpc.logistics_record_id
    LEFT JOIN partners p ON lpc.partner_id = p.id
    -- 优化的付款汇总子查询
    LEFT JOIN (
      SELECT 
        logistics_record_id,
        partner_id,
        SUM(payment_amount) as total_paid,
        MAX(payment_date) as latest_payment_date
      FROM payment_records 
      WHERE payment_date >= COALESCE(p_start_date::date, '1900-01-01'::date)
        AND payment_date <= COALESCE(p_end_date::date, '2999-12-31'::date)
      GROUP BY logistics_record_id, partner_id
    ) payment_summary ON lr.id = payment_summary.logistics_record_id AND lpc.partner_id = payment_summary.partner_id
    -- 优化的开票汇总子查询
    LEFT JOIN (
      SELECT 
        logistics_record_id,
        partner_id,
        SUM(invoice_amount) as total_invoiced,
        MAX(invoice_date) as latest_invoice_date
      FROM invoice_records 
      WHERE invoice_date >= COALESCE(p_start_date::date, '1900-01-01'::date)
        AND invoice_date <= COALESCE(p_end_date::date, '2999-12-31'::date)
      GROUP BY logistics_record_id, partner_id
    ) invoice_summary ON lr.id = invoice_summary.logistics_record_id AND lpc.partner_id = invoice_summary.partner_id
    WHERE 
      (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids)) AND
      (p_partner_ids IS NULL OR lpc.partner_id = ANY(p_partner_ids)) AND
      (p_start_date IS NULL OR lr.loading_date >= p_start_date::date) AND
      (p_end_date IS NULL OR lr.loading_date <= p_end_date::date)
  ),
  paginated_records AS (
    SELECT *
    FROM logistics_with_payments
    ORDER BY loading_date DESC, auto_number DESC
    LIMIT p_page_size
    OFFSET v_offset
  ),
  total_count AS (
    SELECT COUNT(*) as count FROM logistics_with_payments
  )
  SELECT JSONB_BUILD_OBJECT(
    'records', COALESCE(JSONB_AGG(
      JSONB_BUILD_OBJECT(
        'id', pr.id,
        'auto_number', pr.auto_number,
        'project_name', pr.project_name,
        'partner_id', pr.partner_id,
        'partner_name', pr.partner_name,
        'driver_name', pr.driver_name,
        'loading_date', TO_CHAR(pr.loading_date, 'YYYY-MM-DD'),
        'route', CONCAT(pr.loading_location, ' → ', pr.unloading_location),
        'loading_weight', pr.loading_weight,
        'unloading_weight', pr.unloading_weight,
        'billing_type_id', pr.billing_type_id, -- 包含billing_type_id
        'partner_payable', pr.partner_payable,
        'paid_amount', pr.paid_amount,
        'invoiced_amount', pr.invoiced_amount,
        'pending_payment', (pr.partner_payable - pr.paid_amount),
        'pending_invoice', (pr.partner_payable - pr.invoiced_amount),
        'payment_status', pr.payment_status,
        'invoice_status', pr.invoice_status,
        'latest_payment_date', pr.latest_payment_date,
        'latest_invoice_date', pr.latest_invoice_date,
        'level', pr.level
      )
    ), '[]'::JSONB),
    'total_count', (SELECT count FROM total_count),
    'current_page', p_page_number,
    'total_pages', CASE 
      WHEN (SELECT count FROM total_count) = 0 THEN 1 
      ELSE CEIL((SELECT count FROM total_count)::float / p_page_size::float)::integer 
    END,
    'summary', (
      SELECT JSONB_BUILD_OBJECT(
        'total_records', COUNT(*),
        'total_payable', SUM(partner_payable),
        'total_paid', SUM(paid_amount),
        'total_invoiced', SUM(invoiced_amount),
        'total_pending_payment', SUM(partner_payable - paid_amount),
        'total_pending_invoice', SUM(partner_payable - invoiced_amount)
      )
      FROM logistics_with_payments
    )
  )
  INTO v_result
  FROM paginated_records pr, total_count;

  RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.get_payment_request_data
CREATE OR REPLACE FUNCTION public.get_payment_request_data(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid, p_payment_status_array text[] DEFAULT NULL::text[], p_page_size integer DEFAULT 50, p_page_number integer DEFAULT 1)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$DECLARE
    result_json jsonb;
    v_offset integer;
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;

    WITH filtered_records AS (
        SELECT v.*, lr.payment_status
        FROM public.logistics_records_view AS v
        JOIN public.logistics_records lr ON v.id = lr.id
        WHERE
            (p_project_id IS NULL OR v.project_id = p_project_id) AND
            (p_start_date IS NULL OR v.loading_date::date >= p_start_date) AND
            (p_end_date IS NULL OR v.loading_date::date <= p_end_date) AND
            (
                p_payment_status_array IS NULL OR
                array_length(p_payment_status_array, 1) IS NULL OR
                LOWER(lr.payment_status) = ANY(ARRAY(SELECT lower(unnest) FROM unnest(p_payment_status_array)))
            ) AND
            (p_partner_id IS NULL OR EXISTS (
                SELECT 1 FROM public.logistics_partner_costs lpc
                WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
            ))
    ),
    paginated_records AS (
        SELECT id
        FROM filtered_records
        ORDER BY loading_date DESC
        LIMIT p_page_size
        OFFSET v_offset
    )
    SELECT jsonb_build_object(
        'count', (SELECT COUNT(*) FROM filtered_records),
        'overview', (
            SELECT jsonb_build_object(
                'total_records', COALESCE(COUNT(*), 0),
                'total_current_cost', COALESCE(SUM(current_cost), 0),
                'total_extra_cost', COALESCE(SUM(extra_cost), 0),
                'total_payable_cost', COALESCE(SUM(payable_cost), 0)
            )
            FROM filtered_records
        ),
        'partner_payables', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.partner_name), '[]'::jsonb) FROM (
                SELECT
                    lpc.partner_id, p.name AS partner_name,
                    COUNT(DISTINCT lpc.logistics_record_id) AS records_count,
                    SUM(lpc.payable_amount) AS total_payable
                FROM public.logistics_partner_costs lpc
                JOIN public.partners p ON lpc.partner_id = p.id
                WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
                GROUP BY lpc.partner_id, p.name
            ) t
        ),
        'records', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.loading_date DESC), '[]'::jsonb) FROM (
                SELECT
                    v.id, v.auto_number, v.project_name, v.driver_name, v.loading_location, v.unloading_location,
                    to_char(v.loading_date, 'YYYY-MM-DD') AS loading_date,
                    to_char(v.unloading_date, 'YYYY-MM-DD') AS unloading_date,
                    v.loading_weight, v.unloading_weight, v.current_cost, v.payable_cost, v.extra_cost,
                    v.license_plate, v.driver_phone, v.transport_type, v.remarks, v.chain_name,
                    v.payment_status,
                    v.billing_type_id,
                    (SELECT COALESCE(jsonb_agg(sub ORDER BY sub.level), '[]'::jsonb) FROM (
                        SELECT lpc.partner_id, par.name AS partner_name, lpc.level, lpc.payable_amount
                        FROM public.logistics_partner_costs lpc
                        JOIN public.partners par ON lpc.partner_id = par.id
                        WHERE lpc.logistics_record_id = v.id
                     ) sub
                    ) AS partner_costs
                FROM filtered_records v
                WHERE v.id IN (SELECT id FROM paginated_records)
            ) t
        )
    )
    INTO result_json;

    RETURN result_json;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.get_payment_request_data_0827
CREATE OR REPLACE FUNCTION public.get_payment_request_data_0827(p_project_id uuid, p_start_date date, p_end_date date, p_partner_id uuid, p_payment_status_array text[], p_page_size integer, p_page_number integer)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$DECLARE
    result_json jsonb;
    v_offset integer;
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;

    WITH filtered_records AS (
        SELECT v.*, lr.payment_status
        FROM public.logistics_records_view AS v
        JOIN public.logistics_records lr ON v.id = lr.id
        WHERE
            (p_project_id IS NULL OR v.project_id = p_project_id) AND
            (p_start_date IS NULL OR v.loading_date::date >= p_start_date) AND
            (p_end_date IS NULL OR v.loading_date::date <= p_end_date) AND
            -- 【终极大小写修复】将数据库中的状态和传入的状态数组全部转为小写进行比较，
            -- 从而最终、决定性地、无可辩驳地解决大小写不一致导致的筛选失败问题。
            (
                p_payment_status_array IS NULL OR
                array_length(p_payment_status_array, 1) IS NULL OR
                LOWER(lr.payment_status) = ANY(ARRAY(SELECT lower(unnest) FROM unnest(p_payment_status_array)))
            ) AND
            (p_partner_id IS NULL OR EXISTS (
                SELECT 1 FROM public.logistics_partner_costs lpc
                WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
            ))
    ),
    paginated_records AS (
        SELECT id
        FROM filtered_records
        ORDER BY loading_date DESC
        LIMIT p_page_size
        OFFSET v_offset
    )
    SELECT jsonb_build_object(
        'count', (SELECT COUNT(*) FROM filtered_records),
        'overview', (
            SELECT jsonb_build_object(
                'total_records', COALESCE(COUNT(*), 0),
                'total_current_cost', COALESCE(SUM(current_cost), 0),
                'total_extra_cost', COALESCE(SUM(extra_cost), 0),
                'total_payable_cost', COALESCE(SUM(payable_cost), 0)
            )
            FROM filtered_records
        ),
        'partner_payables', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.partner_name), '[]'::jsonb) FROM (
                SELECT
                    lpc.partner_id, p.name AS partner_name,
                    COUNT(DISTINCT lpc.logistics_record_id) AS records_count,
                    SUM(lpc.payable_amount) AS total_payable
                FROM public.logistics_partner_costs lpc
                JOIN public.partners p ON lpc.partner_id = p.id
                WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
                GROUP BY lpc.partner_id, p.name
            ) t
        ),
        'records', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.loading_date DESC), '[]'::jsonb) FROM (
                SELECT
                    v.id, v.auto_number, v.project_name, v.driver_name, v.loading_location, v.unloading_location,
                    to_char(v.loading_date, 'YYYY-MM-DD') AS loading_date,
                    to_char(v.unloading_date, 'YYYY-MM-DD') AS unloading_date,
                    v.loading_weight, v.unloading_weight, v.current_cost, v.payable_cost, v.extra_cost,
                    v.license_plate, v.driver_phone, v.transport_type, v.remarks, v.chain_name,
                    v.payment_status,
                    (SELECT COALESCE(jsonb_agg(sub ORDER BY sub.level), '[]'::jsonb) FROM (
                        SELECT lpc.partner_id, par.name AS partner_name, lpc.level, lpc.payable_amount
                        FROM public.logistics_partner_costs lpc
                        JOIN public.partners par ON lpc.partner_id = par.id
                        WHERE lpc.logistics_record_id = v.id
                     ) sub
                    ) AS partner_costs
                FROM filtered_records v
                WHERE v.id IN (SELECT id FROM paginated_records)
            ) t
        )
    )
    INTO result_json;

    RETURN result_json;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.get_payment_request_data_925
CREATE OR REPLACE FUNCTION public.get_payment_request_data_925(p_project_id uuid, p_start_date date, p_end_date date, p_partner_id uuid, p_payment_status_array text[], p_page_size integer, p_page_number integer, p_driver_names text[])
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$DECLARE
    result_json jsonb;
    v_offset integer;
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;

    WITH filtered_records AS (
        SELECT v.*, lr.payment_status
        FROM public.logistics_records_view AS v
        JOIN public.logistics_records lr ON v.id = lr.id
        WHERE
            (p_project_id IS NULL OR v.project_id = p_project_id) AND
            (p_start_date IS NULL OR v.loading_date::date >= p_start_date) AND
            (p_end_date IS NULL OR v.loading_date::date <= p_end_date) AND
            (
                p_payment_status_array IS NULL OR
                array_length(p_payment_status_array, 1) IS NULL OR
                LOWER(lr.payment_status) = ANY(ARRAY(SELECT lower(unnest) FROM unnest(p_payment_status_array)))
            ) AND
            (p_partner_id IS NULL OR EXISTS (
                SELECT 1 FROM public.logistics_partner_costs lpc
                WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
            )) AND
            -- 新增：司机姓名筛选逻辑
            (p_driver_names IS NULL OR v.driver_name = ANY(p_driver_names))
    ),
    paginated_records AS (
        SELECT id
        FROM filtered_records
        ORDER BY loading_date DESC
        LIMIT p_page_size
        OFFSET v_offset
    )
    SELECT jsonb_build_object(
        'count', (SELECT COUNT(*) FROM filtered_records),
        'overview', (
            SELECT jsonb_build_object(
                'total_records', COALESCE(COUNT(*), 0),
                'total_current_cost', COALESCE(SUM(current_cost), 0),
                'total_extra_cost', COALESCE(SUM(extra_cost), 0),
                'total_payable_cost', COALESCE(SUM(payable_cost), 0)
            )
            FROM filtered_records
        ),
        'partner_payables', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.partner_name), '[]'::jsonb) FROM (
                SELECT
                    lpc.partner_id, p.name AS partner_name,
                    COUNT(DISTINCT lpc.logistics_record_id) AS records_count,
                    SUM(lpc.payable_amount) AS total_payable
                FROM public.logistics_partner_costs lpc
                JOIN public.partners p ON lpc.partner_id = p.id
                WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
                GROUP BY lpc.partner_id, p.name
            ) t
        ),
        'records', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.loading_date DESC), '[]'::jsonb) FROM (
                SELECT
                    v.id, v.auto_number, v.project_name, v.driver_name, v.loading_location, v.unloading_location,
                    to_char(v.loading_date, 'YYYY-MM-DD') AS loading_date,
                    to_char(v.unloading_date, 'YYYY-MM-DD') AS unloading_date,
                    v.loading_weight, v.unloading_weight, v.current_cost, v.payable_cost, v.extra_cost,
                    v.license_plate, v.driver_phone, v.transport_type, v.remarks, v.chain_name,
                    v.payment_status,
                    v.billing_type_id, -- 新增：确保返回计费类型ID
                    (SELECT COALESCE(jsonb_agg(sub ORDER BY sub.level), '[]'::jsonb) FROM (
                        SELECT lpc.partner_id, par.name AS partner_name, lpc.level, lpc.payable_amount
                        FROM public.logistics_partner_costs lpc
                        JOIN public.partners par ON lpc.partner_id = par.id
                        WHERE lpc.logistics_record_id = v.id
                     ) sub
                    ) AS partner_costs
                FROM filtered_records v
                WHERE v.id IN (SELECT id FROM paginated_records)
            ) t
        )
    )
    INTO result_json;

    RETURN result_json;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.get_payment_request_data_bak
CREATE OR REPLACE FUNCTION public.get_payment_request_data_bak(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid, p_payment_status_array text[] DEFAULT NULL::text[], p_page_size integer DEFAULT 50, p_page_number integer DEFAULT 1)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$DECLARE
    result_json jsonb;
    v_offset integer;
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;

    WITH filtered_records AS (
        SELECT v.id
        FROM public.logistics_records_view AS v
        -- 关键修复：JOIN 回基表以获取 payment_status
        JOIN public.logistics_records lr ON v.id = lr.id
        WHERE
            (p_project_id IS NULL OR v.project_id = p_project_id) AND
            (p_start_date IS NULL OR v.loading_date::date >= p_start_date) AND
            (p_end_date IS NULL OR v.loading_date::date <= p_end_date) AND
            -- 关键修复：现在从基表 lr 中过滤 payment_status
            (p_payment_status_array IS NULL OR array_length(p_payment_status_array, 1) IS NULL OR lr.payment_status = ANY(p_payment_status_array)) AND
            (p_partner_id IS NULL OR EXISTS (
                SELECT 1 FROM public.logistics_partner_costs lpc
                WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
            ))
    ),
    paginated_records AS (
        SELECT id
        FROM filtered_records
        ORDER BY (SELECT loading_date FROM public.logistics_records WHERE id = filtered_records.id) DESC
        LIMIT p_page_size
        OFFSET v_offset
    )
    SELECT jsonb_build_object(
        'count', (SELECT COUNT(*) FROM filtered_records),
        'overview', (
            SELECT jsonb_build_object(
                'total_records', COALESCE(COUNT(*), 0),
                'total_current_cost', COALESCE(SUM(current_cost), 0),
                'total_extra_cost', COALESCE(SUM(extra_cost), 0),
                'total_payable_cost', COALESCE(SUM(payable_cost), 0)
            )
            FROM public.logistics_records
            WHERE id IN (SELECT id FROM filtered_records)
        ),
        'partner_payables', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.partner_name), '[]'::jsonb) FROM (
                SELECT
                    lpc.partner_id, p.name AS partner_name,
                    COUNT(DISTINCT lpc.logistics_record_id) AS records_count,
                    SUM(lpc.payable_amount) AS total_payable
                FROM public.logistics_partner_costs lpc
                JOIN public.partners p ON lpc.partner_id = p.id
                WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
                GROUP BY lpc.partner_id, p.name
            ) t
        ),
        'records', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.loading_date DESC), '[]'::jsonb) FROM (
                SELECT
                    v.id, v.auto_number, v.project_name, v.driver_name, v.loading_location, v.unloading_location,
                    to_char(v.loading_date, 'YYYY-MM-DD') AS loading_date,
                    to_char(v.unloading_date, 'YYYY-MM-DD') AS unloading_date,
                    v.loading_weight, v.unloading_weight, v.current_cost, v.payable_cost, v.extra_cost,
                    v.license_plate, v.driver_phone, v.transport_type, v.remarks, v.chain_name,
                    -- 关键修复：从基表 lr 中获取 payment_status
                    lr.payment_status,
                    (SELECT COALESCE(jsonb_agg(sub ORDER BY sub.level), '[]'::jsonb) FROM (
                        SELECT lpc.partner_id, par.name AS partner_name, lpc.level, lpc.payable_amount
                        FROM public.logistics_partner_costs lpc
                        JOIN public.partners par ON lpc.partner_id = par.id
                        WHERE lpc.logistics_record_id = v.id
                     ) sub
                    ) AS partner_costs
                FROM public.logistics_records_view v
                -- 关键修复：再次 JOIN 基表以在最终输出中包含 payment_status
                JOIN public.logistics_records lr ON v.id = lr.id
                WHERE v.id IN (SELECT id FROM paginated_records)
            ) t
        )
    )
    INTO result_json;

    RETURN result_json;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.get_payment_request_data_v2
CREATE OR REPLACE FUNCTION public.get_payment_request_data_v2(p_record_ids uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
    v_can_view boolean := public.is_finance_or_admin();
BEGIN
    SELECT jsonb_build_object(
        'records', COALESCE(jsonb_agg(
            jsonb_build_object(
                'id', v.id,
                'auto_number', v.auto_number,
                'project_name', v.project_name,
                'driver_name', v.driver_name,
                'loading_location', v.loading_location,
                'unloading_location', v.unloading_location,
                'loading_date', to_char(v.loading_date, 'YYYY-MM-DD'),
                'unloading_date', COALESCE(to_char(v.unloading_date, 'YYYY-MM-DD'), null),
                'loading_weight', v.loading_weight,
                'unloading_weight', v.unloading_weight,
                'current_cost', v.current_cost,
                'extra_cost', v.extra_cost,
                'payable_cost', v.payable_cost,
                'license_plate', v.license_plate,
                'driver_phone', v.driver_phone,
                'transport_type', v.transport_type,
                'remarks', v.remarks,
                'chain_name', v.chain_name,
                'cargo_type', lr.cargo_type,
                'payment_status', lr.payment_status,
                'partner_costs', (
                    SELECT COALESCE(jsonb_agg(
                        jsonb_build_object(
                            'partner_id', lpc.partner_id,
                            'partner_name', p.name,
                            'level', lpc.level,
                            'payable_amount', lpc.payable_amount,
                            'full_name', CASE WHEN v_can_view THEN p.full_name ELSE NULL END,
                            'bank_account', CASE WHEN v_can_view THEN bd.bank_account ELSE NULL END,
                            'bank_name', CASE WHEN v_can_view THEN bd.bank_name ELSE NULL END,
                            'branch_name', CASE WHEN v_can_view THEN bd.branch_name ELSE NULL END
                        ) ORDER BY lpc.level
                    ), '[]'::jsonb)
                    FROM public.logistics_partner_costs lpc
                    JOIN public.partners p ON lpc.partner_id = p.id
                    LEFT JOIN public.partner_bank_details bd ON bd.partner_id = p.id
                    WHERE lpc.logistics_record_id = v.id
                )
            ) ORDER BY v.loading_date DESC
        ), '[]'::jsonb)
    )
    INTO result_json
    FROM public.logistics_records_view v
    JOIN public.logistics_records lr ON v.id = lr.id
    WHERE v.id = ANY(p_record_ids);

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- 函数: public.get_payment_request_list
CREATE OR REPLACE FUNCTION public.get_payment_request_list(p_project_id uuid DEFAULT NULL::uuid, p_start_date date DEFAULT NULL::date, p_end_date date DEFAULT NULL::date, p_partner_id uuid DEFAULT NULL::uuid, p_payment_status_array text[] DEFAULT NULL::text[], p_page_size integer DEFAULT 50, p_page_number integer DEFAULT 1)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
    v_offset integer;
BEGIN
    v_offset := (p_page_number - 1) * p_page_size;

    WITH filtered_records AS (
        SELECT v.id
        FROM public.logistics_records_view AS v
        JOIN public.logistics_records lr ON v.id = lr.id
        WHERE
            (p_project_id IS NULL OR v.project_id = p_project_id) AND
            (p_start_date IS NULL OR v.loading_date::date >= p_start_date) AND
            (p_end_date IS NULL OR v.loading_date::date <= p_end_date) AND
            (p_payment_status_array IS NULL OR array_length(p_payment_status_array, 1) IS NULL OR lr.payment_status = ANY(p_payment_status_array)) AND
            (p_partner_id IS NULL OR EXISTS (
                SELECT 1 FROM public.logistics_partner_costs lpc
                WHERE lpc.logistics_record_id = v.id AND lpc.partner_id = p_partner_id
            ))
    ),
    paginated_records AS (
        SELECT id
        FROM filtered_records
        ORDER BY (SELECT loading_date FROM public.logistics_records WHERE id = filtered_records.id) DESC
        LIMIT p_page_size
        OFFSET v_offset
    )
    SELECT jsonb_build_object(
        'count', (SELECT COUNT(*) FROM filtered_records),
        'overview', (
            SELECT jsonb_build_object(
                'total_records', COALESCE(COUNT(*), 0),
                'total_current_cost', COALESCE(SUM(current_cost), 0),
                'total_extra_cost', COALESCE(SUM(extra_cost), 0),
                'total_payable_cost', COALESCE(SUM(payable_cost), 0)
            )
            FROM public.logistics_records
            WHERE id IN (SELECT id FROM filtered_records)
        ),
        'partner_payables', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.partner_name), '[]'::jsonb) FROM (
                SELECT
                    lpc.partner_id, p.name AS partner_name,
                    COUNT(DISTINCT lpc.logistics_record_id) AS records_count,
                    SUM(lpc.payable_amount) AS total_payable
                FROM public.logistics_partner_costs lpc
                JOIN public.partners p ON lpc.partner_id = p.id
                WHERE lpc.logistics_record_id IN (SELECT id FROM filtered_records)
                GROUP BY lpc.partner_id, p.name
            ) t
        ),
        'records', (
            SELECT COALESCE(jsonb_agg(t ORDER BY t.loading_date DESC), '[]'::jsonb) FROM (
                SELECT
                    v.id, v.auto_number, v.project_name, v.driver_name, v.loading_location, v.unloading_location,
                    to_char(v.loading_date, 'YYYY-MM-DD') AS loading_date,
                    to_char(v.unloading_date, 'YYYY-MM-DD') AS unloading_date,
                    v.loading_weight, v.unloading_weight, v.current_cost, v.payable_cost, v.extra_cost,
                    v.license_plate, v.driver_phone, v.transport_type, v.remarks, v.chain_name,
                    lr.payment_status,
                    (SELECT COALESCE(jsonb_agg(sub ORDER BY sub.level), '[]'::jsonb) FROM (
                        SELECT lpc.partner_id, par.name AS partner_name, lpc.level, lpc.payable_amount
                        FROM public.logistics_partner_costs lpc
                        JOIN public.partners par ON lpc.partner_id = par.id
                        WHERE lpc.logistics_record_id = v.id
                     ) sub
                    ) AS partner_costs
                FROM public.logistics_records_view v
                JOIN public.logistics_records lr ON v.id = lr.id
                WHERE v.id IN (SELECT id FROM paginated_records)
            ) t
        )
    )
    INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- 函数: public.get_payment_request_preview
CREATE OR REPLACE FUNCTION public.get_payment_request_preview(p_record_ids uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result_json jsonb;
BEGIN
    WITH relevant_costs AS (
        SELECT
            lpc.logistics_record_id,
            lpc.partner_id,
            lpc.level,
            lpc.payable_amount
        FROM public.logistics_partner_costs lpc
        JOIN public.logistics_records lr ON lpc.logistics_record_id = lr.id
        WHERE
            lpc.logistics_record_id = ANY(p_record_ids)
            AND lr.payment_status = 'Unpaid'
            AND lpc.level > 0
    ),
    aggregated_sheets AS (
        SELECT
            payee.partner_id AS paying_partner_id,
            p_receiver.full_name AS paying_partner_full_name,
            p_receiver.bank_account AS paying_partner_bank_account,
            p_receiver.bank_name AS paying_partner_bank_name,
            COALESCE(p_payer.full_name, '中科智运（云南）供应链科技有限公司') AS header_company_name,
            COUNT(DISTINCT payee.logistics_record_id) AS record_count,
            SUM(payee.payable_amount) AS total_payable
        FROM
            relevant_costs AS payee
        JOIN public.partners AS p_receiver ON payee.partner_id = p_receiver.id
        LEFT JOIN relevant_costs AS payer_cost ON payee.logistics_record_id = payer_cost.logistics_record_id AND payer_cost.level = payee.level - 1
        LEFT JOIN public.partners AS p_payer ON payer_cost.partner_id = p_payer.id
        GROUP BY
            payee.partner_id,
            p_receiver.full_name,
            p_receiver.bank_account,
            p_receiver.bank_name,
            header_company_name
    )
    SELECT jsonb_build_object(
        'sheets', COALESCE(jsonb_agg(s.*), '[]'::jsonb),
        'processed_record_ids', (SELECT COALESCE(array_agg(DISTINCT rc.logistics_record_id), '{}'::uuid[]) FROM relevant_costs rc)
    )
    INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.get_pending_invoicing
CREATE OR REPLACE FUNCTION public.get_pending_invoicing()
 RETURNS numeric
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    total_amount NUMERIC;
BEGIN
    WITH highest_level_costs AS (
        SELECT
            DISTINCT ON (lpc.logistics_record_id)
            lpc.logistics_record_id,
            lpc.payable_amount
        FROM
            public.logistics_partner_costs lpc
        JOIN
            public.logistics_records lr ON lpc.logistics_record_id = lr.id
        WHERE
            lr.payment_status IS NULL OR lr.payment_status NOT IN ('Unpaid', 'Processing')
        ORDER BY
            lpc.logistics_record_id,
            lpc.level DESC -- 按 level 降序排序
    )
    SELECT INTO total_amount SUM(h.payable_amount)
    FROM highest_level_costs h;

    RETURN COALESCE(total_amount, 0);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_pending_payments
CREATE OR REPLACE FUNCTION public.get_pending_payments()
 RETURNS numeric
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    total_amount NUMERIC;
BEGIN
    WITH highest_level_costs AS (
        SELECT
            DISTINCT ON (lpc.logistics_record_id)
            lpc.logistics_record_id,
            lpc.payable_amount
        FROM
            public.logistics_partner_costs lpc
        JOIN
            public.logistics_records lr ON lpc.logistics_record_id = lr.id
        WHERE
            lr.payment_status = 'Unpaid'
        ORDER BY
            lpc.logistics_record_id,
            lpc.level DESC -- 按 level 降序排序
    )
    SELECT INTO total_amount SUM(h.payable_amount)
    FROM highest_level_costs h;

    RETURN COALESCE(total_amount, 0);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.get_permission_stats
CREATE OR REPLACE FUNCTION public.get_permission_stats()
 RETURNS TABLE(total_users bigint, active_users bigint, total_role_templates bigint, total_user_permissions bigint, users_with_custom_permissions bigint)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        (SELECT COUNT(*) FROM profiles) as total_users,
        (SELECT COUNT(*) FROM profiles WHERE is_active = true) as active_users,
        (SELECT COUNT(*) FROM role_permission_templates) as total_role_templates,
        (SELECT COUNT(*) FROM user_permissions) as total_user_permissions,
        (SELECT COUNT(DISTINCT user_id) FROM user_permissions) as users_with_custom_permissions;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.get_permission_sync_status
CREATE OR REPLACE FUNCTION public.get_permission_sync_status()
 RETURNS TABLE(table_name text, last_sync timestamp with time zone, sync_count bigint, minutes_since_sync numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        pss.table_name,
        pss.last_sync,
        pss.sync_count,
        EXTRACT(EPOCH FROM (NOW() - pss.last_sync)) / 60 as minutes_since_sync
    FROM permission_sync_status pss
    ORDER BY pss.last_sync DESC;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.get_platform_usage_statistics
CREATE OR REPLACE FUNCTION public.get_platform_usage_statistics()
 RETURNS TABLE(total_records_with_platforms bigint, total_platform_mentions bigint, unique_platforms bigint, most_used_platform text, most_used_platform_count bigint)
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_total_records BIGINT;
  v_total_mentions BIGINT;
  v_unique_platforms BIGINT;
  v_most_used_platform TEXT;
  v_most_used_count BIGINT;
BEGIN
  -- 计算有平台名称的运单数量
  SELECT COUNT(*) INTO v_total_records
  FROM public.logistics_records
  WHERE other_platform_names IS NOT NULL
  AND array_length(other_platform_names, 1) > 0;
  
  -- 计算平台名称总提及次数
  SELECT COUNT(*) INTO v_total_mentions
  FROM (
    SELECT unnest(other_platform_names) as platform_name
    FROM public.logistics_records
    WHERE other_platform_names IS NOT NULL
    AND array_length(other_platform_names, 1) > 0
  ) t;
  
  -- 计算唯一平台数量
  SELECT COUNT(DISTINCT platform_name) INTO v_unique_platforms
  FROM (
    SELECT unnest(other_platform_names) as platform_name
    FROM public.logistics_records
    WHERE other_platform_names IS NOT NULL
    AND array_length(other_platform_names, 1) > 0
  ) t;
  
  -- 获取最常用的平台
  SELECT platform_name, usage_count
  INTO v_most_used_platform, v_most_used_count
  FROM public.get_all_used_platforms()
  LIMIT 1;
  
  RETURN QUERY
  SELECT 
    v_total_records,
    v_total_mentions,
    v_unique_platforms,
    v_most_used_platform,
    v_most_used_count;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_project_contribution
CREATE OR REPLACE FUNCTION public.get_project_contribution()
 RETURNS TABLE(project_name text, total_receivables numeric)
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    WITH highest_level_costs AS (
        SELECT
            DISTINCT ON (lpc.logistics_record_id)
            lr.project_name,
            lpc.payable_amount
        FROM
            public.logistics_partner_costs lpc
        JOIN
            public.logistics_records lr ON lpc.logistics_record_id = lr.id
        ORDER BY
            lpc.logistics_record_id,
            lpc.level DESC
    )
    SELECT
        h.project_name,
        SUM(h.payable_amount) AS total_receivables
    FROM
        highest_level_costs h
    WHERE
        h.project_name IS NOT NULL
    GROUP BY
        h.project_name
    ORDER BY
        total_receivables DESC;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.get_project_dashboard_data
CREATE OR REPLACE FUNCTION public.get_project_dashboard_data(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$DECLARE
    v_project_details JSON;
    v_daily_report JSON;
    v_seven_day_trend JSON;
    v_summary_stats JSON;
    v_driver_report_table JSON;
BEGIN
    -- 任务1: 获取所有项目的详细信息列表 (已根据数据库结构图修正)
    WITH TopPartner AS (
        SELECT DISTINCT ON (pp.project_id) 
            pp.project_id, 
            p.name AS partner_name, 
            pc.billing_type_id
        FROM public.project_partners AS pp 
        JOIN public.partners AS p ON pp.partner_id = p.id
        -- ★★★ 核心修正: 使用正确的 chain_id 进行关联 ★★★
        JOIN public.partner_chains AS pc ON pp.chain_id = pc.id
        ORDER BY pp.project_id, pp.level DESC
    ), ProjectStartDate AS (
        SELECT project_id, MIN(loading_date)::date AS actual_start_date
        FROM public.logistics_records GROUP BY project_id
    )
    SELECT json_agg(
        json_build_object(
            'id', p.id,
            'name', p.name,
            'partner_name', tp.partner_name,
            'start_date', TO_CHAR(psd.actual_start_date, 'YYYY-MM-DD'),
            'planned_total_tons', p.planned_total_tons,
            'billing_type_id', tp.billing_type_id
        ) ORDER BY p.created_at DESC
    ) INTO v_project_details
    FROM public.projects AS p
    LEFT JOIN TopPartner AS tp ON p.id = tp.project_id
    LEFT JOIN ProjectStartDate AS psd ON p.id = psd.project_id;

    -- 只有当传入有效的项目ID时，才执行针对该项目的统计查询
    IF p_selected_project_id IS NOT NULL THEN
        -- 任务2: 获取日报 (逻辑无误，无需修改)
        WITH DriverBaseCosts AS (
            SELECT logistics_record_id, base_amount FROM public.logistics_partner_costs WHERE level = 1
        ), TopLevelPartnerCosts AS (
            SELECT logistics_record_id, payable_amount FROM public.logistics_partner_costs WHERE (logistics_record_id, level) IN (SELECT logistics_record_id, MAX(level) FROM public.logistics_partner_costs GROUP BY logistics_record_id)
        ), DailyRecords AS (
            SELECT lr.id, COALESCE(lr.unloading_weight, lr.loading_weight) AS tonnage, dbc.base_amount AS driver_receivable, tlpc.payable_amount AS partner_payable
            FROM public.logistics_records lr
            LEFT JOIN DriverBaseCosts dbc ON lr.id = dbc.logistics_record_id
            LEFT JOIN TopLevelPartnerCosts tlpc ON lr.id = tlpc.logistics_record_id
            WHERE lr.project_id = p_selected_project_id AND lr.loading_date::date = p_report_date
        )
        SELECT json_build_object('trip_count', (SELECT COUNT(*) FROM DailyRecords), 'total_tonnage', COALESCE(SUM(tonnage), 0), 'driver_receivable', COALESCE(SUM(driver_receivable), 0), 'partner_payable', COALESCE(SUM(partner_payable), 0))
        INTO v_daily_report FROM DailyRecords;

        -- 任务3: 获取7日趋势 (逻辑无误，无需修改)
        WITH DriverBaseCosts AS (
            SELECT logistics_record_id, base_amount FROM public.logistics_partner_costs WHERE level = 1
        ), date_series AS (
            SELECT generate_series(p_report_date - INTERVAL '6 days', p_report_date, '1 day'::interval)::date AS report_date
        )
        SELECT json_agg(json_build_object('date', TO_CHAR(ds.report_date, 'MM-DD'), 'trips', COALESCE(daily_data.trips, 0), 'weight', COALESCE(daily_data.total_weight, 0), 'receivable', COALESCE(daily_data.total_receivable, 0)) ORDER BY ds.report_date)
        INTO v_seven_day_trend
        FROM date_series ds
        LEFT JOIN (
            SELECT lr.loading_date::date AS report_day, COUNT(lr.id) AS trips, SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS total_weight, SUM(dbc.base_amount) AS total_receivable
            FROM public.logistics_records lr LEFT JOIN DriverBaseCosts dbc ON lr.id = dbc.logistics_record_id
            WHERE lr.project_id = p_selected_project_id AND lr.loading_date::date BETWEEN p_report_date - INTERVAL '6 days' AND p_report_date
            GROUP BY report_day
        ) AS daily_data ON ds.report_date = daily_data.report_day;

        -- 任务4: 获取项目摘要统计 (逻辑无误，无需修改)
        WITH RecordsUpToDate AS (
            SELECT id, unloading_weight, loading_weight
            FROM public.logistics_records
            WHERE project_id = p_selected_project_id AND loading_date::date <= p_report_date
        ), ProjectTopLevelCostsUpToDate AS (
            SELECT lpc.payable_amount
            FROM RecordsUpToDate r
            JOIN public.logistics_partner_costs lpc ON r.id = lpc.logistics_record_id
            WHERE lpc.level = (SELECT MAX(sub.level) FROM public.logistics_partner_costs sub WHERE sub.logistics_record_id = lpc.logistics_record_id)
        )
        SELECT json_build_object(
            'total_trips', (SELECT COUNT(*) FROM RecordsUpToDate),
            'total_tonnage', (SELECT COALESCE(SUM(COALESCE(unloading_weight, loading_weight)), 0) FROM RecordsUpToDate),
            'total_cost', (SELECT COALESCE(SUM(payable_amount), 0) FROM ProjectTopLevelCostsUpToDate),
            'avg_cost', ((SELECT COALESCE(SUM(payable_amount), 0) FROM ProjectTopLevelCostsUpToDate) / NULLIF((SELECT SUM(COALESCE(unloading_weight, loading_weight)) FROM RecordsUpToDate), 0))
        ) INTO v_summary_stats;

        -- 任务5: 生成司机工作量报告 (逻辑无误，无需修改)
        WITH DriverBaseCosts AS (
            SELECT logistics_record_id, base_amount FROM public.logistics_partner_costs WHERE level = 1
        ), TopLevelPartnerCosts AS (
            SELECT logistics_record_id, payable_amount FROM public.logistics_partner_costs WHERE (logistics_record_id, level) IN (SELECT logistics_record_id, MAX(level) FROM public.logistics_partner_costs GROUP BY logistics_record_id)
        ), DriverTotalTrips AS (
            SELECT driver_id, COUNT(id) AS total_trip_count
            FROM public.logistics_records
            WHERE project_id = p_selected_project_id AND loading_date::date <= p_report_date
            GROUP BY driver_id
        )
        SELECT COALESCE(json_agg(row_to_json(t) ORDER BY driver_name ASC), '[]')
        INTO v_driver_report_table
        FROM (
            SELECT 
                d.name AS driver_name,
                d.license_plate,
                d.phone,
                COUNT(lr.id) AS daily_trip_count,
                COALESCE(dtt.total_trip_count, 0) AS total_trip_count,
                SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS total_tonnage, 
                SUM(dbc.base_amount) AS total_driver_receivable, 
                SUM(tlpc.payable_amount) AS total_partner_payable
            FROM public.logistics_records lr
            JOIN public.drivers d ON lr.driver_id = d.id
            LEFT JOIN DriverBaseCosts dbc ON lr.id = dbc.logistics_record_id
            LEFT JOIN TopLevelPartnerCosts tlpc ON lr.id = tlpc.logistics_record_id
            LEFT JOIN DriverTotalTrips dtt ON d.id = dtt.driver_id
            WHERE lr.project_id = p_selected_project_id AND lr.loading_date::date = p_report_date
            GROUP BY d.name, d.license_plate, d.phone, dtt.total_trip_count
        ) t;

    ELSE
        v_daily_report := '{"trip_count":0, "total_tonnage":0,"driver_receivable":0,"partner_payable":0}';
        v_seven_day_trend := '[]';
        v_summary_stats := '{"total_trips":0,"total_tonnage":0,"total_cost":0,"avg_cost":0}';
        v_driver_report_table := '[]';
    END IF;

    RETURN json_build_object(
        'project_details', COALESCE(v_project_details, '[]'),
        'daily_report', v_daily_report,
        'seven_day_trend', v_seven_day_trend,
        'summary_stats', v_summary_stats,
        'driver_report_table', v_driver_report_table
    );
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.get_project_dashboard_data_bak0817
CREATE OR REPLACE FUNCTION public.get_project_dashboard_data_bak0817(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$DECLARE
    v_project_details JSON;
    v_daily_report JSON;
    v_seven_day_trend JSON;
    v_summary_stats JSON;
    v_driver_report_table JSON;
BEGIN
    -- 任务1: 获取所有项目的详细信息列表 (逻辑不变)
    WITH TopPartner AS (
        SELECT DISTINCT ON (pp.project_id) pp.project_id, p.name AS partner_name
        FROM public.project_partners AS pp JOIN public.partners AS p ON pp.partner_id = p.id
        ORDER BY pp.project_id, pp.level DESC
    ), ProjectStartDate AS (
        SELECT project_id, MIN(loading_date)::date AS actual_start_date
        FROM public.logistics_records GROUP BY project_id
    )
    SELECT json_agg(
        json_build_object(
            'id', p.id,
            'name', p.name,
            'partner_name', tp.partner_name,
            'start_date', TO_CHAR(psd.actual_start_date, 'YYYY-MM-DD'),
            'planned_total_tons', p.planned_total_tons
        ) ORDER BY p.created_at DESC
    ) INTO v_project_details
    FROM public.projects AS p
    LEFT JOIN TopPartner AS tp ON p.id = tp.project_id
    LEFT JOIN ProjectStartDate AS psd ON p.id = psd.project_id;

    -- 只有当传入有效的项目ID时，才执行针对该项目的统计查询
    IF p_selected_project_id IS NOT NULL THEN
        -- 任务2: 获取日报 (逻辑不变, 按当日计算)
        WITH DriverBaseCosts AS (
            SELECT logistics_record_id, base_amount FROM public.logistics_partner_costs WHERE level = 1
        ), TopLevelPartnerCosts AS (
            SELECT logistics_record_id, payable_amount FROM public.logistics_partner_costs WHERE (logistics_record_id, level) IN (SELECT logistics_record_id, MAX(level) FROM public.logistics_partner_costs GROUP BY logistics_record_id)
        ), DailyRecords AS (
            SELECT lr.id, COALESCE(lr.unloading_weight, lr.loading_weight) AS tonnage, dbc.base_amount AS driver_receivable, tlpc.payable_amount AS partner_payable
            FROM public.logistics_records lr
            LEFT JOIN DriverBaseCosts dbc ON lr.id = dbc.logistics_record_id
            LEFT JOIN TopLevelPartnerCosts tlpc ON lr.id = tlpc.logistics_record_id
            WHERE lr.project_id = p_selected_project_id AND lr.loading_date::date = p_report_date
        )
        SELECT json_build_object('trip_count', (SELECT COUNT(*) FROM DailyRecords), 'total_tonnage', COALESCE(SUM(tonnage), 0), 'driver_receivable', COALESCE(SUM(driver_receivable), 0), 'partner_payable', COALESCE(SUM(partner_payable), 0))
        INTO v_daily_report FROM DailyRecords;

        -- 任务3: 获取7日趋势 (逻辑不变, 按选定日期往前7天)
        WITH DriverBaseCosts AS (
            SELECT logistics_record_id, base_amount FROM public.logistics_partner_costs WHERE level = 1
        ), date_series AS (
            SELECT generate_series(p_report_date - INTERVAL '6 days', p_report_date, '1 day'::interval)::date AS report_date
        )
        SELECT json_agg(json_build_object('date', TO_CHAR(ds.report_date, 'MM-DD'), 'trips', COALESCE(daily_data.trips, 0), 'weight', COALESCE(daily_data.total_weight, 0), 'receivable', COALESCE(daily_data.total_receivable, 0)) ORDER BY ds.report_date)
        INTO v_seven_day_trend
        FROM date_series ds
        LEFT JOIN (
            SELECT lr.loading_date::date AS report_day, COUNT(lr.id) AS trips, SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS total_weight, SUM(dbc.base_amount) AS total_receivable
            FROM public.logistics_records lr LEFT JOIN DriverBaseCosts dbc ON lr.id = dbc.logistics_record_id
            WHERE lr.project_id = p_selected_project_id AND lr.loading_date::date BETWEEN p_report_date - INTERVAL '6 days' AND p_report_date
            GROUP BY report_day
        ) AS daily_data ON ds.report_date = daily_data.report_day;

        -- 【关键重构】任务4: 获取项目摘要统计 (所有计算都截止到 p_report_date)
        WITH RecordsUpToDate AS (
            -- 1. 预先筛选出所有截止到指定日期的运单
            SELECT id, unloading_weight, loading_weight
            FROM public.logistics_records
            WHERE project_id = p_selected_project_id AND loading_date::date <= p_report_date
        ), ProjectTopLevelCostsUpToDate AS (
            -- 2. 基于筛选后的运单，计算最高级合作方应付
            SELECT lpc.payable_amount
            FROM RecordsUpToDate r
            JOIN public.logistics_partner_costs lpc ON r.id = lpc.logistics_record_id
            WHERE lpc.level = (SELECT MAX(sub.level) FROM public.logistics_partner_costs sub WHERE sub.logistics_record_id = lpc.logistics_record_id)
        )
        SELECT json_build_object(
            -- 3. 所有计算都基于预筛选的CTE
            'total_trips', (SELECT COUNT(*) FROM RecordsUpToDate),
            'total_tonnage', (SELECT COALESCE(SUM(COALESCE(unloading_weight, loading_weight)), 0) FROM RecordsUpToDate),
            'total_cost', (SELECT COALESCE(SUM(payable_amount), 0) FROM ProjectTopLevelCostsUpToDate),
            'avg_cost', ((SELECT COALESCE(SUM(payable_amount), 0) FROM ProjectTopLevelCostsUpToDate) / NULLIF((SELECT SUM(COALESCE(unloading_weight, loading_weight)) FROM RecordsUpToDate), 0))
        ) INTO v_summary_stats;

        -- 任务5: 生成司机工作量报告 (逻辑不变, 按当日计算)
        WITH DriverBaseCosts AS (
            SELECT logistics_record_id, base_amount FROM public.logistics_partner_costs WHERE level = 1
        ), TopLevelPartnerCosts AS (
            SELECT logistics_record_id, payable_amount FROM public.logistics_partner_costs WHERE (logistics_record_id, level) IN (SELECT logistics_record_id, MAX(level) FROM public.logistics_partner_costs GROUP BY logistics_record_id)
        )
        SELECT COALESCE(json_agg(row_to_json(t) ORDER BY driver_name ASC), '[]')
        INTO v_driver_report_table
        FROM (
            SELECT d.name AS driver_name, COUNT(lr.id) AS trip_count, SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS total_tonnage, SUM(dbc.base_amount) AS total_driver_receivable, SUM(tlpc.payable_amount) AS total_partner_payable
            FROM public.logistics_records lr
            JOIN public.drivers d ON lr.driver_id = d.id
            LEFT JOIN DriverBaseCosts dbc ON lr.id = dbc.logistics_record_id
            LEFT JOIN TopLevelPartnerCosts tlpc ON lr.id = tlpc.logistics_record_id
            WHERE lr.project_id = p_selected_project_id AND lr.loading_date::date = p_report_date
            GROUP BY d.name
        ) t;

    ELSE
        v_daily_report := '{"trip_count":0, "total_tonnage":0,"driver_receivable":0,"partner_payable":0}';
        v_seven_day_trend := '[]';
        v_summary_stats := '{"total_trips":0,"total_tonnage":0,"total_cost":0,"avg_cost":0}';
        v_driver_report_table := '[]';
    END IF;

    RETURN json_build_object(
        'project_details', COALESCE(v_project_details, '[]'),
        'daily_report', v_daily_report,
        'seven_day_trend', v_seven_day_trend,
        'summary_stats', v_summary_stats,
        'driver_report_table', v_driver_report_table
    );
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.get_project_dashboard_data_final
CREATE OR REPLACE FUNCTION public.get_project_dashboard_data_final(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    -- ★★★ 核心修正: SELECT 列表中只包含您表中真实存在的列 ★★★
    RETURN (
        SELECT json_build_object(
            'id', p.id,
            'name', p.name,
            'start_date', p.start_date,
            'planned_total_tons', p.planned_total_tons
            -- 'billing_type_id' 已被移除
        )
        FROM projects p
        WHERE p.id = p_selected_project_id
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.get_project_dashboard_data_v2
CREATE OR REPLACE FUNCTION public.get_project_dashboard_data_v2(p_selected_project_id uuid, p_report_date date)
 RETURNS dashboard_data_type_v2
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_project_details_combined json;
    v_daily_report json;
    v_seven_day_trend json;
    v_summary_stats json;
    v_driver_report_table json;
    v_daily_logistics_records json;
    
    v_selected_project_details json;
    v_all_projects_for_dropdown json;
BEGIN
    -- 1a. 获取当前选定的项目详情
    SELECT to_json(proj) INTO v_selected_project_details
    FROM (
        SELECT p.id, p.name, p.start_date, p.planned_total_tons, p.billing_type_id, par.name as partner_name
        FROM projects p
        LEFT JOIN partners par ON par.id = (
            SELECT pp.partner_id FROM project_partners pp 
            JOIN partner_chains pc ON pc.id = pp.chain_id
            WHERE pc.project_id = p.id AND pc.is_default = true
            ORDER BY pp.level LIMIT 1
        )
        WHERE p.id = p_selected_project_id
    ) proj;

    -- 1b. 获取所有项目列表用于下拉框
    SELECT json_agg(json_build_object('id', id, 'name', name)) INTO v_all_projects_for_dropdown FROM projects ORDER BY name;

    -- 1c. 将两者合并到一个JSON对象中
    v_project_details_combined := json_build_object(
        'selected', v_selected_project_details,
        'all_for_dropdown', v_all_projects_for_dropdown
    );

    -- 后续查询保持不变，使用 p_selected_project_id 进行过滤
    -- 2. 计算指定日期的日报
    SELECT json_build_object(
        'trip_count', COUNT(*),
        'total_tonnage', COALESCE(SUM(unloading_weight), 0),
        'driver_receivable', COALESCE(SUM(current_cost), 0),
        'partner_payable', COALESCE(SUM(payable_cost), 0)
    ) INTO v_daily_report
    FROM logistics_records
    WHERE project_id = p_selected_project_id AND loading_date::date = p_report_date;

    -- 3. 计算7日趋势
    SELECT json_agg(trends) INTO v_seven_day_trend
    FROM (
        SELECT 
            d.date::text,
            COALESCE(lr.trips, 0) as trips,
            COALESCE(lr.weight, 0) as weight,
            COALESCE(lr.receivable, 0) as receivable
        FROM generate_series(p_report_date - interval '6 days', p_report_date, '1 day'::interval) d(date)
        LEFT JOIN (
            SELECT 
                loading_date::date,
                COUNT(*) as trips,
                SUM(unloading_weight) as weight,
                SUM(current_cost) as receivable
            FROM logistics_records
            WHERE project_id = p_selected_project_id AND loading_date::date BETWEEN p_report_date - interval '6 days' AND p_report_date
            GROUP BY loading_date::date
        ) lr ON d.date = lr.loading_date
        ORDER BY d.date
    ) trends;

    -- 4. 计算项目整体汇总统计
    SELECT json_build_object(
        'total_trips', COUNT(*),
        'total_tonnage', COALESCE(SUM(unloading_weight), 0),
        'total_cost', COALESCE(SUM(current_cost), 0),
        'avg_cost', COALESCE(SUM(current_cost) / NULLIF(SUM(unloading_weight), 0), 0)
    ) INTO v_summary_stats
    FROM logistics_records
    WHERE project_id = p_selected_project_id;

    -- 5. 司机工作量报告
    SELECT json_agg(driver_stats) INTO v_driver_report_table
    FROM (
        SELECT
            daily.driver_name,
            daily.license_plate,
            daily.phone as driver_phone,
            daily.trip_count,
            daily.total_tonnage,
            daily.total_driver_receivable,
            daily.total_partner_payable,
            total.total_trips_in_project,
            total.total_receivable_in_project
        FROM (
            SELECT driver_id, driver_name, license_plate, phone, COUNT(*) as trip_count, SUM(unloading_weight) as total_tonnage, SUM(current_cost) as total_driver_receivable, SUM(payable_cost) as total_partner_payable
            FROM logistics_records
            WHERE project_id = p_selected_project_id AND loading_date::date = p_report_date
            GROUP BY driver_id, driver_name, license_plate, phone
        ) AS daily
        JOIN (
            SELECT driver_id, COUNT(*) as total_trips_in_project, SUM(current_cost) as total_receivable_in_project
            FROM logistics_records
            WHERE project_id = p_selected_project_id
            GROUP BY driver_id
        ) AS total ON daily.driver_id = total.driver_id
        ORDER BY daily.total_driver_receivable DESC
    ) AS driver_stats;

    -- 6. 获取7日内每天的运单详情
    SELECT json_object_agg(
        lr.loading_date, lr.records
    ) INTO v_daily_logistics_records
    FROM (
        SELECT 
            loading_date::date as loading_date,
            json_agg(json_build_object('id', id, 'auto_number', auto_number, 'driver_name', driver_name, 'license_plate', license_plate, 'loading_weight', loading_weight, 'unloading_weight', unloading_weight, 'current_cost', current_cost)) as records
        FROM logistics_records
        WHERE project_id = p_selected_project_id AND loading_date::date BETWEEN p_report_date - interval '6 days' AND p_report_date
        GROUP BY loading_date::date
    ) lr;

    -- 返回所有数据
    RETURN (v_project_details_combined, v_daily_report, v_seven_day_trend, v_summary_stats, v_driver_report_table, v_daily_logistics_records);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- 函数: public.get_project_dashboard_data_v3
CREATE OR REPLACE FUNCTION public.get_project_dashboard_data_v3(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_selected_project_details json;
BEGIN
    -- 查询逻辑保持不变
    SELECT to_json(proj) INTO v_selected_project_details
    FROM (
        SELECT p.id, p.name, p.start_date, p.planned_total_tons, p.billing_type_id
        FROM projects p
        WHERE p.id = p_selected_project_id
    ) proj;

    RETURN v_selected_project_details;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.get_project_dashboard_data_v8
CREATE OR REPLACE FUNCTION public.get_project_dashboard_data_v8(p_selected_project_id uuid, p_report_date date)
 RETURNS json
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    v_start_date date := p_report_date - interval '29 days';
    v_end_date date := p_report_date;
    result_json json;
BEGIN
    -- ★★★ 核心语法修正: 将 WITH 子句移动到 BEGIN 块内部 ★★★
    WITH 
    project_base AS (
        SELECT p.*, pa.name as partner_name
        FROM projects p
        LEFT JOIN project_partners pp ON p.id = pp.project_id
        LEFT JOIN partners pa ON pp.partner_id = pa.id
    ),
    logistics_in_range AS (
        SELECT *
        FROM logistics_records
        WHERE project_id = p_selected_project_id AND loading_date::date BETWEEN v_start_date AND v_end_date
    ),
    summary_stats AS (
        SELECT
            COUNT(*) AS total_trips,
            COALESCE(SUM(unloading_weight), 0) AS total_tonnage,
            COALESCE(SUM(payable_cost), 0) AS total_cost,
            CASE WHEN COALESCE(SUM(unloading_weight), 0) > 0 THEN COALESCE(SUM(payable_cost), 0) / NULLIF(SUM(unloading_weight), 0) ELSE 0 END AS avg_cost
        FROM logistics_records WHERE project_id = p_selected_project_id
    ),
    daily_report_base AS (
        SELECT *
        FROM logistics_records
        WHERE project_id = p_selected_project_id AND unloading_date::date = p_report_date
    ),
    daily_report AS (
        SELECT
            COUNT(*) AS trip_count,
            (SELECT COUNT(*) FROM logistics_records WHERE project_id = p_selected_project_id) as total_trip_count,
            COALESCE(SUM(unloading_weight), 0) AS total_tonnage,
            COALESCE(SUM(payable_cost), 0) AS driver_receivable,
            (SELECT COALESCE(SUM(lpc.payable_amount), 0) FROM logistics_partner_costs lpc JOIN daily_report_base drb ON lpc.logistics_record_id = drb.id) AS partner_payable
        FROM daily_report_base
    ),
    driver_report_table AS (
        SELECT 
            d.name as driver_name, d.license_plate, d.phone,
            COUNT(lr.id) as trip_count,
            COALESCE(SUM(lr.unloading_weight), 0) as total_tonnage,
            COALESCE(SUM(lr.payable_cost), 0) as total_driver_receivable,
            COALESCE(SUM(lpc.payable_amount), 0) as total_partner_payable,
            (SELECT COUNT(*) FROM logistics_records WHERE driver_id = lr.driver_id AND unloading_date::date = p_report_date) as daily_trip_count,
            (SELECT COALESCE(SUM(payable_cost), 0) FROM logistics_records WHERE driver_id = lr.driver_id AND unloading_date::date = p_report_date) as daily_receivable,
            (SELECT COUNT(*) FROM logistics_records WHERE driver_id = lr.driver_id AND project_id = p_selected_project_id) as total_trip_count,
            (SELECT COALESCE(SUM(payable_cost), 0) FROM logistics_records WHERE driver_id = lr.driver_id AND project_id = p_selected_project_id) as payable_cost
        FROM logistics_records lr
        JOIN drivers d ON lr.driver_id = d.id
        LEFT JOIN logistics_partner_costs lpc ON lr.id = lpc.logistics_record_id
        WHERE lr.project_id = p_selected_project_id AND lr.unloading_date::date = p_report_date
        GROUP BY d.name, d.license_plate, d.phone, lr.driver_id
    ),
    daily_transport_stats AS (
        SELECT
            to_char(loading_date, 'YYYY-MM-DD') AS date,
            COALESCE(SUM(CASE WHEN transport_type = '实际运输' THEN loading_weight ELSE 0 END), 0) AS "actualTransport",
            COALESCE(SUM(CASE WHEN transport_type != '实际运输' THEN loading_weight ELSE 0 END), 0) AS "returns"
        FROM logistics_in_range
        GROUP BY to_char(loading_date, 'YYYY-MM-DD')
        ORDER BY date
    ),
    daily_count_stats AS (
        SELECT
            to_char(loading_date, 'YYYY-MM-DD') AS date,
            COUNT(*) AS count
        FROM logistics_in_range
        GROUP BY to_char(loading_date, 'YYYY-MM-DD')
        ORDER BY date
    ),
    daily_cost_stats AS (
        SELECT
            to_char(loading_date, 'YYYY-MM-DD') AS date,
            COALESCE(SUM(current_cost + extra_cost), 0) AS "totalCost"
        FROM logistics_in_range
        GROUP BY to_char(loading_date, 'YYYY-MM-DD')
        ORDER BY date
    )
    SELECT json_build_object(
        'project_details', (SELECT json_agg(pb) FROM project_base pb),
        'daily_report', (SELECT row_to_json(dr) FROM daily_report dr),
        'summary_stats', (SELECT row_to_json(ss) FROM summary_stats ss),
        'driver_report_table', (SELECT COALESCE(json_agg(drt), '[]'::json) FROM driver_report_table drt),
        'daily_transport_stats', (SELECT COALESCE(json_agg(dts), '[]'::json) FROM daily_transport_stats dts),
        'daily_count_stats', (SELECT COALESCE(json_agg(dcs), '[]'::json) FROM daily_count_stats dcs),
        'daily_cost_stats', (SELECT COALESCE(json_agg(cost_stats), '[]'::json) FROM daily_cost_stats cost_stats)
    )
    INTO result_json;

    RETURN result_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.get_project_driver_ranking
CREATE OR REPLACE FUNCTION public.get_project_driver_ranking(p_project_id uuid, p_report_date date, p_sort text, p_order text, p_limit integer DEFAULT 100, p_offset integer DEFAULT 0)
 RETURNS TABLE(driver_id uuid, driver_name text, license_plate text, phone text, daily_trip_count integer, total_trip_count integer, total_tonnage numeric, total_driver_receivable numeric)
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
begin
  -- 基本权限校验：必须为已登录且启用的用户（示例基于 profiles 表）
  if auth.uid() is null then
    raise exception 'forbidden: not authenticated';
  end if;

  if not exists (
    select 1 from profiles p
    where p.id = auth.uid()
      and coalesce(p.is_active, true) = true
      and p.role in ('admin','finance','business','operator','viewer')
  ) then
    raise exception 'forbidden: no permission';
  end if;

  return query
  with daily as (
    select driver_id, count(*) as daily_trip_count
    from logistics_records
    where project_id = p_project_id
      and loading_date::date = p_report_date
    group by driver_id
  ),
  tot as (
    select driver_id,
           max(driver_name) as driver_name,
           max(license_plate) as license_plate,
           max(driver_phone) as phone,
           count(*) as total_trip_count,
           coalesce(sum(loading_weight), 0) as total_tonnage,
           coalesce(sum(driver_payable_cost), 0) as total_driver_receivable
    from logistics_records
    where project_id = p_project_id
    group by driver_id
  ),
  joined as (
    select t.driver_id, t.driver_name, t.license_plate, t.phone,
           coalesce(d.daily_trip_count, 0) as daily_trip_count,
           t.total_trip_count, t.total_tonnage, t.total_driver_receivable
    from tot t
    left join daily d on d.driver_id = t.driver_id
  )
  select driver_id, driver_name, license_plate, phone,
         daily_trip_count, total_trip_count, total_tonnage, total_driver_receivable
  from (
    select j.*,
      case
        when lower(p_sort) = 'daily' then j.daily_trip_count::numeric
        when lower(p_sort) = 'total' then j.total_trip_count::numeric
        else j.total_driver_receivable
      end as sort_value
    from joined j
  ) s
  order by
    case when lower(p_order) = 'asc' then sort_value end asc,
    case when lower(p_order) = 'desc' then sort_value end desc,
    driver_name
  limit p_limit offset p_offset;
end;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.get_project_drivers_with_details
CREATE OR REPLACE FUNCTION public.get_project_drivers_with_details(p_project_id uuid)
 RETURNS TABLE(driver_id uuid, driver_name text, license_plate text, phone text)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    d.id as driver_id,
    d.name as driver_name,
    d.license_plate,
    d.phone
  FROM public.drivers d
  JOIN public.driver_projects dp ON d.id = dp.driver_id
  WHERE dp.project_id = p_project_id
  ORDER BY d.name;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.get_project_overall_stats
CREATE OR REPLACE FUNCTION public.get_project_overall_stats(p_project_id uuid)
 RETURNS json
 LANGUAGE sql
 SET search_path TO 'public'
AS $function$
  WITH ProjectCosts AS (
    SELECT
      lr.id,
      lr.project_id,
      lpc.payable_amount
    FROM public.logistics_records lr
    JOIN public.logistics_partner_costs lpc ON lr.id = lpc.logistics_record_id
    WHERE lr.project_id = p_project_id
      AND lpc.level = (SELECT MAX(sub.level) FROM public.logistics_partner_costs sub WHERE sub.logistics_record_id = lpc.logistics_record_id)
  )
  SELECT json_build_object(
      'total_trips', (SELECT COUNT(*) FROM public.logistics_records WHERE project_id = p_project_id),
      'total_tonnage', (SELECT COALESCE(SUM(COALESCE(unloading_weight, loading_weight)), 0) FROM public.logistics_records WHERE project_id = p_project_id),
      'total_cost', (SELECT COALESCE(SUM(payable_amount), 0) FROM ProjectCosts),
      'avg_cost', (SELECT COALESCE(SUM(payable_amount), 0) / NULLIF(SUM(COALESCE(unloading_weight, loading_weight)), 0) FROM public.logistics_records lr LEFT JOIN ProjectCosts pc ON lr.id = pc.id WHERE lr.project_id = p_project_id)
  )
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_project_quick_stats
CREATE OR REPLACE FUNCTION public.get_project_quick_stats()
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result jsonb;
BEGIN
    SELECT jsonb_build_object(
        'activeProjects', (
            SELECT COUNT(*) 
            FROM projects 
            WHERE project_status = '进行中'
        ),
        'pendingPayments', (
            SELECT COUNT(*) 
            FROM payment_requests 
            WHERE status = 'Pending'
        )
    )
    INTO result;

    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.get_project_trend_by_range
CREATE OR REPLACE FUNCTION public.get_project_trend_by_range(p_project_id uuid, p_days integer)
 RETURNS TABLE(date date, trips integer, weight numeric, receivable numeric)
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
BEGIN
  -- 临时注释掉权限检查
  -- if auth.uid() is null then
  --   raise exception 'forbidden: not authenticated';
  -- end if;

  -- if not exists (
  --   select 1 from profiles p
  --   where p.id = auth.uid()
  --     and coalesce(p.is_active, true) = true
  --     and p.role in ('admin','finance','business','operator','viewer')
  -- ) then
  --   raise exception 'forbidden: no permission';
  -- end if;

  RETURN QUERY
  SELECT d::date as date,
         COALESCE(count(r.id), 0) as trips,
         COALESCE(sum(r.loading_weight), 0) as weight,
         COALESCE(sum(r.driver_payable_cost), 0) as receivable
  FROM generate_series(current_date - (p_days - 1), current_date, interval '1 day') as d
  LEFT JOIN logistics_records r
    ON r.project_id = p_project_id
   AND r.loading_date::date = d::date
  GROUP BY d
  ORDER BY d;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.get_projects_overview_with_driver_receivable
CREATE OR REPLACE FUNCTION public.get_projects_overview_with_driver_receivable(p_report_date text DEFAULT NULL::text, p_project_id text DEFAULT NULL::text, p_project_ids uuid[] DEFAULT NULL::uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE
AS $function$
DECLARE
  v_report_date date;
  v_result jsonb;
BEGIN
  v_report_date := COALESCE(p_report_date::date, CURRENT_DATE);

  WITH
  -- 1. 获取项目基础信息
  project_base AS (
    SELECT DISTINCT 
      p.id,
      p.name,
      COALESCE(pt.name, '未知合作方') AS partner_name,
      p.start_date,
      p.planned_total_tons,
      COALESCE(pc.billing_type_id, 1) AS billing_type_id
    FROM projects p
    LEFT JOIN LATERAL (
      SELECT pt.name
      FROM project_partners pp
      JOIN partners pt ON pp.partner_id = pt.id
      WHERE pp.project_id = p.id
      ORDER BY pp.level DESC
      LIMIT 1
    ) pt ON true
    LEFT JOIN LATERAL (
      SELECT billing_type_id 
      FROM partner_chains 
      WHERE project_id = p.id 
      LIMIT 1
    ) pc ON true
    WHERE (p_project_id IS NULL OR p.id = p_project_id::uuid)
      AND (p_project_ids IS NULL OR p.id = ANY(p_project_ids))
  ),
  
  -- 2. 批量获取所有项目的日报数据（当天）
  daily_reports AS (
    SELECT 
      lr.project_id,
      COUNT(*) AS trip_count,
      COALESCE(SUM(COALESCE(lr.unloading_weight, lr.loading_weight)), 0) AS total_tonnage,
      COALESCE(SUM(lpc_driver.base_amount), 0) AS driver_receivable,
      COALESCE(SUM(lpc_top.payable_amount), 0) AS partner_payable
    FROM logistics_records lr
    LEFT JOIN logistics_partner_costs lpc_driver 
      ON lr.id = lpc_driver.logistics_record_id AND lpc_driver.level = 1
    LEFT JOIN LATERAL (
      SELECT payable_amount
      FROM logistics_partner_costs
      WHERE logistics_record_id = lr.id
      ORDER BY level DESC
      LIMIT 1
    ) lpc_top ON true
    WHERE lr.loading_date::date = v_report_date
      AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id
  ),
  
  -- 3. 批量获取所有项目的汇总统计（截至报告日期）
  summary_stats_base AS (
    SELECT 
      lr.project_id,
      COUNT(*) AS total_trips,
      SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS total_tonnage,
      SUM(lpc_top.payable_amount) AS total_cost,
      SUM(lpc_driver.base_amount) AS total_driver_receivable
    FROM logistics_records lr
    LEFT JOIN LATERAL (
      SELECT payable_amount
      FROM logistics_partner_costs
      WHERE logistics_record_id = lr.id
      ORDER BY level DESC
      LIMIT 1
    ) lpc_top ON true
    LEFT JOIN logistics_partner_costs lpc_driver 
      ON lr.id = lpc_driver.logistics_record_id AND lpc_driver.level = 1
    WHERE lr.loading_date::date <= v_report_date
      AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id
  ),
  summary_stats AS (
    SELECT 
      project_id,
      total_trips,
      COALESCE(total_tonnage, 0) AS total_tonnage,
      COALESCE(total_cost, 0) AS total_cost,
      COALESCE(total_driver_receivable, 0) AS total_driver_receivable,
      CASE 
        WHEN COALESCE(total_tonnage, 0) > 0 
        THEN COALESCE(total_cost, 0) / total_tonnage
        ELSE 0
      END AS avg_cost
    FROM summary_stats_base
  ),
  
  -- 4. 批量获取7日趋势（所有项目）
  seven_day_trend AS (
    SELECT 
      lr.project_id,
      lr.loading_date::date AS date,
      COUNT(*) AS trips,
      SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS weight,
      SUM(lpc_driver.base_amount) AS receivable
    FROM logistics_records lr
    LEFT JOIN logistics_partner_costs lpc_driver 
      ON lr.id = lpc_driver.logistics_record_id AND lpc_driver.level = 1
    WHERE lr.loading_date::date >= v_report_date - INTERVAL '6 days'
      AND lr.loading_date::date <= v_report_date
      AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id, lr.loading_date::date
  ),
  
  -- 5. 批量获取司机报表数据（所有项目）
  driver_report_base AS (
    SELECT 
      lr.project_id,
      d.name AS driver_name,
      d.license_plate,
      d.phone,
      COUNT(CASE WHEN lr.loading_date::date = v_report_date THEN 1 END) AS daily_trip_count,
      COUNT(*) AS total_trip_count,
      SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS total_tonnage,
      SUM(lpc_driver.base_amount) AS total_driver_receivable,
      SUM(lpc_top.payable_amount) AS total_partner_payable
    FROM logistics_records lr
    JOIN drivers d ON lr.driver_id = d.id
    LEFT JOIN logistics_partner_costs lpc_driver 
      ON lr.id = lpc_driver.logistics_record_id AND lpc_driver.level = 1
    LEFT JOIN LATERAL (
      SELECT payable_amount
      FROM logistics_partner_costs
      WHERE logistics_record_id = lr.id
      ORDER BY level DESC
      LIMIT 1
    ) lpc_top ON true
    WHERE lr.loading_date::date <= v_report_date
      AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id, d.id, d.name, d.license_plate, d.phone
  ),
  
  -- 6. 组合所有数据
  project_data AS (
    SELECT 
      pb.id,
      pb.name,
      pb.partner_name,
      pb.start_date,
      pb.planned_total_tons,
      pb.billing_type_id,
      COALESCE(dr.trip_count, 0) AS daily_trip_count,
      COALESCE(dr.total_tonnage, 0) AS daily_tonnage,
      COALESCE(dr.driver_receivable, 0) AS daily_driver_receivable,
      COALESCE(dr.partner_payable, 0) AS daily_partner_payable,
      COALESCE(ss.total_trips, 0) AS total_trips,
      COALESCE(ss.total_tonnage, 0) AS total_tonnage,
      COALESCE(ss.total_cost, 0) AS total_cost,
      COALESCE(ss.total_driver_receivable, 0) AS total_driver_receivable,
      COALESCE(ss.avg_cost, 0) AS avg_cost,
      COALESCE(json_agg(
        json_build_object(
          'date', std.date,
          'trips', std.trips,
          'weight', std.weight,
          'receivable', std.receivable
        ) ORDER BY std.date
      ) FILTER (WHERE std.date IS NOT NULL), '[]'::json) AS seven_day_trend,
      COALESCE(json_agg(
        json_build_object(
          'driver_name', drb.driver_name,
          'license_plate', drb.license_plate,
          'phone', drb.phone,
          'daily_trip_count', drb.daily_trip_count,
          'total_trip_count', drb.total_trip_count,
          'total_tonnage', drb.total_tonnage,
          'total_driver_receivable', drb.total_driver_receivable,
          'total_partner_payable', drb.total_partner_payable
        ) ORDER BY drb.driver_name
      ) FILTER (WHERE drb.driver_name IS NOT NULL), '[]'::json) AS driver_report_table
    FROM project_base pb
    LEFT JOIN daily_reports dr ON pb.id = dr.project_id
    LEFT JOIN summary_stats ss ON pb.id = ss.project_id
    LEFT JOIN seven_day_trend std ON pb.id = std.project_id
    LEFT JOIN driver_report_base drb ON pb.id = drb.project_id
    GROUP BY pb.id, pb.name, pb.partner_name, pb.start_date, pb.planned_total_tons, pb.billing_type_id,
             dr.trip_count, dr.total_tonnage, dr.driver_receivable, dr.partner_payable,
             ss.total_trips, ss.total_tonnage, ss.total_cost, ss.total_driver_receivable, ss.avg_cost
  ),
  
  -- 7. 全局7日趋势数据
  global_seven_day_trend AS (
    SELECT 
      std.date,
      SUM(std.trips) AS trips,
      SUM(std.weight) AS weight,
      SUM(std.receivable) AS receivable
    FROM seven_day_trend std
    GROUP BY std.date
  ),
  
  -- 8. 全局司机报表数据
  global_driver_report AS (
    SELECT 
      drb.driver_name,
      drb.license_plate,
      drb.phone,
      SUM(drb.daily_trip_count) AS daily_trip_count,
      SUM(drb.total_trip_count) AS total_trip_count,
      SUM(drb.total_tonnage) AS total_tonnage,
      SUM(drb.total_driver_receivable) AS total_driver_receivable,
      SUM(drb.total_partner_payable) AS total_partner_payable
    FROM driver_report_base drb
    GROUP BY drb.driver_name, drb.license_plate, drb.phone
  )

  -- 构建最终结果
  SELECT jsonb_build_object(
    'all_projects_data', COALESCE(json_agg(
      json_build_object(
        'project_details', json_build_array(
          json_build_object(
            'id', pd.id,
            'name', pd.name,
            'partner_name', pd.partner_name,
            'start_date', pd.start_date,
            'planned_total_tons', pd.planned_total_tons,
            'billing_type_id', pd.billing_type_id
          )
        ),
        'daily_report', json_build_object(
          'trip_count', pd.daily_trip_count,
          'total_tonnage', pd.daily_tonnage,
          'driver_receivable', pd.daily_driver_receivable,
          'partner_payable', pd.daily_partner_payable
        ),
        'summary_stats', json_build_object(
          'total_trips', pd.total_trips,
          'total_tonnage', pd.total_tonnage,
          'total_cost', pd.total_cost,
          'total_driver_receivable', pd.total_driver_receivable,
          'avg_cost', pd.avg_cost
        ),
        'seven_day_trend', pd.seven_day_trend,
        'driver_report_table', pd.driver_report_table
      ) ORDER BY pd.name
    ), '[]'::json),
    'global_seven_day_trend', COALESCE(json_agg(
      json_build_object(
        'date', gstd.date,
        'trips', gstd.trips,
        'weight', gstd.weight,
        'receivable', gstd.receivable
      ) ORDER BY gstd.date
    ) FILTER (WHERE gstd.date IS NOT NULL), '[]'::json),
    'global_driver_report_table', COALESCE(json_agg(
      json_build_object(
        'driver_name', gdr.driver_name,
        'license_plate', gdr.license_plate,
        'phone', gdr.phone,
        'daily_trip_count', gdr.daily_trip_count,
        'total_trip_count', gdr.total_trip_count,
        'total_tonnage', gdr.total_tonnage,
        'total_driver_receivable', gdr.total_driver_receivable,
        'total_partner_payable', gdr.total_partner_payable
      ) ORDER BY gdr.driver_name
    ) FILTER (WHERE gdr.driver_name IS NOT NULL), '[]'::json),
    'global_summary', json_build_object(
      'total_projects', COUNT(DISTINCT pd.id),
      'total_receivable', SUM(pd.total_driver_receivable),
      'total_trips', SUM(pd.total_trips)
    )
  )
  INTO v_result
  FROM project_data pd, global_seven_day_trend gstd, global_driver_report gdr;

  RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.get_projects_overview_with_driver_receivable
CREATE OR REPLACE FUNCTION public.get_projects_overview_with_driver_receivable(p_report_date text DEFAULT NULL::text, p_project_id text DEFAULT NULL::text, p_project_ids text[] DEFAULT NULL::text[])
 RETURNS jsonb
 LANGUAGE plpgsql
AS $function$DECLARE
  v_report_date date;
  v_all_projects_data jsonb := '[]'::jsonb;
  v_global_seven_day_trend jsonb := '[]'::jsonb;
  v_global_driver_report_table jsonb := '[]'::jsonb;
  v_global_summary jsonb := '{}'::jsonb;
BEGIN
  -- 参数处理
  v_report_date := COALESCE(p_report_date::date, CURRENT_DATE);
  
  -- 1. 批量获取所有项目的基本信息
  WITH project_base AS (
    SELECT DISTINCT p.id, p.name, p.partner_name, p.start_date, p.planned_total_tons, p.billing_type_id
    FROM projects p
    WHERE (p_project_id IS NULL OR p.id = p_project_id)
    AND (p_project_ids IS NULL OR p.id = ANY(p_project_ids))
  ),
  
  -- 2. 批量获取所有项目的日报数据（当天）
  daily_reports AS (
    SELECT 
      lr.project_id,
      COUNT(*) AS trip_count,
      COALESCE(SUM(COALESCE(lr.unloading_weight, lr.loading_weight)), 0) AS total_tonnage,
      COALESCE(SUM(lpc_driver.base_amount), 0) AS driver_receivable,
      COALESCE(SUM(lpc_top.payable_amount), 0) AS partner_payable
    FROM logistics_records lr
    LEFT JOIN logistics_partner_costs lpc_driver 
      ON lr.id = lpc_driver.logistics_record_id AND lpc_driver.level = 1
    LEFT JOIN LATERAL (
      SELECT payable_amount
      FROM logistics_partner_costs
      WHERE logistics_record_id = lr.id
      ORDER BY level DESC
      LIMIT 1
    ) lpc_top ON true
    WHERE lr.loading_date::date = v_report_date
    AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id
  ),
  
  -- 3. 批量获取所有项目的汇总统计（截至报告日期）
  -- 分两步：先聚合，再计算（避免嵌套聚合错误）
  summary_stats_base AS (
    SELECT 
      lr.project_id,
      COUNT(*) AS total_trips,
      SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS total_tonnage,
      SUM(lpc_top.payable_amount) AS total_cost,
      SUM(lpc_driver.base_amount) AS total_driver_receivable
    FROM logistics_records lr
    LEFT JOIN LATERAL (
      SELECT payable_amount
      FROM logistics_partner_costs
      WHERE logistics_record_id = lr.id
      ORDER BY level DESC
      LIMIT 1
    ) lpc_top ON true
    LEFT JOIN logistics_partner_costs lpc_driver 
      ON lr.id = lpc_driver.logistics_record_id AND lpc_driver.level = 1
    WHERE lr.loading_date::date <= v_report_date
    AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id
  ),
  summary_stats AS (
    SELECT 
      project_id,
      total_trips,
      COALESCE(total_tonnage, 0) AS total_tonnage,
      COALESCE(total_cost, 0) AS total_cost,
      COALESCE(total_driver_receivable, 0) AS total_driver_receivable,
      CASE 
        WHEN COALESCE(total_tonnage, 0) > 0 
        THEN COALESCE(total_cost, 0) / total_tonnage
        ELSE 0
      END AS avg_cost
    FROM summary_stats_base
  ),
  
  -- 4. 批量获取7日趋势（所有项目）
  seven_day_trend AS (
    SELECT 
      lr.project_id,
      lr.loading_date::date AS date,
      COUNT(*) AS trips,
      SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS weight,
      SUM(lpc_driver.base_amount) AS receivable
    FROM logistics_records lr
    LEFT JOIN logistics_partner_costs lpc_driver 
      ON lr.id = lpc_driver.logistics_record_id AND lpc_driver.level = 1
    WHERE lr.loading_date::date >= v_report_date - INTERVAL '6 days'
    AND lr.loading_date::date <= v_report_date
    AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id, lr.loading_date::date
  ),
  
  -- 5. 批量获取司机报表数据（所有项目）
  driver_report_base AS (
    SELECT 
      lr.project_id,
      d.name AS driver_name,
      d.license_plate,
      d.phone,
      COUNT(CASE WHEN lr.loading_date::date = v_report_date THEN 1 END) AS daily_trip_count,
      COUNT(*) AS total_trip_count,
      SUM(COALESCE(lr.unloading_weight, lr.loading_weight)) AS total_tonnage,
      SUM(lpc_driver.base_amount) AS total_driver_receivable,
      SUM(lpc_top.payable_amount) AS total_partner_payable
    FROM logistics_records lr
    JOIN drivers d ON lr.driver_id = d.id
    LEFT JOIN logistics_partner_costs lpc_driver 
      ON lr.id = lpc_driver.logistics_record_id AND lpc_driver.level = 1
    LEFT JOIN LATERAL (
      SELECT payable_amount
      FROM logistics_partner_costs
      WHERE logistics_record_id = lr.id
      ORDER BY level DESC
      LIMIT 1
    ) lpc_top ON true
    WHERE lr.loading_date::date <= v_report_date
    AND (p_project_ids IS NULL OR lr.project_id = ANY(p_project_ids))
    GROUP BY lr.project_id, d.id, d.name, d.license_plate, d.phone
  ),
  
  -- 6. 组合所有数据
  project_data AS (
    SELECT 
      pb.id,
      pb.name,
      pb.partner_name,
      pb.start_date,
      pb.planned_total_tons,
      pb.billing_type_id,
      COALESCE(dr.trip_count, 0) AS daily_trip_count,
      COALESCE(dr.total_tonnage, 0) AS daily_tonnage,
      COALESCE(dr.driver_receivable, 0) AS daily_driver_receivable,
      COALESCE(dr.partner_payable, 0) AS daily_partner_payable,
      COALESCE(ss.total_trips, 0) AS total_trips,
      COALESCE(ss.total_tonnage, 0) AS total_tonnage,
      COALESCE(ss.total_cost, 0) AS total_cost,
      COALESCE(ss.total_driver_receivable, 0) AS total_driver_receivable,
      COALESCE(ss.avg_cost, 0) AS avg_cost,
      COALESCE(json_agg(
        json_build_object(
          'date', std.date,
          'trips', std.trips,
          'weight', std.weight,
          'receivable', std.receivable
        ) ORDER BY std.date
      ) FILTER (WHERE std.date IS NOT NULL), '[]'::json) AS seven_day_trend,
      COALESCE(json_agg(
        json_build_object(
          'driver_name', drb.driver_name,
          'license_plate', drb.license_plate,
          'phone', drb.phone,
          'daily_trip_count', drb.daily_trip_count,
          'total_trip_count', drb.total_trip_count,
          'total_tonnage', drb.total_tonnage,
          'total_driver_receivable', drb.total_driver_receivable,
          'total_partner_payable', drb.total_partner_payable
        ) ORDER BY drb.driver_name
      ) FILTER (WHERE drb.driver_name IS NOT NULL), '[]'::json) AS driver_report_table
    FROM project_base pb
    LEFT JOIN daily_reports dr ON pb.id = dr.project_id
    LEFT JOIN summary_stats ss ON pb.id = ss.project_id
    LEFT JOIN seven_day_trend std ON pb.id = std.project_id
    LEFT JOIN driver_report_base drb ON pb.id = drb.project_id
    GROUP BY pb.id, pb.name, pb.partner_name, pb.start_date, pb.planned_total_tons, pb.billing_type_id,
             dr.trip_count, dr.total_tonnage, dr.driver_receivable, dr.partner_payable,
             ss.total_trips, ss.total_tonnage, ss.total_cost, ss.total_driver_receivable, ss.avg_cost
  )
  
  -- 构建最终结果
  SELECT jsonb_build_object(
    'all_projects_data', COALESCE(json_agg(
      json_build_object(
        'project_details', json_build_array(
          json_build_object(
            'id', id,
            'name', name,
            'partner_name', partner_name,
            'start_date', start_date,
            'planned_total_tons', planned_total_tons,
            'billing_type_id', billing_type_id
          )
        ),
        'daily_report', json_build_object(
          'trip_count', daily_trip_count,
          'total_tonnage', daily_tonnage,
          'driver_receivable', daily_driver_receivable,
          'partner_payable', daily_partner_payable
        ),
        'summary_stats', json_build_object(
          'total_trips', total_trips,
          'total_tonnage', total_tonnage,
          'total_cost', total_cost,
          'total_driver_receivable', total_driver_receivable,
          'avg_cost', avg_cost
        ),
        'seven_day_trend', seven_day_trend,
        'driver_report_table', driver_report_table
      ) ORDER BY name
    ), '[]'::json),
    'global_seven_day_trend', COALESCE(json_agg(
      json_build_object(
        'date', date,
        'trips', SUM(trips),
        'weight', SUM(weight),
        'receivable', SUM(receivable)
      ) ORDER BY date
    ) FILTER (WHERE date IS NOT NULL), '[]'::json),
    'global_driver_report_table', COALESCE(json_agg(
      json_build_object(
        'driver_name', driver_name,
        'license_plate', license_plate,
        'phone', phone,
        'daily_trip_count', SUM(daily_trip_count),
        'total_trip_count', SUM(total_trip_count),
        'total_tonnage', SUM(total_tonnage),
        'total_driver_receivable', SUM(total_driver_receivable),
        'total_partner_payable', SUM(total_partner_payable)
      ) ORDER BY driver_name
    ) FILTER (WHERE driver_name IS NOT NULL), '[]'::json),
    'global_summary', json_build_object(
      'total_projects', COUNT(DISTINCT id),
      'total_receivable', SUM(total_driver_receivable),
      'total_trips', SUM(total_trips)
    )
  )
  INTO v_all_projects_data
  FROM project_data, seven_day_trend, driver_report_base;
  
  RETURN v_all_projects_data;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.get_projects_with_details
CREATE OR REPLACE FUNCTION public.get_projects_with_details()
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN public.get_projects_with_details_optimized();
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.get_projects_with_details_fixed
CREATE OR REPLACE FUNCTION public.get_projects_with_details_fixed()
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
DECLARE
  projects_json jsonb;
  chains_json jsonb;
  partners_json jsonb;
BEGIN
  -- Projects list with complete field mapping including project_status and effective_quantity_type
  SELECT COALESCE(jsonb_agg(
    jsonb_build_object(
      'id', p.id,
      'name', p.name,
      'startDate', p.start_date,
      'endDate', p.end_date,
      'manager', p.manager,
      'loadingAddress', p.loading_address,
      'unloadingAddress', p.unloading_address,
      'autoCode', p.auto_code,
      'plannedTotalTons', p.planned_total_tons,
      'cargoType', p.cargo_type,
      'financeManager', p.finance_manager,
      'projectStatus', p.project_status,
      'effectiveQuantityType', p.effective_quantity_type,
      'createdAt', p.created_at
    ) ORDER BY p.created_at DESC
  ), '[]'::jsonb)
  INTO projects_json
  FROM public.projects p;

  -- Chains grouped per project (no nested aggregates)
  SELECT COALESCE(jsonb_object_agg(project_id, chains_array), '{}'::jsonb)
  INTO chains_json
  FROM (
    SELECT c.project_id,
      jsonb_agg(
        jsonb_build_object(
          'id', c.id,
          'projectId', c.project_id,
          'chainName', c.chain_name,
          'description', c.description,
          'isDefault', c.is_default,
          'billing_type_id', c.billing_type_id,  -- ✅ 添加这行
          'createdAt', c.created_at
        ) ORDER BY c.is_default DESC, c.created_at
      ) AS chains_array
    FROM public.partner_chains c
    GROUP BY c.project_id
  ) AS chains_grouped;

  -- Partners grouped per project (no nested aggregates)
  SELECT COALESCE(jsonb_object_agg(project_id, partners_array), '{}'::jsonb)
  INTO partners_json
  FROM (
    SELECT pp.project_id,
      jsonb_agg(
        jsonb_build_object(
          'id', pp.id,
          'projectId', pp.project_id,
          'partnerId', pp.partner_id,
          'chainId', pp.chain_id,
          'level', pp.level,
          'taxRate', pp.tax_rate,
          'calculationMethod', pp.calculation_method,
          'profitRate', pp.profit_rate,
          'createdAt', pp.created_at,
          'partnerName', p.name
        ) ORDER BY pp.level
      ) AS partners_array
    FROM public.project_partners pp
    JOIN public.partners p ON pp.partner_id = p.id
    GROUP BY pp.project_id
  ) AS partners_grouped;

  RETURN jsonb_build_object(
    'projects', projects_json,
    'chains', chains_json,
    'partners', partners_json
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.get_projects_with_details_optimized
CREATE OR REPLACE FUNCTION public.get_projects_with_details_optimized()
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
  projects_json jsonb;
  chains_json jsonb;
  partners_json jsonb;
BEGIN
  -- 第一步：获取所有项目的基础信息
  SELECT COALESCE(jsonb_agg(
    jsonb_build_object(
      'id', p.id,
      'name', p.name,
      'startDate', p.start_date,
      'endDate', p.end_date,
      'manager', p.manager,
      'loadingAddress', p.loading_address,
      'unloadingAddress', p.unloading_address,
      'autoCode', p.auto_code,
      'plannedTotalTons', p.planned_total_tons,
      'cargoType', p.cargo_type,
      'financeManager', p.finance_manager,
      'projectStatus', p.project_status,
      'createdAt', p.created_at
    ) ORDER BY p.created_at DESC
  ), '[]'::jsonb)
  INTO projects_json
  FROM public.projects p;

  -- 第二步：获取所有合作链路，并按 project_id 分组
  SELECT COALESCE(jsonb_object_agg(project_id, chains_array), '{}'::jsonb)
  INTO chains_json
  FROM (
    SELECT c.project_id,
      jsonb_agg(
        jsonb_build_object(
          'id', c.id,
          'projectId', c.project_id,
          'chainName', c.chain_name,
          'description', c.description,
          'isDefault', c.is_default,
          'createdAt', c.created_at,
          'billing_type_id', c.billing_type_id -- 【【【核心修复】】】确保返回计费模式ID
        ) ORDER BY c.is_default DESC, c.created_at
      ) AS chains_array
    FROM public.partner_chains c
    GROUP BY c.project_id
  ) AS chains_grouped;

  -- 第三步：获取所有合作方，并按 project_id 分组
  SELECT COALESCE(jsonb_object_agg(project_id, partners_array), '{}'::jsonb)
  INTO partners_json
  FROM (
    SELECT pp.project_id,
      jsonb_agg(
        jsonb_build_object(
          'id', pp.id,
          'projectId', pp.project_id,
          'partnerId', pp.partner_id,
          'chainId', pp.chain_id,
          'level', pp.level,
          'taxRate', pp.tax_rate,
          'calculationMethod', pp.calculation_method,
          'profitRate', pp.profit_rate,
          'createdAt', pp.created_at,
          'partnerName', p.name
        ) ORDER BY pp.level
      ) AS partners_array
    FROM public.project_partners pp
    JOIN public.partners p ON pp.partner_id = p.id
    GROUP BY pp.project_id
  ) AS partners_grouped;

  -- 第四步：将三部分数据组合成一个JSON对象并返回
  RETURN jsonb_build_object(
    'projects', projects_json,
    'chains', chains_json,
    'partners', partners_json
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.get_template_field_mappings
CREATE OR REPLACE FUNCTION public.get_template_field_mappings(p_template_id uuid)
 RETURNS TABLE(id uuid, excel_column character varying, database_field character varying, field_type character varying, is_required boolean, validation_rules jsonb, default_value text, display_order integer)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    ifm.id,
    ifm.excel_column,
    ifm.database_field,
    ifm.field_type,
    ifm.is_required,
    ifm.validation_rules,
    ifm.default_value,
    ifm.display_order
  FROM public.import_field_mappings ifm
  WHERE ifm.template_id = p_template_id
  ORDER BY ifm.display_order, ifm.excel_column;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.get_template_fixed_mappings
CREATE OR REPLACE FUNCTION public.get_template_fixed_mappings(p_template_id uuid, p_mapping_type character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id uuid, mapping_type character varying, excel_value text, database_value text, is_case_sensitive boolean)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    ifm.id,
    ifm.mapping_type,
    ifm.excel_value,
    ifm.database_value,
    ifm.is_case_sensitive
  FROM public.import_fixed_mappings ifm
  WHERE ifm.template_id = p_template_id
    AND (p_mapping_type IS NULL OR ifm.mapping_type = p_mapping_type)
  ORDER BY ifm.mapping_type, ifm.excel_value;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.get_today_stats
CREATE OR REPLACE FUNCTION public.get_today_stats()
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result jsonb;
    today_date date := CURRENT_DATE;
BEGIN
    WITH today_records AS (
        SELECT 
            lr.*,
            COALESCE(lr.billing_type_id, 1) as billing_type
        FROM logistics_records lr
        WHERE DATE(lr.loading_date) = today_date
    )
    SELECT jsonb_build_object(
        'todayRecords', COUNT(*),
        'todayWeight', COALESCE(SUM(
            CASE 
                WHEN billing_type = 1 THEN COALESCE(unloading_weight, loading_weight, 0)
                ELSE 0 
            END
        ), 0),
        'todayCost', COALESCE(SUM(payable_cost), 0),
        'activeProjects', (
            SELECT COUNT(DISTINCT project_id) 
            FROM today_records
        )
    )
    INTO result
    FROM today_records;

    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.get_top_partner_daily_trend
CREATE OR REPLACE FUNCTION public.get_top_partner_daily_trend(start_date date, end_date date)
 RETURNS TABLE(date text, payable_amount numeric, trip_count bigint, partner_name text)
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    top_partner_id uuid;
    top_partner_name text;
BEGIN
    -- Step 1: Find the partner with the highest payable amount in the given period
    SELECT
        lr.partner_id,
        p.name
    INTO
        top_partner_id,
        top_partner_name
    FROM
        public.logistics_records lr
    JOIN
        public.partners p ON lr.partner_id = p.id
    WHERE
        lr.loading_date BETWEEN start_date AND end_date
        AND lr.partner_id IS NOT NULL
        AND lr.payable_cost > 0
    GROUP BY
        lr.partner_id, p.name
    ORDER BY
        SUM(lr.payable_cost) DESC
    LIMIT 1;

    -- If no partner is found, return an empty set
    IF top_partner_id IS NULL THEN
        RETURN;
    END IF;

    -- Step 2: Generate a series of dates and get the daily stats for that top partner
    RETURN QUERY
    WITH date_series AS (
        SELECT generate_series(start_date, end_date, '1 day'::interval)::date AS day
    )
    SELECT
        to_char(ds.day, 'YYYY-MM-DD') AS "date",
        COALESCE(SUM(lr.payable_cost), 0)::numeric AS payable_amount,
        COUNT(lr.id)::bigint AS trip_count,
        top_partner_name AS partner_name
    FROM
        date_series ds
    LEFT JOIN
        public.logistics_records lr ON lr.loading_date = ds.day AND lr.partner_id = top_partner_id
    GROUP BY
        ds.day
    ORDER BY
        ds.day;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.get_total_receivables
CREATE OR REPLACE FUNCTION public.get_total_receivables()
 RETURNS numeric
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    total_amount NUMERIC;
BEGIN
    WITH highest_level_costs AS (
        SELECT
            DISTINCT ON (logistics_record_id) -- 每个运单只取一行
            logistics_record_id,
            payable_amount
        FROM
            public.logistics_partner_costs
        ORDER BY
            logistics_record_id,
            level DESC -- 按 level 降序排序，最大的 level 在前
    )
    SELECT INTO total_amount SUM(h.payable_amount)
    FROM highest_level_costs h;

    RETURN COALESCE(total_amount, 0);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.get_transport_overview
CREATE OR REPLACE FUNCTION public.get_transport_overview(p_project_id uuid, p_start_date text, p_end_date text)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    -- 将TEXT类型的日期转换为DATE，如果为空则使用一个很早/很晚的日期
    start_date DATE := COALESCE(p_start_date::DATE, '1970-01-01');
    end_date DATE := COALESCE(p_end_date::DATE, '2999-12-31');
BEGIN
    RETURN (
        WITH 
        -- CTE 1: 基础数据源，根据筛选条件过滤一次
        filtered_records AS (
            SELECT *
            FROM public.logistics_records
            WHERE
                (p_project_id IS NULL OR project_id = p_project_id) AND
                loading_date::DATE BETWEEN start_date AND end_date
        ),
        -- CTE 2: 卡片指标的聚合结果
        overview_stats AS (
            SELECT json_build_object(
                'totalRecords', COUNT(*),
                'totalWeight', COALESCE(SUM(loading_weight), 0),
                'totalCost', COALESCE(SUM(payable_cost), 0),
                'actualTransportCount', COUNT(*) FILTER (WHERE transport_type = '实际运输'),
                'returnCount', COUNT(*) FILTER (WHERE transport_type = '退货')
            ) AS overview
            FROM filtered_records
        ),
        -- CTE 3: 每日运输量统计
        daily_transport_stats AS (
            SELECT json_agg(t) AS stats FROM (
                SELECT
                    loading_date::DATE AS date,
                    COALESCE(SUM(loading_weight) FILTER (WHERE transport_type = '实际运输'), 0) AS "actualTransport",
                    COALESCE(SUM(loading_weight) FILTER (WHERE transport_type = '退货'), 0) AS "returns"
                FROM filtered_records
                GROUP BY loading_date::DATE
                ORDER BY date
            ) t
        ),
        -- CTE 4: 每日费用统计
        daily_cost_stats AS (
            SELECT json_agg(t) AS stats FROM (
                SELECT
                    loading_date::DATE AS date,
                    COALESCE(SUM(payable_cost), 0) AS "totalCost"
                FROM filtered_records
                GROUP BY loading_date::DATE
                ORDER BY date
            ) t
        ),
        -- CTE 5: 每日次数统计
        daily_count_stats AS (
            SELECT json_agg(t) AS stats FROM (
                SELECT
                    loading_date::DATE AS date,
                    COUNT(*) AS count
                FROM filtered_records
                GROUP BY loading_date::DATE
                ORDER BY date
            ) t
        )
        -- 最终组合
        SELECT json_build_object(
            'overview', os.overview,
            'dailyTransportStats', dts.stats,
            'dailyCostStats', dcs.stats,
            'dailyCountStats', dccs.stats
        )
        FROM
            overview_stats os,
            daily_transport_stats dts,
            daily_cost_stats dcs,
            daily_count_stats dccs
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.get_unified_dashboard_stats
CREATE OR REPLACE FUNCTION public.get_unified_dashboard_stats(start_date text, end_date text, project_id_filter uuid DEFAULT NULL::uuid)
 RETURNS json
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result json;
    yesterday_start timestamptz := date_trunc('day', now() - '1 day'::interval);
    yesterday_end timestamptz := date_trunc('day', now());
BEGIN
    WITH 
    filtered_records AS (
        SELECT id, created_at, loading_weight, payable_cost, transport_type, unloading_date, payment_status, loading_date
        FROM logistics_records
        WHERE created_at >= start_date::date AND created_at < (end_date::date + '1 day'::interval)
          AND (project_id_filter IS NULL OR project_id = project_id_filter)
    ),
    highest_level_partner_costs AS (
        SELECT lpc.logistics_record_id, lpc.payable_amount
        FROM (
            SELECT logistics_record_id, payable_amount, ROW_NUMBER() OVER(PARTITION BY logistics_record_id ORDER BY level DESC) as rn
            FROM logistics_partner_costs
        ) lpc
        WHERE lpc.rn = 1
    ),
    yesterday_stats_calc AS (
        SELECT
            COUNT(lr.id) AS yesterday_trip_count,
            COALESCE(SUM(lr.loading_weight), 0) AS yesterday_loading_weight,
            COALESCE(SUM(hlpc.payable_amount), 0) AS yesterday_payable_amount,
            (SELECT COALESCE(SUM(ir.invoice_amount), 0) FROM invoice_records ir WHERE ir.invoice_date = (NOW() - '1 day'::interval)::date) AS yesterday_invoice_amount
        FROM logistics_records lr
        LEFT JOIN highest_level_partner_costs hlpc ON lr.id = hlpc.logistics_record_id
        WHERE lr.loading_date >= yesterday_start AND lr.loading_date < yesterday_end
    ),
    settlement_stats_calc AS (
        SELECT
            COALESCE(SUM(CASE WHEN (NOW() - lr.unloading_date) > '30 days'::interval THEN hlpc.payable_amount ELSE 0 END), 0) AS unsettled_over_30_days_amount,
            COALESCE(SUM(CASE WHEN (NOW() - lr.unloading_date) > '60 days'::interval THEN hlpc.payable_amount ELSE 0 END), 0) AS unsettled_over_60_days_amount,
            COALESCE(SUM(CASE WHEN (NOW() - lr.unloading_date) > '90 days'::interval THEN hlpc.payable_amount ELSE 0 END), 0) AS unsettled_over_90_days_amount,
            -- 【性能优化】使用 LEFT JOIN + IS NULL 替代 NOT EXISTS
            COALESCE(SUM(CASE WHEN (NOW() - lr.unloading_date) > '30 days'::interval AND ir.id IS NULL THEN hlpc.payable_amount ELSE 0 END), 0) AS uninvoiced_over_30_days_amount,
            COALESCE(SUM(CASE WHEN (NOW() - lr.unloading_date) > '60 days'::interval AND ir.id IS NULL THEN hlpc.payable_amount ELSE 0 END), 0) AS uninvoiced_over_60_days_amount,
            COALESCE(SUM(CASE WHEN (NOW() - lr.unloading_date) > '90 days'::interval AND ir.id IS NULL THEN hlpc.payable_amount ELSE 0 END), 0) AS uninvoiced_over_90_days_amount
        FROM logistics_records lr
        JOIN highest_level_partner_costs hlpc ON lr.id = hlpc.logistics_record_id
        -- 【性能优化】将判断是否开票的逻辑移到 LEFT JOIN 中
        LEFT JOIN invoice_records ir ON lr.id = ir.logistics_record_id
        WHERE lr.payment_status = '未支付' AND lr.unloading_date IS NOT NULL
    ),
    overview AS (
        SELECT COUNT(*) AS total_records, COALESCE(SUM(loading_weight), 0) AS total_weight, COALESCE(SUM(payable_cost), 0) AS total_cost,
               COUNT(CASE WHEN transport_type = '实际运输' THEN 1 END) AS actual_transport_count, COUNT(CASE WHEN transport_type = '退货' THEN 1 END) AS return_count
        FROM filtered_records
    ),
    daily_charts AS (
        SELECT
            COALESCE(json_agg(json_build_object('date', d.date, 'actualTransport', d.actual_transport, 'returns', d.returns) ORDER BY d.date), '[]'::json) AS daily_transport_stats,
            COALESCE(json_agg(json_build_object('date', d.date, 'totalCost', d.total_cost) ORDER BY d.date), '[]'::json) AS daily_cost_stats,
            COALESCE(json_agg(json_build_object('date', d.date, 'count', d.count) ORDER BY d.date), '[]'::json) AS daily_count_stats
        FROM (
            SELECT DATE(created_at) AS date,
                   COALESCE(SUM(CASE WHEN transport_type = '实际运输' THEN loading_weight ELSE 0 END), 0) AS actual_transport,
                   COALESCE(SUM(CASE WHEN transport_type = '退货' THEN loading_weight ELSE 0 END), 0) AS returns,
                   COALESCE(SUM(payable_cost), 0) AS total_cost,
                   COUNT(*) AS count
            FROM filtered_records
            GROUP BY DATE(created_at)
        ) d
    )
    SELECT
        json_build_object(
            'summary_stats', (SELECT to_jsonb(yesterday_stats_calc) || to_jsonb(settlement_stats_calc) FROM yesterday_stats_calc, settlement_stats_calc),
            'overview', (SELECT to_json(overview) FROM overview),
            'dailyTransportStats', (SELECT daily_transport_stats FROM daily_charts),
            'dailyCostStats', (SELECT daily_cost_stats FROM daily_charts),
            'dailyCountStats', (SELECT daily_count_stats FROM daily_charts)
        )
    INTO result;
    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.get_unread_notification_count
CREATE OR REPLACE FUNCTION public.get_unread_notification_count(p_user_id uuid)
 RETURNS integer
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_count integer;
BEGIN
  SELECT COUNT(*)::integer INTO v_count
  FROM public.notifications
  WHERE user_id = p_user_id AND is_read = false;
  
  RETURN COALESCE(v_count, 0);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_user_by_username
CREATE OR REPLACE FUNCTION public.get_user_by_username(username_input text)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN (
    SELECT email -- 直接查询并返回 email
    FROM public.profiles
    WHERE username = username_input AND is_active = true
  );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.get_user_contract_permissions
CREATE OR REPLACE FUNCTION public.get_user_contract_permissions(p_user_id uuid, p_contract_id uuid DEFAULT NULL::uuid)
 RETURNS TABLE(contract_id uuid, permission_type text, source text, expires_at timestamp with time zone)
 LANGUAGE plpgsql
AS $function$
DECLARE
    has_is_active_column BOOLEAN;
BEGIN
    -- 检查is_active字段是否存在
    SELECT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'contract_permissions' 
        AND column_name = 'is_active' 
        AND table_schema = 'public'
    ) INTO has_is_active_column;
    
    RETURN QUERY
    -- 用户直接权限
    SELECT cp.contract_id, cp.permission_type, 'user'::TEXT, cp.expires_at
    FROM contract_permissions cp
    WHERE cp.user_id = p_user_id
    AND (NOT has_is_active_column OR cp.is_active = true)
    AND (cp.expires_at IS NULL OR cp.expires_at > NOW())
    AND (p_contract_id IS NULL OR cp.contract_id = p_contract_id)
    
    UNION ALL
    
    -- 角色权限
    SELECT cp.contract_id, cp.permission_type, 'role'::TEXT, cp.expires_at
    FROM contract_permissions cp
    JOIN profiles p ON p.id = p_user_id
    JOIN user_roles ur ON ur.id = cp.role_id
    WHERE ur.role = p.role
    AND (NOT has_is_active_column OR cp.is_active = true)
    AND (cp.expires_at IS NULL OR cp.expires_at > NOW())
    AND (p_contract_id IS NULL OR cp.contract_id = p_contract_id)
    
    UNION ALL
    
    -- 所有者权限
    SELECT cop.contract_id, unnest(cop.permissions)::TEXT, 'owner'::TEXT, NULL::TIMESTAMPTZ
    FROM contract_owner_permissions cop
    WHERE cop.owner_id = p_user_id
    AND (p_contract_id IS NULL OR cop.contract_id = p_contract_id);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.get_user_id_by_email
CREATE OR REPLACE FUNCTION public.get_user_id_by_email(p_email text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'auth', 'public'
AS $function$
DECLARE
    user_id uuid;
BEGIN
    -- 从 auth.users 表中查找用户ID，使用完整的表名限定
    SELECT au.id INTO user_id
    FROM auth.users au
    WHERE au.email = p_email
    LIMIT 1;
    
    -- 如果没找到，返回 NULL
    RETURN user_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.get_user_notifications
CREATE OR REPLACE FUNCTION public.get_user_notifications(p_user_id uuid, p_limit integer DEFAULT 50, p_offset integer DEFAULT 0, p_is_read boolean DEFAULT NULL::boolean)
 RETURNS TABLE(id uuid, type text, category text, title text, message text, link text, related_id uuid, is_read boolean, created_at timestamp with time zone, read_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    n.id,
    n.type,
    n.category,
    n.title,
    n.message,
    n.link,
    n.related_id,
    n.is_read,
    n.created_at,
    n.read_at
  FROM public.notifications n
  WHERE n.user_id = p_user_id
  AND (p_is_read IS NULL OR n.is_read = p_is_read)
  ORDER BY n.created_at DESC
  LIMIT p_limit
  OFFSET p_offset;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.get_user_projects
CREATE OR REPLACE FUNCTION public.get_user_projects()
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    current_user_id UUID; user_role TEXT; project_ids_json JSONB;
BEGIN
    current_user_id := auth.uid();
    SELECT role INTO user_role FROM public.profiles WHERE id = current_user_id;
    IF user_role = 'admin' THEN
        SELECT jsonb_build_object('project_ids', COALESCE(jsonb_agg(p.id), '[]'::jsonb)) INTO project_ids_json FROM public.projects p;
    ELSE
        SELECT jsonb_build_object('project_ids', COALESCE(jsonb_agg(pu.project_id), '[]'::jsonb)) INTO project_ids_json FROM public.project_users pu WHERE pu.user_id = current_user_id;
    END IF;
    RETURN project_ids_json;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.handle_contract_permission_change
CREATE OR REPLACE FUNCTION public.handle_contract_permission_change()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    -- 发送权限变更通知
    PERFORM pg_notify('permission_changed', json_build_object(
        'table', 'contract_permissions',
        'operation', TG_OP,
        'user_id', COALESCE(NEW.user_id, OLD.user_id),
        'contract_id', COALESCE(NEW.contract_id, OLD.contract_id),
        'timestamp', NOW()
    )::text);
    
    RETURN COALESCE(NEW, OLD);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '触发器 handle_contract_permission_change 执行出错: %', SQLERRM;
        RETURN COALESCE(NEW, OLD);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.handle_new_user
CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  INSERT INTO public.profiles (id, email, full_name)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data ->> 'full_name', NEW.email)
  );
  RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.handle_profile_role_change
CREATE OR REPLACE FUNCTION public.handle_profile_role_change()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- 当用户角色变更时，自动应用角色模板权限
    IF OLD.role IS DISTINCT FROM NEW.role THEN
        -- 删除用户的全局权限配置（让用户使用新的角色模板）
        DELETE FROM public.user_permissions 
        WHERE user_id = NEW.id 
        AND project_id IS NULL;
        
        -- 记录角色变更日志
        INSERT INTO public.permission_audit_logs (
            user_id, 
            action, 
            details, 
            created_at
        ) VALUES (
            NEW.id, 
            'role_changed', 
            jsonb_build_object(
                'old_role', OLD.role,
                'new_role', NEW.role,
                'message', '用户角色已变更，权限将使用新角色模板'
            ), 
            now()
        );
        
        RAISE NOTICE '用户 % 角色已从 % 变更为 %，权限将使用新角色模板', 
            NEW.email, OLD.role, NEW.role;
    END IF;
    
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.handle_profile_role_change_safe
CREATE OR REPLACE FUNCTION public.handle_profile_role_change_safe()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- 当用户角色变更时，自动应用角色模板权限
    IF OLD.role IS DISTINCT FROM NEW.role THEN
        -- 删除用户的全局权限配置（让用户使用新的角色模板）
        DELETE FROM public.user_permissions 
        WHERE user_id = NEW.id 
        AND project_id IS NULL;
        
        -- 记录角色变更日志到permission_audit_logs表
        INSERT INTO public.permission_audit_logs (
            user_id, 
            action, 
            permission_type,
            permission_key,
            old_value,
            new_value,
            reason,
            created_by
        ) VALUES (
            NEW.id, 
            'modify',  -- 使用 'modify' 而不是 'role_changed'
            'role',    -- 使用 'role' 而不是 'role_template'
            'user_role',
            jsonb_build_object('old_role', OLD.role),
            jsonb_build_object('new_role', NEW.role),
            '用户角色已变更，权限将使用新角色模板',
            NEW.id
        );
        
        RAISE NOTICE '用户 % 角色已从 % 变更为 %，权限将使用新角色模板', 
            NEW.email, OLD.role, NEW.role;
    END IF;
    
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- 函数: public.handle_project_status_change
CREATE OR REPLACE FUNCTION public.handle_project_status_change()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    user_record RECORD;
    current_user_id UUID;
BEGIN
    -- 检查项目状态是否变更为"进行中"
    IF NEW.project_status = '进行中' AND (OLD.project_status IS NULL OR OLD.project_status != '进行中') THEN
        -- 获取当前操作用户ID
        current_user_id := COALESCE(
            (SELECT auth.uid()),
            (SELECT id FROM public.profiles WHERE role = 'admin' LIMIT 1)
        );
        
        -- 为所有用户分配该项目权限
        FOR user_record IN 
            SELECT id FROM public.profiles WHERE is_active = true
        LOOP
            -- 检查是否已存在分配记录
            IF NOT EXISTS (
                SELECT 1 FROM public.user_projects 
                WHERE user_id = user_record.id 
                AND project_id = NEW.id
            ) THEN
                -- 插入新的项目分配记录
                INSERT INTO public.user_projects (
                    user_id,
                    project_id,
                    role,
                    can_view,
                    can_edit,
                    can_delete,
                    created_at,
                    updated_at,
                    created_by
                ) VALUES (
                    user_record.id,
                    NEW.id,
                    'operator'::app_role, -- 默认角色
                    true,  -- 可以查看
                    true,  -- 可以编辑
                    false, -- 不能删除
                    NOW(),
                    NOW(),
                    current_user_id
                );
            END IF;
        END LOOP;
        
        -- 记录日志
        RAISE NOTICE '项目 % 状态变更为"进行中"，已为所有用户分配访问权限', NEW.name;
    END IF;
    
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.handle_role_template_change
CREATE OR REPLACE FUNCTION public.handle_role_template_change()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    r_template RECORD;
BEGIN
    -- 记录操作类型和角色
    RAISE NOTICE '角色模板操作: % (角色: %)', TG_OP, COALESCE(NEW.role, OLD.role);

    -- 发送权限变更通知
    PERFORM pg_notify('permission_changed', json_build_object(
        'table', 'role_permission_templates',
        'operation', TG_OP,
        'role', COALESCE(NEW.role, OLD.role),
        'timestamp', NOW()
    )::text);

    -- 如果是更新操作，并且角色模板的权限发生了变化，则同步用户权限
    IF TG_OP = 'UPDATE' AND (
        OLD.menu_permissions IS DISTINCT FROM NEW.menu_permissions OR
        OLD.function_permissions IS DISTINCT FROM NEW.function_permissions OR
        OLD.project_permissions IS DISTINCT FROM NEW.project_permissions OR
        OLD.data_permissions IS DISTINCT FROM NEW.data_permissions
    ) THEN
        RAISE NOTICE '角色模板 % 的权限已变更，开始同步用户权限...', NEW.role;
        -- 调用同步用户权限的函数
        PERFORM public.sync_user_permissions_with_role(NEW.role);
    END IF;

    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        -- 记录错误但不阻止操作
        RAISE WARNING '触发器 handle_role_template_change 执行出错: %', SQLERRM;
        RETURN NEW; -- 确保即使出错也返回 NEW，不阻止主操作
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.handle_updated_at
CREATE OR REPLACE FUNCTION public.handle_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.handle_user_info_change
CREATE OR REPLACE FUNCTION public.handle_user_info_change()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- 记录用户信息变更
    IF TG_OP = 'UPDATE' THEN
        -- 记录姓名变更
        IF OLD.full_name IS DISTINCT FROM NEW.full_name THEN
            PERFORM log_user_info_change(
                NEW.id,
                'full_name',
                jsonb_build_object('old_name', OLD.full_name),
                jsonb_build_object('new_name', NEW.full_name),
                '用户姓名已修改'
            );
        END IF;
        
        -- 记录邮箱变更
        IF OLD.email IS DISTINCT FROM NEW.email THEN
            PERFORM log_user_info_change(
                NEW.id,
                'email',
                jsonb_build_object('old_email', OLD.email),
                jsonb_build_object('new_email', NEW.email),
                '用户邮箱已修改'
            );
        END IF;
        
        -- 记录状态变更
        IF OLD.is_active IS DISTINCT FROM NEW.is_active THEN
            PERFORM log_user_info_change(
                NEW.id,
                'is_active',
                jsonb_build_object('old_status', OLD.is_active),
                jsonb_build_object('new_status', NEW.is_active),
                '用户状态已修改'
            );
        END IF;
        
        -- 记录企业微信ID变更
        IF OLD.work_wechat_userid IS DISTINCT FROM NEW.work_wechat_userid THEN
            PERFORM log_user_info_change(
                NEW.id,
                'work_wechat_userid',
                jsonb_build_object('old_wechat_id', OLD.work_wechat_userid),
                jsonb_build_object('new_wechat_id', NEW.work_wechat_userid),
                '企业微信ID已修改'
            );
        END IF;
        
        -- 记录电话变更
        IF OLD.phone IS DISTINCT FROM NEW.phone THEN
            PERFORM log_user_info_change(
                NEW.id,
                'phone',
                jsonb_build_object('old_phone', OLD.phone),
                jsonb_build_object('new_phone', NEW.phone),
                '用户电话已修改'
            );
        END IF;
    END IF;
    
    RETURN COALESCE(NEW, OLD);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.handle_user_permission_change
CREATE OR REPLACE FUNCTION public.handle_user_permission_change()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    -- 发送权限变更通知
    PERFORM pg_notify('permission_changed', json_build_object(
        'table', 'user_permissions',
        'operation', TG_OP,
        'user_id', COALESCE(NEW.user_id, OLD.user_id),
        'project_id', COALESCE(NEW.project_id, OLD.project_id),
        'timestamp', NOW()
    )::text);
    
    RETURN COALESCE(NEW, OLD);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '触发器 handle_user_permission_change 执行出错: %', SQLERRM;
        RETURN COALESCE(NEW, OLD);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- 函数: public.handle_user_project_change
CREATE OR REPLACE FUNCTION public.handle_user_project_change()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    -- 发送权限变更通知
    PERFORM pg_notify('permission_changed', json_build_object(
        'table', 'user_projects',
        'operation', TG_OP,
        'user_id', COALESCE(NEW.user_id, OLD.user_id),
        'project_id', COALESCE(NEW.project_id, OLD.project_id),
        'timestamp', NOW()
    )::text);
    
    RETURN COALESCE(NEW, OLD);
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING '触发器 handle_user_project_change 执行出错: %', SQLERRM;
        RETURN COALESCE(NEW, OLD);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.has_role
CREATE OR REPLACE FUNCTION public.has_role(_user_id uuid, _role app_role)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_roles
    WHERE user_id = _user_id AND role = _role
  )
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.import_logistics_data
CREATE OR REPLACE FUNCTION public.import_logistics_data(p_records jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    success_records jsonb := '[]'::jsonb;
    failures jsonb := '[]'::jsonb;
    project_record RECORD;
    driver_result RECORD;
    loading_location_id uuid;
    unloading_location_id uuid;
    chain_result RECORD;
    new_record_id uuid;
    record_data jsonb;
    row_index integer := 0;
BEGIN
    -- 处理每条记录
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        row_index := row_index + 1;
        BEGIN
            -- 第1步：获取项目信息
            SELECT id, name INTO project_record
            FROM public.projects 
            WHERE name = (record_data->>'project_name') 
            LIMIT 1;

            IF project_record.id IS NULL THEN
                failures := failures || jsonb_build_object(
                    'row_index', row_index,
                    'data', record_data,
                    'error', '项目不存在: ' || (record_data->>'project_name')
                );
                CONTINUE;
            END IF;
            
            -- 第2步：查找或创建司机（根据姓名+车牌+电话三个字段）
            SELECT id, name INTO driver_result
            FROM public.drivers
            WHERE name = (record_data->>'driver_name')
              AND COALESCE(license_plate, '') = COALESCE(record_data->>'license_plate', '')
              AND COALESCE(phone, '') = COALESCE(record_data->>'driver_phone', '')
            LIMIT 1;
            
            -- 如果司机不存在，创建新司机
            IF driver_result.id IS NULL THEN
                INSERT INTO public.drivers (name, license_plate, phone, user_id)
                VALUES (
                    (record_data->>'driver_name'),
                    (record_data->>'license_plate'),
                    (record_data->>'driver_phone'),
                    auth.uid()
                )
                RETURNING id, name INTO driver_result;
            END IF;
            
            -- ✅ 修复：将关联逻辑移到IF块外，确保所有司机都会关联到项目
            -- 无论司机是新创建还是已存在，都要关联到当前项目
            INSERT INTO public.driver_projects (driver_id, project_id, user_id)
            VALUES (driver_result.id, project_record.id, auth.uid())
            ON CONFLICT (driver_id, project_id) DO NOTHING;
            
            -- 第3步：查找或创建装货地点
            SELECT id INTO loading_location_id
            FROM public.locations
            WHERE name = (record_data->>'loading_location')
            LIMIT 1;
            
            IF loading_location_id IS NULL THEN
                INSERT INTO public.locations (name, user_id)
                VALUES ((record_data->>'loading_location'), auth.uid())
                RETURNING id INTO loading_location_id;
            END IF;
            
            -- 第4步：查找或创建卸货地点
            SELECT id INTO unloading_location_id
            FROM public.locations
            WHERE name = (record_data->>'unloading_location')
            LIMIT 1;
            
            IF unloading_location_id IS NULL THEN
                INSERT INTO public.locations (name, user_id)
                VALUES ((record_data->>'unloading_location'), auth.uid())
                RETURNING id INTO unloading_location_id;
            END IF;
            
            -- 第5步：查找合作链路（如果提供）
            IF record_data->>'chain_name' IS NOT NULL AND record_data->>'chain_name' != '' THEN
                SELECT id INTO chain_result
                FROM public.partner_chains
                WHERE project_id = project_record.id 
                  AND chain_name = (record_data->>'chain_name')
                LIMIT 1;
            END IF;
            
            -- 第6步：插入运单记录
            INSERT INTO public.logistics_records (
                project_id,
                project_name,
                chain_id,
                driver_id,
                driver_name,
                loading_location,
                unloading_location,
                loading_date,
                unloading_date,
                loading_weight,
                unloading_weight,
                current_cost,
                extra_cost,
                transport_type,
                license_plate,
                driver_phone,
                remarks,
                user_id,
                external_tracking_numbers,
                other_platform_names
            ) VALUES (
                project_record.id,
                project_record.name,
                chain_result.id,
                driver_result.id,
                driver_result.name,
                record_data->>'loading_location',
                record_data->>'unloading_location',
                (record_data->>'loading_date')::date,
                CASE 
                    WHEN record_data->>'unloading_date' IS NOT NULL 
                    THEN (record_data->>'unloading_date')::date 
                    ELSE NULL 
                END,
                CASE 
                    WHEN record_data->>'loading_weight' ~ '^[0-9]*\.?[0-9]+$' 
                    THEN (record_data->>'loading_weight')::numeric 
                    ELSE NULL 
                END,
                CASE 
                    WHEN record_data->>'unloading_weight' ~ '^[0-9]*\.?[0-9]+$' 
                    THEN (record_data->>'unloading_weight')::numeric 
                    ELSE NULL 
                END,
                CASE 
                    WHEN record_data->>'current_cost' ~ '^[0-9]*\.?[0-9]+$' 
                    THEN (record_data->>'current_cost')::numeric 
                    ELSE NULL 
                END,
                CASE 
                    WHEN record_data->>'extra_cost' ~ '^-?[0-9]*\.?[0-9]+$' 
                    THEN (record_data->>'extra_cost')::numeric 
                    ELSE NULL 
                END,
                COALESCE(record_data->>'transport_type', '实际运输'),
                record_data->>'license_plate',
                record_data->>'driver_phone',
                record_data->>'remarks',
                auth.uid(),
                -- 处理平台运单号数组
                CASE 
                    WHEN record_data->'external_tracking_numbers' IS NOT NULL 
                    THEN ARRAY(SELECT jsonb_array_elements_text(record_data->'external_tracking_numbers'))::text[]
                    ELSE NULL
                END,
                -- 处理平台名称数组
                CASE 
                    WHEN record_data->'other_platform_names' IS NOT NULL 
                    THEN ARRAY(SELECT jsonb_array_elements_text(record_data->'other_platform_names'))::text[]
                    ELSE NULL
                END
            )
            RETURNING id INTO new_record_id;
            
            success_records := success_records || jsonb_build_object(
                'row_index', row_index,
                'record_id', new_record_id
            );
            
        EXCEPTION
            WHEN OTHERS THEN
                failures := failures || jsonb_build_object(
                    'row_index', row_index,
                    'data', record_data,
                    'error', SQLERRM
                );
        END;
    END LOOP;
    
    RETURN jsonb_build_object(
        'success', jsonb_array_length(success_records),
        'failures', jsonb_array_length(failures),
        'success_records', success_records,
        'failure_records', failures
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.import_logistics_data_v2
CREATE OR REPLACE FUNCTION public.import_logistics_data_v2(p_records jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    record_data jsonb;
    project_id uuid;
    chain_id uuid;
    driver_id uuid;
    new_record_id uuid;
    success_count integer := 0;
    error_count integer := 0;
    error_messages text[] := ARRAY[]::text[];
    error_message text;
BEGIN
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records) LOOP
        BEGIN
            -- 获取项目ID
            SELECT id INTO project_id FROM public.projects WHERE name = (record_data->>'project_name');
            IF project_id IS NULL THEN
                error_count := error_count + 1;
                error_messages := error_messages || ('项目不存在: ' || (record_data->>'project_name'));
                CONTINUE;
            END IF;
            
            -- 获取链路ID
            SELECT id INTO chain_id FROM public.partner_chains 
            WHERE project_id = project_id AND chain_name = (record_data->>'chain_name');
            IF chain_id IS NULL THEN
                error_count := error_count + 1;
                error_messages := error_messages || ('链路不存在: ' || (record_data->>'chain_name'));
                CONTINUE;
            END IF;
            
            -- 获取或创建司机ID
            SELECT id INTO driver_id FROM public.drivers 
            WHERE name = (record_data->>'driver_name') AND license_plate = (record_data->>'license_plate');
            IF driver_id IS NULL THEN
                INSERT INTO public.drivers (name, license_plate, phone, user_id)
                VALUES (
                    record_data->>'driver_name',
                    record_data->>'license_plate',
                    COALESCE(record_data->>'driver_phone', ''),
                    (SELECT auth.uid())
                ) RETURNING id INTO driver_id;
            END IF;
            
            -- 添加运单记录
            new_record_id := public.add_logistics_record_with_costs_v2(
                project_id, chain_id, driver_id,
                record_data->>'project_name',
                record_data->>'chain_name',
                record_data->>'driver_name',
                record_data->>'license_plate',
                record_data->>'loading_location',
                record_data->>'unloading_location',
                record_data->>'loading_date',
                (record_data->>'loading_weight')::numeric,
                COALESCE(record_data->>'transport_type', '实际运输'),
                COALESCE((record_data->>'loading_cost')::numeric, 0),
                COALESCE((record_data->>'unloading_cost')::numeric, 0),
                (SELECT auth.uid())
            );
            
            success_count := success_count + 1;
            
        EXCEPTION WHEN OTHERS THEN
            error_count := error_count + 1;
            error_message := '记录处理失败: ' || SQLERRM;
            error_messages := error_messages || error_message;
        END;
    END LOOP;
    
    RETURN jsonb_build_object(
        'success_count', success_count,
        'error_count', error_count,
        'error_messages', error_messages
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.is_admin
CREATE OR REPLACE FUNCTION public.is_admin(_user_id uuid DEFAULT auth.uid())
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT public.has_role(COALESCE(_user_id, auth.uid()), 'admin')
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.is_admin_for_invoice
CREATE OR REPLACE FUNCTION public.is_admin_for_invoice(_user_id uuid DEFAULT auth.uid())
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT EXISTS (
    SELECT 1 FROM public.profiles
    WHERE id = coalesce(_user_id, auth.uid())
      AND role = 'admin'
  );
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.is_authenticated_user
CREATE OR REPLACE FUNCTION public.is_authenticated_user()
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT auth.uid() IS NOT NULL
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.is_finance_or_admin
CREATE OR REPLACE FUNCTION public.is_finance_or_admin(_user_id uuid DEFAULT auth.uid())
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT public.has_role(COALESCE(_user_id, auth.uid()), 'admin') OR 
         public.has_role(COALESCE(_user_id, auth.uid()), 'finance')
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- 函数: public.is_finance_or_admin_for_invoice
CREATE OR REPLACE FUNCTION public.is_finance_or_admin_for_invoice()
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT (SELECT role::text FROM public.profiles WHERE id = auth.uid()) IN ('admin','finance','operator');
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.is_finance_or_admin_old
CREATE OR REPLACE FUNCTION public.is_finance_or_admin_old()
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$SELECT (SELECT role::text FROM public.profiles WHERE id = auth.uid()) IN ('admin','finance');$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.log_permission_change
CREATE OR REPLACE FUNCTION public.log_permission_change(p_user_id uuid, p_action text, p_permission_type text, p_permission_key text, p_target_user_id uuid DEFAULT NULL::uuid, p_target_project_id uuid DEFAULT NULL::uuid, p_old_value jsonb DEFAULT NULL::jsonb, p_new_value jsonb DEFAULT NULL::jsonb, p_reason text DEFAULT NULL::text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  INSERT INTO public.permission_audit_logs (
    user_id,
    action,
    permission_type,
    permission_key,
    target_user_id,
    target_project_id,
    old_value,
    new_value,
    reason,
    created_by
  ) VALUES (
    p_user_id,
    p_action,
    p_permission_type,
    p_permission_key,
    p_target_user_id,
    p_target_project_id,
    p_old_value,
    p_new_value,
    p_reason,
    auth.uid()
  );
EXCEPTION
  WHEN OTHERS THEN
    RAISE WARNING 'Failed to log permission change: %', SQLERRM;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.log_user_info_change
CREATE OR REPLACE FUNCTION public.log_user_info_change(p_user_id uuid, p_change_type text, p_old_value jsonb, p_new_value jsonb, p_reason text DEFAULT NULL::text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    INSERT INTO public.permission_audit_logs (
        user_id,
        action,
        permission_type,
        permission_key,
        old_value,
        new_value,
        reason,
        created_by
    ) VALUES (
        p_user_id,
        'modify',
        'user',
        p_change_type,
        p_old_value,
        p_new_value,
        p_reason,
        auth.uid()
    );
EXCEPTION
    WHEN OTHERS THEN
        RAISE WARNING 'Failed to log user info change: %', SQLERRM;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.log_user_role_change
CREATE OR REPLACE FUNCTION public.log_user_role_change()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  IF OLD.role IS DISTINCT FROM NEW.role THEN
    PERFORM log_permission_change(
      NEW.id,
      'update',
      'role',
      'user_role',
      NEW.id,
      NULL,
      to_jsonb(OLD.role),
      to_jsonb(NEW.role),
      '用户角色变更'
    );
  END IF;
  
  IF OLD.is_active IS DISTINCT FROM NEW.is_active THEN
    PERFORM log_permission_change(
      NEW.id,
      CASE WHEN NEW.is_active THEN 'activate' ELSE 'deactivate' END,
      'user',
      'user_status',
      NEW.id,
      NULL,
      to_jsonb(OLD.is_active),
      to_jsonb(NEW.is_active),
      '用户状态变更'
    );
  END IF;
  
  RETURN NEW;
EXCEPTION
  WHEN OTHERS THEN
    RAISE WARNING 'Failed to log user change: %', SQLERRM;
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- 函数: public.login_with_username_or_email
CREATE OR REPLACE FUNCTION public.login_with_username_or_email(identifier text)
 RETURNS TABLE(user_email text)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO ''
AS $function$
BEGIN
  -- 由于search_path为空，所有对表的引用都必须是模式限定的（schema-qualified）
  RETURN QUERY
  SELECT p.email
  FROM public.profiles AS p -- 明确使用 public.profiles
  WHERE 
    (p.username = identifier OR p.email = identifier) AND p.is_active = TRUE;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.mark_all_notifications_as_read
CREATE OR REPLACE FUNCTION public.mark_all_notifications_as_read(p_user_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  UPDATE public.notifications
  SET is_read = true, read_at = now()
  WHERE user_id = p_user_id AND is_read = false;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.mark_notification_as_read
CREATE OR REPLACE FUNCTION public.mark_notification_as_read(p_notification_id uuid, p_user_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  UPDATE public.notifications
  SET is_read = true, read_at = now()
  WHERE id = p_notification_id AND user_id = p_user_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.monitor_permission_realtime
CREATE OR REPLACE FUNCTION public.monitor_permission_realtime()
 RETURNS TABLE(status text, message text, update_time timestamp with time zone)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        'realtime_enabled' as status,
        '权限实时更新已启用' as message,
        NOW() as update_time
    UNION ALL
    SELECT 
        'tables_monitored' as status,
        '监控表: user_permissions, role_permission_templates, profiles' as message,
        NOW() as update_time
    UNION ALL
    SELECT 
        'triggers_active' as status,
        '触发器已激活，权限变更将实时通知' as message,
        NOW() as update_time;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.notify_payment_request_created
CREATE OR REPLACE FUNCTION public.notify_payment_request_created()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_project_name text;
  v_total_amount numeric;
  v_user_record record;
BEGIN
  -- ✅ 从partner_payment_items获取关联的运单记录和计算总金额
  -- payment_requests表本身没有project_id和total_amount字段
  SELECT 
    DISTINCT lr.project_name,
    SUM(lpc.payable_amount) OVER () as total_amount
  INTO v_project_name, v_total_amount
  FROM public.partner_payment_items ppi
  JOIN public.logistics_records lr ON ppi.logistics_record_id = lr.id
  LEFT JOIN public.logistics_partner_costs lpc ON ppi.logistics_record_id = lpc.logistics_record_id
  WHERE ppi.payment_request_id = NEW.id
  LIMIT 1;
  
  -- 如果没有找到，使用默认值
  v_project_name := COALESCE(v_project_name, '未知项目');
  v_total_amount := COALESCE(v_total_amount, 0);

  -- 通知所有admin和finance角色的用户
  FOR v_user_record IN 
    SELECT id FROM public.profiles 
    WHERE role IN ('admin', 'finance') AND is_active = true
  LOOP
    PERFORM public.create_payment_request_notification(
      v_user_record.id,
      NEW.id,
      v_total_amount,
      v_project_name
    );
  END LOOP;

  RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- 函数: public.notify_permission_change_safe
CREATE OR REPLACE FUNCTION public.notify_permission_change_safe()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- 发送权限变更通知（只处理profiles表）
    PERFORM pg_notify('permission_changed', json_build_object(
        'table', TG_TABLE_NAME,
        'operation', TG_OP,
        'user_id', COALESCE(NEW.id, OLD.id),
        'role', COALESCE(NEW.role, OLD.role),
        'timestamp', NOW()
    )::text);
    
    RETURN COALESCE(NEW, OLD);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.notify_permission_change_with_sync
CREATE OR REPLACE FUNCTION public.notify_permission_change_with_sync()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    -- 更新同步状态
    PERFORM update_sync_status(TG_TABLE_NAME);
    
    -- 发送权限变更通知
    PERFORM pg_notify('permission_changed', json_build_object(
        'table', TG_TABLE_NAME,
        'operation', TG_OP,
        'user_id', CASE 
            WHEN TG_TABLE_NAME = 'profiles' THEN COALESCE(NEW.id, OLD.id)
            WHEN TG_TABLE_NAME = 'role_permission_templates' THEN auth.uid() -- 修复：使用当前用户ID
            ELSE COALESCE(NEW.user_id, OLD.user_id)
        END,
        'role', CASE 
            WHEN TG_TABLE_NAME = 'role_permission_templates' THEN COALESCE(NEW.role, OLD.role)
            ELSE NULL 
        END,
        'update_time', NOW()
    )::text);
    
    RETURN COALESCE(NEW, OLD);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.parse_location_string
CREATE OR REPLACE FUNCTION public.parse_location_string(location_string text)
 RETURNS text[]
 LANGUAGE plpgsql
AS $function$
DECLARE
    result text[];
    parts text[];
    part text;
BEGIN
    -- 处理空值
    IF location_string IS NULL OR location_string = '' THEN
        RETURN ARRAY[]::text[];
    END IF;
    
    -- 分割字符串
    parts := string_to_array(location_string, '|');
    result := ARRAY[]::text[];
    
    -- 处理每个部分
    FOREACH part IN ARRAY parts LOOP
        part := trim(part);
        IF part != '' THEN
            result := result || part;
        END IF;
    END LOOP;
    
    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.parse_location_string_v2
CREATE OR REPLACE FUNCTION public.parse_location_string_v2(location_string text)
 RETURNS text[]
 LANGUAGE plpgsql
AS $function$
DECLARE
    result text[];
    parts text[];
    part text;
BEGIN
    -- 处理空值
    IF location_string IS NULL OR location_string = '' THEN
        RETURN ARRAY[]::text[];
    END IF;
    
    -- 分割字符串
    parts := string_to_array(location_string, '|');
    result := ARRAY[]::text[];
    
    -- 处理每个部分
    FOREACH part IN ARRAY parts LOOP
        part := trim(part);
        IF part != '' THEN
            result := result || part;
        END IF;
    END LOOP;
    
    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.preview_driver_project_association
CREATE OR REPLACE FUNCTION public.preview_driver_project_association(p_driver_ids uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
DECLARE
    v_result jsonb;
BEGIN
    SELECT jsonb_build_object(
        'drivers', COALESCE(
            jsonb_agg(
                jsonb_build_object(
                    'driver_id', driver_id,
                    'driver_name', driver_name,
                    'license_plate', license_plate,
                    'project_ids', project_ids,
                    'project_names', project_names,
                    'record_count', record_count,
                    'has_projects', array_length(project_ids, 1) > 0
                )
            ),
            '[]'::jsonb
        ),
        'summary', jsonb_build_object(
            'total_drivers', array_length(p_driver_ids, 1),
            'drivers_with_projects', COUNT(*) FILTER (WHERE array_length(project_ids, 1) > 0),
            'drivers_without_projects', COUNT(*) FILTER (WHERE array_length(project_ids, 1) = 0 OR project_ids IS NULL),
            'total_records', SUM(record_count)
        )
    ) INTO v_result
    FROM public.find_driver_projects(p_driver_ids);

    RETURN v_result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.preview_import_v2
CREATE OR REPLACE FUNCTION public.preview_import_v2(p_records jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    result jsonb;
    new_records_array jsonb[] := '{}';
    duplicate_records_array jsonb[] := '{}';
    error_records_array jsonb[] := '{}';
    rec jsonb;
    existing_rec record;
    -- 定义用于判断重复的唯一键
    v_license_plate text;
    v_loading_date date;
    v_loading_location text;
    v_remarks text;
BEGIN
    -- 遍历从前端传入的每一条记录
    FOR rec IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        -- 提取关键字段用于重复检查
        v_license_plate := rec->>'license_plate';
        v_loading_date := (rec->>'loading_date')::date;
        v_loading_location := rec->>'loading_location';
        v_remarks := rec->>'remarks';

        -- 基本校验
        IF v_license_plate IS NULL OR v_loading_date IS NULL OR v_loading_location IS NULL THEN
            error_records_array := error_records_array || jsonb_build_object(
                'record', rec,
                'error', '缺少关键信息: 车牌号、装货日期或装货地点不能为空'
            );
            CONTINUE;
        END IF;

        -- 在 logistics_records 表中查找重复记录
        -- 为了性能，只选择需要的字段
        SELECT id, project_name, driver_name, license_plate, driver_phone, loading_location, unloading_location, loading_date, unloading_date, loading_weight, unloading_weight, current_cost, extra_cost, remarks
        INTO existing_rec
        FROM logistics_records
        WHERE 
            license_plate = v_license_plate AND
            loading_date = v_loading_date AND
            loading_location = v_loading_location AND
            -- 为了更精确匹配，可以对备注进行处理，例如只比较一部分或进行模糊匹配
            -- 这里使用精确匹配
            COALESCE(remarks, '') = COALESCE(v_remarks, '');

        -- 如果找到了重复记录
        IF FOUND THEN
            duplicate_records_array := duplicate_records_array || jsonb_build_object(
                'record', rec, -- 来自Excel的新数据
                'existing_record', to_jsonb(existing_rec) -- 数据库中的现有数据
            );
        ELSE
            -- 如果没有找到重复记录
            new_records_array := new_records_array || jsonb_build_object('record', rec);
        END IF;
    END LOOP;

    -- 构建最终的返回结果
    result := jsonb_build_object(
        'new_records', to_jsonb(new_records_array),
        'duplicate_records', to_jsonb(duplicate_records_array),
        'error_records', to_jsonb(error_records_array)
    );

    RETURN result;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.preview_import_with_duplicates_check
CREATE OR REPLACE FUNCTION public.preview_import_with_duplicates_check(p_records jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    record_data jsonb;
    new_records_json jsonb := '[]'::jsonb;
    duplicate_records_json jsonb := '[]'::jsonb;
    error_records_json jsonb := '[]'::jsonb;
    project_exists boolean;
    is_duplicate boolean;
    chain_name_val text;
    loading_date_formatted text;
    chain_id_val uuid;
    project_id_val uuid;
    processed_record jsonb;
BEGIN
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        -- 1. 检查必填字段（8个关键字段）
        IF (record_data->>'project_name') IS NULL OR TRIM(record_data->>'project_name') = '' OR
           (record_data->>'driver_name') IS NULL OR TRIM(record_data->>'driver_name') = '' OR
           (record_data->>'license_plate') IS NULL OR TRIM(record_data->>'license_plate') = '' OR
           (record_data->>'loading_location') IS NULL OR TRIM(record_data->>'loading_location') = '' OR
           (record_data->>'unloading_location') IS NULL OR TRIM(record_data->>'unloading_location') = '' OR
           (record_data->>'loading_date') IS NULL OR TRIM(record_data->>'loading_date') = '' OR
           (record_data->>'loading_weight') IS NULL OR TRIM(record_data->>'loading_weight') = '' THEN
            error_records_json := error_records_json || jsonb_build_object('record', record_data, 'error', '缺少必填字段（8个关键字段）');
            CONTINUE;
        END IF;

        -- 2. 检查项目是否存在并获取项目ID
        SELECT EXISTS (SELECT 1 FROM public.projects WHERE name = TRIM(record_data->>'project_name')), 
               (SELECT id FROM public.projects WHERE name = TRIM(record_data->>'project_name') LIMIT 1)
        INTO project_exists, project_id_val;
        
        IF NOT project_exists THEN
            error_records_json := error_records_json || jsonb_build_object('record', record_data, 'error', '项目不存在');
            CONTINUE;
        END IF;

        -- 3. 处理合作链路ID
        chain_name_val := TRIM(record_data->>'chain_name');
        IF chain_name_val IS NOT NULL AND chain_name_val != '' THEN
            SELECT id INTO chain_id_val 
            FROM public.partner_chains 
            WHERE chain_name = chain_name_val AND project_id = project_id_val
            LIMIT 1;
        ELSE
            chain_id_val := NULL;
        END IF;

        -- 4. 处理日期格式
        loading_date_formatted := TRIM(record_data->>'loading_date');
        
        -- 5. 检查重复记录（使用8个关键字段）
        SELECT EXISTS (
            SELECT 1 FROM public.logistics_records lr
            LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
            WHERE lr.project_name = TRIM(record_data->>'project_name')
            AND COALESCE(pc.chain_name, '') = COALESCE(chain_name_val, '')
            AND lr.driver_name = TRIM(record_data->>'driver_name')
            AND COALESCE(lr.license_plate, '') = COALESCE(TRIM(record_data->>'license_plate'), '')
            AND COALESCE(lr.driver_phone, '') = COALESCE(TRIM(record_data->>'driver_phone'), '')
            AND lr.loading_location = TRIM(record_data->>'loading_location')
            AND lr.unloading_location = TRIM(record_data->>'unloading_location')
            AND lr.loading_date::date = loading_date_formatted::date
            AND COALESCE(lr.loading_weight, 0) = COALESCE((record_data->>'loading_weight')::numeric, 0)
        ) INTO is_duplicate;

        -- 6. 构建处理后的记录，包含所有字段（包括平台字段）
        processed_record := jsonb_build_object(
            'project_name', TRIM(record_data->>'project_name'),
            'chain_name', chain_name_val,
            'driver_name', TRIM(record_data->>'driver_name'),
            'license_plate', TRIM(record_data->>'license_plate'),
            'driver_phone', TRIM(record_data->>'driver_phone'),
            'loading_location', TRIM(record_data->>'loading_location'),
            'unloading_location', TRIM(record_data->>'unloading_location'),
            'loading_date', loading_date_formatted,
            'unloading_date', TRIM(record_data->>'unloading_date'),
            'loading_weight', record_data->>'loading_weight',
            'unloading_weight', record_data->>'unloading_weight',
            'current_cost', record_data->>'current_cost',
            'extra_cost', record_data->>'extra_cost',
            'transport_type', COALESCE(TRIM(record_data->>'transport_type'), '实际运输'),
            'remarks', TRIM(record_data->>'remarks'),
            -- 平台字段：确保这些字段被正确传递
            'external_tracking_numbers', record_data->'external_tracking_numbers',
            'other_platform_names', record_data->'other_platform_names'
        );

        -- 7. 分类记录
        IF is_duplicate THEN
            duplicate_records_json := duplicate_records_json || jsonb_build_object('record', processed_record);
        ELSE
            new_records_json := new_records_json || jsonb_build_object('record', processed_record);
        END IF;
    END LOOP;

    -- 8. 返回结果
    RETURN jsonb_build_object(
        'new_records', new_records_json,
        'duplicate_records', duplicate_records_json,
        'error_records', error_records_json
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- 函数: public.preview_import_with_duplicates_check_v2
CREATE OR REPLACE FUNCTION public.preview_import_with_duplicates_check_v2(p_records jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    record_data jsonb;
    new_records_json jsonb := '[]'::jsonb;
    duplicate_records_json jsonb := '[]'::jsonb;
    error_records_json jsonb := '[]'::jsonb;
    project_exists boolean;
    is_duplicate boolean;
    chain_name_val text;
    loading_date_formatted text;
BEGIN
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records) LOOP
        -- 1. 检查必填字段和项目是否存在
        IF (record_data->>'project_name') IS NULL OR (record_data->>'project_name') = '' OR
           (record_data->>'driver_name') IS NULL OR (record_data->>'driver_name') = '' OR
           (record_data->>'loading_location') IS NULL OR (record_data->>'loading_location') = '' OR
           (record_data->>'unloading_location') IS NULL OR (record_data->>'unloading_location') = '' OR
           (record_data->>'loading_date') IS NULL OR (record_data->>'loading_date') = '' THEN
            error_records_json := error_records_json || jsonb_build_object('record', record_data, 'error', '缺少必填字段');
            CONTINUE;
        END IF;

        SELECT EXISTS (SELECT 1 FROM public.projects WHERE name = (record_data->>'project_name')) INTO project_exists;
        IF NOT project_exists THEN
            error_records_json := error_records_json || jsonb_build_object('record', record_data, 'error', '项目不存在');
            CONTINUE;
        END IF;

        -- 2. 检查重复记录（使用多地点比较）
        chain_name_val := record_data->>'chain_name';
        loading_date_formatted := (record_data->>'loading_date');
        
        SELECT EXISTS (
            SELECT 1 FROM public.logistics_records lr
            LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id
            WHERE lr.project_name = (record_data->>'project_name')
            AND COALESCE(pc.chain_name, '') = COALESCE(chain_name_val, '')
            AND lr.driver_name = (record_data->>'driver_name')
            AND COALESCE(lr.license_plate, '') = COALESCE(record_data->>'license_plate', '')
            AND public.compare_location_arrays_v2(lr.loading_location, record_data->>'loading_location')
            AND public.compare_location_arrays_v2(lr.unloading_location, record_data->>'unloading_location')
            AND lr.loading_date::date = loading_date_formatted::date
            AND COALESCE(lr.loading_weight, 0) = COALESCE((record_data->>'loading_weight')::numeric, 0)
        ) INTO is_duplicate;

        -- 3. 分类记录
        IF is_duplicate THEN
            duplicate_records_json := duplicate_records_json || jsonb_build_object('record', record_data);
        ELSE
            new_records_json := new_records_json || jsonb_build_object('record', record_data);
        END IF;
    END LOOP;

    -- 4. 返回分类结果
    RETURN jsonb_build_object(
        'new_records', new_records_json,
        'duplicate_records', duplicate_records_json,
        'error_records', error_records_json
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.preview_import_with_optimized_duplicate_check
CREATE OR REPLACE FUNCTION public.preview_import_with_optimized_duplicate_check(p_records jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    record_data jsonb;
    new_records_json jsonb := '[]'::jsonb;
    duplicate_records_json jsonb := '[]'::jsonb;
    error_records_json jsonb := '[]'::jsonb;
    project_exists boolean;
    is_duplicate boolean;
    is_excel_duplicate boolean;
    chain_name_val text;
    loading_date_formatted text;
    chain_id_val uuid;
    existing_record record;
    excel_duplicate_count integer;
    record_index integer := 0;
BEGIN
    -- 处理每条记录
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        record_index := record_index + 1;
        
        -- 1. 检查必填字段（9个关键字段）
        IF (record_data->>'project_name') IS NULL OR (record_data->>'project_name') = '' OR
           (record_data->>'driver_name') IS NULL OR (record_data->>'driver_name') = '' OR
           (record_data->>'license_plate') IS NULL OR (record_data->>'license_plate') = '' OR
           (record_data->>'loading_location') IS NULL OR (record_data->>'loading_location') = '' OR
           (record_data->>'unloading_location') IS NULL OR (record_data->>'unloading_location') = '' OR
           (record_data->>'loading_date') IS NULL OR (record_data->>'loading_date') = '' OR
           (record_data->>'loading_weight') IS NULL OR (record_data->>'loading_weight') = '' OR
           (record_data->>'unloading_weight') IS NULL OR (record_data->>'unloading_weight') = '' THEN
            error_records_json := error_records_json || jsonb_build_object(
                'record', record_data, 
                'error', '缺少必填字段（9个关键字段）',
                'row_index', record_index
            );
            CONTINUE;
        END IF;

        -- 2. 检查项目是否存在
        SELECT EXISTS (SELECT 1 FROM public.projects WHERE name = (record_data->>'project_name')) INTO project_exists;
        IF NOT project_exists THEN
            error_records_json := error_records_json || jsonb_build_object(
                'record', record_data, 
                'error', '项目不存在',
                'row_index', record_index
            );
            CONTINUE;
        END IF;

        -- 3. 获取合作链路ID（如果提供了合作链路名称）
        chain_name_val := record_data->>'chain_name';
        IF chain_name_val IS NOT NULL AND chain_name_val != '' THEN
            SELECT id INTO chain_id_val FROM public.partner_chains WHERE chain_name = chain_name_val;
        ELSE
            chain_id_val := NULL;
        END IF;

        loading_date_formatted := (record_data->>'loading_date');

        -- 4. 优先检测与数据库现有记录重复
        SELECT EXISTS (
            SELECT 1 FROM public.logistics_records lr
            WHERE
                lr.project_name = (record_data->>'project_name')
                AND lr.chain_id = chain_id_val
                AND lr.driver_name = (record_data->>'driver_name')
                AND lr.license_plate = (record_data->>'license_plate')
                AND lr.loading_location = (record_data->>'loading_location')
                AND lr.unloading_location = (record_data->>'unloading_location')
                AND lr.loading_date::date = loading_date_formatted::date
                AND lr.loading_weight = (record_data->>'loading_weight')::numeric
                AND lr.unloading_weight = (record_data->>'unloading_weight')::numeric
        ) INTO is_duplicate;

        -- 5. 分类记录
        IF is_duplicate THEN
            -- 与数据库重复（优先级最高）
            SELECT lr.* INTO existing_record
            FROM public.logistics_records lr
            WHERE
                lr.project_name = (record_data->>'project_name')
                AND lr.chain_id = chain_id_val
                AND lr.driver_name = (record_data->>'driver_name')
                AND lr.license_plate = (record_data->>'license_plate')
                AND lr.loading_location = (record_data->>'loading_location')
                AND lr.unloading_location = (record_data->>'unloading_location')
                AND lr.loading_date::date = loading_date_formatted::date
                AND lr.loading_weight = (record_data->>'loading_weight')::numeric
                AND lr.unloading_weight = (record_data->>'unloading_weight')::numeric
            ORDER BY lr.loading_date DESC, lr.created_at DESC
            LIMIT 1;
            
            duplicate_records_json := duplicate_records_json || jsonb_build_object(
                'record', record_data,
                'existing_auto_number', existing_record.auto_number,
                'existing_loading_date', existing_record.loading_date,
                'existing_created_at', existing_record.created_at,
                'duplicate_type', 'database',
                'row_index', record_index
            );
        ELSE
            -- 数据库无重复时，检测Excel内部重复
            SELECT COUNT(*) INTO excel_duplicate_count
            FROM jsonb_array_elements(p_records) AS other_record
            WHERE 
                TRIM(other_record->>'project_name') = TRIM(record_data->>'project_name')
                AND TRIM(other_record->>'driver_name') = TRIM(record_data->>'driver_name')
                AND TRIM(other_record->>'license_plate') = TRIM(record_data->>'license_plate')
                AND TRIM(other_record->>'loading_location') = TRIM(record_data->>'loading_location')
                AND TRIM(other_record->>'unloading_location') = TRIM(record_data->>'unloading_location')
                AND other_record->>'loading_date' = record_data->>'loading_date'
                AND other_record->>'loading_weight' = record_data->>'loading_weight'
                AND other_record->>'unloading_weight' = record_data->>'unloading_weight'
                AND (
                    (chain_name_val IS NULL AND other_record->>'chain_name' IS NULL) OR
                    (chain_name_val IS NOT NULL AND other_record->>'chain_name' = chain_name_val)
                );

            is_excel_duplicate := excel_duplicate_count > 1;

            IF is_excel_duplicate THEN
                -- Excel内部重复
                duplicate_records_json := duplicate_records_json || jsonb_build_object(
                    'record', record_data,
                    'duplicate_type', 'excel',
                    'duplicate_count', excel_duplicate_count,
                    'row_index', record_index
                );
            ELSE
                -- 新记录
                new_records_json := new_records_json || jsonb_build_object(
                    'record', record_data,
                    'row_index', record_index
                );
            END IF;
        END IF;

    END LOOP;

    -- 6. 返回分类结果
    RETURN jsonb_build_object(
        'new_records', new_records_json,
        'duplicate_records', duplicate_records_json,
        'error_records', error_records_json
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.preview_import_with_update_mode
CREATE OR REPLACE FUNCTION public.preview_import_with_update_mode(p_records jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    new_records_json jsonb := '[]'::jsonb;
    update_records_json jsonb := '[]'::jsonb;
    error_records_json jsonb := '[]'::jsonb;
    record_data jsonb;
    existing_record_id uuid;
    existing_auto_number text;
    is_duplicate boolean;
    processed_record jsonb;
    project_id_val uuid;
    chain_id_val uuid;
BEGIN
    -- 遍历每条记录
    FOR record_data IN SELECT * FROM jsonb_array_elements(p_records)
    LOOP
        BEGIN
            -- 1. 基本字段验证
            IF NOT (record_data ? 'project_name' AND record_data ? 'driver_name' AND 
                   record_data ? 'license_plate' AND record_data ? 'loading_location' AND 
                   record_data ? 'unloading_location' AND record_data ? 'loading_date' AND 
                   record_data ? 'loading_weight') THEN
                error_records_json := error_records_json || jsonb_build_object(
                    'record', record_data,
                    'error', '缺少必填字段'
                );
                CONTINUE;
            END IF;

            -- 2. 检查项目是否存在
            SELECT id INTO project_id_val
            FROM public.projects 
            WHERE name = TRIM(record_data->>'project_name')
            LIMIT 1;

            IF project_id_val IS NULL THEN
                error_records_json := error_records_json || jsonb_build_object(
                    'record', record_data,
                    'error', '项目不存在: ' || record_data->>'project_name'
                );
                CONTINUE;
            END IF;

            -- 3. 获取合作链路（不自动创建）
            chain_id_val := NULL;
            IF record_data->>'chain_name' IS NOT NULL AND TRIM(record_data->>'chain_name') != '' THEN
                SELECT id INTO chain_id_val
                FROM public.partner_chains 
                WHERE chain_name = TRIM(record_data->>'chain_name')
                AND project_id = project_id_val
                LIMIT 1;

                -- 如果找不到链路，使用默认链路
                IF chain_id_val IS NULL THEN
                    SELECT id INTO chain_id_val
                    FROM public.partner_chains 
                    WHERE project_id = project_id_val AND is_default = true
                    LIMIT 1;
                    
                    -- 如果连默认链路都没有，则报错
                    IF chain_id_val IS NULL THEN
                        error_records_json := error_records_json || jsonb_build_object(
                            'record', record_data,
                            'error', '项目没有配置合作链路，请先创建链路'
                        );
                        CONTINUE;
                    END IF;
                END IF;
            ELSE
                -- 如果没有指定链路名称，使用默认链路
                SELECT id INTO chain_id_val
                FROM public.partner_chains 
                WHERE project_id = project_id_val AND is_default = true
                LIMIT 1;
                
                -- 如果连默认链路都没有，则报错
                IF chain_id_val IS NULL THEN
                    error_records_json := error_records_json || jsonb_build_object(
                        'record', record_data,
                        'error', '项目没有配置默认链路，请先创建链路'
                    );
                    CONTINUE;
                END IF;
            END IF;

            -- 4. 检查是否存在重复记录（基于8个关键字段）
            SELECT EXISTS (
                SELECT 1 FROM public.logistics_records lr
                WHERE
                    TRIM(lr.project_name) = TRIM(record_data->>'project_name')                    -- 1. 项目名称
                    AND lr.chain_id = chain_id_val                                               -- 2. 合作链路ID
                    AND TRIM(lr.driver_name) = TRIM(record_data->>'driver_name')                 -- 3. 司机姓名
                    AND TRIM(lr.license_plate) = TRIM(record_data->>'license_plate')             -- 4. 车牌号
                    AND TRIM(lr.loading_location) = TRIM(record_data->>'loading_location')       -- 5. 装货地点
                    AND TRIM(lr.unloading_location) = TRIM(record_data->>'unloading_location')   -- 6. 卸货地点
                    AND lr.loading_date::date = (record_data->>'loading_date')::date             -- 7. 装货日期
                    AND lr.loading_weight = (record_data->>'loading_weight')::numeric            -- 8. 装货数量
            ) INTO is_duplicate;

            -- 5. 分类记录
            IF is_duplicate THEN
                -- 获取现有记录的ID和运单号
                SELECT id, auto_number INTO existing_record_id, existing_auto_number
                FROM public.logistics_records lr
                WHERE
                    TRIM(lr.project_name) = TRIM(record_data->>'project_name')
                    AND lr.chain_id = chain_id_val
                    AND TRIM(lr.driver_name) = TRIM(record_data->>'driver_name')
                    AND TRIM(lr.license_plate) = TRIM(record_data->>'license_plate')
                    AND TRIM(lr.loading_location) = TRIM(record_data->>'loading_location')
                    AND TRIM(lr.unloading_location) = TRIM(record_data->>'unloading_location')
                    AND lr.loading_date::date = (record_data->>'loading_date')::date
                    AND lr.loading_weight = (record_data->>'loading_weight')::numeric;
                
                update_records_json := update_records_json || jsonb_build_object(
                    'record', record_data,
                    'existing_record_id', existing_record_id,
                    'existing_auto_number', existing_auto_number
                );
            ELSE
                new_records_json := new_records_json || jsonb_build_object('record', record_data);
            END IF;

        EXCEPTION WHEN OTHERS THEN
            error_records_json := error_records_json || jsonb_build_object(
                'record', record_data,
                'error', SQLERRM
            );
        END;
    END LOOP;

    -- 返回分类结果
    RETURN jsonb_build_object(
        'new_records', new_records_json,
        'update_records', update_records_json,
        'error_records', error_records_json
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.process_logistics_import
CREATE OR REPLACE FUNCTION public.process_logistics_import(records logistics_data_import_type[])
 RETURNS TABLE(line_number integer, error_message text)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    rec public.logistics_data_import_type;
    idx INT := 0;
    allowed_project_ids UUID[];
    new_record_id UUID;
BEGIN
    SELECT ARRAY(SELECT jsonb_array_elements_text::UUID FROM jsonb_array_elements_text((get_user_projects()->>'project_ids')::jsonb)) INTO allowed_project_ids;
    FOREACH rec IN ARRAY records LOOP
        idx := idx + 1;
        IF rec.project_id IS NULL THEN line_number := idx; error_message := '数据错误：找不到对应的“项目”。请检查Excel中的项目名称是否正确。'; RETURN NEXT; CONTINUE; END IF;
        IF rec.driver_id IS NULL THEN line_number := idx; error_message := '数据错误：找不到对应的“司机”。请检查Excel中的司机电话是否正确。'; RETURN NEXT; CONTINUE; END IF;
        IF rec.loading_location_id IS NULL THEN line_number := idx; error_message := '数据错误：找不到对应的“装货地点”。'; RETURN NEXT; CONTINUE; END IF;
        IF rec.unloading_location_id IS NULL THEN line_number := idx; error_message := '数据错误：找不到对应的“卸货地点”。'; RETURN NEXT; CONTINUE; END IF;

        IF rec.project_id = ANY(allowed_project_ids) THEN
            BEGIN
                INSERT INTO public.logistics_records (project_id, chain_id, driver_id, loading_location_id, unloading_location_id, loading_date, unloading_date, loading_weight, unloading_weight, current_cost, extra_cost, transport_type, remarks)
                VALUES (rec.project_id, rec.chain_id, rec.driver_id, rec.loading_location_id, rec.unloading_location_id, rec.loading_date, rec.unloading_date, rec.loading_weight, rec.unloading_weight, rec.current_cost, rec.extra_cost, rec.transport_type::public.transport_enum, rec.remarks)
                RETURNING id INTO new_record_id;

                PERFORM public.recalculate_and_update_costs_for_record(new_record_id);

            EXCEPTION WHEN OTHERS THEN
                DECLARE error_text TEXT; error_detail TEXT; error_hint TEXT;
                BEGIN GET STACKED DIAGNOSTICS error_text = MESSAGE_TEXT, error_detail = PG_EXCEPTION_DETAIL, error_hint = PG_EXCEPTION_HINT;
                    line_number := idx; error_message := '数据库错误: ' || COALESCE(error_text, 'N/A') || ' | 详情: ' || COALESCE(error_detail, 'N/A'); RETURN NEXT;
                END;
            END;
        ELSE
            line_number := idx; error_message := '权限被拒绝：您无权向此项目添加数据。'; RETURN NEXT;
        END IF;
    END LOOP;
    RETURN;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.process_payment_application
CREATE OR REPLACE FUNCTION public.process_payment_application(p_record_ids uuid[])
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    new_request_id text;
BEGIN
    -- 1. 生成唯一的申请ID (逻辑不变)
    new_request_id := 'PAY' || to_char(now(), 'YYYYMMDDHH24MISS') || substr(gen_random_uuid()::text, 1, 4);

    -- 2. 直接向 payment_requests 插入，包含运单ID数组和运单数量
    INSERT INTO public.payment_requests (
        request_id, 
        user_id, 
        status, 
        record_count, -- 重新加入 record_count 字段
        logistics_record_ids
    )
    VALUES (
        new_request_id, 
        auth.uid(), 
        'Pending', 
        array_length(p_record_ids, 1), -- 动态计算并插入运单数量
        p_record_ids
    );

    -- 3. 更新运单状态 (逻辑不变)
    UPDATE public.logistics_records
    SET payment_status = 'Processing'
    WHERE id = ANY(p_record_ids);

    -- 4. 返回新生成的申请ID (逻辑不变)
    RETURN new_request_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.process_payment_application_old
CREATE OR REPLACE FUNCTION public.process_payment_application_old(p_record_ids uuid[], p_total_amount numeric)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$DECLARE
    new_request_id text;
    new_payment_request_id uuid;
    rec_id uuid;
BEGIN
    new_request_id := 'PAY' || to_char(now(), 'YYYYMMDDHH24MISS') || substr(gen_random_uuid()::text, 1, 4);

    INSERT INTO public.payment_requests (request_id, total_amount, record_count, user_id, status)
    VALUES (new_request_id, p_total_amount, array_length(p_record_ids, 1), auth.uid(), 'Pending')
    RETURNING id INTO new_payment_request_id;

    FOREACH rec_id IN ARRAY p_record_ids
    LOOP
        INSERT INTO public.payment_request_records (payment_request_id, logistics_record_id, user_id)
        VALUES (new_payment_request_id, rec_id, auth.uid());
    END LOOP;

    UPDATE public.logistics_records
    SET payment_status = 'Processing'
    WHERE id = ANY(p_record_ids);

    RETURN new_request_id;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.recalculate_and_update_costs_for_record
CREATE OR REPLACE FUNCTION public.recalculate_and_update_costs_for_record(p_record_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    -- 删除现有的成本记录
    DELETE FROM public.logistics_partner_costs 
    WHERE logistics_record_id = p_record_id;

    -- 重新计算并插入成本记录
    INSERT INTO public.logistics_partner_costs
        (logistics_record_id, partner_id, level, base_amount, payable_amount, tax_rate, user_id)
    SELECT
        records_and_chains.record_id,
        partner_record.partner_id,
        partner_record.level,
        records_and_chains.base_payable_amount,
        CASE
            WHEN partner_record.calculation_method = 'profit' THEN
                records_and_chains.base_payable_amount +
                (COALESCE(partner_record.profit_rate, 0) * records_and_chains.effective_quantity)
            ELSE
                CASE
                    WHEN partner_record.tax_rate IS NOT NULL AND partner_record.tax_rate <> 1 THEN
                        records_and_chains.base_payable_amount / (1 - partner_record.tax_rate)
                    ELSE
                        records_and_chains.base_payable_amount
                END
        END AS payable_amount,
        partner_record.tax_rate,
        auth.uid()
    FROM (
        SELECT
            lr.id as record_id,
            lr.project_id,
            COALESCE(lr.chain_id, pc_default.id) as final_chain_id,
            (COALESCE(lr.current_cost, 0) + COALESCE(lr.extra_cost, 0)) as base_payable_amount,
            -- 使用项目配置的有效数量类型计算有效数量
            public.calculate_effective_quantity(
                lr.loading_weight, 
                lr.unloading_weight, 
                COALESCE(p.effective_quantity_type, 'min_value')
            ) as effective_quantity
        FROM public.logistics_records lr
        LEFT JOIN public.partner_chains pc_default
            ON lr.project_id = pc_default.project_id AND pc_default.is_default = true
        LEFT JOIN public.projects p
            ON lr.project_id = p.id
        WHERE lr.id = p_record_id
    ) AS records_and_chains
    JOIN public.project_partners partner_record
        ON records_and_chains.project_id = partner_record.project_id
        AND records_and_chains.final_chain_id = partner_record.chain_id;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.recalculate_and_update_costs_for_record-old
CREATE OR REPLACE FUNCTION public."recalculate_and_update_costs_for_record-old"(p_record_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$DECLARE
    v_record record;
    v_chain_id uuid;
    partner_record record;
    base_payable_amount numeric;
    current_payable_amount numeric;
    effective_weight numeric;
BEGIN
    SELECT id, project_id, chain_id, current_cost, extra_cost, loading_weight, unloading_weight
    INTO v_record
    FROM public.logistics_records
    WHERE id = p_record_id;

    IF NOT FOUND THEN RETURN; END IF;

    IF v_record.chain_id IS NOT NULL THEN
        v_chain_id := v_record.chain_id;
    ELSE
        SELECT id INTO v_chain_id
        FROM public.partner_chains
        WHERE project_id = v_record.project_id AND is_default = true
        LIMIT 1;
    END IF;

    IF v_chain_id IS NULL THEN RETURN; END IF;

    DELETE FROM public.logistics_partner_costs WHERE logistics_record_id = p_record_id;

    base_payable_amount := COALESCE(v_record.current_cost, 0) + COALESCE(v_record.extra_cost, 0);

    IF base_payable_amount <= 0 THEN RETURN; END IF;
    
    effective_weight := COALESCE(
        NULLIF(LEAST(COALESCE(v_record.loading_weight, 999999), COALESCE(v_record.unloading_weight, 999999)), 999999),
        COALESCE(v_record.loading_weight, v_record.unloading_weight, 0)
    );

    FOR partner_record IN
        SELECT pp.* FROM public.project_partners pp
        WHERE pp.project_id = v_record.project_id AND pp.chain_id = v_chain_id
        ORDER BY pp.level ASC
    LOOP
        IF partner_record.calculation_method = 'profit' THEN
            IF effective_weight > 0 THEN
                 current_payable_amount := base_payable_amount + (COALESCE(partner_record.profit_rate, 0) * effective_weight);
            ELSE
                 current_payable_amount := base_payable_amount + COALESCE(partner_record.profit_rate, 0);
            END IF;
        ELSE
            IF partner_record.tax_rate IS NOT NULL AND partner_record.tax_rate <> 1 THEN
                current_payable_amount := base_payable_amount / (1 - partner_record.tax_rate);
            ELSE
                current_payable_amount := base_payable_amount;
            END IF;
        END IF;

        -- 【加固点】
        INSERT INTO public.logistics_partner_costs
            (logistics_record_id, partner_id, level, base_amount, payable_amount, tax_rate, user_id)
        VALUES
            (p_record_id, partner_record.partner_id, partner_record.level, base_payable_amount, current_payable_amount, partner_record.tax_rate, auth.uid());

    END LOOP;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.recalculate_and_update_costs_for_records
CREATE OR REPLACE FUNCTION public.recalculate_and_update_costs_for_records(p_record_ids uuid[])
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    -- 删除现有的成本记录
    DELETE FROM public.logistics_partner_costs 
    WHERE logistics_record_id = ANY(p_record_ids);

    -- 批量插入新的成本记录
    WITH records_to_process AS (
        SELECT
            lr.id,
            lr.project_id,
            -- 确定有效链路ID
            COALESCE(lr.chain_id, dc.id) AS effective_chain_id,
            -- 计算基础应付金额
            (COALESCE(lr.current_cost, 0) + COALESCE(lr.extra_cost, 0)) AS base_payable_amount,
            -- 计算有效重量
            COALESCE(
                NULLIF(LEAST(COALESCE(lr.loading_weight, 999999), COALESCE(lr.unloading_weight, 999999)), 999999),
                COALESCE(lr.loading_weight, lr.unloading_weight, 0)
            ) AS effective_weight
        FROM
            public.logistics_records lr
        LEFT JOIN -- 查找默认链路
            public.partner_chains dc ON lr.project_id = dc.project_id AND dc.is_default = true
        WHERE
            lr.id = ANY(p_record_ids)
    )
    INSERT INTO public.logistics_partner_costs
        (logistics_record_id, partner_id, level, base_amount, payable_amount, tax_rate, user_id)
    SELECT
        rec.id AS logistics_record_id,
        pp.partner_id,
        pp.level,
        rec.base_payable_amount AS base_amount,
        -- 应用公式计算最终金额
        CASE
            WHEN pp.calculation_method = 'profit' THEN
                CASE
                    WHEN rec.effective_weight > 0 THEN
                        rec.base_payable_amount + (COALESCE(pp.profit_rate, 0) * rec.effective_weight)
                    ELSE
                        rec.base_payable_amount + COALESCE(pp.profit_rate, 0)
                END
            ELSE -- 默认为税点法
                CASE
                    WHEN pp.tax_rate IS NOT NULL AND pp.tax_rate <> 1 THEN
                        rec.base_payable_amount / (1 - pp.tax_rate)
                    ELSE
                        rec.base_payable_amount
                END
        END AS payable_amount,
        pp.tax_rate,
        auth.uid()
    FROM
        records_to_process rec
    -- 将每条运单与其有效链路上的所有合作方进行连接
    JOIN
        public.project_partners pp ON rec.effective_chain_id = pp.chain_id
    WHERE
        rec.effective_chain_id IS NOT NULL AND rec.base_payable_amount > 0;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.recalculate_and_update_costs_for_records_test
CREATE OR REPLACE FUNCTION public.recalculate_and_update_costs_for_records_test(p_record_ids uuid[])
 RETURNS void
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$DECLARE
    -- 这个函数的核心逻辑与您原来的单条计算函数一致，但它基于一个ID数组进行批量操作
BEGIN
    -- 步骤1: 批量删除所有相关的旧成本记录
    DELETE FROM public.logistics_partner_costs
    WHERE logistics_record_id = ANY(p_record_ids);

    -- 步骤2: 使用集合操作，一次性计算并插入所有新的成本记录
    INSERT INTO public.logistics_partner_costs
        (logistics_record_id, partner_id, level, base_amount, payable_amount, tax_rate)
    SELECT
        records_and_chains.record_id,
        partner_record.partner_id,
        partner_record.level,
        records_and_chains.base_payable_amount,
        -- 【核心计算逻辑】根据计算方法，批量计算应付金额
        CASE
            WHEN partner_record.calculation_method = 'profit' THEN
                -- 利润法
                records_and_chains.base_payable_amount +
                (COALESCE(partner_record.profit_rate, 0) * records_and_chains.effective_weight)
            ELSE
                -- 税点法 (已包含除零保护)
                CASE
                    WHEN partner_record.tax_rate IS NOT NULL AND partner_record.tax_rate <> 1 THEN
                        records_and_chains.base_payable_amount / (1 - partner_record.tax_rate)
                    ELSE
                        records_and_chains.base_payable_amount
                END
        END AS payable_amount,
        partner_record.tax_rate
    FROM (
        -- 2.1: 准备计算成本所需的所有基础数据
        SELECT
            lr.id as record_id,
            lr.project_id,
            -- 确定使用的链路ID (优先用记录自带的，否则用项目默认的)
            COALESCE(lr.chain_id, pc_default.id) as final_chain_id,
            -- 计算基础应付金额
            (COALESCE(lr.current_cost, 0) + COALESCE(lr.extra_cost, 0)) as base_payable_amount,
            -- 计算有效重量
            COALESCE(
                NULLIF(LEAST(COALESCE(lr.loading_weight, 999999), COALESCE(lr.unloading_weight, 999999)), 999999),
                COALESCE(lr.loading_weight, lr.unloading_weight, 0)
            ) as effective_weight
        FROM public.logistics_records lr
        LEFT JOIN public.partner_chains pc_default
            ON lr.project_id = pc_default.project_id AND pc_default.is_default = true
        WHERE lr.id = ANY(p_record_ids)
    ) AS records_and_chains
    -- 2.2: 关联每个项目和链路对应的所有合作方
    JOIN public.project_partners partner_record
        ON records_and_chains.project_id = partner_record.project_id
        AND records_and_chains.final_chain_id = partner_record.chain_id;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.remove_external_tracking_number
CREATE OR REPLACE FUNCTION public.remove_external_tracking_number(p_logistics_record_id uuid, p_tracking_number text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_external_tracking JSONB;
  v_updated_array JSONB;
BEGIN
  -- 获取当前的外部运单号数组
  SELECT external_tracking_numbers INTO v_external_tracking
  FROM public.logistics_records
  WHERE id = p_logistics_record_id;
  
  -- 移除指定的运单号
  v_updated_array := (
    SELECT jsonb_agg(elem)
    FROM jsonb_array_elements(v_external_tracking) AS elem
    WHERE elem->>'tracking_number' != p_tracking_number
  );
  
  -- 更新数据库记录
  UPDATE public.logistics_records
  SET external_tracking_numbers = COALESCE(v_updated_array, '[]'::jsonb)
  WHERE id = p_logistics_record_id;
  
  RETURN TRUE;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.resolve_and_preview_import
CREATE OR REPLACE FUNCTION public.resolve_and_preview_import(p_records raw_import_record_input[])
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    rec raw_import_record_input;
    processed_rec processed_import_record_output;
    v_project_id UUID; v_driver_id UUID; v_chain_id UUID; v_loading_location_id UUID; v_unloading_location_id UUID;
    v_existing_record_id UUID;
    new_records_arr JSONB[] := ARRAY[]::JSONB[];
    duplicate_records_arr JSONB[] := ARRAY[]::JSONB[];
BEGIN
    FOREACH rec IN ARRAY p_records LOOP
        -- [终极修复] 使用 '[[:space:]]+' 正则表达式，它可以清除所有类型的空白字符，包括“不换行空格”等隐形字符
        SELECT id INTO v_project_id 
        FROM projects 
        WHERE regexp_replace(name, '[[:space:]]+', '', 'g') = regexp_replace(rec.project_name, '[[:space:]]+', '', 'g') 
        LIMIT 1;

        -- “查找或创建”其他关联项的逻辑保持不变
        IF rec.driver_phone IS NOT NULL AND rec.driver_phone <> '' THEN
            SELECT id INTO v_driver_id FROM drivers WHERE phone = rec.driver_phone LIMIT 1;
            IF NOT FOUND THEN INSERT INTO drivers (name, phone, license_plate) VALUES (rec.driver_name, rec.driver_phone, rec.license_plate) RETURNING id INTO v_driver_id; END IF;
        ELSE v_driver_id := NULL; END IF;

        SELECT id INTO v_loading_location_id FROM locations WHERE name = rec.loading_location LIMIT 1;
        IF NOT FOUND AND rec.loading_location IS NOT NULL AND rec.loading_location <> '' THEN INSERT INTO locations (name, address, type) VALUES (rec.loading_location, rec.loading_location, '装货点') RETURNING id INTO v_loading_location_id; END IF;

        SELECT id INTO v_unloading_location_id FROM locations WHERE name = rec.unloading_location LIMIT 1;
        IF NOT FOUND AND rec.unloading_location IS NOT NULL AND rec.unloading_location <> '' THEN INSERT INTO locations (name, address, type) VALUES (rec.unloading_location, rec.unloading_location, '卸货点') RETURNING id INTO v_unloading_location_id; END IF;

        IF v_project_id IS NOT NULL AND rec.chain_name IS NOT NULL AND rec.chain_name <> '' THEN
            SELECT id INTO v_chain_id FROM partner_chains WHERE chain_name = rec.chain_name AND project_id = v_project_id LIMIT 1;
            IF NOT FOUND THEN INSERT INTO partner_chains (chain_name, project_id) VALUES (rec.chain_name, v_project_id) RETURNING id INTO v_chain_id; END IF;
        ELSE v_chain_id := NULL; END IF;

        -- 重复数据检查逻辑保持不变
        SELECT lr.id INTO v_existing_record_id 
        FROM logistics_records lr
        LEFT JOIN drivers d ON lr.driver_id = d.id
        WHERE
            lr.project_id = v_project_id
            AND lr.chain_id = v_chain_id
            AND lr.loading_date = rec.loading_date
            AND lr.loading_location_id = v_loading_location_id
            AND lr.unloading_location_id = v_unloading_location_id
            AND d.name = rec.driver_name
            AND d.license_plate = rec.license_plate
            AND lr.loading_weight = rec.loading_weight
        LIMIT 1;
        
        processed_rec := (v_project_id, v_chain_id, v_driver_id, v_loading_location_id, v_unloading_location_id, rec.loading_date, rec.unloading_date, rec.loading_weight, rec.unloading_weight, rec.current_cost, rec.extra_cost, rec.transport_type, rec.remarks)::public.processed_import_record_output;

        IF v_existing_record_id IS NOT NULL THEN
            duplicate_records_arr := array_append(duplicate_records_arr, jsonb_build_object('original_row_index', rec.original_row_index, 'record', row_to_json(processed_rec), 'existing_record_id', v_existing_record_id));
        ELSE
            new_records_arr := array_append(new_records_arr, jsonb_build_object('original_row_index', rec.original_row_index, 'record', row_to_json(processed_rec)));
        END IF;
    END LOOP;
    RETURN jsonb_build_object('new_records', new_records_arr, 'duplicate_records', duplicate_records_arr);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| -- 函数: public.rollback_project_functions
CREATE OR REPLACE FUNCTION public.rollback_project_functions()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- 删除新创建的函数
  DROP FUNCTION IF EXISTS public.get_projects_with_details_fixed();
  DROP FUNCTION IF EXISTS public.save_project_with_chains_fixed();
  DROP FUNCTION IF EXISTS public.rollback_project_functions();
  
  RAISE NOTICE '项目函数已回滚到原始状态';
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.safe_cast_effective_quantity_type
CREATE OR REPLACE FUNCTION public.safe_cast_effective_quantity_type(input_text text)
 RETURNS effective_quantity_type
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- 检查输入值是否有效
  IF input_text IN ('min_value', 'loading', 'unloading') THEN
    RETURN input_text::effective_quantity_type;
  ELSE
    -- 如果无效，返回默认值
    RETURN 'min_value'::effective_quantity_type;
  END IF;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.safe_delete_logistics_records_by_project_v2
CREATE OR REPLACE FUNCTION public.safe_delete_logistics_records_by_project_v2(p_project_name text)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_record_ids UUID[];
    v_result JSON;
BEGIN
    -- 检查权限
    IF NOT public.is_admin_or_operator() THEN
        RAISE EXCEPTION '权限不足：只有管理员或操作员可以删除运单';
    END IF;
    
    -- 获取项目下的所有运单ID
    SELECT ARRAY_AGG(id) INTO v_record_ids
    FROM public.logistics_records
    WHERE project_name = p_project_name;
    
    -- 如果没有运单记录
    IF v_record_ids IS NULL OR array_length(v_record_ids, 1) = 0 THEN
        RETURN json_build_object(
            'success', true,
            'deleted_count', 0,
            'message', '该项目下没有运单记录'
        );
    END IF;
    
    -- 调用新的批量删除函数
    SELECT public.safe_delete_logistics_records_v2(v_record_ids) INTO v_result;
    
    RETURN v_result;
    
EXCEPTION WHEN OTHERS THEN
    RETURN json_build_object(
        'success', false,
        'message', '按项目删除运单失败: ' || SQLERRM
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.safe_delete_logistics_records_v2
CREATE OR REPLACE FUNCTION public.safe_delete_logistics_records_v2(p_record_ids uuid[])
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_record_id UUID;
    v_auto_number TEXT;
    v_deleted_count INTEGER := 0;
    v_failed_count INTEGER := 0;
    v_failed_records TEXT[] := '{}';
    v_result JSON;
BEGIN
    -- 检查权限
    IF NOT public.is_admin_or_operator() THEN
        RAISE EXCEPTION '权限不足：只有管理员或操作员可以删除运单';
    END IF;
    
    -- 逐个删除运单记录
    FOREACH v_record_id IN ARRAY p_record_ids
    LOOP
        BEGIN
            -- 获取运单号用于错误报告
            SELECT auto_number INTO v_auto_number
            FROM public.logistics_records
            WHERE id = v_record_id;
            
            -- 删除运单记录（触发器会自动处理相关数据）
            DELETE FROM public.logistics_records 
            WHERE id = v_record_id;
            
            v_deleted_count := v_deleted_count + 1;
            
        EXCEPTION WHEN OTHERS THEN
            v_failed_count := v_failed_count + 1;
            v_failed_records := v_failed_records || v_auto_number;
            
            -- 记录错误但不中断整个操作
            INSERT INTO public.operation_logs (
                operation_type,
                table_name,
                record_id,
                record_info,
                operated_by,
                operated_at
            ) VALUES (
                'DELETE_FAILED',
                'logistics_records',
                v_record_id,
                json_build_object(
                    'auto_number', v_auto_number,
                    'error_message', SQLERRM
                ),
                auth.uid(),
                NOW()
            );
        END;
    END LOOP;
    
    -- 返回结果
    v_result := json_build_object(
        'success', true,
        'deleted_count', v_deleted_count,
        'failed_count', v_failed_count,
        'failed_records', v_failed_records,
        'message', format('成功删除 %s 条运单记录，%s 条删除失败', v_deleted_count, v_failed_count)
    );
    
    RETURN v_result;
    
EXCEPTION WHEN OTHERS THEN
    RETURN json_build_object(
        'success', false,
        'message', '批量删除运单失败: ' || SQLERRM
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.safe_numeric_conversion
CREATE OR REPLACE FUNCTION public.safe_numeric_conversion(input_text text, default_value numeric DEFAULT 0)
 RETURNS numeric
 LANGUAGE plpgsql
 IMMUTABLE
AS $function$
BEGIN
    -- 如果输入为空或null，返回默认值
    IF input_text IS NULL OR TRIM(input_text) = '' THEN
        RETURN default_value;
    END IF;
    
    -- 清理字符串：移除前后空格
    input_text := TRIM(input_text);
    
    -- 处理特殊情况
    CASE input_text
        WHEN '--', '---', '----', '-----' THEN
            RETURN default_value;
        WHEN '-', '--', '---', '----', '-----' THEN
            RETURN default_value;
        ELSE
            -- 尝试提取数字部分
            -- 匹配模式：可选的正负号 + 数字 + 可选的小数点 + 数字
            IF input_text ~ '^[+-]?[0-9]+(\.[0-9]+)?$' THEN
                BEGIN
                    RETURN input_text::numeric;
                EXCEPTION WHEN OTHERS THEN
                    RETURN default_value;
                END;
            ELSE
                -- 尝试提取数字部分（移除非数字字符）
                DECLARE
                    cleaned_text text;
                BEGIN
                    -- 处理特殊格式如 "-0-3" -> "-3", "-0-5" -> "-5"
                    cleaned_text := input_text;
                    
                    -- 处理 "-0-3" 格式：提取最后一个数字部分
                    IF cleaned_text ~ '^-0-[0-9]+$' THEN
                        cleaned_text := '-' || regexp_replace(cleaned_text, '^-0-', '');
                    END IF;
                    
                    -- 处理其他连续符号的情况
                    cleaned_text := regexp_replace(cleaned_text, '^[+-]+', 
                        CASE 
                            WHEN length(regexp_replace(cleaned_text, '[^+-]', '', 'g')) % 2 = 0 THEN '+'
                            ELSE '-'
                        END
                    );
                    
                    -- 提取数字、小数点、正负号
                    cleaned_text := regexp_replace(cleaned_text, '[^0-9+-.]', '', 'g');
                    
                    -- 如果清理后为空，返回默认值
                    IF cleaned_text = '' OR cleaned_text = '+' OR cleaned_text = '-' THEN
                        RETURN default_value;
                    END IF;
                    
                    -- 验证清理后的文本是否为有效数字
                    IF cleaned_text ~ '^[+-]?[0-9]+(\.[0-9]+)?$' THEN
                        RETURN cleaned_text::numeric;
                    ELSE
                        RETURN default_value;
                    END IF;
                EXCEPTION WHEN OTHERS THEN
                    RETURN default_value;
                END;
            END IF;
    END CASE;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.save_invoice_request
CREATE OR REPLACE FUNCTION public.save_invoice_request(p_record_ids uuid[])
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_max_level integer;
    v_partner_id uuid;
    v_partner_info record;
    v_request_id uuid;
    v_request_number text;
    v_total_amount numeric := 0;
    v_record_count integer := 0;
    v_partner_costs record;
    created_requests jsonb[] := '{}';
    v_processed_record_ids uuid[] := '{}';
BEGIN
    -- 检查权限
    IF NOT public.is_finance_or_admin_for_invoice() THEN
        RAISE EXCEPTION '权限不足：只有财务人员或管理员可以创建开票申请';
    END IF;

    -- 找出最高级别
    SELECT MAX(level) INTO v_max_level
    FROM public.logistics_partner_costs
    WHERE logistics_record_id = ANY(p_record_ids)
      AND invoice_status = 'Uninvoiced';

    IF v_max_level IS NULL THEN
        RAISE EXCEPTION '没有找到符合条件的未开票运单';
    END IF;

    -- 按合作方分组处理
    FOR v_partner_id IN
        SELECT DISTINCT partner_id
        FROM public.logistics_partner_costs
        WHERE logistics_record_id = ANY(p_record_ids)
          AND level = v_max_level
          AND invoice_status = 'Uninvoiced'
    LOOP
        -- 获取合作方信息
        SELECT 
            p.id,
            p.name,
            p.full_name,
            pbd.tax_number,
            pbd.company_address,
            pbd.bank_name,
            pbd.bank_account
        INTO v_partner_info
        FROM public.partners p
        LEFT JOIN public.partner_bank_details pbd ON p.id = pbd.partner_id
        WHERE p.id = v_partner_id;

        -- 生成申请编号
        v_request_number := public.generate_invoice_request_number();

        -- 统计金额和记录数
        SELECT 
            COUNT(*),
            SUM(lpc.payable_amount)
        INTO v_record_count, v_total_amount
        FROM public.logistics_partner_costs lpc
        WHERE lpc.logistics_record_id = ANY(p_record_ids)
          AND lpc.partner_id = v_partner_id
          AND lpc.level = v_max_level
          AND lpc.invoice_status = 'Uninvoiced';
        
        -- 创建开票申请记录
        INSERT INTO public.invoice_requests (
            request_number,
            partner_id,
            invoicing_partner_id,
            partner_name,
            partner_full_name,
            tax_number,
            company_address,
            bank_name,
            bank_account,
            total_amount,
            record_count,
            status,
            created_by,
            created_at
        ) VALUES (
            v_request_number,
            v_partner_id,
            v_partner_id,
            v_partner_info.name,
            v_partner_info.full_name,
            v_partner_info.tax_number,
            v_partner_info.company_address,
            v_partner_info.bank_name,
            v_partner_info.bank_account,
            v_total_amount,
            v_record_count,
            'Pending',
            auth.uid(),
            NOW()
        ) RETURNING id INTO v_request_id;
        
        -- 创建开票申请明细并更新状态
        FOR v_partner_costs IN
            SELECT 
                lpc.id as cost_id,
                lpc.logistics_record_id,
                lpc.payable_amount
            FROM public.logistics_partner_costs lpc
            WHERE lpc.logistics_record_id = ANY(p_record_ids)
              AND lpc.partner_id = v_partner_id
              AND lpc.level = v_max_level
              AND lpc.invoice_status = 'Uninvoiced'
        LOOP
            -- 插入开票申请明细
            INSERT INTO public.invoice_request_details (
                invoice_request_id,
                logistics_record_id,
                amount
            ) VALUES (
                v_request_id,
                v_partner_costs.logistics_record_id,
                v_partner_costs.payable_amount
            );
            
            -- 更新合作方成本状态
            UPDATE public.logistics_partner_costs
            SET 
                invoice_status = 'Processing',
                invoice_request_id = v_request_id,
                invoice_applied_at = NOW()
            WHERE id = v_partner_costs.cost_id;

            -- 收集已处理的运单ID
            v_processed_record_ids := v_processed_record_ids || v_partner_costs.logistics_record_id;
        END LOOP;
        
        -- 记录创建的申请
        created_requests := created_requests || jsonb_build_object(
            'request_id', v_request_id,
            'request_number', v_request_number,
            'partner_id', v_partner_id,
            'partner_name', v_partner_info.full_name,
            'total_amount', v_total_amount,
            'record_count', v_record_count
        );
    END LOOP;

    -- ✅ 关键修复：更新 logistics_records 表的状态
    -- 将所有已处理的运单状态更新为 'Processing'
    UPDATE public.logistics_records
    SET 
        invoice_status = 'Processing',
        invoice_applied_at = NOW(),
        invoice_request_id = (
            SELECT ir.id 
            FROM public.invoice_requests ir 
            WHERE ir.id = (
                SELECT ird.invoice_request_id 
                FROM public.invoice_request_details ird 
                WHERE ird.logistics_record_id = logistics_records.id 
                LIMIT 1
            )
        )
    WHERE id = ANY(v_processed_record_ids);

    -- 返回结果
    RETURN jsonb_build_object(
        'success', true,
        'message', '开票申请创建成功',
        'created_requests', created_requests,
        'total_requests', array_length(created_requests, 1),
        'processed_record_ids', v_processed_record_ids
    );

EXCEPTION WHEN OTHERS THEN
    RAISE EXCEPTION '创建开票申请失败: %', SQLERRM;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.save_invoice_request_1014
CREATE OR REPLACE FUNCTION public.save_invoice_request_1014(p_invoice_data json)
 RETURNS json
 LANGUAGE plpgsql
AS $function$DECLARE
  updated_count INTEGER;
BEGIN
  -- 更新开票状态
  UPDATE logistics_records 
  SET invoice_status = 'Processing'
  WHERE id::TEXT = ANY(
    SELECT value::TEXT 
    FROM JSON_ARRAY_ELEMENTS_TEXT(p_invoice_data->'all_record_ids')
  );
  
  GET DIAGNOSTICS updated_count = ROW_COUNT;
  
  RETURN JSON_BUILD_OBJECT(
    'success', true,
    'updated_records', updated_count,
    'message', '开票申请已成功创建'
  );
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.save_invoice_request_no
CREATE OR REPLACE FUNCTION public.save_invoice_request_no(p_record_ids uuid[], p_invoice_status text DEFAULT 'Processing'::text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$DECLARE
    result_json jsonb;
    updated_count integer := 0;
BEGIN
    -- 更新logistics_records表的invoice_status
    UPDATE logistics_records 
    SET invoice_status = p_invoice_status
    WHERE id = ANY(p_record_ids);
    
    GET DIAGNOSTICS updated_count = ROW_COUNT;
    
    -- 更新logistics_partner_costs表的invoice_status
    UPDATE logistics_partner_costs 
    SET invoice_status = p_invoice_status
    WHERE logistics_record_id = ANY(p_record_ids);
    
    result_json := jsonb_build_object(
        'success', true,
        'updated_records', updated_count,
        'message', '开票申请保存成功'
    );
    
    RETURN result_json;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.save_project_addresses_to_locations
CREATE OR REPLACE FUNCTION public.save_project_addresses_to_locations(p_project_id uuid, p_loading_address text, p_unloading_address text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    -- Create/associate loading address
    IF p_loading_address IS NOT NULL AND p_loading_address != '' THEN
        PERFORM public.get_or_create_location_with_project(p_loading_address, p_project_id);
    END IF;
    
    -- Create/associate unloading address  
    IF p_unloading_address IS NOT NULL AND p_unloading_address != '' THEN
        PERFORM public.get_or_create_location_with_project(p_unloading_address, p_project_id);
    END IF;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.save_project_with_chains
CREATE OR REPLACE FUNCTION public.save_project_with_chains(project_id_in uuid, project_data jsonb, chains_data jsonb)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_project_id uuid;
  chain jsonb;
  v_chain_id uuid;
  partner jsonb;
BEGIN
  -- 第一步：更新或插入项目主表 (projects)
  IF project_id_in IS NOT NULL THEN
    v_project_id := project_id_in;
    UPDATE public.projects
    SET
      name = project_data->>'name',
      start_date = (project_data->>'start_date')::date,
      end_date = (project_data->>'end_date')::date,
      manager = project_data->>'manager',
      loading_address = project_data->>'loading_address',
      unloading_address = project_data->>'unloading_address',
      finance_manager = project_data->>'finance_manager',
      planned_total_tons = NULLIF(project_data->>'planned_total_tons', '')::numeric,
      cargo_type = COALESCE(NULLIF(project_data->>'cargo_type', ''), '货品')
    WHERE id = v_project_id;
  ELSE
    INSERT INTO public.projects (
      user_id,
      project_status,
      name,
      start_date,
      end_date,
      manager,
      loading_address,
      unloading_address,
      finance_manager,
      planned_total_tons,
      cargo_type
    )
    VALUES (
      auth.uid(),
      '进行中',
      project_data->>'name',
      (project_data->>'start_date')::date,
      (project_data->>'end_date')::date,
      project_data->>'manager',
      project_data->>'loading_address',
      project_data->>'unloading_address',
      project_data->>'finance_manager',
      NULLIF(project_data->>'planned_total_tons', '')::numeric,
      COALESCE(NULLIF(project_data->>'cargo_type', ''), '货品')
    ) RETURNING id INTO v_project_id;
  END IF;

  -- 确保项目ID有效
  IF v_project_id IS NULL THEN
    RAISE EXCEPTION '无法确定项目ID，操作已回滚。';
  END IF;

  -- 第二步：处理地址 (locations)
  PERFORM public.get_or_create_location(project_data->>'loading_address', v_project_id);
  PERFORM public.get_or_create_location(project_data->>'unloading_address', v_project_id);

  -- 第三步：清空旧的链路和合作方数据，为写入新数据做准备
  -- 注意：这是一种“先删后增”的简单策略
  DELETE FROM public.project_partners WHERE project_id = v_project_id;
  DELETE FROM public.partner_chains WHERE project_id = v_project_id;

  -- 第四步：遍历并插入新的链路和合作方数据
  FOR chain IN SELECT * FROM jsonb_array_elements(chains_data)
  LOOP
    -- 【【【核心修复】】】
    -- 在 INSERT 语句中添加 billing_type_id 字段及其对应的值
    INSERT INTO public.partner_chains (
        project_id, 
        chain_name, 
        description, 
        is_default, 
        user_id, 
        billing_type_id -- 1. 在列清单中添加
    )
    VALUES (
        v_project_id, 
        chain->>'chain_name', 
        chain->>'description', 
        (chain->>'is_default')::boolean, 
        auth.uid(),
        (chain->>'billing_type_id')::integer -- 2. 从 JSON 中提取对应的值
    )
    RETURNING id INTO v_chain_id;

    -- 遍历并插入当前链路下的所有合作方
    FOR partner IN SELECT * FROM jsonb_array_elements(chain->'partners')
    LOOP
      INSERT INTO public.project_partners (
        project_id, chain_id, partner_id, level,
        tax_rate, calculation_method, profit_rate, user_id
      )
      VALUES (
        v_project_id, v_chain_id, (partner->>'partner_id')::uuid, (partner->>'level')::integer,
        (partner->>'tax_rate')::numeric, partner->>'calculation_method', (partner->>'profit_rate')::numeric, auth.uid()
      );
    END LOOP;
  END LOOP;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.save_project_with_chains_bak
CREATE OR REPLACE FUNCTION public.save_project_with_chains_bak(project_id_in uuid, project_data jsonb, chains_data jsonb)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$DECLARE
  v_project_id uuid;
  chain jsonb;
  v_chain_id uuid;
  partner jsonb;
BEGIN
  IF project_id_in IS NOT NULL THEN
    v_project_id := project_id_in;
    UPDATE public.projects
    SET
      name = project_data->>'name',
      start_date = (project_data->>'start_date')::date,
      end_date = (project_data->>'end_date')::date,
      manager = project_data->>'manager',
      loading_address = project_data->>'loading_address',
      unloading_address = project_data->>'unloading_address',
      finance_manager = project_data->>'finance_manager',
      planned_total_tons = NULLIF(project_data->>'planned_total_tons', '')::numeric,
      cargo_type = COALESCE(NULLIF(project_data->>'cargo_type', ''), '货品')
    WHERE id = v_project_id;
  ELSE
    INSERT INTO public.projects (
      user_id,
      project_status,
      name,
      start_date,
      end_date,
      manager,
      loading_address,
      unloading_address,
      finance_manager,
      planned_total_tons,
      cargo_type
    )
    VALUES (
      auth.uid(),
      '进行中',
      project_data->>'name',
      (project_data->>'start_date')::date,
      (project_data->>'end_date')::date,
      project_data->>'manager',
      project_data->>'loading_address',
      project_data->>'unloading_address',
      project_data->>'finance_manager',
      NULLIF(project_data->>'planned_total_tons', '')::numeric,
      COALESCE(NULLIF(project_data->>'cargo_type', ''), '货品')
    ) RETURNING id INTO v_project_id;
  END IF;

  IF v_project_id IS NULL THEN
    RAISE EXCEPTION '无法确定项目ID，操作已回滚。';
  END IF;

  PERFORM public.get_or_create_location(project_data->>'loading_address', v_project_id);
  PERFORM public.get_or_create_location(project_data->>'unloading_address', v_project_id);

  DELETE FROM public.project_partners WHERE project_id = v_project_id;
  DELETE FROM public.partner_chains WHERE project_id = v_project_id;

  FOR chain IN SELECT * FROM jsonb_array_elements(chains_data)
  LOOP
    INSERT INTO public.partner_chains (project_id, chain_name, description, is_default, user_id)
    VALUES (v_project_id, chain->>'chain_name', chain->>'description', (chain->>'is_default')::boolean, auth.uid())
    RETURNING id INTO v_chain_id;

    FOR partner IN SELECT * FROM jsonb_array_elements(chain->'partners')
    LOOP
      INSERT INTO public.project_partners (
        project_id, chain_id, partner_id, level,
        tax_rate, calculation_method, profit_rate, user_id
      )
      VALUES (
        v_project_id, v_chain_id, (partner->>'partner_id')::uuid, (partner->>'level')::integer,
        (partner->>'tax_rate')::numeric, partner->>'calculation_method', (partner->>'profit_rate')::numeric, auth.uid()
      );
    END LOOP;
  END LOOP;
END;$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.save_project_with_chains_fixed
CREATE OR REPLACE FUNCTION public.save_project_with_chains_fixed(project_id_in uuid, project_data jsonb, chains_data jsonb)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_project_id uuid;
  chain jsonb;
  v_chain_id uuid;
  partner jsonb;
BEGIN
  -- 确保项目ID不为空
  IF project_id_in IS NOT NULL THEN
    v_project_id := project_id_in;
    
    -- 更新现有项目
    UPDATE public.projects
    SET
      name = project_data->>'name',
      start_date = (project_data->>'start_date')::date,
      end_date = (project_data->>'end_date')::date,
      manager = project_data->>'manager',
      loading_address = project_data->>'loading_address',
      unloading_address = project_data->>'unloading_address',
      finance_manager = project_data->>'finance_manager',
      planned_total_tons = NULLIF(project_data->>'planned_total_tons', '')::numeric,
      cargo_type = project_data->>'cargo_type',
      project_status = project_data->>'project_status',
      effective_quantity_type = (project_data->>'effective_quantity_type')::effective_quantity_type
    WHERE id = v_project_id;
    
    -- 检查更新是否成功
    IF NOT FOUND THEN
      RAISE EXCEPTION '项目不存在或更新失败，项目ID: %', v_project_id;
    END IF;
  ELSE
    -- 创建新项目
    INSERT INTO public.projects (
      user_id,
      project_status,
      name,
      start_date,
      end_date,
      manager,
      loading_address,
      unloading_address,
      finance_manager,
      planned_total_tons,
      cargo_type,
      effective_quantity_type
    )
    VALUES (
      auth.uid(),
      COALESCE(project_data->>'project_status', '进行中'),
      project_data->>'name',
      (project_data->>'start_date')::date,
      (project_data->>'end_date')::date,
      project_data->>'manager',
      project_data->>'loading_address',
      project_data->>'unloading_address',
      project_data->>'finance_manager',
      NULLIF(project_data->>'planned_total_tons', '')::numeric,
      project_data->>'cargo_type',
      COALESCE((project_data->>'effective_quantity_type')::effective_quantity_type, 'min_value'::effective_quantity_type)
    ) RETURNING id INTO v_project_id;
  END IF;

  -- 验证项目ID是否有效
  IF v_project_id IS NULL THEN
    RAISE EXCEPTION '无法确定项目ID，操作已回滚。项目ID输入: %', project_id_in;
  END IF;

  -- 保存项目地址到地点数据库（如果函数存在）
  BEGIN
    PERFORM public.get_or_create_location(project_data->>'loading_address', v_project_id);
    PERFORM public.get_or_create_location(project_data->>'unloading_address', v_project_id);
  EXCEPTION WHEN OTHERS THEN
    -- 如果地点函数不存在，忽略错误
    NULL;
  END;

  -- 删除旧的关系数据
  DELETE FROM public.project_partners WHERE project_id = v_project_id;
  DELETE FROM public.partner_chains WHERE project_id = v_project_id;

  -- 创建新的合作链路和合作方
  FOR chain IN SELECT * FROM jsonb_array_elements(chains_data)
  LOOP
    -- ✅ 修改：添加 billing_type_id 字段
    INSERT INTO public.partner_chains (project_id, chain_name, description, is_default, billing_type_id, user_id)
    VALUES (v_project_id, chain->>'chain_name', chain->>'description', (chain->>'is_default')::boolean, (chain->>'billing_type_id')::bigint, auth.uid())
    RETURNING id INTO v_chain_id;

    FOR partner IN SELECT * FROM jsonb_array_elements(chain->'partners')
    LOOP
      INSERT INTO public.project_partners (
        project_id, chain_id, partner_id, level,
        tax_rate, calculation_method, profit_rate, user_id
      )
      VALUES (
        v_project_id, v_chain_id, (partner->>'partner_id')::uuid, (partner->>'level')::integer,
        (partner->>'tax_rate')::numeric, partner->>'calculation_method', (partner->>'profit_rate')::numeric, auth.uid()
      );
    END LOOP;
  END LOOP;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.save_project_with_chains_safe
CREATE OR REPLACE FUNCTION public.save_project_with_chains_safe(project_id_in uuid, project_data jsonb, chains_data jsonb)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_project_id uuid;
BEGIN
  IF project_id_in IS NOT NULL THEN
    -- 更新现有项目（使用安全转换）
    UPDATE public.projects
    SET
      name = project_data->>'name',
      start_date = (project_data->>'start_date')::date,
      end_date = (project_data->>'end_date')::date,
      manager = project_data->>'manager',
      loading_address = project_data->>'loading_address',
      unloading_address = project_data->>'unloading_address',
      finance_manager = project_data->>'finance_manager',
      planned_total_tons = NULLIF(project_data->>'planned_total_tons', '')::numeric,
      cargo_type = project_data->>'cargo_type',
      project_status = project_data->>'project_status',
      effective_quantity_type = public.safe_cast_effective_quantity_type(project_data->>'effective_quantity_type')
    WHERE id = v_project_id;
  ELSE
    -- 创建新项目（使用安全转换）
    INSERT INTO public.projects (
      user_id,
      project_status,
      name,
      start_date,
      end_date,
      manager,
      loading_address,
      unloading_address,
      finance_manager,
      planned_total_tons,
      cargo_type,
      effective_quantity_type
    )
    VALUES (
      auth.uid(),
      COALESCE(project_data->>'project_status', '进行中'),
      project_data->>'name',
      (project_data->>'start_date')::date,
      (project_data->>'end_date')::date,
      project_data->>'manager',
      project_data->>'loading_address',
      project_data->>'unloading_address',
      project_data->>'finance_manager',
      NULLIF(project_data->>'planned_total_tons', '')::numeric,
      project_data->>'cargo_type',
      public.safe_cast_effective_quantity_type(COALESCE(project_data->>'effective_quantity_type', 'min_value'))
    ) RETURNING id INTO v_project_id;
  END IF;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| -- 函数: public.schedule_permission_maintenance
CREATE OR REPLACE FUNCTION public.schedule_permission_maintenance()
 RETURNS TABLE(maintenance_task text, status text, next_run timestamp with time zone)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        'cache_cleanup' as maintenance_task,
        '手动执行: SELECT cleanup_permission_cache();' as status,
        NOW() + INTERVAL '1 hour' as next_run
    UNION ALL
    SELECT 
        'stats_update' as maintenance_task,
        '手动执行: SELECT update_permission_performance_stats();' as status,
        NOW() + INTERVAL '1 day' as next_run;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.search_locations_with_geocoding
CREATE OR REPLACE FUNCTION public.search_locations_with_geocoding(p_query text DEFAULT ''::text, p_include_coordinates boolean DEFAULT true)
 RETURNS TABLE(id uuid, name text, address text, latitude numeric, longitude numeric, formatted_address text, province text, city text, district text, geocoding_status geocoding_status)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        l.id,
        l.name,
        l.address,
        CASE WHEN p_include_coordinates THEN l.latitude ELSE NULL END,
        CASE WHEN p_include_coordinates THEN l.longitude ELSE NULL END,
        l.formatted_address,
        l.province,
        l.city,
        l.district,
        l.geocoding_status
    FROM public.locations l
    WHERE 
        (p_query = '' OR p_query IS NULL OR 
         l.name ILIKE '%' || p_query || '%' OR
         l.address ILIKE '%' || p_query || '%' OR
         l.formatted_address ILIKE '%' || p_query || '%')
    ORDER BY 
        CASE 
            WHEN l.geocoding_status = 'success' THEN 1
            WHEN l.geocoding_status = 'pending' THEN 2
            WHEN l.geocoding_status = 'failed' THEN 3
        END,
        l.name ASC;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.search_project_linked_items
CREATE OR REPLACE FUNCTION public.search_project_linked_items(p_project_id uuid, p_item_type text, p_search_term text)
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE
 SET search_path TO 'public'
AS $function$
BEGIN
    IF p_item_type = 'drivers' THEN
        RETURN (
            SELECT COALESCE(jsonb_agg(d.*), '[]'::jsonb)
            FROM 
                driver_projects dp -- [核心修复] - 从关联表开始
            JOIN 
                drivers d ON dp.driver_id = d.id -- 然后JOIN主表
            WHERE 
                dp.project_id = p_project_id
                AND (
                    p_search_term IS NULL OR 
                    p_search_term = '' OR 
                    d.name ILIKE '%' || p_search_term || '%' OR
                    d.license_plate ILIKE '%' || p_search_term || '%'
                )
            LIMIT 10
        );
    ELSIF p_item_type = 'locations' THEN
        RETURN (
            SELECT COALESCE(jsonb_agg(l.*), '[]'::jsonb)
            FROM 
                location_projects lp -- [核心修复] - 从关联表开始
            JOIN 
                locations l ON lp.location_id = l.id -- 然后JOIN主表
            WHERE 
                lp.project_id = p_project_id
                AND (
                    p_search_term IS NULL OR 
                    p_search_term = '' OR 
                    l.name ILIKE '%' || p_search_term || '%'
                )
            LIMIT 10
        );
    END IF;
    
    RETURN '[]'::jsonb;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- 函数: public.set_cached_permissions
CREATE OR REPLACE FUNCTION public.set_cached_permissions(p_cache_key text, p_data jsonb, p_expires_minutes integer DEFAULT 5)
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
    INSERT INTO permission_cache (cache_key, cache_data, expires_at)
    VALUES (p_cache_key, p_data, NOW() + (p_expires_minutes || ' minutes')::INTERVAL)
    ON CONFLICT (cache_key) 
    DO UPDATE SET 
        cache_data = EXCLUDED.cache_data,
        expires_at = EXCLUDED.expires_at;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.set_logistics_records_default_status
CREATE OR REPLACE FUNCTION public.set_logistics_records_default_status()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    -- 设置默认状态值
    IF NEW.invoice_status IS NULL THEN
        NEW.invoice_status = 'Uninvoiced';
    END IF;
    
    IF NEW.payment_status IS NULL THEN
        NEW.payment_status = 'Uninvoiced';
    END IF;
    
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.set_project_auto_code
CREATE OR REPLACE FUNCTION public.set_project_auto_code()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    IF NEW.auto_code IS NULL THEN
        NEW.auto_code := generate_project_code();
    END IF;
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.set_updated_at
CREATE OR REPLACE FUNCTION public.set_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.set_user_projects_updated_at
CREATE OR REPLACE FUNCTION public.set_user_projects_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.simple_role_template_update
CREATE OR REPLACE FUNCTION public.simple_role_template_update()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    -- 简单的触发器函数，只记录日志
    RAISE NOTICE '角色模板已更新: %', NEW.role;
    
    -- 发送权限变更通知
    PERFORM pg_notify('permission_changed', json_build_object(
        'table', 'role_permission_templates',
        'operation', 'UPDATE',
        'role', NEW.role,
        'timestamp', NOW()
    )::text);
    
    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        -- 如果出错，记录错误但不阻止更新
        RAISE NOTICE '触发器执行出错: %', SQLERRM;
        RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.sync_user_permissions_with_role
CREATE OR REPLACE FUNCTION public.sync_user_permissions_with_role()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
DECLARE
    user_record RECORD;
    role_template RECORD;
BEGIN
    -- 为所有用户同步权限
    FOR user_record IN 
        SELECT id, email, role 
        FROM public.profiles 
        WHERE role IS NOT NULL
    LOOP
        -- 获取角色模板
        SELECT * INTO role_template
        FROM public.role_permission_templates
        WHERE role = user_record.role;
        
        -- 如果用户有全局权限配置且不继承角色权限，则删除
        IF EXISTS (
            SELECT 1 FROM public.user_permissions 
            WHERE user_id = user_record.id 
            AND project_id IS NULL 
            AND inherit_role = false
        ) THEN
            DELETE FROM public.user_permissions 
            WHERE user_id = user_record.id 
            AND project_id IS NULL;
            
            RAISE NOTICE '已清理用户 % 的全局权限配置，将使用角色 % 的模板权限', 
                user_record.email, user_record.role;
        END IF;
    END LOOP;
    
    RAISE NOTICE '权限同步完成';
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| -- 函数: public.sync_user_permissions_with_role
CREATE OR REPLACE FUNCTION public.sync_user_permissions_with_role(role_name text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    user_record RECORD;
    role_template RECORD;
    updated_count INTEGER := 0;
BEGIN
    -- 获取角色模板
    SELECT * INTO role_template 
    FROM public.role_permission_templates 
    WHERE role = role_name::app_role;
    
    IF NOT FOUND THEN
        RAISE WARNING '角色模板 % 不存在', role_name;
        RETURN;
    END IF;
    
    -- 为所有使用该角色的用户同步权限
    FOR user_record IN 
        SELECT id, email FROM public.profiles 
        WHERE role = role_name::app_role AND is_active = true
    LOOP
        -- 如果用户有全局权限配置且不继承角色权限，则删除
        IF EXISTS (
            SELECT 1 FROM public.user_permissions 
            WHERE user_id = user_record.id 
            AND project_id IS NULL 
            AND inherit_role = false
        ) THEN
            DELETE FROM public.user_permissions 
            WHERE user_id = user_record.id 
            AND project_id IS NULL;
            
            RAISE NOTICE '已清理用户 % 的全局权限配置，将使用角色 % 的模板权限', 
                user_record.email, role_name;
        END IF;
        
        updated_count := updated_count + 1;
    END LOOP;
    
    RAISE NOTICE '角色 % 权限同步完成，影响 % 个用户', role_name, updated_count;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.test_platform_fields_import
CREATE OR REPLACE FUNCTION public.test_platform_fields_import()
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    test_records jsonb;
    preview_result jsonb;
    import_result jsonb;
BEGIN
    -- 创建测试数据
    test_records := '[
        {
            "project_name": "测试项目",
            "driver_name": "测试司机",
            "license_plate": "测试车牌",
            "driver_phone": "13800138000",
            "loading_location": "测试装货地点",
            "unloading_location": "测试卸货地点",
            "loading_date": "2025-01-20",
            "loading_weight": "25.5",
            "current_cost": "1500",
            "extra_cost": "100",
            "transport_type": "实际运输",
            "remarks": "测试备注",
            "external_tracking_numbers": [
                {
                    "platform": "货拉拉",
                    "tracking_number": "HL20250120001",
                    "status": "pending",
                    "created_at": "2025-01-20T08:00:00Z"
                }
            ],
            "other_platform_names": ["货拉拉", "满帮"]
        }
    ]'::jsonb;

    -- 测试预览功能
    SELECT public.preview_import_with_duplicates_check(test_records) INTO preview_result;
    
    -- 测试导入功能
    SELECT public.batch_import_logistics_records(test_records) INTO import_result;

    RETURN jsonb_build_object(
        'preview_result', preview_result,
        'import_result', import_result,
        'test_completed', true
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- 函数: public.test_supabase_realtime
CREATE OR REPLACE FUNCTION public.test_supabase_realtime()
 RETURNS TABLE(test_name text, test_result text, test_time timestamp with time zone)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        'supabase_realtime_available' as test_name,
        'Supabase实时系统可用' as test_result,
        NOW() as test_time
    UNION ALL
    SELECT 
        'triggers_created' as test_name,
        '权限变更触发器已创建' as test_result,
        NOW() as test_time
    UNION ALL
    SELECT 
        'notification_system' as test_name,
        'pg_notify通知系统已配置' as test_result,
        NOW() as test_time;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- 函数: public.update_external_tracking_status
CREATE OR REPLACE FUNCTION public.update_external_tracking_status(p_logistics_record_id uuid, p_tracking_number text, p_status text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_external_tracking JSONB;
  v_updated_tracking JSONB;
  v_updated_array JSONB;
BEGIN
  -- 获取当前的外部运单号数组
  SELECT external_tracking_numbers INTO v_external_tracking
  FROM public.logistics_records
  WHERE id = p_logistics_record_id;
  
  -- 更新指定运单号的状态
  v_updated_array := (
    SELECT jsonb_agg(
      CASE 
        WHEN elem->>'tracking_number' = p_tracking_number THEN
          jsonb_set(elem, '{status}', to_jsonb(p_status))
        ELSE elem
      END
    )
    FROM jsonb_array_elements(v_external_tracking) AS elem
  );
  
  -- 更新数据库记录
  UPDATE public.logistics_records
  SET external_tracking_numbers = v_updated_array
  WHERE id = p_logistics_record_id;
  
  RETURN TRUE;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| -- 函数: public.update_location_geocoding
CREATE OR REPLACE FUNCTION public.update_location_geocoding(p_location_id uuid, p_address text DEFAULT NULL::text, p_latitude numeric DEFAULT NULL::numeric, p_longitude numeric DEFAULT NULL::numeric, p_formatted_address text DEFAULT NULL::text, p_province text DEFAULT NULL::text, p_city text DEFAULT NULL::text, p_district text DEFAULT NULL::text, p_township text DEFAULT NULL::text, p_street text DEFAULT NULL::text, p_street_number text DEFAULT NULL::text, p_adcode text DEFAULT NULL::text, p_citycode text DEFAULT NULL::text, p_status geocoding_status DEFAULT 'success'::geocoding_status, p_error text DEFAULT NULL::text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    UPDATE public.locations 
    SET 
        address = COALESCE(p_address, address),
        latitude = COALESCE(p_latitude, latitude),
        longitude = COALESCE(p_longitude, longitude),
        formatted_address = COALESCE(p_formatted_address, formatted_address),
        province = COALESCE(p_province, province),
        city = COALESCE(p_city, city),
        district = COALESCE(p_district, district),
        township = COALESCE(p_township, township),
        street = COALESCE(p_street, street),
        street_number = COALESCE(p_street_number, street_number),
        adcode = COALESCE(p_adcode, adcode),
        citycode = COALESCE(p_citycode, citycode),
        geocoding_status = p_status,
        geocoding_updated_at = NOW(),
        geocoding_error = p_error
    WHERE id = p_location_id;
    
    RETURN FOUND;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- 函数: public.update_logistics_record_platforms
CREATE OR REPLACE FUNCTION public.update_logistics_record_platforms(p_logistics_record_id uuid, p_platform_names text[])
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- 过滤空字符串和null值
  p_platform_names := ARRAY(
    SELECT DISTINCT trim(name) 
    FROM unnest(p_platform_names) AS name 
    WHERE trim(name) != ''
  );
  
  -- 更新运单记录
  UPDATE public.logistics_records
  SET other_platform_names = p_platform_names
  WHERE id = p_logistics_record_id;
  
  RETURN TRUE;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.update_logistics_record_via_recalc
CREATE OR REPLACE FUNCTION public.update_logistics_record_via_recalc(p_record_id uuid, p_project_id uuid, p_project_name text, p_chain_id uuid, p_driver_id uuid, p_driver_name text, p_loading_location text, p_unloading_location text, p_loading_date timestamp without time zone, p_loading_weight numeric, p_unloading_weight numeric, p_current_cost numeric, p_license_plate text, p_driver_phone text, p_transport_type text, p_extra_cost numeric, p_remarks text, p_unloading_date timestamp without time zone)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    driver_payable numeric;
BEGIN
    -- 计算司机应付金额
    driver_payable := (COALESCE(p_current_cost, 0) + COALESCE(p_extra_cost, 0));

    -- 更新运单记录
    UPDATE public.logistics_records SET
        project_id = p_project_id,
        project_name = p_project_name,
        chain_id = p_chain_id,
        driver_id = p_driver_id,
        driver_name = p_driver_name,
        loading_location = p_loading_location,
        unloading_location = p_unloading_location,
        loading_date = p_loading_date,
        unloading_date = p_unloading_date,
        loading_weight = p_loading_weight,
        unloading_weight = p_unloading_weight,
        current_cost = p_current_cost,
        extra_cost = p_extra_cost,
        payable_cost = driver_payable,
        license_plate = p_license_plate,
        driver_phone = p_driver_phone,
        transport_type = p_transport_type,
        remarks = p_remarks
    WHERE id = p_record_id;

    -- 重新计算合作方成本（使用更新后的函数）
    PERFORM public.recalculate_and_update_costs_for_record(p_record_id);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| -- 函数: public.update_logistics_record_via_recalc
CREATE OR REPLACE FUNCTION public.update_logistics_record_via_recalc(p_record_id uuid, p_project_id uuid, p_project_name text, p_chain_id uuid, p_driver_id uuid, p_driver_name text, p_loading_location text, p_unloading_location text, p_loading_date text, p_loading_weight numeric, p_unloading_weight numeric, p_current_cost numeric, p_license_plate text, p_driver_phone text, p_transport_type text, p_extra_cost numeric, p_remarks text, p_unloading_date text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    driver_payable numeric;
    v_project_code text;
    v_billing_type_id bigint;
BEGIN
    SELECT auto_code INTO v_project_code FROM public.projects WHERE id = p_project_id;
    IF v_project_code IS NULL OR v_project_code = '' THEN
        v_project_code := UPPER(SUBSTRING(p_project_name, 1, 4));
        UPDATE public.projects SET auto_code = v_project_code WHERE id = p_project_id;
    END IF;

    -- Get billing_type_id from chain
    SELECT billing_type_id INTO v_billing_type_id 
    FROM public.partner_chains 
    WHERE id = p_chain_id;
    
    -- Default to 1 if no chain or no billing_type_id
    v_billing_type_id := COALESCE(v_billing_type_id, 1);

    driver_payable := (COALESCE(p_current_cost, 0) + COALESCE(p_extra_cost, 0));
    
    UPDATE public.logistics_records SET
      project_id = p_project_id, 
      project_name = p_project_name, 
      chain_id = p_chain_id,
      billing_type_id = v_billing_type_id,
      driver_id = p_driver_id, 
      driver_name = p_driver_name,
      loading_location = p_loading_location, 
      unloading_location = p_unloading_location, 
      loading_date = p_loading_date,
      unloading_date = p_unloading_date, 
      loading_weight = p_loading_weight, 
      unloading_weight = p_unloading_weight, 
      current_cost = p_current_cost,
      license_plate = p_license_plate, 
      driver_phone = p_driver_phone, 
      transport_type = p_transport_type,
      extra_cost = p_extra_cost, 
      remarks = p_remarks,
      payable_cost = driver_payable
    WHERE id = p_record_id;

    -- 调用已加固的子函数，该函数会正确处理 logistics_partner_costs 的 user_id 插入
    PERFORM public.recalculate_and_update_costs_for_record(p_record_id);
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| -- 函数: public.update_logistics_record_with_costs
CREATE OR REPLACE FUNCTION public.update_logistics_record_with_costs(p_record_id uuid, p_project_id uuid, p_project_name text, p_chain_id uuid, p_driver_id uuid, p_driver_name text, p_loading_location text, p_unloading_location text, p_loading_date text, p_loading_weight numeric, p_unloading_weight numeric, p_current_cost numeric, p_license_plate text, p_driver_phone text, p_transport_type text, p_extra_cost numeric, p_driver_payable_cost numeric, p_remarks text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  total_payable_cost numeric;
BEGIN
  DELETE FROM public.logistics_partner_costs WHERE logistics_record_id = p_record_id;
  
  -- 注意：UPDATE操作通常不记录user_id，除非您有'updated_by'字段。此处的逻辑保持不变。
  UPDATE public.logistics_records SET
    project_id = p_project_id, project_name = p_project_name, chain_id = p_chain_id, driver_id = p_driver_id, driver_name = p_driver_name,
    loading_location = p_loading_location, unloading_location = p_unloading_location, loading_date = p_loading_date,
    loading_weight = p_loading_weight, unloading_weight = p_unloading_weight, current_cost = p_current_cost,
    license_plate = p_license_plate, driver_phone = p_driver_phone, transport_type = p_transport_type,
    extra_cost = p_extra_cost, driver_payable_cost = p_driver_payable_cost, remarks = p_remarks,
    payable_cost = NULL
  WHERE id = p_record_id;

  IF p_current_cost IS NOT NULL AND p_current_cost > 0 THEN
    -- 【加固点】
    INSERT INTO public.logistics_partner_costs (logistics_record_id, partner_id, level, base_amount, payable_amount, tax_rate, user_id)
    SELECT p_record_id, costs.partner_id, costs.level, costs.base_amount, costs.payable_amount, costs.tax_rate, auth.uid()
    FROM public.calculate_partner_costs_v2(p_current_cost, p_project_id, p_chain_id, p_loading_weight, p_unloading_weight) AS costs;
    
    SELECT COALESCE(SUM(lpc.payable_amount), 0) INTO total_payable_cost FROM public.logistics_partner_costs lpc WHERE lpc.logistics_record_id = p_record_id;
    UPDATE public.logistics_records SET payable_cost = total_payable_cost WHERE id = p_record_id;
  END IF;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.update_logistics_records_timestamps
CREATE OR REPLACE FUNCTION public.update_logistics_records_timestamps()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
    -- 开票状态变化时更新时间戳
    IF OLD.invoice_status IS DISTINCT FROM NEW.invoice_status THEN
        IF NEW.invoice_status = 'Processing' AND OLD.invoice_status = 'Uninvoiced' THEN
            NEW.invoice_applied_at = NOW();
        ELSIF NEW.invoice_status = 'Invoiced' AND OLD.invoice_status = 'Processing' THEN
            NEW.invoice_completed_at = NOW();
        END IF;
    END IF;
    
    -- 付款状态变化时更新时间戳
    IF OLD.payment_status IS DISTINCT FROM NEW.payment_status THEN
        IF NEW.payment_status = 'Processing' AND OLD.payment_status = 'Uninvoiced' THEN
            NEW.payment_applied_at = NOW();
        ELSIF NEW.payment_status = 'Paid' AND OLD.payment_status = 'Processing' THEN
            NEW.payment_completed_at = NOW();
        END IF;
    END IF;
    
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| -- 函数: public.update_partner_costs_timestamps
CREATE OR REPLACE FUNCTION public.update_partner_costs_timestamps()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF OLD.invoice_status IS DISTINCT FROM NEW.invoice_status THEN
        IF NEW.invoice_status = 'Processing' AND OLD.invoice_status = 'Uninvoiced' THEN
            NEW.invoice_applied_at = NOW();
        ELSIF NEW.invoice_status = 'Invoiced' AND OLD.invoice_status = 'Processing' THEN
            NEW.invoice_completed_at = NOW();
        END IF;
    END IF;
    
    IF OLD.payment_status IS DISTINCT FROM NEW.payment_status THEN
        IF NEW.payment_status = 'Processing' AND OLD.payment_status = 'Unpaid' THEN
            NEW.payment_applied_at = NOW();
        ELSIF NEW.payment_status = 'Paid' AND OLD.payment_status = 'Processing' THEN
            NEW.payment_completed_at = NOW();
        END IF;
    END IF;
    
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -- 函数: public.update_permission_performance_stats
CREATE OR REPLACE FUNCTION public.update_permission_performance_stats()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- 清空现有统计
    DELETE FROM permission_performance_stats;
    
    -- 插入用户权限统计
    INSERT INTO permission_performance_stats (
        table_name, record_count, unique_users, unique_projects, last_created, first_created
    )
    SELECT 
        'user_permissions' as table_name,
        COUNT(*) as record_count,
        COUNT(DISTINCT user_id) as unique_users,
        COUNT(DISTINCT project_id) as unique_projects,
        MAX(created_at) as last_created,
        MIN(created_at) as first_created
    FROM user_permissions;
    
    -- 插入角色模板统计
    INSERT INTO permission_performance_stats (
        table_name, record_count, unique_users, unique_projects, last_created, first_created
    )
    SELECT 
        'role_permission_templates' as table_name,
        COUNT(*) as record_count,
        0 as unique_users,
        0 as unique_projects,
        MAX(created_at) as last_created,
        MIN(created_at) as first_created
    FROM role_permission_templates;
    
    -- 插入用户统计
    INSERT INTO permission_performance_stats (
        table_name, record_count, unique_users, unique_projects, last_created, first_created
    )
    SELECT 
        'profiles' as table_name,
        COUNT(*) as record_count,
        COUNT(*) as unique_users,
        0 as unique_projects,
        MAX(created_at) as last_created,
        MIN(created_at) as first_created
    FROM profiles;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -- 函数: public.update_single_logistics_record
CREATE OR REPLACE FUNCTION public.update_single_logistics_record(p_record_id uuid, p_record jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    -- [修改] 同样直接从 p_record 中获取 ID
    v_project_id uuid := (p_record->>'project_id')::uuid;
    v_driver_id uuid := (p_record->>'driver_id')::uuid;
    v_loading_location_id uuid := (p_record->>'loading_location_id')::uuid;
    v_unloading_location_id uuid := (p_record->>'unloading_location_id')::uuid;
    v_chain_id uuid := (p_record->>'chain_id')::uuid;

    v_project_name text;
    v_driver_name text;
    v_loading_location_name text;
    v_unloading_location_name text;
    
    loading_date_formatted timestamp;
    unloading_date_formatted timestamp;
    driver_payable numeric;
    v_billing_type_id bigint;
    updated_logistics_record jsonb;
BEGIN
    -- [修改] 逻辑与创建函数保持一致
    SELECT name INTO v_project_name FROM public.projects WHERE id = v_project_id;
    IF v_project_name IS NULL THEN RAISE EXCEPTION '项目ID无效: %', v_project_id; END IF;

    SELECT name INTO v_driver_name FROM public.drivers WHERE id = v_driver_id;
    IF v_driver_name IS NULL THEN RAISE EXCEPTION '司机ID无效: %', v_driver_id; END IF;

    SELECT name INTO v_loading_location_name FROM public.locations WHERE id = v_loading_location_id;
    IF v_loading_location_name IS NULL THEN RAISE EXCEPTION '装货地点ID无效: %', v_loading_location_id; END IF;

    SELECT name INTO v_unloading_location_name FROM public.locations WHERE id = v_unloading_location_id;
    IF v_unloading_location_name IS NULL THEN RAISE EXCEPTION '卸货地点ID无效: %', v_unloading_location_id; END IF;

    SELECT billing_type_id INTO v_billing_type_id FROM public.partner_chains WHERE id = v_chain_id;
    v_billing_type_id := COALESCE(v_billing_type_id, 1);

    loading_date_formatted := (p_record->>'loading_date')::timestamp;
    unloading_date_formatted := COALESCE(NULLIF(p_record->>'unloading_date', ''), p_record->>'loading_date')::timestamp;
    driver_payable := COALESCE((p_record->>'current_cost')::numeric, 0) + COALESCE((p_record->>'extra_cost')::numeric, 0);

    -- 更新记录
    UPDATE public.logistics_records
    SET
        project_id = v_project_id,
        project_name = v_project_name,
        chain_id = v_chain_id,
        billing_type_id = v_billing_type_id,
        driver_id = v_driver_id,
        driver_name = v_driver_name,
        loading_location = v_loading_location_name,
        unloading_location = v_unloading_location_name,
        loading_date = loading_date_formatted,
        unloading_date = unloading_date_formatted,
        loading_weight = NULLIF((p_record->>'loading_weight')::text, '')::numeric,
        unloading_weight = NULLIF((p_record->>'unloading_weight')::text, '')::numeric,
        current_cost = COALESCE((p_record->>'current_cost')::numeric, 0),
        extra_cost = COALESCE((p_record->>'extra_cost')::numeric, 0),
        license_plate = (p_record->>'license_plate'),
        driver_phone = (p_record->>'driver_phone'),
        transport_type = COALESCE((p_record->>'transport_type'), '实际运输'),
        remarks = (p_record->>'remarks'),
        payable_cost = driver_payable
    WHERE id = p_record_id
    RETURNING to_jsonb(logistics_records) INTO updated_logistics_record;

    PERFORM public.recalculate_and_update_costs_for_records(ARRAY[p_record_id]);
    RETURN updated_logistics_record;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| -- 函数: public.update_sync_status
CREATE OR REPLACE FUNCTION public.update_sync_status(p_table_name text)
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
    UPDATE permission_sync_status 
    SET 
        last_sync = NOW(),
        sync_count = sync_count + 1,
        updated_at = NOW()
    WHERE table_name = p_table_name;
    
    -- 如果记录不存在，创建新记录
    IF NOT FOUND THEN
        INSERT INTO permission_sync_status (table_name, sync_count)
        VALUES (p_table_name, 1);
    END IF;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| -- 函数: public.update_updated_at_column
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -- 函数: public.upsert_logistics_record
CREATE OR REPLACE FUNCTION public.upsert_logistics_record(p_record_id uuid, p_project_id uuid, p_chain_id uuid, p_driver_id uuid, p_driver_name text, p_driver_phone text, p_license_plate text, p_loading_location text, p_unloading_location text, p_loading_date date, p_unloading_date date, p_loading_weight numeric, p_unloading_weight numeric, p_current_cost numeric, p_extra_cost numeric, p_transport_type text, p_remarks text, p_force_insert boolean DEFAULT false)
 RETURNS TABLE(status text, message text, record_id uuid)
 LANGUAGE plpgsql
 SET search_path TO 'public'
AS $function$
DECLARE
    v_is_duplicate BOOLEAN := FALSE; v_billing_type_id INT; v_project_name TEXT;
BEGIN
    IF p_record_id IS NULL THEN
        SELECT EXISTS (
            SELECT 1 FROM public.logistics_records WHERE project_id = p_project_id AND chain_id = p_chain_id AND driver_name = p_driver_name AND license_plate = p_license_plate AND loading_location = p_loading_location AND unloading_location = p_unloading_location AND loading_date = p_loading_date AND loading_weight = p_loading_weight
        ) INTO v_is_duplicate;
        IF v_is_duplicate AND NOT p_force_insert THEN
            RETURN QUERY SELECT 'duplicate'::TEXT, '数据库中已存在一条关键字段完全相同的记录。'::TEXT, NULL::UUID; RETURN;
        END IF;
    END IF;
    IF p_chain_id IS NOT NULL THEN SELECT billing_type_id INTO v_billing_type_id FROM public.partner_chains WHERE id = p_chain_id;
    ELSE v_billing_type_id := NULL; END IF;
    IF p_project_id IS NOT NULL THEN SELECT name INTO v_project_name FROM public.projects WHERE id = p_project_id; END IF;
    IF p_record_id IS NOT NULL THEN
        UPDATE public.logistics_records SET project_id = p_project_id, project_name = v_project_name, chain_id = p_chain_id, billing_type_id = v_billing_type_id, driver_id = p_driver_id, driver_name = p_driver_name, driver_phone = p_driver_phone, license_plate = p_license_plate, loading_location = p_loading_location, unloading_location = p_unloading_location, loading_date = p_loading_date, unloading_date = p_unloading_date, loading_weight = p_loading_weight, unloading_weight = p_unloading_weight, current_cost = p_current_cost, extra_cost = p_extra_cost, transport_type = p_transport_type, remarks = p_remarks
        WHERE id = p_record_id RETURNING id INTO record_id;
        status := 'success'; message := '运单更新成功。';
    ELSE
        INSERT INTO public.logistics_records (project_id, project_name, chain_id, billing_type_id, driver_id, driver_name, driver_phone, license_plate, loading_location, unloading_location, loading_date, unloading_date, loading_weight, unloading_weight, current_cost, extra_cost, transport_type, remarks, created_by_user_id)
        VALUES (p_project_id, v_project_name, p_chain_id, v_billing_type_id, p_driver_id, p_driver_name, p_driver_phone, p_license_plate, p_loading_location, p_unloading_location, p_loading_date, p_unloading_date, p_loading_weight, p_unloading_weight, p_current_cost, p_extra_cost, p_transport_type, p_remarks, auth.uid())
        RETURNING id INTO record_id;
        status := 'success'; message := '运单创建成功。';
    END IF;
    IF record_id IS NOT NULL THEN PERFORM public.recalculate_and_update_costs_for_record(record_id); END IF;
    RETURN NEXT;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| -- 函数: public.validate_external_tracking_uniqueness
CREATE OR REPLACE FUNCTION public.validate_external_tracking_uniqueness(p_tracking_number text, p_exclude_logistics_record_id uuid DEFAULT NULL::uuid)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_count INTEGER;
BEGIN
  -- 检查运单号是否已存在
  SELECT COUNT(*) INTO v_count
  FROM public.logistics_records
  WHERE external_tracking_numbers @> jsonb_build_array(
    jsonb_build_object('tracking_number', p_tracking_number)
  )
  AND (p_exclude_logistics_record_id IS NULL OR id != p_exclude_logistics_record_id);
  
  RETURN v_count = 0;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| -- 函数: public.validate_platform_names
CREATE OR REPLACE FUNCTION public.validate_platform_names(p_platform_names text[])
 RETURNS TABLE(is_valid boolean, error_message text, cleaned_platforms text[])
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_cleaned_platforms TEXT[];
  v_error_message TEXT := '';
BEGIN
  -- 清理平台名称（去除空字符串和重复项）
  v_cleaned_platforms := ARRAY(
    SELECT DISTINCT trim(name) 
    FROM unnest(p_platform_names) AS name 
    WHERE trim(name) != ''
  );
  
  -- 验证平台名称长度
  IF EXISTS (
    SELECT 1 FROM unnest(v_cleaned_platforms) AS name 
    WHERE length(name) > 50
  ) THEN
    v_error_message := '平台名称长度不能超过50个字符';
    RETURN QUERY SELECT FALSE, v_error_message, v_cleaned_platforms;
    RETURN;
  END IF;
  
  -- 验证平台名称数量
  IF array_length(v_cleaned_platforms, 1) > 10 THEN
    v_error_message := '最多只能添加10个平台名称';
    RETURN QUERY SELECT FALSE, v_error_message, v_cleaned_platforms;
    RETURN;
  END IF;
  
  RETURN QUERY SELECT TRUE, '', v_cleaned_platforms;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -- 函数: public.verify_role_creation
CREATE OR REPLACE FUNCTION public.verify_role_creation(role_key text)
 RETURNS TABLE(check_type text, status text, details text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        '枚举类型检查'::text,
        CASE 
            WHEN check_enum_value('app_role', role_key) THEN '通过'::text
            ELSE '失败'::text
        END,
        CASE 
            WHEN check_enum_value('app_role', role_key) THEN '角色已添加到枚举类型'::text
            ELSE '角色未添加到枚举类型'::text
        END
    UNION ALL
    SELECT 
        '权限模板检查'::text,
        CASE 
            WHEN EXISTS(SELECT 1 FROM public.role_permission_templates WHERE role = role_key) THEN '通过'::text
            ELSE '失败'::text
        END,
        CASE 
            WHEN EXISTS(SELECT 1 FROM public.role_permission_templates WHERE role = role_key) THEN '权限模板已创建'::text
            ELSE '权限模板未创建'::text
        END
    UNION ALL
    SELECT 
        '项目分配检查'::text,
        CASE 
            WHEN EXISTS(SELECT 1 FROM public.user_projects WHERE role::text = role_key) THEN '通过'::text
            ELSE '警告'::text
        END,
        CASE 
            WHEN EXISTS(SELECT 1 FROM public.user_projects WHERE role::text = role_key) THEN '项目分配已创建'::text
            ELSE '项目分配未创建（可能没有项目）'::text
        END;
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -- 函数: public.void_invoice_request
CREATE OR REPLACE FUNCTION public.void_invoice_request(p_request_id uuid, p_void_reason text DEFAULT NULL::text)
 RETURNS json
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
    v_request record;
    v_affected_count integer;
BEGIN
    -- 检查权限
    IF NOT public.is_finance_or_admin_for_invoice() THEN
        RAISE EXCEPTION '权限不足：只有财务人员或管理员可以作废开票申请单';
    END IF;
    
    -- 获取申请单信息
    SELECT * INTO v_request
    FROM public.invoice_requests
    WHERE id = p_request_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION '开票申请单不存在';
    END IF;
    
    -- 检查是否已经作废
    IF v_request.is_voided THEN
        RAISE EXCEPTION '该申请单已经作废';
    END IF;
    
    -- 作废申请单（使用Cancelled状态）
    UPDATE public.invoice_requests
    SET 
        is_voided = true,
        voided_at = NOW(),
        voided_by = auth.uid(),
        void_reason = p_void_reason,
        status = 'Cancelled'
    WHERE id = p_request_id;
    
    -- 更新相关的logistics_partner_costs状态（回滚运单状态）
    UPDATE public.logistics_partner_costs
    SET 
        invoice_status = 'Uninvoiced',
        invoice_request_id = NULL,
        invoice_applied_at = NULL
    WHERE invoice_request_id = p_request_id;
    
    -- 删除开票申请明细
    DELETE FROM public.invoice_request_details
    WHERE invoice_request_id = p_request_id;
    
    GET DIAGNOSTICS v_affected_count = ROW_COUNT;
    
    RETURN json_build_object(
        'success', true,
        'message', '开票申请单已作废',
        'affected_records', v_affected_count
    );
    
EXCEPTION WHEN OTHERS THEN
    RETURN json_build_object(
        'success', false,
        'message', '作废开票申请单失败: ' || SQLERRM
    );
END;
$function$
;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |