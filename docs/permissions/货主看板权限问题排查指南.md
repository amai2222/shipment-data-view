# 货主看板权限问题排查指南

## 🚨 当前问题

用户访问货主看板时显示"权限不足"错误，提示"您不是货主用户，无法访问货主看板"。

## 🔍 问题分析

### 1. 权限检查逻辑

当前权限检查逻辑：
```typescript
// 判断用户类型和权限
const userRole = user?.role || 'viewer';
const isPartnerRole = userRole === 'partner';
const currentShipperId = isPartnerRole ? user?.partnerId || null : selectedShipperId;

// 合作方角色：必须有 partnerId
if (isPartnerRole && !user?.partnerId) {
  // 显示权限不足错误
}
```

### 2. 可能的原因

1. **用户角色是 'partner' 但没有 partnerId**
   - 用户被设置为合作方角色
   - 但没有关联到具体的货主（partners表记录）
   - 导致 `user?.partnerId` 为空

2. **用户不是货主类型**
   - 用户是合作方角色
   - 但关联的合作方不是"货主"类型
   - 可能是"合作商"、"资方"或"本公司"类型

3. **数据库权限配置问题**
   - 权限模板配置错误
   - 用户权限配置错误

## 🛠️ 排查步骤

### 步骤1：检查用户信息

在浏览器控制台执行：
```javascript
// 检查当前用户信息
console.log('用户信息:', {
  role: user?.role,
  partnerId: user?.partnerId,
  id: user?.id,
  email: user?.email
});
```

### 步骤2：检查合作方信息

如果用户有 `partnerId`，检查关联的合作方信息：
```sql
-- 查询用户的合作方信息
SELECT 
  p.id,
  p.name,
  p.partner_type,
  p.is_root,
  p.hierarchy_path,
  p.hierarchy_depth
FROM partners p
WHERE p.id = '用户的partnerId';
```

### 步骤3：检查权限配置

```sql
-- 检查用户权限
SELECT 
  up.user_id,
  up.menu_permissions,
  up.inherit_role,
  p.role as user_role
FROM user_permissions up
JOIN profiles p ON up.user_id = p.id
WHERE up.user_id = '用户ID';

-- 检查角色权限模板
SELECT 
  role,
  menu_permissions
FROM role_permission_templates
WHERE role = 'partner';
```

## 🔧 解决方案

### 方案1：修复用户关联

如果用户是合作方角色但没有关联货主：

```sql
-- 1. 找到或创建一个货主类型的合作方
INSERT INTO partners (name, partner_type, is_root, hierarchy_path, hierarchy_depth)
VALUES ('测试货主', '货主', true, '/测试货主', 0)
ON CONFLICT DO NOTHING;

-- 2. 更新用户关联
UPDATE profiles 
SET partner_id = (SELECT id FROM partners WHERE name = '测试货主' AND partner_type = '货主')
WHERE id = '用户ID';
```

### 方案2：修改权限检查逻辑

如果用户不是货主类型，但需要访问货主看板：

```typescript
// 修改权限检查逻辑
const isPartnerRole = userRole === 'partner';
const isShipperType = user?.partnerType === '货主'; // 需要添加这个字段

// 合作方角色：必须是货主类型
if (isPartnerRole && !isShipperType) {
  // 显示权限不足错误
}
```

### 方案3：临时绕过权限检查

临时修改权限检查逻辑，允许所有角色访问：

```typescript
// 临时修改：允许所有角色访问
// if (isPartnerRole && !user?.partnerId) {
//   return <InsufficientPermissionsCard />;
// }
```

## 📋 调试信息

已添加调试信息到权限错误页面：

```typescript
<div className="mt-4 p-3 bg-gray-50 rounded text-sm">
  <p><strong>调试信息：</strong></p>
  <p>用户角色: {user?.role}</p>
  <p>合作方ID: {user?.partnerId || '未设置'}</p>
  <p>用户ID: {user?.id}</p>
</div>
```

## 🎯 下一步行动

1. **查看调试信息** - 确认用户的实际角色和关联信息
2. **检查数据库** - 确认用户关联的合作方类型
3. **修复关联** - 将用户关联到正确的货主
4. **测试权限** - 验证修复后的权限检查

## 📞 联系信息

如果问题仍然存在，请提供：
1. 用户的调试信息截图
2. 数据库查询结果
3. 具体的错误信息

---

**创建时间**: 2025-01-22  
**状态**: 待解决
