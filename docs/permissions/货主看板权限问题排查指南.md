# è´§ä¸»çœ‹æ¿æƒé™é—®é¢˜æ’æŸ¥æŒ‡å—

## ğŸš¨ å½“å‰é—®é¢˜

ç”¨æˆ·è®¿é—®è´§ä¸»çœ‹æ¿æ—¶æ˜¾ç¤º"æƒé™ä¸è¶³"é”™è¯¯ï¼Œæç¤º"æ‚¨ä¸æ˜¯è´§ä¸»ç”¨æˆ·ï¼Œæ— æ³•è®¿é—®è´§ä¸»çœ‹æ¿"ã€‚

## ğŸ” é—®é¢˜åˆ†æ

### 1. æƒé™æ£€æŸ¥é€»è¾‘

å½“å‰æƒé™æ£€æŸ¥é€»è¾‘ï¼š
```typescript
// åˆ¤æ–­ç”¨æˆ·ç±»å‹å’Œæƒé™
const userRole = user?.role || 'viewer';
const isPartnerRole = userRole === 'partner';
const currentShipperId = isPartnerRole ? user?.partnerId || null : selectedShipperId;

// åˆä½œæ–¹è§’è‰²ï¼šå¿…é¡»æœ‰ partnerId
if (isPartnerRole && !user?.partnerId) {
  // æ˜¾ç¤ºæƒé™ä¸è¶³é”™è¯¯
}
```

### 2. å¯èƒ½çš„åŸå› 

1. **ç”¨æˆ·è§’è‰²æ˜¯ 'partner' ä½†æ²¡æœ‰ partnerId**
   - ç”¨æˆ·è¢«è®¾ç½®ä¸ºåˆä½œæ–¹è§’è‰²
   - ä½†æ²¡æœ‰å…³è”åˆ°å…·ä½“çš„è´§ä¸»ï¼ˆpartnersè¡¨è®°å½•ï¼‰
   - å¯¼è‡´ `user?.partnerId` ä¸ºç©º

2. **ç”¨æˆ·ä¸æ˜¯è´§ä¸»ç±»å‹**
   - ç”¨æˆ·æ˜¯åˆä½œæ–¹è§’è‰²
   - ä½†å…³è”çš„åˆä½œæ–¹ä¸æ˜¯"è´§ä¸»"ç±»å‹
   - å¯èƒ½æ˜¯"åˆä½œå•†"ã€"èµ„æ–¹"æˆ–"æœ¬å…¬å¸"ç±»å‹

3. **æ•°æ®åº“æƒé™é…ç½®é—®é¢˜**
   - æƒé™æ¨¡æ¿é…ç½®é”™è¯¯
   - ç”¨æˆ·æƒé™é…ç½®é”™è¯¯

## ğŸ› ï¸ æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥ç”¨æˆ·ä¿¡æ¯

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š
```javascript
// æ£€æŸ¥å½“å‰ç”¨æˆ·ä¿¡æ¯
console.log('ç”¨æˆ·ä¿¡æ¯:', {
  role: user?.role,
  partnerId: user?.partnerId,
  id: user?.id,
  email: user?.email
});
```

### æ­¥éª¤2ï¼šæ£€æŸ¥åˆä½œæ–¹ä¿¡æ¯

å¦‚æœç”¨æˆ·æœ‰ `partnerId`ï¼Œæ£€æŸ¥å…³è”çš„åˆä½œæ–¹ä¿¡æ¯ï¼š
```sql
-- æŸ¥è¯¢ç”¨æˆ·çš„åˆä½œæ–¹ä¿¡æ¯
SELECT 
  p.id,
  p.name,
  p.partner_type,
  p.is_root,
  p.hierarchy_path,
  p.hierarchy_depth
FROM partners p
WHERE p.id = 'ç”¨æˆ·çš„partnerId';
```

### æ­¥éª¤3ï¼šæ£€æŸ¥æƒé™é…ç½®

```sql
-- æ£€æŸ¥ç”¨æˆ·æƒé™
SELECT 
  up.user_id,
  up.menu_permissions,
  up.inherit_role,
  p.role as user_role
FROM user_permissions up
JOIN profiles p ON up.user_id = p.id
WHERE up.user_id = 'ç”¨æˆ·ID';

-- æ£€æŸ¥è§’è‰²æƒé™æ¨¡æ¿
SELECT 
  role,
  menu_permissions
FROM role_permission_templates
WHERE role = 'partner';
```

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤ç”¨æˆ·å…³è”

å¦‚æœç”¨æˆ·æ˜¯åˆä½œæ–¹è§’è‰²ä½†æ²¡æœ‰å…³è”è´§ä¸»ï¼š

```sql
-- 1. æ‰¾åˆ°æˆ–åˆ›å»ºä¸€ä¸ªè´§ä¸»ç±»å‹çš„åˆä½œæ–¹
INSERT INTO partners (name, partner_type, is_root, hierarchy_path, hierarchy_depth)
VALUES ('æµ‹è¯•è´§ä¸»', 'è´§ä¸»', true, '/æµ‹è¯•è´§ä¸»', 0)
ON CONFLICT DO NOTHING;

-- 2. æ›´æ–°ç”¨æˆ·å…³è”
UPDATE profiles 
SET partner_id = (SELECT id FROM partners WHERE name = 'æµ‹è¯•è´§ä¸»' AND partner_type = 'è´§ä¸»')
WHERE id = 'ç”¨æˆ·ID';
```

### æ–¹æ¡ˆ2ï¼šä¿®æ”¹æƒé™æ£€æŸ¥é€»è¾‘

å¦‚æœç”¨æˆ·ä¸æ˜¯è´§ä¸»ç±»å‹ï¼Œä½†éœ€è¦è®¿é—®è´§ä¸»çœ‹æ¿ï¼š

```typescript
// ä¿®æ”¹æƒé™æ£€æŸ¥é€»è¾‘
const isPartnerRole = userRole === 'partner';
const isShipperType = user?.partnerType === 'è´§ä¸»'; // éœ€è¦æ·»åŠ è¿™ä¸ªå­—æ®µ

// åˆä½œæ–¹è§’è‰²ï¼šå¿…é¡»æ˜¯è´§ä¸»ç±»å‹
if (isPartnerRole && !isShipperType) {
  // æ˜¾ç¤ºæƒé™ä¸è¶³é”™è¯¯
}
```

### æ–¹æ¡ˆ3ï¼šä¸´æ—¶ç»•è¿‡æƒé™æ£€æŸ¥

ä¸´æ—¶ä¿®æ”¹æƒé™æ£€æŸ¥é€»è¾‘ï¼Œå…è®¸æ‰€æœ‰è§’è‰²è®¿é—®ï¼š

```typescript
// ä¸´æ—¶ä¿®æ”¹ï¼šå…è®¸æ‰€æœ‰è§’è‰²è®¿é—®
// if (isPartnerRole && !user?.partnerId) {
//   return <InsufficientPermissionsCard />;
// }
```

## ğŸ“‹ è°ƒè¯•ä¿¡æ¯

å·²æ·»åŠ è°ƒè¯•ä¿¡æ¯åˆ°æƒé™é”™è¯¯é¡µé¢ï¼š

```typescript
<div className="mt-4 p-3 bg-gray-50 rounded text-sm">
  <p><strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong></p>
  <p>ç”¨æˆ·è§’è‰²: {user?.role}</p>
  <p>åˆä½œæ–¹ID: {user?.partnerId || 'æœªè®¾ç½®'}</p>
  <p>ç”¨æˆ·ID: {user?.id}</p>
</div>
```

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯** - ç¡®è®¤ç”¨æˆ·çš„å®é™…è§’è‰²å’Œå…³è”ä¿¡æ¯
2. **æ£€æŸ¥æ•°æ®åº“** - ç¡®è®¤ç”¨æˆ·å…³è”çš„åˆä½œæ–¹ç±»å‹
3. **ä¿®å¤å…³è”** - å°†ç”¨æˆ·å…³è”åˆ°æ­£ç¡®çš„è´§ä¸»
4. **æµ‹è¯•æƒé™** - éªŒè¯ä¿®å¤åçš„æƒé™æ£€æŸ¥

## ğŸ“ è”ç³»ä¿¡æ¯

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ï¼š
1. ç”¨æˆ·çš„è°ƒè¯•ä¿¡æ¯æˆªå›¾
2. æ•°æ®åº“æŸ¥è¯¢ç»“æœ
3. å…·ä½“çš„é”™è¯¯ä¿¡æ¯

---

**åˆ›å»ºæ—¶é—´**: 2025-01-22  
**çŠ¶æ€**: å¾…è§£å†³
