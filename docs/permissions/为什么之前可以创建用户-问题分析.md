# ä¸ºä»€ä¹ˆä¹‹å‰å¯ä»¥åˆ›å»ºç”¨æˆ·ï¼Ÿ- é—®é¢˜åˆ†æ

## ğŸ” é—®é¢˜å‘ç°

ç”¨æˆ·åé¦ˆï¼š**ä¹‹å‰å¯ä»¥åˆ›å»ºå’Œåˆ é™¤ç”¨æˆ·ï¼Œç°åœ¨ä¸ºä»€ä¹ˆä¸è¡Œäº†ï¼Ÿ**

---

## âœ… çœŸç›¸æ­æ™“

### ä¹‹å‰çš„ä»£ç å®ç°

åœ¨æ—§çš„ä»£ç ä¸­ï¼ˆ`src/hooks/useUnifiedUserManagement.ts` å’Œ `src/pages/Settings/UserManagement.tsx_bak`ï¼‰ï¼Œä½¿ç”¨çš„æ˜¯ï¼š

```typescript
// âœ… æ—§ä»£ç  - å¯ä»¥å·¥ä½œ
const { data: authData, error: authError } = await supabase.auth.signUp({
  email: userData.email,
  password: userData.password,
  options: {
    emailRedirectTo: `${window.location.origin}/`,
    data: {
      username: userData.username,
      full_name: userData.full_name
    }
  }
});
```

### ç°åœ¨çš„ä»£ç å®ç°

åœ¨æ–°çš„ä»£ç ä¸­ï¼ˆ`src/components/permissions/UserManagement.tsx`ï¼‰ï¼Œæ”¹æˆäº†ï¼š

```typescript
// âŒ æ–°ä»£ç  - ä¼šæŠ¥é”™ "User not allowed"
const { data: authData, error: authError } = await supabase.auth.admin.createUser({
  email: createUserForm.email,
  password: createUserForm.password,
  email_confirm: true
});
```

---

## ğŸ“Š ä¸¤ç§æ–¹å¼çš„åŒºåˆ«

| ç‰¹æ€§ | `auth.signUp()` | `auth.admin.createUser()` |
|------|----------------|--------------------------|
| **æ‰€éœ€å¯†é’¥** | âœ… Anon Keyï¼ˆå…¬å¼€å¯†é’¥ï¼‰ | âŒ Service Role Keyï¼ˆç®¡ç†å‘˜å¯†é’¥ï¼‰ |
| **å‰ç«¯å¯ç”¨æ€§** | âœ… å¯ä»¥åœ¨å‰ç«¯ç›´æ¥è°ƒç”¨ | âŒ ä¸èƒ½åœ¨å‰ç«¯è°ƒç”¨ |
| **é‚®ç®±éªŒè¯** | âš ï¸ éœ€è¦ç”¨æˆ·ç‚¹å‡»éªŒè¯é“¾æ¥ | âœ… å¯ä»¥è·³è¿‡éªŒè¯ï¼ˆemail_confirm: trueï¼‰ |
| **ä½¿ç”¨åœºæ™¯** | ç”¨æˆ·è‡ªåŠ©æ³¨å†Œ | ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ· |
| **å®‰å…¨æ€§** | âœ… å®‰å…¨ï¼ˆå…¬å¼€APIï¼‰ | âš ï¸ éœ€è¦ä¿æŠ¤ï¼ˆç®¡ç†å‘˜APIï¼‰ |
| **æ˜¯å¦éœ€è¦ Edge Function** | âŒ ä¸éœ€è¦ | âœ… éœ€è¦ |

---

## ğŸ¯ ä¸ºä»€ä¹ˆä¼šæ”¹æˆ admin.createUser()ï¼Ÿ

å¯èƒ½çš„åŸå› ï¼š

### 1. é¿å…é‚®ç®±éªŒè¯æµç¨‹
```typescript
// signUp() æ–¹å¼
// âŒ ç”¨æˆ·æ³¨å†Œåéœ€è¦ï¼š
// 1. æ‰“å¼€é‚®ç®±
// 2. ç‚¹å‡»éªŒè¯é“¾æ¥
// 3. æ‰èƒ½ç™»å½•ç³»ç»Ÿ

// admin.createUser() æ–¹å¼
// âœ… ç®¡ç†å‘˜åˆ›å»ºåï¼š
// 1. ç”¨æˆ·ç«‹å³å¯ä»¥ç™»å½•
// 2. æ— éœ€é‚®ç®±éªŒè¯
```

### 2. æ›´å¥½çš„ç®¡ç†æ§åˆ¶
```typescript
// signUp() æ–¹å¼
// - ä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œï¼ˆå¦‚æœå¼€å¯äº†å…¬å¼€æ³¨å†Œï¼‰
// - éš¾ä»¥æ§åˆ¶ç”¨æˆ·åˆ›å»º

// admin.createUser() æ–¹å¼
// - åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºç”¨æˆ·
// - å®Œå…¨å¯æ§
```

### 3. ç»Ÿä¸€çš„ç”¨æˆ·ç®¡ç†
```typescript
// admin API æä¾›äº†å®Œæ•´çš„ç”¨æˆ·ç®¡ç†åŠŸèƒ½ï¼š
// - admin.createUser() - åˆ›å»º
// - admin.updateUserById() - æ›´æ–°
// - admin.deleteUser() - åˆ é™¤
// - admin.inviteUserByEmail() - é‚€è¯·
```

---

## ğŸ’¡ ä¸ºä»€ä¹ˆç°åœ¨æŠ¥é”™ "User not allowed"ï¼Ÿ

```
å‰ç«¯ä½¿ç”¨ Anon Key â†’ è°ƒç”¨ admin.createUser() â†’ Supabase æ£€æŸ¥æƒé™ â†’ æ‹’ç»è®¿é—® âŒ
                                                                    â†“
                                                          "User not allowed"
```

**Anon Key ä¸èƒ½è°ƒç”¨ admin API**ï¼Œè¿™æ˜¯ Supabase çš„å®‰å…¨æœºåˆ¶ï¼

---

## ğŸ”§ ä¸‰ç§è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ 1ï¼šæ”¹å›ä½¿ç”¨ signUp()ï¼ˆæœ€ç®€å•ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸éœ€è¦ Edge Function
- âœ… ä»£ç æ”¹åŠ¨æœ€å°
- âœ… ç«‹å³å¯ç”¨

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦é‚®ç®±éªŒè¯
- âŒ ç”¨æˆ·ä½“éªŒè¾ƒå·®
- âŒ å¦‚æœå¼€å¯å…¬å¼€æ³¨å†Œï¼Œä»»ä½•äººéƒ½èƒ½æ³¨å†Œ

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
const { data: authData, error: authError } = await supabase.auth.signUp({
  email: createUserForm.email,
  password: createUserForm.password,
  options: {
    data: {
      full_name: createUserForm.full_name,
      role: createUserForm.role
    }
  }
});
```

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Edge Functionï¼ˆæ¨èï¼‰â­

**ä¼˜ç‚¹**ï¼š
- âœ… å®‰å…¨å¯é 
- âœ… è·³è¿‡é‚®ç®±éªŒè¯
- âœ… å®Œå…¨æ§åˆ¶æƒé™
- âœ… å¯ä»¥æ·»åŠ å¤æ‚çš„ä¸šåŠ¡é€»è¾‘

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦éƒ¨ç½² Edge Function
- âš ï¸ éœ€è¦å‡ åˆ†é’Ÿè®¾ç½®æ—¶é—´

**å®ç°æ–¹å¼**ï¼š
- âœ… å·²åˆ›å»ºï¼š`supabase/functions/create-user/index.ts`
- âœ… å·²ä¿®æ”¹ï¼š`src/components/permissions/UserManagement.tsx`

### æ–¹æ¡ˆ 3ï¼šåœ¨åç«¯æš´éœ² Service Role Keyï¼ˆâŒ ä¸æ¨èï¼‰

**ä¸ºä»€ä¹ˆä¸æ¨è**ï¼š
- âŒ **æåº¦å±é™©ï¼** Service Role Key æš´éœ²åœ¨å‰ç«¯
- âŒ ä»»ä½•äººéƒ½å¯ä»¥è·å–è¿™ä¸ªå¯†é’¥
- âŒ å¯ä»¥æ‰§è¡Œä»»ä½•æ•°æ®åº“æ“ä½œ
- âŒ æ•°æ®åº“å®Œå…¨å¤±å»ä¿æŠ¤

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### å¦‚æœä½ æƒ³è¦å¿«é€Ÿæ¢å¤åŠŸèƒ½ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

**æ”¹å›ä½¿ç”¨ `signUp()` æ–¹å¼**ï¼š

1. ä¿®æ”¹ `src/components/permissions/UserManagement.tsx`
2. å°† `auth.admin.createUser()` æ”¹ä¸º `auth.signUp()`
3. æé†’ç”¨æˆ·éœ€è¦éªŒè¯é‚®ç®±

**ä¿®æ”¹ä»£ç **ï¼š
```typescript
// åœ¨ handleCreateUser å‡½æ•°ä¸­
const { data: authData, error: authError } = await supabase.auth.signUp({
  email: createUserForm.email,
  password: createUserForm.password,
  options: {
    emailRedirectTo: `${window.location.origin}/`,
    data: {
      full_name: createUserForm.full_name,
      role: createUserForm.role
    }
  }
});

// ç„¶åæ›´æ–° profiles è¡¨
if (authData.user) {
  await supabase
    .from('profiles')
    .update({
      full_name: createUserForm.full_name,
      role: createUserForm.role,
      is_active: true
    })
    .eq('id', authData.user.id);
}
```

### å¦‚æœä½ æƒ³è¦å®Œå–„çš„è§£å†³æ–¹æ¡ˆï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰â­

**ä½¿ç”¨ Edge Function**ï¼ˆæˆ‘å·²ç»å¸®ä½ åˆ›å»ºå¥½äº†ï¼‰ï¼š

1. éƒ¨ç½² Edge Functionï¼šè¿è¡Œ `.\deploy-create-user-function.ps1`
2. å‰ç«¯ä»£ç å·²ç»ä¿®æ”¹å®Œæˆï¼ˆè°ƒç”¨ Edge Functionï¼‰
3. ç”¨æˆ·åˆ›å»ºåç«‹å³å¯ç”¨ï¼Œæ— éœ€é‚®ç®±éªŒè¯

---

## ğŸ“ Supabase é…ç½®æ£€æŸ¥

### æ£€æŸ¥æ˜¯å¦ç¦ç”¨äº†å…¬å¼€æ³¨å†Œ

å¦‚æœä½ æ‹…å¿ƒä»»ä½•äººéƒ½èƒ½é€šè¿‡ `signUp()` æ³¨å†Œï¼Œå¯ä»¥åœ¨ Supabase Dashboard ä¸­ç¦ç”¨ï¼š

1. è¿›å…¥ **Authentication** â†’ **Settings**
2. æ‰¾åˆ° **Enable Email Signup**
3. å…³é—­è¿™ä¸ªé€‰é¡¹

è¿™æ ·ï¼š
- âŒ æ™®é€šç”¨æˆ·æ— æ³•é€šè¿‡ `signUp()` æ³¨å†Œ
- âœ… ä½†ä½ çš„ä»£ç ä»ç„¶å¯ä»¥è°ƒç”¨ï¼ˆå› ä¸ºä½¿ç”¨çš„æ˜¯ Anon Keyï¼‰

**ç­‰ç­‰ï¼Œè¿™æ ·ä¸è¡Œï¼** å¦‚æœç¦ç”¨äº† Email Signupï¼Œä½ çš„ `signUp()` è°ƒç”¨ä¹Ÿä¼šå¤±è´¥ã€‚

æ‰€ä»¥æœ€å¥½çš„æ–¹æ¡ˆè¿˜æ˜¯ï¼š**ä½¿ç”¨ Edge Function** ğŸ¯

---

## ğŸ æ€»ç»“

### ä¹‹å‰èƒ½ç”¨çš„åŸå› 
- âœ… ä½¿ç”¨çš„æ˜¯ `auth.signUp()`ï¼ˆæ™®é€šAPIï¼‰
- âœ… Anon Key å¯ä»¥è°ƒç”¨
- âš ï¸ ä½†éœ€è¦é‚®ç®±éªŒè¯

### ç°åœ¨ä¸èƒ½ç”¨çš„åŸå› 
- âŒ æ”¹æˆäº† `auth.admin.createUser()`ï¼ˆç®¡ç†å‘˜APIï¼‰
- âŒ Anon Key æ— æƒè°ƒç”¨
- âŒ æŠ¥é”™ "User not allowed"

### æ¨èçš„è§£å†³æ–¹æ¡ˆ
1. **çŸ­æœŸ**ï¼šæ”¹å› `signUp()`ï¼Œæ¥å—é‚®ç®±éªŒè¯æµç¨‹
2. **é•¿æœŸ**ï¼šä½¿ç”¨ Edge Functionï¼ˆå·²å‡†å¤‡å¥½ï¼‰

---

## â“ ä½ çš„é€‰æ‹©

è¯·å‘Šè¯‰æˆ‘ä½ å¸Œæœ›ï¼š

### é€‰é¡¹ Aï¼šå¿«é€Ÿæ¢å¤ï¼ˆ5åˆ†é’Ÿï¼‰
æˆ‘å¸®ä½ æ”¹å› `signUp()` æ–¹å¼ï¼Œä½†ç”¨æˆ·éœ€è¦éªŒè¯é‚®ç®±

### é€‰é¡¹ Bï¼šå®Œå–„è§£å†³ï¼ˆ10åˆ†é’Ÿï¼‰
éƒ¨ç½² Edge Functionï¼Œæ— éœ€é‚®ç®±éªŒè¯ï¼Œæ›´å®‰å…¨

### é€‰é¡¹ Cï¼šäº†è§£æ›´å¤š
æˆ‘è¯¦ç»†è§£é‡Šæ¯ä¸ªæ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹

ä½ æƒ³é€‰å“ªä¸ªï¼ŸğŸ˜Š

