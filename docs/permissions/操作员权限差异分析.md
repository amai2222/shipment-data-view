# 操作员权限差异分析

## 问题描述

操作员角色的菜单权限数量显示为 25，但实际应该只比管理员（47）少一个"设置"菜单及其子菜单（共7个）。

实际差异：47 - 25 = **22个菜单权限**

## 预期差异

根据配置，操作员应该只缺少：
1. `settings`（设置主菜单）
2. `settings.users`（用户管理）
3. `settings.permissions`（权限配置）
4. `settings.contract_permissions`（合同权限）
5. `settings.role_templates`（角色模板）
6. `settings.integrated`（集成权限管理）
7. `settings.audit_logs`（操作日志）

**预期差异：7个菜单权限**

## 实际配置差异

根据 `src/config/permissions.ts` 中的配置：

### 管理员（admin）有但操作员（operator）没有的菜单权限：

1. **数据看板**
   - `dashboard.project` ❌ 操作员缺少

2. **信息维护**
   - `maintenance.projects` ❌ 操作员缺少
   - `maintenance.locations_enhanced` ❌ 操作员缺少

3. **设置菜单（全部）**
   - `settings` ❌ 操作员缺少
   - `settings.users` ❌ 操作员缺少
   - `settings.permissions` ❌ 操作员缺少
   - `settings.contract_permissions` ❌ 操作员缺少
   - `settings.role_templates` ❌ 操作员缺少
   - `settings.integrated` ❌ 操作员缺少
   - `settings.audit_logs` ❌ 操作员缺少

**配置差异：1 + 2 + 7 = 10个菜单权限**

## 数据库中的实际差异

需要执行 `scripts/check_role_permissions_difference.sql` 来检查数据库中实际存储的权限差异。

## 可能的原因

1. **数据库中的数据与配置文件不一致**
   - 数据库中的权限可能没有正确同步
   - 可能某些权限被误删或未正确保存

2. **菜单权限计数逻辑问题**
   - 可能计算了某些不应该计算的权限项
   - 可能重复计算了某些权限

3. **权限同步问题**
   - 前端配置的权限可能没有正确保存到数据库

## 解决方案

### 步骤 1：检查数据库中的实际权限

执行以下 SQL 查询：

```sql
-- 查看管理员和操作员的实际菜单权限
SELECT 
    role,
    menu_permissions,
    array_length(menu_permissions, 1) as menu_count
FROM public.role_permission_templates
WHERE role IN ('admin', 'operator')
ORDER BY role;
```

### 步骤 2：找出缺失的权限

执行 `scripts/check_role_permissions_difference.sql` 找出具体缺失的权限。

### 步骤 3：修复操作员权限

根据分析，操作员应该添加以下权限：
- `dashboard.project`（项目看板）
- `maintenance.projects`（项目管理）
- `maintenance.locations_enhanced`（地点管理增强版）

然后操作员的菜单权限应该是：47 - 7（设置菜单）= **40个**，而不是25个。

## 结论

**当前显示的25个菜单权限不正确**。根据配置，操作员应该有：
- 管理员权限（47个）减去设置菜单（7个） = **40个菜单权限**

如果显示为25，说明数据库中可能：
1. 缺少了其他菜单权限
2. 或者权限计算逻辑有问题

需要检查数据库中的实际数据来确定具体原因。

