# 用户管理安全升级完整指南

## 🎯 升级概述

本次升级将所有用户管理功能从不安全的前端 Admin API 调用改为安全的 Edge Functions 调用，消除了安全漏洞。

---

## ✅ 已修复的功能

| 功能 | 旧实现 | 新实现 | 状态 |
|------|--------|--------|------|
| 创建用户 | ❌ `auth.admin.createUser()` | ✅ Edge Function | 🟢 已修复 |
| 修改密码 | ❌ `auth.admin.updateUserById()` | ✅ Edge Function | 🟢 已修复 |
| 更新用户信息 | ❌ `auth.admin.updateUserById()` | ✅ Edge Function | 🟢 已修复 |
| 删除用户 | ❌ `auth.admin.deleteUser()` | ✅ Edge Function | 🟢 已修复 |
| 批量删除用户 | ❌ `auth.admin.deleteUser()` | ✅ Edge Function | 🟢 已修复 |

---

## 📦 新增的 Edge Functions

### 1. create-user
**功能**：安全创建新用户

**权限**：admin, system_admin

**特性**：
- ✅ 自动邮箱验证（无需用户点击验证链接）
- ✅ 密码强度验证（至少6位）
- ✅ 邮箱格式验证
- ✅ 邮箱重复检查
- ✅ 角色有效性验证
- ✅ 失败自动回滚

### 2. update-user-password
**功能**：安全修改用户密码

**权限**：
- 用户可以修改自己的密码
- admin, system_admin 可以修改任何人的密码

**特性**：
- ✅ 密码强度验证
- ✅ 权限检查
- ✅ 防止修改自己的密码时越权

### 3. update-user
**功能**：安全更新用户信息

**权限**：
- 用户可以修改自己的基本信息（姓名、电话等）
- admin, system_admin 可以修改任何人的所有信息
- 只有管理员可以修改角色和状态

**特性**：
- ✅ 邮箱格式验证
- ✅ 邮箱重复检查
- ✅ 角色有效性验证
- ✅ 权限分级控制

### 4. delete-user
**功能**：安全删除用户

**权限**：
- admin 可以软删除（停用用户）
- system_admin 可以硬删除（永久删除）

**特性**：
- ✅ 软删除：设置 is_active = false
- ✅ 硬删除：完全删除认证和档案
- ✅ 防止删除自己
- ✅ 权限分级控制

---

## 🚀 部署步骤

### 方法 1：使用自动部署脚本（推荐）⚡

```powershell
# 在项目根目录执行
.\deploy-all-user-functions.ps1
```

脚本会自动：
1. ✓ 检查环境
2. ✓ 登录 Supabase
3. ✓ 链接项目
4. ✓ 部署所有函数
5. ✓ 显示结果

### 方法 2：手动部署

```powershell
# 1. 登录
supabase login

# 2. 链接项目
supabase link --project-ref [你的项目ID]

# 3. 部署各个函数
supabase functions deploy create-user --no-verify-jwt
supabase functions deploy update-user-password --no-verify-jwt
supabase functions deploy update-user --no-verify-jwt
supabase functions deploy delete-user --no-verify-jwt

# 4. 查看部署状态
supabase functions list
```

### 方法 3：在 Supabase Dashboard 手动部署

1. 访问 https://app.supabase.com
2. 选择项目 → Edge Functions
3. 依次创建以下函数：
   - `create-user`
   - `update-user-password`
   - `update-user`
   - `delete-user`
4. 复制对应的 `supabase/functions/[function-name]/index.ts` 内容

---

## 🧪 测试指南

### 测试前准备

1. 部署所有 Edge Functions
2. 刷新前端页面（Ctrl+F5）
3. 使用管理员账号登录

### 测试用例 1：创建用户

**步骤**：
1. 进入 **设置** → **用户管理**
2. 点击 **+ 新建用户**
3. 填写信息：
   - 邮箱：test@example.com
   - 密码：Test123!
   - 姓名：测试用户
   - 角色：查看者

**预期结果**：
- ✅ 显示"用户创建成功"
- ✅ 用户出现在列表中
- ✅ 新用户可以直接登录（无需邮箱验证）

**错误测试**：
| 测试 | 输入 | 预期结果 |
|------|------|---------|
| 邮箱格式错误 | "test@" | ❌ "邮箱格式不正确" |
| 密码太短 | "123" | ❌ "密码长度至少为 6 位" |
| 邮箱重复 | 已存在的邮箱 | ❌ "该邮箱已被注册" |
| 无效角色 | "superuser" | ❌ "无效的角色" |

### 测试用例 2：修改密码

**步骤**：
1. 找到任意用户
2. 点击 **修改密码** 图标
3. 输入新密码：NewPass123!
4. 确认保存

**预期结果**：
- ✅ 显示"密码修改成功"
- ✅ 用户可以使用新密码登录

**权限测试**：
| 角色 | 修改自己密码 | 修改他人密码 |
|------|-------------|-------------|
| system_admin | ✅ 可以 | ✅ 可以 |
| admin | ✅ 可以 | ✅ 可以 |
| operator | ✅ 可以 | ❌ 不可以 |
| viewer | ✅ 可以 | ❌ 不可以 |

### 测试用例 3：更新用户信息

**步骤**：
1. 找到任意用户
2. 点击 **编辑** 图标
3. 修改信息：
   - 姓名：新姓名
   - 角色：操作员
   - 手机：13800138000
4. 保存

**预期结果**：
- ✅ 显示"用户信息更新成功"
- ✅ 信息立即更新显示

**权限测试**：
| 修改内容 | admin | operator |
|---------|-------|----------|
| 自己的姓名 | ✅ 可以 | ✅ 可以 |
| 自己的角色 | ❌ 不可以 | ❌ 不可以 |
| 他人的姓名 | ✅ 可以 | ❌ 不可以 |
| 他人的角色 | ✅ 可以 | ❌ 不可以 |

### 测试用例 4：删除用户

#### 软删除（停用用户）

**步骤**：
1. 找到任意用户
2. 点击 **删除/停用** 按钮
3. 在对话框中选择"停用用户"
4. 确认

**预期结果**：
- ✅ 显示"用户已停用"
- ✅ 用户状态变为"已停用"
- ✅ 用户无法登录
- ✅ 数据仍然保留

#### 硬删除（永久删除）

**步骤**：
1. 使用 system_admin 账号登录
2. 找到任意用户
3. 点击 **删除/停用** 按钮
4. 在对话框中选择"永久删除"
5. 确认

**预期结果**：
- ✅ 显示"用户已永久删除"
- ✅ 用户从列表中消失
- ✅ 所有相关数据被删除

**权限测试**：
| 角色 | 软删除 | 硬删除 |
|------|--------|--------|
| system_admin | ✅ 可以 | ✅ 可以 |
| admin | ✅ 可以 | ❌ 不可以 |
| operator | ❌ 不可以 | ❌ 不可以 |

### 测试用例 5：批量删除用户

**步骤**：
1. 勾选多个用户
2. 点击 **批量删除** 按钮
3. 选择删除类型（停用/永久删除）
4. 确认

**预期结果**：
- ✅ 显示"已停用/删除 X 个用户"
- ✅ 所有选中用户被处理
- ✅ 失败的用户会显示错误信息

---

## 🔍 故障排查

### 问题 1：调用 Edge Function 失败

**错误信息**：`Failed to fetch` 或 `Network error`

**解决方案**：
```powershell
# 1. 检查函数是否部署成功
supabase functions list

# 2. 查看函数日志
supabase functions logs create-user
supabase functions logs update-user-password
supabase functions logs update-user
supabase functions logs delete-user

# 3. 重新部署
.\deploy-all-user-functions.ps1
```

### 问题 2：权限不足

**错误信息**：`您没有权限...`

**原因**：当前用户角色不够

**解决方案**：
```sql
-- 检查用户角色
SELECT id, email, role FROM profiles WHERE email = '你的邮箱';

-- 如需要，更新为管理员
UPDATE profiles 
SET role = 'admin' 
WHERE email = '你的邮箱';
```

### 问题 3：邮箱已存在

**错误信息**：`该邮箱已被注册`

**解决方案**：
```sql
-- 检查邮箱
SELECT id, email, is_active FROM profiles WHERE email = '邮箱地址';

-- 如果是已停用的用户，可以重新激活
UPDATE profiles 
SET is_active = true 
WHERE email = '邮箱地址';
```

### 问题 4：函数部署失败

**常见原因**：
- 网络连接问题
- 项目 ID 错误
- 函数代码语法错误
- Supabase CLI 版本过旧

**解决方案**：
```powershell
# 1. 检查 CLI 版本
supabase --version

# 2. 更新 CLI
npm update -g supabase

# 3. 重新登录和链接
supabase logout
supabase login
supabase link --project-ref [项目ID]

# 4. 重新部署
.\deploy-all-user-functions.ps1
```

---

## 📊 安全性对比

### 升级前 ❌

```typescript
// 不安全：Service Role Key 暴露在前端
const { data } = await supabase.auth.admin.createUser({...});
```

**风险**：
- ❌ Service Role Key 可能被窃取
- ❌ 攻击者可以执行任何数据库操作
- ❌ 无法进行权限控制
- ❌ 无法审计操作日志

### 升级后 ✅

```typescript
// 安全：通过 Edge Function
const { data } = await supabase.functions.invoke('create-user', {...});
```

**优势**：
- ✅ Service Role Key 只在服务端
- ✅ 完善的权限验证
- ✅ 详细的操作日志
- ✅ 更好的错误处理
- ✅ 可以添加复杂业务逻辑

---

## 📚 API 文档

### create-user

```typescript
await supabase.functions.invoke('create-user', {
  body: {
    email: string;           // 必填
    password: string;        // 必填，至少6位
    full_name: string;       // 必填
    role: string;            // 必填，有效角色之一
    phone?: string;          // 可选
    work_wechat_userid?: string;  // 可选
  }
});
```

### update-user-password

```typescript
await supabase.functions.invoke('update-user-password', {
  body: {
    userId: string;          // 必填
    newPassword: string;     // 必填，至少6位
  }
});
```

### update-user

```typescript
await supabase.functions.invoke('update-user', {
  body: {
    userId: string;          // 必填
    email?: string;          // 可选
    full_name?: string;      // 可选
    role?: string;           // 可选
    phone?: string;          // 可选
    work_wechat_userid?: string;  // 可选
    is_active?: boolean;     // 可选
  }
});
```

### delete-user

```typescript
await supabase.functions.invoke('delete-user', {
  body: {
    userId: string;          // 必填
    hardDelete?: boolean;    // 可选，默认 false（软删除）
  }
});
```

---

## ✨ 总结

### 升级内容
1. ✅ 创建了 4 个 Edge Functions
2. ✅ 修改了 5 个前端文件
3. ✅ 创建了统一部署脚本
4. ✅ 编写了完整测试指南

### 安全提升
- 🔒 消除了 Service Role Key 泄露风险
- 🔒 增加了完善的权限控制
- 🔒 提供了详细的操作日志
- 🔒 支持更复杂的业务逻辑

### 用户体验
- ⚡ 无需邮箱验证，创建即可用
- ⚡ 更详细的错误提示
- ⚡ 支持软删除和硬删除
- ⚡ 权限分级更合理

---

## 🎉 完成！

现在你的用户管理系统已经完全安全了！

**下一步**：
1. 运行 `.\deploy-all-user-functions.ps1` 部署所有函数
2. 刷新前端页面测试功能
3. 如有问题，查看故障排查部分

需要帮助？随时联系！😊

