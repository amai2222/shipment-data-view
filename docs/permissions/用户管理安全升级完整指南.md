# ç”¨æˆ·ç®¡ç†å®‰å…¨å‡çº§å®Œæ•´æŒ‡å—

## ğŸ¯ å‡çº§æ¦‚è¿°

æœ¬æ¬¡å‡çº§å°†æ‰€æœ‰ç”¨æˆ·ç®¡ç†åŠŸèƒ½ä»ä¸å®‰å…¨çš„å‰ç«¯ Admin API è°ƒç”¨æ”¹ä¸ºå®‰å…¨çš„ Edge Functions è°ƒç”¨ï¼Œæ¶ˆé™¤äº†å®‰å…¨æ¼æ´ã€‚

---

## âœ… å·²ä¿®å¤çš„åŠŸèƒ½

| åŠŸèƒ½ | æ—§å®ç° | æ–°å®ç° | çŠ¶æ€ |
|------|--------|--------|------|
| åˆ›å»ºç”¨æˆ· | âŒ `auth.admin.createUser()` | âœ… Edge Function | ğŸŸ¢ å·²ä¿®å¤ |
| ä¿®æ”¹å¯†ç  | âŒ `auth.admin.updateUserById()` | âœ… Edge Function | ğŸŸ¢ å·²ä¿®å¤ |
| æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | âŒ `auth.admin.updateUserById()` | âœ… Edge Function | ğŸŸ¢ å·²ä¿®å¤ |
| åˆ é™¤ç”¨æˆ· | âŒ `auth.admin.deleteUser()` | âœ… Edge Function | ğŸŸ¢ å·²ä¿®å¤ |
| æ‰¹é‡åˆ é™¤ç”¨æˆ· | âŒ `auth.admin.deleteUser()` | âœ… Edge Function | ğŸŸ¢ å·²ä¿®å¤ |

---

## ğŸ“¦ æ–°å¢çš„ Edge Functions

### 1. create-user
**åŠŸèƒ½**ï¼šå®‰å…¨åˆ›å»ºæ–°ç”¨æˆ·

**æƒé™**ï¼šadmin, system_admin

**ç‰¹æ€§**ï¼š
- âœ… è‡ªåŠ¨é‚®ç®±éªŒè¯ï¼ˆæ— éœ€ç”¨æˆ·ç‚¹å‡»éªŒè¯é“¾æ¥ï¼‰
- âœ… å¯†ç å¼ºåº¦éªŒè¯ï¼ˆè‡³å°‘6ä½ï¼‰
- âœ… é‚®ç®±æ ¼å¼éªŒè¯
- âœ… é‚®ç®±é‡å¤æ£€æŸ¥
- âœ… è§’è‰²æœ‰æ•ˆæ€§éªŒè¯
- âœ… å¤±è´¥è‡ªåŠ¨å›æ»š

### 2. update-user-password
**åŠŸèƒ½**ï¼šå®‰å…¨ä¿®æ”¹ç”¨æˆ·å¯†ç 

**æƒé™**ï¼š
- ç”¨æˆ·å¯ä»¥ä¿®æ”¹è‡ªå·±çš„å¯†ç 
- admin, system_admin å¯ä»¥ä¿®æ”¹ä»»ä½•äººçš„å¯†ç 

**ç‰¹æ€§**ï¼š
- âœ… å¯†ç å¼ºåº¦éªŒè¯
- âœ… æƒé™æ£€æŸ¥
- âœ… é˜²æ­¢ä¿®æ”¹è‡ªå·±çš„å¯†ç æ—¶è¶Šæƒ

### 3. update-user
**åŠŸèƒ½**ï¼šå®‰å…¨æ›´æ–°ç”¨æˆ·ä¿¡æ¯

**æƒé™**ï¼š
- ç”¨æˆ·å¯ä»¥ä¿®æ”¹è‡ªå·±çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€ç”µè¯ç­‰ï¼‰
- admin, system_admin å¯ä»¥ä¿®æ”¹ä»»ä½•äººçš„æ‰€æœ‰ä¿¡æ¯
- åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹è§’è‰²å’ŒçŠ¶æ€

**ç‰¹æ€§**ï¼š
- âœ… é‚®ç®±æ ¼å¼éªŒè¯
- âœ… é‚®ç®±é‡å¤æ£€æŸ¥
- âœ… è§’è‰²æœ‰æ•ˆæ€§éªŒè¯
- âœ… æƒé™åˆ†çº§æ§åˆ¶

### 4. delete-user
**åŠŸèƒ½**ï¼šå®‰å…¨åˆ é™¤ç”¨æˆ·

**æƒé™**ï¼š
- admin å¯ä»¥è½¯åˆ é™¤ï¼ˆåœç”¨ç”¨æˆ·ï¼‰
- system_admin å¯ä»¥ç¡¬åˆ é™¤ï¼ˆæ°¸ä¹…åˆ é™¤ï¼‰

**ç‰¹æ€§**ï¼š
- âœ… è½¯åˆ é™¤ï¼šè®¾ç½® is_active = false
- âœ… ç¡¬åˆ é™¤ï¼šå®Œå…¨åˆ é™¤è®¤è¯å’Œæ¡£æ¡ˆ
- âœ… é˜²æ­¢åˆ é™¤è‡ªå·±
- âœ… æƒé™åˆ†çº§æ§åˆ¶

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹æ³• 1ï¼šä½¿ç”¨è‡ªåŠ¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰âš¡

```powershell
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
.\deploy-all-user-functions.ps1
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. âœ“ æ£€æŸ¥ç¯å¢ƒ
2. âœ“ ç™»å½• Supabase
3. âœ“ é“¾æ¥é¡¹ç›®
4. âœ“ éƒ¨ç½²æ‰€æœ‰å‡½æ•°
5. âœ“ æ˜¾ç¤ºç»“æœ

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨éƒ¨ç½²

```powershell
# 1. ç™»å½•
supabase login

# 2. é“¾æ¥é¡¹ç›®
supabase link --project-ref [ä½ çš„é¡¹ç›®ID]

# 3. éƒ¨ç½²å„ä¸ªå‡½æ•°
supabase functions deploy create-user --no-verify-jwt
supabase functions deploy update-user-password --no-verify-jwt
supabase functions deploy update-user --no-verify-jwt
supabase functions deploy delete-user --no-verify-jwt

# 4. æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
supabase functions list
```

### æ–¹æ³• 3ï¼šåœ¨ Supabase Dashboard æ‰‹åŠ¨éƒ¨ç½²

1. è®¿é—® https://app.supabase.com
2. é€‰æ‹©é¡¹ç›® â†’ Edge Functions
3. ä¾æ¬¡åˆ›å»ºä»¥ä¸‹å‡½æ•°ï¼š
   - `create-user`
   - `update-user-password`
   - `update-user`
   - `delete-user`
4. å¤åˆ¶å¯¹åº”çš„ `supabase/functions/[function-name]/index.ts` å†…å®¹

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### æµ‹è¯•å‰å‡†å¤‡

1. éƒ¨ç½²æ‰€æœ‰ Edge Functions
2. åˆ·æ–°å‰ç«¯é¡µé¢ï¼ˆCtrl+F5ï¼‰
3. ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•

### æµ‹è¯•ç”¨ä¾‹ 1ï¼šåˆ›å»ºç”¨æˆ·

**æ­¥éª¤**ï¼š
1. è¿›å…¥ **è®¾ç½®** â†’ **ç”¨æˆ·ç®¡ç†**
2. ç‚¹å‡» **+ æ–°å»ºç”¨æˆ·**
3. å¡«å†™ä¿¡æ¯ï¼š
   - é‚®ç®±ï¼štest@example.com
   - å¯†ç ï¼šTest123!
   - å§“åï¼šæµ‹è¯•ç”¨æˆ·
   - è§’è‰²ï¼šæŸ¥çœ‹è€…

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤º"ç”¨æˆ·åˆ›å»ºæˆåŠŸ"
- âœ… ç”¨æˆ·å‡ºç°åœ¨åˆ—è¡¨ä¸­
- âœ… æ–°ç”¨æˆ·å¯ä»¥ç›´æ¥ç™»å½•ï¼ˆæ— éœ€é‚®ç®±éªŒè¯ï¼‰

**é”™è¯¯æµ‹è¯•**ï¼š
| æµ‹è¯• | è¾“å…¥ | é¢„æœŸç»“æœ |
|------|------|---------|
| é‚®ç®±æ ¼å¼é”™è¯¯ | "test@" | âŒ "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®" |
| å¯†ç å¤ªçŸ­ | "123" | âŒ "å¯†ç é•¿åº¦è‡³å°‘ä¸º 6 ä½" |
| é‚®ç®±é‡å¤ | å·²å­˜åœ¨çš„é‚®ç®± | âŒ "è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ" |
| æ— æ•ˆè§’è‰² | "superuser" | âŒ "æ— æ•ˆçš„è§’è‰²" |

### æµ‹è¯•ç”¨ä¾‹ 2ï¼šä¿®æ”¹å¯†ç 

**æ­¥éª¤**ï¼š
1. æ‰¾åˆ°ä»»æ„ç”¨æˆ·
2. ç‚¹å‡» **ä¿®æ”¹å¯†ç ** å›¾æ ‡
3. è¾“å…¥æ–°å¯†ç ï¼šNewPass123!
4. ç¡®è®¤ä¿å­˜

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤º"å¯†ç ä¿®æ”¹æˆåŠŸ"
- âœ… ç”¨æˆ·å¯ä»¥ä½¿ç”¨æ–°å¯†ç ç™»å½•

**æƒé™æµ‹è¯•**ï¼š
| è§’è‰² | ä¿®æ”¹è‡ªå·±å¯†ç  | ä¿®æ”¹ä»–äººå¯†ç  |
|------|-------------|-------------|
| system_admin | âœ… å¯ä»¥ | âœ… å¯ä»¥ |
| admin | âœ… å¯ä»¥ | âœ… å¯ä»¥ |
| operator | âœ… å¯ä»¥ | âŒ ä¸å¯ä»¥ |
| viewer | âœ… å¯ä»¥ | âŒ ä¸å¯ä»¥ |

### æµ‹è¯•ç”¨ä¾‹ 3ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯

**æ­¥éª¤**ï¼š
1. æ‰¾åˆ°ä»»æ„ç”¨æˆ·
2. ç‚¹å‡» **ç¼–è¾‘** å›¾æ ‡
3. ä¿®æ”¹ä¿¡æ¯ï¼š
   - å§“åï¼šæ–°å§“å
   - è§’è‰²ï¼šæ“ä½œå‘˜
   - æ‰‹æœºï¼š13800138000
4. ä¿å­˜

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤º"ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ"
- âœ… ä¿¡æ¯ç«‹å³æ›´æ–°æ˜¾ç¤º

**æƒé™æµ‹è¯•**ï¼š
| ä¿®æ”¹å†…å®¹ | admin | operator |
|---------|-------|----------|
| è‡ªå·±çš„å§“å | âœ… å¯ä»¥ | âœ… å¯ä»¥ |
| è‡ªå·±çš„è§’è‰² | âŒ ä¸å¯ä»¥ | âŒ ä¸å¯ä»¥ |
| ä»–äººçš„å§“å | âœ… å¯ä»¥ | âŒ ä¸å¯ä»¥ |
| ä»–äººçš„è§’è‰² | âœ… å¯ä»¥ | âŒ ä¸å¯ä»¥ |

### æµ‹è¯•ç”¨ä¾‹ 4ï¼šåˆ é™¤ç”¨æˆ·

#### è½¯åˆ é™¤ï¼ˆåœç”¨ç”¨æˆ·ï¼‰

**æ­¥éª¤**ï¼š
1. æ‰¾åˆ°ä»»æ„ç”¨æˆ·
2. ç‚¹å‡» **åˆ é™¤/åœç”¨** æŒ‰é’®
3. åœ¨å¯¹è¯æ¡†ä¸­é€‰æ‹©"åœç”¨ç”¨æˆ·"
4. ç¡®è®¤

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤º"ç”¨æˆ·å·²åœç”¨"
- âœ… ç”¨æˆ·çŠ¶æ€å˜ä¸º"å·²åœç”¨"
- âœ… ç”¨æˆ·æ— æ³•ç™»å½•
- âœ… æ•°æ®ä»ç„¶ä¿ç•™

#### ç¡¬åˆ é™¤ï¼ˆæ°¸ä¹…åˆ é™¤ï¼‰

**æ­¥éª¤**ï¼š
1. ä½¿ç”¨ system_admin è´¦å·ç™»å½•
2. æ‰¾åˆ°ä»»æ„ç”¨æˆ·
3. ç‚¹å‡» **åˆ é™¤/åœç”¨** æŒ‰é’®
4. åœ¨å¯¹è¯æ¡†ä¸­é€‰æ‹©"æ°¸ä¹…åˆ é™¤"
5. ç¡®è®¤

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤º"ç”¨æˆ·å·²æ°¸ä¹…åˆ é™¤"
- âœ… ç”¨æˆ·ä»åˆ—è¡¨ä¸­æ¶ˆå¤±
- âœ… æ‰€æœ‰ç›¸å…³æ•°æ®è¢«åˆ é™¤

**æƒé™æµ‹è¯•**ï¼š
| è§’è‰² | è½¯åˆ é™¤ | ç¡¬åˆ é™¤ |
|------|--------|--------|
| system_admin | âœ… å¯ä»¥ | âœ… å¯ä»¥ |
| admin | âœ… å¯ä»¥ | âŒ ä¸å¯ä»¥ |
| operator | âŒ ä¸å¯ä»¥ | âŒ ä¸å¯ä»¥ |

### æµ‹è¯•ç”¨ä¾‹ 5ï¼šæ‰¹é‡åˆ é™¤ç”¨æˆ·

**æ­¥éª¤**ï¼š
1. å‹¾é€‰å¤šä¸ªç”¨æˆ·
2. ç‚¹å‡» **æ‰¹é‡åˆ é™¤** æŒ‰é’®
3. é€‰æ‹©åˆ é™¤ç±»å‹ï¼ˆåœç”¨/æ°¸ä¹…åˆ é™¤ï¼‰
4. ç¡®è®¤

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤º"å·²åœç”¨/åˆ é™¤ X ä¸ªç”¨æˆ·"
- âœ… æ‰€æœ‰é€‰ä¸­ç”¨æˆ·è¢«å¤„ç†
- âœ… å¤±è´¥çš„ç”¨æˆ·ä¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šè°ƒç”¨ Edge Function å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š`Failed to fetch` æˆ– `Network error`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# 1. æ£€æŸ¥å‡½æ•°æ˜¯å¦éƒ¨ç½²æˆåŠŸ
supabase functions list

# 2. æŸ¥çœ‹å‡½æ•°æ—¥å¿—
supabase functions logs create-user
supabase functions logs update-user-password
supabase functions logs update-user
supabase functions logs delete-user

# 3. é‡æ–°éƒ¨ç½²
.\deploy-all-user-functions.ps1
```

### é—®é¢˜ 2ï¼šæƒé™ä¸è¶³

**é”™è¯¯ä¿¡æ¯**ï¼š`æ‚¨æ²¡æœ‰æƒé™...`

**åŸå› **ï¼šå½“å‰ç”¨æˆ·è§’è‰²ä¸å¤Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- æ£€æŸ¥ç”¨æˆ·è§’è‰²
SELECT id, email, role FROM profiles WHERE email = 'ä½ çš„é‚®ç®±';

-- å¦‚éœ€è¦ï¼Œæ›´æ–°ä¸ºç®¡ç†å‘˜
UPDATE profiles 
SET role = 'admin' 
WHERE email = 'ä½ çš„é‚®ç®±';
```

### é—®é¢˜ 3ï¼šé‚®ç®±å·²å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š`è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- æ£€æŸ¥é‚®ç®±
SELECT id, email, is_active FROM profiles WHERE email = 'é‚®ç®±åœ°å€';

-- å¦‚æœæ˜¯å·²åœç”¨çš„ç”¨æˆ·ï¼Œå¯ä»¥é‡æ–°æ¿€æ´»
UPDATE profiles 
SET is_active = true 
WHERE email = 'é‚®ç®±åœ°å€';
```

### é—®é¢˜ 4ï¼šå‡½æ•°éƒ¨ç½²å¤±è´¥

**å¸¸è§åŸå› **ï¼š
- ç½‘ç»œè¿æ¥é—®é¢˜
- é¡¹ç›® ID é”™è¯¯
- å‡½æ•°ä»£ç è¯­æ³•é”™è¯¯
- Supabase CLI ç‰ˆæœ¬è¿‡æ—§

**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# 1. æ£€æŸ¥ CLI ç‰ˆæœ¬
supabase --version

# 2. æ›´æ–° CLI
npm update -g supabase

# 3. é‡æ–°ç™»å½•å’Œé“¾æ¥
supabase logout
supabase login
supabase link --project-ref [é¡¹ç›®ID]

# 4. é‡æ–°éƒ¨ç½²
.\deploy-all-user-functions.ps1
```

---

## ğŸ“Š å®‰å…¨æ€§å¯¹æ¯”

### å‡çº§å‰ âŒ

```typescript
// ä¸å®‰å…¨ï¼šService Role Key æš´éœ²åœ¨å‰ç«¯
const { data } = await supabase.auth.admin.createUser({...});
```

**é£é™©**ï¼š
- âŒ Service Role Key å¯èƒ½è¢«çªƒå–
- âŒ æ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»ä½•æ•°æ®åº“æ“ä½œ
- âŒ æ— æ³•è¿›è¡Œæƒé™æ§åˆ¶
- âŒ æ— æ³•å®¡è®¡æ“ä½œæ—¥å¿—

### å‡çº§å âœ…

```typescript
// å®‰å…¨ï¼šé€šè¿‡ Edge Function
const { data } = await supabase.functions.invoke('create-user', {...});
```

**ä¼˜åŠ¿**ï¼š
- âœ… Service Role Key åªåœ¨æœåŠ¡ç«¯
- âœ… å®Œå–„çš„æƒé™éªŒè¯
- âœ… è¯¦ç»†çš„æ“ä½œæ—¥å¿—
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†
- âœ… å¯ä»¥æ·»åŠ å¤æ‚ä¸šåŠ¡é€»è¾‘

---

## ğŸ“š API æ–‡æ¡£

### create-user

```typescript
await supabase.functions.invoke('create-user', {
  body: {
    email: string;           // å¿…å¡«
    password: string;        // å¿…å¡«ï¼Œè‡³å°‘6ä½
    full_name: string;       // å¿…å¡«
    role: string;            // å¿…å¡«ï¼Œæœ‰æ•ˆè§’è‰²ä¹‹ä¸€
    phone?: string;          // å¯é€‰
    work_wechat_userid?: string;  // å¯é€‰
  }
});
```

### update-user-password

```typescript
await supabase.functions.invoke('update-user-password', {
  body: {
    userId: string;          // å¿…å¡«
    newPassword: string;     // å¿…å¡«ï¼Œè‡³å°‘6ä½
  }
});
```

### update-user

```typescript
await supabase.functions.invoke('update-user', {
  body: {
    userId: string;          // å¿…å¡«
    email?: string;          // å¯é€‰
    full_name?: string;      // å¯é€‰
    role?: string;           // å¯é€‰
    phone?: string;          // å¯é€‰
    work_wechat_userid?: string;  // å¯é€‰
    is_active?: boolean;     // å¯é€‰
  }
});
```

### delete-user

```typescript
await supabase.functions.invoke('delete-user', {
  body: {
    userId: string;          // å¿…å¡«
    hardDelete?: boolean;    // å¯é€‰ï¼Œé»˜è®¤ falseï¼ˆè½¯åˆ é™¤ï¼‰
  }
});
```

---

## âœ¨ æ€»ç»“

### å‡çº§å†…å®¹
1. âœ… åˆ›å»ºäº† 4 ä¸ª Edge Functions
2. âœ… ä¿®æ”¹äº† 5 ä¸ªå‰ç«¯æ–‡ä»¶
3. âœ… åˆ›å»ºäº†ç»Ÿä¸€éƒ¨ç½²è„šæœ¬
4. âœ… ç¼–å†™äº†å®Œæ•´æµ‹è¯•æŒ‡å—

### å®‰å…¨æå‡
- ğŸ”’ æ¶ˆé™¤äº† Service Role Key æ³„éœ²é£é™©
- ğŸ”’ å¢åŠ äº†å®Œå–„çš„æƒé™æ§åˆ¶
- ğŸ”’ æä¾›äº†è¯¦ç»†çš„æ“ä½œæ—¥å¿—
- ğŸ”’ æ”¯æŒæ›´å¤æ‚çš„ä¸šåŠ¡é€»è¾‘

### ç”¨æˆ·ä½“éªŒ
- âš¡ æ— éœ€é‚®ç®±éªŒè¯ï¼Œåˆ›å»ºå³å¯ç”¨
- âš¡ æ›´è¯¦ç»†çš„é”™è¯¯æç¤º
- âš¡ æ”¯æŒè½¯åˆ é™¤å’Œç¡¬åˆ é™¤
- âš¡ æƒé™åˆ†çº§æ›´åˆç†

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ çš„ç”¨æˆ·ç®¡ç†ç³»ç»Ÿå·²ç»å®Œå…¨å®‰å…¨äº†ï¼

**ä¸‹ä¸€æ­¥**ï¼š
1. è¿è¡Œ `.\deploy-all-user-functions.ps1` éƒ¨ç½²æ‰€æœ‰å‡½æ•°
2. åˆ·æ–°å‰ç«¯é¡µé¢æµ‹è¯•åŠŸèƒ½
3. å¦‚æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹æ•…éšœæ’æŸ¥éƒ¨åˆ†

éœ€è¦å¸®åŠ©ï¼Ÿéšæ—¶è”ç³»ï¼ğŸ˜Š

