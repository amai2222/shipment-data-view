# 用户管理和项目分配系统逻辑详解

## 🏗️ **系统架构概览**

### 核心组件
1. **用户管理 (User Management)**
2. **权限管理 (Permission Management)**  
3. **项目分配 (Project Assignment)**
4. **角色管理 (Role Management)**

---

## 👥 **用户管理逻辑**

### 1. 用户数据结构

#### 数据库表：`profiles`
```sql
CREATE TABLE public.profiles (
  id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT,
  full_name TEXT,
  role TEXT DEFAULT 'viewer' CHECK (role IN ('admin', 'finance', 'business', 'operator', 'partner', 'viewer')),
  phone TEXT,
  work_wechat_userid TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  PRIMARY KEY (id)
);
```

#### 用户角色类型
- **admin**: 系统管理员 - 拥有所有权限
- **finance**: 财务人员 - 财务管理权限
- **business**: 业务人员 - 业务管理权限  
- **operator**: 操作员 - 基础操作权限
- **partner**: 合作伙伴 - 有限访问权限
- **viewer**: 查看者 - 只读权限

### 2. 用户管理服务

#### `UserManagementService.ts`
```typescript
// 核心功能
- getUsers(): 获取所有用户
- createUser(): 创建新用户（认证+档案）
- updateUser(): 更新用户信息
- deleteUser(): 删除用户
- batchUpdateUserRoles(): 批量更新用户角色
- batchUpdateUserStatus(): 批量更新用户状态
```

#### 用户创建流程
1. **认证创建**: 在 `auth.users` 中创建用户
2. **档案创建**: 在 `profiles` 表中创建用户档案
3. **权限分配**: 根据角色分配默认权限
4. **项目分配**: 自动分配所有项目访问权限

---

## 🔐 **权限管理逻辑**

### 1. 权限层级结构

#### 三层权限体系
```
用户实际权限 = 角色模板权限 + 用户自定义权限 + 项目分配权限
```

#### 权限类型
- **菜单权限 (Menu Permissions)**: 界面访问权限
- **功能权限 (Function Permissions)**: 操作执行权限
- **项目权限 (Project Permissions)**: 项目管理权限
- **数据权限 (Data Permissions)**: 数据访问权限

### 2. 权限数据表

#### `role_permission_templates` - 角色权限模板
```sql
CREATE TABLE public.role_permission_templates (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  role text NOT NULL UNIQUE,
  name text NOT NULL,
  description text,
  color text DEFAULT 'bg-gray-500',
  menu_permissions text[] DEFAULT '{}',
  function_permissions text[] DEFAULT '{}',
  project_permissions text[] DEFAULT '{}',
  data_permissions text[] DEFAULT '{}',
  is_system boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);
```

#### `user_permissions` - 用户自定义权限
```sql
CREATE TABLE public.user_permissions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES public.profiles(id),
  project_id uuid REFERENCES public.projects(id), -- NULL表示全局权限
  menu_permissions text[] DEFAULT '{}',
  function_permissions text[] DEFAULT '{}',
  project_permissions text[] DEFAULT '{}',
  data_permissions text[] DEFAULT '{}',
  inherit_role boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  UNIQUE(user_id, project_id)
);
```

### 3. 权限计算逻辑

#### `PermissionCalculationService.ts`
```typescript
// 权限计算流程
1. 获取用户角色模板权限
2. 获取用户自定义权限（如果有）
3. 获取项目分配权限
4. 合并所有权限
5. 返回最终有效权限
```

---

## 📋 **项目分配逻辑**

### 1. 项目分配策略

#### 默认权限策略
- **默认开放**: 所有用户默认具有所有项目的访问权限
- **明确限制**: 只有在 `user_projects` 表中有明确限制时才限制访问
- **自动分配**: 新用户和新项目会自动分配给所有用户

### 2. 项目分配数据表

#### `user_projects` - 用户项目关联表
```sql
CREATE TABLE public.user_projects (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  project_id uuid NOT NULL REFERENCES public.projects(id) ON DELETE CASCADE,
  role text DEFAULT 'member', -- 项目内角色
  can_view boolean DEFAULT true,
  can_edit boolean DEFAULT false,
  can_delete boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid REFERENCES public.profiles(id),
  UNIQUE(user_id, project_id)
);
```

### 3. 项目角色权限映射

#### `DynamicRoleService.ts`
```typescript
// 项目角色权限配置
const PROJECT_ROLE_PERMISSIONS = {
  admin: {
    additionalPermissions: [
      'project_access', 'project.view_all', 'project.admin',
      'project_data', 'project_data.view_financial', 'project_data.edit_financial',
      'project_data.view_operational', 'project_data.edit_operational'
    ],
    can_view: true, can_edit: true, can_delete: true
  },
  finance: {
    additionalPermissions: [
      'project_access', 'project.view_all', 'project_data',
      'project_data.view_financial', 'project_data.edit_financial'
    ],
    can_view: true, can_edit: true, can_delete: false
  },
  // ... 其他角色配置
};
```

### 4. 项目分配服务

#### `ProjectAssignmentService.ts`
```typescript
// 核心功能
- getUserProjectAssignments(): 获取用户项目分配
- assignProjectToUser(): 为用户分配项目
- removeProjectFromUser(): 移除用户项目分配
- batchAssignProjectsToUser(): 批量分配项目
- restrictProjectFromUser(): 限制用户项目访问
```

---

## 🔄 **权限计算流程**

### 1. 用户权限计算

```typescript
// 权限计算步骤
1. 获取用户基础信息（角色）
2. 加载角色模板权限
3. 加载用户自定义权限（如果有）
4. 加载项目分配权限
5. 合并权限（用户权限优先，项目权限叠加）
6. 返回最终权限
```

### 2. 权限优先级

```
用户自定义权限 > 角色模板权限 > 默认权限
项目分配权限 = 基础权限 + 额外权限
```

### 3. 权限数量计算

```
总权限数 = 菜单权限 + 功能权限 + 项目权限 + 数据权限
项目权限 = 基础项目权限 + 项目分配权限
```

---

## 🎯 **实际应用场景**

### 1. 新用户创建
1. 创建认证用户
2. 创建用户档案
3. 分配角色
4. 自动分配所有项目访问权限
5. 应用角色模板权限

### 2. 项目权限管理
1. 管理员选择用户
2. 查看用户当前项目分配
3. 分配/移除项目权限
4. 设置项目内角色
5. 权限立即生效

### 3. 权限变更
1. 修改用户角色
2. 更新角色模板权限
3. 添加用户自定义权限
4. 调整项目分配
5. 权限重新计算

---

## 📊 **权限统计逻辑**

### 权限数量显示
- **权限模板**: 显示基础权限数量（如60个）
- **用户权限**: 显示实际权限数量（如96-97个）
- **差异原因**: 项目分配权限叠加（+36-37个）

### 权限来源
- **基础权限**: 来自角色模板
- **额外权限**: 来自项目分配
- **自定义权限**: 来自用户特定配置

---

## 🔧 **技术实现要点**

### 1. 数据库设计
- 使用外键约束确保数据一致性
- 使用唯一约束防止重复分配
- 使用触发器自动更新时间戳

### 2. 权限缓存
- 权限计算结果缓存
- 实时权限更新
- 批量权限计算优化

### 3. 安全策略
- 行级安全策略（RLS）
- 角色基础访问控制
- 权限审计日志

---

## 📈 **系统优势**

1. **灵活性**: 支持角色模板 + 用户自定义 + 项目分配
2. **可扩展性**: 易于添加新角色和权限
3. **安全性**: 多层权限验证
4. **易用性**: 可视化权限管理界面
5. **性能**: 权限缓存和批量操作优化

这个系统实现了完整的用户权限管理体系，支持细粒度的权限控制和灵活的项目分配策略。
