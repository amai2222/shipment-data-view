# 操作员权限修复说明

## 问题分析

根据数据库查询结果，发现操作员角色的菜单权限存在以下问题：

### 1. 缺少父级菜单项

操作员权限中**缺少了关键的父级菜单项**，如：
- `dashboard`（数据看板主菜单）
- `business`（业务管理主菜单）
- `maintenance`（信息维护主菜单）
- `finance`（财务管理主菜单）
- `contracts`（合同管理主菜单）
- `audit`（审核管理主菜单）
- `data_maintenance`（数据维护主菜单）

### 2. 存在重复项

操作员权限列表中存在重复的权限项：
- `data_maintenance.waybill` 出现2次
- `contracts.list` 出现2次
- `data_maintenance.waybill_enhanced` 可能也有重复

### 3. 权限数量不正确

- **管理员权限数量**：47个
- **操作员权限数量**：25个（存在重复，实际更少）
- **预期差异**：应该只缺少7个设置菜单权限 = 40个权限
- **实际差异**：47 - 25 = 22个（不正确）

## 修复方案

### 修复逻辑

1. **获取管理员的所有菜单权限**
2. **移除设置相关的权限**（7个）：
   - `settings`
   - `settings.users`
   - `settings.permissions`
   - `settings.contract_permissions`
   - `settings.role_templates`
   - `settings.integrated`
   - `settings.audit_logs`
3. **去重处理**（确保没有重复项）
4. **更新操作员权限**

### 预期结果

- **管理员权限**：47个
- **操作员权限**：40个（47 - 7 = 40）
- **差异**：7个（仅设置菜单）

## 执行步骤

1. **执行修复脚本**：
   ```sql
   -- 在 Supabase SQL Editor 中执行
   -- scripts/fix_operator_menu_permissions.sql
   ```

2. **验证修复结果**：
   ```sql
   -- 检查权限数量和差异
   SELECT 
       role,
       array_length(menu_permissions, 1) as menu_count,
       array_to_string(menu_permissions, ', ') as permissions
   FROM public.role_permission_templates
   WHERE role IN ('admin', 'operator')
   ORDER BY role;
   ```

3. **检查缺失的权限**（应该只有设置菜单）：
   ```sql
   -- 执行 scripts/check_role_permissions_difference.sql
   ```

## 修复后预期

修复后，操作员应该拥有：
- ✅ 所有数据看板权限（包括 `dashboard`, `dashboard.transport`, `dashboard.financial`, `dashboard.project`, `dashboard.shipper`, `dashboard.quantity`）
- ✅ 所有信息维护权限（包括 `maintenance`, `maintenance.projects`, `maintenance.drivers`, `maintenance.locations`, `maintenance.locations_enhanced`, `maintenance.partners`）
- ✅ 所有业务管理权限（包括 `business`, `business.entry`, `business.scale`, `business.invoice_request`, `business.payment_request`, `business.payment_requests`）
- ✅ 所有合同管理权限（包括 `contracts` 及其所有子菜单）
- ✅ 所有财务管理权限（包括 `finance` 及其所有子菜单）
- ✅ 所有审核管理权限（包括 `audit`, `audit.invoice`, `audit.payment`）
- ✅ 所有数据维护权限（包括 `data_maintenance` 及其所有子菜单）
- ❌ **仅缺少设置菜单**（7个权限）

## 注意事项

- 修复脚本会自动去重，确保没有重复的权限项
- 修复后，操作员的权限数量应该是 **40个**（47 - 7）
- 如果修复后数量不对，请检查数据库中是否还有其他问题

