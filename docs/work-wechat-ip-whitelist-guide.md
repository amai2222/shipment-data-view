# 企业微信IP白名单配置指南

## 问题描述
当使用Supabase Edge Functions调用企业微信API时，可能会遇到以下错误：
```
errcode: 60020
errmsg: "not allow to access from your ip"
```

这是因为企业微信对调用API的服务器IP地址有白名单限制。

## 解决方案

### 步骤1：获取需要添加的IP地址
根据错误日志，当前需要添加的IP地址是：
- **IP地址**: `54.183.157.167`
- **建议添加IP段**: `54.183.0.0/16` (Supabase US-West区域)

### 步骤2：在企业微信后台配置IP白名单

#### 2.1 登录企业微信管理后台
1. 访问 [企业微信管理后台](https://work.weixin.qq.com)
2. 使用管理员账号登录

#### 2.2 进入应用设置
1. 在左侧菜单选择「应用管理」
2. 找到你的自建应用（AgentId: 1000002）
3. 点击进入应用详情页面

#### 2.3 配置企业可信IP
1. 在应用详情页面，找到「企业可信IP」区域
2. 点击「设置」或「配置」按钮
3. 在IP白名单中添加以下地址：

**方式1：添加具体IP**
```
54.183.157.167
```

**方式2：添加IP段（推荐）**
```
54.183.0.0/16
```

#### 2.4 保存设置
1. 确认IP地址输入正确
2. 点击「保存」或「确定」
3. 等待配置生效（通常几分钟内生效）

### 步骤3：验证配置
1. 配置完成后，重新在企业微信中尝试登录
2. 检查Supabase Edge Function日志，确认不再出现IP限制错误

## 替代方案

如果无法配置IP白名单（例如没有管理员权限），可以考虑以下替代方案：

### 方案A：使用企业微信网页版授权
直接在前端处理OAuth流程，减少服务端API调用。

### 方案B：联系企业微信管理员
请企业微信管理员协助配置IP白名单。

### 方案C：使用代理服务器
配置一个固定IP的代理服务器来中转API请求。

## 常见问题

### Q1: 添加IP后仍然报错怎么办？
- 检查IP地址是否输入正确
- 等待几分钟让配置生效
- 尝试添加更大的IP段

### Q2: 如何获取Supabase的完整IP范围？
- 可以联系Supabase支持获取完整的IP列表
- 或者使用通配符IP段如 `54.183.0.0/16`

### Q3: 配置后多久生效？
- 通常在几分钟内生效
- 如果超过10分钟仍未生效，请检查配置是否正确

## 安全提醒

- 只添加必要的IP地址，避免过度开放
- 定期检查和更新IP白名单
- 监控API调用日志，确保安全

---

配置完成后，企业微信登录功能就可以正常使用了。