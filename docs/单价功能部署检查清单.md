# 单价功能部署检查清单

## 📋 部署前检查

### 1. 文件确认 ✅

- [x] 前端代码修改
  - [x] `src/pages/BusinessEntry/components/LogisticsFormDialog.tsx`
  - [x] `src/pages/BusinessEntry/types.ts`

- [x] 数据库迁移文件
  - [x] `supabase/migrations/20251120_add_unit_price_and_auto_calculation.sql`
  - [x] `supabase/migrations/20251120_update_rpc_functions_support_unit_price.sql`
  - [x] `supabase/migrations/20251116_fix_add_logistics_record_with_costs_date_type.sql`（已更新）

- [x] 文档
  - [x] `docs/单价功能设计方案.md`
  - [x] `docs/单价功能前端实现说明.md`
  - [x] `docs/单价功能实施完成总结.md`
  - [x] `docs/单价功能使用指南.md`

---

## 🚀 部署步骤

### 第一步：数据库迁移

在 **Supabase Dashboard → SQL Editor** 中按顺序执行：

#### 1.1 添加字段和触发器（必须第一个执行）
```sql
-- 执行文件：
supabase/migrations/20251120_add_unit_price_and_auto_calculation.sql
```

**检查点**：
- [ ] 执行成功，无错误
- [ ] 看到提示："✅ 单价功能已成功创建"
- [ ] 看到新增字段提示

#### 1.2 更新 RPC 函数（第二个执行）
```sql
-- 执行文件：
supabase/migrations/20251120_update_rpc_functions_support_unit_price.sql
```

**检查点**：
- [ ] 执行成功，无错误
- [ ] 看到提示："✅ RPC 函数已更新，支持单价功能"

#### 1.3 重新执行 add_logistics_record_with_costs 函数（第三个执行）
```sql
-- 执行文件：
supabase/migrations/20251116_fix_add_logistics_record_with_costs_date_type.sql
```

**检查点**：
- [ ] 执行成功，无错误
- [ ] 函数成功更新

### 第二步：验证数据库

在 SQL Editor 中运行验证查询：

```sql
-- 1. 检查字段是否已添加
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'logistics_records'
AND column_name IN ('unit_price', 'effective_quantity', 'calculation_mode')
ORDER BY column_name;

-- 预期结果：
-- unit_price         | numeric     | YES | NULL
-- effective_quantity | numeric     | YES | NULL
-- calculation_mode   | text        | YES | 'manual'

-- 2. 检查触发器是否已创建
SELECT trigger_name, event_manipulation, event_object_table
FROM information_schema.triggers
WHERE trigger_name = 'trigger_auto_calculate_cost_from_unit_price';

-- 预期结果：应该有 1 行记录

-- 3. 检查函数是否已创建
SELECT proname, pronargs 
FROM pg_proc 
WHERE proname IN (
    'get_effective_quantity_for_record',
    'auto_calculate_cost_from_unit_price',
    'add_logistics_record_with_costs',
    'update_logistics_record_via_recalc'
)
ORDER BY proname;

-- 预期结果：应该有 4 行记录

-- 4. 验证旧数据
SELECT 
    COUNT(*) as total_count,
    COUNT(unit_price) as with_unit_price,
    COUNT(CASE WHEN calculation_mode = 'manual' THEN 1 END) as manual_mode,
    COUNT(CASE WHEN calculation_mode = 'auto' THEN 1 END) as auto_mode
FROM logistics_records;

-- 预期结果：
-- - total_count: 所有运单数量
-- - with_unit_price: 0（旧数据都没有单价）
-- - manual_mode: 所有旧数据（与 total_count 相同）
-- - auto_mode: 0
```

**检查点**：
- [ ] 所有字段已添加
- [ ] 触发器已创建
- [ ] 函数已创建
- [ ] 旧数据已设置为 manual 模式
- [ ] 旧数据的 current_cost 和 payable_cost 未改变

### 第三步：前端部署

```bash
# 如果是本地开发环境
# 刷新浏览器页面即可（Ctrl+R 或 F5）

# 如果是生产环境
# 重新构建和部署前端应用
npm run build
# 部署到服务器
```

**检查点**：
- [ ] 页面正常加载
- [ ] 运单表单正常显示
- [ ] 单价输入框已显示

---

## ✅ 功能测试

### 测试1：新增运单（自动模式）

1. 点击"新增运单"
2. 选择项目：**测试项目**
3. 输入单价：**350**
4. 输入装货重量：**20**
5. 输入卸货重量：**19.8**
6. 输入额外费用：**100**

**预期结果**：
- [ ] 显示"自动计算模式"蓝色标签
- [ ] 有效数量显示：**19.800**
- [ ] 运费自动计算：**6930.00**（只读，灰色）
- [ ] 司机应收显示：**¥7,030.00**
- [ ] 点击保存成功

### 测试2：新增运单（手动模式）

1. 点击"新增运单"
2. 选择项目：**测试项目**
3. **不输入单价**（留空）
4. 输入运费：**7000**
5. 输入额外费用：**100**

**预期结果**：
- [ ] 不显示"自动计算模式"标签
- [ ] 不显示有效数量卡片
- [ ] 运费输入框可编辑（正常样式）
- [ ] 司机应收显示：**¥7,100.00**
- [ ] 点击保存成功

### 测试3：编辑旧运单

1. 打开一个旧运单（创建于功能上线前）
2. 检查界面

**预期结果**：
- [ ] 单价输入框为空
- [ ] 运费显示原有值（可编辑）
- [ ] 手动模式
- [ ] 修改其他字段，保存成功
- [ ] 数据未改变

### 测试4：为旧运单添加单价

1. 打开一个旧运单
2. 输入单价：**350**
3. 观察变化

**预期结果**：
- [ ] 切换到自动模式
- [ ] 显示有效数量
- [ ] 运费重新计算
- [ ] 保存后，以后再次编辑时保留单价

### 测试5：模式切换

1. 新增运单
2. 输入单价：**350** → 观察自动模式
3. 删除单价（清空） → 观察切换到手动模式
4. 重新输入单价：**360** → 观察切换回自动模式

**预期结果**：
- [ ] 模式切换流畅
- [ ] 运费正确计算
- [ ] UI 状态正确

### 测试6：不同项目配置

测试三种不同的项目配置：

#### 项目A：取较小值（min_value）
- 装货：20 吨，卸货：19.8 吨
- **预期有效数量**：19.8 吨

#### 项目B：取装货数量（loading）
- 装货：20 吨，卸货：19.8 吨
- **预期有效数量**：20 吨

#### 项目C：取卸货数量（unloading）
- 装货：20 吨，卸货：19.8 吨
- **预期有效数量**：19.8 吨

**检查点**：
- [ ] 三种配置都正确计算
- [ ] 运费计算正确

---

## 🐛 问题排查

### 问题1：保存失败

**可能原因**：
- 数据库迁移未执行完成
- 函数参数不匹配

**排查步骤**：
1. 打开浏览器控制台（F12）
2. 查看错误信息
3. 检查数据库迁移是否全部执行成功

### 问题2：运费没有自动计算

**可能原因**：
- 单价未输入或为 0
- 装卸货重量为空

**排查步骤**：
1. 检查单价是否大于 0
2. 检查装货或卸货重量是否已输入
3. 检查控制台是否有 JavaScript 错误

### 问题3：有效数量显示不正确

**可能原因**：
- 项目配置未正确读取
- 计算逻辑错误

**排查步骤**：
1. 检查项目的 effective_quantity_type 配置
2. 在控制台查看 effectiveQuantity 的计算值
3. 检查装货和卸货重量数据

### 问题4：旧数据被修改

**排查步骤**：
```sql
-- 检查旧数据是否保持 manual 模式
SELECT 
    id, 
    auto_number,
    calculation_mode,
    unit_price,
    current_cost,
    payable_cost
FROM logistics_records
WHERE created_at < '2025-11-20'  -- 功能上线前的数据
ORDER BY created_at DESC
LIMIT 10;

-- 预期结果：
-- calculation_mode 都应该是 'manual'
-- unit_price 都应该是 NULL
-- current_cost 和 payable_cost 应该保持原值
```

---

## 📊 性能监控

### 监控指标

```sql
-- 1. 检查自动模式使用率
SELECT 
    calculation_mode,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) as percentage
FROM logistics_records
GROUP BY calculation_mode;

-- 2. 检查单价分布
SELECT 
    COUNT(*) as total,
    COUNT(unit_price) as with_price,
    AVG(unit_price) as avg_price,
    MIN(unit_price) as min_price,
    MAX(unit_price) as max_price
FROM logistics_records
WHERE unit_price IS NOT NULL;

-- 3. 检查触发器执行情况
-- 在触发器中添加了 RAISE NOTICE，可以在日志中查看
```

---

## ✅ 部署完成确认

### 最终检查清单

- [ ] 数据库迁移全部执行成功
- [ ] 所有字段已添加
- [ ] 触发器已创建
- [ ] RPC 函数已更新
- [ ] 前端页面正常加载
- [ ] 新增运单（自动模式）测试通过
- [ ] 新增运单（手动模式）测试通过
- [ ] 编辑旧运单测试通过
- [ ] 模式切换测试通过
- [ ] 不同项目配置测试通过
- [ ] 旧数据未被修改
- [ ] 合作方成本计算正常

### 签字确认

- [ ] 开发完成签字：__________ 日期：__________
- [ ] 测试通过签字：__________ 日期：__________
- [ ] 上线批准签字：__________ 日期：__________

---

## 🎉 部署完成

恭喜！单价功能已成功部署。

**功能特性**：
- ✅ 智能模式切换（有单价→自动，无单价→手动）
- ✅ 项目配置驱动的有效数量计算
- ✅ 实时计算预览
- ✅ 完全向后兼容
- ✅ 用户友好的界面

**用户价值**：
- 减少手动计算错误
- 提高录入效率
- 保留灵活性

---

**部署日期**：2025-11-20  
**版本号**：v2.0

