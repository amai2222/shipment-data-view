# 多平台名称支持方案

## 📋 需求分析

### 1. **业务场景**
- **平台别名**: 同一个平台可能有多个名称（如"货拉拉"、"货拉拉货运"、"Lalamove"）
- **平台合并**: 不同平台可能合并或更名
- **多品牌运营**: 一个公司运营多个品牌
- **国际化**: 同一平台在不同地区有不同名称

### 2. **当前限制**
- 现有设计只支持单一平台名称
- 无法处理平台名称变化
- 查询时只能按固定名称匹配

## 🎯 解决方案

### 方案一：平台配置表 + 别名支持（推荐）

#### 1. **数据库设计**

```sql
-- 创建平台配置表
CREATE TABLE public.external_platforms (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  platform_code TEXT NOT NULL UNIQUE, -- 平台代码（唯一标识）
  primary_name TEXT NOT NULL, -- 主要名称
  aliases TEXT[] DEFAULT '{}', -- 别名数组
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 修改外部运单号JSON结构
-- 原来: {"platform": "货拉拉", "tracking_number": "HLL001"}
-- 现在: {"platform_code": "HLL", "platform_name": "货拉拉", "tracking_number": "HLL001"}
```

#### 2. **JSON数据结构优化**

```json
[
  {
    "platform_code": "HLL",
    "platform_name": "货拉拉",
    "tracking_number": "HLL20250120001",
    "status": "completed",
    "created_at": "2025-01-20T10:00:00Z",
    "remarks": "主运单"
  },
  {
    "platform_code": "MB",
    "platform_name": "满帮",
    "tracking_number": "MB20250120002",
    "status": "in_transit",
    "created_at": "2025-01-20T11:00:00Z",
    "remarks": "分单"
  }
]
```

### 方案二：完全动态平台名称

#### 1. **简化设计**
- 不预设平台列表
- 用户自由输入平台名称
- 支持平台名称的模糊匹配和自动补全

#### 2. **实现方式**
```typescript
// 前端组件支持自由输入
<Input
  value={tracking.platform}
  onChange={(e) => updateTracking(index, 'platform', e.target.value)}
  placeholder="输入平台名称"
  list="platform-suggestions" // 支持自动补全
/>
```

### 方案三：混合方案（最佳实践）

#### 1. **预设常用平台 + 自定义支持**
- 预设主流平台配置
- 支持用户添加自定义平台
- 智能匹配和提示

## 🗄️ 推荐实施方案

### 1. **数据库结构**

```sql
-- 平台配置表
CREATE TABLE public.external_platforms (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  platform_code TEXT NOT NULL UNIQUE,
  primary_name TEXT NOT NULL,
  aliases TEXT[] DEFAULT '{}',
  description TEXT,
  website_url TEXT,
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 用户自定义平台表
CREATE TABLE public.user_custom_platforms (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  platform_name TEXT NOT NULL,
  platform_code TEXT,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);
```

### 2. **预设平台数据**

```sql
INSERT INTO public.external_platforms (platform_code, primary_name, aliases, description) VALUES
  ('HLL', '货拉拉', ARRAY['货拉拉货运', 'Lalamove', '货拉拉物流'], '货拉拉货运平台'),
  ('MB', '满帮', ARRAY['满帮集团', '满帮物流', 'Manbang'], '满帮物流平台'),
  ('YMM', '运满满', ARRAY['运满满物流', 'Yunmanman'], '运满满物流平台'),
  ('DDHY', '滴滴货运', ARRAY['滴滴物流', 'Didi Freight'], '滴滴货运平台'),
  ('SF', '顺丰', ARRAY['顺丰速运', 'SF Express'], '顺丰速运平台'),
  ('YTO', '圆通', ARRAY['圆通速递', 'YTO Express'], '圆通速递平台'),
  ('ZTO', '中通', ARRAY['中通快递', 'ZTO Express'], '中通快递平台'),
  ('STO', '申通', ARRAY['申通快递', 'STO Express'], '申通快递平台');
```

### 3. **查询函数优化**

```sql
-- 根据平台名称（支持别名）查询
CREATE OR REPLACE FUNCTION public.get_logistics_records_by_platform_name(
  p_platform_name TEXT
)
RETURNS TABLE (
  id UUID,
  auto_number TEXT,
  project_name TEXT,
  external_tracking_numbers JSONB
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    lr.id,
    lr.auto_number,
    lr.project_name,
    lr.external_tracking_numbers
  FROM public.logistics_records lr
  WHERE lr.external_tracking_numbers @> jsonb_build_array(
    jsonb_build_object('platform_name', p_platform_name)
  )
  OR lr.external_tracking_numbers @> jsonb_build_array(
    jsonb_build_object('platform_code', (
      SELECT platform_code 
      FROM public.external_platforms 
      WHERE primary_name = p_platform_name 
      OR p_platform_name = ANY(aliases)
      LIMIT 1
    ))
  );
END;
$$;
```

## 🎨 前端组件优化

### 1. **智能平台选择组件**

```tsx
// 平台选择组件
interface PlatformOption {
  code: string;
  name: string;
  aliases: string[];
  isCustom?: boolean;
}

const PlatformSelector = ({ value, onChange, allowCustom = true }) => {
  const [platforms, setPlatforms] = useState<PlatformOption[]>([]);
  const [customPlatforms, setCustomPlatforms] = useState<PlatformOption[]>([]);
  const [searchTerm, setSearchTerm] = useState('');

  // 获取平台列表
  useEffect(() => {
    const fetchPlatforms = async () => {
      const { data } = await supabase
        .from('external_platforms')
        .select('platform_code, primary_name, aliases')
        .eq('is_active', true)
        .order('sort_order');
      
      setPlatforms(data || []);
    };
    fetchPlatforms();
  }, []);

  // 搜索过滤
  const filteredPlatforms = useMemo(() => {
    const allPlatforms = [...platforms, ...customPlatforms];
    if (!searchTerm) return allPlatforms;
    
    return allPlatforms.filter(platform => 
      platform.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      platform.aliases.some(alias => 
        alias.toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [platforms, customPlatforms, searchTerm]);

  return (
    <div className="space-y-2">
      <Label>平台名称</Label>
      <div className="relative">
        <Input
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          placeholder="搜索或输入平台名称"
          list="platform-options"
        />
        <datalist id="platform-options">
          {filteredPlatforms.map(platform => (
            <option key={platform.code} value={platform.name}>
              {platform.name} ({platform.code})
            </option>
          ))}
        </datalist>
      </div>
      
      {/* 平台选择列表 */}
      <div className="max-h-40 overflow-y-auto border rounded-md">
        {filteredPlatforms.map(platform => (
          <div
            key={platform.code}
            className="p-2 hover:bg-gray-100 cursor-pointer"
            onClick={() => {
              onChange(platform.name);
              setSearchTerm(platform.name);
            }}
          >
            <div className="font-medium">{platform.name}</div>
            {platform.aliases.length > 0 && (
              <div className="text-sm text-gray-500">
                别名: {platform.aliases.join(', ')}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
};
```

### 2. **平台管理界面**

```tsx
// 平台管理组件
const PlatformManagement = () => {
  const [platforms, setPlatforms] = useState<PlatformOption[]>([]);
  const [showAddForm, setShowAddForm] = useState(false);

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold">平台管理</h2>
        <Button onClick={() => setShowAddForm(true)}>
          <Plus className="mr-2 h-4 w-4" />
          添加平台
        </Button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {platforms.map(platform => (
          <Card key={platform.code}>
            <CardHeader>
              <CardTitle className="flex justify-between items-center">
                <span>{platform.name}</span>
                <Badge variant="outline">{platform.code}</Badge>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-2">
                <div>
                  <Label className="text-sm font-medium">别名:</Label>
                  <div className="text-sm text-muted-foreground">
                    {platform.aliases.length > 0 
                      ? platform.aliases.join(', ')
                      : '无'
                    }
                  </div>
                </div>
                <div className="flex gap-2">
                  <Button size="sm" variant="outline">编辑</Button>
                  <Button size="sm" variant="outline">删除</Button>
                </div>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
};
```

## 🔧 实施步骤

### 1. **数据库更新**

```sql
-- 1. 创建平台配置表
CREATE TABLE public.external_platforms (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  platform_code TEXT NOT NULL UNIQUE,
  primary_name TEXT NOT NULL,
  aliases TEXT[] DEFAULT '{}',
  description TEXT,
  website_url TEXT,
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 2. 创建用户自定义平台表
CREATE TABLE public.user_custom_platforms (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  platform_name TEXT NOT NULL,
  platform_code TEXT,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
);

-- 3. 插入预设平台数据
INSERT INTO public.external_platforms (platform_code, primary_name, aliases, description) VALUES
  ('HLL', '货拉拉', ARRAY['货拉拉货运', 'Lalamove', '货拉拉物流'], '货拉拉货运平台'),
  ('MB', '满帮', ARRAY['满帮集团', '满帮物流', 'Manbang'], '满帮物流平台'),
  ('YMM', '运满满', ARRAY['运满满物流', 'Yunmanman'], '运满满物流平台'),
  ('DDHY', '滴滴货运', ARRAY['滴滴物流', 'Didi Freight'], '滴滴货运平台');

-- 4. 创建索引
CREATE INDEX idx_external_platforms_code ON public.external_platforms(platform_code);
CREATE INDEX idx_external_platforms_name ON public.external_platforms(primary_name);
CREATE INDEX idx_external_platforms_aliases ON public.external_platforms USING GIN (aliases);
```

### 2. **前端组件更新**

- 更新 `ExternalTrackingNumbersInput` 组件
- 添加平台管理界面
- 实现智能搜索和自动补全

### 3. **数据迁移**

```sql
-- 迁移现有数据到新格式
UPDATE public.logistics_records 
SET external_tracking_numbers = (
  SELECT jsonb_agg(
    jsonb_build_object(
      'platform_code', 
      CASE 
        WHEN elem->>'platform' = '货拉拉' THEN 'HLL'
        WHEN elem->>'platform' = '满帮' THEN 'MB'
        WHEN elem->>'platform' = '运满满' THEN 'YMM'
        WHEN elem->>'platform' = '滴滴货运' THEN 'DDHY'
        ELSE 'OTHER'
      END,
      'platform_name', elem->>'platform',
      'tracking_number', elem->>'tracking_number',
      'status', elem->>'status',
      'created_at', elem->>'created_at',
      'remarks', elem->>'remarks'
    )
  )
  FROM jsonb_array_elements(external_tracking_numbers) AS elem
)
WHERE external_tracking_numbers IS NOT NULL 
AND jsonb_array_length(external_tracking_numbers) > 0;
```

## 📊 优势对比

| 特性 | 当前方案 | 多平台名称方案 |
|------|----------|----------------|
| 平台名称灵活性 | 固定列表 | 支持别名和自定义 |
| 查询准确性 | 精确匹配 | 智能匹配 |
| 扩展性 | 有限 | 高度可扩展 |
| 用户体验 | 基础 | 智能化 |
| 数据一致性 | 一般 | 优秀 |

## 🎯 推荐选择

**建议采用方案三（混合方案）**：
1. 预设主流平台，提供常用选项
2. 支持别名，处理平台名称变化
3. 允许自定义，满足特殊需求
4. 智能搜索，提升用户体验

这样既保证了常用场景的便利性，又提供了足够的灵活性来处理各种复杂情况。
