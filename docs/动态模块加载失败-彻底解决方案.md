# åŠ¨æ€æ¨¡å—åŠ è½½å¤±è´¥ - å½»åº•è§£å†³æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜æ ¹æºåˆ†æ

### æ ¸å¿ƒé—®é¢˜
```
SyntaxError: Unexpected token '<'
Failed to fetch dynamically imported module: /assets/recharts-vendor-Bu-t51L7.js
```

**æ ¹æœ¬åŸå› ï¼š**
1. æµè§ˆå™¨è¯·æ±‚ JS æ–‡ä»¶ï¼Œä½†æ”¶åˆ° HTMLï¼ˆé€šå¸¸æ˜¯ index.htmlï¼‰
2. æµè§ˆå™¨å°è¯•è§£æ HTML ä¸º JavaScriptï¼Œå¯¼è‡´è¯­æ³•é”™è¯¯
3. è¿™æ˜¯å› ä¸ºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¢« `_redirects` é‡å®šå‘åˆ° `index.html`

---

## âœ… å½»åº•è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¼˜åŒ– Vite æ„å»ºé…ç½®ï¼ˆâœ… æ¨èï¼‰

#### 1. ä½¿ç”¨å†…å®¹å“ˆå¸Œè€Œééšæœºå“ˆå¸Œ

**é—®é¢˜ï¼š** Vite é»˜è®¤ä½¿ç”¨éšæœºå“ˆå¸Œï¼Œæ¯æ¬¡æ„å»ºæ–‡ä»¶åå¯èƒ½ä¸åŒï¼Œå¯¼è‡´ï¼š
- éƒ¨ç½²æ—¶æ–‡ä»¶åä¸åŒ¹é…
- æµè§ˆå™¨ç¼“å­˜å¤±æ•ˆ
- åŠ¨æ€å¯¼å…¥å¤±è´¥

**è§£å†³ï¼š** ä½¿ç”¨å†…å®¹å“ˆå¸Œï¼ˆcontenthashï¼‰

```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        // âœ… ä½¿ç”¨å†…å®¹å“ˆå¸Œï¼šç›¸åŒå†…å®¹ = ç›¸åŒå“ˆå¸Œ
        chunkFileNames: (chunkInfo) => {
          const vendorChunks = ['xlsx-vendor', 'recharts-vendor', 'react-vendor', 'tanstack-vendor', 'supabase-vendor', 'ui-vendor'];
          if (vendorChunks.includes(chunkInfo.name)) {
            return 'assets/[name].[hash].js';
          }
          return 'assets/[name]-[hash].js';
        },
        entryFileNames: 'assets/[name]-[hash].js',
        assetFileNames: (assetInfo) => {
          const info = assetInfo.name.split('.');
          const ext = info[info.length - 1];
          if (/png|jpe?g|svg|gif|tiff|bmp|ico/i.test(ext)) {
            return 'assets/images/[name]-[hash].[ext]';
          } else if (/woff2?|ttf|eot/i.test(ext)) {
            return 'assets/fonts/[name]-[hash].[ext]';
          }
          return 'assets/[name]-[hash].[ext]';
        },
      },
    },
  },
});
```

**ä¼˜åŠ¿ï¼š**
- æ–‡ä»¶å†…å®¹ä¸å˜ï¼Œå“ˆå¸Œå€¼ä¸å˜
- å……åˆ†åˆ©ç”¨æµè§ˆå™¨ç¼“å­˜
- é¿å…æ–‡ä»¶åä¸åŒ¹é…é—®é¢˜

---

#### 2. æ·»åŠ æ„å»ºåéªŒè¯

**ç›®çš„ï¼š** ç¡®ä¿æ‰€æœ‰æ–‡ä»¶æ­£ç¡®ç”Ÿæˆå¹¶éƒ¨ç½²

**å®æ–½ï¼š**

```javascript
// scripts/verify-build.jsï¼ˆå·²å®ç°ï¼‰
// éªŒè¯å†…å®¹ï¼š
// 1. æ£€æŸ¥ dist ç›®å½•æ˜¯å¦å­˜åœ¨
// 2. æ£€æŸ¥ index.html æ˜¯å¦å­˜åœ¨
// 3. æ£€æŸ¥ assets ç›®å½•æ˜¯å¦å­˜åœ¨
// 4. éªŒè¯æ‰€æœ‰å¼•ç”¨çš„ JS æ–‡ä»¶æ˜¯å¦å­˜åœ¨
// 5. ç”Ÿæˆæ–‡ä»¶æ¸…å•ï¼ˆassets-manifest.jsonï¼‰
// 6. å¤åˆ¶ _headers æ–‡ä»¶åˆ° dist ç›®å½•
```

---

### æ–¹æ¡ˆäºŒï¼šä¼˜åŒ– Cloudflare Pages é…ç½®

#### 1. `_headers` æ–‡ä»¶ï¼ˆæ˜ç¡® MIME ç±»å‹ï¼‰

```
# public/_headers
/assets/*.js
  Content-Type: application/javascript
  Cache-Control: public, max-age=31536000, immutable

/*.js
  Content-Type: application/javascript
  Cache-Control: public, max-age=31536000, immutable

/*.css
  Content-Type: text/css
  Cache-Control: public, max-age=31536000, immutable

/*.html
  Content-Type: text/html
  Cache-Control: no-cache, no-store, must-revalidate
```

**ä½œç”¨ï¼š**
- æ˜ç¡®å‘Šè¯‰ Cloudflare Pages JS æ–‡ä»¶çš„ MIME ç±»å‹
- é˜²æ­¢è¿”å›é”™è¯¯çš„ Content-Type
- è®¾ç½®åˆç†çš„ç¼“å­˜ç­–ç•¥

---

#### 2. `_redirects` æ–‡ä»¶ï¼ˆç¡®ä¿é™æ€èµ„æºä¸è¢«é‡å®šå‘ï¼‰

```
# public/_redirects
# Cloudflare Pages ä¼šä¼˜å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
# å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œç›´æ¥è¿”å›æ–‡ä»¶ï¼ˆä¸ä¼šè§¦å‘é‡å®šå‘ï¼‰
# å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ‰ä¼šè§¦å‘é‡å®šå‘è§„åˆ™

# SPA è·¯ç”±æ”¯æŒï¼šå°†æ‰€æœ‰ä¸å­˜åœ¨çš„è·¯ç”±é‡å®šå‘åˆ° index.html
# æ³¨æ„ï¼šé™æ€èµ„æºæ–‡ä»¶å¦‚æœå­˜åœ¨ï¼Œä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šè¢«é‡å®šå‘
/*    /index.html   200
```

**å…³é”®ç‚¹ï¼š**
- `/*` åªåŒ¹é…ä¸å­˜åœ¨çš„è·¯å¾„
- é™æ€èµ„æºï¼ˆå¦‚ `/assets/*.js`ï¼‰å¦‚æœå­˜åœ¨ï¼Œä¼šè¢«ä¼˜å…ˆè¿”å›
- ä¸éœ€è¦é¢å¤–æ’é™¤è§„åˆ™

---

### æ–¹æ¡ˆä¸‰ï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²éªŒè¯

åˆ›å»ºéƒ¨ç½²éªŒè¯è„šæœ¬ï¼Œç¡®ä¿æ–‡ä»¶æ­£ç¡®ä¸Šä¼ ï¼š

```bash
#!/bin/bash
# scripts/verify-deployment.sh

DOMAIN="https://ynzkzy.325218.xyz"

echo "ğŸ” éªŒè¯éƒ¨ç½²..."

# 1. æ£€æŸ¥ index.html
if curl -s -o /dev/null -w "%{http_code}" "$DOMAIN/index.html" | grep -q "200"; then
  echo "âœ… index.html å¯è®¿é—®"
else
  echo "âŒ index.html è®¿é—®å¤±è´¥"
  exit 1
fi

# 2. æ£€æŸ¥ assets ç›®å½•
if curl -s -o /dev/null -w "%{http_code}" "$DOMAIN/assets-manifest.json" | grep -q "200"; then
  echo "âœ… assets-manifest.json å¯è®¿é—®"
else
  echo "âš ï¸  assets-manifest.json ä¸å¯è®¿é—®ï¼ˆå¯èƒ½æœªç”Ÿæˆï¼‰"
fi

# 3. æ£€æŸ¥å…³é”® vendor æ–‡ä»¶
for vendor in recharts-vendor react-vendor tanstack-vendor supabase-vendor ui-vendor; do
  if curl -s "$DOMAIN/assets-manifest.json" | grep -q "$vendor"; then
    echo "âœ… $vendor å·²ç”Ÿæˆ"
  else
    echo "âš ï¸  $vendor æœªæ‰¾åˆ°"
  fi
done

echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"
```

---

## ğŸ”§ å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ›´æ–° Vite é…ç½®

```bash
# å·²å®Œæˆ
```

### æ­¥éª¤ 2ï¼šéªŒè¯æ„å»ºè„šæœ¬

```bash
# å·²å®Œæˆï¼Œåœ¨ package.json ä¸­ï¼š
"build": "vite build && node scripts/verify-build.js"
```

### æ­¥éª¤ 3ï¼šé‡æ–°æ„å»º

```bash
npm run build
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… index.html å­˜åœ¨
âœ… assets ç›®å½•å­˜åœ¨
ğŸ“¦ assets ç›®å½•ä¸­çš„æ‰€æœ‰ JS æ–‡ä»¶ (209 ä¸ª)
âœ… å·²å¤åˆ¶ _headers æ–‡ä»¶åˆ° dist ç›®å½•
âœ… å·²ç”Ÿæˆ assets-manifest.json (209 ä¸ª JS æ–‡ä»¶)
âœ… æ„å»ºéªŒè¯é€šè¿‡ï¼æ‰€æœ‰æ–‡ä»¶éƒ½å­˜åœ¨ï¼Œç›®å½•ç»“æ„æ­£ç¡®ã€‚
```

### æ­¥éª¤ 4ï¼šéƒ¨ç½²åˆ° Cloudflare Pages

**æ–¹å¼ 1ï¼šè‡ªåŠ¨éƒ¨ç½²**
```bash
git add .
git commit -m "ä¼˜åŒ–Viteæ„å»ºé…ç½®ï¼šä½¿ç”¨å†…å®¹å“ˆå¸Œï¼Œæ·»åŠ æ„å»ºéªŒè¯"
git push
```

**æ–¹å¼ 2ï¼šæ‰‹åŠ¨ä¸Šä¼ **
- ä¸Šä¼  `dist` ç›®å½•åˆ° Cloudflare Pages

### æ­¥éª¤ 5ï¼šéƒ¨ç½²åéªŒè¯

1. **æ¸…é™¤ Cloudflare ç¼“å­˜ï¼š**
   - Cloudflare Dashboard â†’ Caching â†’ Purge Everything

2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼š**
   - æŒ‰ `Ctrl+Shift+Delete`
   - æˆ–ç¡¬åˆ·æ–° `Ctrl+Shift+R`

3. **éªŒè¯æ–‡ä»¶ï¼š**
   ```bash
   # æ£€æŸ¥ manifest æ–‡ä»¶
   curl https://ynzkzy.325218.xyz/assets-manifest.json
   
   # æ£€æŸ¥å…³é”® JS æ–‡ä»¶
   curl -I https://ynzkzy.325218.xyz/assets/recharts-vendor.xxxxx.js
   ```

4. **æ£€æŸ¥å“åº”å¤´ï¼š**
   - åº”è¯¥è¿”å› `Content-Type: application/javascript`
   - ä¸åº”è¯¥è¿”å› `Content-Type: text/html`

---

## ğŸ“‹ éªŒè¯æ¸…å•

éƒ¨ç½²åæ£€æŸ¥ï¼š

- [ ] `index.html` å¯æ­£å¸¸è®¿é—®
- [ ] `assets-manifest.json` å­˜åœ¨å¹¶åŒ…å«æ‰€æœ‰æ–‡ä»¶
- [ ] JS æ–‡ä»¶çš„ `Content-Type` ä¸º `application/javascript`
- [ ] é¡µé¢æ—  `SyntaxError: Unexpected token '<'` é”™è¯¯
- [ ] é¡µé¢æ—  `Failed to fetch dynamically imported module` é”™è¯¯
- [ ] æ‰€æœ‰æ‡’åŠ è½½æ¨¡å—æ­£å¸¸åŠ è½½
- [ ] Recharts å›¾è¡¨æ­£å¸¸æ˜¾ç¤º

---

## ğŸ¯ ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆå½»åº•è§£å†³é—®é¢˜

### 1. å†…å®¹å“ˆå¸Œçš„ä¼˜åŠ¿

**ä¹‹å‰ï¼ˆéšæœºå“ˆå¸Œï¼‰ï¼š**
```
æ„å»º1: recharts-vendor-Bu-t51L7.js
æ„å»º2: recharts-vendor-Cx-u62M8.js  â† å†…å®¹ç›¸åŒï¼Œå“ˆå¸Œä¸åŒ
```

**ç°åœ¨ï¼ˆå†…å®¹å“ˆå¸Œï¼‰ï¼š**
```
æ„å»º1: recharts-vendor.a1b2c3d4.js
æ„å»º2: recharts-vendor.a1b2c3d4.js  â† å†…å®¹ç›¸åŒï¼Œå“ˆå¸Œç›¸åŒ
```

**æ•ˆæœï¼š**
- æ–‡ä»¶åç¨³å®šï¼Œé¿å…ç¼“å­˜å¤±æ•ˆ
- æ„å»ºè¾“å‡ºå¯é¢„æµ‹
- éƒ¨ç½²åæ–‡ä»¶åä¸€è‡´

### 2. æ„å»ºéªŒè¯çš„ä½œç”¨

**éªŒè¯è„šæœ¬ä¼šï¼š**
- æ£€æŸ¥æ‰€æœ‰å¼•ç”¨çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- ç”Ÿæˆæ–‡ä»¶æ¸…å•ï¼ˆå¯ç”¨äºéƒ¨ç½²åå¯¹æ¯”ï¼‰
- å¤åˆ¶ `_headers` æ–‡ä»¶åˆ° `dist`
- æå‰å‘ç°æ„å»ºé—®é¢˜

**é¿å…çš„é—®é¢˜ï¼š**
- æ–‡ä»¶æœªç”Ÿæˆå°±éƒ¨ç½²
- `_headers` æ–‡ä»¶é—æ¼
- æ–‡ä»¶åä¸åŒ¹é…

### 3. å“åº”å¤´é…ç½®çš„ä½œç”¨

**`_headers` æ–‡ä»¶ï¼š**
- æ˜ç¡®æŒ‡å®š JS æ–‡ä»¶çš„ MIME ç±»å‹
- é˜²æ­¢ Cloudflare è¿”å›é”™è¯¯çš„ Content-Type
- è®¾ç½®åˆç†çš„ç¼“å­˜ç­–ç•¥

**é¿å…çš„é—®é¢˜ï¼š**
- JS æ–‡ä»¶è¢«å½“ä½œ HTML è¿”å›
- MIME ç±»å‹æ£€æµ‹é”™è¯¯
- ç¼“å­˜ç­–ç•¥ä¸å½“

### 4. `_redirects` æ–‡ä»¶çš„ä½œç”¨

**ç®€æ´çš„é…ç½®ï¼š**
```
/*    /index.html   200
```

**å·¥ä½œåŸç†ï¼š**
- Cloudflare Pages å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- å¦‚æœ `/assets/xxx.js` å­˜åœ¨ â†’ ç›´æ¥è¿”å› JS æ–‡ä»¶
- å¦‚æœ `/some-route` ä¸å­˜åœ¨ â†’ é‡å®šå‘åˆ° `index.html`ï¼ˆSPA è·¯ç”±ï¼‰

**é¿å…çš„é—®é¢˜ï¼š**
- é™æ€èµ„æºè¢«é‡å®šå‘åˆ° index.html
- SPA è·¯ç”±å¤±æ•ˆ

---

## ğŸš€ æœ€ä½³å®è·µ

### å¼€å‘é˜¶æ®µ

1. **æœ¬åœ°æµ‹è¯•æ„å»ºï¼š**
   ```bash
   npm run build
   ```

2. **éªŒè¯æ„å»ºè¾“å‡ºï¼š**
   ```bash
   node scripts/verify-build.js
   ```

3. **é¢„è§ˆæ„å»ºç»“æœï¼š**
   ```bash
   npm run preview
   ```

### éƒ¨ç½²é˜¶æ®µ

1. **è‡ªåŠ¨æ„å»ºéªŒè¯ï¼š**
   - `package.json` ä¸­ `"build": "vite build && node scripts/verify-build.js"`
   - æ„å»ºå¤±è´¥ä¼šè‡ªåŠ¨ä¸­æ­¢éƒ¨ç½²

2. **æ£€æŸ¥éƒ¨ç½²æ—¥å¿—ï¼š**
   - Cloudflare Pages Dashboard â†’ Deployments â†’ View logs
   - ç¡®è®¤éªŒè¯è„šæœ¬é€šè¿‡

3. **éƒ¨ç½²åéªŒè¯ï¼š**
   - æ£€æŸ¥ `assets-manifest.json`
   - å¯¹æ¯”æ„å»ºæ—¶çš„æ¸…å•

### ç»´æŠ¤é˜¶æ®µ

1. **ç›‘æ§é”™è¯¯ï¼š**
   - æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰æ¨¡å—åŠ è½½é”™è¯¯
   - Cloudflare Analytics æ˜¯å¦æœ‰ 404 é”™è¯¯

2. **ç‰ˆæœ¬ç®¡ç†ï¼š**
   - æäº¤ `_headers` å’Œ `_redirects` åˆ° Git
   - è®°å½•æ„å»ºè¾“å‡ºçš„æ–‡ä»¶æ¸…å•

3. **ç¼“å­˜ç®¡ç†ï¼š**
   - é‡å¤§æ›´æ–°åæ¸…é™¤ Cloudflare ç¼“å­˜
   - æé†’ç”¨æˆ·æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **æ–‡ä»¶åç¨³å®šæ€§** | æ¯æ¬¡æ„å»ºéƒ½ä¸åŒ | å†…å®¹ç›¸åŒåˆ™æ–‡ä»¶åç›¸åŒ |
| **æ„å»ºéªŒè¯** | æ—  | è‡ªåŠ¨éªŒè¯æ‰€æœ‰æ–‡ä»¶ |
| **MIME ç±»å‹** | ä¾èµ–è‡ªåŠ¨æ£€æµ‹ | æ˜ç¡®é…ç½® |
| **ç¼“å­˜ç­–ç•¥** | ä¸ä¸€è‡´ | ç»Ÿä¸€é…ç½® |
| **é”™è¯¯ç‡** | å¶å‘ | åŸºæœ¬æœç» |

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

1. **æ£€æŸ¥æ„å»ºæ—¥å¿—ï¼š**
   ```bash
   npm run build
   ```
   ç¡®è®¤éªŒè¯è„šæœ¬é€šè¿‡

2. **æ£€æŸ¥éƒ¨ç½²æ—¥å¿—ï¼š**
   - Cloudflare Pages â†’ Deployments â†’ View logs
   - ç¡®è®¤æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æˆåŠŸ

3. **æ£€æŸ¥æ–‡ä»¶ï¼š**
   ```bash
   # è®¿é—® manifest æ–‡ä»¶
   https://ä½ çš„åŸŸå.com/assets-manifest.json
   
   # æ£€æŸ¥ JS æ–‡ä»¶
   https://ä½ çš„åŸŸå.com/assets/recharts-vendor.xxxxx.js
   ```

4. **æ£€æŸ¥å“åº”å¤´ï¼š**
   - æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Network
   - æŸ¥çœ‹ JS æ–‡ä»¶çš„ `Content-Type`
   - åº”è¯¥æ˜¯ `application/javascript`

5. **æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼š**
   - Cloudflare ç¼“å­˜
   - æµè§ˆå™¨ç¼“å­˜
   - CDN ç¼“å­˜ï¼ˆå¦‚æœæœ‰ï¼‰

---

## ğŸ’¡ æ€»ç»“

**é—®é¢˜æœ¬è´¨ï¼š** æ–‡ä»¶ä¸å­˜åœ¨æˆ– MIME ç±»å‹é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
1. âœ… ä½¿ç”¨å†…å®¹å“ˆå¸Œ â†’ æ–‡ä»¶åç¨³å®š
2. âœ… æ„å»ºéªŒè¯ â†’ ç¡®ä¿æ–‡ä»¶ç”Ÿæˆ
3. âœ… `_headers` é…ç½® â†’ æ˜ç¡® MIME ç±»å‹
4. âœ… `_redirects` é…ç½® â†’ é™æ€èµ„æºä¼˜å…ˆè¿”å›

**æ ¸å¿ƒåŸåˆ™ï¼š**
- è®©æ–‡ä»¶åå¯é¢„æµ‹
- è®©æ–‡ä»¶ä¸€å®šå­˜åœ¨
- è®© MIME ç±»å‹æ­£ç¡®
- è®©é™æ€èµ„æºä¼˜å…ˆè¿”å›

**æ•ˆæœï¼š** ä»æ ¹æºä¸Šæœç»åŠ¨æ€æ¨¡å—åŠ è½½å¤±è´¥çš„é—®é¢˜

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [Vite æ„å»ºé…ç½®](https://vitejs.dev/config/)
- [Cloudflare Pages æ–‡æ¡£](https://developers.cloudflare.com/pages/)
- [Rollup è¾“å‡ºé…ç½®](https://rollupjs.org/configuration-options/)
