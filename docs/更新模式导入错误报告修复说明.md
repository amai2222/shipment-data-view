# 更新模式导入错误报告修复说明

## 问题描述

在数据维护运单维护的更新模式导入中，当所有55条记录都失败时，系统只显示"成功:0,失败:55"，但没有提供具体的失败原因，导致用户无法知道为什么导入失败。

## 问题原因

1. **数据库函数缺少错误详情**: `batch_import_logistics_records_with_update` 函数在异常处理时只记录了错误到日志，但没有返回详细的错误信息给前端。

2. **前端缺少错误详情显示**: `useExcelImportWithUpdate` hook 没有处理数据库返回的错误详情。

## 修复内容

### 1. 数据库函数修复

**文件**: `scripts/create-update-import-function.sql`

**修复内容**:
- 添加 `v_error_details` 变量存储错误详情
- 添加 `v_record_index` 变量记录处理的行号
- 在异常处理中收集详细的错误信息
- 在返回结果中包含 `error_details` 字段

**关键代码**:
```sql
DECLARE
    v_error_details jsonb := '[]'::jsonb;
    v_record_index integer := 0;
    -- ... 其他变量

-- 在异常处理中
EXCEPTION WHEN OTHERS THEN
    v_error_count := v_error_count + 1;
    v_error_details := v_error_details || jsonb_build_object(
        'record_index', v_record_index,
        'error_message', SQLERRM,
        'record_data', record_data
    );
    RAISE NOTICE '处理记录失败: %', SQLERRM;
END;

-- 返回结果包含错误详情
RETURN jsonb_build_object(
    'success_count', v_success_count,
    'error_count', v_error_count,
    'inserted_count', array_length(v_inserted_ids, 1),
    'updated_count', v_update_count,
    'inserted_ids', v_inserted_ids,
    'updated_ids', v_updated_ids,
    'error_details', v_error_details
);
```

### 2. 前端Hook修复

**文件**: `src/pages/BusinessEntry/hooks/useExcelImportWithUpdate.ts`

**修复内容**:
- 在错误处理中显示详细的错误信息
- 为每条失败记录显示具体的错误原因
- 显示失败记录的关键字段信息

**关键代码**:
```javascript
if (errorCount > 0) {
  // 显示详细错误信息
  const errorDetails = result.error_details || [];
  addLog(`详细错误信息:`);
  errorDetails.forEach((error: any, index: number) => {
    addLog(`  记录 ${error.record_index}: ${error.error_message}`);
    if (error.record_data) {
      addLog(`    项目: ${error.record_data.project_name || 'N/A'}`);
      addLog(`    司机: ${error.record_data.driver_name || 'N/A'}`);
      addLog(`    车牌: ${error.record_data.license_plate || 'N/A'}`);
    }
  });
  
  toast({
    title: `导入部分完成`,
    description: `成功导入 ${successCount} 条，失败 ${errorCount} 条。详情请查看导入日志。`,
    variant: errorCount > successCount ? "destructive" : "default",
    duration: 9000
  });
}
```

## 修复后的效果

### 1. 数据库层面
- 函数返回详细的错误信息
- 包含失败记录的行号和具体错误原因
- 包含失败记录的原始数据

### 2. 前端层面
- 导入日志中显示详细的错误信息
- 每条失败记录显示具体的错误原因
- 显示失败记录的关键字段信息

### 3. 用户体验
- 用户可以看到具体的失败原因
- 可以根据错误信息修正数据
- 提高问题排查效率

## 测试脚本

### 1. 完整测试
```sql
\i scripts/fix-update-import-error-reporting.sql
```

### 2. 简单测试
```sql
\i scripts/test-error-reporting-simple.sql
```

### 3. 诊断脚本
```sql
\i scripts/diagnose-update-import-failure.sql
```

## 常见错误原因

1. **项目不存在**: 项目名称在系统中不存在
2. **司机信息缺失**: 司机姓名或车牌号格式不正确
3. **地点信息缺失**: 装货地点或卸货地点不存在
4. **日期格式错误**: 装货日期格式不正确
5. **数据类型错误**: 重量或金额字段包含非数字字符
6. **权限问题**: 用户没有相应的操作权限

## 使用说明

1. **执行数据库修复**:
   ```sql
   \i scripts/fix-update-import-error-reporting.sql
   ```

2. **重启前端应用**:
   前端代码已更新，重启应用即可生效

3. **测试导入功能**:
   - 使用包含错误数据的Excel文件测试
   - 查看导入日志中的详细错误信息
   - 根据错误信息修正数据后重新导入

## 更新日志

- 2025-01-20: 识别问题，缺少详细错误信息
- 2025-01-20: 修复数据库函数，添加错误详情返回
- 2025-01-20: 修复前端Hook，显示详细错误信息
- 2025-01-20: 创建测试脚本和诊断工具
- 2025-01-20: 创建修复说明文档

## 结论

现在更新模式导入功能可以提供详细的错误信息，帮助用户快速定位和解决问题。所有55条记录失败的情况现在会显示具体的失败原因，大大提高了问题排查的效率。
