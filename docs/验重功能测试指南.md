# 验重功能测试指南

## 问题现象
用户反馈：导入Excel数据时没有提示重复，但系统显示"智能导入预览完成"和"重复数据检查"。

## 问题分析
从导入预览截图可以看出：
- ✅ 验重功能已启用
- ❌ 数据被识别为"错误记录"而非"重复记录"
- ⚠️ 错误原因：缺少必填字段 (8个关键字段)

## 必填字段清单
验重功能基于以下8个关键字段：

| 字段名 | 是否必填 | 说明 |
|--------|----------|------|
| 项目名称 | ✅ 必填 | 必须与系统中已有的项目名称完全一致 |
| 司机姓名 | ✅ 必填 | 如果不存在会自动创建 |
| 车牌号 | ✅ 必填 | 用于司机信息完善 |
| 装货地点 | ✅ 必填 | 如果不存在会自动创建 |
| 卸货地点 | ✅ 必填 | 如果不存在会自动创建 |
| 装货日期 | ✅ 必填 | 格式：YYYY-MM-DD |
| 装货数量 | ✅ 必填 | 数字格式，如：10.5 |
| 合作链路 | ⚠️ 可选 | 影响验重，建议填写 |

## 测试步骤

### 第一步：准备测试数据
1. 下载最新模板
2. 填写一条完整的运单记录，确保所有必填字段都有数据
3. 保存Excel文件

### 第二步：首次导入
1. 选择Excel文件进行导入
2. 应该看到"1条新记录"，没有错误记录
3. 确认导入

### 第三步：重复导入测试
1. 使用相同的Excel文件再次导入
2. 应该看到"1条重复记录"在重复记录列表中
3. 可以选择跳过或覆盖

## 常见问题

### 1. 数据被识别为错误记录
**原因**：缺少必填字段或格式不正确
**解决**：检查Excel数据，确保所有必填字段都有数据

### 2. 没有提示重复
**原因**：
- 数据格式问题（空格、特殊字符）
- 项目名称不匹配
- 合作链路名称不匹配

**解决**：
- 使用TRIM函数去除空格
- 确保项目名称与系统完全一致
- 检查合作链路名称

### 3. 验重条件过于严格
**当前逻辑**：8个字段必须完全匹配
**建议**：如果业务需要，可以调整验重字段

## 验重逻辑说明

```sql
-- 验重检查的8个关键字段
SELECT EXISTS (
    SELECT 1 FROM logistics_records lr
    WHERE
        TRIM(lr.project_name) = TRIM(输入的项目名称)           -- 1. 项目名称
        AND lr.chain_id = 合作链路ID                        -- 2. 合作链路
        AND TRIM(lr.driver_name) = TRIM(输入的司机姓名)       -- 3. 司机姓名
        AND TRIM(lr.license_plate) = TRIM(输入的车牌号)      -- 4. 车牌号
        AND TRIM(lr.loading_location) = TRIM(输入的装货地点)  -- 5. 装货地点
        AND TRIM(lr.unloading_location) = TRIM(输入的卸货地点) -- 6. 卸货地点
        AND lr.loading_date::date = 输入的装货日期           -- 7. 装货日期
        AND lr.loading_weight = 输入的装货数量               -- 8. 装货数量
);
```

## 调试建议

如果验重功能仍然不工作，请：

1. **检查数据库函数**：确保 `preview_import_with_duplicates_check` 函数已更新
2. **查看控制台日志**：检查是否有JavaScript错误
3. **验证数据格式**：确保Excel数据格式正确
4. **联系技术支持**：提供具体的Excel数据和错误信息
