# 动态菜单系统实施指南

## 📋 概述

将硬编码的菜单系统改为完全可配置的动态菜单系统，支持后台管理。

## ✅ 已完成的工作

### 1. 数据库迁移
✅ 创建了 `menu_config` 表
✅ 添加了 RLS 策略
✅ 导入了当前所有菜单配置

**文件**：`supabase/migrations/20251103_create_dynamic_menu_system.sql`

### 2. 前端 Hook
✅ 创建了 `useDynamicMenu` Hook
✅ 支持从数据库读取菜单
✅ 支持权限过滤

**文件**：`src/hooks/useDynamicMenu.ts`

### 3. 动态侧边栏组件
✅ 创建了 `AppSidebarDynamic` 组件
✅ 支持图标动态加载
✅ 支持加载状态显示

**文件**：`src/components/AppSidebarDynamic.tsx`

### 4. 菜单配置管理页面
✅ 创建了管理界面
✅ 支持CRUD操作
✅ 支持拖拽排序
✅ 支持启用/禁用

**文件**：`src/pages/Settings/MenuConfig.tsx`

---

## 🚀 部署步骤

### 步骤 1：运行数据库迁移

在 **Supabase SQL 编辑器**中运行：

```sql
-- 文件位置：supabase/migrations/20251103_create_dynamic_menu_system.sql
```

**预期结果**：
- ✅ 创建 `menu_config` 表
- ✅ 插入当前所有菜单配置
- ✅ 创建 RLS 策略

**验证**：
```sql
SELECT COUNT(*) FROM menu_config;
-- 应该显示 40+ 条记录
```

### 步骤 2：添加路由

在 `src/App.tsx` 中添加菜单配置页面路由：

```tsx
import MenuConfigPage from '@/pages/Settings/MenuConfig';

// 在路由配置中添加
<Route
  path="/settings/menu-config"
  element={
    <ProtectedRoute>
      <MenuConfigPage />
    </ProtectedRoute>
  }
/>
```

### 步骤 3：替换侧边栏组件

**选项 A：完全替换（推荐）**

在 `src/App.tsx` 或主布局文件中：

```tsx
// 旧版
import { AppSidebar } from '@/components/AppSidebar';

// 改为新版
import { AppSidebarDynamic as AppSidebar } from '@/components/AppSidebarDynamic';
```

**选项 B：逐步迁移**

保留两个版本，通过配置切换：

```tsx
import { AppSidebar } from '@/components/AppSidebar';
import { AppSidebarDynamic } from '@/components/AppSidebarDynamic';

// 使用环境变量控制
const useDynamicMenu = import.meta.env.VITE_USE_DYNAMIC_MENU === 'true';

function Layout() {
  return (
    <SidebarProvider>
      {useDynamicMenu ? <AppSidebarDynamic /> : <AppSidebar />}
      {/* ... */}
    </SidebarProvider>
  );
}
```

### 步骤 4：测试功能

1. **登录管理员账户**
2. **访问菜单配置页面**：`/settings/menu-config`
3. **测试菜单管理**：
   - 编辑菜单标题
   - 调整菜单顺序
   - 禁用/启用菜单
   - 添加新菜单
4. **刷新页面**，查看菜单变化

---

## 📊 数据库表结构

### menu_config 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| key | TEXT | 菜单唯一标识 |
| parent_key | TEXT | 父菜单key |
| title | TEXT | 显示标题 |
| url | TEXT | 路由URL |
| icon | TEXT | 图标名称 |
| order_index | INTEGER | 排序索引 |
| is_active | BOOLEAN | 是否启用 |
| is_group | BOOLEAN | 是否为分组 |
| required_permissions | TEXT[] | 所需权限 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

---

## 🎯 使用示例

### 添加新菜单项

在菜单配置页面点击"新建菜单"：

```
菜单Key: reports.export
显示标题: 导出报表
所属分组: business_group
路由URL: /reports/export
图标: FileText
排序索引: 45
所需权限: business.export, reports
```

### 禁用某个菜单

在菜单列表中找到对应菜单，关闭"状态"开关即可。

### 调整菜单顺序

使用 ↑ ↓ 按钮调整，或直接修改"排序索引"数值。

---

## 🔧 高级配置

### 支持的图标列表

系统支持以下 Lucide React 图标：

```
BarChart3, Database, FileText, Calculator, PieChart, 
Banknote, Truck, Package, MapPin, Users, Plus,
ClipboardList, Settings, Weight, Shield, History,
TreePine, CheckCircle2, CreditCard, Menu, DollarSign
```

如需添加更多图标，编辑：
- `src/components/AppSidebarDynamic.tsx` 的 `iconMap`

### 权限控制

菜单的 `required_permissions` 支持多个权限：

```tsx
// 用户只要有任一权限即可访问
required_permissions: ['dashboard.transport', 'dashboard']

// Hook 会检查：
hasMenuAccess('dashboard.transport') || hasMenuAccess('dashboard')
```

### 自定义菜单层级

当前支持2级菜单（分组 + 菜单项），如需支持3级：

1. 修改 `menu_config` 表，添加 `level` 字段
2. 修改 `useDynamicMenu.ts`，支持递归构建
3. 修改 `AppSidebarDynamic.tsx`，支持嵌套渲染

---

## 🐛 常见问题

### Q1: 菜单不显示？

**检查**：
1. 数据库中菜单的 `is_active = true`
2. 用户有对应的权限（`required_permissions`）
3. 菜单的 `parent_key` 正确指向分组

### Q2: 图标不显示？

**检查**：
1. 图标名称拼写正确（区分大小写）
2. 图标名称在 `iconMap` 中存在
3. 如果是新图标，需要先导入并添加到 `iconMap`

### Q3: 修改后不生效？

**解决**：
1. 刷新页面（Ctrl+F5 强制刷新）
2. 检查浏览器控制台是否有错误
3. 检查数据库中数据是否正确更新

### Q4: 性能问题？

**优化**：
1. `useDynamicMenu` 已使用 `useMemo` 缓存
2. 考虑添加本地存储缓存
3. 考虑添加 Service Worker 缓存

---

## 📈 未来改进方向

### 短期（可选）

- [ ] 支持菜单项拖拽排序
- [ ] 支持批量导入/导出菜单配置
- [ ] 支持菜单预览功能

### 中期（建议）

- [ ] 支持3级甚至N级菜单
- [ ] 支持菜单国际化（多语言）
- [ ] 支持角色特定菜单（不同角色看到不同菜单）

### 长期（高级）

- [ ] 支持菜单个性化（用户自定义菜单）
- [ ] 支持菜单A/B测试
- [ ] 支持菜单使用统计分析

---

## ✅ 迁移前后对比

| 功能 | 硬编码方式 | 动态配置方式 |
|------|------------|--------------|
| 添加菜单 | ❌ 需要修改代码 | ✅ 后台配置 |
| 调整顺序 | ❌ 修改代码重新部署 | ✅ 拖拽即可 |
| 禁用菜单 | ❌ 注释代码 | ✅ 开关切换 |
| 权限控制 | ✅ 支持 | ✅ 支持 |
| 修改图标 | ❌ 修改代码 | ✅ 选择列表 |
| 多语言 | ❌ 不支持 | ✅ 可扩展 |
| 维护成本 | ❌ 高 | ✅ 低 |

---

## 🎉 总结

动态菜单系统已经准备就绪，您现在可以：

1. ✅ 在 Supabase 中运行迁移脚本
2. ✅ 启用新的动态侧边栏组件
3. ✅ 在后台管理菜单配置
4. ✅ 无需修改代码即可调整菜单

**立即开始：运行数据库迁移脚本！** 🚀

---

**文档版本**：1.0  
**创建时间**：2025-11-03  
**维护者**：系统管理员

