# 系统备份功能使用指南

## 📋 功能概述

支持将数据库数据备份到本地，提供两种格式：
- ✅ **JSON 格式**：适合数据分析、跨平台使用
- ✅ **SQL 格式**：适合数据库恢复、直接导入

## 🚀 快速开始

### 步骤 1：添加菜单（必须）

在 **Supabase SQL 编辑器**运行：

```sql
-- 运行这个脚本
scripts/add-system-backup-menu.sql
```

**预期结果**：
- ✅ `menu_config` 表新增"系统备份"菜单
- ✅ admin 自动获得访问权限

---

### 步骤 2：访问备份页面

刷新浏览器后：

```
侧边栏 → 设置 → 系统备份
或直接访问：/settings/backup
```

---

### 步骤 3：执行备份

**完整备份流程：**

1. **选择要备份的表**
   - 勾选需要备份的表
   - 或使用快捷按钮（仅业务数据/仅配置数据/全部数据）

2. **选择备份格式**
   - JSON格式：点击"下载 JSON 备份"
   - SQL格式：点击"下载 SQL 备份"

3. **等待备份完成**
   - 进度提示：正在备份 xxx... (1/15)
   - 自动下载文件

4. **保存备份文件**
   - 文件名格式：`中科物流系统备份_2025-11-03T10-30-00.json`
   - 建议保存到：本地 + 云盘（双重保险）

---

## 📊 备份表说明

### 核心业务表（必备）

| 表名 | 说明 | 重要性 |
|------|------|--------|
| `logistics_records` | 运单记录 | ⭐⭐⭐⭐⭐ |
| `logistics_partner_costs` | 运单成本 | ⭐⭐⭐⭐⭐ |

### 项目和合作方（推荐）

| 表名 | 说明 | 重要性 |
|------|------|--------|
| `projects` | 项目信息 | ⭐⭐⭐⭐ |
| `partners` | 合作方信息 | ⭐⭐⭐⭐ |
| `project_partners` | 项目合作方配置 | ⭐⭐⭐⭐ |
| `partner_chains` | 合作链路 | ⭐⭐⭐⭐ |

### 财务数据（推荐）

| 表名 | 说明 | 重要性 |
|------|------|--------|
| `payment_requests` | 付款申请 | ⭐⭐⭐⭐ |
| `invoice_requests` | 开票申请 | ⭐⭐⭐⭐ |
| `payment_records` | 付款记录 | ⭐⭐⭐⭐ |
| `invoice_records` | 开票记录 | ⭐⭐⭐⭐ |

### 系统配置（建议）

| 表名 | 说明 | 重要性 |
|------|------|--------|
| `profiles` | 用户信息 | ⭐⭐⭐ |
| `user_permissions` | 用户权限 | ⭐⭐⭐ |
| `role_permission_templates` | 角色模板 | ⭐⭐⭐ |
| `menu_config` | 菜单配置 | ⭐⭐⭐ |

---

## 💾 备份格式对比

### JSON 格式

**优点**：
- ✅ 人类可读
- ✅ 适合数据分析
- ✅ 可用 Excel/工具打开
- ✅ 跨平台兼容

**缺点**：
- ❌ 文件较大
- ❌ 恢复需要编程

**适用场景**：
- 数据分析
- 数据迁移
- 审计查看
- 生成报表

**示例**：
```json
{
  "version": "1.0",
  "timestamp": "2025-11-03T10:30:00.000Z",
  "tables": {
    "projects": {
      "count": 15,
      "data": [
        {
          "id": "xxx",
          "name": "项目A",
          ...
        }
      ]
    }
  }
}
```

---

### SQL 格式

**优点**：
- ✅ 直接可执行
- ✅ 恢复简单
- ✅ 标准格式
- ✅ 支持事务

**缺点**：
- ❌ 不易人工查看
- ❌ 数据量大时较慢

**适用场景**：
- 数据库恢复
- 迁移到新环境
- 灾难恢复
- 版本回滚

**示例**：
```sql
BEGIN;

-- 表: projects (15 条记录)
INSERT INTO projects (id, name, ...) VALUES (...);
INSERT INTO projects (id, name, ...) VALUES (...);

COMMIT;
```

---

## 🔄 数据恢复

### JSON 恢复（需要编程）

```javascript
// 读取备份文件
const backup = JSON.parse(backupFileContent);

// 恢复每个表
for (const [tableName, tableData] of Object.entries(backup.tables)) {
  await supabase
    .from(tableName)
    .insert(tableData.data);
}
```

### SQL 恢复（直接执行）

```sql
-- 在 Supabase SQL 编辑器中运行备份的 SQL 文件即可
```

---

## ⚡ 快捷备份组合

### 仅业务数据

**包含**：
- ✅ 运单记录
- ✅ 运单成本
- ✅ 项目信息
- ✅ 合作方信息
- ✅ 财务记录
- ✅ 司机、地点

**不包含**：
- ❌ 用户和权限
- ❌ 系统配置

**适用场景**：
- 业务数据分析
- 迁移业务数据
- 生成业务报表

---

### 仅配置数据

**包含**：
- ✅ 用户信息
- ✅ 权限配置
- ✅ 角色模板
- ✅ 菜单配置
- ✅ 项目配置
- ✅ 合作方配置

**不包含**：
- ❌ 运单记录
- ❌ 财务记录

**适用场景**：
- 系统配置备份
- 迁移到新环境
- 权限配置复制

---

### 全部数据

**包含**：
- ✅ 所有业务数据
- ✅ 所有配置数据
- ✅ 所有系统数据

**适用场景**：
- 完整备份
- 系统迁移
- 灾难恢复

---

## 📅 备份策略建议

### 日常备份（推荐）

**每天备份业务数据：**
```
时间：每天晚上
选择：仅业务数据
格式：JSON
保存：本地文件夹/业务备份/
```

**每周备份全部数据：**
```
时间：每周日
选择：全部数据
格式：SQL
保存：云盘/系统备份/
```

**重要操作前备份：**
```
时机：升级、迁移、批量修改前
选择：全部数据
格式：SQL
保存：专门文件夹
```

---

## ⚠️ 注意事项

### 安全提示

1. **备份文件包含敏感数据**
   - 用户信息
   - 财务数据
   - 合同信息
   - 请妥善保管

2. **文件存储建议**
   - ✅ 本地加密存储
   - ✅ 云盘加密备份
   - ❌ 不要上传到公共空间

3. **定期测试恢复**
   - 验证备份文件完整性
   - 测试恢复流程
   - 确保数据可用

### 性能提示

1. **备份时间**
   - 数据量小（<10万条）：几秒钟
   - 数据量中（10-100万条）：几分钟
   - 数据量大（>100万条）：可能较长

2. **文件大小**
   - JSON 格式较大（约为SQL的1.5-2倍）
   - SQL 格式较紧凑

3. **浏览器限制**
   - 极大文件（>500MB）可能失败
   - 建议分批备份

---

## 🔧 高级功能（未来扩展）

### 可以添加的功能

- [ ] 定时自动备份
- [ ] 备份到云存储（OSS/S3）
- [ ] 增量备份（只备份变化）
- [ ] 备份加密
- [ ] 一键恢复功能
- [ ] 备份历史记录
- [ ] 备份差异对比

---

## ✅ 总结

| 功能 | 状态 |
|------|------|
| JSON备份 | ✅ 已实现 |
| SQL备份 | ✅ 已实现 |
| 表选择 | ✅ 已实现 |
| 快捷组合 | ✅ 已实现 |
| 进度显示 | ✅ 已实现 |
| 文件下载 | ✅ 已实现 |

---

**立即使用：**
1. 运行 `scripts/add-system-backup-menu.sql`
2. 刷新页面
3. 访问"设置" → "系统备份"
4. 开始备份数据！

---

**文档版本**：1.0  
**创建时间**：2025-11-03


