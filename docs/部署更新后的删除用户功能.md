# éƒ¨ç½²æ›´æ–°åçš„åˆ é™¤ç”¨æˆ·åŠŸèƒ½

## ğŸ¯ ç›®æ ‡

å°†æ—§çš„ `delete-user` Edge Function æ›´æ–°ä¸ºæ–°ç‰ˆæœ¬ï¼Œæ”¯æŒè‡ªåŠ¨è½¬ç§»æ•°æ®ï¼Œé˜²æ­¢å¤–é”®çº¦æŸé”™è¯¯ã€‚

---

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. å‰ç«¯ä»£ç  âœ…
- **æ–‡ä»¶**: `src/components/permissions/UserManagement.tsx`
- **ä¿®æ”¹**: å·²æ”¹ä¸ºè°ƒç”¨ Edge Functionï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ é™¤ profiles
- **çŠ¶æ€**: å·²å®Œæˆï¼Œæ— éœ€å†ä¿®æ”¹

### 2. Edge Function V2 âœ…
- **æ–‡ä»¶**: `supabase/functions/delete-user-v2/index.ts`
- **åŠŸèƒ½**: 
  - è‡ªåŠ¨è½¬ç§»å…³è”æ•°æ®åˆ°ç®¡ç†å‘˜
  - æ”¯æŒè½¯åˆ é™¤ï¼ˆåœç”¨ï¼‰å’Œç¡¬åˆ é™¤
  - é˜²æ­¢å¤–é”®çº¦æŸé”™è¯¯
- **çŠ¶æ€**: å·²åˆ›å»ºï¼Œéœ€è¦éƒ¨ç½²

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹æ¡ˆ A: éƒ¨ç½²ä¸ºæ–°å‡½æ•°ï¼ˆæ¨èï¼‰â­

**ä¼˜ç‚¹**: å¯ä»¥æµ‹è¯•åå†åˆ‡æ¢ï¼Œæ›´å®‰å…¨

#### Step 1: éƒ¨ç½²æ–°å‡½æ•°

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd supabase/functions
supabase functions deploy delete-user-v2
```

#### Step 2: æµ‹è¯•æ–°å‡½æ•°

```typescript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
const { data, error } = await supabase.functions.invoke('delete-user-v2', {
  body: {
    userId: 'æµ‹è¯•ç”¨æˆ·ID',
    hardDelete: true
  }
});

console.log('ç»“æœ:', data);
```

#### Step 3: æ›´æ–°å‰ç«¯è°ƒç”¨

```typescript
// ä¿®æ”¹ src/components/permissions/UserManagement.tsx
// å°† 'delete-user' æ”¹ä¸º 'delete-user-v2'

const { data, error } = await supabase.functions.invoke('delete-user-v2', {  // ğŸ‘ˆ æ”¹è¿™é‡Œ
  body: {
    userId: userToDelete.id,
    hardDelete: true
  }
});
```

#### Step 4: é‡æ–°ç¼–è¯‘å‰ç«¯

```bash
npm run build
# é‡æ–°éƒ¨ç½²å‰ç«¯
```

---

### æ–¹æ¡ˆ B: ç›´æ¥æ›¿æ¢ï¼ˆå¿«é€Ÿï¼‰

**ä¼˜ç‚¹**: æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç 

#### Step 1: å¤‡ä»½æ—§å‡½æ•°

```bash
# é‡å‘½åæ—§å‡½æ•°æ–‡ä»¶å¤¹
mv supabase/functions/delete-user supabase/functions/delete-user-old
```

#### Step 2: é‡å‘½åæ–°å‡½æ•°

```bash
# å°† V2 æ”¹åä¸º delete-user
mv supabase/functions/delete-user-v2 supabase/functions/delete-user
```

#### Step 3: éƒ¨ç½²

```bash
supabase functions deploy delete-user
```

#### Step 4: æµ‹è¯•

```typescript
// åœ¨ç”¨æˆ·ç®¡ç†ç•Œé¢æµ‹è¯•åˆ é™¤åŠŸèƒ½
// åº”è¯¥ä¸ä¼šå†å‡ºç°å¤–é”®çº¦æŸé”™è¯¯
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### 1. åˆ›å»ºæµ‹è¯•ç”¨æˆ·

```typescript
const { data, error } = await supabase.functions.invoke('create-user', {
  body: {
    email: 'test-delete@example.com',
    password: 'Test123456',
    full_name: 'æµ‹è¯•åˆ é™¤',
    role: 'viewer'
  }
});
```

### 2. ä¸ºæµ‹è¯•ç”¨æˆ·åˆ›å»ºä¸€äº›æ•°æ®

```sql
-- åˆ›å»ºä¸€äº›å…³è”æ•°æ®
INSERT INTO public.drivers (name, license_plate, phone, user_id)
VALUES ('æµ‹è¯•å¸æœº', 'äº¬A12345', '13800138000', 'æµ‹è¯•ç”¨æˆ·ID');
```

### 3. åˆ é™¤æµ‹è¯•ç”¨æˆ·

```typescript
const { data, error } = await supabase.functions.invoke('delete-user-v2', {
  body: {
    userId: 'æµ‹è¯•ç”¨æˆ·ID',
    hardDelete: true
  }
});
```

### 4. éªŒè¯ç»“æœ

```sql
-- 1. æ£€æŸ¥ auth.users
SELECT * FROM auth.users WHERE email = 'test-delete@example.com';
-- åº”è¯¥è¿”å›ç©º

-- 2. æ£€æŸ¥ profiles
SELECT * FROM public.profiles WHERE email = 'test-delete@example.com';
-- åº”è¯¥è¿”å›ç©º

-- 3. æ£€æŸ¥å…³è”æ•°æ®æ˜¯å¦å·²è½¬ç§»
SELECT * FROM public.drivers WHERE name = 'æµ‹è¯•å¸æœº';
-- user_id åº”è¯¥å·²ç»å˜æˆç®¡ç†å‘˜çš„ ID
```

---

## ğŸ“Š å¯¹æ¯”ï¼šæ—§ç‰ˆ vs æ–°ç‰ˆ

| ç‰¹æ€§ | æ—§ç‰ˆ delete-user | æ–°ç‰ˆ delete-user-v2 |
|------|-----------------|-------------------|
| åˆ é™¤ auth.users | âœ… | âœ… |
| åˆ é™¤ profiles | âœ… | âœ… |
| å¤„ç†å…³è”æ•°æ® | âŒ **ä¼šæŠ¥é”™** | âœ… **è‡ªåŠ¨è½¬ç§»** |
| æ”¯æŒè½¯åˆ é™¤ | âŒ | âœ… |
| é˜²æ­¢å¤–é”®é”™è¯¯ | âŒ | âœ… |
| æŒ‡å®šæ¥ç®¡è´¦æˆ· | âŒ | âœ… |

---

## âš™ï¸ é…ç½®é€‰é¡¹

### ç¡¬åˆ é™¤ï¼ˆå®Œå…¨åˆ é™¤ï¼‰

```typescript
await supabase.functions.invoke('delete-user-v2', {
  body: {
    userId: 'xxx',
    hardDelete: true,  // å®Œå…¨åˆ é™¤
    transferToUserId: 'admin-id'  // å¯é€‰ï¼šæŒ‡å®šæ¥ç®¡è´¦æˆ·
  }
});
```

### è½¯åˆ é™¤ï¼ˆä»…åœç”¨ï¼‰

```typescript
await supabase.functions.invoke('delete-user-v2', {
  body: {
    userId: 'xxx',
    hardDelete: false  // ä»…åœç”¨ï¼Œä¸åˆ é™¤
  }
});
```

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

### å¦‚æœä½¿ç”¨æ–¹æ¡ˆ A

```typescript
// å‰ç«¯ä»£ç æ”¹å›
const { data, error } = await supabase.functions.invoke('delete-user', {  // æ”¹å›æ—§ç‰ˆ
  body: { userId, hardDelete: true }
});
```

### å¦‚æœä½¿ç”¨æ–¹æ¡ˆ B

```bash
# æ¢å¤æ—§å‡½æ•°
mv supabase/functions/delete-user-old supabase/functions/delete-user
supabase functions deploy delete-user
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒç›´æ¥æµ‹è¯•**
   - å…ˆåœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•
   - ç¡®è®¤æ— è¯¯åå†éƒ¨ç½²ç”Ÿäº§

2. **ç¡®ä¿æœ‰ç®¡ç†å‘˜è´¦æˆ·**
   - æ–°ç‰ˆæœ¬éœ€è¦ admin@example.com è´¦æˆ·æ¥æ¥ç®¡æ•°æ®
   - æˆ–è€…æŒ‡å®š transferToUserId å‚æ•°

3. **æ‰§è¡Œå‰å¤‡ä»½**
   ```sql
   CREATE TABLE auth_users_backup AS SELECT * FROM auth.users;
   CREATE TABLE profiles_backup AS SELECT * FROM public.profiles;
   ```

4. **å‘ŠçŸ¥å›¢é˜Ÿ**
   - éƒ¨ç½²å‰é€šçŸ¥å›¢é˜Ÿæˆå‘˜
   - é¿å…åœ¨åˆ é™¤è¿‡ç¨‹ä¸­æœ‰å…¶ä»–æ“ä½œ

---

## ğŸ‰ é¢„æœŸæ•ˆæœ

éƒ¨ç½²åï¼Œåˆ é™¤ç”¨æˆ·å°†ï¼š
- âœ… ä¸å†å‡ºç°å¤–é”®çº¦æŸé”™è¯¯
- âœ… è‡ªåŠ¨è½¬ç§»å…³è”æ•°æ®
- âœ… åŒæ—¶åˆ é™¤ auth.users å’Œ profiles
- âœ… ä¿ç•™ä¸šåŠ¡æ•°æ®çš„å®Œæ•´æ€§

---

**éƒ¨ç½²æ—¶é—´**: çº¦ 5-10 åˆ†é’Ÿ  
**é£é™©ç­‰çº§**: ğŸŸ¢ ä½ï¼ˆæœ‰å›æ»šæ–¹æ¡ˆï¼‰  
**æ¨èæ–¹æ¡ˆ**: æ–¹æ¡ˆ Aï¼ˆæ›´å®‰å…¨ï¼‰

