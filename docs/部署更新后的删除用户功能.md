# 部署更新后的删除用户功能

## 🎯 目标

将旧的 `delete-user` Edge Function 更新为新版本，支持自动转移数据，防止外键约束错误。

---

## ✅ 已完成的修改

### 1. 前端代码 ✅
- **文件**: `src/components/permissions/UserManagement.tsx`
- **修改**: 已改为调用 Edge Function，而不是直接删除 profiles
- **状态**: 已完成，无需再修改

### 2. Edge Function V2 ✅
- **文件**: `supabase/functions/delete-user-v2/index.ts`
- **功能**: 
  - 自动转移关联数据到管理员
  - 支持软删除（停用）和硬删除
  - 防止外键约束错误
- **状态**: 已创建，需要部署

---

## 🚀 部署步骤

### 方案 A: 部署为新函数（推荐）⭐

**优点**: 可以测试后再切换，更安全

#### Step 1: 部署新函数

```bash
# 在项目根目录执行
cd supabase/functions
supabase functions deploy delete-user-v2
```

#### Step 2: 测试新函数

```typescript
// 在浏览器控制台测试
const { data, error } = await supabase.functions.invoke('delete-user-v2', {
  body: {
    userId: '测试用户ID',
    hardDelete: true
  }
});

console.log('结果:', data);
```

#### Step 3: 更新前端调用

```typescript
// 修改 src/components/permissions/UserManagement.tsx
// 将 'delete-user' 改为 'delete-user-v2'

const { data, error } = await supabase.functions.invoke('delete-user-v2', {  // 👈 改这里
  body: {
    userId: userToDelete.id,
    hardDelete: true
  }
});
```

#### Step 4: 重新编译前端

```bash
npm run build
# 重新部署前端
```

---

### 方案 B: 直接替换（快速）

**优点**: 无需修改前端代码

#### Step 1: 备份旧函数

```bash
# 重命名旧函数文件夹
mv supabase/functions/delete-user supabase/functions/delete-user-old
```

#### Step 2: 重命名新函数

```bash
# 将 V2 改名为 delete-user
mv supabase/functions/delete-user-v2 supabase/functions/delete-user
```

#### Step 3: 部署

```bash
supabase functions deploy delete-user
```

#### Step 4: 测试

```typescript
// 在用户管理界面测试删除功能
// 应该不会再出现外键约束错误
```

---

## 🧪 测试清单

### 1. 创建测试用户

```typescript
const { data, error } = await supabase.functions.invoke('create-user', {
  body: {
    email: 'test-delete@example.com',
    password: 'Test123456',
    full_name: '测试删除',
    role: 'viewer'
  }
});
```

### 2. 为测试用户创建一些数据

```sql
-- 创建一些关联数据
INSERT INTO public.drivers (name, license_plate, phone, user_id)
VALUES ('测试司机', '京A12345', '13800138000', '测试用户ID');
```

### 3. 删除测试用户

```typescript
const { data, error } = await supabase.functions.invoke('delete-user-v2', {
  body: {
    userId: '测试用户ID',
    hardDelete: true
  }
});
```

### 4. 验证结果

```sql
-- 1. 检查 auth.users
SELECT * FROM auth.users WHERE email = 'test-delete@example.com';
-- 应该返回空

-- 2. 检查 profiles
SELECT * FROM public.profiles WHERE email = 'test-delete@example.com';
-- 应该返回空

-- 3. 检查关联数据是否已转移
SELECT * FROM public.drivers WHERE name = '测试司机';
-- user_id 应该已经变成管理员的 ID
```

---

## 📊 对比：旧版 vs 新版

| 特性 | 旧版 delete-user | 新版 delete-user-v2 |
|------|-----------------|-------------------|
| 删除 auth.users | ✅ | ✅ |
| 删除 profiles | ✅ | ✅ |
| 处理关联数据 | ❌ **会报错** | ✅ **自动转移** |
| 支持软删除 | ❌ | ✅ |
| 防止外键错误 | ❌ | ✅ |
| 指定接管账户 | ❌ | ✅ |

---

## ⚙️ 配置选项

### 硬删除（完全删除）

```typescript
await supabase.functions.invoke('delete-user-v2', {
  body: {
    userId: 'xxx',
    hardDelete: true,  // 完全删除
    transferToUserId: 'admin-id'  // 可选：指定接管账户
  }
});
```

### 软删除（仅停用）

```typescript
await supabase.functions.invoke('delete-user-v2', {
  body: {
    userId: 'xxx',
    hardDelete: false  // 仅停用，不删除
  }
});
```

---

## 🔄 回滚方案

如果新版本有问题，可以快速回滚：

### 如果使用方案 A

```typescript
// 前端代码改回
const { data, error } = await supabase.functions.invoke('delete-user', {  // 改回旧版
  body: { userId, hardDelete: true }
});
```

### 如果使用方案 B

```bash
# 恢复旧函数
mv supabase/functions/delete-user-old supabase/functions/delete-user
supabase functions deploy delete-user
```

---

## 📝 注意事项

1. **不要在生产环境直接测试**
   - 先在开发环境测试
   - 确认无误后再部署生产

2. **确保有管理员账户**
   - 新版本需要 admin@example.com 账户来接管数据
   - 或者指定 transferToUserId 参数

3. **执行前备份**
   ```sql
   CREATE TABLE auth_users_backup AS SELECT * FROM auth.users;
   CREATE TABLE profiles_backup AS SELECT * FROM public.profiles;
   ```

4. **告知团队**
   - 部署前通知团队成员
   - 避免在删除过程中有其他操作

---

## 🎉 预期效果

部署后，删除用户将：
- ✅ 不再出现外键约束错误
- ✅ 自动转移关联数据
- ✅ 同时删除 auth.users 和 profiles
- ✅ 保留业务数据的完整性

---

**部署时间**: 约 5-10 分钟  
**风险等级**: 🟢 低（有回滚方案）  
**推荐方案**: 方案 A（更安全）

