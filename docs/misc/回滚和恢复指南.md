# Git回滚和开票申请功能恢复指南

## 当前状态
- ✅ 开票申请功能已备份到 `invoice-features-backup` 目录
- ✅ 备份包含所有必要的文件和配置

## 回滚步骤

### 1. 查看提交历史
```bash
git log --oneline -10
```

### 2. 选择回滚目标
根据您的需要选择回滚到哪个提交：

**选项A: 回滚到开票申请功能之前**
```bash
# 回滚到添加开票申请功能之前的提交
git reset --hard <commit-hash>
```

**选项B: 回滚到特定功能点**
```bash
# 例如回滚到某个稳定的提交
git reset --hard 1f70285  # 回滚到 "Fix: Resolve preview build errors"
```

**选项C: 软回滚（保留工作区更改）**
```bash
git reset --soft <commit-hash>
```

### 3. 强制推送到远程（如果需要）
```bash
git push --force-with-lease origin main
```

## 恢复开票申请功能

### 1. 运行恢复脚本
```bash
powershell -ExecutionPolicy Bypass -File restore-invoice-features.ps1
```

### 2. 执行数据库迁移
```bash
# 按顺序执行数据库迁移
supabase db push
```

### 3. 重新构建项目
```bash
npm install
npm run build
```

### 4. 测试功能
- 检查开票申请页面是否正常
- 检查开票申请单管理页面是否正常
- 测试开票申请功能是否完整

## 手动恢复步骤（如果脚本失败）

### 1. 恢复前端文件
```bash
# 恢复开票申请页面
cp invoice-features-backup/src/pages/InvoiceRequest.tsx src/pages/
cp invoice-features-backup/src/pages/InvoiceRequestManagement.tsx src/pages/
cp invoice-features-backup/src/pages/mobile/MobileInvoiceRequestManagement.tsx src/pages/mobile/

# 恢复路由配置
cp invoice-features-backup/src/App.tsx src/
cp invoice-features-backup/src/components/AppSidebar.tsx src/components/
```

### 2. 恢复权限配置
```bash
cp invoice-features-backup/src/config/permissions.ts src/config/
cp invoice-features-backup/src/config/permissionsNew.ts src/config/
cp invoice-features-backup/src/pages/Settings/PermissionManagement.tsx src/pages/Settings/
```

### 3. 恢复数据库迁移
```bash
cp invoice-features-backup/supabase/migrations/*.sql supabase/migrations/
```

### 4. 恢复类型定义
```bash
cp invoice-features-backup/src/types/index.ts src/types/
```

## 验证恢复

### 1. 检查文件是否存在
```bash
# 检查关键文件
ls src/pages/InvoiceRequest.tsx
ls src/pages/InvoiceRequestManagement.tsx
ls src/pages/mobile/MobileInvoiceRequestManagement.tsx
```

### 2. 检查路由配置
```bash
# 检查App.tsx中是否有开票申请路由
grep -n "InvoiceRequest" src/App.tsx
```

### 3. 检查权限配置
```bash
# 检查权限配置中是否有开票申请权限
grep -n "invoice_request" src/config/permissions.ts
```

### 4. 检查数据库迁移
```bash
# 检查迁移文件
ls supabase/migrations/20250816_fix_invoice_request_function_overload.sql
ls supabase/migrations/20250116_*.sql
```

## 故障排除

### 1. 如果恢复后出现编译错误
```bash
# 重新安装依赖
rm -rf node_modules package-lock.json
npm install
npm run build
```

### 2. 如果数据库迁移失败
```bash
# 检查Supabase连接
supabase status
# 重新推送迁移
supabase db push --debug
```

### 3. 如果权限配置丢失
```bash
# 手动添加权限配置到数据库
# 参考备份文件中的权限配置
```

## 注意事项

1. **备份重要性**: 确保在回滚前已经完成备份
2. **数据库状态**: 回滚后数据库状态可能与代码不匹配，需要重新执行迁移
3. **依赖关系**: 开票申请功能依赖多个组件，确保所有依赖都已恢复
4. **测试验证**: 恢复后务必测试所有功能是否正常工作

## 回滚建议

根据您的需求，建议的回滚策略：

### 保守回滚（推荐）
```bash
# 回滚到最近的稳定提交
git reset --hard 1f70285  # "Fix: Resolve preview build errors"
```

### 激进回滚
```bash
# 回滚到更早的提交
git reset --hard <更早的commit-hash>
```

### 选择性回滚
```bash
# 只回滚特定文件
git checkout <commit-hash> -- <specific-files>
```

选择适合您需求的回滚策略，然后按照恢复步骤重新添加开票申请功能。
