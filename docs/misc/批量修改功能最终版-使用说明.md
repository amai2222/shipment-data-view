# 批量修改应收和链路功能 - 最终版使用说明

## 🎯 两个批量功能

### 1. 批量修改应收 ✏️
- 显示每条运单的详细信息
- 每条运单独立输入框
- 可以设置不同的金额

### 2. 批量修改链路 🔗
- 统一更换合作链路
- 自动重新计算成本
- 必须是同一项目

---

## 📦 部署步骤

### 必须按顺序执行以下SQL：

#### 1️⃣ 先执行（修复链路修改重算逻辑）
**文件**：`合作链路修改-使用正确重算逻辑.sql`

在 Supabase Dashboard → SQL Editor 中执行此文件的全部内容

**成功标志**：
```
✅ 修复完成！使用标准重算逻辑
```

#### 2️⃣ 再执行（添加批量修改链路功能）
**文件**：`supabase/migrations/20251025_add_batch_modify_functions.sql`

在 Supabase Dashboard → SQL Editor 中执行此文件的全部内容

**成功标志**：
```
✅ 批量修改功能创建完成
```

#### 3️⃣ 刷新浏览器
按 `Ctrl + Shift + R` 强制刷新

---

## 🎯 功能1：批量修改应收（详细版）

### 界面展示

对话框会显示所有选中运单的详细信息：

| 运单编号 | 装货日期 | 司机 | 原应付金额 | 新应付金额 |
|----------|----------|------|------------|------------|
| YDN20251022-001 | 2025/10/22 | 李刚 | ¥2,900.00 | `[输入框]` |
| YDN20251022-002 | 2025/10/21 | 张三 | ¥3,200.00 | `[输入框]` |
| YDN20251022-003 | 2025/10/20 | 王五 | ¥2,800.00 | `[输入框]` |

### 操作步骤

1. **选择运单**
   - 在付款审核页面勾选要修改的运单
   - 可以选择 1-100 条运单

2. **打开对话框**
   - 点击**"批量修改应收"**按钮
   - 系统加载运单数据

3. **查看详情**
   - 运单编号：识别每条运单
   - 装货日期：了解运输时间
   - 司机：确认司机信息
   - 原应付金额：当前最高级合作方的应付金额

4. **输入新金额**
   - 每条运单都有独立的输入框
   - 默认值为原应付金额
   - 可以修改为任意金额
   - 支持小数点后两位

5. **确认修改**
   - 点击**"确认修改 (X条)"**按钮
   - 系统逐个处理运单
   - 显示成功/失败统计

### 处理逻辑

```
对每条运单：
  ├─ 检查付款状态（必须是"未支付"）
  ├─ 检查开票状态（必须是"未开票"）
  ├─ 查找最高级合作方
  ├─ 更新应付金额
  └─ 记录成功/失败
  
最后显示：成功 X 条，失败 Y 条
```

### 使用示例

**场景：财务核对后需要调整应收**

选中了3条运单：
- YDN001：原金额2900，改为 **3500**
- YDN002：原金额3200，改为 **3500**（统一价格）
- YDN003：原金额2800，改为 **3000**（单独定价）

操作：
1. 勾选这3条运单
2. 点击"批量修改应收"
3. 看到对话框显示3条运单详情
4. 在输入框中分别输入：3500、3500、3000
5. 点击"确认修改 (3条)"
6. 完成！

---

## 🎯 功能2：批量修改链路（统一版）

### 界面展示

对话框只有一个下拉选择框：

```
┌─────────────────────────────┐
│ 🟣 批量修改合作链路          │
│ 已选择 3 条运单              │
├─────────────────────────────┤
│ 选择合作链路                │
│ ┌─────────────────────────┐ │
│ │ 线下张海宽         ▼    │ │
│ │ - 成丰6                 │ │
│ │ - 线下张海宽            │ │
│ │ - 其他链路...           │ │
│ └─────────────────────────┘ │
│                             │
│ 💡 提示：                   │
│ • 修改后自动重新计算成本     │
│ • 只能修改未支付且未开票     │
│ • 必须属于同一个项目         │
├─────────────────────────────┤
│        [取消] [确认修改]     │
└─────────────────────────────┘
```

### 操作步骤

1. 选择运单（必须是同一项目）
2. 点击"批量修改链路"
3. 从下拉列表选择新链路
4. 点击"确认修改"
5. 系统自动重新计算所有合作方成本

### 使用示例

**场景：批量更换合作链路**

选中了5条"中粮可乐"项目的运单，都是"成丰6"链路，需要改为"线下张海宽"：

1. 筛选项目："中粮可乐"
2. 勾选5条运单
3. 点击"批量修改链路"
4. 选择"线下张海宽"
5. 点击"确认修改"
6. 系统更新5条运单，重新计算15个合作方成本（假设每条3个）

---

## ⚠️ 限制和注意事项

### 批量修改应收
- ✅ 每条运单可以设置不同金额
- ✅ 自动跳过已付款/已开票的运单
- ✅ 只修改最高级合作方
- ⚠️ 必须为每条运单输入有效金额

### 批量修改链路
- ✅ 所有运单改为同一个链路
- ✅ 自动重新计算所有合作方成本
- ⚠️ **所选运单必须属于同一个项目**
- ⚠️ 目标链路必须已配置合作方

---

## 🔍 故障排除

### 问题1：批量修改应收对话框显示空列表
**原因**：选中的运单没有合作方成本数据  
**解决**：检查运单是否已配置合作链路

### 问题2：修改后提示"失败X条"
**原因**：运单状态不符合要求  
**解决**：
1. 按F12查看控制台的详细失败列表
2. 确认失败原因（已付款/已开票/无合作方）
3. 只选择符合条件的运单

### 问题3：批量修改链路下拉列表为空
**原因**：该项目没有配置合作链路  
**解决**：在项目管理页面为该项目添加合作链路

### 问题4：所有运单都修改失败
**检查**：
1. 当前用户角色（必须是 admin/finance/operator）
2. 运单状态（必须是"未支付"且"未开票"）
3. 控制台错误信息（F12查看）

---

## 📋 完整操作检查清单

### 部署前
- [ ] 在Supabase执行 `合作链路修改-使用正确重算逻辑.sql`
- [ ] 在Supabase执行 `20251025_add_batch_modify_functions.sql`
- [ ] 刷新浏览器（Ctrl + Shift + R）

### 测试批量修改应收
- [ ] 选择3-5条"未支付"的运单
- [ ] 点击"批量修改应收"按钮
- [ ] 看到对话框显示运单列表（运单号、日期、司机、原金额）
- [ ] 每条运单有独立输入框
- [ ] 输入新金额并确认
- [ ] 看到成功提示
- [ ] 数据库中金额已更新

### 测试批量修改链路
- [ ] 筛选出同一项目的运单
- [ ] 选择3-5条"未支付"的运单
- [ ] 点击"批量修改链路"按钮
- [ ] 看到链路下拉列表
- [ ] 选择新链路并确认
- [ ] 看到成功提示和重算合作方数量
- [ ] 数据库中链路已更新，成本已重算

---

## 🎉 完成标志

所有功能正常后，您会看到：

### 批量修改应收
- ✅ 对话框显示详细的运单列表
- ✅ 每条运单有独立输入框
- ✅ 修改后显示："成功更新 X 条运单，失败 Y 条"
- ✅ 列表中金额已更新

### 批量修改链路
- ✅ 对话框显示链路选择下拉列表
- ✅ 修改后显示："成功更新 X 条运单，重新计算 Y 个合作方成本"
- ✅ 列表中链路已更新，金额已重算

**工作效率提升10倍以上！** 🚀

