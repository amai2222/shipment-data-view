# 手动修改成本保护逻辑说明

## 🔍 问题发现

用户提出关键问题：**手动修改的司机应收或合作方应收，会不会被自动重算覆盖？**

经过全面检查，发现**严重问题**：

### ❌ 原有问题

#### 1. **modify_logistics_record_chain_with_recalc** （修改链路函数）
```sql
-- 第一步：直接删除
DELETE FROM logistics_partner_costs WHERE logistics_record_id = p_record_id;

-- 第二步：重新计算并插入
INSERT INTO logistics_partner_costs (...) VALUES (...);
```
**问题：** 没有检查 `is_manually_modified`，直接删除所有，包括手动修改的值

#### 2. **recalculate_costs_for_chain_safe** （项目配置变更自动重算）
```sql
-- 只检查付款状态，不检查手动修改标记
IF p_only_unpaid AND v_has_paid_status THEN
    CONTINUE;  -- 跳过已付款
END IF;

-- 直接删除并重算（未付款的运单）
DELETE FROM logistics_partner_costs WHERE logistics_record_id = v_record_id;
```
**问题：** 只保护已付款运单，不保护手动修改的值

---

## ✅ 解决方案

已创建迁移脚本：`20251028_comprehensive_protect_manual_costs.sql`

### 保护逻辑（两个函数都添加）：

```
步骤1：保存手动值
  ↓
SELECT json_agg(...)
FROM logistics_partner_costs
WHERE logistics_record_id = p_record_id
AND is_manually_modified = true;  -- ✅ 只保存手动修改的

步骤2：删除旧记录
  ↓
DELETE FROM logistics_partner_costs
WHERE logistics_record_id = p_record_id;

步骤3：重新计算
  ↓
FOR 每个合作方 LOOP
  -- 系统计算值
  v_payable_amount := 系统计算(...);
  
  -- ✅ 检查是否有手动值
  IF 该合作方(partner_id+level)有手动值 THEN
    v_payable_amount := 手动值;
    v_is_manual := true;
    v_protected_count++;
  END IF;
  
  -- 插入（保持标记）
  INSERT INTO logistics_partner_costs (
    ...,
    is_manually_modified = v_is_manual  -- ✅ 保持标记
  );
END LOOP;
```

---

## 📋 完整的保护机制

### 场景1：用户手动修改合作方应收

```
1. 用户修改：¥4200 → ¥4500
   → 前端设置 is_manually_modified = true ✅
   
2. 用户修改链路：链路A → 链路B
   → 后端函数：
     ① 保存手动值 ¥4500
     ② 删除所有旧记录
     ③ 按链路B计算 ¥4300
     ④ 发现有手动值，恢复 ¥4500 ✅
     ⑤ 保持 is_manually_modified = true ✅
```

### 场景2：管理员修改项目配置

```
1. 用户手动修改：某运单的合作方应收 ¥4500
   → is_manually_modified = true ✅
   
2. 管理员修改税率：6% → 9%
   → 触发器自动重算：
     ① 遍历所有未付款运单
     ② 保存每个运单的手动值
     ③ 删除并重算
     ④ 恢复手动值 ✅
     ⑤ 保持标记 ✅
```

### 场景3：用户主动恢复默认

```
1. 用户点击"恢复默认"按钮
   → 前端主动清除：
     UPDATE logistics_partner_costs
     SET is_manually_modified = false  -- ✅ 清除标记
     WHERE ...;
     
2. 调用重算函数
   → 因为 is_manually_modified = false
   → 不会被保护，使用系统计算值 ✅
```

---

## 🎯 关于司机应收的特殊说明

### ❓ 司机应收不在自动重算范围内

**原因：**
- 司机应收存储在 `logistics_records.payable_cost`
- 重算函数只操作 `logistics_partner_costs` 表
- **不会自动重算司机应收** ✅

### 司机应收的修改场景：

| 操作 | 是否被覆盖 | 说明 |
|-----|-----------|------|
| 手动修改司机应收 | ❌ 不会 | 存储在不同表，不受合作方重算影响 |
| 修改链路 | ❌ 不会 | 重算函数不处理司机应收 |
| 管理员改配置 | ❌ 不会 | 触发器只重算合作方成本 |
| 用户点"恢复默认" | ✅ 会 | 前端主动恢复为最高级合作方金额 |

---

## 📊 保护级别总结

### ✅ 完全保护（修复后）

| 数据 | 手动修改后 | 修改链路 | 配置变更 | 恢复默认 |
|------|-----------|---------|---------|---------|
| **合作方应收** | is_manually_modified=true | 🛡️ 保护 | 🛡️ 保护 | ❌ 清除 |
| **司机应收** | 手动修改 | ✅ 保持 | ✅ 保持 | ❌ 恢复 |

### 🔑 关键机制

1. **is_manually_modified 标记**
   - 前端修改时设置为 `true`
   - 后端重算时检查并保护
   - 用户点"恢复默认"时清除

2. **付款状态保护**
   - 已付款的运单：完全跳过，不重算
   - 未付款的运单：重算但保护手动值

3. **司机应收**
   - 独立存储，不受合作方重算影响
   - 只有"恢复默认"会主动修改

---

## 🔄 需要执行的操作

### 1. 运行数据库迁移

```bash
psql your_database < supabase/migrations/20251028_comprehensive_protect_manual_costs.sql
```

或在 Supabase Dashboard 的 SQL Editor 中执行。

### 2. 测试验证

#### 测试1：修改链路保护手动值
1. 手动修改合作方应收：¥4200 → ¥4500
2. 修改合作链路
3. 验证：应收金额仍为 ¥4500 ✅

#### 测试2：配置变更保护手动值
1. 手动修改合作方应收
2. 管理员修改项目税率
3. 验证：手动值被保护 ✅

#### 测试3：恢复默认清除手动值
1. 手动修改合作方应收
2. 点击"恢复默认"
3. 验证：恢复为系统计算值 ✅

---

## 📌 后台函数不需要额外修改

**原因：**
- 前端的单个/批量修改都是直接调用 `UPDATE`
- 不使用批量RPC函数
- 保存逻辑完全正确

**需要修改的只有：**
- ✅ `modify_logistics_record_chain_with_recalc` - 已修复
- ✅ `recalculate_costs_for_chain_safe` - 已修复

---

## ✅ 最终结论

修复后，系统具有完善的保护机制：
1. ✅ 手动修改的值会被保护
2. ✅ 修改链路不会丢失手动值
3. ✅ 配置变更不会覆盖手动值
4. ✅ "恢复默认"才会清除手动值
5. ✅ 司机应收独立存储，不受影响

**现在可以放心使用手动修改功能了！** 🎉

