# 通知系统快速指南

## 🚀 3步启用真实通知系统

### 第一步：执行数据库迁移（2分钟）

```bash
# 在Supabase Dashboard SQL Editor中执行
supabase/migrations/create_notifications_system.sql
```

**创建内容**:
- ✅ notifications表
- ✅ 4个索引
- ✅ RLS安全策略
- ✅ 6个通知函数
- ✅ 1个自动触发器

### 第二步：创建测试通知（1分钟）

```sql
-- 在Supabase SQL Editor执行
INSERT INTO notifications (
  user_id,
  type,
  category,
  title,
  message,
  link
) VALUES (
  auth.uid(),
  'info',
  'system',
  '欢迎使用通知系统',
  '您的通知系统已成功启用，现在可以接收实时通知了！',
  '/m/'
);
```

### 第三步：查看通知（30秒）

```
访问 /m/notifications
看到刚创建的欢迎通知 ✅
```

---

## 📱 立即可用的功能

### 通知页面功能
- ✅ 查看所有通知
- ✅ 筛选未读/业务/财务通知
- ✅ 标记单个已读
- ✅ 全部标记已读
- ✅ 删除通知
- ✅ 点击跳转相关页面
- ✅ 每分钟自动刷新

### 自动通知场景
- ✅ 付款申请创建 → 通知admin和finance
- ✅ 合同即将到期 → 通知负责人
- ✅ 项目完成 → 通知相关人员

---

## 🔔 手动创建通知

### 通用通知模板

```sql
INSERT INTO notifications (
  user_id,      -- 接收者ID
  type,         -- 'info' | 'warning' | 'success' | 'error'
  category,     -- 'system' | 'business' | 'finance' | 'contract'
  title,        -- 通知标题
  message,      -- 通知内容
  link          -- 可选：跳转链接
) VALUES (
  '用户ID',
  '通知类型',
  '通知分类',
  '标题',
  '详细消息',
  '/m/page-url'
);
```

### 示例：通知所有管理员

```sql
-- 通知所有管理员
INSERT INTO notifications (user_id, type, category, title, message)
SELECT 
  id,
  'warning',
  'system',
  '系统维护通知',
  '系统将于今晚22:00进行维护，预计耗时1小时'
FROM profiles
WHERE role = 'admin' AND is_active = true;
```

### 示例：通知特定用户

```sql
-- 通知项目负责人
INSERT INTO notifications (user_id, type, category, title, message, link)
SELECT 
  p.id,
  'info',
  'business',
  '项目进度更新',
  format('项目"%s"已完成50%%进度', proj.name),
  format('/m/projects/detail/%s', proj.id)
FROM profiles p
JOIN projects proj ON p.full_name = proj.manager
WHERE proj.id = '项目ID';
```

---

## 🎯 通知最佳实践

### 1. 通知内容规范

**好的通知** ✅:
```
标题: 付款申请待审批
消息: 项目"煤炭运输A"有新的付款申请，金额¥50,000
链接: /m/payment-requests-management
```

**不好的通知** ❌:
```
标题: 通知
消息: 有新消息
链接: 无
```

### 2. 通知时机

- ✅ 关键业务事件发生时
- ✅ 需要用户操作时
- ✅ 重要数据变化时
- ❌ 避免过于频繁
- ❌ 避免无关紧要的通知

### 3. 通知对象

- ✅ 通知相关责任人
- ✅ 通知有操作权限的人
- ❌ 不要通知无关人员
- ❌ 不要重复通知

---

## 📊 监控和维护

### 查看通知统计

```sql
-- 总通知数
SELECT COUNT(*) FROM notifications;

-- 未读通知数
SELECT COUNT(*) FROM notifications WHERE is_read = false;

-- 按类型统计
SELECT type, COUNT(*) 
FROM notifications 
GROUP BY type;

-- 按分类统计
SELECT category, COUNT(*) 
FROM notifications 
GROUP BY category;
```

### 清理旧通知

```sql
-- 删除30天前的已读通知
DELETE FROM notifications
WHERE is_read = true
AND created_at < NOW() - INTERVAL '30 days';

-- 删除90天前的所有通知
DELETE FROM notifications
WHERE created_at < NOW() - INTERVAL '90 days';
```

---

## 🎨 自定义通知

### 添加自定义通知函数

```sql
CREATE OR REPLACE FUNCTION create_custom_notification(
  p_user_id uuid,
  p_type text,
  p_category text,
  p_title text,
  p_message text,
  p_link text DEFAULT NULL
)
RETURNS uuid
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_notification_id uuid;
BEGIN
  INSERT INTO notifications (
    user_id, type, category, title, message, link
  ) VALUES (
    p_user_id, p_type, p_category, p_title, p_message, p_link
  )
  RETURNING id INTO v_notification_id;
  
  RETURN v_notification_id;
END;
$$;

-- 使用示例
SELECT create_custom_notification(
  'user-id',
  'success',
  'business',
  '导入完成',
  '成功导入100条运单数据',
  '/m/business-entry'
);
```

---

## ⚡ 性能优化

### 已实现的优化

1. **数据库索引** ✅
   - user_id索引
   - is_read索引
   - created_at索引
   - 复合索引

2. **前端缓存** ✅
   - 30秒缓存策略
   - React Query管理
   - 智能刷新

3. **查询优化** ✅
   - 限制返回数量
   - 只查询需要的字段
   - RLS策略高效

---

## 🎉 总结

### 修复前
- ❌ 假数据（mockNotifications）
- ❌ 数据不准确
- ❌ 操作不保存
- ❌ 所有用户看相同数据

### 修复后
- ✅ 真实数据（数据库）
- ✅ 数据准确
- ✅ 操作持久化
- ✅ 用户隔离
- ✅ 自动通知
- ✅ 实时刷新

### 使用步骤
1. 执行SQL创建通知系统（2分钟）
2. 创建测试通知验证（1分钟）
3. 访问通知页面查看（30秒）

**总耗时**: 约3.5分钟

---

**通知系统现在使用真实数据，准确可靠！** 🎉

需要帮助？查看 [移动端通知系统修复说明.md](./移动端通知系统修复说明.md)

---

*快速指南 | 2025年1月8日*

