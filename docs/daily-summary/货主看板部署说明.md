# 货主看板 - 部署说明

## 📦 部署清单

### ✅ 已完成的工作

#### 1. 数据库层
- [x] 创建统计函数：`supabase/migrations/20250122_create_shipper_dashboard_functions.sql`
  - `get_shipper_dashboard_stats()` - 获取总体统计
  - `get_subordinate_shippers_stats()` - 获取下级货主列表
  - `get_shipper_trend_data()` - 获取趋势数据
  - `get_shipper_top_routes()` - 获取Top路线
  - `get_shipper_project_distribution()` - 获取项目分布

#### 2. 前端页面
- [x] 桌面端：`src/pages/ShipperDashboard.tsx`
- [x] 移动端：`src/pages/mobile/MobileShipperDashboard.tsx`

#### 3. 路由配置
- [x] 桌面端路由：`/dashboard/shipper`
- [x] 移动端路由：`/m/dashboard/shipper`
- [x] 更新 `src/App.tsx`

#### 4. 导航菜单
- [x] 桌面端菜单：`src/components/AppSidebar.tsx`
- [x] 移动端菜单：`src/components/mobile/MobileLayout.tsx`
- [x] 菜单项：数据看板 → 货主看板

#### 5. 文档
- [x] 设计方案：`货主看板设计方案.md`
- [x] 使用指南：`货主看板使用指南.md`
- [x] 部署说明：`货主看板部署说明.md`（本文件）

## 🚀 部署步骤

### 第一步：部署数据库迁移

1. **连接到 Supabase**
   ```bash
   # 确保已登录 Supabase CLI
   supabase login
   
   # 连接到项目
   supabase link --project-ref <your-project-ref>
   ```

2. **执行迁移文件**
   ```bash
   # 方法1：使用 Supabase CLI（推荐）
   supabase db push
   
   # 方法2：手动执行
   # 在 Supabase Dashboard → SQL Editor 中执行
   # supabase/migrations/20250122_create_shipper_dashboard_functions.sql
   ```

3. **验证函数创建**
   ```sql
   -- 在 Supabase SQL Editor 中执行
   SELECT routine_name 
   FROM information_schema.routines 
   WHERE routine_name LIKE '%shipper%'
   ORDER BY routine_name;
   
   -- 应该看到以下函数：
   -- ✓ get_shipper_dashboard_stats
   -- ✓ get_shipper_project_distribution
   -- ✓ get_shipper_top_routes
   -- ✓ get_shipper_trend_data
   -- ✓ get_subordinate_shippers_stats
   ```

### 第二步：部署前端代码

1. **提交代码到 Git**
   ```bash
   git add .
   git commit -m "添加货主看板功能"
   git push origin main
   ```

2. **构建前端**
   ```bash
   npm run build
   ```

3. **部署到生产环境**
   - 如果使用 Vercel/Netlify，会自动部署
   - 如果使用自己的服务器，上传 `dist` 目录

### 第三步：配置权限

1. **确保数据库权限策略正确**
   ```sql
   -- 检查 partners 表的 RLS 策略
   SELECT * FROM pg_policies WHERE tablename = 'partners';
   
   -- 检查 logistics_records 表的 RLS 策略
   SELECT * FROM pg_policies WHERE tablename = 'logistics_records';
   ```

2. **配置菜单权限**
   - 在 Supabase Dashboard 或权限管理页面
   - 添加 `dashboard.shipper` 权限键
   - 分配给需要访问的角色

### 第四步：测试验证

1. **测试桌面端访问**
   - 使用货主账号登录
   - 访问：`https://your-domain.com/dashboard/shipper`
   - 验证数据加载正常

2. **测试移动端访问**
   - 使用手机或调整浏览器窗口
   - 访问：`https://your-domain.com/m/dashboard/shipper`
   - 验证响应式布局

3. **测试权限控制**
   - 使用非货主账号登录
   - 应显示"权限不足"提示
   - 验证数据隔离正确

4. **测试数据功能**
   - 筛选时间范围
   - 查看趋势图表
   - 查看下级货主列表
   - 导出报表（功能开发中）

## 📋 验证检查清单

### 数据库验证
- [ ] 5个数据库函数已创建
- [ ] 函数可以正常执行
- [ ] 权限策略配置正确
- [ ] 测试数据准确

### 前端验证
- [ ] 桌面端页面正常显示
- [ ] 移动端页面正常显示
- [ ] 菜单入口可见
- [ ] 路由跳转正常
- [ ] 图表渲染正常
- [ ] 筛选功能正常

### 权限验证
- [ ] 货主用户可以访问
- [ ] 非货主用户被拒绝
- [ ] 数据隔离正确
- [ ] 只能看到本级和下级数据

### 功能验证
- [ ] 总体统计显示正确
- [ ] 待处理事项提醒正常
- [ ] 趋势图表加载正常
- [ ] 下级货主列表显示正确
- [ ] 项目分布显示正确
- [ ] Top路线显示正确

## ⚠️ 注意事项

### 1. 数据准备
确保以下数据已正确配置：
- ✅ `partners` 表中有 `partner_type = '货主'` 的记录
- ✅ 货主的层级关系已配置（`parent_partner_id`, `hierarchy_path`）
- ✅ 项目已关联货主（`project_partners` 表）
- ✅ 运单已录入系统（`logistics_records` 表）

### 2. 用户配置
确保货主用户已正确配置：
- ✅ 用户账号的 `partnerId` 指向货主记录
- ✅ 用户角色有访问权限（admin/finance/business/viewer）
- ✅ 菜单权限已分配

### 3. 性能考虑
- 🔍 如果货主数量很多（>1000），考虑添加分页
- 🔍 如果数据量很大，考虑添加缓存
- 🔍 监控数据库函数的执行时间

### 4. 兼容性
- ✅ 支持 Chrome、Firefox、Safari、Edge
- ✅ 移动端支持 iOS 和 Android
- ✅ 平板端自动使用移动端界面

## 🔧 故障排查

### 问题1：函数创建失败
**错误信息**：`ERROR: function does not exist`

**解决方法**：
1. 检查迁移文件是否完整
2. 确认 Supabase 连接正常
3. 手动在 SQL Editor 中执行
4. 检查函数依赖的表是否存在

### 问题2：页面显示"权限不足"
**原因**：用户不是货主类型或无访问权限

**解决方法**：
1. 检查用户的 `partnerId` 是否指向货主
2. 确认货主的 `partner_type = '货主'`
3. 检查用户角色权限
4. 查看菜单权限配置

### 问题3：数据显示为0或为空
**原因**：数据未正确关联或时间范围内无数据

**解决方法**：
1. 调整时间范围重新查看
2. 检查项目是否关联货主
3. 确认运单已录入
4. 验证层级关系配置

### 问题4：图表不显示
**原因**：数据格式不正确或图表库加载失败

**解决方法**：
1. 检查浏览器控制台错误
2. 确认 recharts 库已安装
3. 验证数据格式正确
4. 刷新页面重新加载

### 问题5：移动端布局错误
**原因**：CSS未正确加载或设备检测失败

**解决方法**：
1. 清除浏览器缓存
2. 检查 Tailwind CSS 配置
3. 验证设备检测逻辑
4. 测试不同屏幕尺寸

## 📊 性能指标

### 预期性能
- **页面加载时间**：< 2秒
- **数据查询时间**：< 1秒
- **图表渲染时间**：< 500ms
- **菜单响应时间**：< 100ms

### 监控建议
1. 使用 Supabase Dashboard 监控函数执行时间
2. 使用浏览器 Performance 工具分析前端性能
3. 监控数据库查询日志
4. 设置告警阈值

## 🔄 后续优化

### 短期优化（1-2周）
- [ ] 添加数据导出功能（Excel/PDF）
- [ ] 添加数据刷新动画
- [ ] 优化移动端加载速度
- [ ] 添加错误边界处理

### 中期优化（1个月）
- [ ] 添加数据缓存机制
- [ ] 实现下级货主详情弹窗
- [ ] 添加自定义日期范围选择
- [ ] 支持数据对比功能

### 长期优化（3个月）
- [ ] 添加实时数据推送
- [ ] 实现数据预测功能
- [ ] 添加自定义报表功能
- [ ] 支持多维度数据分析

## 📞 技术支持

### 开发团队联系方式
- **前端开发**：[联系方式]
- **后端开发**：[联系方式]
- **数据库管理**：[联系方式]
- **测试团队**：[联系方式]

### 支持渠道
- 📧 邮件支持：support@example.com
- 💬 在线聊天：[链接]
- 📞 电话支持：[电话]
- 📝 工单系统：[链接]

## 📚 相关文档

- [货主看板设计方案](./货主看板设计方案.md)
- [货主看板使用指南](./货主看板使用指南.md)
- [货主层级管理文档](./货主层级管理功能更新说明.md)
- [数据库迁移指南](./数据库迁移执行顺序说明.md)

---

**部署版本**：v1.0.0  
**部署日期**：2025-01-22  
**部署人员**：AI Assistant  
**审核状态**：待审核

祝部署顺利！🎉

