# 运单验重逻辑说明

## 📋 概述

系统使用8个关键字段来判断运单记录是否为重复数据。当一条记录中的这8个字段与数据库中某条现有运单记录完全匹配时，该记录将被识别为"重复数据"。

## 🔍 验重字段（8个必填字段）

| 序号 | 字段名 | 数据库字段 | 说明 | 示例 |
|------|--------|------------|------|------|
| 1 | 项目名称 | `project_name` | 运单所属项目 | 示例项目A |
| 2 | 合作链路 | `chain_id` | 根据Excel中的文本名称找到partner_chains表中的对应ID | 默认链路 |
| 3 | 司机姓名 | `driver_name` | 司机姓名 | 张三 |
| 4 | 车牌号 | `license_plate` | 车辆车牌号 | 京A12345 |
| 5 | 装货地点 | `loading_location` | 装货地点名称 | 北京仓库 |
| 6 | 卸货地点 | `unloading_location` | 卸货地点名称 | 上海仓库 |
| 7 | 装货日期 | `loading_date` | 装货日期 | 2025-01-20 |
| 8 | 装货数量 | `loading_weight` | 装货数量 | 25.5 |

## ⚠️ 重要说明

### 1. **必填字段**
- 这8个字段都是**必填字段**
- 如果任何一个字段为空，该记录将被标记为"错误记录"
- 系统会提示"缺少必填字段（8个关键字段）"

### 2. **完全匹配**
- 只有当这8个字段**完全匹配**时，才认为是重复数据
- 任何一个字段不同，都认为是不同的记录

### 3. **合作链路处理**
- 如果Excel中提供了合作链路名称，系统会查找对应的`partner_chains`表中的ID
- 如果合作链路名称为空，则`chain_id`为NULL
- 合作链路ID必须完全匹配才认为是重复

## 🔄 验重流程

### 1. **导入前检查**
```
Excel数据 → 验证8个必填字段 → 检查项目是否存在 → 查找合作链路ID → 验重检查
```

### 2. **分类结果**
- **新记录**：不重复的数据，可以直接导入
- **重复记录**：与现有数据重复，用户可以选择跳过或强制导入
- **错误记录**：数据格式错误或缺少必填字段

### 3. **用户选择**
- 对于重复记录，用户可以选择：
  - 跳过重复记录
  - 强制导入重复记录（覆盖现有数据）

## 📝 验重示例

### 示例1：重复数据
```
现有记录：
项目名称: 项目A, 合作链路: 默认链路, 司机: 张三, 车牌: 京A12345, 
装货地点: 北京, 卸货地点: 上海, 装货日期: 2025-01-20, 装货数量: 25.5

导入数据：
项目名称: 项目A, 合作链路: 默认链路, 司机: 张三, 车牌: 京A12345, 
装货地点: 北京, 卸货地点: 上海, 装货日期: 2025-01-20, 装货数量: 25.5

结果: ✅ 重复
```

### 示例2：不重复数据（装货数量不同）
```
现有记录：
项目名称: 项目A, 合作链路: 默认链路, 司机: 张三, 车牌: 京A12345, 
装货地点: 北京, 卸货地点: 上海, 装货日期: 2025-01-20, 装货数量: 25.5

导入数据：
项目名称: 项目A, 合作链路: 默认链路, 司机: 张三, 车牌: 京A12345, 
装货地点: 北京, 卸货地点: 上海, 装货日期: 2025-01-20, 装货数量: 30.0

结果: ❌ 不重复（装货数量不同）
```

### 示例3：不重复数据（装货日期不同）
```
现有记录：
项目名称: 项目A, 合作链路: 默认链路, 司机: 张三, 车牌: 京A12345, 
装货地点: 北京, 卸货地点: 上海, 装货日期: 2025-01-20, 装货数量: 25.5

导入数据：
项目名称: 项目A, 合作链路: 默认链路, 司机: 张三, 车牌: 京A12345, 
装货地点: 北京, 卸货地点: 上海, 装货日期: 2025-01-21, 装货数量: 25.5

结果: ❌ 不重复（装货日期不同）
```

## 🛠️ 技术实现

### 1. **数据库函数**
- `preview_import_with_duplicates_check(p_records jsonb)`：预览导入并检查重复
- `check_logistics_record_duplicate(...)`：检查单条记录是否重复

### 2. **前端验证**
- 导入前验证8个必填字段
- 显示验重结果和用户选择界面
- 支持批量处理重复记录

### 3. **SQL查询逻辑**
```sql
SELECT EXISTS (
    SELECT 1 FROM public.logistics_records lr
    WHERE
        lr.project_name = (record_data->>'project_name')                    -- 1. 项目名称
        AND lr.chain_id = chain_id_val                                     -- 2. 合作链路ID
        AND lr.driver_name = (record_data->>'driver_name')                 -- 3. 司机姓名
        AND lr.license_plate = (record_data->>'license_plate')             -- 4. 车牌号
        AND lr.loading_location = (record_data->>'loading_location')       -- 5. 装货地点
        AND lr.unloading_location = (record_data->>'unloading_location')   -- 6. 卸货地点
        AND lr.loading_date::date = loading_date_formatted::date           -- 7. 装货日期
        AND lr.loading_weight = (record_data->>'loading_weight')::numeric  -- 8. 装货数量
) INTO is_duplicate;
```

## 📊 模板字段说明

### 必填字段（用于验重）
- 项目名称*
- 司机姓名*
- 车牌号*
- 装货地点*
- 卸货地点*
- 装货日期*
- 装货数量*

### 可选字段
- 合作链路(可选)
- 司机电话(可选)
- 卸货日期(可选)
- 卸货数量(可选)
- 运费金额(可选)
- 额外费用(可选)
- 运输类型(可选)
- 备注(可选)
- 其他平台名称(可选)
- 其他平台运单号(可选)

## 🚀 使用建议

1. **确保数据完整性**：导入前确保8个必填字段都有值
2. **检查重复记录**：仔细查看重复记录，确认是否需要覆盖
3. **分批导入**：大量数据建议分批导入，便于处理重复记录
4. **备份数据**：重要数据导入前建议先备份

## 🔧 故障排除

### 常见问题
1. **"缺少必填字段"错误**：检查8个必填字段是否都有值
2. **"项目不存在"错误**：确认项目名称在系统中存在
3. **重复记录过多**：检查数据源，确认是否真的需要导入重复数据

### 解决方案
1. 检查Excel模板，确保必填字段都有值
2. 确认项目名称与系统中的完全一致
3. 对于重复记录，可以选择跳过或强制导入
