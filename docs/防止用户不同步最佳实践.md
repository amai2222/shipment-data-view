# 防止用户不同步 - 最佳实践

## 🎯 问题根源

Supabase 有两个独立的用户表：
- `auth.users` - 认证系统表
- `public.profiles` - 业务信息表

**如果不正确处理，会导致两个表不同步。**

---

## ✅ 正确做法

### 1. 创建用户

**✅ 使用 Edge Function**
```typescript
// 前端调用
const { data, error } = await supabase.functions.invoke('create-user', {
  body: {
    email: 'user@example.com',
    password: 'password',
    full_name: '用户姓名',
    role: 'viewer'
  }
});
```

**❌ 不要直接使用**
```typescript
// 错误！会导致不同步
await supabase.auth.signUp({...})
```

---

### 2. 删除用户

**✅ 使用更新后的 Edge Function**
```typescript
// 前端调用（已在 UserManagement.tsx 中实现）
const { data, error } = await supabase.functions.invoke('delete-user', {
  body: {
    userId: userId,
    hardDelete: true
  }
});
```

**❌ 绝对不要直接删除**
```typescript
// 错误！会导致孤立用户
await supabase.from('profiles').delete().eq('id', userId)
```

---

### 3. 更新用户

**✅ 同时更新两个表**
```typescript
// 1. 更新 profiles
await supabase.from('profiles').update({...}).eq('id', userId)

// 2. 如果需要更新邮箱，也要更新 auth.users
await supabase.auth.admin.updateUserById(userId, {
  email: newEmail
})
```

---

## 🛡️ 防护措施

### 已实施 ✅

1. **前端代码修复**
   - `src/components/permissions/UserManagement.tsx` 已修改
   - 统一使用 Edge Function 删除用户

2. **Edge Function 优化**
   - `supabase/functions/delete-user-v2/index.ts` （新版本）
   - 自动转移关联数据到管理员
   - 避免外键约束错误

3. **智能清理脚本**
   - `scripts/delete_all_orphaned_users_auto.sql`
   - 可以清理现有的孤立用户

### 建议实施 💡

1. **定期检查**
   ```sql
   -- 每周执行一次
   SELECT COUNT(*) as orphaned_count
   FROM auth.users au
   LEFT JOIN public.profiles p ON au.id = p.id
   WHERE p.id IS NULL;
   
   -- 应该返回 0
   ```

2. **数据库触发器**（可选）
   - 在 profiles 删除时自动清理 auth.users
   - 但要注意避免循环触发

3. **代码审查规范**
   - 禁止直接操作 `auth.users` 或 `profiles`
   - 必须通过 Edge Function
   - PR 审查时检查用户操作代码

---

## 📋 部署清单

### 立即部署

1. **部署新的 Edge Function**
   ```bash
   cd supabase/functions
   supabase functions deploy delete-user-v2
   ```

2. **更新前端调用**（已完成✅）
   - `src/components/permissions/UserManagement.tsx`

3. **测试删除功能**
   - 创建测试用户
   - 删除测试用户
   - 验证 auth.users 和 profiles 都被删除

### 定期维护

1. **每周检查**
   ```sql
   SELECT * FROM auth.users au
   LEFT JOIN public.profiles p ON au.id = p.id
   WHERE p.id IS NULL;
   ```

2. **如果发现孤立用户**
   ```bash
   # 执行智能清理脚本
   # scripts/delete_all_orphaned_users_auto.sql
   ```

---

## 🚫 禁止的操作

### ❌ 绝对不要这样做

1. **直接删除 profiles**
   ```sql
   DELETE FROM public.profiles WHERE id = 'xxx';  -- ❌ 错误
   ```

2. **直接创建 auth.users**
   ```typescript
   await supabase.auth.signUp({...})  // ❌ 错误
   ```

3. **手动修改数据库**
   ```sql
   -- ❌ 错误：在生产环境中手动删除
   DELETE FROM auth.users WHERE email = 'xxx';
   ```

---

## ✅ 正确的工作流程

### 创建用户流程

```
1. 前端提交 → 
2. Edge Function (create-user) → 
3. 创建 auth.users → 
4. 创建 profiles → 
5. 返回成功
```

### 删除用户流程

```
1. 前端提交 → 
2. Edge Function (delete-user-v2) → 
3. 转移关联数据到管理员 → 
4. 删除 profiles → 
5. 删除 auth.users → 
6. 返回成功
```

### 企业微信登录流程

```
1. 企业微信回调 → 
2. Edge Function (work-wechat-auth) → 
3. 检查 auth.users 是否存在 → 
4. 如果不存在，创建 auth.users → 
5. Upsert profiles → 
6. 返回登录凭证
```

---

## 📊 监控指标

### 健康指标

```sql
-- 1. auth.users 和 profiles 数量应该相等
SELECT 
    (SELECT COUNT(*) FROM auth.users) as auth_count,
    (SELECT COUNT(*) FROM public.profiles) as profile_count,
    CASE 
        WHEN (SELECT COUNT(*) FROM auth.users) = (SELECT COUNT(*) FROM public.profiles)
        THEN '✅ 健康'
        ELSE '❌ 不同步'
    END as status;

-- 2. 孤立用户应该为 0
SELECT COUNT(*) as orphaned_users
FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

---

## 🆘 故障恢复

### 如果出现不同步

1. **不要惊慌**
2. **执行智能清理脚本**
   ```sql
   -- scripts/delete_all_orphaned_users_auto.sql
   ```
3. **检查是否还有代码直接操作用户表**
4. **更新到最新的 Edge Function**

### 备份策略

```sql
-- 在执行任何清理前，先备份
CREATE TABLE auth_users_backup AS SELECT * FROM auth.users;
CREATE TABLE profiles_backup AS SELECT * FROM public.profiles;
```

---

## 📚 相关文档

- `docs/用户同步删除系统说明.md` - 技术详解
- `docs/快速开始-清理孤立用户.md` - 快速操作指南
- `修复用户同步问题-完整总结.md` - 问题总结

---

## 👥 团队培训

### 开发人员必读

1. ✅ 用户操作必须通过 Edge Function
2. ✅ 不要直接操作 `auth.users` 或 `profiles`
3. ✅ PR 审查时注意用户相关代码
4. ✅ 测试时验证两个表的同步

### 运维人员必做

1. ✅ 每周检查孤立用户
2. ✅ 定期备份用户表
3. ✅ 监控两个表的数量
4. ✅ 遇到问题及时清理

---

**最后更新**: 2025-11-01  
**状态**: ✅ 已实施

