# é˜²æ­¢ç”¨æˆ·ä¸åŒæ­¥ - æœ€ä½³å®è·µ

## ğŸ¯ é—®é¢˜æ ¹æº

Supabase æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„ç”¨æˆ·è¡¨ï¼š
- `auth.users` - è®¤è¯ç³»ç»Ÿè¡¨
- `public.profiles` - ä¸šåŠ¡ä¿¡æ¯è¡¨

**å¦‚æœä¸æ­£ç¡®å¤„ç†ï¼Œä¼šå¯¼è‡´ä¸¤ä¸ªè¡¨ä¸åŒæ­¥ã€‚**

---

## âœ… æ­£ç¡®åšæ³•

### 1. åˆ›å»ºç”¨æˆ·

**âœ… ä½¿ç”¨ Edge Function**
```typescript
// å‰ç«¯è°ƒç”¨
const { data, error } = await supabase.functions.invoke('create-user', {
  body: {
    email: 'user@example.com',
    password: 'password',
    full_name: 'ç”¨æˆ·å§“å',
    role: 'viewer'
  }
});
```

**âŒ ä¸è¦ç›´æ¥ä½¿ç”¨**
```typescript
// é”™è¯¯ï¼ä¼šå¯¼è‡´ä¸åŒæ­¥
await supabase.auth.signUp({...})
```

---

### 2. åˆ é™¤ç”¨æˆ·

**âœ… ä½¿ç”¨æ›´æ–°åçš„ Edge Function**
```typescript
// å‰ç«¯è°ƒç”¨ï¼ˆå·²åœ¨ UserManagement.tsx ä¸­å®ç°ï¼‰
const { data, error } = await supabase.functions.invoke('delete-user', {
  body: {
    userId: userId,
    hardDelete: true
  }
});
```

**âŒ ç»å¯¹ä¸è¦ç›´æ¥åˆ é™¤**
```typescript
// é”™è¯¯ï¼ä¼šå¯¼è‡´å­¤ç«‹ç”¨æˆ·
await supabase.from('profiles').delete().eq('id', userId)
```

---

### 3. æ›´æ–°ç”¨æˆ·

**âœ… åŒæ—¶æ›´æ–°ä¸¤ä¸ªè¡¨**
```typescript
// 1. æ›´æ–° profiles
await supabase.from('profiles').update({...}).eq('id', userId)

// 2. å¦‚æœéœ€è¦æ›´æ–°é‚®ç®±ï¼Œä¹Ÿè¦æ›´æ–° auth.users
await supabase.auth.admin.updateUserById(userId, {
  email: newEmail
})
```

---

## ğŸ›¡ï¸ é˜²æŠ¤æªæ–½

### å·²å®æ–½ âœ…

1. **å‰ç«¯ä»£ç ä¿®å¤**
   - `src/components/permissions/UserManagement.tsx` å·²ä¿®æ”¹
   - ç»Ÿä¸€ä½¿ç”¨ Edge Function åˆ é™¤ç”¨æˆ·

2. **Edge Function ä¼˜åŒ–**
   - `supabase/functions/delete-user-v2/index.ts` ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
   - è‡ªåŠ¨è½¬ç§»å…³è”æ•°æ®åˆ°ç®¡ç†å‘˜
   - é¿å…å¤–é”®çº¦æŸé”™è¯¯

3. **æ™ºèƒ½æ¸…ç†è„šæœ¬**
   - `scripts/delete_all_orphaned_users_auto.sql`
   - å¯ä»¥æ¸…ç†ç°æœ‰çš„å­¤ç«‹ç”¨æˆ·

### å»ºè®®å®æ–½ ğŸ’¡

1. **å®šæœŸæ£€æŸ¥**
   ```sql
   -- æ¯å‘¨æ‰§è¡Œä¸€æ¬¡
   SELECT COUNT(*) as orphaned_count
   FROM auth.users au
   LEFT JOIN public.profiles p ON au.id = p.id
   WHERE p.id IS NULL;
   
   -- åº”è¯¥è¿”å› 0
   ```

2. **æ•°æ®åº“è§¦å‘å™¨**ï¼ˆå¯é€‰ï¼‰
   - åœ¨ profiles åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç† auth.users
   - ä½†è¦æ³¨æ„é¿å…å¾ªç¯è§¦å‘

3. **ä»£ç å®¡æŸ¥è§„èŒƒ**
   - ç¦æ­¢ç›´æ¥æ“ä½œ `auth.users` æˆ– `profiles`
   - å¿…é¡»é€šè¿‡ Edge Function
   - PR å®¡æŸ¥æ—¶æ£€æŸ¥ç”¨æˆ·æ“ä½œä»£ç 

---

## ğŸ“‹ éƒ¨ç½²æ¸…å•

### ç«‹å³éƒ¨ç½²

1. **éƒ¨ç½²æ–°çš„ Edge Function**
   ```bash
   cd supabase/functions
   supabase functions deploy delete-user-v2
   ```

2. **æ›´æ–°å‰ç«¯è°ƒç”¨**ï¼ˆå·²å®Œæˆâœ…ï¼‰
   - `src/components/permissions/UserManagement.tsx`

3. **æµ‹è¯•åˆ é™¤åŠŸèƒ½**
   - åˆ›å»ºæµ‹è¯•ç”¨æˆ·
   - åˆ é™¤æµ‹è¯•ç”¨æˆ·
   - éªŒè¯ auth.users å’Œ profiles éƒ½è¢«åˆ é™¤

### å®šæœŸç»´æŠ¤

1. **æ¯å‘¨æ£€æŸ¥**
   ```sql
   SELECT * FROM auth.users au
   LEFT JOIN public.profiles p ON au.id = p.id
   WHERE p.id IS NULL;
   ```

2. **å¦‚æœå‘ç°å­¤ç«‹ç”¨æˆ·**
   ```bash
   # æ‰§è¡Œæ™ºèƒ½æ¸…ç†è„šæœ¬
   # scripts/delete_all_orphaned_users_auto.sql
   ```

---

## ğŸš« ç¦æ­¢çš„æ“ä½œ

### âŒ ç»å¯¹ä¸è¦è¿™æ ·åš

1. **ç›´æ¥åˆ é™¤ profiles**
   ```sql
   DELETE FROM public.profiles WHERE id = 'xxx';  -- âŒ é”™è¯¯
   ```

2. **ç›´æ¥åˆ›å»º auth.users**
   ```typescript
   await supabase.auth.signUp({...})  // âŒ é”™è¯¯
   ```

3. **æ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“**
   ```sql
   -- âŒ é”™è¯¯ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ‰‹åŠ¨åˆ é™¤
   DELETE FROM auth.users WHERE email = 'xxx';
   ```

---

## âœ… æ­£ç¡®çš„å·¥ä½œæµç¨‹

### åˆ›å»ºç”¨æˆ·æµç¨‹

```
1. å‰ç«¯æäº¤ â†’ 
2. Edge Function (create-user) â†’ 
3. åˆ›å»º auth.users â†’ 
4. åˆ›å»º profiles â†’ 
5. è¿”å›æˆåŠŸ
```

### åˆ é™¤ç”¨æˆ·æµç¨‹

```
1. å‰ç«¯æäº¤ â†’ 
2. Edge Function (delete-user-v2) â†’ 
3. è½¬ç§»å…³è”æ•°æ®åˆ°ç®¡ç†å‘˜ â†’ 
4. åˆ é™¤ profiles â†’ 
5. åˆ é™¤ auth.users â†’ 
6. è¿”å›æˆåŠŸ
```

### ä¼ä¸šå¾®ä¿¡ç™»å½•æµç¨‹

```
1. ä¼ä¸šå¾®ä¿¡å›è°ƒ â†’ 
2. Edge Function (work-wechat-auth) â†’ 
3. æ£€æŸ¥ auth.users æ˜¯å¦å­˜åœ¨ â†’ 
4. å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»º auth.users â†’ 
5. Upsert profiles â†’ 
6. è¿”å›ç™»å½•å‡­è¯
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å¥åº·æŒ‡æ ‡

```sql
-- 1. auth.users å’Œ profiles æ•°é‡åº”è¯¥ç›¸ç­‰
SELECT 
    (SELECT COUNT(*) FROM auth.users) as auth_count,
    (SELECT COUNT(*) FROM public.profiles) as profile_count,
    CASE 
        WHEN (SELECT COUNT(*) FROM auth.users) = (SELECT COUNT(*) FROM public.profiles)
        THEN 'âœ… å¥åº·'
        ELSE 'âŒ ä¸åŒæ­¥'
    END as status;

-- 2. å­¤ç«‹ç”¨æˆ·åº”è¯¥ä¸º 0
SELECT COUNT(*) as orphaned_users
FROM auth.users au
LEFT JOIN public.profiles p ON au.id = p.id
WHERE p.id IS NULL;
```

---

## ğŸ†˜ æ•…éšœæ¢å¤

### å¦‚æœå‡ºç°ä¸åŒæ­¥

1. **ä¸è¦æƒŠæ…Œ**
2. **æ‰§è¡Œæ™ºèƒ½æ¸…ç†è„šæœ¬**
   ```sql
   -- scripts/delete_all_orphaned_users_auto.sql
   ```
3. **æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä»£ç ç›´æ¥æ“ä½œç”¨æˆ·è¡¨**
4. **æ›´æ–°åˆ°æœ€æ–°çš„ Edge Function**

### å¤‡ä»½ç­–ç•¥

```sql
-- åœ¨æ‰§è¡Œä»»ä½•æ¸…ç†å‰ï¼Œå…ˆå¤‡ä»½
CREATE TABLE auth_users_backup AS SELECT * FROM auth.users;
CREATE TABLE profiles_backup AS SELECT * FROM public.profiles;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/ç”¨æˆ·åŒæ­¥åˆ é™¤ç³»ç»Ÿè¯´æ˜.md` - æŠ€æœ¯è¯¦è§£
- `docs/å¿«é€Ÿå¼€å§‹-æ¸…ç†å­¤ç«‹ç”¨æˆ·.md` - å¿«é€Ÿæ“ä½œæŒ‡å—
- `ä¿®å¤ç”¨æˆ·åŒæ­¥é—®é¢˜-å®Œæ•´æ€»ç»“.md` - é—®é¢˜æ€»ç»“

---

## ğŸ‘¥ å›¢é˜ŸåŸ¹è®­

### å¼€å‘äººå‘˜å¿…è¯»

1. âœ… ç”¨æˆ·æ“ä½œå¿…é¡»é€šè¿‡ Edge Function
2. âœ… ä¸è¦ç›´æ¥æ“ä½œ `auth.users` æˆ– `profiles`
3. âœ… PR å®¡æŸ¥æ—¶æ³¨æ„ç”¨æˆ·ç›¸å…³ä»£ç 
4. âœ… æµ‹è¯•æ—¶éªŒè¯ä¸¤ä¸ªè¡¨çš„åŒæ­¥

### è¿ç»´äººå‘˜å¿…åš

1. âœ… æ¯å‘¨æ£€æŸ¥å­¤ç«‹ç”¨æˆ·
2. âœ… å®šæœŸå¤‡ä»½ç”¨æˆ·è¡¨
3. âœ… ç›‘æ§ä¸¤ä¸ªè¡¨çš„æ•°é‡
4. âœ… é‡åˆ°é—®é¢˜åŠæ—¶æ¸…ç†

---

**æœ€åæ›´æ–°**: 2025-11-01  
**çŠ¶æ€**: âœ… å·²å®æ–½

