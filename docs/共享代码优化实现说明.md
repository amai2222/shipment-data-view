# å…±äº«ä»£ç ä¼˜åŒ–å®ç°è¯´æ˜

## âœ… ä¼˜åŒ–å®Œæˆ

å·²æˆåŠŸå®ç°å…±äº«ä»£ç æ¨¡å—ä¼˜åŒ–ï¼Œæ‰€æœ‰ Edge Functions ç°åœ¨ç›´æ¥å¯¼å…¥å…±äº«æ¨¡å—ï¼Œé¿å…äº† HTTP è°ƒç”¨å¼€é”€ã€‚

## ğŸ“Š ä¼˜åŒ–å‰åå¯¹æ¯”

### ä¼˜åŒ–å‰ï¼ˆHTTP è°ƒç”¨ï¼‰

```
å…¶ä»– Edge Functions
    â†“ HTTP è°ƒç”¨ï¼ˆ~20-70ms å¼€é”€ï¼‰
get-tracking-token Edge Function
    â†“
1. å†…å­˜ç¼“å­˜
2. æ•°æ®åº“ç¼“å­˜
3. è‡ªåŠ¨ç™»å½•
```

**å»¶è¿Ÿ**ï¼š~70-115msï¼ˆæ•°æ®åº“ç¼“å­˜å‘½ä¸­æ—¶ï¼‰

### ä¼˜åŒ–åï¼ˆå…±äº«æ¨¡å—ï¼‰

```
å…¶ä»– Edge Functions
    â†“ ç›´æ¥å¯¼å…¥ï¼ˆæ—  HTTP å¼€é”€ï¼‰
_shared/token-cache.ts
    â†“
1. å†…å­˜ç¼“å­˜
2. æ•°æ®åº“ç¼“å­˜
3. è‡ªåŠ¨ç™»å½•
```

**å»¶è¿Ÿ**ï¼š~20-45msï¼ˆæ•°æ®åº“ç¼“å­˜å‘½ä¸­æ—¶ï¼‰

**æ€§èƒ½æå‡**ï¼š**2-3å€** âš¡

## ğŸ—ï¸ æ¶æ„å˜æ›´

### 1. åˆ›å»ºå…±äº«æ¨¡å—

**æ–‡ä»¶**ï¼š`supabase/functions/_shared/token-cache.ts`

**åŠŸèƒ½**ï¼š
- å¯¼å‡º `getToken(type: 'add' | 'query')` å‡½æ•°
- å¯¼å‡º `getTokenWithInfo(type: 'add' | 'query')` å‡½æ•°ï¼ˆç”¨äº get-tracking-tokenï¼‰
- åŒ…å«æ‰€æœ‰ Token è·å–å’Œç¼“å­˜é€»è¾‘

### 2. æ›´æ–° get-tracking-token

**å˜æ›´**ï¼š
- ä½¿ç”¨å…±äº«æ¨¡å— `getTokenWithInfo`
- ä¿ç•™ä½œä¸ºç‹¬ç«‹æœåŠ¡ï¼ˆç”¨äºå‰ç«¯æ‰‹åŠ¨åˆ·æ–°ï¼‰

### 3. æ›´æ–°å…¶ä»–å››ä¸ª Edge Functions

**å·²æ›´æ–°çš„å‡½æ•°**ï¼š
1. âœ… `add-vehicle` - ç›´æ¥å¯¼å…¥ `getToken('add')`
2. âœ… `vehicle-tracking` - ç›´æ¥å¯¼å…¥ `getToken('query')`
3. âœ… `sync-vehicle-tracking-ids` - ç›´æ¥å¯¼å…¥ `getToken('query')`
4. âœ… `sync-vehicle` - ç›´æ¥å¯¼å…¥ `getToken('add')` å’Œ `getToken('query')`

**å˜æ›´**ï¼š
- ç§»é™¤ HTTP è°ƒç”¨ä»£ç 
- ç›´æ¥å¯¼å…¥å…±äº«æ¨¡å—
- æ›´æ–°é”™è¯¯æç¤ºä¿¡æ¯

## ğŸ“ ä»£ç ç¤ºä¾‹

### å…±äº«æ¨¡å—ä½¿ç”¨

```typescript
// supabase/functions/add-vehicle/index.ts
import { getToken } from '../_shared/token-cache.ts';

// ç›´æ¥è°ƒç”¨ï¼Œæ—  HTTP å¼€é”€
const token = await getToken('add');
```

### get-tracking-token ä½¿ç”¨

```typescript
// supabase/functions/get-tracking-token/index.ts
import { getTokenWithInfo } from '../_shared/token-cache.ts';

// è·å– Token å’Œè¯¦ç»†ä¿¡æ¯
const { token, expiresAt } = await getTokenWithInfo(type);
```

## ğŸ¯ ä¼˜åŠ¿

### 1. æ€§èƒ½æå‡

- âœ… **å‡å°‘å»¶è¿Ÿ**ï¼šä» ~70-115ms é™è‡³ ~20-45ms
- âœ… **é¿å… HTTP å¼€é”€**ï¼šæ— ç½‘ç»œè°ƒç”¨ã€åºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… **ç›´æ¥æ•°æ®åº“è®¿é—®**ï¼šå‡å°‘ä¸­é—´å±‚

### 2. ä»£ç è´¨é‡

- âœ… **ä»£ç å¤ç”¨**ï¼šæ‰€æœ‰é€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹
- âœ… **æ˜“äºç»´æŠ¤**ï¼šä¿®æ”¹åªéœ€æ›´æ–°å…±äº«æ¨¡å—
- âœ… **ç±»å‹å®‰å…¨**ï¼šTypeScript ç±»å‹æ£€æŸ¥

### 3. æ¶æ„ä¼˜åŒ–

- âœ… **ç¬¦åˆ Supabase æ¨è**ï¼šä½¿ç”¨ `_shared` ç›®å½•
- âœ… **ç¬¦åˆä¸»æµè§„èŒƒ**ï¼šå…±äº«ä»£ç æ¨¡å—æ˜¯ Serverless æœ€ä½³å®è·µ
- âœ… **å‘åå…¼å®¹**ï¼šä¿ç•™ `get-tracking-token` ä½œä¸ºç‹¬ç«‹æœåŠ¡

## ğŸ”„ å·¥ä½œæµç¨‹

### æ­£å¸¸æµç¨‹ï¼ˆæ•°æ®åº“ä¸­æœ‰æœ‰æ•ˆ Tokenï¼‰

```
ç”¨æˆ·è¯·æ±‚ â†’ add-vehicle
    â†“
ç›´æ¥è°ƒç”¨ getToken('add')
    â†“
_shared/token-cache.ts:
    1. æ£€æŸ¥å†…å­˜ç¼“å­˜ â†’ ç©ºï¼ˆæ–°å®ä¾‹ï¼‰
    2. æ£€æŸ¥æ•°æ®åº“ç¼“å­˜ â†’ âœ… æ‰¾åˆ°æœ‰æ•ˆ Token
    3. æ›´æ–°å†…å­˜ç¼“å­˜
    4. è¿”å› Token
    â†“
add-vehicle ä½¿ç”¨ Token è°ƒç”¨ç¬¬ä¸‰æ–¹ API
```

**å»¶è¿Ÿ**ï¼š~20-45msï¼ˆä»…æ•°æ®åº“æŸ¥è¯¢ï¼‰

### Token è¿‡æœŸæµç¨‹

```
ç”¨æˆ·è¯·æ±‚ â†’ add-vehicle
    â†“
ä½¿ç”¨ Token è°ƒç”¨ç¬¬ä¸‰æ–¹ API
    â†“
è¿”å› 401/403ï¼ˆToken è¿‡æœŸï¼‰
    â†“
é‡æ–°è°ƒç”¨ getToken('add')
    â†“
_shared/token-cache.ts:
    1. æ£€æŸ¥å†…å­˜ç¼“å­˜ â†’ å·²è¿‡æœŸ
    2. æ£€æŸ¥æ•°æ®åº“ç¼“å­˜ â†’ å·²è¿‡æœŸ
    3. æ‰§è¡Œç™»å½• â†’ è·å–æ–° Token
    4. ä¿å­˜åˆ°æ•°æ®åº“ âœ…
    5. æ›´æ–°å†…å­˜ç¼“å­˜
    6. è¿”å›æ–° Token
    â†“
add-vehicle ä½¿ç”¨æ–° Token é‡è¯•
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### æ•°æ®åº“ç¼“å­˜å‘½ä¸­

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **å»¶è¿Ÿ** | ~70-115ms | ~20-45ms | **2-3å€** |
| **HTTP è°ƒç”¨** | æœ‰ | æ—  | âœ… |
| **æ•°æ®åº“æŸ¥è¯¢** | æœ‰ | æœ‰ | - |

### éœ€è¦ç™»å½•

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **å»¶è¿Ÿ** | ~1070-1115ms | ~1020-1045ms | **~50ms** |
| **HTTP è°ƒç”¨** | æœ‰ | æ—  | âœ… |
| **ç™»å½•æ—¶é—´** | ~1000ms | ~1000ms | - |

## ğŸ” éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥å¯¼å…¥

```typescript
// æ‰€æœ‰å‡½æ•°éƒ½åº”è¯¥å¯¼å…¥å…±äº«æ¨¡å—
import { getToken } from '../_shared/token-cache.ts';
```

### 2. æ£€æŸ¥æ—¥å¿—

ä¼˜åŒ–åçš„æ—¥å¿—åº”è¯¥æ˜¾ç¤ºï¼š
```
âœ… ä»å…±äº«æ¨¡å—è·å–åˆ° Token
```

è€Œä¸æ˜¯ï¼š
```
âœ… ä» get-tracking-token æœåŠ¡è·å–åˆ° Token
```

### 3. æ€§èƒ½æµ‹è¯•

- é¦–æ¬¡è°ƒç”¨ï¼šåº”è¯¥æ‰§è¡Œç™»å½•ï¼ˆ~1000msï¼‰
- åç»­è°ƒç”¨ï¼šåº”è¯¥ä»æ•°æ®åº“è¯»å–ï¼ˆ~20-45msï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç¯å¢ƒå˜é‡

å…±äº«æ¨¡å—éœ€è¦ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `PWD_ADD` æˆ– `TRACKING_ADD_PASSWORD`ï¼ˆå¯é€‰ï¼‰
- `PWD_QUERY` æˆ– `TRACKING_QUERY_PASSWORD`ï¼ˆå¯é€‰ï¼‰

### 2. æ•°æ®åº“è¡¨

ç¡®ä¿ `tracking_token_cache` è¡¨å·²åˆ›å»ºï¼š
```sql
-- æ‰§è¡Œè¿ç§»æ–‡ä»¶
supabase/migrations/20250116_create_tracking_token_cache.sql
```

### 3. å‘åå…¼å®¹

- âœ… `get-tracking-token` ä½œä¸ºç‹¬ç«‹æœåŠ¡ä¿ç•™
- âœ… å‰ç«¯æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½æ­£å¸¸
- âœ… ç¯å¢ƒå˜é‡é™çº§æ–¹æ¡ˆä¿ç•™

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. éƒ¨ç½²å…±äº«æ¨¡å—

å…±äº«æ¨¡å—ä¼šè‡ªåŠ¨éš Edge Functions ä¸€èµ·éƒ¨ç½²ï¼Œæ— éœ€å•ç‹¬éƒ¨ç½²ã€‚

### 2. éƒ¨ç½²æ›´æ–°çš„å‡½æ•°

```bash
supabase functions deploy get-tracking-token
supabase functions deploy add-vehicle
supabase functions deploy vehicle-tracking
supabase functions deploy sync-vehicle-tracking-ids
supabase functions deploy sync-vehicle
```

### 3. éªŒè¯éƒ¨ç½²

- æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "ä»å…±äº«æ¨¡å—è·å–åˆ° Token"
- æµ‹è¯• Token è·å–æ€§èƒ½
- éªŒè¯ Token ç¼“å­˜åŠŸèƒ½

## âœ… å®Œæˆæ¸…å•

- [x] åˆ›å»ºå…±äº«æ¨¡å— `_shared/token-cache.ts`
- [x] æ›´æ–° `get-tracking-token/index.ts` ä½¿ç”¨å…±äº«æ¨¡å—
- [x] æ›´æ–° `add-vehicle/index.ts` ç›´æ¥å¯¼å…¥å…±äº«æ¨¡å—
- [x] æ›´æ–° `vehicle-tracking/index.ts` ç›´æ¥å¯¼å…¥å…±äº«æ¨¡å—
- [x] æ›´æ–° `sync-vehicle-tracking-ids/index.ts` ç›´æ¥å¯¼å…¥å…±äº«æ¨¡å—
- [x] æ›´æ–° `sync-vehicle/index.ts` ç›´æ¥å¯¼å…¥å…±äº«æ¨¡å—
- [x] æ›´æ–°æ‰€æœ‰é‡è¯•é€»è¾‘ä½¿ç”¨å…±äº«æ¨¡å—
- [x] ä¿ç•™ `get-tracking-token` ä½œä¸ºç‹¬ç«‹æœåŠ¡

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

1. **æ€§èƒ½æå‡**ï¼šToken è·å–å»¶è¿Ÿå‡å°‘ 2-3å€
2. **ä»£ç è´¨é‡**ï¼šä»£ç æ›´ç®€æ´ï¼Œæ˜“äºç»´æŠ¤
3. **æ¶æ„ä¼˜åŒ–**ï¼šç¬¦åˆ Supabase å’Œä¸»æµæœ€ä½³å®è·µ

---

**æœ€åæ›´æ–°**ï¼š2025-01-16  
**çŠ¶æ€**ï¼šâœ… ä¼˜åŒ–å®Œæˆï¼Œå¾…éƒ¨ç½²éªŒè¯

