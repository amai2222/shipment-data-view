# 移动端优化完整指南

## 📱 概述

本系统已全面优化移动端体验,包含以下核心功能:
- ✅ 下拉刷新
- ✅ 无限滚动加载
- ✅ 滑动手势操作
- ✅ 触摸反馈优化
- ✅ 骨架屏加载
- ✅ 离线状态处理
- ✅ 安全区域适配(刘海屏)
- ✅ 虚拟列表性能优化

## 📚 目录

1. [新增Hooks](#新增hooks)
2. [新增组件](#新增组件)
3. [工具函数](#工具函数)
4. [使用示例](#使用示例)
5. [最佳实践](#最佳实践)

---

## 🎣 新增Hooks

### 1. usePullToRefresh - 下拉刷新

```typescript
import { usePullToRefresh } from '@/hooks/usePullToRefresh';

function MyComponent() {
  const {
    containerRef,
    isPulling,
    isRefreshing,
    pullDistance,
    pullProgress
  } = usePullToRefresh({
    onRefresh: async () => {
      await fetchData();
    },
    threshold: 80,
    resistance: 2.5,
    enabled: true
  });

  return <div ref={containerRef}>...</div>;
}
```

### 2. useInfiniteScroll - 无限滚动

```typescript
import { useInfiniteScroll } from '@/hooks/useInfiniteScroll';

function MyList() {
  const {
    containerRef,
    sentinelRef,
    isLoading
  } = useInfiniteScroll({
    onLoadMore: async () => {
      await loadMoreData();
    },
    hasMore: true,
    threshold: 200,
    enabled: true
  });

  return (
    <div ref={containerRef}>
      {items.map(item => <Item key={item.id} {...item} />)}
      <div ref={sentinelRef} />
    </div>
  );
}
```

### 3. useSwipeGesture - 滑动手势

```typescript
import { useSwipeGesture } from '@/hooks/useSwipeGesture';

function SwipeableItem() {
  const { elementRef, swipeDirection } = useSwipeGesture({
    onSwipeLeft: () => console.log('向左滑动'),
    onSwipeRight: () => console.log('向右滑动'),
    minSwipeDistance: 50,
    maxSwipeTime: 300
  });

  return <div ref={elementRef}>滑动我</div>;
}
```

### 4. useMobileOptimization - 移动端优化

```typescript
import { useMobileOptimization } from '@/hooks/useMobileOptimization';

function MyComponent() {
  const {
    isMobile,
    isTablet,
    isSlowConnection,
    isOnline,
    shouldReduceMotion,
    shouldLazyLoad,
    shouldUseVirtualList
  } = useMobileOptimization();

  // 根据网络状况调整加载策略
  if (isSlowConnection) {
    // 降低图片质量或延迟加载
  }

  return <div>...</div>;
}
```

### 5. useHapticFeedback - 触觉反馈

```typescript
import { useHapticFeedback } from '@/hooks/useMobileOptimization';

function MyButton() {
  const haptic = useHapticFeedback();

  const handleClick = () => {
    haptic.lightImpact(); // 轻触反馈
    // 或: haptic.success(), haptic.warning(), haptic.error()
  };

  return <button onClick={handleClick}>点击我</button>;
}
```

---

## 🧩 新增组件

### 1. MobilePullToRefresh - 下拉刷新容器

```tsx
import { MobilePullToRefresh } from '@/components/mobile/MobilePullToRefresh';

<MobilePullToRefresh
  onRefresh={async () => {
    await fetchData();
  }}
  threshold={80}
  enabled={true}
>
  <YourContent />
</MobilePullToRefresh>
```

### 2. MobileInfiniteList - 无限滚动列表

```tsx
import { MobileInfiniteList } from '@/components/mobile/MobileInfiniteList';

<MobileInfiniteList
  items={dataList}
  onLoadMore={async () => {
    await loadMore();
  }}
  hasMore={hasMore}
  isLoading={isLoading}
  isError={isError}
  renderItem={(item) => <ItemCard {...item} />}
  keyExtractor={(item) => item.id}
  threshold={200}
/>
```

### 3. MobileSkeletonLoader - 骨架屏

```tsx
import { MobileSkeletonLoader } from '@/components/mobile/MobileSkeletonLoader';

// 加载状态
{isLoading && <MobileSkeletonLoader count={5} type="card" />}

// 类型选项: 'card' | 'list' | 'detail' | 'table' | 'dashboard'
```

### 4. MobileEmptyState - 空状态

```tsx
import { 
  MobileEmptyState,
  NoDataState,
  SearchEmptyState,
  ErrorState,
  OfflineState 
} from '@/components/mobile/MobileEmptyState';

// 无数据状态
<NoDataState onRefresh={refetch} />

// 搜索无结果
<SearchEmptyState keyword="关键词" />

// 错误状态
<ErrorState onRetry={retry} />

// 离线状态
<OfflineState />

// 自定义空状态
<MobileEmptyState
  icon={CustomIcon}
  title="标题"
  description="描述"
  action={{
    label: "按钮文字",
    onClick: handleAction
  }}
/>
```

### 5. MobileFormField - 移动端表单字段

```tsx
import { MobileFormField, MobileFormCard, MobileFormGroup } from '@/components/mobile/MobileFormField';

<MobileFormCard title="基本信息">
  <MobileFormGroup title="必填项">
    <MobileFormField
      label="姓名"
      value={name}
      onChange={setName}
      type="text"
      required
      placeholder="请输入姓名"
      error={errors.name}
    />
    
    <MobileFormField
      label="手机号"
      value={phone}
      onChange={setPhone}
      type="tel"
      icon={<Phone />}
    />
    
    <MobileFormField
      label="类型"
      value={type}
      onChange={setType}
      type="select"
      options={[
        { value: '1', label: '类型一' },
        { value: '2', label: '类型二' }
      ]}
    />
  </MobileFormGroup>
</MobileFormCard>
```

### 6. MobileBottomNav - 底部导航栏

```tsx
import { MobileBottomNav, MobileBottomNavLayout } from '@/components/mobile/MobileBottomNav';
import { Home, User, Settings } from 'lucide-react';

const navItems = [
  { href: '/m/', icon: Home, label: '首页' },
  { href: '/m/profile', icon: User, label: '我的', badge: 3 },
  { href: '/m/settings', icon: Settings, label: '设置' }
];

// 方式1: 单独使用
<MobileBottomNav items={navItems} />

// 方式2: 配合布局使用
<MobileBottomNavLayout navItems={navItems}>
  <YourPageContent />
</MobileBottomNavLayout>
```

### 7. MobileHeader - 移动端头部

```tsx
import { MobileHeader } from '@/components/mobile/MobileHeader';
import { Share, Download } from 'lucide-react';

<MobileHeader
  title="页面标题"
  subtitle="副标题"
  showBack={true}
  onBack={() => navigate(-1)}
  searchable={true}
  onSearch={() => setShowSearch(true)}
  shareable={true}
  onShare={handleShare}
  actions={[
    { icon: Download, label: '下载', onClick: handleDownload }
  ]}
/>
```

### 8. MobileActionSheet - 操作面板

```tsx
import { MobileActionSheet } from '@/components/mobile/MobileActionSheet';
import { Edit, Trash, Share } from 'lucide-react';

<MobileActionSheet
  open={isOpen}
  onOpenChange={setIsOpen}
  title="选择操作"
  actions={[
    {
      icon: Edit,
      label: '编辑',
      onClick: handleEdit
    },
    {
      icon: Share,
      label: '分享',
      onClick: handleShare
    },
    {
      icon: Trash,
      label: '删除',
      onClick: handleDelete,
      variant: 'destructive'
    }
  ]}
/>
```

### 9. MobileSwipeableCard - 可滑动卡片

```tsx
import { MobileSwipeableCard } from '@/components/mobile/MobileSwipeableCard';
import { Edit, Trash, Archive } from 'lucide-react';

<MobileSwipeableCard
  leftActions={[
    { icon: Archive, label: '归档', onClick: handleArchive }
  ]}
  rightActions={[
    { icon: Edit, label: '编辑', onClick: handleEdit },
    { icon: Trash, label: '删除', onClick: handleDelete, variant: 'destructive' }
  ]}
>
  <CardContent />
</MobileSwipeableCard>
```

### 10. MobileTouchable - 触摸优化组件

```tsx
import { MobileTouchable, MobileButton, MobileTouchableCard } from '@/components/mobile/MobileTouchable';

// 基础触摸组件
<MobileTouchable
  onClick={handleClick}
  onLongPress={handleLongPress}
  onDoubleClick={handleDoubleClick}
  hapticFeedback={true}
  rippleEffect={true}
>
  <div>触摸区域</div>
</MobileTouchable>

// 移动端按钮
<MobileButton
  onClick={handleClick}
  variant="primary"
  size="lg"
>
  确认
</MobileButton>

// 可触摸卡片
<MobileTouchableCard onClick={handleClick}>
  <CardContent />
</MobileTouchableCard>
```

### 11. MobileOptimizedList - 优化列表

```tsx
import { MobileOptimizedList } from '@/components/mobile/MobileOptimizedList';

<MobileOptimizedList
  items={dataList}
  renderItem={(item) => <ItemCard {...item} />}
  keyExtractor={(item) => item.id}
  onRefresh={async () => await refetch()}
  onLoadMore={async () => await loadMore()}
  hasMore={hasMore}
  isLoading={isLoading}
  useVirtualList={items.length > 50}
  enablePullToRefresh={true}
  enableInfiniteScroll={true}
/>
```

### 12. EnhancedMobileLayout - 增强移动端布局

```tsx
import { EnhancedMobileLayout } from '@/components/mobile/EnhancedMobileLayout';

<EnhancedMobileLayout
  title="页面标题"
  showHeader={true}
  showBackButton={false}
  headerActions={<Button>操作</Button>}
>
  <YourPageContent />
</EnhancedMobileLayout>
```

---

## 🛠️ 工具函数

### 移动端工具库 (src/utils/mobile.ts)

```typescript
import {
  preventIOSBounce,          // 防止iOS橡皮筋效果
  disableDoubleTapZoom,      // 禁用双击缩放
  getSafeAreaInsets,         // 获取安全区域
  supportsHapticFeedback,    // 检测触觉反馈支持
  triggerHaptic,             // 触发触觉反馈
  isSlowConnection,          // 检测慢速网络
  getNetworkStatus,          // 获取网络状态
  formatFileSize,            // 格式化文件大小
  isNotchedDevice,           // 检测全面屏设备
  scrollToTop,               // 滚动到顶部
  scrollToElement,           // 滚动到元素
  copyToClipboard,           // 复制到剪贴板
  shareContent,              // 分享内容
  callPhone,                 // 拨打电话
  sendSMS,                   // 发送短信
  openMap,                   // 打开地图
  throttle,                  // 节流
  debounce,                  // 防抖
  compressImage              // 图片压缩
} from '@/utils/mobile';

// 使用示例
triggerHaptic('light');
await copyToClipboard('复制内容');
await shareContent({ title: '标题', text: '内容', url: 'https://...' });
callPhone('13800138000');
```

---

## 💡 使用示例

### 完整的移动端列表页面

```tsx
import React, { useState, useEffect } from 'react';
import { EnhancedMobileLayout } from '@/components/mobile/EnhancedMobileLayout';
import { MobileOptimizedList } from '@/components/mobile/MobileOptimizedList';
import { MobileSearchBar } from '@/components/mobile/MobileSearchBar';
import { MobileCard } from '@/components/mobile/MobileCard';
import { MobileFAB } from '@/components/mobile/MobileBottomNav';
import { Plus } from 'lucide-react';

function MobileListPage() {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [hasMore, setHasMore] = useState(true);
  const [searchValue, setSearchValue] = useState('');

  const loadData = async (isRefresh = false) => {
    setLoading(true);
    try {
      const data = await fetchData();
      setItems(isRefresh ? data : [...items, ...data]);
      setHasMore(data.length > 0);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadData(true);
  }, []);

  return (
    <EnhancedMobileLayout title="列表页">
      <div className="space-y-4">
        <MobileSearchBar
          searchValue={searchValue}
          onSearchChange={setSearchValue}
          placeholder="搜索..."
        />

        <MobileOptimizedList
          items={items}
          renderItem={(item) => (
            <MobileCard
              onClick={() => handleItemClick(item)}
              onEdit={() => handleEdit(item)}
              onDelete={() => handleDelete(item)}
            >
              <div>
                <h3>{item.title}</h3>
                <p>{item.description}</p>
              </div>
            </MobileCard>
          )}
          keyExtractor={(item) => item.id}
          onRefresh={() => loadData(true)}
          onLoadMore={() => loadData(false)}
          hasMore={hasMore}
          isLoading={loading}
          enablePullToRefresh={true}
          enableInfiniteScroll={true}
        />
      </div>

      <MobileFAB
        icon={Plus}
        label="新建"
        onClick={() => navigate('/m/create')}
        position="bottom-right"
        variant="primary"
      />
    </EnhancedMobileLayout>
  );
}
```

### 完整的移动端表单页面

```tsx
import React, { useState } from 'react';
import { EnhancedMobileLayout } from '@/components/mobile/EnhancedMobileLayout';
import { MobileFormCard, MobileFormField, MobileFormGroup } from '@/components/mobile/MobileFormField';
import { MobileButton } from '@/components/mobile/MobileTouchable';
import { User, Phone, Mail } from 'lucide-react';

function MobileFormPage() {
  const [formData, setFormData] = useState({
    name: '',
    phone: '',
    email: '',
    type: '',
    description: '',
    enabled: true
  });

  const [errors, setErrors] = useState({});

  const handleSubmit = async () => {
    // 验证表单
    const newErrors = validate(formData);
    if (Object.keys(newErrors).length > 0) {
      setErrors(newErrors);
      return;
    }

    // 提交数据
    try {
      await submitForm(formData);
      toast({ title: '提交成功' });
      navigate(-1);
    } catch (error) {
      toast({ title: '提交失败', variant: 'destructive' });
    }
  };

  return (
    <EnhancedMobileLayout title="表单页" showBackButton={true}>
      <div className="space-y-4">
        <MobileFormCard title="基本信息" description="请填写必要信息">
          <MobileFormGroup title="个人信息">
            <MobileFormField
              label="姓名"
              value={formData.name}
              onChange={(value) => setFormData({ ...formData, name: value })}
              type="text"
              required
              error={errors.name}
              icon={<User className="h-4 w-4" />}
            />

            <MobileFormField
              label="手机号"
              value={formData.phone}
              onChange={(value) => setFormData({ ...formData, phone: value })}
              type="tel"
              required
              error={errors.phone}
              icon={<Phone className="h-4 w-4" />}
            />

            <MobileFormField
              label="邮箱"
              value={formData.email}
              onChange={(value) => setFormData({ ...formData, email: value })}
              type="email"
              icon={<Mail className="h-4 w-4" />}
            />
          </MobileFormGroup>

          <MobileFormGroup title="其他信息">
            <MobileFormField
              label="类型"
              value={formData.type}
              onChange={(value) => setFormData({ ...formData, type: value })}
              type="select"
              options={[
                { value: '1', label: '类型一' },
                { value: '2', label: '类型二' }
              ]}
              required
            />

            <MobileFormField
              label="描述"
              value={formData.description}
              onChange={(value) => setFormData({ ...formData, description: value })}
              type="textarea"
              rows={4}
            />

            <MobileFormField
              label="启用"
              value={formData.enabled}
              onChange={(value) => setFormData({ ...formData, enabled: value })}
              type="switch"
            />
          </MobileFormGroup>
        </MobileFormCard>

        <div className="flex space-x-3 pt-4">
          <MobileButton
            onClick={() => navigate(-1)}
            variant="ghost"
            className="flex-1"
          >
            取消
          </MobileButton>
          <MobileButton
            onClick={handleSubmit}
            variant="primary"
            className="flex-1"
          >
            提交
          </MobileButton>
        </div>
      </div>
    </EnhancedMobileLayout>
  );
}
```

---

## 🎯 最佳实践

### 1. 性能优化

```tsx
// ✅ 使用虚拟列表处理大量数据
<MobileOptimizedList
  items={largeDataSet}
  useVirtualList={items.length > 50}
  itemHeight={100}
/>

// ✅ 图片懒加载
import { compressImage } from '@/utils/mobile';
const compressedBlob = await compressImage(file, 1920, 1080, 0.8);

// ✅ 防抖搜索
import { debounce } from '@/utils/mobile';
const debouncedSearch = debounce(handleSearch, 300);
```

### 2. 用户体验

```tsx
// ✅ 添加触觉反馈
import { triggerHaptic } from '@/utils/mobile';
const handleClick = () => {
  triggerHaptic('light');
  // 执行操作
};

// ✅ 下拉刷新
<MobilePullToRefresh onRefresh={refetch}>
  <DataList />
</MobilePullToRefresh>

// ✅ 加载状态
{isLoading && <MobileSkeletonLoader type="card" count={5} />}

// ✅ 空状态
{!isLoading && items.length === 0 && <NoDataState />}
```

### 3. 响应式设计

```tsx
// ✅ 使用移动端优化组件
import { useMobileOptimization } from '@/hooks/useMobileOptimization';

function MyComponent() {
  const { shouldUseVirtualList, isSlowConnection } = useMobileOptimization();
  
  return (
    <MobileOptimizedList
      useVirtualList={shouldUseVirtualList}
      itemHeight={isSlowConnection ? 80 : 100}
    />
  );
}
```

### 4. 安全区域适配

```tsx
// ✅ 使用安全区域类
<div className="safe-area-inset-top safe-area-inset-bottom">
  内容
</div>

// ✅ 或使用内联样式
<div style={{
  paddingTop: 'env(safe-area-inset-top, 0px)',
  paddingBottom: 'env(safe-area-inset-bottom, 0px)'
}}>
  内容
</div>
```

### 5. 网络状态处理

```tsx
// ✅ 处理离线状态
import { useMobileOptimization } from '@/hooks/useMobileOptimization';

function MyPage() {
  const { isOnline } = useMobileOptimization();
  
  if (!isOnline) {
    return <OfflineState />;
  }
  
  return <YourContent />;
}
```

---

## 📝 注意事项

1. **输入框字体大小**: 移动端输入框字体不能小于16px,否则iOS会自动缩放
2. **触摸目标**: 按钮等可点击元素最小尺寸应为44x44px
3. **安全区域**: 使用`safe-area-inset-*`类或CSS变量适配刘海屏
4. **性能**: 列表超过50项时启用虚拟滚动
5. **网络**: 检测慢速网络,降低资源加载质量
6. **离线**: 提供离线状态提示和缓存策略
7. **手势**: 使用原生滑动手势,避免与系统手势冲突

---

## 🔧 样式引入

确保在main.tsx或App.tsx中引入移动端样式:

```tsx
import '@/styles/mobile.css';
```

---

## 📱 设备检测

```tsx
import { useDeviceDetection } from '@/hooks/useDeviceDetection';

const { isMobile, isTablet, isWorkWeChat } = useDeviceDetection();
```

---

## 🎨 样式类

```css
/* 常用移动端样式类 */
.mobile-no-select          /* 禁用文本选择 */
.mobile-touchable          /* 触摸优化 */
.mobile-smooth-scroll      /* 平滑滚动 */
.mobile-prevent-bounce     /* 防止橡皮筋效果 */
.mobile-full-height        /* 全屏高度 */
.mobile-press-effect       /* 按压效果 */
.mobile-card-shadow        /* 卡片阴影 */
```

---

## 📖 更多资源

- [React Window文档](https://react-window.vercel.app/)
- [移动端Web开发最佳实践](https://web.dev/mobile/)
- [iOS人机界面指南](https://developer.apple.com/design/human-interface-guidelines/ios)
- [Android Material Design](https://material.io/design)

---

## ✨ 总结

本移动端优化方案提供了:
- 💪 完整的移动端组件库
- 🎣 实用的React Hooks
- 🛠️ 丰富的工具函数
- 📱 优秀的触摸体验
- ⚡ 出色的性能表现

开始使用这些组件和工具,为您的用户打造最佳的移动端体验!

