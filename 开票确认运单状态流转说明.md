# å¼€ç¥¨ç¡®è®¤è¿å•çŠ¶æ€æµè½¬è¯´æ˜

## ğŸ¯ **é—®é¢˜å›ç­”**

**æ˜¯çš„ï¼Œå¼€ç¥¨ç¡®è®¤ä¼šå½±å“è¿å•çŠ¶æ€ï¼** å…·ä½“å½±å“ä»¥ä¸‹è¡¨å’Œå­—æ®µï¼š

## ğŸ“Š **æ¶‰åŠçš„è¡¨å’Œå­—æ®µ**

### 1. ä¸»è¦å½±å“è¡¨ï¼š`logistics_partner_costs`
è¿™æ˜¯è¿å•çŠ¶æ€ç®¡ç†çš„æ ¸å¿ƒè¡¨ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®å­—æ®µï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çŠ¶æ€å€¼ |
|--------|------|------|--------|
| `invoice_status` | TEXT | å¼€ç¥¨çŠ¶æ€ | `'Uninvoiced'` â†’ `'Processing'` â†’ `'Invoiced'` |
| `invoice_request_id` | UUID | å…³è”çš„å¼€ç¥¨ç”³è¯·ID | ç”³è¯·æ—¶è®¾ç½®ï¼Œå®Œæˆæ—¶ä¿ç•™ |
| `invoice_number` | TEXT | å‘ç¥¨å·ç  | å®Œæˆå¼€ç¥¨æ—¶è®¾ç½® |
| `invoice_applied_at` | TIMESTAMP | å¼€ç¥¨ç”³è¯·æ—¶é—´ | ç”³è¯·æ—¶è‡ªåŠ¨è®¾ç½® |
| `invoice_completed_at` | TIMESTAMP | å¼€ç¥¨å®Œæˆæ—¶é—´ | å®Œæˆæ—¶è‡ªåŠ¨è®¾ç½® |

### 2. ç”³è¯·å•è¡¨ï¼š`invoice_requests`
å¼€ç¥¨ç”³è¯·å•çš„çŠ¶æ€ç®¡ç†ï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çŠ¶æ€å€¼ |
|--------|------|------|--------|
| `status` | TEXT | ç”³è¯·å•çŠ¶æ€ | `'Pending'` â†’ `'Approved'` â†’ `'Completed'` |
| `invoice_number` | TEXT | å‘ç¥¨å·ç  | å®Œæˆå¼€ç¥¨æ—¶è®¾ç½® |
| `invoice_date` | DATE | å‘ç¥¨æ—¥æœŸ | å®Œæˆå¼€ç¥¨æ—¶è®¾ç½® |

## ğŸ”„ **å®Œæ•´çŠ¶æ€æµè½¬è¿‡ç¨‹**

### é˜¶æ®µ1ï¼šåˆ›å»ºå¼€ç¥¨ç”³è¯·
```sql
-- 1. åˆ›å»ºå¼€ç¥¨ç”³è¯·å•
INSERT INTO invoice_requests (status, ...) VALUES ('Pending', ...);

-- 2. æ›´æ–°è¿å•çŠ¶æ€ä¸º"å·²ç”³è¯·å¼€ç¥¨"
UPDATE logistics_partner_costs 
SET 
    invoice_status = 'Processing',
    invoice_request_id = [ç”³è¯·å•ID],
    invoice_applied_at = NOW()
WHERE logistics_record_id IN ([è¿å•IDåˆ—è¡¨]);
```

### é˜¶æ®µ2ï¼šç¡®è®¤å¼€ç¥¨ï¼ˆå‰ç«¯å½“å‰å®ç°ï¼‰
```sql
-- åªæ›´æ–°ç”³è¯·å•çŠ¶æ€ï¼Œä¸æ›´æ–°è¿å•çŠ¶æ€
UPDATE invoice_requests 
SET status = 'Approved'
WHERE id = [ç”³è¯·å•ID];
```

### é˜¶æ®µ3ï¼šå®Œæˆå¼€ç¥¨ï¼ˆæ•°æ®åº“å‡½æ•°å®ç°ï¼‰
```sql
-- 1. æ›´æ–°ç”³è¯·å•çŠ¶æ€
UPDATE invoice_requests 
SET 
    status = 'Completed',
    invoice_number = [å‘ç¥¨å·ç ],
    invoice_date = [å‘ç¥¨æ—¥æœŸ]
WHERE id = [ç”³è¯·å•ID];

-- 2. æ›´æ–°è¿å•çŠ¶æ€ä¸º"å·²å¼€ç¥¨"
UPDATE logistics_partner_costs 
SET 
    invoice_status = 'Invoiced',
    invoice_number = [å‘ç¥¨å·ç ],
    invoice_completed_at = NOW()
WHERE invoice_request_id = [ç”³è¯·å•ID];
```

## ğŸ› **å½“å‰é—®é¢˜**

### å‰ç«¯å®ç°ä¸å®Œæ•´
å‰ç«¯çš„"ç¡®è®¤å¼€ç¥¨"åŠŸèƒ½åªæ›´æ–°äº†`invoice_requests`è¡¨ï¼Œæ²¡æœ‰æ›´æ–°`logistics_partner_costs`è¡¨ï¼š

```typescript
// å½“å‰å‰ç«¯å®ç°ï¼ˆä¸å®Œæ•´ï¼‰
const approveInvoice = async (requestId: string) => {
  const { data, error } = await supabase
    .from('invoice_requests')
    .update({ 
      status: 'Approved',  // åªæ›´æ–°ç”³è¯·å•çŠ¶æ€
      updated_at: new Date().toISOString()
    })
    .eq('id', requestId);
  // ç¼ºå°‘å¯¹ logistics_partner_costs è¡¨çš„æ›´æ–°
};
```

## ğŸ› ï¸ **ä¿®å¤æ–¹æ¡ˆ**

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ•°æ®åº“å‡½æ•°ï¼ˆæ¨èï¼‰
```typescript
// ä¿®å¤åçš„å‰ç«¯å®ç°
const approveInvoice = async (requestId: string) => {
  try {
    const { data, error } = await supabase.rpc('approve_invoice_request', {
      p_request_id: requestId,
      p_action: 'approve',
      p_remarks: null
    });

    if (error) throw error;

    toast({
      title: "ç¡®è®¤æˆåŠŸ",
      description: "å¼€ç¥¨ç”³è¯·å•å·²ç¡®è®¤ï¼Œè¿å•çŠ¶æ€å·²æ›´æ–°",
    });
    loadInvoiceRequests();
  } catch (error) {
    console.error('ç¡®è®¤å¼€ç¥¨å¤±è´¥:', error);
    toast({
      title: "ç¡®è®¤å¤±è´¥",
      description: error.message || 'æ— æ³•ç¡®è®¤å¼€ç¥¨',
      variant: "destructive",
    });
  }
};
```

### æ–¹æ¡ˆ2ï¼šå‰ç«¯ç›´æ¥æ›´æ–°ï¼ˆä¸æ¨èï¼‰
```typescript
// ä¸æ¨èçš„å®ç°æ–¹å¼
const approveInvoice = async (requestId: string) => {
  try {
    // 1. æ›´æ–°ç”³è¯·å•çŠ¶æ€
    await supabase
      .from('invoice_requests')
      .update({ status: 'Approved' })
      .eq('id', requestId);

    // 2. æ›´æ–°è¿å•çŠ¶æ€
    await supabase
      .from('logistics_partner_costs')
      .update({ 
        invoice_status = 'Processing'  // æˆ–è€…ä¿æŒå½“å‰çŠ¶æ€
      })
      .eq('invoice_request_id', requestId);

    // 3. å®Œæˆå¼€ç¥¨æ—¶å†æ¬¡æ›´æ–°
    // ...
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
};
```

## ğŸ“ˆ **çŠ¶æ€æµè½¬å›¾**

```
è¿å•åˆ›å»º
    â†“
logistics_partner_costs.invoice_status = 'Uninvoiced'
    â†“
åˆ›å»ºå¼€ç¥¨ç”³è¯·
    â†“
logistics_partner_costs.invoice_status = 'Processing'
    â†“
ç¡®è®¤å¼€ç¥¨ï¼ˆå½“å‰ç¼ºå¤±ï¼‰
    â†“
logistics_partner_costs.invoice_status = 'Processing' (ä¿æŒä¸å˜)
    â†“
å®Œæˆå¼€ç¥¨
    â†“
logistics_partner_costs.invoice_status = 'Invoiced'
```

## ğŸ¯ **å»ºè®®ä¿®å¤**

1. **ä½¿ç”¨æ•°æ®åº“å‡½æ•°**: è°ƒç”¨`approve_invoice_request`å‡½æ•°
2. **å®Œæ•´çŠ¶æ€ç®¡ç†**: ç¡®ä¿è¿å•çŠ¶æ€ä¸ç”³è¯·å•çŠ¶æ€åŒæ­¥
3. **é”™è¯¯å¤„ç†**: ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **çŠ¶æ€éªŒè¯**: æ£€æŸ¥çŠ¶æ€è½¬æ¢çš„åˆæ³•æ€§

## ğŸ“‹ **æ€»ç»“**

**å¼€ç¥¨ç¡®è®¤ç¡®å®ä¼šå½±å“è¿å•çŠ¶æ€**ï¼Œä¸»è¦å½±å“ï¼š
- **è¡¨**: `logistics_partner_costs`
- **å­—æ®µ**: `invoice_status`, `invoice_applied_at`, `invoice_completed_at`
- **çŠ¶æ€å€¼**: `'Uninvoiced'` â†’ `'Processing'` â†’ `'Invoiced'`

å½“å‰å‰ç«¯å®ç°ä¸å®Œæ•´ï¼Œéœ€è¦ä¿®å¤ä»¥ç¡®ä¿è¿å•çŠ¶æ€æ­£ç¡®æ›´æ–°ï¼ğŸ”§
