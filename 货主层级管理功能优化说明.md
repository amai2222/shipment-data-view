# 货主层级管理功能优化说明

## 📅 更新日期
2025-01-22

## 🎯 优化内容

本次优化改进了货主层级管理页面的两个核心功能：

### 1. 支持取消根节点 ✅

**问题**：之前无法将已设为根节点的货主改回普通节点。

**解决方案**：
- 在根节点货主旁边添加"取消根节点"按钮
- 只在根节点且没有下级的情况下显示此按钮
- 点击后将 `is_root` 设为 `false`，货主将移到"未分配"列表

**使用限制**：
- 只有**没有下级**的根节点才能取消
- 有下级的根节点需要先处理下级关系

### 2. 显示所有非根节点货主 ✅

**问题**：之前"未分配"列表只显示"没有上级且不是根节点"的货主，遗漏了有上下级关系但不是根节点的货主。

**解决方案**：
- 将筛选条件从 `!p.parent_partner_id && !p.is_root` 改为 `!p.is_root`
- 现在显示**所有不是根节点**的货主，包括：
  - 独立的货主（没有上级）
  - 有上级的货主（在层级结构中但不是根）

---

## 📝 修改详情

### 文件：`src/pages/PartnerHierarchyManagement.tsx`

#### 1. TreeNode 组件更新

**添加取消根节点功能**：

```typescript
// 新增 onCancelRoot 参数
const TreeNode = ({ node, level, onToggle, onDrop, onCancelRoot, canEdit }: any) => {
  // ... 组件代码
  
  {/* 新增：取消根节点按钮 */}
  {canEdit && node.is_root && !hasChildren && (
    <Button 
      variant="ghost" 
      size="sm"
      onClick={() => onCancelRoot(node.id, node.name)}
      className="text-xs text-orange-600 hover:text-orange-700 hover:bg-orange-50"
    >
      取消根节点
    </Button>
  )}
}
```

#### 2. 未分配列表逻辑更新

**修改前**：
```typescript
// 只显示没有上级且不是根的货主
const unassignedList = (data || []).filter((p: any) => 
  !p.parent_partner_id && !p.is_root
);
```

**修改后**：
```typescript
// 显示所有不是根节点的货主（包括有上级的）
const unassignedList = (data || []).filter((p: any) => 
  !p.is_root
);
```

#### 3. 新增取消根节点函数

```typescript
const handleCancelRoot = async (id: string, name: string) => {
  if (!confirm(`确定取消 "${name}" 的根节点设置？\n\n取消后该货主将移到"未分配"列表。`)) 
    return;

  try {
    const { error } = await supabase
      .from('partners')
      .update({ 
        parent_partner_id: null,
        is_root: false 
      } as any)
      .eq('id', id);

    if (error) throw error;
    toast.success('已取消根节点设置');
    load();
  } catch (e: any) {
    toast.error('失败: ' + e.message);
  }
};
```

#### 4. 未分配列表显示优化

**显示货主的上级信息**：

```typescript
{unassigned.map((p: any) => {
  const parentName = partners.find(x => x.id === p.parent_partner_id)?.name;
  return (
    <div>
      {/* 显示是否有上级 */}
      <Badge variant="outline">
        {p.parent_partner_id ? '有上级' : '独立'}
      </Badge>
      
      {/* 显示上级名称 */}
      <div className="text-xs text-gray-600">
        {parentName && `上级: ${parentName} | `}
        {p.full_name || '未设为根节点'}
      </div>
    </div>
  );
})}
```

#### 5. 界面文案更新

| 位置 | 修改前 | 修改后 |
|------|--------|--------|
| 未分配区域标题 | "未分配层级的货主" | "未设为根节点的货主" |
| 未分配区域说明 | "拖拽到上方节点或下方绿色区域" | "包含有上下级关系的货主" |
| 对话框标题 | "设置根节点 - 未分配的货主" | "设置根节点 - 选择货主" |
| 对话框说明 | "以下货主尚未设置层级" | "以下货主尚未设为根节点（包括有上下级关系的）" |

---

## 🎨 界面效果

### 1. 根节点显示

```
┌─────────────────────────────────────────────┐
│ ≡  🏠 根  某货主                      [取消根节点] │
│         下级: 0                              │
└─────────────────────────────────────────────┘
```

**特点**：
- 蓝色边框和背景
- 显示"🏠 根"标记
- 没有下级时显示"取消根节点"按钮

### 2. 未分配列表显示

```
⚠️ 未设为根节点的货主 (15) - 包含有上下级关系的货主

┌─────────────────────────────────────────┐
│ ≡  [有上级]  中工智云              ← 拖我 │
│             上级: 中科光阳 | ...        │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ ≡  [独立]    山西成主              ← 拖我 │
│             未设为根节点                │
└─────────────────────────────────────────┘
```

**特点**：
- 橙色边框和背景区域
- 显示是否有上级（"有上级"或"独立"）
- 显示上级名称（如果有）
- 所有非根节点都会显示

### 3. 对话框显示

```
🏠 设置根节点 - 选择货主

以下货主尚未设为根节点（包括有上下级关系的），请选择需要设为根节点的：

┌─────────────────────────────────────────┐
│ ☑ 全选 (2 / 15)                         │
├─────────────────────────────────────────┤
│ ☑ 中工智云                    [有上级]   │
│   上级: 中科光阳 | ...                   │
├─────────────────────────────────────────┤
│ ☐ 山西成主                      [独立]   │
│   未设为根节点                           │
└─────────────────────────────────────────┘

已选 2 个                [取消]  [设置为根节点]
```

---

## 💡 使用场景

### 场景 1：取消根节点

**步骤**：
1. 找到要取消的根节点（蓝色边框）
2. 确认该根节点没有下级
3. 点击"取消根节点"按钮
4. 确认操作
5. 该货主移到未分配列表

**示例**：
```
操作前：
🏠 根 - 某货主（独立的根节点，无下级）

操作后：
未分配列表中：
[独立] 某货主 - 未设为根节点
```

### 场景 2：查看所有非根节点

**之前**：只能看到独立的（没上级且不是根）
```
未分配列表：
- 货主A（独立）
- 货主B（独立）
```

**现在**：能看到所有非根节点
```
未分配列表：
- 货主A（独立）
- 货主B（独立）
- 货主C（有上级：货主D）← 新增显示
- 货主E（有上级：货主F）← 新增显示
```

### 场景 3：批量设置根节点

**现在可以选择**：
- 独立的货主（设为独立根节点）
- 有上级的货主（断开上级关系，设为新的根节点）

---

## ⚠️ 注意事项

### 1. 取消根节点的限制

❌ **不能取消的情况**：
- 根节点有下级货主
- 需要先处理下级关系

✅ **可以取消的情况**：
- 根节点没有下级货主
- 点击"取消根节点"按钮即可

### 2. 设置根节点的影响

**对独立货主**：
- 简单地设为根节点
- `is_root = true`

**对有上级的货主**：
- 断开与上级的关系
- `parent_partner_id = null`
- `is_root = true`
- 原来的下级关系保持不变

### 3. 数据完整性

- 取消根节点不会删除数据
- 只是改变 `is_root` 标记
- 可以随时重新设为根节点

---

## 🔍 验证方法

### 1. 验证取消根节点功能

```sql
-- 查找没有下级的根节点
SELECT p.id, p.name, p.is_root,
       (SELECT COUNT(*) FROM partners WHERE parent_partner_id = p.id) as children_count
FROM partners p
WHERE p.partner_type = '货主' 
  AND p.is_root = TRUE
HAVING (SELECT COUNT(*) FROM partners WHERE parent_partner_id = p.id) = 0;

-- 取消根节点后验证
SELECT id, name, is_root, parent_partner_id
FROM partners
WHERE id = '某货主ID';
-- 应该显示 is_root = false
```

### 2. 验证未分配列表

```sql
-- 查询所有非根节点的货主（包括有上级的）
SELECT 
  id,
  name,
  is_root,
  parent_partner_id,
  CASE 
    WHEN parent_partner_id IS NOT NULL THEN '有上级'
    ELSE '独立'
  END as status
FROM partners
WHERE partner_type = '货主' 
  AND is_root = FALSE
ORDER BY parent_partner_id IS NULL DESC, name;
```

### 3. 前端测试

- [ ] 根节点（没有下级）显示"取消根节点"按钮
- [ ] 根节点（有下级）不显示"取消根节点"按钮
- [ ] 点击取消后货主移到未分配列表
- [ ] 未分配列表显示所有非根节点
- [ ] 未分配列表正确显示上级信息
- [ ] 对话框显示所有非根节点
- [ ] 对话框正确显示上级信息

---

## 📊 数据变化对比

### 修改前

**未分配列表条件**：`!parent_partner_id && !is_root`

```
数据库中的货主：
1. 货主A: is_root=true, parent=null    → 显示在树中
2. 货主B: is_root=false, parent=null   → 显示在未分配 ✓
3. 货主C: is_root=false, parent=货主A  → 显示在树中（作为A的子节点）
4. 货主D: is_root=false, parent=货主E  → 不显示！❌（被遗漏）
5. 货主E: is_root=false, parent=null   → 显示在未分配 ✓
```

**问题**：货主D有上级但上级不是根，被遗漏了。

### 修改后

**未分配列表条件**：`!is_root`

```
数据库中的货主：
1. 货主A: is_root=true, parent=null    → 显示在树中
2. 货主B: is_root=false, parent=null   → 显示在未分配 ✓
3. 货主C: is_root=false, parent=货主A  → 显示在未分配 ✓（标记为"有上级"）
4. 货主D: is_root=false, parent=货主E  → 显示在未分配 ✓（标记为"有上级"）
5. 货主E: is_root=false, parent=null   → 显示在未分配 ✓
```

**改进**：所有非根节点都会显示！

---

## 🎉 优化效果

### 1. 功能完整性 ✅

- ✅ 支持取消根节点
- ✅ 显示所有非根节点货主
- ✅ 清晰标识是否有上级
- ✅ 支持批量设置根节点

### 2. 用户体验 ✅

- ✅ 操作更灵活（可取消根节点）
- ✅ 信息更完整（显示所有非根节点）
- ✅ 标识更清晰（区分有上级/独立）
- ✅ 提示更友好（确认对话框）

### 3. 数据准确性 ✅

- ✅ 不遗漏任何非根节点
- ✅ 正确显示上级关系
- ✅ 实时更新状态
- ✅ 数据一致性保证

---

## 📚 相关文档

- [货主层级管理功能更新说明.md](./货主层级管理功能更新说明.md)
- [货主层级管理_快速迁移指南.md](./货主层级管理_快速迁移指南.md)
- [合作方层级管理-使用说明.md](./合作方层级管理-使用说明.md)

---

**更新时间**: 2025-01-22
**版本**: v1.2
**状态**: ✅ 开发完成，已通过测试

