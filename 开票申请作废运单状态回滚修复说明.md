# 开票申请作废运单状态回滚修复说明

## 问题描述

**现象**: 在财务开票页面点击"一键作废"后，运单的开票状态仍然显示为"Processing"（申请中/处理中），没有回滚为"Uninvoiced"（未开票）

## 问题原因

### 前端问题

**文件**: `src/pages/InvoiceRequestManagement.tsx`  
**函数**: `handleBatchVoid`（第639-676行）

**问题代码**:
```typescript
const handleBatchVoid = async () => {
  // 只更新了invoice_requests表
  const { error } = await supabase
    .from('invoice_requests')
    .update({ 
      status: 'Voided',
      is_voided: true,
      voided_at: new Date().toISOString(),
      voided_by: (await supabase.auth.getUser()).data.user?.id,
      updated_at: new Date().toISOString()
    })
    .in('id', selectedIds);
  
  // ❌ 没有调用void_invoice_request RPC函数
  // ❌ 没有回滚logistics_records的状态
  // ❌ 没有回滚logistics_partner_costs的状态
};
```

### 后端问题

**文件**: `supabase/migrations/20250816_fix_invoice_request_function_overload.sql`  
**函数**: `void_invoice_request`（第277-345行）

**问题代码**:
```sql
-- ✅ 回滚了logistics_partner_costs（第319-325行）
UPDATE public.logistics_partner_costs
SET 
    invoice_status = 'Uninvoiced',
    invoice_request_id = NULL,
    invoice_applied_at = NULL
WHERE invoice_request_id = p_request_id;

-- ❌ 但是没有回滚logistics_records表的状态！
```

---

## 修复方案

### 修复1：前端调用正确的RPC函数

**文件**: `src/pages/InvoiceRequestManagement.tsx`

**修复后的代码**:
```typescript
const handleBatchVoid = async () => {
  if (selection.selectedIds.size === 0) return;
  
  setIsBatchProcessing(true);
  try {
    const selectedIds = Array.from(selection.selectedIds);
    let successCount = 0;
    let failCount = 0;
    
    // ✅ 逐个调用后端RPC函数，确保状态正确回滚
    for (const requestId of selectedIds) {
      try {
        const { data, error } = await supabase.rpc('void_invoice_request', {
          p_request_id: requestId,
          p_void_reason: '批量作废'
        });
        
        if (error) throw error;
        
        const result = data as { success: boolean; message: string } | null;
        if (result?.success) {
          successCount++;
        } else {
          failCount++;
        }
      } catch (err) {
        failCount++;
      }
    }

    toast({
      title: "批量作废完成",
      description: `成功作废 ${successCount} 个申请单。运单状态已回滚为未开票。`,
    });
  }
}
```

### 修复2：后端函数回滚logistics_records状态

**文件**: `supabase/migrations/20251027_fix_void_invoice_request_rollback_logistics.sql`

**修复内容**:
```sql
CREATE OR REPLACE FUNCTION public.void_invoice_request(...)
RETURNS json
AS $$
DECLARE
    v_logistics_record_ids uuid[];
BEGIN
    -- 获取关联的运单ID
    SELECT array_agg(DISTINCT logistics_record_id)
    INTO v_logistics_record_ids
    FROM public.invoice_request_details
    WHERE invoice_request_id = p_request_id;
    
    -- 作废申请单
    UPDATE public.invoice_requests SET status = 'Voided' ...;
    
    -- ✅ 回滚logistics_partner_costs
    UPDATE public.logistics_partner_costs
    SET invoice_status = 'Uninvoiced' ...;
    
    -- ✅ 新增：回滚logistics_records的开票状态
    IF v_logistics_record_ids IS NOT NULL THEN
        UPDATE public.logistics_records
        SET 
            invoice_status = 'Uninvoiced',
            invoice_request_id = NULL,
            invoice_applied_at = NULL
        WHERE id = ANY(v_logistics_record_ids);
    END IF;
    
    RETURN json_build_object(
        'success', true,
        'message', '开票申请单已作废，运单状态已回滚'
    );
END;
$$;
```

---

## 状态回滚逻辑

### 完整的回滚流程

```
点击"一键作废"
    ↓
调用void_invoice_request RPC函数
    ↓
1. 作废申请单
   invoice_requests.status → 'Voided'
   invoice_requests.is_voided → true
    ↓
2. 回滚合作方成本状态
   logistics_partner_costs.invoice_status → 'Uninvoiced'
   logistics_partner_costs.invoice_request_id → NULL
    ↓
3. ✅ 回滚运单开票状态（新增）
   logistics_records.invoice_status → 'Uninvoiced'
   logistics_records.invoice_request_id → NULL
    ↓
4. 删除申请单明细
   DELETE FROM invoice_request_details
```

---

## 需要更新的表

### 1. invoice_requests（开票申请单表）
```sql
status = 'Voided'
is_voided = true
voided_at = NOW()
voided_by = auth.uid()
```

### 2. logistics_partner_costs（合作方成本表）
```sql
invoice_status = 'Uninvoiced'  -- 从Processing回滚到Uninvoiced
invoice_request_id = NULL
invoice_applied_at = NULL
```

### 3. logistics_records（运单表）✅ 关键修复
```sql
invoice_status = 'Uninvoiced'  -- 从Processing回滚到Uninvoiced
invoice_request_id = NULL
invoice_applied_at = NULL
```

---

## 执行修复

### 步骤1：执行SQL迁移文件

```sql
-- 在Supabase SQL编辑器中执行
supabase/migrations/20251027_fix_void_invoice_request_rollback_logistics.sql
```

或者：

```powershell
# PowerShell中执行
supabase db push
```

### 步骤2：刷新页面

修复完成后，刷新财务开票页面即可使用。

---

## 测试方法

### 测试作废功能

1. 创建一个开票申请单
2. 查看相关运单的开票状态 → 应该是"Processing"
3. 在财务开票页面，选中该申请单
4. 点击"一键作废"
5. 确认作废
6. 查看相关运单的开票状态 → 应该回滚为"Uninvoiced"

### SQL验证

```sql
-- 1. 查看申请单关联的运单
SELECT 
    ir.request_number,
    ir.status as request_status,
    ird.logistics_record_id,
    lr.auto_number,
    lr.invoice_status as record_status,
    lpc.invoice_status as cost_status
FROM invoice_requests ir
JOIN invoice_request_details ird ON ir.id = ird.invoice_request_id
JOIN logistics_records lr ON ird.logistics_record_id = lr.id
LEFT JOIN logistics_partner_costs lpc ON lr.id = lpc.logistics_record_id
WHERE ir.id = 'YOUR_REQUEST_ID';

-- 2. 作废申请单后再查询
-- request_status应该是'Voided'
-- record_status应该是'Uninvoiced'（关键！）
-- cost_status应该是'Uninvoiced'
```

---

## 对比付款申请的作废逻辑

### 付款申请作废（参考）

**函数**: `void_payment_request_with_rollback`

**回滚内容**:
1. ✅ payment_requests.status → 'Cancelled'
2. ✅ logistics_partner_costs.payment_status → 'Unpaid'
3. ✅ **logistics_records.payment_status → 'Unpaid'**

### 开票申请作废（应该一致）

**函数**: `void_invoice_request`

**回滚内容**:
1. ✅ invoice_requests.status → 'Voided'
2. ✅ logistics_partner_costs.invoice_status → 'Uninvoiced'
3. ✅ **logistics_records.invoice_status → 'Uninvoiced'** (本次修复)

---

## 相关函数检查

### 同时需要检查的函数

#### 1. 审批拒绝时的回滚
如果存在审批拒绝功能，也需要确保回滚logistics_records：

```sql
-- 拒绝开票申请时
UPDATE logistics_records
SET invoice_status = 'Uninvoiced'
WHERE id IN (SELECT logistics_record_id FROM invoice_request_details WHERE invoice_request_id = ...);
```

#### 2. 删除申请单时的回滚
删除开票申请单时也需要回滚：

```sql
CREATE OR REPLACE FUNCTION delete_invoice_request(p_request_id uuid)
AS $$
BEGIN
    -- 回滚logistics_records
    UPDATE logistics_records
    SET invoice_status = 'Uninvoiced', ...
    WHERE id IN (...);
    
    -- 回滚logistics_partner_costs
    UPDATE logistics_partner_costs
    SET invoice_status = 'Uninvoiced', ...
    WHERE invoice_request_id = p_request_id;
    
    -- 删除申请单
    DELETE FROM invoice_requests WHERE id = p_request_id;
END;
$$;
```

---

## 注意事项

### 1. 数据一致性

确保三个表的状态始终保持一致：
- `invoice_requests.status`
- `logistics_records.invoice_status`  
- `logistics_partner_costs.invoice_status`

### 2. 批量操作性能

当前使用循环逐个调用RPC，如果批量作废大量申请单可能较慢。

**优化方案**（后续可实施）:
```typescript
// 创建批量作废RPC函数
const { data, error } = await supabase.rpc('batch_void_invoice_requests', {
  p_request_ids: Array.from(selection.selectedIds),
  p_void_reason: '批量作废'
});
```

### 3. 事务处理

后端函数应该在事务中执行，确保原子性。

---

## 立即执行

### 修复已完成 ✅

1. **前端代码**: 已修改`handleBatchVoid`函数
2. **后端SQL**: 已创建迁移文件

### 执行SQL

在Supabase SQL编辑器中运行：
```sql
supabase/migrations/20251027_fix_void_invoice_request_rollback_logistics.sql
```

### 测试

作废申请单后，运单状态应该正确回滚为"未开票"。

---

**修复日期**: 2025-10-27  
**修复文件**: 
- `src/pages/InvoiceRequestManagement.tsx`
- `supabase/migrations/20251027_fix_void_invoice_request_rollback_logistics.sql`

