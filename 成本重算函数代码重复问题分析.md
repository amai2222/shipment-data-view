# æˆæœ¬é‡ç®—å‡½æ•°ä»£ç é‡å¤é—®é¢˜åˆ†æ

## âš ï¸ æ‚¨çš„å‘ç°å®Œå…¨æ­£ç¡®ï¼

ç³»ç»Ÿä¸­**ä¸æ˜¯ä½¿ç”¨åŒä¸€ä¸ªå‡½æ•°**ï¼Œè€Œæ˜¯**ç›¸åŒçš„è®¡ç®—é€»è¾‘é‡å¤äº†3æ¬¡**ï¼

---

## ğŸ“Š æˆæœ¬é‡ç®—å‡½æ•°å…¨è§ˆ

### å‡½æ•°æ¸…å•ï¼ˆ6ä¸ªï¼‰

| åºå· | å‡½æ•°å | åŠŸèƒ½ | æ ¸å¿ƒè®¡ç®—é€»è¾‘ | ä»£ç é‡å¤ |
|-----|--------|------|------------|---------|
| 1 | `recalculate_costs_for_chain` | é‡ç®—æŒ‡å®šé“¾è·¯æ‰€æœ‰è¿å• | âœ… æœ‰ | åŸå§‹ç‰ˆæœ¬ |
| 2 | `recalculate_costs_for_chain_safe` | å®‰å…¨é‡ç®—é“¾è·¯ï¼ˆè·³è¿‡å·²ä»˜æ¬¾ï¼‰ | âœ… æœ‰ | âŒ é‡å¤ |
| 3 | `modify_logistics_record_chain_with_recalc` | ä¿®æ”¹å•ä¸ªè¿å•é“¾è·¯ | âœ… æœ‰ | âŒ é‡å¤ |
| 4 | `batch_modify_chain` | æ‰¹é‡ä¿®æ”¹é“¾è·¯ | âŒ æ— ï¼ˆè°ƒç”¨å‡½æ•°3ï¼‰ | å¤ç”¨å‡½æ•°3 |
| 5 | `recalculate_costs_for_project` | é‡ç®—æ•´ä¸ªé¡¹ç›® | âŒ æ— ï¼ˆè°ƒç”¨å‡½æ•°1ï¼‰ | å¤ç”¨å‡½æ•°1 |
| 6 | `auto_recalc_on_project_partner_change` | è§¦å‘å™¨å‡½æ•° | âŒ æ— ï¼ˆè°ƒç”¨å‡½æ•°1ï¼‰ | å¤ç”¨å‡½æ•°1 |

---

## ğŸ” é‡å¤ä»£ç è¯¦æƒ…

### æ ¸å¿ƒè®¡ç®—é€»è¾‘ï¼ˆçº¦30è¡Œä»£ç ï¼‰

è¿™æ®µä»£ç åœ¨**3ä¸ªå‡½æ•°ä¸­å®Œå…¨é‡å¤**ï¼š

```sql
-- ğŸ”´ é‡å¤ä»£ç æ®µï¼ˆå‡ºç°åœ¨3ä¸ªå‡½æ•°ä¸­ï¼‰
-- ============================================

-- è®¡ç®—åº”ä»˜é‡‘é¢
IF v_project_partners.calculation_method = 'profit' THEN
    -- åˆ©æ¶¦æ³•
    IF v_loading_weight IS NOT NULL AND v_loading_weight > 0 THEN
        v_payable_amount := v_base_amount + (COALESCE(v_project_partners.profit_rate, 0) * v_loading_weight);
    ELSE
        v_payable_amount := v_base_amount + COALESCE(v_project_partners.profit_rate, 0);
    END IF;
ELSE
    -- ç¨ç‚¹æ³•ï¼ˆé»˜è®¤ï¼‰
    IF v_project_partners.tax_rate IS NOT NULL AND v_project_partners.tax_rate != 1 THEN
        v_payable_amount := v_base_amount / (1 - v_project_partners.tax_rate);
    ELSE
        v_payable_amount := v_base_amount;
    END IF;
END IF;

-- æ’å…¥æ–°çš„æˆæœ¬è®°å½•
INSERT INTO logistics_partner_costs (
    logistics_record_id,
    partner_id,
    level,
    base_amount,
    payable_amount,
    tax_rate,
    user_id
) VALUES (
    v_record_id,
    v_project_partners.partner_id,
    v_project_partners.level,
    v_base_amount,
    v_payable_amount,
    v_project_partners.tax_rate,
    auth.uid()
);
```

### é‡å¤ä½ç½®

| å‡½æ•° | æ–‡ä»¶ | è¡Œæ•°èŒƒå›´ |
|-----|------|---------|
| `recalculate_costs_for_chain` | 20250122_auto_recalc_on_project_partner_change.sql | 68-102 |
| `recalculate_costs_for_chain_safe` | 20250122_auto_recalc_on_project_partner_change.sql | ~280-320 |
| `modify_logistics_record_chain_with_recalc` | 20251025_fix_modify_chain_with_recalculation.sql | 156-189 |

---

## ğŸ“ˆ å‡½æ•°è°ƒç”¨å…³ç³»å›¾

```
ç”¨æˆ·æ“ä½œè§¦å‘
    â”‚
    â”œâ”€> ä¿®æ”¹é¡¹ç›®åˆä½œæ–¹é…ç½®
    â”‚   â””â”€> auto_recalc_on_project_partner_change (è§¦å‘å™¨)
    â”‚       â””â”€> recalculate_costs_for_chain
    â”‚           â””â”€> [è®¡ç®—é€»è¾‘A] â† ç¬¬1æ¬¡é‡å¤
    â”‚
    â”œâ”€> ä¿®æ”¹å•ä¸ªè¿å•é“¾è·¯
    â”‚   â””â”€> modify_logistics_record_chain_with_recalc
    â”‚       â””â”€> [è®¡ç®—é€»è¾‘C] â† ç¬¬3æ¬¡é‡å¤ï¼ˆä¸Aç›¸åŒï¼‰
    â”‚
    â”œâ”€> æ‰¹é‡ä¿®æ”¹è¿å•é“¾è·¯
    â”‚   â””â”€> batch_modify_chain
    â”‚       â””â”€> å¾ªç¯è°ƒç”¨ modify_logistics_record_chain_with_recalc
    â”‚           â””â”€> [è®¡ç®—é€»è¾‘C]
    â”‚
    â””â”€> å®‰å…¨é‡ç®—é“¾è·¯
        â””â”€> recalculate_costs_for_chain_safe
            â””â”€> [è®¡ç®—é€»è¾‘B] â† ç¬¬2æ¬¡é‡å¤ï¼ˆä¸Aç›¸åŒï¼‰
```

---

## âš ï¸ é£é™©åˆ†æ

### å½“å‰å­˜åœ¨çš„é£é™©

#### 1. é€»è¾‘ä¸ä¸€è‡´é£é™© ğŸ”´ é«˜å±

**é—®é¢˜**ï¼šå¦‚æœæœ‰äººåªä¿®æ”¹äº†ä¸€ä¸ªå‡½æ•°çš„è®¡ç®—é€»è¾‘ï¼Œå¿˜è®°ä¿®æ”¹å…¶ä»–å‡½æ•°

**åæœ**ï¼š
- ä¸åŒå…¥å£è®¡ç®—çš„æˆæœ¬ä¸ä¸€è‡´
- æ•°æ®æ··ä¹±
- éš¾ä»¥æ’æŸ¥

#### 2. ç»´æŠ¤æˆæœ¬é«˜ ğŸŸ¡ ä¸­å±

**é—®é¢˜**ï¼šæ¯æ¬¡ä¿®æ”¹è®¡ç®—å…¬å¼éœ€è¦æ”¹3ä¸ªåœ°æ–¹

**åæœ**ï¼š
- å®¹æ˜“é—æ¼
- å¢åŠ å¼€å‘æ—¶é—´
- å¢åŠ æµ‹è¯•å·¥ä½œé‡

#### 3. æ–°å¢è®¡ç®—æ–¹æ³•å›°éš¾ ğŸŸ¡ ä¸­å±

**é—®é¢˜**ï¼šå¦‚æœè¦æ·»åŠ æ–°çš„è®¡ç®—æ–¹æ³•ï¼ˆå¦‚é˜¶æ¢¯ç¨ç‚¹ï¼‰ï¼Œéœ€è¦ä¿®æ”¹3ä¸ªåœ°æ–¹

**ç¤ºä¾‹**ï¼š
```sql
-- å‡è®¾è¦æ–°å¢"é˜¶æ¢¯ç¨ç‚¹æ³•"
-- éœ€è¦åœ¨3ä¸ªå‡½æ•°ä¸­éƒ½æ·»åŠ ç›¸åŒçš„é€»è¾‘
ELSIF v_project_partners.calculation_method = 'tiered_tax' THEN
    -- é˜¶æ¢¯è®¡ç®—é€»è¾‘
    ...
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæå–æ ¸å¿ƒå‡½æ•°ï¼ˆæ¨èï¼‰âœ¨

#### æ­¥éª¤1ï¼šåˆ›å»ºæ ¸å¿ƒè®¡ç®—å‡½æ•°

```sql
-- ============================================================================
-- æ ¸å¿ƒï¼šè®¡ç®—å•ä¸ªåˆä½œæ–¹çš„åº”ä»˜é‡‘é¢
-- ============================================================================
CREATE OR REPLACE FUNCTION public.calculate_partner_payable_amount(
    p_base_amount NUMERIC,
    p_loading_weight NUMERIC,
    p_calculation_method TEXT,
    p_tax_rate NUMERIC,
    p_profit_rate NUMERIC
)
RETURNS NUMERIC AS $$
DECLARE
    v_payable_amount NUMERIC;
BEGIN
    IF p_calculation_method = 'profit' THEN
        -- åˆ©æ¶¦æ³•
        IF p_loading_weight IS NOT NULL AND p_loading_weight > 0 THEN
            v_payable_amount := p_base_amount + (COALESCE(p_profit_rate, 0) * p_loading_weight);
        ELSE
            v_payable_amount := p_base_amount + COALESCE(p_profit_rate, 0);
        END IF;
    ELSE
        -- ç¨ç‚¹æ³•ï¼ˆé»˜è®¤ï¼‰
        IF p_tax_rate IS NOT NULL AND p_tax_rate != 1 THEN
            v_payable_amount := p_base_amount / (1 - p_tax_rate);
        ELSE
            v_payable_amount := p_base_amount;
        END IF;
    END IF;
    
    RETURN v_payable_amount;
END;
$$ LANGUAGE plpgsql IMMUTABLE SECURITY DEFINER;

COMMENT ON FUNCTION public.calculate_partner_payable_amount IS 'è®¡ç®—åˆä½œæ–¹åº”ä»˜é‡‘é¢çš„æ ¸å¿ƒå‡½æ•°';
```

#### æ­¥éª¤2ï¼šä¿®æ”¹æ‰€æœ‰é‡ç®—å‡½æ•°è°ƒç”¨æ ¸å¿ƒå‡½æ•°

```sql
-- åœ¨ recalculate_costs_for_chain ä¸­
v_payable_amount := calculate_partner_payable_amount(
    v_base_amount,
    v_loading_weight,
    v_project_partners.calculation_method,
    v_project_partners.tax_rate,
    v_project_partners.profit_rate
);

-- åœ¨ recalculate_costs_for_chain_safe ä¸­
v_payable_amount := calculate_partner_payable_amount(
    v_base_amount,
    v_loading_weight,
    v_project_partners.calculation_method,
    v_project_partners.tax_rate,
    v_project_partners.profit_rate
);

-- åœ¨ modify_logistics_record_chain_with_recalc ä¸­
v_payable_amount := calculate_partner_payable_amount(
    v_base_amount,
    v_loading_weight,
    v_project_partners.calculation_method,
    v_project_partners.tax_rate,
    v_project_partners.profit_rate
);
```

**ä¼˜ç‚¹**ï¼š
- âœ… åªéœ€ç»´æŠ¤ä¸€å¤„è®¡ç®—é€»è¾‘
- âœ… æ–°å¢è®¡ç®—æ–¹æ³•åªéœ€ä¿®æ”¹æ ¸å¿ƒå‡½æ•°
- âœ… ä¿è¯æ‰€æœ‰å‡½æ•°è®¡ç®—ä¸€è‡´
- âœ… ä»£ç æ›´æ¸…æ™°

---

### æ–¹æ¡ˆBï¼šæ–‡æ¡£åŒ–åŒæ­¥ä¿®æ”¹ï¼ˆæ¬¡é€‰ï¼‰

å¦‚æœä¸é‡æ„ï¼Œè‡³å°‘è¦ï¼š

1. **åˆ›å»ºä¿®æ”¹æ¸…å•**
   ```
   ä¿®æ”¹è®¡ç®—é€»è¾‘æ—¶å¿…é¡»åŒæ­¥ä¿®æ”¹ï¼š
   - recalculate_costs_for_chain (ç¬¬68-83è¡Œ)
   - recalculate_costs_for_chain_safe (ç¬¬xxxè¡Œ)
   - modify_logistics_record_chain_with_recalc (ç¬¬156-170è¡Œ)
   ```

2. **æ·»åŠ ä»£ç æ³¨é‡Š**
   ```sql
   -- âš ï¸ æ³¨æ„ï¼šæ­¤è®¡ç®—é€»è¾‘åœ¨ä»¥ä¸‹å‡½æ•°ä¸­ä¹Ÿå­˜åœ¨
   -- - recalculate_costs_for_chain
   -- - recalculate_costs_for_chain_safe
   -- - modify_logistics_record_chain_with_recalc
   -- ä¿®æ”¹æ—¶å¿…é¡»åŒæ­¥æ›´æ–°æ‰€æœ‰å‡½æ•°ï¼
   ```

3. **åˆ›å»ºéªŒè¯è„šæœ¬**
   ```sql
   -- éªŒè¯æ‰€æœ‰å‡½æ•°çš„è®¡ç®—ç»“æœæ˜¯å¦ä¸€è‡´
   SELECT verify_all_recalc_functions();
   ```

---

## ğŸ¯ å»ºè®®æ‰§è¡Œè®¡åˆ’

### çŸ­æœŸï¼ˆç«‹å³ï¼‰

**ä¿æŒç°çŠ¶ + æ–‡æ¡£åŒ–**

1. âœ… åˆ›å»º"æˆæœ¬é‡ç®—å‡½æ•°åŒæ­¥ä¿®æ”¹æ¸…å•.md"
2. âœ… åœ¨ä»£ç ä¸­æ·»åŠ è­¦å‘Šæ³¨é‡Š
3. âœ… æµ‹è¯•éªŒè¯å½“å‰é€»è¾‘ä¸€è‡´æ€§

**åŸå› **ï¼š
- åŠŸèƒ½å·²åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œ
- é‡æ„æœ‰é£é™©
- éœ€è¦å®Œæ•´æµ‹è¯•

### ä¸­æœŸï¼ˆ1-2å‘¨åï¼‰

**é‡æ„ä¸ºæ ¸å¿ƒå‡½æ•°**

1. åˆ›å»º `calculate_partner_payable_amount` æ ¸å¿ƒå‡½æ•°
2. é€æ­¥ä¿®æ”¹ç°æœ‰å‡½æ•°
3. å®Œæ•´æµ‹è¯•å¯¹æ¯”ç»“æœ
4. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

**åŸå› **ï¼š
- é™ä½é•¿æœŸç»´æŠ¤æˆæœ¬
- å‡å°‘å‡ºé”™å¯èƒ½
- ä¾¿äºæ‰©å±•æ–°åŠŸèƒ½

---

## ğŸ“‹ æˆæœ¬è®¡ç®—é€»è¾‘è¯´æ˜

### åˆ©æ¶¦æ³•ï¼ˆProfit Methodï¼‰

```
åº”ä»˜é‡‘é¢ = åŸºç¡€é‡‘é¢ + (åˆ©æ¶¦ç‡ Ã— è£…è´§é‡é‡)

ç¤ºä¾‹ï¼š
- åŸºç¡€é‡‘é¢ï¼š1000å…ƒ
- åˆ©æ¶¦ç‡ï¼š50å…ƒ/å¨
- è£…è´§é‡é‡ï¼š10å¨
- åº”ä»˜é‡‘é¢ = 1000 + (50 Ã— 10) = 1500å…ƒ
```

### ç¨ç‚¹æ³•ï¼ˆTax Methodï¼‰

```
åº”ä»˜é‡‘é¢ = åŸºç¡€é‡‘é¢ / (1 - ç¨ç‡)

ç¤ºä¾‹ï¼š
- åŸºç¡€é‡‘é¢ï¼š1000å…ƒ
- ç¨ç‡ï¼š0.06 (6%)
- åº”ä»˜é‡‘é¢ = 1000 / (1 - 0.06) = 1063.83å…ƒ
```

---

## ğŸ§ª ä¸€è‡´æ€§éªŒè¯

### éªŒè¯è„šæœ¬

```sql
-- åˆ›å»ºæµ‹è¯•è¿å•
INSERT INTO logistics_records (id, ...) VALUES (...);

-- ä½¿ç”¨3ä¸ªä¸åŒå‡½æ•°é‡ç®—
SELECT recalculate_costs_for_chain(...);
SELECT recalculate_costs_for_chain_safe(...);
SELECT modify_logistics_record_chain_with_recalc(...);

-- å¯¹æ¯”ç»“æœæ˜¯å¦ä¸€è‡´
SELECT 
    lr.auto_number,
    lpc1.payable_amount as amount_from_func1,
    lpc2.payable_amount as amount_from_func2,
    lpc3.payable_amount as amount_from_func3,
    CASE 
        WHEN lpc1.payable_amount = lpc2.payable_amount 
         AND lpc2.payable_amount = lpc3.payable_amount 
        THEN 'âœ… ä¸€è‡´'
        ELSE 'âŒ ä¸ä¸€è‡´'
    END as check_result
FROM ...;
```

---

## ğŸ“ ä¿®æ”¹å†å²è¿½è¸ª

### è¿™äº›å‡½æ•°æ˜¯ä½•æ—¶åˆ›å»ºçš„ï¼Ÿ

| å‡½æ•° | åˆ›å»ºæ—¥æœŸ | è¿ç§»æ–‡ä»¶ |
|-----|---------|---------|
| `recalculate_costs_for_chain` | 2025-01-22 | 20250122_auto_recalc_on_project_partner_change.sql |
| `recalculate_costs_for_chain_safe` | 2025-01-22 | 20250122_auto_recalc_on_project_partner_change.sql |
| `recalculate_costs_for_project` | 2025-01-22 | 20250122_auto_recalc_on_project_partner_change.sql |
| `modify_logistics_record_chain_with_recalc` | 2025-10-25 | 20251025_fix_modify_chain_with_recalculation.sql |
| `batch_modify_chain` | 2025-10-25 | 20251025_add_batch_modify_functions.sql |

**åˆ†æ**ï¼š
- å‡½æ•°1-3åœ¨åŒä¸€å¤©åˆ›å»ºï¼ˆ2025-01-22ï¼‰
- å‡½æ•°4åœ¨3ä¸ªæœˆååˆ›å»ºï¼ˆ2025-10-25ï¼‰
- åˆ›å»ºå‡½æ•°4æ—¶**å¤åˆ¶ç²˜è´´**äº†è®¡ç®—é€»è¾‘ï¼Œæ²¡æœ‰å¤ç”¨

---

## âš ï¸ å®é™…é—®é¢˜æ¡ˆä¾‹

### å¦‚æœè¦ä¿®æ”¹è®¡ç®—å…¬å¼

**åœºæ™¯**ï¼šç¨ç‚¹æ³•æ”¹ä¸º `base_amount / (1 + tax_rate)` ï¼ˆç¨å‰ä»·ï¼‰

**éœ€è¦ä¿®æ”¹çš„åœ°æ–¹**ï¼š

1. âœ… `recalculate_costs_for_chain` (ç¬¬78-82è¡Œ)
   ```sql
   v_payable_amount := v_base_amount / (1 + v_project_partners.tax_rate);
   ```

2. âœ… `recalculate_costs_for_chain_safe` (ç›¸åº”è¡Œ)
   ```sql
   v_payable_amount := v_base_amount / (1 + v_project_partners.tax_rate);
   ```

3. âœ… `modify_logistics_record_chain_with_recalc` (ç¬¬165-169è¡Œ)
   ```sql
   v_payable_amount := v_base_amount / (1 + v_project_partners.tax_rate);
   ```

**å¦‚æœé—æ¼ä¸€å¤„**ï¼š
- âŒ ä¸åŒå…¥å£è®¡ç®—ç»“æœä¸ä¸€è‡´
- âŒ æ•°æ®æ··ä¹±
- âŒ éš¾ä»¥æ’æŸ¥

---

## ğŸ’¡ é‡æ„æ–¹æ¡ˆè¯¦è§£

### åˆ›å»ºæ ¸å¿ƒè®¡ç®—å‡½æ•°

```sql
-- ============================================================================
-- æ ¸å¿ƒå‡½æ•°ï¼šè®¡ç®—åˆä½œæ–¹åº”ä»˜é‡‘é¢
-- ============================================================================
-- åŠŸèƒ½ï¼šæ ¹æ®è®¡ç®—æ–¹æ³•ï¼ˆåˆ©æ¶¦æ³•/ç¨ç‚¹æ³•ï¼‰è®¡ç®—åº”ä»˜é‡‘é¢
-- å‚æ•°ï¼š
--   p_base_amount      - åŸºç¡€é‡‘é¢ï¼ˆcurrent_cost + extra_costï¼‰
--   p_loading_weight   - è£…è´§é‡é‡
--   p_calculation_method - è®¡ç®—æ–¹æ³•ï¼ˆ'profit' æˆ– 'tax'ï¼‰
--   p_tax_rate         - ç¨ç‡ï¼ˆ0-1ä¹‹é—´çš„å°æ•°ï¼‰
--   p_profit_rate      - åˆ©æ¶¦ç‡ï¼ˆå…ƒ/å¨ æˆ– å›ºå®šé‡‘é¢ï¼‰
-- è¿”å›ï¼šåº”ä»˜é‡‘é¢
-- ============================================================================
CREATE OR REPLACE FUNCTION public.calculate_partner_payable_amount(
    p_base_amount NUMERIC,
    p_loading_weight NUMERIC,
    p_calculation_method TEXT,
    p_tax_rate NUMERIC,
    p_profit_rate NUMERIC
)
RETURNS NUMERIC AS $$
DECLARE
    v_payable_amount NUMERIC;
BEGIN
    -- å‚æ•°éªŒè¯
    IF p_base_amount IS NULL OR p_base_amount < 0 THEN
        RAISE EXCEPTION 'åŸºç¡€é‡‘é¢ä¸èƒ½ä¸ºç©ºæˆ–è´Ÿæ•°';
    END IF;
    
    -- æ ¹æ®è®¡ç®—æ–¹æ³•è®¡ç®—
    IF p_calculation_method = 'profit' THEN
        -- ========== åˆ©æ¶¦æ³• ==========
        IF p_loading_weight IS NOT NULL AND p_loading_weight > 0 THEN
            -- åˆ©æ¶¦ç‡ Ã— é‡é‡
            v_payable_amount := p_base_amount + (COALESCE(p_profit_rate, 0) * p_loading_weight);
        ELSE
            -- å›ºå®šåˆ©æ¶¦
            v_payable_amount := p_base_amount + COALESCE(p_profit_rate, 0);
        END IF;
    ELSE
        -- ========== ç¨ç‚¹æ³•ï¼ˆé»˜è®¤ï¼‰ ==========
        IF p_tax_rate IS NOT NULL AND p_tax_rate != 0 AND p_tax_rate != 1 THEN
            -- å«ç¨ä»· = ç¨å‰ä»· / (1 - ç¨ç‡)
            v_payable_amount := p_base_amount / (1 - p_tax_rate);
        ELSE
            -- æ— ç¨æˆ–ç¨ç‡ä¸º0
            v_payable_amount := p_base_amount;
        END IF;
    END IF;
    
    RETURN ROUND(v_payable_amount, 2);  -- ä¿ç•™2ä½å°æ•°
END;
$$ LANGUAGE plpgsql IMMUTABLE SECURITY DEFINER;

COMMENT ON FUNCTION public.calculate_partner_payable_amount IS 
'è®¡ç®—åˆä½œæ–¹åº”ä»˜é‡‘é¢çš„æ ¸å¿ƒå‡½æ•°ï¼ˆåˆ©æ¶¦æ³•/ç¨ç‚¹æ³•ï¼‰';
```

### ä¿®æ”¹åçš„é‡ç®—å‡½æ•°ç¤ºä¾‹

```sql
-- ä¿®æ”¹ recalculate_costs_for_chain
FOR v_project_partners IN ... LOOP
    -- ğŸ¯ è°ƒç”¨æ ¸å¿ƒå‡½æ•°ï¼Œä¸å†é‡å¤ä»£ç 
    v_payable_amount := calculate_partner_payable_amount(
        v_base_amount,
        v_loading_weight,
        v_project_partners.calculation_method,
        v_project_partners.tax_rate,
        v_project_partners.profit_rate
    );
    
    INSERT INTO logistics_partner_costs (...) VALUES (...);
END LOOP;
```

---

## ğŸ“Š é‡æ„å‰åå¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å |
|-----|--------|--------|
| **ä»£ç é‡å¤** | 3æ¬¡ | 0æ¬¡ |
| **ç»´æŠ¤ç‚¹** | 3ä¸ªå‡½æ•° | 1ä¸ªæ ¸å¿ƒå‡½æ•° |
| **ä¿®æ”¹è®¡ç®—é€»è¾‘** | æ”¹3å¤„ | æ”¹1å¤„ |
| **æ–°å¢è®¡ç®—æ–¹æ³•** | æ”¹3å¤„ | æ”¹1å¤„ |
| **å‡ºé”™é£é™©** | é«˜ | ä½ |
| **ä»£ç è¡Œæ•°** | ~90è¡Œï¼ˆé‡å¤ï¼‰ | ~30è¡Œï¼ˆæ ¸å¿ƒï¼‰|

---

## ğŸ¯ é‡æ„ä¼˜å…ˆçº§

### ç´§æ€¥ç¨‹åº¦ï¼šğŸŸ¡ ä¸­ç­‰

**åŸå› **ï¼š
- å½“å‰åŠŸèƒ½æ­£å¸¸
- ä½†å­˜åœ¨é•¿æœŸé£é™©
- å»ºè®®å°½å¿«é‡æ„

### å½±å“èŒƒå›´ï¼šğŸŸ¢ å¯æ§

**é‡æ„å½±å“**ï¼š
- åªæ¶‰åŠæˆæœ¬è®¡ç®—é€»è¾‘
- æ¥å£ä¸å˜
- å¯ä»¥é€æ­¥è¿ç§»

### å»ºè®®æ—¶é—´ï¼šğŸ“… 1-2å‘¨å†…

**ç†ç”±**ï¼š
- é¿å…ç§¯ç´¯æ›´å¤šæŠ€æœ¯å€º
- è¶è®°å¿†çŠ¹æ–°æ—¶é‡æ„
- é™ä½æœªæ¥ç»´æŠ¤æˆæœ¬

---

## ğŸ“ åŒæ­¥ä¿®æ”¹æ¸…å•ï¼ˆå¦‚æœä¸é‡æ„ï¼‰

### âš ï¸ ä¿®æ”¹è®¡ç®—é€»è¾‘æ—¶å¿…é¡»åŒæ­¥

| åºå· | å‡½æ•°å | æ–‡ä»¶ | è¡Œæ•° |
|-----|--------|------|------|
| 1 | `recalculate_costs_for_chain` | 20250122_auto_recalc_on_project_partner_change.sql | 68-83 |
| 2 | `recalculate_costs_for_chain_safe` | 20250122_auto_recalc_on_project_partner_change.sql | ~280-320 |
| 3 | `modify_logistics_record_chain_with_recalc` | 20251025_fix_modify_chain_with_recalculation.sql | 156-170 |

### éªŒè¯æ­¥éª¤

1. å¯¹æ¯”3ä¸ªå‡½æ•°çš„è®¡ç®—é€»è¾‘ä»£ç 
2. ç¡®ä¿å®Œå…¨ä¸€è‡´ï¼ˆé€è¡Œå¯¹æ¯”ï¼‰
3. æµ‹è¯•ç›¸åŒè¾“å…¥å¾—åˆ°ç›¸åŒç»“æœ
4. åœ¨ä»£ç ä¸­æ·»åŠ åŒæ­¥ä¿®æ”¹æé†’æ³¨é‡Š

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### é€‰é¡¹Aï¼šç«‹å³é‡æ„ï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**ï¼šä¸€åŠ³æ°¸é€¸  
**æ—¶é—´**ï¼š2-3å°æ—¶  
**é£é™©**ï¼šéœ€è¦æµ‹è¯•

### é€‰é¡¹Bï¼šæš‚ä¸é‡æ„

**ä¼˜ç‚¹**ï¼šé›¶é£é™©  
**ç¼ºç‚¹**ï¼šé•¿æœŸç»´æŠ¤æˆæœ¬é«˜  
**è¦æ±‚**ï¼šå¿…é¡»ä¸¥æ ¼åŒæ­¥ä¿®æ”¹

---

**æ‚¨å¸Œæœ›æˆ‘åˆ›å»ºé‡æ„æ–¹æ¡ˆå—ï¼Ÿè¿˜æ˜¯å…ˆæ·»åŠ åŒæ­¥ä¿®æ”¹çš„è­¦å‘Šæ³¨é‡Šï¼Ÿ** ğŸ¤”

