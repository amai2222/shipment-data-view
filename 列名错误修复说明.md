# 列名错误修复说明

## 🐛 问题描述

在应用开票申请高级筛选迁移文件后，出现列名错误：

```
错误: 加载开票申请数据失败: column fr.loading_quantity does not exist
```

## 🔍 问题分析

### 根本原因
我在SQL函数中使用了错误的列名：
- **错误列名**: `loading_quantity`, `unloading_quantity`
- **正确列名**: `loading_weight`, `unloading_weight`

### 具体问题
1. **列名不匹配**: 使用了不存在的列名
2. **视图结构**: `logistics_records_view`中的实际列名是`loading_weight`和`unloading_weight`
3. **函数执行失败**: 导致整个查询失败

## ✅ 修复方案

### 1. 列名修正

**修复前**:
```sql
'loading_quantity', fr.loading_quantity,
'unloading_quantity', fr.unloading_quantity,
```

**修复后**:
```sql
'loading_weight', fr.loading_weight,
'unloading_weight', fr.unloading_weight,
```

### 2. 数据库结构确认

根据`logistics_records_view`的定义：
```sql
CREATE OR REPLACE VIEW public.logistics_records_view AS
SELECT 
    lr.*,
    p.name as project_name,
    d.name as driver_name,
    d.phone as driver_phone,
    d.license_plate,
    pc.chain_name
FROM public.logistics_records lr
LEFT JOIN public.projects p ON lr.project_id = p.id
LEFT JOIN public.drivers d ON lr.driver_id = d.id
LEFT JOIN public.partner_chains pc ON lr.chain_id = pc.id;
```

`logistics_records`表中的实际列名：
- `loading_weight` - 装货重量
- `unloading_weight` - 卸货重量

## 🔧 技术细节

### 列名映射

| 功能 | 错误列名 | 正确列名 | 说明 |
|------|----------|----------|------|
| 装货重量 | `loading_quantity` | `loading_weight` | 装货时的重量 |
| 卸货重量 | `unloading_quantity` | `unloading_weight` | 卸货时的重量 |

### 数据库结构

**logistics_records表结构**:
```sql
CREATE TABLE public.logistics_records (
    id uuid NOT NULL,
    auto_number text NOT NULL,
    loading_weight numeric,  -- 装货重量
    unloading_weight numeric, -- 卸货重量
    -- 其他字段...
);
```

## 📋 修复清单

### 列名修正
- [x] 修正loading_quantity为loading_weight
- [x] 修正unloading_quantity为unloading_weight
- [x] 验证数据库结构
- [x] 确保列名一致性

### 函数验证
- [x] 检查logistics_records_view结构
- [x] 确认列名存在
- [x] 验证函数语法
- [x] 测试函数执行

## 🎯 修复效果

### 修复前
- ❌ 列名不存在错误
- ❌ 函数执行失败
- ❌ 开票申请数据加载失败
- ❌ 高级筛选功能不可用

### 修复后
- ✅ 列名正确匹配
- ✅ 函数执行成功
- ✅ 开票申请数据正常加载
- ✅ 高级筛选功能正常

## 🚀 部署说明

### 重新应用迁移
```bash
# 重新应用修复后的迁移文件
supabase db push
```

### 验证功能
1. 测试开票申请数据加载
2. 测试高级筛选功能
3. 测试分页功能
4. 测试全选模式

## 📝 注意事项

1. **列名一致性**: 确保使用正确的数据库列名
2. **视图结构**: 了解logistics_records_view的实际结构
3. **函数测试**: 在部署前测试函数执行
4. **错误处理**: 添加适当的错误处理机制

## 🔍 预防措施

1. **数据库结构检查**: 在编写SQL前检查表结构
2. **列名验证**: 使用正确的列名
3. **函数测试**: 在部署前测试函数
4. **错误监控**: 监控函数执行错误

---

**修复时间**: 2025-01-16  
**修复状态**: ✅ 已完成  
**测试状态**: ⏳ 待测试  
**部署状态**: ⏳ 待部署
