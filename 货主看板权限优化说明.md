# 货主看板权限优化说明

## 🎯 优化目标

**修改前**：所有用户都需要是货主类型才能访问货主看板  
**修改后**：只有"合作方"角色需要验证货主类型，其他角色可以选择货主查看数据

## ✅ 已完成的修改

### 1. 权限逻辑调整

#### 用户角色分类

| 角色 | 中文名称 | 权限逻辑 |
|------|---------|---------|
| 🔵 admin | 系统管理员 | 可选择任意货主查看 |
| 🔵 finance | 财务人员 | 可选择任意货主查看 |
| 🔵 business | 业务人员 | 可选择任意货主查看 |
| 🔵 operator | 操作人员 | 可选择任意货主查看 |
| 🔵 viewer | 查看者 | 可选择任意货主查看 |
| 🟣 partner | 合作方 | 必须是货主类型 |

### 2. 具体实现

#### 合作方角色（partner）
- ✅ 必须关联货主类型的合作方
- ✅ 只能查看自己关联的货主数据
- ✅ 无法切换查看其他货主
- ❌ 如果不是货主类型，显示权限不足

#### 非合作方角色（admin/finance/business/operator/viewer）
- ✅ 系统加载所有根节点货主列表
- ✅ 可以通过下拉框选择要查看的货主
- ✅ 默认选择第一个货主
- ✅ 可以随意切换查看不同货主的数据
- ⚠️ 如果系统中没有货主，显示友好提示

### 3. 界面变化

#### 桌面端（ShipperDashboard.tsx）

**合作方角色界面**：
```
┌──────────────────────────────────────────┐
│ 📊 货主看板                               │
│ [最近30天▼] [全部▼] [🔄刷新] [📥导出]    │
└──────────────────────────────────────────┘
```

**非合作方角色界面**：
```
┌──────────────────────────────────────────┐
│ 📊 货主看板                               │
│ [选择货主▼] [最近30天▼] [全部▼] [刷新] [导出] │
└──────────────────────────────────────────┘
```

#### 移动端（MobileShipperDashboard.tsx）

**合作方角色界面**：
```
┌──────────────────┐
│ 🌊 货主看板       │
│ [最近7天▼]       │
└──────────────────┘
```

**非合作方角色界面**：
```
┌──────────────────┐
│ 🌊 货主看板       │
│ [选择货主▼]      │
│ [最近7天▼]       │
└──────────────────┘
```

## 🔧 技术实现

### 1. 用户角色判断
```typescript
const userRole = user?.role || 'viewer';
const isPartnerRole = userRole === 'partner';
```

### 2. 货主ID获取逻辑
```typescript
// 合作方：使用关联的 partnerId
// 非合作方：使用下拉框选择的 shipperId
const currentShipperId = isPartnerRole 
  ? user?.partnerId || null 
  : selectedShipperId;
```

### 3. 可用货主列表加载
```typescript
const loadAvailableShippers = async () => {
  if (isPartnerRole) return; // 合作方不需要加载列表
  
  const { data } = await supabase
    .from('partners')
    .select('id, name')
    .eq('partner_type', '货主')
    .eq('is_root', true)
    .order('name');
  
  setAvailableShippers(data || []);
  
  // 默认选择第一个
  if (data && data.length > 0) {
    setSelectedShipperId(data[0].id);
  }
};
```

### 4. 权限检查逻辑
```typescript
// 合作方：必须有 partnerId
if (isPartnerRole && !user?.partnerId) {
  return <权限不足提示 />;
}

// 非合作方：必须有可用货主
if (!isPartnerRole && availableShippers.length === 0) {
  return <暂无数据提示 />;
}
```

## 📊 使用场景

### 场景1：合作方用户登录
1. 系统检测到用户角色是"合作方"
2. 验证用户是否关联了货主类型的合作方
3. 如果是货主类型 → 显示数据
4. 如果不是货主类型 → 显示"权限不足"

### 场景2：管理员登录
1. 系统检测到用户角色是"管理员"
2. 加载所有根节点货主列表
3. 在页面头部显示货主选择下拉框
4. 默认选择第一个货主
5. 管理员可以切换查看不同货主的数据

### 场景3：财务人员登录
1. 系统检测到用户角色是"财务"
2. 加载所有根节点货主列表
3. 可以选择货主查看财务数据
4. 用于核对不同货主的账务情况

### 场景4：业务人员登录
1. 系统检测到用户角色是"业务"
2. 可以查看不同货主的业务数据
3. 用于跟进和管理各货主的业务

## ⚠️ 注意事项

### 1. 数据权限
- 非合作方角色虽然可以选择货主，但仍然遵循层级权限
- 只能查看选定货主及其下级的数据
- 无法查看选定货主的上级或平级数据

### 2. 货主列表范围
- 只加载根节点货主（`is_root = true`）
- 子级货主不会出现在选择列表中
- 选择根节点后，自动包含其所有下级

### 3. 性能优化
- 货主列表只在组件加载时获取一次
- 切换货主时重新加载数据
- 使用 React hooks 管理状态

## 🚀 部署步骤

### 1. 文件修改清单
- ✅ `src/pages/ShipperDashboard.tsx`（桌面端）
- ✅ `src/pages/mobile/MobileShipperDashboard.tsx`（移动端）

### 2. 部署前测试
- [ ] 测试合作方角色：必须是货主类型
- [ ] 测试管理员角色：可以选择货主
- [ ] 测试财务角色：可以选择货主
- [ ] 测试业务角色：可以选择货主
- [ ] 测试操作员角色：可以选择货主
- [ ] 测试查看者角色：可以选择货主

### 3. 提交代码
```bash
git add .
git commit -m "优化货主看板权限：非合作方角色可选择货主查看"
git push origin main
```

## 📈 预期效果

### 改进前的问题
❌ 非货主用户完全无法访问货主看板  
❌ 管理员无法查看货主数据  
❌ 财务无法核对货主账务  

### 改进后的优势
✅ 合作方用户：仍需货主类型，保证数据安全  
✅ 管理员：可以管理和查看所有货主数据  
✅ 财务人员：可以核对任意货主的财务数据  
✅ 业务人员：可以跟进不同货主的业务情况  
✅ 灵活性：既保证安全性，又提供便利性  

## 🎯 总结

### 核心改进
1. **差异化权限**：根据用户角色采用不同的权限逻辑
2. **灵活性提升**：非合作方角色可以查看任意货主
3. **安全性保持**：合作方角色仍需货主类型验证
4. **用户体验**：提供货主选择下拉框，操作更便捷

### 适用场景
- ✅ 集团公司：管理员查看各子公司（货主）数据
- ✅ 财务审计：财务人员核对不同货主账务
- ✅ 业务管理：业务人员跟进各货主的业务
- ✅ 合作方：货主只能查看自己的数据

---

**版本**：v1.2.0  
**更新日期**：2025-01-22  
**优化内容**：权限逻辑优化，支持角色差异化访问  
**向后兼容**：是（不影响现有功能）

