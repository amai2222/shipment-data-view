# ä»˜æ¬¾ç”³è¯·é€šçŸ¥è§¦å‘å™¨ä¿®å¤è¯´æ˜

## ğŸ› é”™è¯¯ä¿¡æ¯

```
æ“ä½œå¤±è´¥: record "new" has no field "project_id"
```

## ğŸ“ é—®é¢˜å®šä½

### é”™è¯¯æ¥æº

**æ–‡ä»¶ï¼š** `supabase/migrations/create_notifications_system.sql`  
**å‡½æ•°ï¼š** `notify_payment_request_created()`  
**è§¦å‘å™¨ï¼š** `trigger_payment_request_notification`  
**è§¦å‘æ—¶æœºï¼š** åœ¨ `payment_requests` è¡¨æ’å…¥æ•°æ®å

### é”™è¯¯ä»£ç 

```sql
-- ç¬¬162è¡Œ
CREATE OR REPLACE FUNCTION public.notify_payment_request_created()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
DECLARE
  v_project_name text;
BEGIN
  -- âŒ é”™è¯¯ï¼špayment_requestsè¡¨æ²¡æœ‰project_idå­—æ®µ
  SELECT name INTO v_project_name
  FROM public.projects
  WHERE id = NEW.project_id;  -- è¿™é‡ŒæŠ¥é”™ï¼
  ...
END;
$$;
```

## ğŸ” æ ¹æœ¬åŸå› 

### payment_requestsè¡¨ç»“æ„

`payment_requests` è¡¨æ²¡æœ‰ `project_id` å­—æ®µï¼

**å®é™…å­—æ®µï¼š**
- id
- total_amount
- status
- work_wechat_sp_no
- approval_result
- created_at
- updated_at
- created_by
- user_id
- ...

**ç¼ºå°‘ï¼š**
- âŒ project_id

### ä¸ºä»€ä¹ˆä¼šå‡ºé”™ï¼Ÿ

åœ¨ç”Ÿæˆä»˜æ¬¾ç”³è¯·å¹¶ä¿å­˜åˆ°æ•°æ®åº“æ—¶ï¼š
```sql
INSERT INTO payment_requests (total_amount, created_by, ...)
VALUES (...);
```

è§¦å‘äº† `AFTER INSERT` è§¦å‘å™¨ `trigger_payment_request_notification`ï¼Œè¿™ä¸ªè§¦å‘å™¨è°ƒç”¨å‡½æ•°å°è¯•è®¿é—® `NEW.project_id`ï¼Œä½†è¿™ä¸ªå­—æ®µä¸å­˜åœ¨ï¼Œå¯¼è‡´æŠ¥é”™ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤è§¦å‘å™¨å‡½æ•°ï¼ˆæ¨èï¼‰

ä¸ä¾èµ–ä¸å­˜åœ¨çš„ `project_id` å­—æ®µï¼Œä»å…³è”è¡¨è·å–é¡¹ç›®ä¿¡æ¯ã€‚

**ä¿®å¤åçš„ä»£ç ï¼š**

```sql
CREATE OR REPLACE FUNCTION public.notify_payment_request_created()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_project_name text;
  v_user_record record;
BEGIN
  -- âœ… ä»å…³è”çš„è¿å•è®°å½•è·å–é¡¹ç›®ä¿¡æ¯
  SELECT DISTINCT lr.project_name
  INTO v_project_name
  FROM public.payment_request_items pri
  JOIN public.logistics_records lr ON pri.logistics_record_id = lr.id
  WHERE pri.payment_request_id = NEW.id
  LIMIT 1;
  
  -- å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤å€¼
  v_project_name := COALESCE(v_project_name, 'æœªçŸ¥é¡¹ç›®');

  -- é€šçŸ¥æ‰€æœ‰adminå’Œfinanceè§’è‰²çš„ç”¨æˆ·
  FOR v_user_record IN 
    SELECT id FROM public.profiles 
    WHERE role IN ('admin', 'finance') AND is_active = true
  LOOP
    PERFORM public.create_payment_request_notification(
      v_user_record.id,
      NEW.id,
      NEW.total_amount,
      v_project_name
    );
  END LOOP;

  RETURN NEW;
END;
$$;
```

**å…³é”®æ”¹åŠ¨ï¼š**
1. ä¸å†ä½¿ç”¨ `NEW.project_id`
2. é€šè¿‡ `payment_request_items` å’Œ `logistics_records` è·å–é¡¹ç›®åç§°
3. æ·»åŠ å®¹é”™å¤„ç†

---

### æ–¹æ¡ˆ2ï¼šç¦ç”¨è§¦å‘å™¨ï¼ˆä¸´æ—¶ï¼‰

å¦‚æœæš‚æ—¶ä¸éœ€è¦é€šçŸ¥åŠŸèƒ½ï¼Œå¯ä»¥ç¦ç”¨è§¦å‘å™¨ï¼š

```sql
-- ç¦ç”¨è§¦å‘å™¨
DROP TRIGGER IF EXISTS trigger_payment_request_notification ON public.payment_requests;
```

**æ³¨æ„ï¼š** è¿™ä¼šå¯¼è‡´ä»˜æ¬¾ç”³è¯·åˆ›å»ºæ—¶ä¸å†å‘é€é€šçŸ¥ã€‚

---

### æ–¹æ¡ˆ3ï¼šæ·»åŠ project_idå­—æ®µï¼ˆä¸æ¨èï¼‰

ä¸º `payment_requests` è¡¨æ·»åŠ  `project_id` å­—æ®µï¼š

```sql
ALTER TABLE public.payment_requests 
ADD COLUMN IF NOT EXISTS project_id UUID;
```

**ä¸æ¨èåŸå› ï¼š**
- payment_requestså¯èƒ½åŒ…å«å¤šä¸ªé¡¹ç›®çš„è¿å•
- å•ä¸€project_idå­—æ®µä¸å¤Ÿçµæ´»
- éœ€è¦ä¿®æ”¹æ›´å¤šç›¸å…³ä»£ç 

---

## ğŸ”§ åº”ç”¨ä¿®å¤

### ä¿®å¤æ–‡ä»¶

`supabase/migrations/20250816_fix_payment_request_notification_trigger.sql`

### åº”ç”¨æ–¹å¼

**åœ¨Supabase SQL Editorä¸­ï¼š**
```sql
-- ç›´æ¥è¿è¡Œä¿®å¤æ–‡ä»¶çš„å†…å®¹
```

**æˆ–ä½¿ç”¨CLIï¼š**
```bash
supabase db push
```

### éªŒè¯ä¿®å¤

```sql
-- 1. æ£€æŸ¥å‡½æ•°æ˜¯å¦å·²æ›´æ–°
SELECT pg_get_functiondef(oid) 
FROM pg_proc 
WHERE proname = 'notify_payment_request_created';

-- 2. æ£€æŸ¥è§¦å‘å™¨æ˜¯å¦æ­£å¸¸
SELECT 
  tgname AS è§¦å‘å™¨åç§°,
  tgtype AS è§¦å‘å™¨ç±»å‹,
  tgenabled AS æ˜¯å¦å¯ç”¨
FROM pg_trigger
WHERE tgname = 'trigger_payment_request_notification';
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•ä»˜æ¬¾ç”³è¯·åˆ›å»º

1. é€‰æ‹©ä¸€äº›è¿å•è®°å½•
2. ç‚¹å‡»"ä¸€é”®ç”³è¯·ä»˜æ¬¾"
3. åœ¨é¢„è§ˆå¯¹è¯æ¡†ä¸­æŸ¥çœ‹åˆä½œæ–¹åˆ—è¡¨
4. ç‚¹å‡»"ç¡®è®¤å¹¶ç”Ÿæˆç”³è¯·"
5. åº”è¯¥æˆåŠŸï¼Œä¸å†æŠ¥é”™

### é¢„æœŸç»“æœ

- âœ… ä»˜æ¬¾ç”³è¯·åˆ›å»ºæˆåŠŸ
- âœ… è¿å•çŠ¶æ€æ›´æ–°ä¸º"å·²ç”³è¯·æ”¯ä»˜"
- âœ… é€šçŸ¥å‘é€ç»™ç®¡ç†å‘˜å’Œè´¢åŠ¡ï¼ˆå¦‚æœå‡½æ•°æ­£å¸¸ï¼‰
- âœ… ä¸å†å‡ºç° "record new has no field project_id" é”™è¯¯

---

## ğŸ“Š ç›¸å…³è¡¨ç»“æ„

### payment_requestsè¡¨ï¼ˆæ¨æµ‹ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| total_amount | NUMERIC | æ€»é‡‘é¢ |
| status | TEXT | çŠ¶æ€ |
| work_wechat_sp_no | TEXT | ä¼ä¸šå¾®ä¿¡å®¡æ‰¹å•å· |
| approval_result | JSONB | å®¡æ‰¹ç»“æœ |
| created_at | TIMESTAMPTZ | åˆ›å»ºæ—¶é—´ |
| created_by | UUID | åˆ›å»ºäºº |
| user_id | UUID | ç”¨æˆ·ID |
| âŒ project_id | - | **ä¸å­˜åœ¨** |

### partner_payment_itemsè¡¨ï¼ˆå…³è”è¡¨ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| payment_request_id | UUID | ä»˜æ¬¾ç”³è¯·ID |
| logistics_record_id | UUID | è¿å•è®°å½•ID |
| user_id | UUID | ç”¨æˆ·ID |

### æ•°æ®å…³ç³»

```
payment_requests (1)
      â†“ (1å¯¹å¤š)
partner_payment_items (N)
      â†“ (Nå¯¹1)
logistics_records
      â”œâ”€ project_id
      â””â”€ project_name  âœ… é€šè¿‡è¿™é‡Œè·å–é¡¹ç›®ä¿¡æ¯
```

---

## ğŸ¯ å…¶ä»–å¯èƒ½éœ€è¦ä¿®å¤çš„åœ°æ–¹

### æ£€æŸ¥å…¶ä»–è§¦å‘å™¨

```sql
-- æŸ¥æ‰¾æ‰€æœ‰ä½¿ç”¨NEW.project_idçš„è§¦å‘å™¨
SELECT 
  t.tgname AS è§¦å‘å™¨å,
  p.proname AS å‡½æ•°å,
  pg_get_functiondef(p.oid) AS å‡½æ•°å®šä¹‰
FROM pg_trigger t
JOIN pg_proc p ON t.tgfoid = p.oid
WHERE pg_get_functiondef(p.oid) LIKE '%NEW.project_id%'
  OR pg_get_functiondef(p.oid) LIKE '%new.project_id%';
```

### æ£€æŸ¥å…¶ä»–å‡½æ•°

```sql
-- æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½ä½¿ç”¨payment_requests.project_idçš„å‡½æ•°
SELECT 
  proname AS å‡½æ•°å,
  pg_get_functiondef(oid) AS å‡½æ•°å®šä¹‰
FROM pg_proc
WHERE pg_get_functiondef(oid) LIKE '%payment_requests%project_id%';
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½æ•°æ®**
   - ä¿®æ”¹è§¦å‘å™¨å‰å…ˆç¡®è®¤å½“å‰ç³»ç»ŸçŠ¶æ€
   - å¦‚æœ‰éœ€è¦ï¼Œå¯¼å‡ºpayment_requestsæ•°æ®

2. **é€šçŸ¥åŠŸèƒ½å½±å“**
   - ä¿®å¤åï¼Œé€šçŸ¥ä¼šåŒ…å«æ­£ç¡®çš„é¡¹ç›®åç§°
   - å¦‚æœpayment_request_itemsä¸ºç©ºï¼Œæ˜¾ç¤º"æœªçŸ¥é¡¹ç›®"

3. **æµ‹è¯•å»ºè®®**
   - å…ˆåœ¨æµ‹è¯•ç¯å¢ƒåº”ç”¨ä¿®å¤
   - éªŒè¯ä»˜æ¬¾ç”³è¯·åˆ›å»ºæµç¨‹
   - ç¡®è®¤é€šçŸ¥æ­£å¸¸å‘é€

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [API_DOCUMENTATION.md](./API_DOCUMENTATION.md) - APIæ–‡æ¡£
- [å¼€ç¥¨ç”³è¯·åŠŸèƒ½è¯´æ˜.md](./å¼€ç¥¨ç”³è¯·åŠŸèƒ½è¯´æ˜.md) - å¼€ç¥¨ç”³è¯·åŠŸèƒ½

---

**ä¿®å¤æ–‡ä»¶ï¼š** `supabase/migrations/20250816_fix_payment_request_notification_trigger.sql`  
**é”™è¯¯çº§åˆ«ï¼š** ğŸ”´ é«˜ï¼ˆé˜»æ­¢ä»˜æ¬¾ç”³è¯·åˆ›å»ºï¼‰  
**ä¿®å¤çŠ¶æ€ï¼š** âœ… å·²åˆ›å»ºä¿®å¤è¿ç§»  
**éœ€è¦åº”ç”¨ï¼š** æ˜¯

