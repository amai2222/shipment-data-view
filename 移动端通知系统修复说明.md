# 移动端通知系统修复说明

## 🐛 问题描述

**问题**: 移动端通知页面显示的数据和实际不一样  
**原因**: 使用的是**模拟假数据**（mockNotifications），而不是从数据库读取真实数据

---

## 🔍 问题详情

### 原代码分析

```typescript
// ❌ 问题代码：使用硬编码的假数据
const mockNotifications: Notification[] = [
  {
    id: '1',
    type: 'warning',
    title: '付款申请待审批',
    message: '有5笔付款申请等待您的审批，总金额¥125,000',
    time: '2024-01-15T10:30:00Z',
    isRead: false,
    category: 'finance'
  },
  // ... 更多假数据
];

const [notifications, setNotifications] = useState(mockNotifications);
```

**问题**:
1. 数据是写死的，不是从数据库来的
2. 所有用户看到的都是相同的假数据
3. 操作（标记已读、删除）只改变本地状态，不保存到数据库
4. 刷新页面后，所有操作都会丢失

---

## ✅ 解决方案

### 1. 创建真实的通知系统 ⭐⭐⭐⭐⭐

已创建完整的数据库通知系统：

**SQL文件**: `supabase/migrations/create_notifications_system.sql`

**包含内容**:
- ✅ `notifications` 表 - 存储所有通知
- ✅ 索引优化 - 提升查询性能
- ✅ RLS策略 - 用户只能看自己的通知
- ✅ 通知生成函数 - 自动创建通知
- ✅ 查询函数 - 获取通知列表
- ✅ 操作函数 - 标记已读、删除等
- ✅ 自动触发器 - 业务事件自动通知

### 2. 修改通知页面使用真实数据 ✅

**修改文件**: `src/pages/mobile/MobileNotifications.tsx`

**主要改进**:
```typescript
// ✅ 优化后：从数据库获取真实数据
const { data: notifications = [], isLoading } = useQuery({
  queryKey: ['user-notifications', user?.id],
  queryFn: async () => {
    const { data, error } = await supabase.rpc('get_user_notifications', {
      p_user_id: user.id,
      p_limit: 100,
      p_offset: 0,
      p_is_read: null
    });
    
    if (error) throw error;
    return processNotifications(data);
  },
  staleTime: 30 * 1000,
  refetchInterval: 60 * 1000, // 每分钟自动刷新
});

// ✅ 真实的未读数量
const { data: unreadCount = 0 } = useQuery({
  queryKey: ['unread-notification-count', user?.id],
  queryFn: async () => {
    const { data } = await supabase.rpc('get_unread_notification_count', {
      p_user_id: user.id
    });
    return data || 0;
  },
  refetchInterval: 60 * 1000,
});
```

---

## 📋 通知系统功能

### 数据库表结构

```sql
CREATE TABLE notifications (
  id uuid PRIMARY KEY,
  user_id uuid,              -- 接收通知的用户
  type text,                 -- 通知类型: info/warning/success/error
  category text,             -- 分类: system/business/finance/contract
  title text,                -- 通知标题
  message text,              -- 通知内容
  link text,                 -- 跳转链接（可选）
  related_id uuid,           -- 关联记录ID
  is_read boolean,           -- 是否已读
  created_at timestamptz,    -- 创建时间
  read_at timestamptz,       -- 阅读时间
  metadata jsonb             -- 额外数据
);
```

### 自动通知场景

#### 1. 付款申请创建时 ✅
```sql
-- 触发器自动执行
当有新的付款申请创建时：
→ 自动通知所有admin和finance角色用户
→ 显示项目名称和申请金额
→ 提供跳转链接
```

#### 2. 合同即将到期时 ✅
```sql
-- 定时任务检查
每天自动检查：
→ 找到30天内到期的合同
→ 通知负责人和管理员
→ 避免7天内重复通知
```

#### 3. 项目完成时 ✅
```sql
-- 可手动调用
项目完成时：
→ 通知项目相关人员
→ 显示总运量等关键数据
→ 提供项目详情链接
```

---

## 🎯 通知功能特性

### 前端功能

1. **实时数据** ✅
   - 从数据库读取真实通知
   - 每分钟自动刷新
   - 显示实际未读数量

2. **智能刷新** ✅
   - 30秒缓存策略
   - 操作后自动刷新
   - 不阻塞用户交互

3. **完整操作** ✅
   - 标记单个已读
   - 全部标记已读
   - 删除通知
   - 点击跳转相关页面

4. **分类筛选** ✅
   - 全部通知
   - 未读通知
   - 业务通知
   - 财务通知

### 后端功能

1. **通知生成** ✅
   - 付款申请通知
   - 合同到期提醒
   - 项目完成通知
   - 可扩展其他通知

2. **自动触发** ✅
   - 付款申请自动通知
   - 合同到期自动检查
   - 业务事件自动通知

3. **权限控制** ✅
   - 用户只能看自己的通知
   - RLS策略保护
   - 安全的数据访问

4. **性能优化** ✅
   - 索引优化
   - 查询高效
   - 批量操作支持

---

## 🚀 使用步骤

### 第一步：执行数据库迁移（3分钟）

```bash
# 方法1: 使用Supabase Dashboard
1. 打开 Supabase Dashboard
2. 进入 SQL Editor
3. 复制并执行 create_notifications_system.sql

# 方法2: 使用Supabase CLI
supabase migration new create_notifications_system
# 复制SQL内容到新建的migration文件
supabase db push
```

### 第二步：验证表创建（1分钟）

```sql
-- 在Supabase SQL Editor中执行
SELECT * FROM notifications LIMIT 5;

-- 应该返回空结果（暂无通知）
```

### 第三步：测试通知功能（2分钟）

```sql
-- 手动创建一条测试通知
INSERT INTO notifications (
  user_id,
  type,
  category,
  title,
  message
) VALUES (
  auth.uid(), -- 当前用户ID
  'info',
  'system',
  '测试通知',
  '这是一条测试通知，验证系统正常工作'
);

-- 查询验证
SELECT * FROM notifications WHERE user_id = auth.uid();
```

### 第四步：访问通知页面（1分钟）

```
访问 /m/notifications
应该看到刚创建的测试通知
```

---

## 📊 功能对比

### 优化前 ❌

| 功能 | 状态 | 说明 |
|------|------|------|
| 数据来源 | ❌ 假数据 | 硬编码的mockNotifications |
| 数据同步 | ❌ 无 | 不保存到数据库 |
| 用户隔离 | ❌ 无 | 所有用户看到相同数据 |
| 实时更新 | ❌ 无 | 需要刷新页面 |
| 持久化 | ❌ 无 | 操作不保存 |
| 自动通知 | ❌ 无 | 无业务触发器 |

### 优化后 ✅

| 功能 | 状态 | 说明 |
|------|------|------|
| 数据来源 | ✅ 真实 | 从数据库读取 |
| 数据同步 | ✅ 有 | 实时同步 |
| 用户隔离 | ✅ 有 | 每个用户看自己的通知 |
| 实时更新 | ✅ 有 | 每分钟自动刷新 |
| 持久化 | ✅ 有 | 所有操作保存到数据库 |
| 自动通知 | ✅ 有 | 付款申请自动通知 |

---

## 🔧 通知API使用

### 前端调用示例

#### 获取通知列表
```typescript
const { data: notifications } = useQuery({
  queryKey: ['user-notifications', userId],
  queryFn: async () => {
    const { data } = await supabase.rpc('get_user_notifications', {
      p_user_id: userId,
      p_limit: 50,
      p_is_read: null // null=全部, true=已读, false=未读
    });
    return data;
  }
});
```

#### 标记已读
```typescript
await supabase.rpc('mark_notification_as_read', {
  p_notification_id: notificationId,
  p_user_id: userId
});
```

#### 删除通知
```typescript
await supabase.rpc('delete_notification', {
  p_notification_id: notificationId,
  p_user_id: userId
});
```

### 后端触发通知

#### 创建付款申请通知
```sql
SELECT create_payment_request_notification(
  'user-uuid',           -- 用户ID
  'request-uuid',        -- 申请单ID
  50000,                 -- 金额
  '煤炭运输A'            -- 项目名称
);
```

#### 检查合同到期
```sql
-- 可以设置为定时任务（每天执行一次）
SELECT check_expiring_contracts();
```

---

## 📱 前端功能增强

### 1. 自动刷新
```typescript
refetchInterval: 60 * 1000  // 每分钟自动刷新
```

### 2. 智能缓存
```typescript
staleTime: 30 * 1000  // 30秒内使用缓存
```

### 3. 点击跳转
```typescript
onClick={() => {
  markAsRead(notification.id);
  if (notification.link) {
    navigate(notification.link);
  }
}}
```

### 4. 加载状态
```typescript
if (isLoading) {
  return <MobileSkeletonLoader type="list" />;
}
```

---

## 🎯 扩展通知场景

### 建议添加的通知

#### 1. 运单审批通知
```sql
CREATE OR REPLACE FUNCTION create_waybill_approval_notification(...)
RETURNS void AS $$
BEGIN
  INSERT INTO notifications (...)
  VALUES ('运单待审批', '运单编号XXX需要您的审批', ...);
END;
$$;
```

#### 2. 数据异常通知
```sql
-- 当发现数据异常时
INSERT INTO notifications (type, category, title, message)
VALUES ('error', 'system', '数据异常', '发现XX条数据异常...');
```

#### 3. 任务完成通知
```sql
-- 批量导入完成
-- 报表生成完成
-- 数据同步完成
```

---

## 📊 通知类型说明

### 通知类型（type）

| 类型 | 图标 | 颜色 | 用途 |
|------|------|------|------|
| info | ℹ️ | 蓝色 | 一般信息通知 |
| warning | ⚠️ | 橙色 | 警告提醒 |
| success | ✅ | 绿色 | 成功消息 |
| error | ❌ | 红色 | 错误提醒 |

### 通知分类（category）

| 分类 | 说明 | 示例 |
|------|------|------|
| system | 系统通知 | 系统升级、维护通知 |
| business | 业务通知 | 运单、项目相关 |
| finance | 财务通知 | 付款、开票申请 |
| contract | 合同通知 | 合同到期提醒 |

---

## 🔧 部署步骤

### 必需步骤

#### 1. 执行数据库迁移 ⭐⭐⭐⭐⭐
```bash
# 在Supabase Dashboard SQL Editor中执行
supabase/migrations/create_notifications_system.sql
```

#### 2. 验证功能
```sql
-- 创建测试通知
INSERT INTO notifications (
  user_id, type, category, title, message
) VALUES (
  auth.uid(), 'info', 'system', '欢迎使用通知系统', '通知系统已成功启用！'
);

-- 查看通知
SELECT * FROM get_user_notifications(auth.uid(), 10, 0, null);
```

#### 3. 测试前端页面
```
访问 /m/notifications
应该看到刚创建的通知
```

### 可选步骤

#### 4. 设置定时任务（合同到期检查）
```bash
# 在Supabase Dashboard中设置Cron Job
# 每天凌晨执行
0 0 * * * SELECT check_expiring_contracts();
```

---

## 📱 前端集成

### 在其他页面显示未读数量

```typescript
// 在导航栏显示未读通知数
import { useQuery } from '@tanstack/react-query';
import { useAuth } from '@/contexts/AuthContext';

function NavBar() {
  const { user } = useAuth();
  
  const { data: unreadCount = 0 } = useQuery({
    queryKey: ['unread-notification-count', user?.id],
    queryFn: async () => {
      const { data } = await supabase.rpc('get_unread_notification_count', {
        p_user_id: user.id
      });
      return data || 0;
    },
    enabled: !!user?.id,
    refetchInterval: 60 * 1000, // 每分钟刷新
  });

  return (
    <Button onClick={() => navigate('/m/notifications')}>
      <Bell className="h-5 w-5" />
      {unreadCount > 0 && (
        <Badge variant="destructive">{unreadCount}</Badge>
      )}
    </Button>
  );
}
```

---

## 🎯 完整的通知流程

### 示例：付款申请流程

```
1. 用户提交付款申请
   ↓
2. 触发器自动执行
   ↓
3. 查找所有admin和finance用户
   ↓
4. 为每个用户创建通知
   ↓
5. 用户打开通知页面
   ↓
6. 看到新通知（实时数据）
   ↓
7. 点击通知
   ↓
8. 跳转到付款申请管理页面
   ↓
9. 标记为已读（保存到数据库）
```

---

## 📊 对比总结

### 数据来源对比

| 方面 | 优化前 | 优化后 |
|------|--------|--------|
| 数据源 | 硬编码假数据 | 数据库真实数据 |
| 更新方式 | 不更新 | 自动刷新 |
| 用户隔离 | 无（所有人看相同数据） | 有（每人看自己的） |
| 持久化 | 无 | 有 |
| 自动生成 | 无 | 有（业务触发） |

### 功能对比

| 功能 | 优化前 | 优化后 |
|------|--------|--------|
| 标记已读 | 只改本地 | 保存到数据库 ✅ |
| 删除通知 | 只改本地 | 从数据库删除 ✅ |
| 未读数量 | 本地计算 | 数据库查询 ✅ |
| 自动通知 | 无 | 业务触发 ✅ |
| 实时刷新 | 无 | 每分钟刷新 ✅ |

---

## 🔮 扩展建议

### 可以添加的通知类型

1. **运单相关**
   - 新运单录入通知
   - 运单审批通知
   - 运单异常通知

2. **财务相关**
   - 开票申请通知
   - 付款完成通知
   - 对账提醒

3. **合同相关**
   - 合同到期提醒 ✅（已实现）
   - 合同审批通知
   - 合同变更通知

4. **系统相关**
   - 系统维护通知
   - 数据同步完成
   - 批量操作结果

---

## ✅ 验证清单

### 数据库验证
- [ ] notifications表已创建
- [ ] 索引已创建
- [ ] RLS策略已启用
- [ ] 通知函数可用
- [ ] 触发器已绑定

### 前端验证
- [ ] 页面加载显示真实数据
- [ ] 标记已读功能正常
- [ ] 删除通知功能正常
- [ ] 未读数量准确
- [ ] 自动刷新工作正常

### 业务验证
- [ ] 创建付款申请后收到通知
- [ ] 通知可以正常跳转
- [ ] 多用户隔离正常

---

## 📚 相关文档

- [数据库优化指南](./数据库查询优化指南.md) - 数据库优化
- [代码优化指南](./代码优化快速使用指南.md) - 代码优化

---

## ✨ 总结

### 问题
- ❌ 使用假数据
- ❌ 数据不准确
- ❌ 操作不保存

### 解决
- ✅ 创建真实通知系统
- ✅ 从数据库读取数据
- ✅ 所有操作持久化
- ✅ 自动刷新机制
- ✅ 业务自动触发

### 效果
- 🎯 数据真实准确
- ⚡ 每分钟自动刷新
- 💾 所有操作保存
- 🔔 业务自动通知
- 😊 用户体验优秀

---

**现在通知系统使用真实数据，准确可靠！** 🎉

---

*修复日期: 2025年1月8日*  
*影响范围: 移动端通知功能*  
*状态: ✅ 已修复，需执行数据库迁移*

