# 立即部署 - 批量修改功能

## 🚀 快速部署（3步）

### 步骤1：部署链路修改函数修复
在 **Supabase Dashboard → SQL Editor** 中执行：

**文件**：`合作链路修改-使用正确重算逻辑.sql`

**作用**：修复单个链路修改的重算逻辑

### 步骤2：部署批量操作函数
在 **Supabase Dashboard → SQL Editor** 中执行：

**文件**：`supabase/migrations/20251025_add_batch_modify_functions.sql`

**作用**：添加批量修改应收和批量修改链路的函数

### 步骤3：刷新浏览器
按 `Ctrl + Shift + R` 强制刷新

---

## ✅ 完成标志

### 步骤1完成标志
看到消息：
```
✅ 修复完成！使用标准重算逻辑
```

### 步骤2完成标志
看到消息：
```
✅ 批量修改功能创建完成
```

### 功能验证
1. 进入付款审核页面
2. 勾选几条运单
3. 应该看到：
   - 蓝色提示栏显示"已选择 X 条记录"
   - 右侧有两个按钮：**批量修改应收** | **批量修改链路**

---

## 🎯 新增的UI元素

### 批量操作提示栏（选择运单后显示）
```
┌─────────────────────────────────────────────────────────┐
│ 已选择 3 条记录  [清除选择]                              │
│               [批量修改应收] [批量修改链路]              │
└─────────────────────────────────────────────────────────┘
```

### 批量修改应收对话框
- 标题：🟢 批量修改应收
- 输入：新的应付金额
- 提示：只修改最高级合作方，自动跳过已付款/已开票

### 批量修改链路对话框
- 标题：🟣 批量修改合作链路
- 选择：从下拉列表选择新链路
- 提示：自动重算成本，必须是同一项目

---

## 📝 功能特点

### 智能跳过
系统会自动跳过不符合条件的运单：
- 已申请付款
- 已完成付款
- 已申请开票
- 已完成开票
- 无合作方（修改应收时）
- 链路不存在（修改链路时）

### 详细反馈
- ✅ 成功数量统计
- ✅ 失败数量统计
- ✅ 失败原因显示（控制台F12）
- ✅ 批量修改链路还会显示重算的合作方总数

### 权限控制
- ✅ 只有管理员、财务、操作员可以操作
- ✅ 其他角色看不到批量操作按钮

---

## 🔍 测试建议

### 测试1：批量修改应收
1. 选择3条"未支付"的运单
2. 点击"批量修改应收"
3. 输入金额：3500
4. 确认修改
5. **预期**：成功更新3条

### 测试2：批量修改链路（成功场景）
1. 筛选出某个项目的运单（如"中粮可乐"）
2. 选择3条"未支付"的运单
3. 点击"批量修改链路"
4. 选择"线下张海宽"
5. 确认修改
6. **预期**：成功更新3条，重新计算9个合作方成本（假设每条有3个合作方）

### 测试3：批量修改（跳过场景）
1. 选择5条运单（其中2条已申请付款）
2. 点击"批量修改应收"
3. 输入金额：3000
4. 确认修改
5. **预期**：成功3条，失败2条（已申请付款）

### 测试4：不同项目（应该失败）
1. 选择来自不同项目的运单
2. 点击"批量修改链路"
3. **预期**：可能只显示第一个项目的链路，或操作失败

---

## 🐛 故障排除

### 问题：批量操作按钮不显示
**原因**：没有选择运单  
**解决**：勾选至少一条运单

### 问题：批量修改链路下拉列表为空
**原因**：该项目没有配置合作链路  
**解决**：在项目管理中为该项目添加合作链路

### 问题：所有运单都修改失败
**检查**：
1. 当前用户角色是否为 admin/finance/operator
2. 运单状态是否为"未支付"且"未开票"
3. 按F12查看控制台的详细错误

---

## 📦 文件清单

### SQL文件（需要执行）
1. ✅ `合作链路修改-使用正确重算逻辑.sql` - 先执行
2. ✅ `supabase/migrations/20251025_add_batch_modify_functions.sql` - 后执行

### 前端文件（已自动更新）
1. ✅ `src/pages/PaymentRequest.tsx` - 已添加批量功能

### 文档文件
1. ✅ `批量修改应收和链路功能使用说明.md` - 详细使用说明
2. ✅ `批量修改功能实现完成总结.md` - 实现总结
3. ✅ `立即部署-批量修改功能.md` - 本文件

---

## ⏱️ 预计部署时间

- SQL执行：< 1分钟
- 浏览器刷新：< 10秒
- 功能测试：5-10分钟

**总计：约10分钟即可完成部署和验证**

---

## 🎉 完成后的效果

部署完成后，财务人员可以：
- ⚡ 一次性修改多条运单的应收金额
- ⚡ 一次性更换多条运单的合作链路
- ⚡ 自动重新计算所有合作方成本
- ⚡ 清晰的成功/失败反馈

**效率提升**：从逐条操作变为批量操作，工作效率提升 **10倍以上**！

