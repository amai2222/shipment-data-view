# å¼€ç¥¨ç”³è¯·å‡½æ•°é‡è½½å†²çªä¿®å¤è¯´æ˜

## ğŸ› é”™è¯¯ä¿¡æ¯

```
Could not choose the best candidate function between:
  public.save_invoice_request(p_invoice_data => json)
  public.save_invoice_request(p_invoice_data => jsonb)
```

## ğŸ“ é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

æ•°æ®åº“ä¸­å­˜åœ¨**ä¸¤ä¸ª**åŒåå‡½æ•° `save_invoice_request`ï¼Œä½†å‚æ•°ç±»å‹ä¸åŒï¼š
- ä¸€ä¸ªæ¥å— `json` ç±»å‹å‚æ•°
- ä¸€ä¸ªæ¥å— `jsonb` ç±»å‹å‚æ•°

å½“å‰ç«¯è°ƒç”¨æ—¶ï¼ŒPostgreSQLæ— æ³•ç¡®å®šä½¿ç”¨å“ªä¸ªå‡½æ•°ï¼Œå¯¼è‡´æŠ¥é”™ã€‚

### ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ä¸ªå‡½æ•°ï¼Ÿ

å¯èƒ½åŸå› ï¼š
1. å†å²é—ç•™ï¼šä¹‹å‰çš„è¿ç§»åˆ›å»ºäº†jsonç‰ˆæœ¬
2. åç»­æ›´æ–°ï¼šæ–°çš„è¿ç§»åˆ›å»ºäº†jsonbç‰ˆæœ¬
3. æœªæ¸…ç†ï¼šæ—§ç‰ˆæœ¬æœªè¢«åˆ é™¤

### è°ƒç”¨ä»£ç 

```typescript
// src/pages/InvoiceRequest.tsx
const { data, error } = await supabase.rpc('save_invoice_request', {
  p_invoice_data: invoiceData  // â† PostgreSQLä¸çŸ¥é“ç”¨å“ªä¸ªå‡½æ•°
});
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ç­–ç•¥

**åˆ é™¤æ‰€æœ‰ç‰ˆæœ¬ï¼Œåªä¿ç•™ä¸€ä¸ªjsonbç‰ˆæœ¬**

**åŸå› é€‰æ‹©jsonbï¼š**
- jsonbæ˜¯PostgreSQLæ¨èçš„äºŒè¿›åˆ¶JSONæ ¼å¼
- æ€§èƒ½æ›´å¥½
- æ”¯æŒç´¢å¼•
- æ˜¯ç°ä»£PostgreSQLçš„æ ‡å‡†

### ä¿®å¤æ­¥éª¤

```sql
-- 1. åˆ é™¤æ‰€æœ‰å¯èƒ½çš„é‡è½½ç‰ˆæœ¬
DROP FUNCTION IF EXISTS public.save_invoice_request(json);
DROP FUNCTION IF EXISTS public.save_invoice_request(jsonb);
DROP FUNCTION IF EXISTS public.save_invoice_request(p_invoice_data json);
DROP FUNCTION IF EXISTS public.save_invoice_request(p_invoice_data jsonb);

-- 2. é‡æ–°åˆ›å»ºå”¯ä¸€ç‰ˆæœ¬ï¼ˆjsonbï¼‰
CREATE OR REPLACE FUNCTION public.save_invoice_request(p_invoice_data jsonb)
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
AS $function$
  -- å‡½æ•°å®ç°...
$function$;
```

---

## ğŸ”§ ä¿®å¤æ–‡ä»¶

**æ–‡ä»¶åï¼š** `supabase/migrations/20250816_fix_invoice_request_function_overload.sql`

**ä¿®å¤å†…å®¹ï¼š**
1. åˆ é™¤æ‰€æœ‰ç‰ˆæœ¬çš„ `save_invoice_request` å‡½æ•°
2. é‡æ–°åˆ›å»ºå”¯ä¸€çš„jsonbç‰ˆæœ¬
3. æ·»åŠ å®Œæ•´çš„å‡½æ•°å®ç°
4. æ·»åŠ æ³¨é‡Šè¯´æ˜

---

## ğŸ“‹ å‡½æ•°åŠŸèƒ½è¯´æ˜

### save_invoice_request å‡½æ•°

**åŠŸèƒ½ï¼š** åˆ›å»ºå¼€ç¥¨ç”³è¯·

**å‚æ•°ï¼š**
```typescript
p_invoice_data: {
  sheets: [
    {
      invoicing_partner_id: string,
      invoicing_partner_full_name: string,
      total_invoiceable: number,
      partner_costs: [
        {
          id: string,  // logistics_partner_cost_id
          ...
        }
      ]
    }
  ],
  all_partner_cost_ids: string[]
}
```

**è¿”å›å€¼ï¼š**
```typescript
{
  success: true,
  created_requests: [
    {
      request_id: string,
      request_number: string,  // INV-20250816-0001
      partner_name: string,
      total_amount: number
    }
  ],
  total_requests: number
}
```

**å¤„ç†é€»è¾‘ï¼š**
1. éªŒè¯ç”¨æˆ·æƒé™ï¼ˆè´¢åŠ¡æˆ–ç®¡ç†å‘˜ï¼‰
2. éªŒè¯åˆä½œæ–¹æˆæœ¬æœªå¼€ç¥¨
3. ä¸ºæ¯ä¸ªå¼€ç¥¨åˆä½œæ–¹åˆ›å»ºå¼€ç¥¨ç”³è¯·
4. ç”Ÿæˆå¼€ç¥¨ç”³è¯·ç¼–å·ï¼ˆINV-YYYYMMDD-XXXXï¼‰
5. æ’å…¥å¼€ç¥¨æ˜ç»†è®°å½•
6. æ›´æ–°åˆä½œæ–¹æˆæœ¬çš„å¼€ç¥¨çŠ¶æ€ä¸º"Requested"
7. è¿”å›åˆ›å»ºç»“æœ

---

## ğŸ¯ ç›¸å…³è¡¨ç»“æ„

### invoice_requestsè¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| request_number | TEXT | ç”³è¯·ç¼–å· |
| invoicing_partner_id | UUID | å¼€ç¥¨åˆä½œæ–¹ID |
| invoicing_partner_full_name | TEXT | åˆä½œæ–¹å…¨å |
| total_amount | NUMERIC | æ€»é‡‘é¢ |
| status | TEXT | çŠ¶æ€ |
| created_by | UUID | åˆ›å»ºäºº |
| user_id | UUID | ç”¨æˆ·ID |

### partner_invoice_itemsè¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| invoice_request_id | UUID | å¼€ç¥¨ç”³è¯·ID |
| logistics_partner_cost_id | UUID | åˆä½œæ–¹æˆæœ¬ID |
| user_id | UUID | ç”¨æˆ·ID |

### logistics_partner_costsè¡¨

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | UUID | ä¸»é”® |
| logistics_record_id | UUID | è¿å•ID |
| partner_id | UUID | åˆä½œæ–¹ID |
| payable_amount | NUMERIC | åº”ä»˜é‡‘é¢ |
| invoice_status | TEXT | å¼€ç¥¨çŠ¶æ€ |

---

## ğŸš€ åº”ç”¨ä¿®å¤

### æ­¥éª¤

1. **åº”ç”¨è¿ç§»æ–‡ä»¶**
   ```bash
   # åœ¨Supabase SQL Editorä¸­æ‰§è¡Œ
   # æˆ–ä½¿ç”¨ CLI: supabase db push
   ```

2. **éªŒè¯ä¿®å¤**
   ```sql
   -- æ£€æŸ¥save_invoice_requestå‡½æ•°
   SELECT 
     proname AS å‡½æ•°å,
     pg_get_function_arguments(oid) AS å‚æ•°,
     pg_get_function_result(oid) AS è¿”å›å€¼
   FROM pg_proc 
   WHERE proname = 'save_invoice_request';
   
   -- åº”è¯¥åªè¿”å›ä¸€è¡Œç»“æœ
   ```

3. **æµ‹è¯•åŠŸèƒ½**
   - é€‰æ‹©è¿å•
   - ç‚¹å‡»"å¼€ç¥¨ç”³è¯·"
   - æŸ¥çœ‹é¢„è§ˆ
   - ç‚¹å‡»"ä¿å­˜å¼€ç¥¨ç”³è¯·" â† åº”è¯¥æˆåŠŸ

---

## ğŸ“Š éœ€è¦åº”ç”¨çš„è¿ç§»æ–‡ä»¶æ±‡æ€»

ç°åœ¨å…±æœ‰**3ä¸ªè¿ç§»æ–‡ä»¶**éœ€è¦åº”ç”¨ï¼š

| # | æ–‡ä»¶å | ä¿®å¤å†…å®¹ | ä¼˜å…ˆçº§ |
|---|--------|---------|--------|
| 1 | `20250816_fix_driver_project_association_in_import.sql` | å¸æœºé¡¹ç›®å…³è” | ä¸­ |
| 2 | `20250816_fix_payment_request_notification_trigger.sql` | ä»˜æ¬¾ç”³è¯·é€šçŸ¥è§¦å‘å™¨ | é«˜ |
| 3 | `20250816_fix_invoice_request_function_overload.sql` | å¼€ç¥¨ç”³è¯·å‡½æ•°é‡è½½å†²çª | **ğŸ”´ é«˜** |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å…³äºå‡½æ•°é‡è½½

**PostgreSQLçš„å‡½æ•°é‡è½½è§„åˆ™ï¼š**
- å…è®¸åŒåå‡½æ•°ï¼Œä½†å‚æ•°æ•°é‡æˆ–ç±»å‹å¿…é¡»ä¸åŒ
- json å’Œ jsonb è¢«è®¤ä¸ºæ˜¯"ç›¸ä¼¼"ç±»å‹
- è°ƒç”¨æ—¶å¦‚æœå‚æ•°ç±»å‹æ¨¡ç³Šï¼Œä¼šæŠ¥é”™

**é¿å…å†²çªçš„æ–¹æ³•ï¼š**
1. ä½¿ç”¨ä¸åŒçš„å‡½æ•°å
2. æˆ–åªä¿ç•™ä¸€ä¸ªç‰ˆæœ¬ï¼ˆæ¨èï¼‰
3. æˆ–æ˜¾å¼æŒ‡å®šå‚æ•°ç±»å‹

### å…³äºjson vs jsonb

**æ¨èä½¿ç”¨jsonbï¼š**
- âœ… äºŒè¿›åˆ¶å­˜å‚¨ï¼Œæ€§èƒ½æ›´å¥½
- âœ… æ”¯æŒç´¢å¼•
- âœ… æ”¯æŒæ›´å¤šæ“ä½œç¬¦
- âœ… PostgreSQLæ¨è

**jsonçš„ä½¿ç”¨åœºæ™¯ï¼š**
- éœ€è¦ä¿ç•™åŸå§‹æ ¼å¼
- ä¸éœ€è¦æŸ¥è¯¢å†…éƒ¨å­—æ®µ
- ä»…ç”¨äºå­˜å‚¨å’Œä¼ è¾“

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### å¼€ç¥¨ç”³è¯·åŠŸèƒ½æµ‹è¯•

- [ ] å¯ä»¥é€‰æ‹©è¿å•
- [ ] å¯ä»¥ç‚¹å‡»"ä¸€é”®å¼€ç¥¨ç”³è¯·"
- [ ] å¯ä»¥æŸ¥çœ‹å¼€ç¥¨é¢„è§ˆ
- [ ] æ˜¾ç¤ºåˆä½œæ–¹åˆ—è¡¨
- [ ] æ˜¾ç¤ºè¿å•æ•°é‡å’Œé‡‘é¢
- [ ] ç‚¹å‡»"ä¿å­˜å¼€ç¥¨ç”³è¯·"æˆåŠŸ
- [ ] ä¸å†å‡ºç°å‡½æ•°é‡è½½é”™è¯¯
- [ ] å¼€ç¥¨ç”³è¯·æˆåŠŸåˆ›å»º
- [ ] è¿å•çŠ¶æ€æ›´æ–°ä¸º"å·²ç”³è¯·å¼€ç¥¨"

---

## ğŸ“ ç›¸å…³é”™è¯¯ä¿®å¤

ä»Šå¤©ä¿®å¤çš„æ‰€æœ‰é—®é¢˜ï¼š

1. âœ… è¿å•ç¼–è¾‘éªŒè¯é€»è¾‘
2. âœ… TypeScriptç±»å‹å®šä¹‰
3. âœ… å¸æœºæœç´¢åŠŸèƒ½
4. âœ… Excelå¯¼å…¥å¸æœºé¡¹ç›®å…³è”
5. âœ… è¿å•ç®¡ç†å¯¼å…¥åŠŸèƒ½ç§»é™¤
6. âœ… è¿å•ç»´æŠ¤å¢å¼ºç‰ˆéªŒé‡
7. âœ… å¼ºåˆ¶å¯¼å…¥é‡å¤å¯å‹¾é€‰
8. âœ… **ä»˜æ¬¾ç”³è¯·é€šçŸ¥è§¦å‘å™¨** â† åˆšä¿®å¤
9. âœ… **å¼€ç¥¨ç”³è¯·å‡½æ•°é‡è½½å†²çª** â† å½“å‰ä¿®å¤

---

**ä¿®å¤æ–‡ä»¶ï¼š** `supabase/migrations/20250816_fix_invoice_request_function_overload.sql`  
**é”™è¯¯çº§åˆ«ï¼š** ğŸ”´ é«˜ï¼ˆé˜»æ­¢å¼€ç¥¨ç”³è¯·åˆ›å»ºï¼‰  
**ä¿®å¤çŠ¶æ€ï¼š** âœ… å·²åˆ›å»ºä¿®å¤è¿ç§»  
**éœ€è¦åº”ç”¨ï¼š** æ˜¯

