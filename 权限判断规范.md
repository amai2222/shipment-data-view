# 权限判断规范

> **重要规则**: 所有权限判断必须使用权限系统，禁止硬编码角色判断

---

## ❌ 禁止的硬编码方式

### 前端（React/TypeScript）

```typescript
// ❌ 错误：硬编码角色判断
if (user.role === 'admin') { ... }
if (user.role === 'finance') { ... }
if (['admin', 'finance'].includes(user.role)) { ... }

// ❌ 错误：直接判断 profile.role
if (profile?.role === 'admin') { ... }
```

### 后端（数据库函数/SQL）

```sql
-- ❌ 错误：硬编码角色判断
IF user_role = 'admin' THEN ...
IF user_role IN ('admin', 'finance') THEN ...
WHERE role = 'admin'
WHERE role IN ('admin', 'finance', 'operator')
```

---

## ✅ 正确的权限判断方式

### 前端（React/TypeScript）

#### 1. 使用 `useUnifiedPermissions` Hook（推荐）⭐

```typescript
import { useUnifiedPermissions } from '@/hooks/useUnifiedPermissions';

function MyComponent() {
  const { 
    hasMenuAccess,        // 检查菜单权限
    hasFunctionAccess,    // 检查功能权限
    hasButtonAccess,      // 检查按钮权限
    hasPageAccess,        // 检查页面权限
    hasDataAccess,        // 检查数据权限
    isAdmin,              // 是否为管理员（兼容）
    hasRole               // 检查角色（兼容，但不推荐）
  } = useUnifiedPermissions();

  // ✅ 正确：使用权限系统
  if (hasMenuAccess('settings.users')) {
    return <SettingsMenu />;
  }

  // ✅ 正确：检查按钮权限
  {hasButtonAccess('logistics.edit') && (
    <Button onClick={handleEdit}>编辑</Button>
  )}

  // ✅ 正确：检查功能权限
  if (hasFunctionAccess('payment.approve')) {
    // 允许审批
  }
}
```

#### 2. 使用 `PermissionGuard` 组件

```typescript
import { PermissionGuard } from '@/components/PermissionGuard';

// ✅ 正确：使用权限守卫
<PermissionGuard 
  requireMenu="settings.users"
  fallback={<div>无权限</div>}
>
  <UserManagement />
</PermissionGuard>

// ✅ 正确：检查功能权限
<PermissionGuard 
  requireFunction="logistics.delete"
>
  <Button>删除</Button>
</PermissionGuard>
```

#### 3. 路由保护

```typescript
// ✅ 正确：使用 requiredPermission
<Route 
  path="/settings/users" 
  element={
    <ProtectedRoute requiredPermission="settings.users">
      <AppLayout><UserManagement /></AppLayout>
    </ProtectedRoute>
  } 
/>
```

---

### 后端（数据库函数/SQL）

#### 1. 使用统一权限检查函数（推荐）⭐

```sql
-- ✅ 正确：检查菜单权限
IF NOT public.has_menu_permission('settings.users') THEN
    RAISE EXCEPTION '权限不足：无法访问用户管理';
END IF;

-- ✅ 正确：检查功能权限
IF NOT public.has_function_permission('logistics.modify_chain') THEN
    RETURN json_build_object(
        'success', false,
        'message', '权限不足：只有有相应权限的用户可以修改合作链路'
    );
END IF;

-- ✅ 正确：检查数据权限
IF public.has_data_permission('partner.view_all') THEN
    -- 可以查看所有合作方
ELSE
    -- 只能查看自己的数据
END IF;
```

#### 2. RLS 策略中使用权限系统

```sql
-- ✅ 正确：使用权限检查函数
CREATE POLICY "users_can_view_data" 
ON public.logistics_records
FOR SELECT
USING (
    public.is_admin()  -- ✅ 兼容函数，内部使用权限系统
    OR
    public.has_data_permission('logistics.view_all')
    OR
    user_id = auth.uid()
);
```

---

## 📋 权限系统使用指南

### 前端权限检查方法

| 用途 | 方法 | 示例 |
|------|------|------|
| **菜单显示** | `hasMenuAccess(key)` | `hasMenuAccess('dashboard.finance')` |
| **按钮显示** | `hasButtonAccess(key)` | `hasButtonAccess('payment.approve')` |
| **页面访问** | `hasPageAccess(key)` | `hasPageAccess('settings.users')` |
| **功能操作** | `hasFunctionAccess(key)` | `hasFunctionAccess('logistics.delete')` |
| **数据范围** | `hasDataAccess(key)` | `hasDataAccess('partner.view_all')` |
| **项目权限** | `hasProjectAccess(key)` | `hasProjectAccess('project.edit')` |

### 后端权限检查函数

| 用途 | 函数 | 示例 |
|------|------|------|
| **菜单权限** | `has_menu_permission(key)` | `has_menu_permission('dashboard.finance')` |
| **功能权限** | `has_function_permission(key)` | `has_function_permission('payment.approve')` |
| **数据权限** | `has_data_permission(key)` | `has_data_permission('partner.view_all')` |
| **项目权限** | `has_project_permission(key)` | `has_project_permission('project.edit')` |
| **管理员检查** | `is_admin()` | `is_admin()` （兼容，内部使用权限系统）|

---

## 🔍 代码审查检查清单

### 前端代码检查

- [ ] ✅ 所有权限判断使用 `useUnifiedPermissions`
- [ ] ✅ 没有硬编码 `role === 'admin'`
- [ ] ✅ 没有硬编码 `role === 'finance'`
- [ ] ✅ 路由保护使用 `requiredPermission`
- [ ] ✅ 按钮显示使用 `hasButtonAccess` 或 `PermissionGuard`
- [ ] ✅ 菜单显示使用 `hasMenuAccess`

### 后端代码检查

- [ ] ✅ SQL 函数使用权限检查函数
- [ ] ✅ 没有硬编码 `role = 'admin'`
- [ ] ✅ 没有硬编码 `role IN ('admin', 'finance')`
- [ ] ✅ RLS 策略使用权限检查函数
- [ ] ✅ 权限检查函数查询 `user_permissions` 和 `role_permission_templates`

---

## 📝 改造示例

### 前端改造示例

```typescript
// ❌ 改造前：硬编码
if (user.role === 'admin' || user.role === 'finance') {
  return <PaymentAudit />;
}

// ✅ 改造后：使用权限系统
const { hasMenuAccess } = useUnifiedPermissions();
if (hasMenuAccess('payment.audit')) {
  return <PaymentAudit />;
}
```

### 后端改造示例

```sql
-- ❌ 改造前：硬编码
CREATE OR REPLACE FUNCTION modify_chain(...)
AS $$
BEGIN
    IF current_user_role IN ('admin', 'finance', 'operator') THEN
        -- 允许操作
    ELSE
        RAISE EXCEPTION '权限不足';
    END IF;
END;
$$;

-- ✅ 改造后：使用权限系统
CREATE OR REPLACE FUNCTION modify_chain(...)
AS $$
BEGIN
    IF NOT public.has_function_permission('logistics.modify_chain') THEN
        RAISE EXCEPTION '权限不足：只有有相应权限的用户可以修改合作链路';
    END IF;
    -- 允许操作
END;
$$;
```

---

## ⚠️ 特殊情况

### Admin 角色的处理

**前端：**
```typescript
// ✅ 正确：isAdmin 来自权限系统，内部已经查询了权限
const { isAdmin, hasFunctionAccess } = useUnifiedPermissions();

// admin 自动拥有所有权限
if (isAdmin) return true;

// 其他角色检查权限
return hasFunctionAccess('payment.approve');
```

**后端：**
```sql
-- ✅ 正确：is_admin() 内部查询权限系统
IF public.is_admin() THEN
    RETURN TRUE;  -- admin 自动拥有所有权限
END IF;

-- ✅ 正确：使用权限检查函数
IF public.has_function_permission('payment.approve') THEN
    -- 允许操作
END IF;
```

---

## 📚 相关文件

### 前端权限系统
- `src/hooks/useUnifiedPermissions.ts` - 统一权限 Hook
- `src/hooks/useSimplePermissions.ts` - 基础权限 Hook
- `src/components/PermissionGuard.tsx` - 权限守卫组件
- `src/components/ProtectedRoute.tsx` - 路由保护组件

### 后端权限系统
- `supabase/migrations/20251102_unified_permission_check_functions.sql` - 统一权限检查函数
- `public.has_menu_permission()` - 菜单权限检查
- `public.has_function_permission()` - 功能权限检查
- `public.has_data_permission()` - 数据权限检查
- `public.has_project_permission()` - 项目权限检查
- `public.is_admin()` - 管理员检查（兼容）

---

## ✅ 总结

**核心原则：**
1. ✅ 所有权限判断必须通过权限系统
2. ✅ 禁止硬编码角色判断
3. ✅ 前端使用 `useUnifiedPermissions`
4. ✅ 后端使用权限检查函数
5. ✅ Admin 自动拥有所有权限（权限系统内部处理）

**违反规范的后果：**
- ❌ 权限配置无法生效
- ❌ 无法灵活控制权限
- ❌ 维护困难
- ❌ 代码不符合规范

---

**请所有代码修改都遵循此规范！** ✅

