# æƒé™åˆ¤æ–­è§„èŒƒ

> **é‡è¦è§„åˆ™**: æ‰€æœ‰æƒé™åˆ¤æ–­å¿…é¡»ä½¿ç”¨æƒé™ç³»ç»Ÿï¼Œç¦æ­¢ç¡¬ç¼–ç è§’è‰²åˆ¤æ–­

---

## âŒ ç¦æ­¢çš„ç¡¬ç¼–ç æ–¹å¼

### å‰ç«¯ï¼ˆReact/TypeScriptï¼‰

```typescript
// âŒ é”™è¯¯ï¼šç¡¬ç¼–ç è§’è‰²åˆ¤æ–­
if (user.role === 'admin') { ... }
if (user.role === 'finance') { ... }
if (['admin', 'finance'].includes(user.role)) { ... }

// âŒ é”™è¯¯ï¼šç›´æ¥åˆ¤æ–­ profile.role
if (profile?.role === 'admin') { ... }
```

### åç«¯ï¼ˆæ•°æ®åº“å‡½æ•°/SQLï¼‰

```sql
-- âŒ é”™è¯¯ï¼šç¡¬ç¼–ç è§’è‰²åˆ¤æ–­
IF user_role = 'admin' THEN ...
IF user_role IN ('admin', 'finance') THEN ...
WHERE role = 'admin'
WHERE role IN ('admin', 'finance', 'operator')
```

---

## âœ… æ­£ç¡®çš„æƒé™åˆ¤æ–­æ–¹å¼

### å‰ç«¯ï¼ˆReact/TypeScriptï¼‰

#### 1. ä½¿ç”¨ `useUnifiedPermissions` Hookï¼ˆæ¨èï¼‰â­

```typescript
import { useUnifiedPermissions } from '@/hooks/useUnifiedPermissions';

function MyComponent() {
  const { 
    hasMenuAccess,        // æ£€æŸ¥èœå•æƒé™
    hasFunctionAccess,    // æ£€æŸ¥åŠŸèƒ½æƒé™
    hasButtonAccess,      // æ£€æŸ¥æŒ‰é’®æƒé™
    hasPageAccess,        // æ£€æŸ¥é¡µé¢æƒé™
    hasDataAccess,        // æ£€æŸ¥æ•°æ®æƒé™
    isAdmin,              // æ˜¯å¦ä¸ºç®¡ç†å‘˜ï¼ˆå…¼å®¹ï¼‰
    hasRole               // æ£€æŸ¥è§’è‰²ï¼ˆå…¼å®¹ï¼Œä½†ä¸æ¨èï¼‰
  } = useUnifiedPermissions();

  // âœ… æ­£ç¡®ï¼šä½¿ç”¨æƒé™ç³»ç»Ÿ
  if (hasMenuAccess('settings.users')) {
    return <SettingsMenu />;
  }

  // âœ… æ­£ç¡®ï¼šæ£€æŸ¥æŒ‰é’®æƒé™
  {hasButtonAccess('logistics.edit') && (
    <Button onClick={handleEdit}>ç¼–è¾‘</Button>
  )}

  // âœ… æ­£ç¡®ï¼šæ£€æŸ¥åŠŸèƒ½æƒé™
  if (hasFunctionAccess('payment.approve')) {
    // å…è®¸å®¡æ‰¹
  }
}
```

#### 2. ä½¿ç”¨ `PermissionGuard` ç»„ä»¶

```typescript
import { PermissionGuard } from '@/components/PermissionGuard';

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æƒé™å®ˆå«
<PermissionGuard 
  requireMenu="settings.users"
  fallback={<div>æ— æƒé™</div>}
>
  <UserManagement />
</PermissionGuard>

// âœ… æ­£ç¡®ï¼šæ£€æŸ¥åŠŸèƒ½æƒé™
<PermissionGuard 
  requireFunction="logistics.delete"
>
  <Button>åˆ é™¤</Button>
</PermissionGuard>
```

#### 3. è·¯ç”±ä¿æŠ¤

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ requiredPermission
<Route 
  path="/settings/users" 
  element={
    <ProtectedRoute requiredPermission="settings.users">
      <AppLayout><UserManagement /></AppLayout>
    </ProtectedRoute>
  } 
/>
```

---

### åç«¯ï¼ˆæ•°æ®åº“å‡½æ•°/SQLï¼‰

#### 1. ä½¿ç”¨ç»Ÿä¸€æƒé™æ£€æŸ¥å‡½æ•°ï¼ˆæ¨èï¼‰â­

```sql
-- âœ… æ­£ç¡®ï¼šæ£€æŸ¥èœå•æƒé™
IF NOT public.has_menu_permission('settings.users') THEN
    RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šæ— æ³•è®¿é—®ç”¨æˆ·ç®¡ç†';
END IF;

-- âœ… æ­£ç¡®ï¼šæ£€æŸ¥åŠŸèƒ½æƒé™
IF NOT public.has_function_permission('logistics.modify_chain') THEN
    RETURN json_build_object(
        'success', false,
        'message', 'æƒé™ä¸è¶³ï¼šåªæœ‰æœ‰ç›¸åº”æƒé™çš„ç”¨æˆ·å¯ä»¥ä¿®æ”¹åˆä½œé“¾è·¯'
    );
END IF;

-- âœ… æ­£ç¡®ï¼šæ£€æŸ¥æ•°æ®æƒé™
IF public.has_data_permission('partner.view_all') THEN
    -- å¯ä»¥æŸ¥çœ‹æ‰€æœ‰åˆä½œæ–¹
ELSE
    -- åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®
END IF;
```

#### 2. RLS ç­–ç•¥ä¸­ä½¿ç”¨æƒé™ç³»ç»Ÿ

```sql
-- âœ… æ­£ç¡®ï¼šä½¿ç”¨æƒé™æ£€æŸ¥å‡½æ•°
CREATE POLICY "users_can_view_data" 
ON public.logistics_records
FOR SELECT
USING (
    public.is_admin()  -- âœ… å…¼å®¹å‡½æ•°ï¼Œå†…éƒ¨ä½¿ç”¨æƒé™ç³»ç»Ÿ
    OR
    public.has_data_permission('logistics.view_all')
    OR
    user_id = auth.uid()
);
```

---

## ğŸ“‹ æƒé™ç³»ç»Ÿä½¿ç”¨æŒ‡å—

### å‰ç«¯æƒé™æ£€æŸ¥æ–¹æ³•

| ç”¨é€” | æ–¹æ³• | ç¤ºä¾‹ |
|------|------|------|
| **èœå•æ˜¾ç¤º** | `hasMenuAccess(key)` | `hasMenuAccess('dashboard.finance')` |
| **æŒ‰é’®æ˜¾ç¤º** | `hasButtonAccess(key)` | `hasButtonAccess('payment.approve')` |
| **é¡µé¢è®¿é—®** | `hasPageAccess(key)` | `hasPageAccess('settings.users')` |
| **åŠŸèƒ½æ“ä½œ** | `hasFunctionAccess(key)` | `hasFunctionAccess('logistics.delete')` |
| **æ•°æ®èŒƒå›´** | `hasDataAccess(key)` | `hasDataAccess('partner.view_all')` |
| **é¡¹ç›®æƒé™** | `hasProjectAccess(key)` | `hasProjectAccess('project.edit')` |

### åç«¯æƒé™æ£€æŸ¥å‡½æ•°

| ç”¨é€” | å‡½æ•° | ç¤ºä¾‹ |
|------|------|------|
| **èœå•æƒé™** | `has_menu_permission(key)` | `has_menu_permission('dashboard.finance')` |
| **åŠŸèƒ½æƒé™** | `has_function_permission(key)` | `has_function_permission('payment.approve')` |
| **æ•°æ®æƒé™** | `has_data_permission(key)` | `has_data_permission('partner.view_all')` |
| **é¡¹ç›®æƒé™** | `has_project_permission(key)` | `has_project_permission('project.edit')` |
| **ç®¡ç†å‘˜æ£€æŸ¥** | `is_admin()` | `is_admin()` ï¼ˆå…¼å®¹ï¼Œå†…éƒ¨ä½¿ç”¨æƒé™ç³»ç»Ÿï¼‰|

---

## ğŸ” ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•

### å‰ç«¯ä»£ç æ£€æŸ¥

- [ ] âœ… æ‰€æœ‰æƒé™åˆ¤æ–­ä½¿ç”¨ `useUnifiedPermissions`
- [ ] âœ… æ²¡æœ‰ç¡¬ç¼–ç  `role === 'admin'`
- [ ] âœ… æ²¡æœ‰ç¡¬ç¼–ç  `role === 'finance'`
- [ ] âœ… è·¯ç”±ä¿æŠ¤ä½¿ç”¨ `requiredPermission`
- [ ] âœ… æŒ‰é’®æ˜¾ç¤ºä½¿ç”¨ `hasButtonAccess` æˆ– `PermissionGuard`
- [ ] âœ… èœå•æ˜¾ç¤ºä½¿ç”¨ `hasMenuAccess`

### åç«¯ä»£ç æ£€æŸ¥

- [ ] âœ… SQL å‡½æ•°ä½¿ç”¨æƒé™æ£€æŸ¥å‡½æ•°
- [ ] âœ… æ²¡æœ‰ç¡¬ç¼–ç  `role = 'admin'`
- [ ] âœ… æ²¡æœ‰ç¡¬ç¼–ç  `role IN ('admin', 'finance')`
- [ ] âœ… RLS ç­–ç•¥ä½¿ç”¨æƒé™æ£€æŸ¥å‡½æ•°
- [ ] âœ… æƒé™æ£€æŸ¥å‡½æ•°æŸ¥è¯¢ `user_permissions` å’Œ `role_permission_templates`

---

## ğŸ“ æ”¹é€ ç¤ºä¾‹

### å‰ç«¯æ”¹é€ ç¤ºä¾‹

```typescript
// âŒ æ”¹é€ å‰ï¼šç¡¬ç¼–ç 
if (user.role === 'admin' || user.role === 'finance') {
  return <PaymentAudit />;
}

// âœ… æ”¹é€ åï¼šä½¿ç”¨æƒé™ç³»ç»Ÿ
const { hasMenuAccess } = useUnifiedPermissions();
if (hasMenuAccess('payment.audit')) {
  return <PaymentAudit />;
}
```

### åç«¯æ”¹é€ ç¤ºä¾‹

```sql
-- âŒ æ”¹é€ å‰ï¼šç¡¬ç¼–ç 
CREATE OR REPLACE FUNCTION modify_chain(...)
AS $$
BEGIN
    IF current_user_role IN ('admin', 'finance', 'operator') THEN
        -- å…è®¸æ“ä½œ
    ELSE
        RAISE EXCEPTION 'æƒé™ä¸è¶³';
    END IF;
END;
$$;

-- âœ… æ”¹é€ åï¼šä½¿ç”¨æƒé™ç³»ç»Ÿ
CREATE OR REPLACE FUNCTION modify_chain(...)
AS $$
BEGIN
    IF NOT public.has_function_permission('logistics.modify_chain') THEN
        RAISE EXCEPTION 'æƒé™ä¸è¶³ï¼šåªæœ‰æœ‰ç›¸åº”æƒé™çš„ç”¨æˆ·å¯ä»¥ä¿®æ”¹åˆä½œé“¾è·¯';
    END IF;
    -- å…è®¸æ“ä½œ
END;
$$;
```

---

## âš ï¸ ç‰¹æ®Šæƒ…å†µ

### Admin è§’è‰²çš„å¤„ç†

**å‰ç«¯ï¼š**
```typescript
// âœ… æ­£ç¡®ï¼šisAdmin æ¥è‡ªæƒé™ç³»ç»Ÿï¼Œå†…éƒ¨å·²ç»æŸ¥è¯¢äº†æƒé™
const { isAdmin, hasFunctionAccess } = useUnifiedPermissions();

// admin è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™
if (isAdmin) return true;

// å…¶ä»–è§’è‰²æ£€æŸ¥æƒé™
return hasFunctionAccess('payment.approve');
```

**åç«¯ï¼š**
```sql
-- âœ… æ­£ç¡®ï¼šis_admin() å†…éƒ¨æŸ¥è¯¢æƒé™ç³»ç»Ÿ
IF public.is_admin() THEN
    RETURN TRUE;  -- admin è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™
END IF;

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨æƒé™æ£€æŸ¥å‡½æ•°
IF public.has_function_permission('payment.approve') THEN
    -- å…è®¸æ“ä½œ
END IF;
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### å‰ç«¯æƒé™ç³»ç»Ÿ
- `src/hooks/useUnifiedPermissions.ts` - ç»Ÿä¸€æƒé™ Hook
- `src/hooks/useSimplePermissions.ts` - åŸºç¡€æƒé™ Hook
- `src/components/PermissionGuard.tsx` - æƒé™å®ˆå«ç»„ä»¶
- `src/components/ProtectedRoute.tsx` - è·¯ç”±ä¿æŠ¤ç»„ä»¶

### åç«¯æƒé™ç³»ç»Ÿ
- `supabase/migrations/20251102_unified_permission_check_functions.sql` - ç»Ÿä¸€æƒé™æ£€æŸ¥å‡½æ•°
- `public.has_menu_permission()` - èœå•æƒé™æ£€æŸ¥
- `public.has_function_permission()` - åŠŸèƒ½æƒé™æ£€æŸ¥
- `public.has_data_permission()` - æ•°æ®æƒé™æ£€æŸ¥
- `public.has_project_permission()` - é¡¹ç›®æƒé™æ£€æŸ¥
- `public.is_admin()` - ç®¡ç†å‘˜æ£€æŸ¥ï¼ˆå…¼å®¹ï¼‰

---

## âœ… æ€»ç»“

**æ ¸å¿ƒåŸåˆ™ï¼š**
1. âœ… æ‰€æœ‰æƒé™åˆ¤æ–­å¿…é¡»é€šè¿‡æƒé™ç³»ç»Ÿ
2. âœ… ç¦æ­¢ç¡¬ç¼–ç è§’è‰²åˆ¤æ–­
3. âœ… å‰ç«¯ä½¿ç”¨ `useUnifiedPermissions`
4. âœ… åç«¯ä½¿ç”¨æƒé™æ£€æŸ¥å‡½æ•°
5. âœ… Admin è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ˆæƒé™ç³»ç»Ÿå†…éƒ¨å¤„ç†ï¼‰

**è¿åè§„èŒƒçš„åæœï¼š**
- âŒ æƒé™é…ç½®æ— æ³•ç”Ÿæ•ˆ
- âŒ æ— æ³•çµæ´»æ§åˆ¶æƒé™
- âŒ ç»´æŠ¤å›°éš¾
- âŒ ä»£ç ä¸ç¬¦åˆè§„èŒƒ

---

**è¯·æ‰€æœ‰ä»£ç ä¿®æ”¹éƒ½éµå¾ªæ­¤è§„èŒƒï¼** âœ…

