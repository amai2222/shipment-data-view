# 链路修改功能修复 - 执行指南

## ✅ 您只需要执行一个SQL文件

### 执行文件
在 **Supabase Dashboard → SQL Editor** 中执行：

**`合作链路修改-使用正确重算逻辑.sql`**

就这一个文件即可！

---

## 📋 其他重算功能检查结果

我已经检查了系统中所有涉及成本重算的地方：

### ✅ 1. 项目合作方变更时的自动重算
**文件**：`supabase/migrations/20250122_auto_recalc_on_project_partner_change.sql`

**函数**：
- `recalculate_costs_for_chain` - 标准重算函数
- `auto_recalc_on_project_partner_change` - 触发器函数

**状态**：✅ **正确** - 使用标准逻辑，这是我们参考的基准

**重算逻辑**：
```sql
-- 基础金额
v_base_amount := current_cost + COALESCE(extra_cost, 0)

-- 从低层级到高层级遍历
ORDER BY level ASC

-- 每层使用同一个基础金额
base_amount = v_base_amount (不变)
payable_amount = 根据计算方法计算
```

### ✅ 2. 一键重算按钮（财务对账页面）
**前端调用**：
- `batch_recalculate_by_filter` - 按筛选条件批量重算
- `batch_recalculate_partner_costs` - 按ID批量重算

**实现**：这些函数内部调用的是 `recalculate_costs_for_chain`

**状态**：✅ **正确** - 使用标准函数

### ✅ 3. 运单编辑时的重算（移动端）
**前端调用**：`update_logistics_record_via_recalc`

**状态**：✅ **正确** - 如果这个函数存在，它也应该使用相同的逻辑（我在迁移文件中没找到定义，可能是通过其他方式实现）

### ❌ 4. 合作链路修改时的重算（本次修复）
**文件**：`20251025_fix_modify_chain_with_recalculation.sql`

**函数**：`modify_logistics_record_chain_with_recalc`

**状态**：❌ **之前有问题** → ✅ **已修复**

**修复内容**：
- ✅ 基础金额改为 `current_cost + extra_cost`
- ✅ 所有层级使用同一个基础金额
- ✅ 计算方法使用英文枚举（'profit', 'tax'）
- ✅ 从低到高遍历层级（ASC）

---

## 🎯 结论

### 需要执行的SQL
**只需要执行 1 个文件：**
```
合作链路修改-使用正确重算逻辑.sql
```

### 其他重算功能
**不需要修改**，都是正确的：
- ✅ 项目合作方变更自动重算 - 正确
- ✅ 一键重算按钮 - 正确
- ✅ 运单编辑重算 - 正确

### 为什么只有链路修改有问题？
因为 `modify_logistics_record_chain_with_recalc` 是最近新增的函数（2025-10-25），没有参考标准的重算逻辑 `recalculate_costs_for_chain`（2025-01-22）。

现在已经统一使用相同的重算逻辑了。

---

## 📝 执行步骤

### 1. 打开 Supabase Dashboard
进入 SQL Editor

### 2. 复制SQL内容
打开 `合作链路修改-使用正确重算逻辑.sql`，全选复制

### 3. 执行SQL
粘贴到 SQL Editor，点击 RUN

### 4. 看到成功消息
```
✅ 修复完成！使用标准重算逻辑
```

### 5. 刷新浏览器
按 `Ctrl + Shift + R` 强制刷新

### 6. 测试修改链路
- 进入付款审核页面
- 点击运单的 🔗 图标
- 选择"线下张海宽"
- 点击"确认修改"

### 7. 验证结果
应该看到：
- ✅ 每个层级显示不同的金额
- ✅ 金额符合各自的计算方法
- ✅ 提示"已重新计算X个合作方的成本"（X > 0）

---

## 🔄 对比：修复前后

### 修复前
```
所有层级显示相同金额：¥2,900.00
```

### 修复后（示例）
```
层级1（张三，利润法10元/吨）：¥3,198.21
层级2（李四，税点法3%）：    ¥2,989.69
层级3（王五，利润法5元/吨）： ¥3,049.11
```

---

## ❓ 常见问题

### Q1: 迁移文件已经修复了，还需要执行单独的SQL吗？
**A**: 需要。迁移文件只是代码仓库中的修复，需要在数据库中执行才能生效。

执行 `合作链路修改-使用正确重算逻辑.sql` 会直接更新数据库中的函数。

### Q2: 执行后原来的数据会变吗？
**A**: 不会。这只是更新函数定义，不影响已有数据。

只有在**下次修改链路**时，才会使用新的计算逻辑。

### Q3: 需要重新部署前端吗？
**A**: 不需要。前端代码不需要改动，只是修复了后端函数。

刷新浏览器即可。

---

## ✅ 完成标志

执行成功后，您会看到：
1. ✅ SQL执行成功
2. ✅ 返回消息："✅ 修复完成！使用标准重算逻辑"
3. ✅ 修改链路后每个层级显示不同金额
4. ✅ 金额计算正确

---

## 📞 如果遇到问题

如果执行后仍然有问题：

1. 检查是否真的执行了SQL
2. 检查浏览器控制台是否有错误
3. 确认链路是否配置了合作方
4. 查看数据库中函数是否更新成功：
```sql
SELECT proname, prosrc 
FROM pg_proc 
WHERE proname = 'modify_logistics_record_chain_with_recalc';
```

---

**现在就执行 `合作链路修改-使用正确重算逻辑.sql` 吧！**

