# æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å¿«é€ŸæŒ‡å—

## ğŸš€ ç«‹å³ä½¿ç”¨

### 1. æ¸…ç†consoleæ—¥å¿—

```bash
# è¿è¡Œæ—¥å¿—æ¸…ç†è„šæœ¬
cd shipment-data-view
node scripts/clean-console-logs.js
```

**æ•ˆæœ**:
- è‡ªåŠ¨æ¸…ç†æ‰€æœ‰console.log
- ä¿ç•™console.errorå’ŒKEEPæ ‡è®°çš„æ—¥å¿—
- æå‡ç”Ÿäº§ç¯å¢ƒæ€§èƒ½

### 2. ä¼˜åŒ–å·²å®Œæˆçš„æ–‡ä»¶

å·²ä¼˜åŒ–çš„æ–‡ä»¶ä¼šè‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€é¢å¤–é…ç½®ï¼š
- âœ… `src/pages/mobile/MobileProjectOverview.tsx`
- âœ… `src/pages/mobile/MobileProjects.tsx`

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ç§»åŠ¨ç«¯é¡¹ç›®çœ‹æ¿

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| 20ä¸ªé¡¹ç›®åŠ è½½ | ~2ç§’ | ~0.1ç§’ | **20å€** |
| æ•°æ®åº“æŸ¥è¯¢ | 41æ¬¡ | 2æ¬¡ | **95%å‡å°‘** |
| ç½‘ç»œè¯·æ±‚ | 41ä¸ª | 2ä¸ª | **95%å‡å°‘** |

---

## ğŸ¯ N+1æŸ¥è¯¢è¯†åˆ«

### âŒ åé¢æ¡ˆä¾‹ï¼ˆN+1é—®é¢˜ï¼‰

```typescript
// ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼šè·å–æ‰€æœ‰é¡¹ç›®
const projects = await supabase.from('projects').select('*');

// Næ¬¡æŸ¥è¯¢ï¼šä¸ºæ¯ä¸ªé¡¹ç›®æŸ¥è¯¢ç»Ÿè®¡æ•°æ®
for (const project of projects) {
  const stats = await supabase
    .from('logistics_records')
    .select('*')
    .eq('project_id', project.id);
}
// æ€»æŸ¥è¯¢æ•°ï¼š1 + N = 21æ¬¡ï¼ˆN=20ï¼‰
```

### âœ… æ­£ç¡®åšæ³•ï¼ˆæ‰¹é‡æŸ¥è¯¢ï¼‰

```typescript
// ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼šè·å–æ‰€æœ‰é¡¹ç›®
const projects = await supabase.from('projects').select('*');
const projectIds = projects.map(p => p.id);

// ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼šæ‰¹é‡è·å–æ‰€æœ‰ç»Ÿè®¡æ•°æ®
const allStats = await supabase
  .from('logistics_records')
  .select('*')
  .in('project_id', projectIds);

// åœ¨å†…å­˜ä¸­èšåˆ
const statsMap = new Map();
allStats.forEach(stat => {
  // èšåˆé€»è¾‘
});
// æ€»æŸ¥è¯¢æ•°ï¼š2æ¬¡ï¼
```

---

## ğŸ”§ å¸¸è§åœºæ™¯ä¼˜åŒ–

### åœºæ™¯1: å…³è”æ•°æ®æŸ¥è¯¢

```typescript
// âŒ ä¸å¥½
async function getProjectsWithRecords() {
  const projects = await db.query('SELECT * FROM projects');
  
  for (const project of projects) {
    project.records = await db.query(
      'SELECT * FROM logistics_records WHERE project_id = ?',
      [project.id]
    );
  }
  return projects;
}

// âœ… å¥½
async function getProjectsWithRecords() {
  const projects = await db.query('SELECT * FROM projects');
  const projectIds = projects.map(p => p.id);
  
  const allRecords = await db.query(
    'SELECT * FROM logistics_records WHERE project_id IN (?)',
    [projectIds]
  );
  
  // åœ¨å†…å­˜ä¸­ç»„åˆ
  const recordsMap = groupBy(allRecords, 'project_id');
  projects.forEach(p => {
    p.records = recordsMap[p.id] || [];
  });
  
  return projects;
}
```

### åœºæ™¯2: ç»Ÿè®¡æ•°æ®è®¡ç®—

```typescript
// âŒ ä¸å¥½
async function getProjectStats() {
  const projects = await db.query('SELECT * FROM projects');
  
  for (const project of projects) {
    const stats = await db.query(`
      SELECT COUNT(*) as count, SUM(weight) as total
      FROM logistics_records
      WHERE project_id = ?
    `, [project.id]);
    project.stats = stats[0];
  }
}

// âœ… å¥½
async function getProjectStats() {
  const [projects, allStats] = await Promise.all([
    db.query('SELECT * FROM projects'),
    db.query(`
      SELECT 
        project_id,
        COUNT(*) as count,
        SUM(weight) as total
      FROM logistics_records
      GROUP BY project_id
    `)
  ]);
  
  const statsMap = new Map(
    allStats.map(s => [s.project_id, s])
  );
  
  projects.forEach(p => {
    p.stats = statsMap.get(p.id) || { count: 0, total: 0 };
  });
}
```

### åœºæ™¯3: å¹¶è¡ŒæŸ¥è¯¢

```typescript
// âŒ ä¸å¥½ - ä¸²è¡ŒæŸ¥è¯¢
async function getDashboardData() {
  const users = await db.query('SELECT * FROM users');
  const projects = await db.query('SELECT * FROM projects');
  const records = await db.query('SELECT * FROM records');
  return { users, projects, records };
}
// æ€»è€—æ—¶ï¼š50ms + 50ms + 50ms = 150ms

// âœ… å¥½ - å¹¶è¡ŒæŸ¥è¯¢
async function getDashboardData() {
  const [users, projects, records] = await Promise.all([
    db.query('SELECT * FROM users'),
    db.query('SELECT * FROM projects'),
    db.query('SELECT * FROM records')
  ]);
  return { users, projects, records };
}
// æ€»è€—æ—¶ï¼šmax(50ms, 50ms, 50ms) = 50ms
```

---

## ğŸ“ æ£€æŸ¥æ¸…å•

åœ¨ç¼–å†™æ•°æ®åº“æŸ¥è¯¢ä»£ç æ—¶ï¼Œé—®è‡ªå·±ï¼š

- [ ] æˆ‘æ˜¯å¦åœ¨å¾ªç¯ä¸­æŸ¥è¯¢æ•°æ®åº“ï¼Ÿ
- [ ] æˆ‘èƒ½å¦ç”¨ä¸€æ¬¡æŸ¥è¯¢ä»£æ›¿å¤šæ¬¡æŸ¥è¯¢ï¼Ÿ
- [ ] æˆ‘èƒ½å¦ä½¿ç”¨`.in()`æ‰¹é‡æŸ¥è¯¢ï¼Ÿ
- [ ] æˆ‘èƒ½å¦ä½¿ç”¨`Promise.all()`å¹¶è¡ŒæŸ¥è¯¢ï¼Ÿ
- [ ] æˆ‘æ˜¯å¦åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Ÿ
- [ ] æˆ‘æ˜¯å¦æ·»åŠ äº†é€‚å½“çš„ç´¢å¼•ï¼Ÿ
- [ ] æˆ‘æ˜¯å¦ä½¿ç”¨äº†React Queryç¼“å­˜ï¼Ÿ

---

## ğŸ¨ ä»£ç æ¨¡æ¿

### æ‰¹é‡æŸ¥è¯¢æ¨¡æ¿

```typescript
async function batchQuery<T>(ids: string[]) {
  if (ids.length === 0) return [];
  
  const { data, error } = await supabase
    .from('table_name')
    .select('*')
    .in('id', ids);
    
  if (error) throw error;
  return data;
}
```

### èšåˆæ•°æ®æ¨¡æ¿

```typescript
function aggregateData<T>(
  items: T[],
  groupBy: keyof T
): Map<any, T[]> {
  const map = new Map();
  
  items.forEach(item => {
    const key = item[groupBy];
    if (!map.has(key)) {
      map.set(key, []);
    }
    map.get(key).push(item);
  });
  
  return map;
}
```

### React Queryä¼˜åŒ–æ¨¡æ¿

```typescript
const { data } = useQuery({
  queryKey: ['resource', id],
  queryFn: async () => {
    // æ‰¹é‡æŸ¥è¯¢é€»è¾‘
    const [main, related] = await Promise.all([
      fetchMain(id),
      fetchRelated(id)
    ]);
    
    return combineData(main, related);
  },
  staleTime: 5 * 60 * 1000,  // 5åˆ†é’Ÿ
  cacheTime: 10 * 60 * 1000  // 10åˆ†é’Ÿ
});
```

---

## ğŸš¨ å¸¸è§é”™è¯¯

### é”™è¯¯1: åµŒå¥—å¾ªç¯æŸ¥è¯¢
```typescript
// âŒ æå·®çš„æ€§èƒ½
for (const user of users) {
  for (const project of projects) {
    const data = await db.query(...);
  }
}
// æŸ¥è¯¢æ¬¡æ•°ï¼šN * Mï¼ˆå¦‚æœN=10, M=20ï¼Œåˆ™200æ¬¡æŸ¥è¯¢ï¼ï¼‰
```

### é”™è¯¯2: å¿˜è®°ä½¿ç”¨ç´¢å¼•
```typescript
// âŒ æ²¡æœ‰ç´¢å¼•çš„æŸ¥è¯¢
WHERE project_id = '123'

// âœ… æ·»åŠ ç´¢å¼•
CREATE INDEX idx_project_id ON logistics_records(project_id);
```

### é”™è¯¯3: æŸ¥è¯¢è¿‡å¤šå­—æ®µ
```typescript
// âŒ æŸ¥è¯¢æ‰€æœ‰å­—æ®µ
.select('*')

// âœ… åªæŸ¥è¯¢éœ€è¦çš„
.select('id, name, status')
```

---

## ğŸ“š ç›¸å…³èµ„æº

- [å®Œæ•´ä¼˜åŒ–æŠ¥å‘Š](./æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–æŒ‡å—.md)
- [æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–](./æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–ç´¢å¼•.sql)
- [Supabaseæ–‡æ¡£](https://supabase.com/docs)

---

## âœ¨ å¿«é€Ÿæ€»ç»“

1. **é¿å…N+1**: ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ä»£æ›¿å¾ªç¯æŸ¥è¯¢
2. **å¹¶è¡Œæ‰§è¡Œ**: ä½¿ç”¨`Promise.all()`å¹¶è¡ŒæŸ¥è¯¢
3. **é€‰æ‹©å­—æ®µ**: åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
4. **æ·»åŠ ç´¢å¼•**: ä¸ºå¸¸ç”¨æŸ¥è¯¢æ·»åŠ ç´¢å¼•
5. **ä½¿ç”¨ç¼“å­˜**: åˆ©ç”¨React Queryç¼“å­˜

**è®°ä½**: æ¯å‡å°‘ä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼Œéƒ½èƒ½æ˜¾è‘—æå‡æ€§èƒ½ï¼

---

*å¿«é€ŸæŒ‡å— | 2025å¹´1æœˆ8æ—¥*

