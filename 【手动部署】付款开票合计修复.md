# 【手动部署】付款和开票合计金额修复

## ⚡ 快速部署（3分钟）

### 步骤1：打开Supabase Dashboard

1. 登录 [https://supabase.com](https://supabase.com)
2. 选择你的项目
3. 左侧菜单点击 **SQL Editor**

---

### 步骤2：复制SQL内容

打开这个文件并复制所有内容：
```
supabase/migrations/20250131_fix_payment_invoice_summary_by_status.sql
```

**提示**：在VS Code中打开文件，按 `Ctrl+A` 全选，`Ctrl+C` 复制

---

### 步骤3：执行SQL

1. 在SQL Editor中粘贴刚才复制的内容
2. 点击右下角的 **Run** 按钮（或按 `Ctrl+Enter`）
3. 等待执行完成

**预期结果**：
```
✅ 修复完成：合计计算现在跟随筛选条件
✅ 修复前：筛选非默认状态时，合计显示¥0.00
✅ 修复后：合计跟随筛选条件，正确显示金额
```

---

### 步骤4：验证修复

#### 测试付款申请

1. 打开系统：**合作方付款申请**页面
2. 筛选条件选择：**已申请支付**
3. 点击：**搜索**
4. 检查底部合计行：
   - 司机应收：应该有金额
   - 各合作方：应该有金额（不是¥0.00）✅

#### 测试开票申请

1. 打开系统：**合作方开票申请**页面
2. 筛选条件选择：**开票中**
3. 点击：**搜索**
4. 检查底部合计行：
   - 各合作方：应该有金额（不是¥0.00）✅

---

## ⚠️ 如果遇到错误

### 错误：函数名称不唯一

**完整错误信息**：
```
ERROR: 42725: function name "public.get_invoice_request_data" is not unique
HINT: Specify the argument list to select the function unambiguously.
```

**解决方法**：

在执行修复SQL之前，先执行这段SQL删除旧版本：

```sql
-- 删除所有版本的旧函数
DROP FUNCTION IF EXISTS public.get_payment_request_data CASCADE;
DROP FUNCTION IF EXISTS public.get_invoice_request_data CASCADE;
```

然后再执行修复SQL。

---

## 🔄 如果需要回滚

### 方法1：执行原始迁移文件

找到并执行这两个文件中的任意一个：
```
supabase/migrations/20251029_fix_payment_request_data_sort_by_auto_number.sql
supabase/migrations/20251029_fix_invoice_request_data_sort_by_auto_number.sql
```

---

### 方法2：简单修改

如果只想恢复原来的逻辑，在SQL Editor中执行：

```sql
-- 恢复付款申请合计（只统计未支付）
-- 找到函数中的合计计算WHERE条件，改为：
-- AND lpc.payment_status = 'Unpaid'

-- 恢复开票申请合计（只统计未开票）  
-- AND lpc.invoice_status = 'Uninvoiced'
```

---

## ✅ 完成确认

部署完成后，确认以下事项：

- [ ] SQL执行成功，无错误信息
- [ ] 筛选"已申请支付"时，合计正常显示
- [ ] 筛选"开票中"时，合计正常显示
- [ ] 其他筛选条件也正常

---

## 📞 需要帮助？

如果遇到问题：
1. 查看 `docs/database/付款开票合计修复部署指南.md` 详细说明
2. 检查 `docs/bug-fixes/付款开票申请合计金额筛选状态不匹配修复.md` 问题分析
3. 参考备份文件：`scripts/sql/backup/backup_payment_invoice_summary_functions.sql`

---

**现在打开Supabase Dashboard，按上述步骤执行SQL即可！** 🚀

