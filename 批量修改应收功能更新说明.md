# 批量修改应收功能更新说明

## ✨ 功能优化

将批量修改应收从"统一修改为一个金额"优化为**"逐个设置每条运单的金额"**，更加灵活和实用。

---

## 🎨 新UI界面

### 批量修改应收对话框

```
┌──────────────────────────────────────────────────────────────────┐
│ 🟢 批量修改应收                                                   │
│ 已选择 3 条运单，请逐个输入新的应付金额                           │
├──────────────────────────────────────────────────────────────────┤
│ ┌────────────────────────────────────────────────────────────┐   │
│ │ 运单编号      装货日期    司机    原应付    新应付金额      │   │
│ │ YDN001       2025-10-22   张三   ¥2,900   [  3500.00  ]   │   │
│ ├────────────────────────────────────────────────────────────┤   │
│ │ YDN002       2025-10-21   李四   ¥3,200   [  3500.00  ]   │   │
│ ├────────────────────────────────────────────────────────────┤   │
│ │ YDN003       2025-10-20   王五   ¥2,800   [  3000.00  ]   │   │
│ └────────────────────────────────────────────────────────────┘   │
│                                                                   │
│ ⚠️ 注意：                                                         │
│ • 只会修改最高级合作方的应付金额                                  │
│ • 只能修改"未支付"且"未开票"的运单                                │
│ • 已申请付款或已开票的运单将自动跳过                              │
├──────────────────────────────────────────────────────────────────┤
│                              [取消] [确认修改 (3条)]              │
└──────────────────────────────────────────────────────────────────┘
```

---

## 📊 显示信息

每条运单显示以下信息：

| 列名 | 说明 | 示例 |
|------|------|------|
| **运单编号** | 运单的自动编号 | YDN20251022-001 |
| **装货日期** | 装货日期（本地化格式） | 2025/10/22 |
| **司机** | 司机姓名 | 张三 |
| **原应付金额** | 当前最高级合作方的应付金额 | ¥2,900.00 |
| **新应付金额** | 输入框（可编辑） | [输入框] |

---

## 🎯 使用流程

### 步骤1：选择运单
在付款审核页面勾选需要修改的运单

### 步骤2：打开批量修改对话框
点击**"批量修改应收"**按钮

### 步骤3：查看运单详情
对话框中会列出所有选中的运单：
- 运单编号
- 装货日期
- 司机姓名
- 原应收金额（只读）
- 新应收金额（可编辑输入框）

### 步骤4：逐个输入新金额
为每条运单输入新的应收金额：
- 默认值为原金额
- 可以根据需要调整
- 每条运单的金额可以不同

### 步骤5：确认修改
点击**"确认修改"**按钮

### 步骤6：查看结果
系统显示：
```
批量修改完成
成功更新 3 条运单，失败 0 条
```

---

## 💡 使用场景

### 场景1：统一调整
所有运单改为相同金额：
1. 打开批量修改对话框
2. 第一条输入3500
3. 其他运单复制粘贴3500
4. 确认修改

### 场景2：差异化调整
每条运单设置不同金额：
1. 打开批量修改对话框
2. 根据实际情况为每条运单输入不同金额
3. 例如：YDN001改3500，YDN002改3200，YDN003改3000
4. 确认修改

### 场景3：部分调整
只修改部分运单：
1. 打开批量修改对话框
2. 需要修改的运单输入新金额
3. 不需要修改的保持原值
4. 确认修改

---

## 🎨 界面特点

### 1. 卡片式布局
- 每条运单一个卡片
- 左侧绿色边框标识
- 信息一目了然

### 2. 响应式设计
- 桌面端：6列网格布局
- 移动端：单列垂直布局
- 自适应不同屏幕尺寸

### 3. 滚动区域
- 对话框最大高度：90vh
- 运单列表区域：60vh可滚动
- 支持查看大量运单

### 4. 数据对比
- 原应收金额：灰色显示（只读）
- 新应收金额：蓝色边框输入框（可编辑）
- 方便对比调整

---

## 🔄 处理逻辑

### 前端逻辑
1. 打开对话框时，读取所有选中运单的数据
2. 获取每条运单的最高级合作方应付金额
3. 将原金额作为输入框的默认值
4. 用户可以修改任意运单的金额
5. 点击确认后逐个提交修改

### 后端逻辑
- 不使用批量RPC函数
- 前端逐个调用单次修改
- 每条运单独立处理
- 统计成功/失败数量

---

## ⚠️ 注意事项

### 1. 金额验证
- 必须输入有效数字
- 金额必须大于0
- 支持两位小数

### 2. 状态检查
每条运单独立检查：
- 未支付 ✅
- 未开票 ✅
- 有合作方 ✅

不符合条件的自动跳过并在结果中显示。

### 3. 批量操作提示
- 确认按钮显示运单数量：**"确认修改 (3条)"**
- 实时反馈当前选择的运单数量

---

## 📝 与原设计的对比

### 之前的设计（已废弃）
- 所有运单改为统一的金额
- 只有一个输入框
- 不够灵活

### 现在的设计（已实现）
- 每条运单独立输入框
- 显示运单详细信息
- 可以设置不同的金额
- 更加灵活实用

---

## ✅ 优势

1. **信息透明**：清楚看到每条运单的详情
2. **灵活调整**：每条运单可设置不同金额
3. **快速操作**：一次性处理多条运单
4. **对比方便**：原金额和新金额并排显示
5. **智能跳过**：自动跳过不符合条件的运单

---

## 🚀 部署说明

### 前端代码
已更新 `src/pages/PaymentRequest.tsx`：
- ✅ 新增 `batchCostRecords` 状态
- ✅ 修改 `handleOpenBatchModify` 准备运单数据
- ✅ 修改 `handleBatchModifyCost` 逐个处理
- ✅ 重新设计批量修改应收对话框UI

### 后端函数
不需要使用 `batch_modify_partner_cost` 函数了，前端直接逐个调用单次更新。

### 测试步骤
1. 刷新浏览器
2. 选择几条运单
3. 点击"批量修改应收"
4. 查看对话框是否显示运单详情
5. 修改金额并测试

---

## 📸 界面预览

### 对话框头部
```
🟢 批量修改应收
已选择 50 条运单，请逐个输入新的应付金额
```

### 运单列表（每条卡片）
```
┌────────────────────────────────────────────────────────┐
│ 运单编号: YDN20251022-001                               │
│ 装货日期: 2025/10/22                                    │
│ 司机: 李刚                                              │
│ 原应付金额: ¥2,900.00                                   │
│ 新应付金额: [  3500.00  ] (输入框)                     │
└────────────────────────────────────────────────────────┘
```

### 底部按钮
```
[取消]                    [确认修改 (50条)]
```

---

## 🎉 总结

批量修改应收功能已优化为**详细列表式操作**：
- ✅ 显示每条运单的完整信息
- ✅ 每条运单独立输入框
- ✅ 支持差异化设置金额
- ✅ 更加灵活和实用

**准备好刷新浏览器测试新界面了！** 🚀

