# ç”¨æˆ·ç®¡ç†å®‰å…¨ä¿®å¤ - å®Œæ•´æ–‡ä»¶æ¸…å•

## ğŸ“¦ æ–°å¢çš„ Edge Functions

### Supabase Functions
```
supabase/functions/
â”œâ”€â”€ create-user/
â”‚   â””â”€â”€ index.ts                    # âœ… æ–°å¢ï¼šåˆ›å»ºç”¨æˆ·
â”œâ”€â”€ update-user-password/
â”‚   â””â”€â”€ index.ts                    # âœ… æ–°å¢ï¼šä¿®æ”¹å¯†ç 
â”œâ”€â”€ update-user/
â”‚   â””â”€â”€ index.ts                    # âœ… æ–°å¢ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯
â””â”€â”€ delete-user/
    â””â”€â”€ index.ts                    # âœ… æ–°å¢ï¼šåˆ é™¤ç”¨æˆ·
```

**åŠŸèƒ½è¯´æ˜**ï¼š
- æ‰€æœ‰å‡½æ•°éƒ½åŒ…å«å®Œæ•´çš„æƒé™éªŒè¯
- æ”¯æŒè¯¦ç»†çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- è‡ªåŠ¨æ•°æ®éªŒè¯ï¼ˆé‚®ç®±ã€å¯†ç ã€è§’è‰²ç­‰ï¼‰
- å¤±è´¥è‡ªåŠ¨å›æ»šæœºåˆ¶

---

## ğŸ”§ ä¿®æ”¹çš„å‰ç«¯æ–‡ä»¶

### 1. ç”¨æˆ·ç®¡ç†æœåŠ¡å±‚
```
src/services/
â””â”€â”€ UserManagementService.ts        # âœï¸ å·²ä¿®æ”¹
```

**ä¿®æ”¹å†…å®¹**ï¼š
- `createUser()` - å·²é€šè¿‡ `UserManagement.tsx` è°ƒç”¨ Edge Function
- `updateUser()` - æ”¹ä¸ºè°ƒç”¨ `update-user` å’Œ `update-user-password`
- `deleteUser()` - æ”¹ä¸ºè°ƒç”¨ `delete-user`
- `batchDeleteUsers()` - æ”¹ä¸ºè°ƒç”¨ `delete-user`ï¼ˆæ‰¹é‡ï¼‰

### 2. ç”¨æˆ·ç®¡ç†ç•Œé¢ç»„ä»¶
```
src/components/permissions/
â””â”€â”€ UserManagement.tsx               # âœï¸ å·²ä¿®æ”¹
```

**ä¿®æ”¹å†…å®¹**ï¼š
- `handleCreateUser()` - æ”¹ä¸ºè°ƒç”¨ `create-user` Edge Function

### 3. å¯†ç ä¿®æ”¹å¯¹è¯æ¡†
```
src/components/
â”œâ”€â”€ ChangePasswordDialog.tsx         # âœï¸ å·²ä¿®æ”¹
â””â”€â”€ EnterpriseUserEditDialog.tsx     # âœï¸ å·²ä¿®æ”¹
```

**ä¿®æ”¹å†…å®¹**ï¼š
- `ChangePasswordDialog` - ä¿®æ”¹å¯†ç æ”¹ä¸ºè°ƒç”¨ Edge Function
- `EnterpriseUserEditDialog` - ä¿®æ”¹å¯†ç å’Œé‚®ç®±æ”¹ä¸ºè°ƒç”¨ Edge Function

### 4. ç§»åŠ¨ç«¯ç”¨æˆ·ç®¡ç†
```
src/pages/mobile/
â””â”€â”€ MobileIntegratedUserManagement.tsx  # âœï¸ å·²ä¿®æ”¹
```

**ä¿®æ”¹å†…å®¹**ï¼š
- `handleChangePassword()` - æ”¹ä¸ºè°ƒç”¨ `update-user-password`

---

## ğŸš€ éƒ¨ç½²å’Œæ–‡æ¡£æ–‡ä»¶

### éƒ¨ç½²è„šæœ¬
```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ deploy-all-user-functions.ps1      # âœ… æ–°å¢ï¼šç»Ÿä¸€éƒ¨ç½²è„šæœ¬
â””â”€â”€ deploy-create-user-function.ps1    # âš ï¸ ä¿ç•™ï¼šå•ç‹¬éƒ¨ç½²åˆ›å»ºç”¨æˆ·
```

**è¯´æ˜**ï¼š
- `deploy-all-user-functions.ps1` - æ¨èä½¿ç”¨ï¼Œéƒ¨ç½²æ‰€æœ‰å‡½æ•°
- `deploy-create-user-function.ps1` - å¯é€‰ï¼Œä»…éƒ¨ç½²åˆ›å»ºç”¨æˆ·å‡½æ•°

### æ–‡æ¡£æ–‡ä»¶
```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†å®‰å…¨ä¿®å¤-å¿«é€Ÿå¼€å§‹.md                    # âœ… æ–°å¢ï¼šå¿«é€Ÿå¼€å§‹æŒ‡å—
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†å®‰å…¨å‡çº§å®Œæ•´æŒ‡å—.md                     # âœ… æ–°å¢ï¼šå®Œæ•´æŠ€æœ¯æ–‡æ¡£
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†åŠŸèƒ½å®Œæ•´ä¿®å¤æ¸…å•.md                     # âœ… æ–°å¢ï¼šä¿®å¤æ¸…å•
â”œâ”€â”€ ä¸ºä»€ä¹ˆä¹‹å‰å¯ä»¥åˆ›å»ºç”¨æˆ·-é—®é¢˜åˆ†æ.md              # âœ… æ–°å¢ï¼šé—®é¢˜åŸå› åˆ†æ
â”œâ”€â”€ ç”¨æˆ·åˆ›å»ºåŠŸèƒ½ä¿®å¤è¯´æ˜.md                        # âš ï¸ ä¿ç•™ï¼šåˆ›å»ºç”¨æˆ·ä¸“é¡¹è¯´æ˜
â”œâ”€â”€ ç”¨æˆ·åˆ›å»ºåŠŸèƒ½-å¿«é€Ÿä¿®å¤æŒ‡å—.md                   # âš ï¸ ä¿ç•™ï¼šåˆ›å»ºç”¨æˆ·å¿«é€ŸæŒ‡å—
â””â”€â”€ ç”¨æˆ·ç®¡ç†å®‰å…¨ä¿®å¤-æ–‡ä»¶æ¸…å•.md                   # âœ… æ–°å¢ï¼šæœ¬æ–‡ä»¶
```

---

## ğŸ“Š ä¿®æ”¹ç»Ÿè®¡

### æ–°å¢æ–‡ä»¶
- **Edge Functions**: 4 ä¸ª
- **éƒ¨ç½²è„šæœ¬**: 1 ä¸ª
- **æ–‡æ¡£**: 4 ä¸ª
- **æ€»è®¡**: 9 ä¸ªæ–°æ–‡ä»¶

### ä¿®æ”¹æ–‡ä»¶
- **Service å±‚**: 1 ä¸ª
- **ç»„ä»¶**: 3 ä¸ª
- **é¡µé¢**: 1 ä¸ª
- **æ€»è®¡**: 5 ä¸ªæ–‡ä»¶è¢«ä¿®æ”¹

### ä»£ç è¡Œæ•°ç»Ÿè®¡ï¼ˆä¼°ç®—ï¼‰
- **æ–°å¢ä»£ç **: ~1,200 è¡Œï¼ˆEdge Functionsï¼‰
- **ä¿®æ”¹ä»£ç **: ~200 è¡Œï¼ˆå‰ç«¯ï¼‰
- **æ–‡æ¡£**: ~1,500 è¡Œ
- **æ€»è®¡**: ~2,900 è¡Œ

---

## ğŸ” æ–‡ä»¶è¯¦ç»†è¯´æ˜

### Edge Functions è¯¦ç»†åŠŸèƒ½

#### 1. create-user/index.ts
```typescript
// åŠŸèƒ½ï¼šåˆ›å»ºæ–°ç”¨æˆ·
// æƒé™ï¼šadmin, system_admin
// éªŒè¯ï¼š
//   - é‚®ç®±æ ¼å¼éªŒè¯
//   - å¯†ç å¼ºåº¦éªŒè¯ï¼ˆè‡³å°‘6ä½ï¼‰
//   - é‚®ç®±é‡å¤æ£€æŸ¥
//   - è§’è‰²æœ‰æ•ˆæ€§éªŒè¯
// ç‰¹æ€§ï¼š
//   - è‡ªåŠ¨é‚®ç®±éªŒè¯ï¼ˆæ— éœ€ç”¨æˆ·ç‚¹å‡»ï¼‰
//   - å¤±è´¥è‡ªåŠ¨å›æ»š
//   - è¯¦ç»†é”™è¯¯ä¿¡æ¯
```

#### 2. update-user-password/index.ts
```typescript
// åŠŸèƒ½ï¼šä¿®æ”¹ç”¨æˆ·å¯†ç 
// æƒé™ï¼š
//   - ç”¨æˆ·å¯ä»¥ä¿®æ”¹è‡ªå·±çš„å¯†ç 
//   - admin/system_admin å¯ä»¥ä¿®æ”¹ä»»ä½•äººçš„å¯†ç 
// éªŒè¯ï¼š
//   - å¯†ç å¼ºåº¦éªŒè¯
//   - æƒé™æ£€æŸ¥
// ç‰¹æ€§ï¼š
//   - é˜²æ­¢è¶Šæƒæ“ä½œ
//   - å¯†ç ç«‹å³ç”Ÿæ•ˆ
```

#### 3. update-user/index.ts
```typescript
// åŠŸèƒ½ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯
// æƒé™ï¼š
//   - ç”¨æˆ·å¯ä»¥ä¿®æ”¹è‡ªå·±çš„åŸºæœ¬ä¿¡æ¯
//   - admin/system_admin å¯ä»¥ä¿®æ”¹ä»»ä½•äººçš„ä¿¡æ¯
//   - åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹è§’è‰²å’ŒçŠ¶æ€
// éªŒè¯ï¼š
//   - é‚®ç®±æ ¼å¼éªŒè¯
//   - é‚®ç®±é‡å¤æ£€æŸ¥
//   - è§’è‰²æœ‰æ•ˆæ€§éªŒè¯
// ç‰¹æ€§ï¼š
//   - æƒé™åˆ†çº§æ§åˆ¶
//   - å¯é€‰å­—æ®µæ›´æ–°
```

#### 4. delete-user/index.ts
```typescript
// åŠŸèƒ½ï¼šåˆ é™¤ç”¨æˆ·
// æƒé™ï¼š
//   - admin å¯ä»¥è½¯åˆ é™¤ï¼ˆåœç”¨ï¼‰
//   - system_admin å¯ä»¥ç¡¬åˆ é™¤ï¼ˆæ°¸ä¹…ï¼‰
// ç±»å‹ï¼š
//   - è½¯åˆ é™¤ï¼šè®¾ç½® is_active = false
//   - ç¡¬åˆ é™¤ï¼šå®Œå…¨åˆ é™¤è®¤è¯å’Œæ¡£æ¡ˆ
// ç‰¹æ€§ï¼š
//   - é˜²æ­¢åˆ é™¤è‡ªå·±
//   - æƒé™åˆ†çº§æ§åˆ¶
//   - æ”¯æŒæ‰¹é‡æ“ä½œ
```

---

## ğŸ” å®‰å…¨æ”¹è¿›å¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆä¸å®‰å…¨ï¼‰âŒ
```typescript
// ç›´æ¥åœ¨å‰ç«¯è°ƒç”¨ Admin API
const { data } = await supabase.auth.admin.createUser({...});
const { error } = await supabase.auth.admin.updateUserById(...);
const { error } = await supabase.auth.admin.deleteUser(...);
```

**é—®é¢˜**ï¼š
- âŒ Service Role Key æš´éœ²åœ¨å‰ç«¯
- âŒ ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡æµè§ˆå™¨è·å–å¯†é’¥
- âŒ æ— æƒé™éªŒè¯
- âŒ æ— å®¡è®¡æ—¥å¿—

### ä¿®æ”¹åï¼ˆå®‰å…¨ï¼‰âœ…
```typescript
// é€šè¿‡ Edge Function è°ƒç”¨
const { data } = await supabase.functions.invoke('create-user', {...});
const { data } = await supabase.functions.invoke('update-user-password', {...});
const { data } = await supabase.functions.invoke('update-user', {...});
const { data } = await supabase.functions.invoke('delete-user', {...});
```

**ä¼˜åŠ¿**ï¼š
- âœ… Service Role Key åªåœ¨æœåŠ¡ç«¯
- âœ… å®Œå–„çš„æƒé™éªŒè¯
- âœ… è¯¦ç»†çš„å®¡è®¡æ—¥å¿—
- âœ… æ›´å¥½çš„é”™è¯¯å¤„ç†
- âœ… æ”¯æŒå¤æ‚ä¸šåŠ¡é€»è¾‘

---

## ğŸ“‹ ä½¿ç”¨å»ºè®®

### æ¨èé˜…è¯»é¡ºåº

1. **å¿«é€Ÿå¼€å§‹**ï¼š`ç”¨æˆ·ç®¡ç†å®‰å…¨ä¿®å¤-å¿«é€Ÿå¼€å§‹.md`
   - äº†è§£åŸºæœ¬æƒ…å†µ
   - å¿«é€Ÿéƒ¨ç½²å’Œæµ‹è¯•

2. **é—®é¢˜åˆ†æ**ï¼š`ä¸ºä»€ä¹ˆä¹‹å‰å¯ä»¥åˆ›å»ºç”¨æˆ·-é—®é¢˜åˆ†æ.md`
   - ç†è§£é—®é¢˜åŸå› 
   - äº†è§£ä¸åŒæ–¹æ¡ˆ

3. **å®Œæ•´æŒ‡å—**ï¼š`ç”¨æˆ·ç®¡ç†å®‰å…¨å‡çº§å®Œæ•´æŒ‡å—.md`
   - è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹
   - API æ–‡æ¡£
   - æ•…éšœæ’æŸ¥

4. **æœ¬æ–‡ä»¶**ï¼šäº†è§£æ‰€æœ‰å˜æ›´çš„æ–‡ä»¶

### éƒ¨ç½²é¡ºåº

1. **ç¬¬ä¸€æ­¥**ï¼šè¿è¡Œ `deploy-all-user-functions.ps1`
2. **ç¬¬äºŒæ­¥**ï¼šåˆ·æ–°å‰ç«¯é¡µé¢
3. **ç¬¬ä¸‰æ­¥**ï¼šæµ‹è¯•æ‰€æœ‰åŠŸèƒ½

### æµ‹è¯•é¡ºåº

1. **åˆ›å»ºç”¨æˆ·** - åŸºç¡€åŠŸèƒ½
2. **ä¿®æ”¹å¯†ç ** - æƒé™éªŒè¯
3. **æ›´æ–°ä¿¡æ¯** - æ•°æ®éªŒè¯
4. **åˆ é™¤ç”¨æˆ·** - è½¯åˆ é™¤/ç¡¬åˆ é™¤

---

## âœ… éªŒæ”¶æ¸…å•

### éƒ¨ç½²éªŒæ”¶
- [ ] æ‰€æœ‰ 4 ä¸ª Edge Functions éƒ¨ç½²æˆåŠŸ
- [ ] å‰ç«¯ä»£ç å·²æ›´æ–°
- [ ] æµè§ˆå™¨å·²åˆ·æ–°ï¼ˆCtrl+F5ï¼‰

### åŠŸèƒ½éªŒæ”¶
- [ ] å¯ä»¥åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆæ— éœ€é‚®ç®±éªŒè¯ï¼‰
- [ ] å¯ä»¥ä¿®æ”¹ç”¨æˆ·å¯†ç 
- [ ] å¯ä»¥æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- [ ] å¯ä»¥åœç”¨ç”¨æˆ·ï¼ˆè½¯åˆ é™¤ï¼‰
- [ ] system_admin å¯ä»¥æ°¸ä¹…åˆ é™¤ç”¨æˆ·ï¼ˆç¡¬åˆ é™¤ï¼‰

### å®‰å…¨éªŒæ”¶
- [ ] æ™®é€šç”¨æˆ·æ— æ³•ä¿®æ”¹ä»–äººä¿¡æ¯
- [ ] æ™®é€šç”¨æˆ·æ— æ³•ä¿®æ”¹è§’è‰²
- [ ] æ™®é€šç”¨æˆ·æ— æ³•åˆ é™¤ç”¨æˆ·
- [ ] admin æ— æ³•ç¡¬åˆ é™¤ç”¨æˆ·
- [ ] æ— æ³•åˆ é™¤è‡ªå·±çš„è´¦å·

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### ç«‹å³æ‰§è¡Œ
```powershell
# éƒ¨ç½²æ‰€æœ‰ Edge Functions
.\deploy-all-user-functions.ps1
```

### åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
1. æ·»åŠ ç”¨æˆ·æ“ä½œå®¡è®¡æ—¥å¿—
2. å¢åŠ é‚®ä»¶é€šçŸ¥åŠŸèƒ½
3. æ”¯æŒæ‰¹é‡å¯¼å…¥ç”¨æˆ·
4. æ·»åŠ ç”¨æˆ·æ ‡ç­¾ç³»ç»Ÿ
5. å®ç°ç”¨æˆ·æƒé™ç»§æ‰¿

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ–‡æ¡£**ï¼šå…ˆæŸ¥çœ‹å¯¹åº”çš„æ–‡æ¡£
2. **æŸ¥çœ‹æ—¥å¿—**ï¼š`supabase functions logs <function-name>`
3. **é‡æ–°éƒ¨ç½²**ï¼š`.\deploy-all-user-functions.ps1`
4. **è”ç³»æ”¯æŒ**ï¼šæä¾›é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—

---

## ğŸ‰ å®Œæˆï¼

æ‰€æœ‰æ–‡ä»¶å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹éƒ¨ç½²äº†ï¼

**é¢„è®¡æ—¶é—´**ï¼š5-10 åˆ†é’Ÿå®Œæˆéƒ¨ç½²å’Œæµ‹è¯•

**æ•ˆæœ**ï¼šç”¨æˆ·ç®¡ç†ç³»ç»Ÿå®Œå…¨å®‰å…¨ï¼Œæ— ä»»ä½•å®‰å…¨æ¼æ´ï¼ğŸ”’âœ¨

