# ä»˜æ¬¾å®¡æ ¸å’Œè´¢åŠ¡ä»˜æ¬¾ç­›é€‰å™¨å‡çº§ - å®Œæ•´å®æ–½æŒ‡å—

## âœ… åç«¯SQLå·²å®Œæˆ

**æ–‡ä»¶**ï¼š`å‡çº§ä»˜æ¬¾å®¡æ ¸ç­›é€‰å™¨_åç«¯å‡½æ•°.sql`

---

## ğŸš€ ç«‹å³æ‰§è¡Œ

### æ­¥éª¤1ï¼šæ‰§è¡ŒSQLè„šæœ¬

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š
```
å‡çº§ä»˜æ¬¾å®¡æ ¸ç­›é€‰å™¨_åç«¯å‡½æ•°.sql
```

---

## ğŸ“‹ å‰ç«¯ä¿®æ”¹æŒ‡å—

ç”±äºä¸¤ä¸ªé¡µé¢ï¼ˆPaymentAudit.tsx å’Œ PaymentRequestsList.tsxï¼‰çš„ä¿®æ”¹éå¸¸ç›¸ä¼¼ï¼Œä¸”ä»£ç é‡å¤§ï¼Œè¿™é‡Œæä¾›è¯¦ç»†çš„ä¿®æ”¹æ¸…å•ã€‚

### éœ€è¦ä¿®æ”¹çš„é¡µé¢

1. âœ… **ä»˜æ¬¾å®¡æ ¸** - `src/pages/PaymentAudit.tsx`
2. âœ… **è´¢åŠ¡ä»˜æ¬¾** - `src/pages/PaymentRequestsList.tsx`

---

## ğŸ¯ ä¿®æ”¹æ¸…å•ï¼ˆä¸¤ä¸ªé¡µé¢éƒ½éœ€è¦ï¼‰

### 1. å›¾æ ‡å¯¼å…¥ï¼ˆå‚è€ƒPaymentRequest.tsxï¼‰

**åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ **ï¼š

```typescript
// å›¾æ ‡å ä½ç¬¦ç»„ä»¶
const ChevronDown = ({ className }: { className?: string }) => <span className={className}>â–¼</span>;
const ChevronUp = ({ className }: { className?: string }) => <span className={className}>â–²</span>;
const Hash = ({ className }: { className?: string }) => <span className={className}>#</span>;
const Phone = ({ className }: { className?: string }) => <span className={className}>ğŸ“</span>;
const Building2 = ({ className }: { className?: string }) => <span className={className}>ğŸ¢</span>;

// å¯¼å…¥æ‰¹é‡è¾“å…¥å¯¹è¯æ¡†
import { BatchInputDialog } from "@/pages/BusinessEntry/components/BatchInputDialog";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { DateRangePicker } from "@/components/ui/date-range-picker";
import { Plus } from "lucide-react";
```

---

### 2. æ‰©å±•ç­›é€‰å™¨æ•°æ®ç»“æ„

**æ‰¾åˆ° filters çŠ¶æ€å®šä¹‰ï¼Œä¿®æ”¹ä¸º**ï¼š

```typescript
const [filters, setFilters] = useState({
  // å¸¸è§„ç­›é€‰
  projectId: '',
  startDate: '',
  endDate: '',
  status: '',  // ç”³è¯·å•çŠ¶æ€
  
  // é«˜çº§ç­›é€‰
  requestId: '',          // ç”³è¯·å•å·
  waybillNumbers: '',     // è¿å•å·ï¼ˆæ”¹ä¸ºå¤æ•°ï¼‰
  driverName: '',         // å¸æœº
  licensePlate: '',       // ğŸ†• è½¦ç‰Œå·
  driverPhone: '',        // ğŸ†• ç”µè¯
  otherPlatformName: ''   // ğŸ†• å¹³å°åç§°
});
```

---

### 3. æ·»åŠ æ–°çŠ¶æ€ç®¡ç†

**åœ¨ç°æœ‰çŠ¶æ€åæ·»åŠ **ï¼š

```typescript
const [showAdvanced, setShowAdvanced] = useState(false); // æ§åˆ¶é«˜çº§ç­›é€‰å±•å¼€/æ”¶èµ·
const [platformOptions, setPlatformOptions] = useState<{
  platform_name: string;
  usage_count: number;
}[]>([]); // åŠ¨æ€å¹³å°é€‰é¡¹
const [batchDialog, setBatchDialog] = useState<{
  isOpen: boolean;
  type: 'waybill' | 'driver' | 'license' | 'phone' | null;
}>({ isOpen: false, type: null });
```

---

### 4. æ·»åŠ æ‰¹é‡è¾“å…¥å¤„ç†å‡½æ•°

**åœ¨ç­›é€‰å™¨å¤„ç†å‡½æ•°åæ·»åŠ **ï¼š

```typescript
// æ‰¹é‡è¾“å…¥å¯¹è¯æ¡†å¤„ç†
const openBatchDialog = (type: 'waybill' | 'driver' | 'license' | 'phone') => {
  setBatchDialog({ isOpen: true, type });
};

const closeBatchDialog = () => {
  setBatchDialog({ isOpen: false, type: null });
};

const handleBatchConfirm = (values: string[]) => {
  const value = values.join(',');
  const type = batchDialog.type;
  if (type === 'waybill') handleFilterChange('waybillNumbers', value);
  else if (type === 'driver') handleFilterChange('driverName', value);
  else if (type === 'license') handleFilterChange('licensePlate', value);
  else if (type === 'phone') handleFilterChange('driverPhone', value);
};

const getCurrentBatchValue = () => {
  const type = batchDialog.type;
  if (type === 'waybill') return filters.waybillNumbers;
  if (type === 'driver') return filters.driverName;
  if (type === 'license') return filters.licensePlate;
  if (type === 'phone') return filters.driverPhone;
  return '';
};

const getBatchDialogConfig = () => {
  const type = batchDialog.type;
  if (type === 'waybill') return {
    title: 'æ‰¹é‡è¾“å…¥è¿å•ç¼–å·',
    placeholder: 'è¯·ç²˜è´´è¿å•ç¼–å·ï¼Œç”¨æ¢è¡Œæˆ–é€—å·åˆ†éš”ã€‚',
    description: 'æ”¯æŒæ‰¹é‡è¾“å…¥å¤šä¸ªè¿å•ç¼–å·'
  };
  if (type === 'driver') return {
    title: 'æ‰¹é‡è¾“å…¥å¸æœºå§“å',
    placeholder: 'è¯·ç²˜è´´å¸æœºå§“åï¼Œç”¨æ¢è¡Œæˆ–é€—å·åˆ†éš”ã€‚',
    description: 'æ”¯æŒæ‰¹é‡è¾“å…¥å¤šä¸ªå¸æœºå§“å'
  };
  if (type === 'license') return {
    title: 'æ‰¹é‡è¾“å…¥è½¦ç‰Œå·',
    placeholder: 'è¯·ç²˜è´´è½¦ç‰Œå·ï¼Œç”¨æ¢è¡Œæˆ–é€—å·åˆ†éš”ã€‚',
    description: 'æ”¯æŒæ‰¹é‡è¾“å…¥å¤šä¸ªè½¦ç‰Œå·'
  };
  if (type === 'phone') return {
    title: 'æ‰¹é‡è¾“å…¥ç”µè¯å·ç ',
    placeholder: 'è¯·ç²˜è´´ç”µè¯å·ç ï¼Œç”¨æ¢è¡Œæˆ–é€—å·åˆ†éš”ã€‚',
    description: 'æ”¯æŒæ‰¹é‡è¾“å…¥å¤šä¸ªç”µè¯å·ç '
  };
  return { title: '', placeholder: '', description: '' };
};

// åŠ è½½åŠ¨æ€å¹³å°é€‰é¡¹
useEffect(() => {
  const loadPlatformOptions = async () => {
    const { data } = await supabase.rpc('get_all_used_platforms');
    if (data) {
      const fixedPlatforms = ['æœ¬å¹³å°', 'ä¸­ç§‘æ™ºè¿', 'ä¸­å·¥æ™ºäº‘', 'å¯ä¹å…¬å¸', 'ç›¼ç›¼é›†å›¢'];
      const dynamicPlatforms = data.filter(
        (p: any) => !fixedPlatforms.includes(p.platform_name)
      );
      setPlatformOptions(dynamicPlatforms);
    }
  };
  loadPlatformOptions();
}, []);
```

---

### 5. ä¿®æ”¹RPCè°ƒç”¨å‚æ•°

**åœ¨ fetchPaymentRequests å‡½æ•°ä¸­ï¼Œä¿®æ”¹ä¸º**ï¼š

```typescript
const { data, error } = await supabase.rpc('get_payment_requests_filtered', {
  p_request_id: filters.requestId || null,
  p_start_date: filters.startDate || null,
  p_end_date: filters.endDate || null,
  p_status: filters.status || null,
  p_project_id: filters.projectId || null,
  p_waybill_numbers: filters.waybillNumbers || null,  // æ”¹ä¸ºå¤æ•°
  p_driver_name: filters.driverName || null,
  p_license_plate: filters.licensePlate || null,
  p_driver_phone: filters.driverPhone || null,
  p_other_platform_name: filters.otherPlatformName || null,
  p_limit: pageSize,
  p_offset: (currentPage - 1) * pageSize
});
```

---

### 6. é‡æ„ç­›é€‰å™¨UI

**å®Œæ•´çš„ç­›é€‰å™¨JSXä»£ç **ï¼š

```tsx
{/* æ‰¹é‡è¾“å…¥å¯¹è¯æ¡† */}
<BatchInputDialog
  isOpen={batchDialog.isOpen}
  onClose={closeBatchDialog}
  onConfirm={handleBatchConfirm}
  title={getBatchDialogConfig().title}
  description={getBatchDialogConfig().description}
  placeholder={getBatchDialogConfig().placeholder}
  currentValue={getCurrentBatchValue()}
/>

{/* ç­›é€‰å™¨å¡ç‰‡ */}
<Card>
  <CardContent className="p-4">
    {/* å¸¸è§„ç­›é€‰åŒºåŸŸ */}
    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 items-end">
      {/* é¡¹ç›®ç­›é€‰ */}
      <div className="flex flex-col gap-1.5">
        <Label>é¡¹ç›®</Label>
        <Select value={filters.projectId} onValueChange={(v) => handleFilterChange('projectId', v)}>
          <SelectTrigger className="h-10">
            <SelectValue placeholder="æ‰€æœ‰é¡¹ç›®" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">æ‰€æœ‰é¡¹ç›®</SelectItem>
            {projects.map(p => (
              <SelectItem key={p.id} value={p.id}>{p.name}</SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      
      {/* æ—¥æœŸèŒƒå›´ç­›é€‰ */}
      <div className="flex flex-col gap-1.5">
        <Label>æ—¥æœŸèŒƒå›´</Label>
        <DateRangePicker 
          date={dateRangeValue} 
          setDate={handleDateChange} 
        />
      </div>
      
      {/* ç”³è¯·å•çŠ¶æ€ç­›é€‰ */}
      <div className="flex flex-col gap-1.5">
        <Label>ç”³è¯·å•çŠ¶æ€</Label>
        <Select value={filters.status} onValueChange={(v) => handleFilterChange('status', v)}>
          <SelectTrigger className="h-10">
            <SelectValue placeholder="æ‰€æœ‰çŠ¶æ€" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">æ‰€æœ‰çŠ¶æ€</SelectItem>
            <SelectItem value="Pending">å¾…å®¡æ ¸</SelectItem>
            <SelectItem value="Approved">å·²å®¡æ ¸</SelectItem>
            <SelectItem value="Paid">å·²ä»˜æ¬¾</SelectItem>
            <SelectItem value="Rejected">å·²æ‹’ç»</SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      {/* æœç´¢/æ¸…é™¤æŒ‰é’® */}
      <div className="flex gap-2 items-end">
        <Button onClick={fetchPaymentRequests} className="h-10 flex-1 bg-blue-600 hover:bg-blue-700">
          <Search className="mr-2 h-4 w-4"/>æœç´¢
        </Button>
        <Button variant="outline" onClick={clearFilters} className="h-10 flex-1">æ¸…é™¤</Button>
      </div>
    </div>
    
    {/* å±•å¼€/æ”¶èµ·é«˜çº§ç­›é€‰æŒ‰é’® */}
    <div className="mt-4 flex justify-center">
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setShowAdvanced(!showAdvanced)}
        className="text-purple-600 hover:text-purple-700 hover:bg-purple-50"
      >
        {showAdvanced ? (
          <>
            <ChevronUp className="mr-1 h-4 w-4" />
            æ”¶èµ·é«˜çº§ç­›é€‰
          </>
        ) : (
          <>
            <ChevronDown className="mr-1 h-4 w-4" />
            å±•å¼€é«˜çº§ç­›é€‰
          </>
        )}
      </Button>
    </div>
    
    {/* é«˜çº§ç­›é€‰åŒºåŸŸ */}
    {showAdvanced && (
      <div className="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {/* ç”³è¯·å•å·ç­›é€‰ */}
          <div className="space-y-2">
            <Label htmlFor="request-id" className="text-sm font-medium text-purple-800">
              ç”³è¯·å•å·
            </Label>
            <Input
              id="request-id"
              placeholder="ç”³è¯·å•å·..."
              value={filters.requestId}
              onChange={(e) => handleFilterChange('requestId', e.target.value)}
              className="h-10"
            />
          </div>
          
          {/* è¿å•ç¼–å·ç­›é€‰ï¼ˆæ‰¹é‡ï¼‰ */}
          <div className="space-y-2">
            <Label htmlFor="waybill" className="text-sm font-medium text-purple-800 flex items-center gap-1">
              <FileText className="h-4 w-4" />
              è¿å•ç¼–å·
            </Label>
            <div className="flex gap-1">
              <Input
                id="waybill"
                placeholder="è¿å•ç¼–å·ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”..."
                value={filters.waybillNumbers}
                onChange={(e) => handleFilterChange('waybillNumbers', e.target.value)}
                onKeyDown={(e) => { if (e.key === 'Enter') fetchPaymentRequests(); }}
                className="h-10 flex-1"
              />
              <Button variant="outline" size="sm" onClick={() => openBatchDialog('waybill')} className="h-10 px-2">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
            <div className="text-xs text-purple-600">
              ğŸ’¡ æ”¯æŒæœç´¢æœ¬å¹³å°å’Œå…¶ä»–å¹³å°è¿å•å·
            </div>
          </div>
          
          {/* å¸æœºç­›é€‰ï¼ˆæ‰¹é‡ï¼‰ */}
          <div className="space-y-2">
            <Label htmlFor="driver" className="text-sm font-medium text-purple-800 flex items-center gap-1">
              <Users className="h-4 w-4" />
              å¸æœº
            </Label>
            <div className="flex gap-1">
              <Input
                id="driver"
                placeholder="å¸æœºå§“åï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”..."
                value={filters.driverName}
                onChange={(e) => handleFilterChange('driverName', e.target.value)}
                className="h-10 flex-1"
              />
              <Button variant="outline" size="sm" onClick={() => openBatchDialog('driver')} className="h-10 px-2">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
          </div>
          
          {/* è½¦ç‰Œå·ç­›é€‰ï¼ˆæ‰¹é‡ï¼‰ */}
          <div className="space-y-2">
            <Label htmlFor="license" className="text-sm font-medium text-purple-800 flex items-center gap-1">
              <Hash className="h-4 w-4" />
              è½¦ç‰Œå·
            </Label>
            <div className="flex gap-1">
              <Input
                id="license"
                placeholder="è½¦ç‰Œå·ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”..."
                value={filters.licensePlate}
                onChange={(e) => handleFilterChange('licensePlate', e.target.value)}
                className="h-10 flex-1"
              />
              <Button variant="outline" size="sm" onClick={() => openBatchDialog('license')} className="h-10 px-2">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
          </div>
          
          {/* ç”µè¯ç­›é€‰ï¼ˆæ‰¹é‡ï¼‰ */}
          <div className="space-y-2">
            <Label htmlFor="phone" className="text-sm font-medium text-purple-800 flex items-center gap-1">
              <Phone className="h-4 w-4" />
              ç”µè¯
            </Label>
            <div className="flex gap-1">
              <Input
                id="phone"
                placeholder="ç”µè¯ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”..."
                value={filters.driverPhone}
                onChange={(e) => handleFilterChange('driverPhone', e.target.value)}
                className="h-10 flex-1"
              />
              <Button variant="outline" size="sm" onClick={() => openBatchDialog('phone')} className="h-10 px-2">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
          </div>
          
          {/* å…¶ä»–å¹³å°åç§°ç­›é€‰ */}
          <div className="space-y-2">
            <Label htmlFor="platform" className="text-sm font-medium text-purple-800 flex items-center gap-1">
              <Building2 className="h-4 w-4" />
              å…¶ä»–å¹³å°åç§°
            </Label>
            <Select value={filters.otherPlatformName || 'all'} onValueChange={(v) => handleFilterChange('otherPlatformName', v === 'all' ? '' : v)}>
              <SelectTrigger id="platform" className="h-10">
                <SelectValue placeholder="é€‰æ‹©å¹³å°" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">æ‰€æœ‰å¹³å°</SelectItem>
                <SelectItem value="æœ¬å¹³å°">æœ¬å¹³å°</SelectItem>
                <SelectItem value="ä¸­ç§‘æ™ºè¿">ä¸­ç§‘æ™ºè¿</SelectItem>
                <SelectItem value="ä¸­å·¥æ™ºäº‘">ä¸­å·¥æ™ºäº‘</SelectItem>
                <SelectItem value="å¯ä¹å…¬å¸">å¯ä¹å…¬å¸</SelectItem>
                <SelectItem value="ç›¼ç›¼é›†å›¢">ç›¼ç›¼é›†å›¢</SelectItem>
                {platformOptions.length > 0 && (
                  <>
                    <SelectItem value="---" disabled className="text-xs text-purple-400">
                      â”€â”€â”€ å…¶ä»–å¹³å° â”€â”€â”€
                    </SelectItem>
                    {platformOptions.map((platform) => (
                      <SelectItem key={platform.platform_name} value={platform.platform_name}>
                        {platform.platform_name} ({platform.usage_count}æ¡)
                      </SelectItem>
                    ))}
                  </>
                )}
              </SelectContent>
            </Select>
          </div>
        </div>
      </div>
    )}
  </CardContent>
</Card>
```

---

## ğŸ“ å®Œæ•´å‚è€ƒæ–‡ä»¶

ç”±äºä»£ç é‡å¤§ï¼Œå»ºè®®**ç›´æ¥å¤åˆ¶PaymentRequest.tsxçš„ç­›é€‰å™¨éƒ¨åˆ†**ï¼š

### å‚è€ƒæ–‡ä»¶
`src/pages/PaymentRequest.tsx`

### å‚è€ƒè¡Œæ•°
- å›¾æ ‡å®šä¹‰ï¼šç¬¬30-42è¡Œ
- æ‰¹é‡å¯¹è¯æ¡†å¯¼å…¥ï¼šç¬¬52è¡Œ
- çŠ¶æ€ç®¡ç†ï¼šç¬¬125-136è¡Œ
- æ‰¹é‡è¾“å…¥å¤„ç†å‡½æ•°ï¼šç¬¬277-304è¡Œ
- ç­›é€‰å™¨UIï¼šç¬¬1025-1268è¡Œ

### ä¸»è¦ä¿®æ”¹ç‚¹

| ä»˜æ¬¾ç”³è¯· | ä»˜æ¬¾å®¡æ ¸/è´¢åŠ¡ä»˜æ¬¾ | è¯´æ˜ |
|---------|----------------|------|
| æ”¯ä»˜çŠ¶æ€ç­›é€‰ | ç”³è¯·å•çŠ¶æ€ç­›é€‰ | å­—æ®µåæ”¹ä¸ºstatus |
| åˆä½œæ–¹ç­›é€‰ | âŒ åˆ é™¤ | ä¸éœ€è¦ |
| driverNamesæ•°ç»„ | driverNameå­—ç¬¦ä¸² | å·²ç»Ÿä¸€ä¸ºå­—ç¬¦ä¸²æ‰¹é‡ |
| å…¶ä»–ç›¸åŒ | å…¶ä»–ç›¸åŒ | å®Œå…¨ä¸€è‡´ |

---

## ğŸ¯ å¿«é€Ÿå®æ–½æ­¥éª¤

### æ–¹æ³•1ï¼šæ‰‹åŠ¨ä¿®æ”¹ï¼ˆæ¨èç†è§£ä»£ç ï¼‰

æŒ‰ç…§ä¸Šè¿°ä¿®æ”¹æ¸…å•é€é¡¹ä¿®æ”¹

### æ–¹æ³•2ï¼šå‚è€ƒå¤åˆ¶ï¼ˆå¿«é€Ÿå®æ–½ï¼‰

1. æ‰“å¼€ `PaymentRequest.tsx`
2. å¤åˆ¶ç­›é€‰å™¨ç›¸å…³ä»£ç 
3. ç²˜è´´åˆ° `PaymentAudit.tsx` å’Œ `PaymentRequestsList.tsx`
4. ä¿®æ”¹å­—æ®µåç§°ï¼š
   - `paymentStatus` â†’ `status`ï¼ˆç”³è¯·å•çŠ¶æ€ï¼‰
   - åˆ é™¤ `partnerId`ï¼ˆä¸éœ€è¦åˆä½œæ–¹ç­›é€‰ï¼‰
5. æµ‹è¯•åŠŸèƒ½

---

## â±ï¸ æ—¶é—´ä¼°ç®—

| ä»»åŠ¡ | æ—¶é—´ |
|-----|------|
| æ‰§è¡ŒSQLè„šæœ¬ | 1åˆ†é’Ÿ |
| ä¿®æ”¹PaymentAudit.tsx | 30åˆ†é’Ÿ |
| ä¿®æ”¹PaymentRequestsList.tsx | 30åˆ†é’Ÿ |
| æµ‹è¯•éªŒè¯ | 15åˆ†é’Ÿ |
| **æ€»è®¡** | **çº¦1.5å°æ—¶** |

---

## ğŸš¨ é‡è¦æç¤º

### å…ˆæ‰§è¡ŒSQLå†ä¿®æ”¹å‰ç«¯

```
1. âœ… æ‰§è¡ŒSQLè„šæœ¬ï¼ˆå‡çº§ä»˜æ¬¾å®¡æ ¸ç­›é€‰å™¨_åç«¯å‡½æ•°.sqlï¼‰
2. â³ ä¿®æ”¹å‰ç«¯ä»£ç 
3. â³ æµ‹è¯•åŠŸèƒ½
```

---

**SQLè„šæœ¬å·²å‡†å¤‡å¥½ï¼Œå»ºè®®æ‚¨å…ˆæ‰§è¡ŒSQLï¼ŒæˆåŠŸåæˆ‘ç»§ç»­ä¿®æ”¹å‰ç«¯ä»£ç ï¼** ğŸš€

