# 付款审核和财务付款筛选器升级 - 完整实施指南

## ✅ 后端SQL已完成

**文件**：`升级付款审核筛选器_后端函数.sql`

---

## 🚀 立即执行

### 步骤1：执行SQL脚本

在 Supabase SQL Editor 中执行：
```
升级付款审核筛选器_后端函数.sql
```

---

## 📋 前端修改指南

由于两个页面（PaymentAudit.tsx 和 PaymentRequestsList.tsx）的修改非常相似，且代码量大，这里提供详细的修改清单。

### 需要修改的页面

1. ✅ **付款审核** - `src/pages/PaymentAudit.tsx`
2. ✅ **财务付款** - `src/pages/PaymentRequestsList.tsx`

---

## 🎯 修改清单（两个页面都需要）

### 1. 图标导入（参考PaymentRequest.tsx）

**在文件顶部添加**：

```typescript
// 图标占位符组件
const ChevronDown = ({ className }: { className?: string }) => <span className={className}>▼</span>;
const ChevronUp = ({ className }: { className?: string }) => <span className={className}>▲</span>;
const Hash = ({ className }: { className?: string }) => <span className={className}>#</span>;
const Phone = ({ className }: { className?: string }) => <span className={className}>📞</span>;
const Building2 = ({ className }: { className?: string }) => <span className={className}>🏢</span>;

// 导入批量输入对话框
import { BatchInputDialog } from "@/pages/BusinessEntry/components/BatchInputDialog";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { DateRangePicker } from "@/components/ui/date-range-picker";
import { Plus } from "lucide-react";
```

---

### 2. 扩展筛选器数据结构

**找到 filters 状态定义，修改为**：

```typescript
const [filters, setFilters] = useState({
  // 常规筛选
  projectId: '',
  startDate: '',
  endDate: '',
  status: '',  // 申请单状态
  
  // 高级筛选
  requestId: '',          // 申请单号
  waybillNumbers: '',     // 运单号（改为复数）
  driverName: '',         // 司机
  licensePlate: '',       // 🆕 车牌号
  driverPhone: '',        // 🆕 电话
  otherPlatformName: ''   // 🆕 平台名称
});
```

---

### 3. 添加新状态管理

**在现有状态后添加**：

```typescript
const [showAdvanced, setShowAdvanced] = useState(false); // 控制高级筛选展开/收起
const [platformOptions, setPlatformOptions] = useState<{
  platform_name: string;
  usage_count: number;
}[]>([]); // 动态平台选项
const [batchDialog, setBatchDialog] = useState<{
  isOpen: boolean;
  type: 'waybill' | 'driver' | 'license' | 'phone' | null;
}>({ isOpen: false, type: null });
```

---

### 4. 添加批量输入处理函数

**在筛选器处理函数后添加**：

```typescript
// 批量输入对话框处理
const openBatchDialog = (type: 'waybill' | 'driver' | 'license' | 'phone') => {
  setBatchDialog({ isOpen: true, type });
};

const closeBatchDialog = () => {
  setBatchDialog({ isOpen: false, type: null });
};

const handleBatchConfirm = (values: string[]) => {
  const value = values.join(',');
  const type = batchDialog.type;
  if (type === 'waybill') handleFilterChange('waybillNumbers', value);
  else if (type === 'driver') handleFilterChange('driverName', value);
  else if (type === 'license') handleFilterChange('licensePlate', value);
  else if (type === 'phone') handleFilterChange('driverPhone', value);
};

const getCurrentBatchValue = () => {
  const type = batchDialog.type;
  if (type === 'waybill') return filters.waybillNumbers;
  if (type === 'driver') return filters.driverName;
  if (type === 'license') return filters.licensePlate;
  if (type === 'phone') return filters.driverPhone;
  return '';
};

const getBatchDialogConfig = () => {
  const type = batchDialog.type;
  if (type === 'waybill') return {
    title: '批量输入运单编号',
    placeholder: '请粘贴运单编号，用换行或逗号分隔。',
    description: '支持批量输入多个运单编号'
  };
  if (type === 'driver') return {
    title: '批量输入司机姓名',
    placeholder: '请粘贴司机姓名，用换行或逗号分隔。',
    description: '支持批量输入多个司机姓名'
  };
  if (type === 'license') return {
    title: '批量输入车牌号',
    placeholder: '请粘贴车牌号，用换行或逗号分隔。',
    description: '支持批量输入多个车牌号'
  };
  if (type === 'phone') return {
    title: '批量输入电话号码',
    placeholder: '请粘贴电话号码，用换行或逗号分隔。',
    description: '支持批量输入多个电话号码'
  };
  return { title: '', placeholder: '', description: '' };
};

// 加载动态平台选项
useEffect(() => {
  const loadPlatformOptions = async () => {
    const { data } = await supabase.rpc('get_all_used_platforms');
    if (data) {
      const fixedPlatforms = ['本平台', '中科智运', '中工智云', '可乐公司', '盼盼集团'];
      const dynamicPlatforms = data.filter(
        (p: any) => !fixedPlatforms.includes(p.platform_name)
      );
      setPlatformOptions(dynamicPlatforms);
    }
  };
  loadPlatformOptions();
}, []);
```

---

### 5. 修改RPC调用参数

**在 fetchPaymentRequests 函数中，修改为**：

```typescript
const { data, error } = await supabase.rpc('get_payment_requests_filtered', {
  p_request_id: filters.requestId || null,
  p_start_date: filters.startDate || null,
  p_end_date: filters.endDate || null,
  p_status: filters.status || null,
  p_project_id: filters.projectId || null,
  p_waybill_numbers: filters.waybillNumbers || null,  // 改为复数
  p_driver_name: filters.driverName || null,
  p_license_plate: filters.licensePlate || null,
  p_driver_phone: filters.driverPhone || null,
  p_other_platform_name: filters.otherPlatformName || null,
  p_limit: pageSize,
  p_offset: (currentPage - 1) * pageSize
});
```

---

### 6. 重构筛选器UI

**完整的筛选器JSX代码**：

```tsx
{/* 批量输入对话框 */}
<BatchInputDialog
  isOpen={batchDialog.isOpen}
  onClose={closeBatchDialog}
  onConfirm={handleBatchConfirm}
  title={getBatchDialogConfig().title}
  description={getBatchDialogConfig().description}
  placeholder={getBatchDialogConfig().placeholder}
  currentValue={getCurrentBatchValue()}
/>

{/* 筛选器卡片 */}
<Card>
  <CardContent className="p-4">
    {/* 常规筛选区域 */}
    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 items-end">
      {/* 项目筛选 */}
      <div className="flex flex-col gap-1.5">
        <Label>项目</Label>
        <Select value={filters.projectId} onValueChange={(v) => handleFilterChange('projectId', v)}>
          <SelectTrigger className="h-10">
            <SelectValue placeholder="所有项目" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">所有项目</SelectItem>
            {projects.map(p => (
              <SelectItem key={p.id} value={p.id}>{p.name}</SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      
      {/* 日期范围筛选 */}
      <div className="flex flex-col gap-1.5">
        <Label>日期范围</Label>
        <DateRangePicker 
          date={dateRangeValue} 
          setDate={handleDateChange} 
        />
      </div>
      
      {/* 申请单状态筛选 */}
      <div className="flex flex-col gap-1.5">
        <Label>申请单状态</Label>
        <Select value={filters.status} onValueChange={(v) => handleFilterChange('status', v)}>
          <SelectTrigger className="h-10">
            <SelectValue placeholder="所有状态" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="">所有状态</SelectItem>
            <SelectItem value="Pending">待审核</SelectItem>
            <SelectItem value="Approved">已审核</SelectItem>
            <SelectItem value="Paid">已付款</SelectItem>
            <SelectItem value="Rejected">已拒绝</SelectItem>
          </SelectContent>
        </Select>
      </div>
      
      {/* 搜索/清除按钮 */}
      <div className="flex gap-2 items-end">
        <Button onClick={fetchPaymentRequests} className="h-10 flex-1 bg-blue-600 hover:bg-blue-700">
          <Search className="mr-2 h-4 w-4"/>搜索
        </Button>
        <Button variant="outline" onClick={clearFilters} className="h-10 flex-1">清除</Button>
      </div>
    </div>
    
    {/* 展开/收起高级筛选按钮 */}
    <div className="mt-4 flex justify-center">
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setShowAdvanced(!showAdvanced)}
        className="text-purple-600 hover:text-purple-700 hover:bg-purple-50"
      >
        {showAdvanced ? (
          <>
            <ChevronUp className="mr-1 h-4 w-4" />
            收起高级筛选
          </>
        ) : (
          <>
            <ChevronDown className="mr-1 h-4 w-4" />
            展开高级筛选
          </>
        )}
      </Button>
    </div>
    
    {/* 高级筛选区域 */}
    {showAdvanced && (
      <div className="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {/* 申请单号筛选 */}
          <div className="space-y-2">
            <Label htmlFor="request-id" className="text-sm font-medium text-purple-800">
              申请单号
            </Label>
            <Input
              id="request-id"
              placeholder="申请单号..."
              value={filters.requestId}
              onChange={(e) => handleFilterChange('requestId', e.target.value)}
              className="h-10"
            />
          </div>
          
          {/* 运单编号筛选（批量） */}
          <div className="space-y-2">
            <Label htmlFor="waybill" className="text-sm font-medium text-purple-800 flex items-center gap-1">
              <FileText className="h-4 w-4" />
              运单编号
            </Label>
            <div className="flex gap-1">
              <Input
                id="waybill"
                placeholder="运单编号，多个用逗号分隔..."
                value={filters.waybillNumbers}
                onChange={(e) => handleFilterChange('waybillNumbers', e.target.value)}
                onKeyDown={(e) => { if (e.key === 'Enter') fetchPaymentRequests(); }}
                className="h-10 flex-1"
              />
              <Button variant="outline" size="sm" onClick={() => openBatchDialog('waybill')} className="h-10 px-2">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
            <div className="text-xs text-purple-600">
              💡 支持搜索本平台和其他平台运单号
            </div>
          </div>
          
          {/* 司机筛选（批量） */}
          <div className="space-y-2">
            <Label htmlFor="driver" className="text-sm font-medium text-purple-800 flex items-center gap-1">
              <Users className="h-4 w-4" />
              司机
            </Label>
            <div className="flex gap-1">
              <Input
                id="driver"
                placeholder="司机姓名，多个用逗号分隔..."
                value={filters.driverName}
                onChange={(e) => handleFilterChange('driverName', e.target.value)}
                className="h-10 flex-1"
              />
              <Button variant="outline" size="sm" onClick={() => openBatchDialog('driver')} className="h-10 px-2">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
          </div>
          
          {/* 车牌号筛选（批量） */}
          <div className="space-y-2">
            <Label htmlFor="license" className="text-sm font-medium text-purple-800 flex items-center gap-1">
              <Hash className="h-4 w-4" />
              车牌号
            </Label>
            <div className="flex gap-1">
              <Input
                id="license"
                placeholder="车牌号，多个用逗号分隔..."
                value={filters.licensePlate}
                onChange={(e) => handleFilterChange('licensePlate', e.target.value)}
                className="h-10 flex-1"
              />
              <Button variant="outline" size="sm" onClick={() => openBatchDialog('license')} className="h-10 px-2">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
          </div>
          
          {/* 电话筛选（批量） */}
          <div className="space-y-2">
            <Label htmlFor="phone" className="text-sm font-medium text-purple-800 flex items-center gap-1">
              <Phone className="h-4 w-4" />
              电话
            </Label>
            <div className="flex gap-1">
              <Input
                id="phone"
                placeholder="电话，多个用逗号分隔..."
                value={filters.driverPhone}
                onChange={(e) => handleFilterChange('driverPhone', e.target.value)}
                className="h-10 flex-1"
              />
              <Button variant="outline" size="sm" onClick={() => openBatchDialog('phone')} className="h-10 px-2">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
          </div>
          
          {/* 其他平台名称筛选 */}
          <div className="space-y-2">
            <Label htmlFor="platform" className="text-sm font-medium text-purple-800 flex items-center gap-1">
              <Building2 className="h-4 w-4" />
              其他平台名称
            </Label>
            <Select value={filters.otherPlatformName || 'all'} onValueChange={(v) => handleFilterChange('otherPlatformName', v === 'all' ? '' : v)}>
              <SelectTrigger id="platform" className="h-10">
                <SelectValue placeholder="选择平台" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">所有平台</SelectItem>
                <SelectItem value="本平台">本平台</SelectItem>
                <SelectItem value="中科智运">中科智运</SelectItem>
                <SelectItem value="中工智云">中工智云</SelectItem>
                <SelectItem value="可乐公司">可乐公司</SelectItem>
                <SelectItem value="盼盼集团">盼盼集团</SelectItem>
                {platformOptions.length > 0 && (
                  <>
                    <SelectItem value="---" disabled className="text-xs text-purple-400">
                      ─── 其他平台 ───
                    </SelectItem>
                    {platformOptions.map((platform) => (
                      <SelectItem key={platform.platform_name} value={platform.platform_name}>
                        {platform.platform_name} ({platform.usage_count}条)
                      </SelectItem>
                    ))}
                  </>
                )}
              </SelectContent>
            </Select>
          </div>
        </div>
      </div>
    )}
  </CardContent>
</Card>
```

---

## 📝 完整参考文件

由于代码量大，建议**直接复制PaymentRequest.tsx的筛选器部分**：

### 参考文件
`src/pages/PaymentRequest.tsx`

### 参考行数
- 图标定义：第30-42行
- 批量对话框导入：第52行
- 状态管理：第125-136行
- 批量输入处理函数：第277-304行
- 筛选器UI：第1025-1268行

### 主要修改点

| 付款申请 | 付款审核/财务付款 | 说明 |
|---------|----------------|------|
| 支付状态筛选 | 申请单状态筛选 | 字段名改为status |
| 合作方筛选 | ❌ 删除 | 不需要 |
| driverNames数组 | driverName字符串 | 已统一为字符串批量 |
| 其他相同 | 其他相同 | 完全一致 |

---

## 🎯 快速实施步骤

### 方法1：手动修改（推荐理解代码）

按照上述修改清单逐项修改

### 方法2：参考复制（快速实施）

1. 打开 `PaymentRequest.tsx`
2. 复制筛选器相关代码
3. 粘贴到 `PaymentAudit.tsx` 和 `PaymentRequestsList.tsx`
4. 修改字段名称：
   - `paymentStatus` → `status`（申请单状态）
   - 删除 `partnerId`（不需要合作方筛选）
5. 测试功能

---

## ⏱️ 时间估算

| 任务 | 时间 |
|-----|------|
| 执行SQL脚本 | 1分钟 |
| 修改PaymentAudit.tsx | 30分钟 |
| 修改PaymentRequestsList.tsx | 30分钟 |
| 测试验证 | 15分钟 |
| **总计** | **约1.5小时** |

---

## 🚨 重要提示

### 先执行SQL再修改前端

```
1. ✅ 执行SQL脚本（升级付款审核筛选器_后端函数.sql）
2. ⏳ 修改前端代码
3. ⏳ 测试功能
```

---

**SQL脚本已准备好，建议您先执行SQL，成功后我继续修改前端代码！** 🚀

