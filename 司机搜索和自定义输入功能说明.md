# 司机搜索和自定义输入功能说明

## 功能概述

为运单新增/编辑表单中的司机选择功能添加了以下增强：

### ✨ 新功能特性

1. **智能搜索**
   - 支持按司机姓名搜索
   - 支持按车牌号搜索
   - 支持按电话号码搜索
   - 实时过滤匹配结果

2. **自定义输入**
   - 如果司机不在列表中，可以快速添加新司机
   - 添加时可以同时填写：
     - 司机姓名（必填）
     - 车牌号（可选）
     - 司机电话（可选）

3. **自动填充**
   - 选择司机后自动填充车牌号
   - 选择司机后自动填充司机电话
   - 减少重复输入

4. **用户体验优化**
   - 下拉列表显示司机完整信息（姓名、车牌、电话）
   - 搜索无结果时提示添加新司机
   - 支持快捷键操作

## 实现细节

### 新增组件

#### `DriverComboInput.tsx`
复合输入组件，结合了搜索、选择和自定义输入功能：

**主要特性：**
- 基于 `Command` 组件实现搜索功能
- 使用 `Popover` 实现下拉面板
- 集成 `Dialog` 用于添加新司机
- 自动保存新司机到数据库

**使用方式：**
```tsx
<DriverComboInput
  drivers={drivers}
  value={formData.driverId}
  onChange={handleDriverSelect}
  onDriversUpdate={handleDriversUpdate}
  disabled={!formData.projectId}
  placeholder="搜索或选择司机"
/>
```

### 修改的文件

#### `LogisticsFormDialog.tsx`
1. 导入新的 `DriverComboInput` 组件
2. 更新 `handleDriverSelect` 函数，支持接收司机详细信息
3. 添加 `handleDriversUpdate` 函数，用于添加新司机后刷新列表
4. 替换原有的 `Select` 组件为 `DriverComboInput`

## 使用说明

### 搜索现有司机

1. 点击司机输入框
2. 在搜索框中输入：
   - 司机姓名
   - 车牌号
   - 电话号码
3. 从匹配结果中选择司机
4. 车牌号和电话会自动填充

### 添加新司机

**方法一：搜索无结果时添加**
1. 在搜索框输入司机姓名
2. 如果没有匹配结果，会显示"添加新司机"按钮
3. 点击按钮，自动填充姓名
4. 补充车牌号和电话（可选）
5. 点击"添加司机"保存

**方法二：主动添加**
1. 点击司机输入框
2. 点击底部的"添加自定义司机"按钮
3. 填写司机信息
4. 点击"添加司机"保存

### 编辑模式

- 编辑运单时，会显示当前司机信息卡片
- 可以搜索并更换司机
- 也可以添加新司机

## 技术栈

- **UI组件库**: Radix UI
- **命令面板**: `@/components/ui/command`
- **弹出层**: `@/components/ui/popover`
- **对话框**: `@/components/ui/dialog`
- **数据库**: Supabase
- **表单验证**: 实时验证必填字段

## 数据流

```
用户输入
  ↓
搜索过滤
  ↓
选择司机 → 自动填充车牌和电话
  ↓
提交表单

或

未找到司机
  ↓
打开添加对话框
  ↓
填写司机信息
  ↓
保存到数据库 → 刷新司机列表 → 自动选择新司机
  ↓
自动填充车牌和电话
```

## 优势

1. **减少操作步骤**
   - 搜索和选择一步完成
   - 自动填充减少重复输入

2. **提高数据准确性**
   - 复用已有司机信息，避免重复录入
   - 统一管理司机信息

3. **灵活性**
   - 支持快速添加新司机
   - 支持模糊搜索

4. **用户体验**
   - 直观的搜索界面
   - 清晰的信息展示
   - 友好的空状态提示

## 注意事项

1. **必填项验证**
   - 添加新司机时，姓名为必填项
   - 车牌号和电话为可选项

2. **数据同步**
   - 添加新司机后会自动刷新司机列表
   - 新司机会立即可用

3. **权限控制**
   - 确保用户有权限添加司机
   - 数据库需要配置正确的RLS策略

## 后续优化建议

1. **验证增强**
   - 添加车牌号格式验证
   - 添加电话号码格式验证
   - 检查司机姓名是否重复

2. **功能扩展**
   - 支持编辑司机信息
   - 支持删除司机
   - 添加司机头像上传

3. **性能优化**
   - 对大量司机数据进行分页
   - 使用虚拟滚动优化长列表
   - 添加防抖优化搜索性能

