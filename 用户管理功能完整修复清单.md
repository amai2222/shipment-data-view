# ç”¨æˆ·ç®¡ç†åŠŸèƒ½å®Œæ•´ä¿®å¤æ¸…å•

## ğŸ“‹ é—®é¢˜æ±‡æ€»

ç³»ç»Ÿä¸­æœ‰å¤šä¸ªåœ°æ–¹ä½¿ç”¨äº† `supabase.auth.admin` APIï¼Œéœ€è¦ç»Ÿä¸€ä¿®å¤ï¼š

| æ–‡ä»¶ | ä½¿ç”¨æƒ…å†µ | ä¿®å¤çŠ¶æ€ |
|------|---------|----------|
| `src/components/permissions/UserManagement.tsx` | åˆ›å»ºç”¨æˆ· | âœ… å·²ä¿®å¤ |
| `src/services/UserManagementService.ts` | åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ç”¨æˆ· | âš ï¸ éœ€ä¿®å¤ |
| `src/components/EnterpriseUserEditDialog.tsx` | æ›´æ–°ç”¨æˆ·å¯†ç å’Œé‚®ç®± | âš ï¸ éœ€ä¿®å¤ |
| `src/components/ChangePasswordDialog.tsx` | ä¿®æ”¹å¯†ç  | âš ï¸ éœ€ä¿®å¤ |
| `src/pages/mobile/MobileIntegratedUserManagement.tsx` | ä¿®æ”¹å¯†ç ï¼ˆç§»åŠ¨ç«¯ï¼‰ | âš ï¸ éœ€ä¿®å¤ |

---

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. åˆ›å»ºç”¨æˆ·åŠŸèƒ½

**æ–‡ä»¶**ï¼š`src/components/permissions/UserManagement.tsx`

**ä¿®æ”¹å†…å®¹**ï¼š
- ä»ç›´æ¥è°ƒç”¨ `supabase.auth.admin.createUser()`
- æ”¹ä¸ºè°ƒç”¨ Edge Function `create-user`

**æ–°å¢æ–‡ä»¶**ï¼š
- `supabase/functions/create-user/index.ts` - Edge Function
- `deploy-create-user-function.ps1` - éƒ¨ç½²è„šæœ¬
- `ç”¨æˆ·åˆ›å»ºåŠŸèƒ½ä¿®å¤è¯´æ˜.md` - è¯¦ç»†è¯´æ˜
- `ç”¨æˆ·åˆ›å»ºåŠŸèƒ½-å¿«é€Ÿä¿®å¤æŒ‡å—.md` - å¿«é€ŸæŒ‡å—

---

## âš ï¸ å¾…ä¿®å¤åŠŸèƒ½

ä¸ºäº†æä¾›å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œè¿˜éœ€è¦åˆ›å»ºä»¥ä¸‹ Edge Functionsï¼š

### 2. æ›´æ–°ç”¨æˆ·å¯†ç åŠŸèƒ½

**éœ€è¦åˆ›å»º**ï¼š`supabase/functions/update-user-password/index.ts`

**åŠŸèƒ½**ï¼š
- ç®¡ç†å‘˜å¯ä»¥é‡ç½®ä»»ä½•ç”¨æˆ·çš„å¯†ç 
- ç”¨æˆ·å¯ä»¥ä¿®æ”¹è‡ªå·±çš„å¯†ç 
- éªŒè¯å¯†ç å¼ºåº¦

**å½±å“çš„æ–‡ä»¶**ï¼š
- `src/components/EnterpriseUserEditDialog.tsx`
- `src/components/ChangePasswordDialog.tsx`
- `src/pages/mobile/MobileIntegratedUserManagement.tsx`
- `src/services/UserManagementService.ts`

### 3. æ›´æ–°ç”¨æˆ·ä¿¡æ¯åŠŸèƒ½

**éœ€è¦åˆ›å»º**ï¼š`supabase/functions/update-user/index.ts`

**åŠŸèƒ½**ï¼š
- æ›´æ–°ç”¨æˆ·é‚®ç®±
- æ›´æ–°ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- éªŒè¯é‚®ç®±æ ¼å¼å’Œé‡å¤

**å½±å“çš„æ–‡ä»¶**ï¼š
- `src/components/EnterpriseUserEditDialog.tsx`
- `src/services/UserManagementService.ts`

### 4. åˆ é™¤ç”¨æˆ·åŠŸèƒ½

**éœ€è¦åˆ›å»º**ï¼š`supabase/functions/delete-user/index.ts`

**åŠŸèƒ½**ï¼š
- åˆ é™¤ç”¨æˆ·è´¦å·
- è½¯åˆ é™¤ï¼ˆè®¾ç½® is_active = falseï¼‰
- ç¡¬åˆ é™¤ï¼ˆå®Œå…¨åˆ é™¤è®°å½•ï¼‰

**å½±å“çš„æ–‡ä»¶**ï¼š
- `src/services/UserManagementService.ts`

---

## ğŸš€ ä¼˜å…ˆçº§æ’åº

æ ¹æ®åŠŸèƒ½çš„é‡è¦æ€§å’Œä½¿ç”¨é¢‘ç‡ï¼š

### ğŸ”´ ç´§æ€¥ï¼ˆç«‹å³ä¿®å¤ï¼‰
1. âœ… **åˆ›å»ºç”¨æˆ·** - å·²å®Œæˆ
2. âš ï¸ **ä¿®æ”¹å¯†ç ** - é«˜é¢‘ä½¿ç”¨

### ğŸŸ¡ é‡è¦ï¼ˆå°½å¿«ä¿®å¤ï¼‰
3. âš ï¸ **æ›´æ–°ç”¨æˆ·ä¿¡æ¯** - å¸¸ç”¨åŠŸèƒ½
4. âš ï¸ **åˆ é™¤ç”¨æˆ·** - ç®¡ç†åŠŸèƒ½

---

## ğŸ“ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

åœ¨å®Œæˆæ‰€æœ‰ Edge Functions ä¹‹å‰ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹ä¸´æ—¶æ–¹æ¡ˆï¼š

### æ–¹æ¡ˆ Aï¼šé™åˆ¶åŠŸèƒ½ï¼ˆæ¨èï¼‰
æš‚æ—¶ç¦ç”¨éœ€è¦ admin API çš„åŠŸèƒ½ï¼Œç­‰ Edge Functions éƒ¨ç½²å®Œæˆåå†å¯ç”¨ã€‚

### æ–¹æ¡ˆ Bï¼šä½¿ç”¨é‚€è¯·é“¾æ¥
å¯¹äºåˆ›å»ºç”¨æˆ·ï¼Œå¯ä»¥ä½¿ç”¨ Supabase çš„ç”¨æˆ·é‚€è¯·åŠŸèƒ½ï¼š

```typescript
// å‘é€é‚€è¯·é“¾æ¥
const { data, error } = await supabase.auth.admin.inviteUserByEmail(
  'user@example.com'
);
```

ä½†è¿™ä»ç„¶éœ€è¦ Service Role Keyï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦ Edge Functionã€‚

---

## ğŸ¯ å®Œæ•´ä¿®å¤è®¡åˆ’

### é˜¶æ®µ 1ï¼šåˆ›å»ºç”¨æˆ·ï¼ˆâœ… å·²å®Œæˆï¼‰
- [x] åˆ›å»º Edge Function
- [x] ä¿®æ”¹å‰ç«¯ä»£ç 
- [x] ç¼–å†™æ–‡æ¡£å’Œè„šæœ¬
- [x] æµ‹è¯•éªŒè¯

### é˜¶æ®µ 2ï¼šä¿®æ”¹å¯†ç ï¼ˆâš ï¸ å¾…å®Œæˆï¼‰
- [ ] åˆ›å»º Edge Function
- [ ] ä¿®æ”¹ç›¸å…³ç»„ä»¶
- [ ] æµ‹è¯•éªŒè¯

### é˜¶æ®µ 3ï¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆâš ï¸ å¾…å®Œæˆï¼‰
- [ ] åˆ›å»º Edge Function
- [ ] ä¿®æ”¹ç›¸å…³ç»„ä»¶
- [ ] æµ‹è¯•éªŒè¯

### é˜¶æ®µ 4ï¼šåˆ é™¤ç”¨æˆ·ï¼ˆâš ï¸ å¾…å®Œæˆï¼‰
- [ ] åˆ›å»º Edge Function
- [ ] ä¿®æ”¹ç›¸å…³ç»„ä»¶
- [ ] æµ‹è¯•éªŒè¯

---

## ğŸ’¡ æ¶æ„æ”¹è¿›å»ºè®®

### 1. ç»Ÿä¸€ç”¨æˆ·ç®¡ç†æœåŠ¡

åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„ç”¨æˆ·ç®¡ç† Edge Functionï¼š

```
supabase/functions/user-management/index.ts
```

æ”¯æŒå¤šç§æ“ä½œï¼š
- `POST /user-management?action=create` - åˆ›å»ºç”¨æˆ·
- `PUT /user-management?action=update` - æ›´æ–°ç”¨æˆ·
- `PUT /user-management?action=password` - ä¿®æ”¹å¯†ç 
- `DELETE /user-management?action=delete` - åˆ é™¤ç”¨æˆ·

### 2. å‰ç«¯æœåŠ¡å±‚å°è£…

åœ¨ `src/services/UserManagementService.ts` ä¸­ç»Ÿä¸€å°è£…æ‰€æœ‰ç”¨æˆ·ç®¡ç†æ“ä½œï¼š

```typescript
export class UserManagementService {
  static async createUser(data) {
    return await supabase.functions.invoke('user-management', {
      body: { action: 'create', ...data }
    });
  }
  
  static async updatePassword(userId, password) {
    return await supabase.functions.invoke('user-management', {
      body: { action: 'password', userId, password }
    });
  }
  
  // ... å…¶ä»–æ–¹æ³•
}
```

### 3. æƒé™ç»Ÿä¸€ç®¡ç†

åœ¨ Edge Function ä¸­ç»Ÿä¸€å¤„ç†æƒé™éªŒè¯ï¼š

```typescript
function checkPermission(currentUser, action) {
  const permissions = {
    create: ['admin', 'system_admin'],
    update: ['admin', 'system_admin'],
    delete: ['system_admin'],
    password: ['admin', 'system_admin', 'self']
  };
  
  return permissions[action].includes(currentUser.role);
}
```

---

## ğŸ“Š å·¥ä½œé‡ä¼°ç®—

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | å¤æ‚åº¦ |
|------|----------|--------|
| ä¿®æ”¹å¯†ç  Edge Function | 2 å°æ—¶ | ä¸­ |
| æ›´æ–°ç”¨æˆ·ä¿¡æ¯ Edge Function | 2 å°æ—¶ | ä¸­ |
| åˆ é™¤ç”¨æˆ· Edge Function | 1 å°æ—¶ | ä½ |
| å‰ç«¯ä»£ç ä¿®æ”¹ | 3 å°æ—¶ | ä¸­ |
| æµ‹è¯•å’Œè°ƒè¯• | 2 å°æ—¶ | ä¸­ |
| **æ€»è®¡** | **10 å°æ—¶** | - |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆå·²å®Œæˆï¼‰
1. âœ… éƒ¨ç½² `create-user` Edge Function
2. âœ… æµ‹è¯•åˆ›å»ºç”¨æˆ·åŠŸèƒ½
3. âœ… æ›´æ–°æ–‡æ¡£

### åç»­ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
1. åˆ›å»ºå…¶ä»– Edge Functions
2. é‡æ„ç”¨æˆ·ç®¡ç†æœåŠ¡
3. å®Œå–„é”™è¯¯å¤„ç†
4. æ·»åŠ å•å…ƒæµ‹è¯•

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœä½ éœ€è¦æˆ‘ç»§ç»­å®Œæˆå…¶ä»– Edge Functions çš„å¼€å‘ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼š

1. **ä¿®æ”¹å¯†ç åŠŸèƒ½** - è®©æˆ‘åˆ›å»º `update-user-password` Edge Function
2. **æ›´æ–°ç”¨æˆ·ä¿¡æ¯åŠŸèƒ½** - è®©æˆ‘åˆ›å»º `update-user` Edge Function
3. **åˆ é™¤ç”¨æˆ·åŠŸèƒ½** - è®©æˆ‘åˆ›å»º `delete-user` Edge Function
4. **ç»Ÿä¸€ç”¨æˆ·ç®¡ç†æœåŠ¡** - è®©æˆ‘åˆ›å»ºç»Ÿä¸€çš„ `user-management` Edge Function

---

## âœ¨ æ€»ç»“

ç›®å‰å·²å®Œæˆ**åˆ›å»ºç”¨æˆ·**åŠŸèƒ½çš„ä¿®å¤ï¼Œè¿™æ˜¯æœ€ç´§æ€¥å’Œæœ€å¸¸ç”¨çš„åŠŸèƒ½ã€‚

å…¶ä»–åŠŸèƒ½ï¼š
- å¦‚æœæš‚æ—¶ä¸ç”¨ï¼Œå¯ä»¥å…ˆç¦ç”¨
- å¦‚æœéœ€è¦ä½¿ç”¨ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šç«‹å³åˆ›å»ºå¯¹åº”çš„ Edge Functions

**å½“å‰çŠ¶æ€**ï¼šâœ… å¯ä»¥æ­£å¸¸åˆ›å»ºæ–°ç”¨æˆ·äº†ï¼

éœ€è¦ç»§ç»­ä¿®å¤å…¶ä»–åŠŸèƒ½å—ï¼ŸğŸ˜Š

