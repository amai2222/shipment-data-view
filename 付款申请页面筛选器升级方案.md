# 付款申请页面筛选器升级方案

## 📋 需求分析

### 当前状态（PaymentRequest.tsx）

**筛选项**：
1. 项目
2. 日期范围
3. 合作方
4. 司机（支持批量输入）
5. 支付状态

**布局**：简单的5列网格，所有筛选项展示在一行

---

### 参考对象（FilterBar.tsx - 运单管理）

**筛选项**：
1. 项目
2. 日期范围
3. **高级筛选**（可展开/收起）：
   - 司机（支持批量输入）
   - 车牌号（支持批量输入）
   - 电话（支持批量输入）
   - 运单编号（支持批量输入）
   - **其他平台名称**（固定+动态，从数据库获取）
   - 磅单状态

**布局**：
- 常规筛选：项目 + 日期 + 搜索按钮
- 高级筛选：展开后显示所有其他筛选项
- 有明显的展开/收起按钮

---

## 🎯 升级方案

### 设计原则

> **常规筛选保留支付状态，其他筛选和运单管理一样**

1. **常规筛选区域**（始终可见）
   - 项目
   - 日期范围
   - **支付状态**（付款申请特有，必须保留）
   - 搜索/清除按钮
   - 展开高级筛选按钮

2. **高级筛选区域**（可展开/收起）
   - 合作方
   - 司机（支持批量输入）
   - 车牌号（支持批量输入）
   - 电话（支持批量输入）
   - 运单编号（支持批量输入）
   - 其他平台名称（动态加载）

---

## 📝 详细设计

### 1. 数据结构修改

#### FinanceFilters 接口扩展

**修改前**：
```typescript
interface FinanceFilters {
  projectId: string;
  partnerId: string;
  startDate: string;
  endDate: string;
  paymentStatus: string;
  driverNames: string[];
}
```

**修改后**：
```typescript
interface FinanceFilters {
  // 常规筛选
  projectId: string;
  startDate: string;
  endDate: string;
  paymentStatus: string; // 保留在常规筛选
  
  // 高级筛选
  partnerId: string;
  driverNames: string[];
  licensePlate: string;        // 新增：车牌号
  driverPhone: string;          // 新增：电话
  waybillNumbers: string;       // 新增：运单编号
  otherPlatformName: string;    // 新增：其他平台名称
}
```

---

### 2. UI布局设计

#### 常规筛选区域（始终可见）

```
┌─────────────────────────────────────────────────────────────────┐
│ 🏢 项目    │ 📅 日期范围    │ 💳 支付状态    │ 🔍 搜索  清除   │
│                                                    ▼ 展开高级筛选 │
└─────────────────────────────────────────────────────────────────┘
```

#### 高级筛选区域（展开后显示）

```
┌─────────────────────────────────────────────────────────────────┐
│ ─── 高级筛选 ───                                      ▲ 收起筛选 │
├─────────────────────────────────────────────────────────────────┤
│ 👥 合作方    │ 👤 司机 [+]   │ # 车牌号 [+]  │ 📞 电话 [+]     │
│ 📄 运单号 [+]│ 🏢 平台名称   │                │                 │
└─────────────────────────────────────────────────────────────────┘
```

**[+]** 表示支持批量输入按钮

---

### 3. 功能特性

#### ✅ 保留功能
- 项目筛选
- 日期范围筛选
- **支付状态筛选**（在常规筛选区域）
- 司机批量输入
- 搜索/清除功能

#### 🆕 新增功能
1. **高级筛选展开/收起**
   - 默认收起，节省空间
   - 展开后显示所有高级筛选项

2. **车牌号筛选**
   - 支持单个输入
   - 支持批量输入（用逗号分隔）

3. **电话筛选**
   - 支持单个输入
   - 支持批量输入（用逗号分隔）

4. **运单编号筛选**
   - 支持单个输入
   - 支持批量输入（用逗号分隔）
   - 同时搜索本平台和其他平台运单号

5. **其他平台名称筛选**
   - 固定平台：本平台、中科智运、中工智云、可乐公司、盼盼集团
   - 动态平台：从数据库自动获取
   - 显示使用次数

---

### 4. 后端修改需求

#### SQL函数需要修改

**当前函数**：`get_payment_request_data`

**需要添加的参数**：
```sql
p_license_plate TEXT DEFAULT NULL,
p_driver_phone TEXT DEFAULT NULL,
p_waybill_numbers TEXT DEFAULT NULL,
p_other_platform_name TEXT DEFAULT NULL
```

**筛选逻辑**：
```sql
-- 车牌号筛选
AND (p_license_plate IS NULL OR lr.license_plate ILIKE '%' || p_license_plate || '%')

-- 电话筛选
AND (p_driver_phone IS NULL OR lr.driver_phone ILIKE '%' || p_driver_phone || '%')

-- 运单编号筛选（同时搜索本平台和其他平台）
AND (p_waybill_numbers IS NULL OR 
     lr.auto_number = ANY(v_waybill_array) OR
     (lr.external_tracking_numbers IS NOT NULL AND 
      lr.external_tracking_numbers && v_waybill_array))

-- 其他平台名称筛选
AND (p_other_platform_name IS NULL OR 
     CASE 
         WHEN p_other_platform_name = '本平台' THEN 
             (lr.other_platform_names IS NULL OR array_length(lr.other_platform_names, 1) IS NULL)
         ELSE 
             EXISTS (SELECT 1 FROM unnest(lr.other_platform_names) AS platform_name 
                    WHERE platform_name ILIKE '%' || p_other_platform_name || '%')
     END)
```

---

## 🚀 实施步骤

### 第一步：修改前端数据结构

1. 扩展 `FinanceFilters` 接口
2. 更新 `INITIAL_FINANCE_FILTERS` 常量
3. 添加状态管理：
   - `showAdvanced`：控制高级筛选展开/收起
   - `platformOptions`：动态平台列表

### 第二步：修改UI布局

1. 重构筛选器为两部分：
   - 常规筛选区域
   - 高级筛选区域（可折叠）

2. 添加批量输入对话框

3. 添加动态平台加载逻辑

### 第三步：修改后端调用

1. 更新 `fetchReportData` 函数调用参数
2. 添加新的筛选参数传递

### 第四步：修改SQL函数

1. 修改 `get_payment_request_data` 函数签名
2. 添加新的筛选逻辑
3. 同步修改跨页全选函数 `get_filtered_unpaid_ids`

---

## 📊 界面对比

### 修改前（当前）

```
┌──────────────────────────────────────────────────────────┐
│ 项目 │ 日期 │ 合作方 │ 司机 │ 支付状态 │ 搜索 清除       │
└──────────────────────────────────────────────────────────┘
```

### 修改后（新设计）

**默认状态（收起）**：
```
┌──────────────────────────────────────────────────────────┐
│ 🏢 项目 │ 📅 日期范围 │ 💳 支付状态 │ 🔍 搜索  清除    │
│                                          ▼ 展开高级筛选   │
└──────────────────────────────────────────────────────────┘
```

**展开状态**：
```
┌──────────────────────────────────────────────────────────┐
│ 🏢 项目 │ 📅 日期范围 │ 💳 支付状态 │ 🔍 搜索  清除    │
│                                          ▲ 收起高级筛选   │
├──────────────────────────────────────────────────────────┤
│ ─── 高级筛选 ───                                        │
│ 👥 合作方    │ 👤 司机 [+]   │ # 车牌号 [+]           │
│ 📞 电话 [+]  │ 📄 运单号 [+] │ 🏢 平台名称             │
└──────────────────────────────────────────────────────────┘
```

---

## 🎨 设计细节

### 1. 颜色和样式

参考 FilterBar.tsx：
- 使用紫色主题（purple）
- 高级筛选区域背景：`from-purple-50 to-pink-50`
- 边框颜色：`border-purple-200`

### 2. 图标使用

- 🏢 Building2 - 项目/平台
- 📅 Calendar - 日期
- 💳 CreditCard - 支付状态
- 👥 Users - 司机/合作方
- # Hash - 车牌号
- 📞 Phone - 电话
- 📄 FileText - 运单号
- 🔍 Search - 搜索
- ▼/▲ ChevronDown/ChevronUp - 展开/收起

### 3. 交互体验

- 高级筛选默认收起，节省空间
- 展开/收起有平滑动画
- 批量输入按钮用 [+] 图标表示
- 支付状态保持在常规筛选，便于快速切换

---

## ⚠️ 注意事项

### 1. 兼容性考虑

- 保持现有筛选功能100%兼容
- 新增筛选项不影响现有业务逻辑

### 2. 性能考虑

- 高级筛选展开/收起只影响UI，不触发数据查询
- 动态平台列表只加载一次（组件初始化时）

### 3. 用户体验

- 支付状态筛选保持在显眼位置（常规筛选区域）
- 常用筛选项在常规区域，高级功能在高级区域
- 搜索按钮始终可见

---

## 📁 涉及的文件

| 文件 | 修改内容 | 预计代码量 |
|-----|---------|-----------|
| `src/pages/PaymentRequest.tsx` | 扩展筛选器UI和逻辑 | +200行 |
| `supabase/migrations/xxx_enhance_payment_request_filters.sql` | 修改SQL函数 | +100行 |
| `scripts/xxx_enhance_payment_request_filters.sql` | SQL脚本备份 | +100行 |

---

## 🧪 测试清单

- [ ] 常规筛选功能正常
- [ ] 高级筛选展开/收起正常
- [ ] 支付状态筛选保持在常规区域
- [ ] 车牌号筛选功能正常
- [ ] 电话筛选功能正常
- [ ] 运单号筛选功能正常（支持其他平台运单号）
- [ ] 其他平台名称筛选功能正常
- [ ] 批量输入功能正常
- [ ] 所有筛选组合测试
- [ ] 清除功能正常
- [ ] 跨页全选功能正常

---

## 🎯 预期效果

### 用户体验提升

1. **更强大的筛选能力**
   - 支持多维度筛选
   - 批量输入提高效率

2. **更好的界面布局**
   - 常规筛选简洁明了
   - 高级功能按需展开

3. **功能一致性**
   - 与运单管理筛选器保持一致
   - 降低学习成本

---

## 📝 开发估时

| 阶段 | 预计时间 |
|-----|---------|
| 前端UI重构 | 2小时 |
| 后端SQL函数修改 | 1小时 |
| 集成测试 | 1小时 |
| **总计** | **4小时** |

---

**准备好开始实施吗？**

如果同意此方案，我将立即开始：
1. 修改前端代码
2. 创建SQL修改脚本
3. 完整测试
4. 生成详细文档

**请确认是否执行此方案？** 🚀

