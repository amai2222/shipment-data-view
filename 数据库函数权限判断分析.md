# æ•°æ®åº“å‡½æ•°æƒé™åˆ¤æ–­åˆ†æ

> **æ£€æŸ¥èŒƒå›´**: æ‰€æœ‰ SQL å‡½æ•°ï¼ˆRPC å‡½æ•°ï¼‰å’Œ RLS ç­–ç•¥  
> **å‘ç°**: **28ä¸ªæ–‡ä»¶ä¸­æœ‰90å¤„ç¡¬ç¼–ç è§’è‰²åˆ¤æ–­** âš ï¸

---

## ğŸ” å‘ç°çš„ç¡¬ç¼–ç åˆ¤æ–­

### 1. æƒé™æ£€æŸ¥è¾…åŠ©å‡½æ•° âš ï¸

#### `is_finance_operator_or_admin()`
**ä½ç½®**: `20251025_fix_modify_chain_with_recalculation.sql`

```sql
CREATE OR REPLACE FUNCTION public.is_finance_operator_or_admin()
RETURNS BOOLEAN AS $$
DECLARE
    user_role TEXT;
BEGIN
    SELECT role::text INTO user_role
    FROM public.profiles
    WHERE id = auth.uid();
    
    -- âŒ ç¡¬ç¼–ç ï¼šåªæœ‰è¿™ä¸‰ä¸ªè§’è‰²
    RETURN user_role IN ('admin', 'finance', 'operator');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**ä½¿ç”¨ä½ç½®ï¼š**
- `modify_logistics_record_chain_with_recalc()` - ä¿®æ”¹åˆä½œé“¾è·¯
- `get_project_available_chains()` - è·å–é¡¹ç›®åˆä½œé“¾è·¯
- `validate_chain_modification_permission()` - éªŒè¯é“¾è·¯ä¿®æ”¹æƒé™

**é—®é¢˜ï¼š**
- âŒ å³ä½¿ç»™ business é…ç½®äº†"ä¿®æ”¹åˆä½œé“¾è·¯"æƒé™ï¼Œå‡½æ•°ä¹Ÿä¼šæ‹’ç»
- âŒ æ— æ³•çµæ´»é…ç½®

---

### 2. æ•°æ®è®¿é—®æƒé™å‡½æ•° âš ï¸

#### `can_view_partner()`
**ä½ç½®**: `20250122_update_hierarchy_to_owner_only.sql`, `20250121_add_partner_unlimited_hierarchy.sql`

```sql
CREATE OR REPLACE FUNCTION public.can_view_partner(target_partner_id UUID)
RETURNS BOOLEAN AS $$
DECLARE
  current_user_role TEXT;
BEGIN
  -- è·å–å½“å‰ç”¨æˆ·è§’è‰²
  SELECT role INTO current_user_role
  FROM public.profiles
  WHERE id = current_user_id;
  
  -- âŒ ç¡¬ç¼–ç ï¼šç®¡ç†å‘˜å’Œè´¢åŠ¡å¯ä»¥æŸ¥çœ‹æ‰€æœ‰
  IF current_user_role IN ('admin', 'finance') THEN
    RETURN TRUE;
  END IF;
  
  -- ... å…¶ä»–é€»è¾‘
END;
$$;
```

**é—®é¢˜ï¼š**
- âŒ admin å’Œ finance ç¡¬ç¼–ç å¯æŸ¥çœ‹æ‰€æœ‰åˆä½œæ–¹
- âŒ å³ä½¿å…¶ä»–è§’è‰²æœ‰æ•°æ®æƒé™é…ç½®ï¼Œä¹Ÿæ— æ³•æŸ¥çœ‹

---

### 3. RLS ç­–ç•¥ä¸­çš„ç¡¬ç¼–ç  âš ï¸

#### `logistics_records` è¡¨çš„ RLS ç­–ç•¥
**ä½ç½®**: `20250122_fix_view_rls_policies.sql`

```sql
CREATE POLICY "logistics_records_select_policy"
ON public.logistics_records
FOR SELECT
TO authenticated
USING (
    -- âŒ ç¡¬ç¼–ç ï¼šç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰æ•°æ®
    public.is_admin()  -- è¿™ä¸ªå‡½æ•°éœ€è¦æŸ¥æ‰¾å®šä¹‰
    OR
    -- ç”¨æˆ·å¯ä»¥çœ‹åˆ°è‡ªå·±æœ‰æƒé™çš„é¡¹ç›®çš„è¿å•
    project_id IN (
        SELECT project_id 
        FROM public.user_projects 
        WHERE user_id = auth.uid()
    )
);
```

**é—®é¢˜ï¼š**
- âŒ `is_admin()` å‡½æ•°å¯èƒ½æ˜¯ç¡¬ç¼–ç çš„
- âŒ å³ä½¿æœ‰æƒé™é…ç½®ï¼ŒRLSä¹Ÿä¼šä¼˜å…ˆæ£€æŸ¥è§’è‰²

---

#### `projects` è¡¨çš„ RLS ç­–ç•¥
**ä½ç½®**: `20251028_fix_projects_rls_for_mobile.sql`

```sql
CREATE POLICY "projects_select_policy" ON public.projects
FOR SELECT
USING (
    -- âŒ ç¡¬ç¼–ç ï¼šç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰é¡¹ç›®
    (
        EXISTS (
            SELECT 1 FROM public.profiles 
            WHERE id = auth.uid() AND role = 'admin'
        )
    )
    OR
    -- âŒ ç¡¬ç¼–ç ï¼šè´¢åŠ¡å¯ä»¥çœ‹åˆ°æ‰€æœ‰é¡¹ç›®
    (
        EXISTS (
            SELECT 1 FROM public.profiles 
            WHERE id = auth.uid() AND role = 'finance'
        )
    )
    OR
    -- ç”¨æˆ·å¯ä»¥çœ‹åˆ°è‡ªå·±æœ‰æƒé™çš„é¡¹ç›®
    id IN (
        SELECT project_id 
        FROM public.user_projects 
        WHERE user_id = auth.uid()
    )
);
```

**é—®é¢˜ï¼š**
- âŒ admin å’Œ finance ç¡¬ç¼–ç å¯ä»¥æŸ¥çœ‹æ‰€æœ‰é¡¹ç›®
- âŒ æ— æ³•é€šè¿‡æƒé™ç³»ç»Ÿæ§åˆ¶

---

### 4. è§¦å‘å™¨ä¸­çš„ç¡¬ç¼–ç  âš ï¸

#### `prevent_admin_permission_reduction()` è§¦å‘å™¨
**ä½ç½®**: `20251101_smart_admin_permissions.sql`

```sql
CREATE OR REPLACE FUNCTION public.prevent_admin_permission_reduction()
RETURNS TRIGGER
AS $$
BEGIN
    -- âŒ åªæ£€æŸ¥ admin è§’è‰²
    IF NEW.role = 'admin' THEN
        -- é˜²æ­¢å‡å°‘æƒé™
    END IF;
END;
$$;
```

**è¿™ä¸ªå¯èƒ½æ˜¯åˆç†çš„**ï¼Œå› ä¸ºæ˜¯ä¸“é—¨ä¿æŠ¤ admin è§’è‰²çš„ã€‚

---

## ğŸ“Š å½±å“åˆ†æ

### ç»Ÿè®¡

| ç±»å‹ | æ•°é‡ | ä¸¥é‡ç¨‹åº¦ |
|------|------|---------|
| **æƒé™æ£€æŸ¥å‡½æ•°** | 1ä¸ªå‡½æ•°ï¼ˆå¤šå¤„ä½¿ç”¨ï¼‰ | âš ï¸ é«˜ |
| **æ•°æ®è®¿é—®å‡½æ•°** | 1ä¸ªå‡½æ•°ï¼ˆå¤šå¤„ä½¿ç”¨ï¼‰ | âš ï¸ é«˜ |
| **RLSç­–ç•¥** | å¤šå¤„ | âš ï¸ éå¸¸é«˜ |
| **è§¦å‘å™¨** | 1ä¸ªï¼ˆå¯èƒ½æ˜¯åˆç†çš„ï¼‰ | âœ… ä½ |

---

### å®é™…å½±å“åœºæ™¯

#### åœºæ™¯1ï¼šç»™ business é…ç½®"ä¿®æ”¹åˆä½œé“¾è·¯"æƒé™

```
å‰ç«¯ï¼š
  âœ… æ˜¾ç¤º"ä¿®æ”¹é“¾è·¯"æŒ‰é’®ï¼ˆå› ä¸ºæƒé™ç³»ç»Ÿå…è®¸ï¼‰

ç”¨æˆ·ç‚¹å‡»ï¼š
  â†“
åç«¯å‡½æ•°è°ƒç”¨ï¼š
  modify_logistics_record_chain_with_recalc()
  â†“
æƒé™æ£€æŸ¥ï¼š
  is_finance_operator_or_admin()
  â†“
  business ä¸åœ¨ ('admin', 'finance', 'operator') ä¸­
  âŒ è¿”å›é”™è¯¯ï¼š"æƒé™ä¸è¶³ï¼šåªæœ‰è´¢åŠ¡ã€æ“ä½œå‘˜å’Œç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹åˆä½œé“¾è·¯"
```

**ç»“æœï¼š**
- âš ï¸ å‰ç«¯å¯ä»¥é…ç½®ï¼Œä½†åç«¯å‡½æ•°ä¼šæ‹’ç»
- âš ï¸ ç”¨æˆ·ä½“éªŒä¸ä¸€è‡´

---

#### åœºæ™¯2ï¼šç»™ operator é…ç½®"æŸ¥çœ‹æ‰€æœ‰é¡¹ç›®"æƒé™

```
å‰ç«¯ï¼š
  âœ… æ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®ï¼ˆå› ä¸ºæƒé™ç³»ç»Ÿå…è®¸ï¼‰

ç”¨æˆ·è®¿é—®é¡¹ç›®æ•°æ®ï¼š
  â†“
RLSç­–ç•¥æ£€æŸ¥ï¼š
  projects_select_policy
  â†“
  æ£€æŸ¥ role = 'admin' OR role = 'finance'
  â†“
  operator ä¸æ˜¯ admin ä¹Ÿä¸æ˜¯ finance
  âŒ åªèƒ½çœ‹åˆ°è‡ªå·±æœ‰æƒé™çš„é¡¹ç›®
```

**ç»“æœï¼š**
- âš ï¸ å³ä½¿é…ç½®äº†æƒé™ï¼ŒRLSä¹Ÿä¼šé™åˆ¶
- âš ï¸ æ•°æ®è®¿é—®å—é™

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: åˆ›å»ºç»Ÿä¸€çš„æƒé™æ£€æŸ¥å‡½æ•° â­ï¼ˆæ¨èï¼‰

**åˆ›å»ºä¸€ä¸ªé€šç”¨çš„æƒé™æ£€æŸ¥å‡½æ•°ï¼ŒæŸ¥è¯¢æƒé™è¡¨ï¼š**

```sql
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰èœå•æƒé™
CREATE OR REPLACE FUNCTION public.has_menu_permission(p_menu_key TEXT)
RETURNS BOOLEAN AS $$
DECLARE
    v_user_id UUID;
    v_user_role TEXT;
    v_has_permission BOOLEAN := FALSE;
BEGIN
    v_user_id := auth.uid();
    
    IF v_user_id IS NULL THEN
        RETURN FALSE;
    END IF;
    
    -- è·å–ç”¨æˆ·è§’è‰²
    SELECT role INTO v_user_role
    FROM public.profiles
    WHERE id = v_user_id;
    
    -- admin è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼ˆä¿æŒå…¼å®¹ï¼‰
    IF v_user_role = 'admin' THEN
        RETURN TRUE;
    END IF;
    
    -- æ£€æŸ¥ç”¨æˆ·è‡ªå®šä¹‰æƒé™
    SELECT EXISTS (
        SELECT 1
        FROM public.user_permissions
        WHERE user_id = v_user_id
          AND project_id IS NULL
          AND p_menu_key = ANY(menu_permissions)
    ) INTO v_has_permission;
    
    IF v_has_permission THEN
        RETURN TRUE;
    END IF;
    
    -- æ£€æŸ¥è§’è‰²æ¨¡æ¿æƒé™
    SELECT EXISTS (
        SELECT 1
        FROM public.role_permission_templates
        WHERE role = v_user_role
          AND p_menu_key = ANY(menu_permissions)
    ) INTO v_has_permission;
    
    RETURN v_has_permission;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰åŠŸèƒ½æƒé™
CREATE OR REPLACE FUNCTION public.has_function_permission(p_function_key TEXT)
RETURNS BOOLEAN AS $$
-- ç±»ä¼¼ä¸Šé¢çš„é€»è¾‘ï¼Œä½†æ£€æŸ¥ function_permissions
END;
$$;

-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ•°æ®æƒé™
CREATE OR REPLACE FUNCTION public.has_data_permission(p_data_scope TEXT)
RETURNS BOOLEAN AS $$
-- ç±»ä¼¼ä¸Šé¢çš„é€»è¾‘ï¼Œä½†æ£€æŸ¥ data_permissions
END;
$$;
```

---

### æ–¹æ¡ˆ B: ä¿®æ”¹ç°æœ‰å‡½æ•°ä½¿ç”¨æƒé™ç³»ç»Ÿ

#### ä¿®æ”¹ `is_finance_operator_or_admin()`

```sql
-- ä¹‹å‰ï¼ˆç¡¬ç¼–ç ï¼‰
RETURN user_role IN ('admin', 'finance', 'operator');

-- æ”¹ä¸ºï¼ˆæƒé™åˆ¤æ–­ï¼‰
RETURN (
    -- admin è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™
    v_user_role = 'admin'
    OR
    -- æ£€æŸ¥æ˜¯å¦æœ‰"ä¿®æ”¹åˆä½œé“¾è·¯"æƒé™
    public.has_function_permission('logistics.modify_chain')
);
```

---

#### ä¿®æ”¹ `can_view_partner()`

```sql
-- ä¹‹å‰ï¼ˆç¡¬ç¼–ç ï¼‰
IF current_user_role IN ('admin', 'finance') THEN
    RETURN TRUE;
END IF;

-- æ”¹ä¸ºï¼ˆæƒé™åˆ¤æ–­ï¼‰
IF current_user_role = 'admin' THEN
    RETURN TRUE;  -- admin ä¿æŒæŸ¥çœ‹æ‰€æœ‰
END IF;

IF public.has_data_permission('partner.view_all') THEN
    RETURN TRUE;  -- æœ‰æƒé™é…ç½®æ—¶å¯ä»¥æŸ¥çœ‹æ‰€æœ‰
END IF;
```

---

#### ä¿®æ”¹ RLS ç­–ç•¥

```sql
-- ä¹‹å‰ï¼ˆç¡¬ç¼–ç ï¼‰
WHERE id = auth.uid() AND role = 'admin'

-- æ”¹ä¸ºï¼ˆæƒé™åˆ¤æ–­ï¼‰
WHERE id = auth.uid() 
  AND (
    role = 'admin'  -- admin ä¿æŒæŸ¥çœ‹æ‰€æœ‰
    OR EXISTS (
        SELECT 1 FROM public.user_permissions
        WHERE user_id = auth.uid()
          AND project_id IS NULL
          AND 'project.view_all' = ANY(data_permissions)
    )
    OR EXISTS (
        SELECT 1 FROM public.role_permission_templates
        WHERE role = (SELECT role FROM public.profiles WHERE id = auth.uid())
          AND 'project.view_all' = ANY(data_permissions)
    )
  )
```

**âš ï¸ æ³¨æ„ï¼šRLS ç­–ç•¥ä¸­æŸ¥è¯¢æ€§èƒ½å¾ˆé‡è¦ï¼Œéœ€è¦ä¼˜åŒ–ï¼**

---

## âš ï¸ æ€§èƒ½è€ƒè™‘

### é—®é¢˜

**æƒé™æ£€æŸ¥å‡½æ•°åœ¨ RLS ç­–ç•¥ä¸­ä½¿ç”¨ï¼š**

```sql
-- æ¯ä¸ªæŸ¥è¯¢éƒ½ä¼šæ‰§è¡Œ
USING (
    public.has_menu_permission('project.view_all')
)
```

**æ€§èƒ½å½±å“ï¼š**
- âš ï¸ æ¯æ¬¡æŸ¥è¯¢éƒ½è¦æ‰§è¡Œæƒé™æ£€æŸ¥å‡½æ•°
- âš ï¸ æƒé™æ£€æŸ¥å‡½æ•°å†…éƒ¨è¿˜è¦æŸ¥è¯¢å¤šä¸ªè¡¨
- âš ï¸ å¯èƒ½å¯¼è‡´æŸ¥è¯¢å˜æ…¢

### ä¼˜åŒ–æ–¹æ¡ˆ

1. **ç¼“å­˜æƒé™åˆ° session å˜é‡**
2. **ä½¿ç”¨ç‰©åŒ–è§†å›¾å­˜å‚¨æƒé™**
3. **åœ¨ Edge Function ä¸­æ£€æŸ¥æƒé™ï¼Œè€Œä¸æ˜¯ RLS**

---

## ğŸ“‹ éœ€è¦ä¿®æ”¹çš„å‡½æ•°åˆ—è¡¨

### é«˜ä¼˜å…ˆçº§ âš ï¸

1. **`is_finance_operator_or_admin()`**
   - ä½¿ç”¨ä½ç½®ï¼š3ä¸ªå‡½æ•°
   - å½±å“ï¼šåˆä½œé“¾è·¯ä¿®æ”¹ã€æŸ¥çœ‹

2. **`can_view_partner()`**
   - ä½¿ç”¨ä½ç½®ï¼šå¤šå¤„
   - å½±å“ï¼šåˆä½œæ–¹æ•°æ®è®¿é—®

3. **RLS ç­–ç•¥ä¸­çš„ç¡¬ç¼–ç **
   - `projects` è¡¨
   - `logistics_records` è¡¨
   - å…¶ä»–è¡¨çš„ç­–ç•¥

### ä½ä¼˜å…ˆçº§ âœ…

1. **`prevent_admin_permission_reduction()`**
   - ä¸“é—¨ä¿æŠ¤ adminï¼Œå¯ä»¥ä¿æŒç°çŠ¶

---

## âœ… å»ºè®®

### çŸ­æœŸæ–¹æ¡ˆï¼ˆæ¨èï¼‰â­

1. **åˆ›å»ºç»Ÿä¸€æƒé™æ£€æŸ¥å‡½æ•°**
   - `has_menu_permission()`
   - `has_function_permission()`
   - `has_data_permission()`

2. **é€æ­¥æ›¿æ¢ç¡¬ç¼–ç **
   - å…ˆæ›¿æ¢å…³é”®å‡½æ•°ï¼ˆåˆä½œé“¾è·¯ã€æ•°æ®è®¿é—®ï¼‰
   - å†æ›¿æ¢ RLS ç­–ç•¥ï¼ˆæ³¨æ„æ€§èƒ½ï¼‰

3. **ä¿æŒ admin å…¼å®¹**
   - admin è§’è‰²ä»ç„¶è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™
   - ç¡®ä¿å‘åå…¼å®¹

### é•¿æœŸæ–¹æ¡ˆ

1. **å®Œå…¨ä½¿ç”¨æƒé™ç³»ç»Ÿ**
   - æ‰€æœ‰è§’è‰²éƒ½é€šè¿‡æƒé™è¡¨åˆ¤æ–­
   - admin ä¹Ÿåªæ˜¯æœ‰å®Œæ•´æƒé™é…ç½®

2. **æ€§èƒ½ä¼˜åŒ–**
   - ç¼“å­˜æƒé™ç»“æœ
   - ä¼˜åŒ–æŸ¥è¯¢è·¯å¾„

---

## ğŸ“ ä¸‹ä¸€æ­¥

1. âœ… åˆ›å»ºç»Ÿä¸€æƒé™æ£€æŸ¥å‡½æ•°
2. âœ… ä¿®æ”¹ `is_finance_operator_or_admin()` 
3. âœ… ä¿®æ”¹ `can_view_partner()`
4. âœ… ä¿®æ”¹å…³é”® RLS ç­–ç•¥
5. âœ… æµ‹è¯•æ€§èƒ½å½±å“

---

**æ•°æ®åº“å‡½æ•°ç¡¬ç¼–ç ï¼šéœ€è¦æ”¹é€ ï¼** âš ï¸ğŸ”§

