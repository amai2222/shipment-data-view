# 数据库函数权限判断分析

> **检查范围**: 所有 SQL 函数（RPC 函数）和 RLS 策略  
> **发现**: **28个文件中有90处硬编码角色判断** ⚠️

---

## 🔍 发现的硬编码判断

### 1. 权限检查辅助函数 ⚠️

#### `is_finance_operator_or_admin()`
**位置**: `20251025_fix_modify_chain_with_recalculation.sql`

```sql
CREATE OR REPLACE FUNCTION public.is_finance_operator_or_admin()
RETURNS BOOLEAN AS $$
DECLARE
    user_role TEXT;
BEGIN
    SELECT role::text INTO user_role
    FROM public.profiles
    WHERE id = auth.uid();
    
    -- ❌ 硬编码：只有这三个角色
    RETURN user_role IN ('admin', 'finance', 'operator');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**使用位置：**
- `modify_logistics_record_chain_with_recalc()` - 修改合作链路
- `get_project_available_chains()` - 获取项目合作链路
- `validate_chain_modification_permission()` - 验证链路修改权限

**问题：**
- ❌ 即使给 business 配置了"修改合作链路"权限，函数也会拒绝
- ❌ 无法灵活配置

---

### 2. 数据访问权限函数 ⚠️

#### `can_view_partner()`
**位置**: `20250122_update_hierarchy_to_owner_only.sql`, `20250121_add_partner_unlimited_hierarchy.sql`

```sql
CREATE OR REPLACE FUNCTION public.can_view_partner(target_partner_id UUID)
RETURNS BOOLEAN AS $$
DECLARE
  current_user_role TEXT;
BEGIN
  -- 获取当前用户角色
  SELECT role INTO current_user_role
  FROM public.profiles
  WHERE id = current_user_id;
  
  -- ❌ 硬编码：管理员和财务可以查看所有
  IF current_user_role IN ('admin', 'finance') THEN
    RETURN TRUE;
  END IF;
  
  -- ... 其他逻辑
END;
$$;
```

**问题：**
- ❌ admin 和 finance 硬编码可查看所有合作方
- ❌ 即使其他角色有数据权限配置，也无法查看

---

### 3. RLS 策略中的硬编码 ⚠️

#### `logistics_records` 表的 RLS 策略
**位置**: `20250122_fix_view_rls_policies.sql`

```sql
CREATE POLICY "logistics_records_select_policy"
ON public.logistics_records
FOR SELECT
TO authenticated
USING (
    -- ❌ 硬编码：管理员可以看到所有数据
    public.is_admin()  -- 这个函数需要查找定义
    OR
    -- 用户可以看到自己有权限的项目的运单
    project_id IN (
        SELECT project_id 
        FROM public.user_projects 
        WHERE user_id = auth.uid()
    )
);
```

**问题：**
- ❌ `is_admin()` 函数可能是硬编码的
- ❌ 即使有权限配置，RLS也会优先检查角色

---

#### `projects` 表的 RLS 策略
**位置**: `20251028_fix_projects_rls_for_mobile.sql`

```sql
CREATE POLICY "projects_select_policy" ON public.projects
FOR SELECT
USING (
    -- ❌ 硬编码：管理员可以看到所有项目
    (
        EXISTS (
            SELECT 1 FROM public.profiles 
            WHERE id = auth.uid() AND role = 'admin'
        )
    )
    OR
    -- ❌ 硬编码：财务可以看到所有项目
    (
        EXISTS (
            SELECT 1 FROM public.profiles 
            WHERE id = auth.uid() AND role = 'finance'
        )
    )
    OR
    -- 用户可以看到自己有权限的项目
    id IN (
        SELECT project_id 
        FROM public.user_projects 
        WHERE user_id = auth.uid()
    )
);
```

**问题：**
- ❌ admin 和 finance 硬编码可以查看所有项目
- ❌ 无法通过权限系统控制

---

### 4. 触发器中的硬编码 ⚠️

#### `prevent_admin_permission_reduction()` 触发器
**位置**: `20251101_smart_admin_permissions.sql`

```sql
CREATE OR REPLACE FUNCTION public.prevent_admin_permission_reduction()
RETURNS TRIGGER
AS $$
BEGIN
    -- ❌ 只检查 admin 角色
    IF NEW.role = 'admin' THEN
        -- 防止减少权限
    END IF;
END;
$$;
```

**这个可能是合理的**，因为是专门保护 admin 角色的。

---

## 📊 影响分析

### 统计

| 类型 | 数量 | 严重程度 |
|------|------|---------|
| **权限检查函数** | 1个函数（多处使用） | ⚠️ 高 |
| **数据访问函数** | 1个函数（多处使用） | ⚠️ 高 |
| **RLS策略** | 多处 | ⚠️ 非常高 |
| **触发器** | 1个（可能是合理的） | ✅ 低 |

---

### 实际影响场景

#### 场景1：给 business 配置"修改合作链路"权限

```
前端：
  ✅ 显示"修改链路"按钮（因为权限系统允许）

用户点击：
  ↓
后端函数调用：
  modify_logistics_record_chain_with_recalc()
  ↓
权限检查：
  is_finance_operator_or_admin()
  ↓
  business 不在 ('admin', 'finance', 'operator') 中
  ❌ 返回错误："权限不足：只有财务、操作员和管理员可以修改合作链路"
```

**结果：**
- ⚠️ 前端可以配置，但后端函数会拒绝
- ⚠️ 用户体验不一致

---

#### 场景2：给 operator 配置"查看所有项目"权限

```
前端：
  ✅ 显示所有项目（因为权限系统允许）

用户访问项目数据：
  ↓
RLS策略检查：
  projects_select_policy
  ↓
  检查 role = 'admin' OR role = 'finance'
  ↓
  operator 不是 admin 也不是 finance
  ❌ 只能看到自己有权限的项目
```

**结果：**
- ⚠️ 即使配置了权限，RLS也会限制
- ⚠️ 数据访问受限

---

## 🎯 解决方案

### 方案 A: 创建统一的权限检查函数 ⭐（推荐）

**创建一个通用的权限检查函数，查询权限表：**

```sql
-- 检查用户是否有菜单权限
CREATE OR REPLACE FUNCTION public.has_menu_permission(p_menu_key TEXT)
RETURNS BOOLEAN AS $$
DECLARE
    v_user_id UUID;
    v_user_role TEXT;
    v_has_permission BOOLEAN := FALSE;
BEGIN
    v_user_id := auth.uid();
    
    IF v_user_id IS NULL THEN
        RETURN FALSE;
    END IF;
    
    -- 获取用户角色
    SELECT role INTO v_user_role
    FROM public.profiles
    WHERE id = v_user_id;
    
    -- admin 自动拥有所有权限（保持兼容）
    IF v_user_role = 'admin' THEN
        RETURN TRUE;
    END IF;
    
    -- 检查用户自定义权限
    SELECT EXISTS (
        SELECT 1
        FROM public.user_permissions
        WHERE user_id = v_user_id
          AND project_id IS NULL
          AND p_menu_key = ANY(menu_permissions)
    ) INTO v_has_permission;
    
    IF v_has_permission THEN
        RETURN TRUE;
    END IF;
    
    -- 检查角色模板权限
    SELECT EXISTS (
        SELECT 1
        FROM public.role_permission_templates
        WHERE role = v_user_role
          AND p_menu_key = ANY(menu_permissions)
    ) INTO v_has_permission;
    
    RETURN v_has_permission;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 检查用户是否有功能权限
CREATE OR REPLACE FUNCTION public.has_function_permission(p_function_key TEXT)
RETURNS BOOLEAN AS $$
-- 类似上面的逻辑，但检查 function_permissions
END;
$$;

-- 检查用户是否有数据权限
CREATE OR REPLACE FUNCTION public.has_data_permission(p_data_scope TEXT)
RETURNS BOOLEAN AS $$
-- 类似上面的逻辑，但检查 data_permissions
END;
$$;
```

---

### 方案 B: 修改现有函数使用权限系统

#### 修改 `is_finance_operator_or_admin()`

```sql
-- 之前（硬编码）
RETURN user_role IN ('admin', 'finance', 'operator');

-- 改为（权限判断）
RETURN (
    -- admin 自动拥有所有权限
    v_user_role = 'admin'
    OR
    -- 检查是否有"修改合作链路"权限
    public.has_function_permission('logistics.modify_chain')
);
```

---

#### 修改 `can_view_partner()`

```sql
-- 之前（硬编码）
IF current_user_role IN ('admin', 'finance') THEN
    RETURN TRUE;
END IF;

-- 改为（权限判断）
IF current_user_role = 'admin' THEN
    RETURN TRUE;  -- admin 保持查看所有
END IF;

IF public.has_data_permission('partner.view_all') THEN
    RETURN TRUE;  -- 有权限配置时可以查看所有
END IF;
```

---

#### 修改 RLS 策略

```sql
-- 之前（硬编码）
WHERE id = auth.uid() AND role = 'admin'

-- 改为（权限判断）
WHERE id = auth.uid() 
  AND (
    role = 'admin'  -- admin 保持查看所有
    OR EXISTS (
        SELECT 1 FROM public.user_permissions
        WHERE user_id = auth.uid()
          AND project_id IS NULL
          AND 'project.view_all' = ANY(data_permissions)
    )
    OR EXISTS (
        SELECT 1 FROM public.role_permission_templates
        WHERE role = (SELECT role FROM public.profiles WHERE id = auth.uid())
          AND 'project.view_all' = ANY(data_permissions)
    )
  )
```

**⚠️ 注意：RLS 策略中查询性能很重要，需要优化！**

---

## ⚠️ 性能考虑

### 问题

**权限检查函数在 RLS 策略中使用：**

```sql
-- 每个查询都会执行
USING (
    public.has_menu_permission('project.view_all')
)
```

**性能影响：**
- ⚠️ 每次查询都要执行权限检查函数
- ⚠️ 权限检查函数内部还要查询多个表
- ⚠️ 可能导致查询变慢

### 优化方案

1. **缓存权限到 session 变量**
2. **使用物化视图存储权限**
3. **在 Edge Function 中检查权限，而不是 RLS**

---

## 📋 需要修改的函数列表

### 高优先级 ⚠️

1. **`is_finance_operator_or_admin()`**
   - 使用位置：3个函数
   - 影响：合作链路修改、查看

2. **`can_view_partner()`**
   - 使用位置：多处
   - 影响：合作方数据访问

3. **RLS 策略中的硬编码**
   - `projects` 表
   - `logistics_records` 表
   - 其他表的策略

### 低优先级 ✅

1. **`prevent_admin_permission_reduction()`**
   - 专门保护 admin，可以保持现状

---

## ✅ 建议

### 短期方案（推荐）⭐

1. **创建统一权限检查函数**
   - `has_menu_permission()`
   - `has_function_permission()`
   - `has_data_permission()`

2. **逐步替换硬编码**
   - 先替换关键函数（合作链路、数据访问）
   - 再替换 RLS 策略（注意性能）

3. **保持 admin 兼容**
   - admin 角色仍然自动拥有所有权限
   - 确保向后兼容

### 长期方案

1. **完全使用权限系统**
   - 所有角色都通过权限表判断
   - admin 也只是有完整权限配置

2. **性能优化**
   - 缓存权限结果
   - 优化查询路径

---

## 📝 下一步

1. ✅ 创建统一权限检查函数
2. ✅ 修改 `is_finance_operator_or_admin()` 
3. ✅ 修改 `can_view_partner()`
4. ✅ 修改关键 RLS 策略
5. ✅ 测试性能影响

---

**数据库函数硬编码：需要改造！** ⚠️🔧

