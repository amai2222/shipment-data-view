# åˆä½œæ–¹åç§°åŒå‘åŒæ­¥ä½¿ç”¨æŒ‡å—

## ğŸ¯ åŠŸèƒ½è¯´æ˜

å®ç°äº† `partners` è¡¨å’Œ `partner_bank_details` è¡¨ä¹‹é—´ `full_name` å­—æ®µçš„**åŒå‘è‡ªåŠ¨åŒæ­¥**ã€‚

### âœ… åŒæ­¥æœºåˆ¶
- **partners.full_name** æ›´æ–° â†’ è‡ªåŠ¨åŒæ­¥åˆ° **partner_bank_details.full_name**
- **partner_bank_details.full_name** æ›´æ–° â†’ è‡ªåŠ¨åŒæ­¥åˆ° **partners.full_name**
- **å®æ—¶åŒæ­¥**ï¼šä»»ä½•ä¸€æ–¹çš„ä¿®æ”¹éƒ½ä¼šç«‹å³åŒæ­¥åˆ°å¦ä¸€æ–¹

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“è§¦å‘å™¨
```sql
-- partnersè¡¨è§¦å‘å™¨
CREATE TRIGGER trigger_sync_partner_to_bank_details
    AFTER INSERT OR UPDATE OF full_name ON public.partners
    FOR EACH ROW
    EXECUTE FUNCTION public.sync_partner_to_bank_details();

-- partner_bank_detailsè¡¨è§¦å‘å™¨  
CREATE TRIGGER trigger_sync_bank_details_to_partner
    AFTER INSERT OR UPDATE OF full_name ON public.partner_bank_details
    FOR EACH ROW
    EXECUTE FUNCTION public.sync_bank_details_to_partner();
```

### 2. åŒæ­¥å‡½æ•°
- `sync_partner_to_bank_details()` - partners â†’ partner_bank_details
- `sync_bank_details_to_partner()` - partner_bank_details â†’ partners

## ğŸ“‹ ä½¿ç”¨æ–¹æ³•

### 1. è‡ªåŠ¨åŒæ­¥ï¼ˆæ¨èï¼‰
**æ— éœ€ä»»ä½•æ“ä½œ**ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ï¼š
- åœ¨åˆä½œæ–¹ç®¡ç†é¡µé¢ä¿®æ”¹ `full_name` â†’ è‡ªåŠ¨åŒæ­¥åˆ°é“¶è¡Œè¯¦æƒ…
- åœ¨é“¶è¡Œè¯¦æƒ…é¡µé¢ä¿®æ”¹ `full_name` â†’ è‡ªåŠ¨åŒæ­¥åˆ°åˆä½œæ–¹ä¿¡æ¯

### 2. æ‰‹åŠ¨æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
```sql
-- æ£€æŸ¥æ‰€æœ‰åˆä½œæ–¹çš„ä¸€è‡´æ€§
SELECT * FROM public.check_partner_name_consistency();

-- åªæŸ¥çœ‹ä¸ä¸€è‡´çš„è®°å½•
SELECT * FROM public.check_partner_name_consistency() 
WHERE NOT is_consistent;
```

### 3. æ‰‹åŠ¨ä¿®å¤æ•°æ®
```sql
-- ä¿®å¤æ‰€æœ‰ä¸ä¸€è‡´çš„è®°å½•
SELECT * FROM public.fix_partner_name_consistency();

-- æ‰‹åŠ¨åŒæ­¥å•ä¸ªåˆä½œæ–¹
SELECT public.sync_partner_names_manual('åˆä½œæ–¹ID');

-- æ‰¹é‡åŒæ­¥æ‰€æœ‰åˆä½œæ–¹
SELECT public.sync_all_partner_names();
```

## ğŸ¨ å‰ç«¯ä½¿ç”¨ç¤ºä¾‹

### 1. åˆä½œæ–¹ç®¡ç†é¡µé¢
```typescript
// ä¿®æ”¹åˆä½œæ–¹full_nameæ—¶ï¼Œä¼šè‡ªåŠ¨åŒæ­¥åˆ°partner_bank_details
const updatePartner = async (partnerId: string, fullName: string) => {
  const { error } = await supabase
    .from('partners')
    .update({ full_name: fullName })
    .eq('id', partnerId);
  
  // æ— éœ€æ‰‹åŠ¨æ›´æ–°partner_bank_detailsï¼Œè§¦å‘å™¨ä¼šè‡ªåŠ¨å¤„ç†
  if (error) throw error;
};
```

### 2. é“¶è¡Œè¯¦æƒ…é¡µé¢
```typescript
// ä¿®æ”¹é“¶è¡Œè¯¦æƒ…full_nameæ—¶ï¼Œä¼šè‡ªåŠ¨åŒæ­¥åˆ°partners
const updateBankDetails = async (partnerId: string, fullName: string) => {
  const { error } = await supabase
    .from('partner_bank_details')
    .update({ full_name: fullName })
    .eq('partner_id', partnerId);
  
  // æ— éœ€æ‰‹åŠ¨æ›´æ–°partnersï¼Œè§¦å‘å™¨ä¼šè‡ªåŠ¨å¤„ç†
  if (error) throw error;
};
```

## ğŸ” æ•°æ®éªŒè¯

### 1. æ£€æŸ¥åŒæ­¥çŠ¶æ€
```sql
-- æŸ¥çœ‹æ‰€æœ‰åˆä½œæ–¹çš„åŒæ­¥çŠ¶æ€
SELECT 
    p.id,
    p.name,
    p.full_name as partners_full_name,
    pbd.full_name as bank_full_name,
    CASE 
        WHEN p.full_name = pbd.full_name THEN 'âœ… å·²åŒæ­¥'
        WHEN p.full_name IS NULL AND pbd.full_name IS NULL THEN 'âœ… éƒ½ä¸ºç©º'
        ELSE 'âŒ ä¸ä¸€è‡´'
    END as sync_status
FROM public.partners p
LEFT JOIN public.partner_bank_details pbd ON p.id = pbd.partner_id
WHERE pbd.partner_id IS NOT NULL;
```

### 2. ç›‘æ§åŒæ­¥æ—¥å¿—
```sql
-- æŸ¥çœ‹åŒæ­¥æ“ä½œæ—¥å¿—ï¼ˆéœ€è¦å¯ç”¨æ—¥å¿—è®°å½•ï¼‰
SELECT * FROM pg_stat_activity 
WHERE query LIKE '%sync_partner%' 
OR query LIKE '%sync_bank%';
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¼˜å…ˆçº§
- **partners.full_name** ä¼˜å…ˆäº **partner_bank_details.full_name**
- å¦‚æœä¸¤ä¸ªå­—æ®µéƒ½æœ‰å€¼ä¸”ä¸åŒï¼Œä»¥ partners è¡¨ä¸ºå‡†

### 2. æ€§èƒ½è€ƒè™‘
- è§¦å‘å™¨æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä¸ä¼šé˜»å¡ä¸»æ“ä½œ
- å¤§é‡æ•°æ®ä¿®æ”¹æ—¶å»ºè®®ä½¿ç”¨æ‰¹é‡åŒæ­¥å‡½æ•°

### 3. é”™è¯¯å¤„ç†
- å¦‚æœåŒæ­¥å¤±è´¥ï¼Œä¼šåœ¨æ•°æ®åº“æ—¥å¿—ä¸­è®°å½•é”™è¯¯
- å¯ä»¥ä½¿ç”¨æ‰‹åŠ¨åŒæ­¥å‡½æ•°è¿›è¡Œä¿®å¤

## ğŸ› ï¸ æ•…éšœæ’é™¤

### 1. åŒæ­¥ä¸ç”Ÿæ•ˆ
```sql
-- æ£€æŸ¥è§¦å‘å™¨æ˜¯å¦å­˜åœ¨
SELECT trigger_name, event_object_table 
FROM information_schema.triggers 
WHERE event_object_table IN ('partners', 'partner_bank_details');

-- é‡æ–°åˆ›å»ºè§¦å‘å™¨
DROP TRIGGER IF EXISTS trigger_sync_partner_to_bank_details ON public.partners;
DROP TRIGGER IF EXISTS trigger_sync_bank_details_to_partner ON public.partner_bank_details;
-- ç„¶åé‡æ–°æ‰§è¡Œåˆ›å»ºè§¦å‘å™¨çš„SQL
```

### 2. æ•°æ®ä¸ä¸€è‡´
```sql
-- å¼ºåˆ¶åŒæ­¥æ‰€æœ‰æ•°æ®
SELECT public.sync_all_partner_names();
```

### 3. æ€§èƒ½é—®é¢˜
```sql
-- æ£€æŸ¥è§¦å‘å™¨æ‰§è¡Œæ—¶é—´
SELECT * FROM pg_stat_user_functions 
WHERE funcname LIKE '%sync_partner%';
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. å®šæœŸæ£€æŸ¥
```sql
-- æ¯å‘¨æ£€æŸ¥ä¸€æ¬¡æ•°æ®ä¸€è‡´æ€§
SELECT 
    COUNT(*) as total_records,
    COUNT(CASE WHEN is_consistent THEN 1 END) as consistent_count,
    COUNT(CASE WHEN NOT is_consistent THEN 1 END) as inconsistent_count
FROM public.check_partner_name_consistency();
```

### 2. æ€§èƒ½ç›‘æ§
```sql
-- ç›‘æ§è§¦å‘å™¨æ‰§è¡Œæƒ…å†µ
SELECT 
    schemaname,
    tablename,
    n_tup_ins as inserts,
    n_tup_upd as updates,
    n_tup_del as deletes
FROM pg_stat_user_tables 
WHERE tablename IN ('partners', 'partner_bank_details');
```

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™ä¸ªåŒå‘åŒæ­¥æ–¹æ¡ˆï¼Œæ‚¨å¯ä»¥ï¼š

1. **è‡ªåŠ¨åŒæ­¥**ï¼šä¿®æ”¹ä»»ä¸€è¡¨çš„ `full_name` éƒ½ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å¦ä¸€è¡¨
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿ä¸¤ä¸ªè¡¨çš„ `full_name` å­—æ®µå§‹ç»ˆä¿æŒä¸€è‡´
3. **å®æ—¶æ›´æ–°**ï¼šæ‰€æœ‰ç›¸å…³é¡µé¢å’ŒæŠ¥è¡¨éƒ½ä¼šæ˜¾ç¤ºæœ€æ–°çš„åç§°
4. **æ˜“äºç»´æŠ¤**ï¼šæä¾›å®Œæ•´çš„æ£€æŸ¥ã€ä¿®å¤å’Œç›‘æ§å·¥å…·

**ç°åœ¨æ‚¨å¯ä»¥æ”¾å¿ƒåœ°åœ¨åˆä½œæ–¹ç®¡ç†ä¸­ä¿®æ”¹ `full_name`ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰ç›¸å…³çš„æ•°æ®åŒæ­¥ï¼** ğŸš€
