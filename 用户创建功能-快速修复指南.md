# 🚀 用户创建功能 - 快速修复指南

## ❌ 问题
创建用户时显示：**"创建失败 User not allowed"**

## ✅ 解决方案（3步完成）

---

### 步骤 1：部署 Edge Function

#### 方法 A：使用脚本（推荐）⚡

在项目根目录打开 PowerShell，运行：

```powershell
.\deploy-create-user-function.ps1
```

脚本会自动：
- ✓ 检查环境
- ✓ 登录 Supabase
- ✓ 链接项目
- ✓ 部署函数

#### 方法 B：手动部署

**使用 Supabase CLI：**

```powershell
# 1. 登录
supabase login

# 2. 链接项目
supabase link --project-ref [你的项目ID]

# 3. 部署
supabase functions deploy create-user --no-verify-jwt
```

**或在 Supabase Dashboard：**

1. 访问 https://app.supabase.com
2. 选择项目 → **Edge Functions**
3. 点击 **Deploy new function**
4. 函数名：`create-user`
5. 复制 `supabase/functions/create-user/index.ts` 内容
6. 点击 **Deploy**

---

### 步骤 2：刷新前端

```powershell
# 如果是开发环境
npm run dev

# 如果是生产环境
npm run build
# 然后重新部署
```

或者直接刷新浏览器页面（按 Ctrl+F5 强制刷新）

---

### 步骤 3：测试创建用户

1. 登录系统（使用管理员账号）
2. 进入 **设置** → **用户管理**
3. 点击 **+ 新建用户**
4. 填写信息：
   - 邮箱：test@example.com
   - 密码：Test123!
   - 姓名：测试用户
   - 角色：查看者
5. 点击 **创建用户**
6. 应该显示 **✓ 用户创建成功**

---

## 📋 快速检查清单

在执行修复前，确认：

- [ ] 你有管理员或系统管理员权限
- [ ] 已安装 Supabase CLI（或准备手动部署）
- [ ] 网络可以访问 Supabase
- [ ] 有项目的 Project ID

---

## ⚠️ 常见问题

### Q1: 没有 Supabase CLI 怎么办？

**A:** 使用 Supabase Dashboard 手动部署（见步骤 1 方法 B）

### Q2: 部署后还是报错？

**A:** 检查：
1. Edge Function 是否部署成功（在 Dashboard 查看）
2. 前端页面是否刷新（按 Ctrl+F5）
3. 当前用户是否是管理员

### Q3: 提示"您没有权限创建用户"？

**A:** 当前用户不是管理员。在数据库中更新角色：

```sql
UPDATE profiles 
SET role = 'admin' 
WHERE email = '你的邮箱';
```

---

## 🎯 为什么会出现这个问题？

**简单解释：**
- 前端代码使用了需要管理员密钥的 API
- 但前端只有公开密钥，无权调用
- 解决：创建服务端函数，在服务端调用管理员 API

**技术细节：**
- `supabase.auth.admin` 需要 Service Role Key
- 前端只有 Anon Key
- Edge Function 运行在服务端，可以安全使用 Service Role Key

---

## 📞 需要帮助？

如果修复后仍有问题，请提供：
1. Edge Function 部署日志
2. 浏览器控制台错误信息
3. 当前用户的角色

---

## ✨ 修复完成后

你就可以：
- ✅ 正常创建用户
- ✅ 用户可以登录系统
- ✅ 系统更加安全

**预计修复时间：** < 10 分钟

完成后请测试一下，如有问题随时联系！🎉

