# 数据库权限管理方案

## 🎯 问题分析

### 当前问题
权限配置中的菜单权限是硬编码的，存在以下问题：
1. **数据不一致**: 权限配置与实际菜单结构不同步
2. **维护困难**: 需要手动维护两套配置
3. **扩展性差**: 新增菜单项需要修改多个文件

### 解决方案
将菜单权限配置存储到数据库中，实现动态权限管理。

## 🗄️ 数据库设计

### 1. 菜单权限配置表

**表名**: `menu_permissions`

**字段设计**:
```sql
CREATE TABLE public.menu_permissions (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    permission_key text NOT NULL UNIQUE,        -- 权限键，用于权限控制
    permission_name text NOT NULL,             -- 权限名称，用于显示
    menu_group text NOT NULL,                  -- 菜单分组
    menu_url text,                             -- 菜单URL路径
    menu_icon text,                            -- 菜单图标
    sort_order integer DEFAULT 0,              -- 排序顺序
    is_active boolean DEFAULT true,            -- 是否启用
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone NOT NULL DEFAULT now(),
    PRIMARY KEY (id)
);
```

### 2. 角色权限模板表

**表名**: `role_permission_templates`

**字段设计**:
```sql
CREATE TABLE public.role_permission_templates (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    role app_role NOT NULL,                    -- 角色类型
    name text,                                 -- 角色名称
    description text,                          -- 角色描述
    color text DEFAULT 'bg-blue-500',         -- 角色颜色
    menu_permissions text[] DEFAULT '{}',      -- 菜单权限数组
    function_permissions text[] DEFAULT '{}',  -- 功能权限数组
    project_permissions text[] DEFAULT '{}',   -- 项目权限数组
    data_permissions text[] DEFAULT '{}',      -- 数据权限数组
    is_system boolean DEFAULT false,          -- 是否系统角色
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone NOT NULL DEFAULT now(),
    PRIMARY KEY (id)
);
```

### 3. 用户权限表

**表名**: `user_permissions`

**字段设计**:
```sql
CREATE TABLE public.user_permissions (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    user_id uuid NOT NULL,                    -- 用户ID
    project_id uuid,                           -- 项目ID（可选）
    menu_permissions text[] DEFAULT '{}',      -- 菜单权限数组
    function_permissions text[] DEFAULT '{}',  -- 功能权限数组
    project_permissions text[] DEFAULT '{}',   -- 项目权限数组
    data_permissions text[] DEFAULT '{}',      -- 数据权限数组
    custom_settings jsonb DEFAULT '{}',       -- 自定义设置
    inherit_role boolean DEFAULT true,        -- 是否继承角色权限
    created_by uuid,                           -- 创建者
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone NOT NULL DEFAULT now(),
    PRIMARY KEY (id),
    FOREIGN KEY (user_id) REFERENCES public.profiles(id) ON DELETE CASCADE
);
```

## 🔧 技术实现

### 1. 数据库迁移文件

**文件**: `supabase/migrations/20250116_initialize_menu_permissions.sql`

**功能**:
- 创建菜单权限配置表
- 插入系统角色权限模板
- 初始化菜单权限数据
- 创建必要的索引

### 2. 动态权限配置

**文件**: `src/config/dynamicPermissions.ts`

**核心功能**:
```typescript
// 从数据库读取菜单权限配置
export async function generateMenuPermissions() {
  const { data: menuPermissions, error } = await supabase
    .from('menu_permissions')
    .select('*')
    .eq('is_active', true)
    .order('sort_order');

  // 按分组组织权限
  const groupedPermissions = {};
  menuPermissions?.forEach(permission => {
    if (!groupedPermissions[permission.menu_group]) {
      groupedPermissions[permission.menu_group] = [];
    }
    groupedPermissions[permission.menu_group].push({
      key: permission.permission_key,
      label: permission.permission_name,
      url: permission.menu_url,
      icon: permission.menu_icon
    });
  });

  return Object.entries(groupedPermissions).map(([group, permissions]) => ({
    group,
    permissions
  }));
}
```

### 3. 权限管理页面更新

**文件**: `src/pages/Settings/PermissionManagement.tsx`

**更新内容**:
- 异步加载菜单权限配置
- 支持数据库权限管理
- 提供回退机制

## 📊 权限数据初始化

### 1. 系统角色权限模板

**管理员角色**:
- 拥有所有菜单权限
- 拥有所有功能权限
- 系统角色，不可删除

**财务角色**:
- 拥有财务相关菜单权限
- 拥有财务相关功能权限
- 系统角色，不可删除

**操作员角色**:
- 拥有业务操作菜单权限
- 拥有数据操作功能权限
- 系统角色，不可删除

**合作方角色**:
- 拥有查看相关菜单权限
- 只有查看功能权限
- 系统角色，不可删除

**查看者角色**:
- 只有数据看板菜单权限
- 只有查看功能权限
- 系统角色，不可删除

### 2. 菜单权限配置

**数据看板**:
- `dashboard.transport` - 运输看板
- `dashboard.financial` - 财务看板
- `dashboard.project` - 项目看板

**合同管理**:
- `contracts.list` - 合同列表

**信息维护**:
- `maintenance.projects` - 项目管理
- `maintenance.drivers` - 司机管理
- `maintenance.locations` - 地点管理
- `maintenance.locations_enhanced` - 地点管理（增强版）
- `maintenance.partners` - 合作方管理

**业务管理**:
- `business.entry` - 运单管理
- `business.scale` - 磅单管理
- `business.invoice_request` - 开票申请
- `business.payment_request` - 付款申请

**财务管理**:
- `finance.reconciliation` - 运费对账
- `finance.payment_invoice` - 付款与开票
- `finance.invoice_request_management` - 开票申请单管理
- `finance.payment_requests` - 付款申请单管理

**数据维护**:
- `data_maintenance.waybill` - 运单维护
- `data_maintenance.waybill_enhanced` - 运单维护（增强版）

**设置**:
- `settings.users` - 用户管理
- `settings.permissions` - 权限配置
- `settings.contract_permissions` - 合同权限
- `settings.role_templates` - 角色模板
- `settings.permission_management` - 权限管理

## 🚀 部署步骤

### 1. 应用数据库迁移

```bash
# 应用菜单权限初始化迁移
supabase db push
```

### 2. 验证数据初始化

```sql
-- 检查菜单权限配置
SELECT * FROM public.menu_permissions ORDER BY sort_order;

-- 检查角色权限模板
SELECT * FROM public.role_permission_templates;

-- 检查用户权限
SELECT * FROM public.user_permissions;
```

### 3. 测试权限功能

1. 验证权限配置页面加载
2. 验证菜单权限列表显示
3. 验证权限配置保存功能
4. 验证权限控制功能

## 🎯 优势特点

### 1. 数据一致性
- 权限配置与菜单结构完全同步
- 单一数据源，避免不一致
- 自动更新，减少维护成本

### 2. 扩展性
- 新增菜单项自动同步到权限配置
- 支持动态权限管理
- 支持权限分组和排序

### 3. 灵活性
- 支持角色权限模板
- 支持用户个性化权限
- 支持项目级权限控制

### 4. 可维护性
- 数据库管理，易于维护
- 支持权限审计和日志
- 支持权限导入导出

## 📝 注意事项

### 1. 数据迁移
- 确保现有权限数据不丢失
- 提供数据迁移脚本
- 支持回滚操作

### 2. 性能优化
- 添加必要的数据库索引
- 使用缓存机制
- 优化查询性能

### 3. 安全考虑
- 权限数据访问控制
- 防止权限提升攻击
- 审计权限变更

---

**方案状态**: ✅ 已实现  
**数据库状态**: ⏳ 待迁移  
**测试状态**: ⏳ 待测试  
**部署状态**: ⏳ 待部署
