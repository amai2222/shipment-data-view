# Excel数据格式问题修复说明

## 🔍 问题诊断

### 错误信息
```
invalid input syntax for type integer: "--29"
```

### 问题原因
Excel数据中包含了无效的数字格式：
- `"--29"` - 包含双破折号
- `"---29"` - 包含多个破折号
- `"--"` - 只有破折号
- `"---"` - 多个破折号

这些字符串无法直接转换为数据库的 `numeric` 类型，导致导入失败。

---

## 🛠️ 解决方案

### 1. 创建安全数字转换函数

```sql
CREATE OR REPLACE FUNCTION public.safe_numeric_conversion(input_text text, default_value numeric DEFAULT 0)
RETURNS numeric
```

**功能**：
- ✅ 处理 `"--29"` 格式，提取为 `-29`
- ✅ 处理 `"---29"` 格式，提取为 `-29`
- ✅ 处理 `"--"` 格式，返回默认值 `0`
- ✅ 处理空值，返回默认值
- ✅ 处理无效字符，返回默认值

### 2. 更新导入函数

**修改前**：
```sql
-- 直接转换，会失败
(record_data->>'current_cost')::numeric
```

**修改后**：
```sql
-- 安全转换，不会失败
public.safe_numeric_conversion(record_data->>'current_cost', 0)
```

---

## 📊 转换规则

| 输入值 | 输出值 | 说明 |
|--------|--------|------|
| `"--29"` | `-29` | 提取数字部分 |
| `"---29"` | `-29` | 提取数字部分 |
| `"--"` | `0` | 无效格式，使用默认值 |
| `"---"` | `0` | 无效格式，使用默认值 |
| `""` | `0` | 空值，使用默认值 |
| `"12.34"` | `12.34` | 正常数字 |
| `"-12.34"` | `-12.34` | 正常负数 |
| `"abc"` | `0` | 无效字符，使用默认值 |

---

## 🎯 修复的字段

### 数字字段（使用安全转换）
- `loading_weight` - 装货重量
- `unloading_weight` - 卸货重量  
- `current_cost` - 运费金额
- `extra_cost` - 额外费用

### 文本字段（保持原样）
- `project_name` - 项目名称
- `driver_name` - 司机姓名
- `license_plate` - 车牌号
- `loading_location` - 装货地点
- `unloading_location` - 卸货地点
- `remarks` - 备注

---

## 🚀 执行步骤

### 1. 执行SQL修复
```sql
-- 在 Supabase SQL Editor 中执行
supabase/migrations/fix_excel_data_type_conversion.sql
```

### 2. 验证修复
```sql
-- 测试安全转换函数
SELECT public.safe_numeric_conversion('--29', 0);  -- 应该返回 -29
SELECT public.safe_numeric_conversion('---29', 0); -- 应该返回 -29
SELECT public.safe_numeric_conversion('--', 0);    -- 应该返回 0
```

### 3. 重新导入Excel
- 使用相同的Excel文件重新导入
- 应该不再出现 `"--29"` 错误

---

## 📋 测试用例

### 测试数据
```excel
项目名称    司机姓名    车牌号      装货重量    运费金额    额外费用
可口可乐    孙德峰      黑MM6548    --29        --29        --29
可口可乐    栗冲        黑ME4471    ---29       ---29       ---29
可口可乐    孟庆臣      黑M37667    --          --          --
```

### 预期结果
- ✅ 所有记录成功导入
- ✅ `--29` 转换为 `-29`
- ✅ `---29` 转换为 `-29`
- ✅ `--` 转换为 `0`

---

## ⚠️ 注意事项

### 1. 数据验证
修复后，系统会自动处理无效格式，但建议：
- 检查Excel数据源
- 确保数据格式正确
- 避免使用 `--` 这样的格式

### 2. 性能影响
- 安全转换函数会稍微增加处理时间
- 但避免了导入失败，整体效率更高

### 3. 数据准确性
- 系统会尽可能提取有效数字
- 无法识别的格式会使用默认值 `0`
- 建议检查转换后的数据是否正确

---

## 🔧 预防措施

### 1. Excel数据规范
- 数字字段只使用纯数字格式
- 避免使用 `--` 这样的特殊字符
- 使用标准的数字格式：`123.45`、`-123.45`

### 2. 数据验证
- 导入前检查Excel数据
- 使用数据验证规则
- 避免复制粘贴时带入特殊字符

### 3. 模板规范
- 提供标准导入模板
- 在模板中设置正确的数据格式
- 添加数据验证规则

---

## 📞 问题排查

### 如果仍有导入失败

1. **检查错误信息**
   ```sql
   -- 查看具体的错误信息
   SELECT * FROM your_error_log_table;
   ```

2. **测试转换函数**
   ```sql
   -- 测试问题数据
   SELECT public.safe_numeric_conversion('你的问题数据', 0);
   ```

3. **检查Excel格式**
   - 确保数字字段格式正确
   - 避免使用公式生成 `--` 格式
   - 检查单元格格式设置

---

## ✅ 修复完成

执行修复后，您应该能够：
- ✅ 成功导入包含 `"--29"` 格式的Excel文件
- ✅ 系统自动处理无效数字格式
- ✅ 避免 `invalid input syntax for type integer` 错误
- ✅ 保持数据完整性和准确性

---

*修复说明版本：1.0*  
*创建日期：2025年1月8日*
