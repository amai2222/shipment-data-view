# å¼€ç¥¨ç”³è¯·ä½œåºŸåŠŸèƒ½ä¿®å¤è¯´æ˜

## ğŸ› **é—®é¢˜æè¿°**

ç”¨æˆ·åœ¨ä½œåºŸå¼€ç¥¨ç”³è¯·å•æ—¶é‡åˆ°æ•°æ®åº“çº¦æŸé”™è¯¯ï¼š
```
ä½œåºŸå¤±è´¥: new row for relation "invoice_requests" violates check constraint "invoice_requests_status_check"
```

## ğŸ” **é—®é¢˜åˆ†æ**

### é”™è¯¯åŸå› 
1. **CHECKçº¦æŸå†²çª**: `invoice_requests`è¡¨çš„`status`å­—æ®µæœ‰CHECKçº¦æŸ
2. **çŠ¶æ€å€¼ä¸åŒ¹é…**: ä½œåºŸå‡½æ•°å°è¯•è®¾ç½®`status = 'Voided'`ï¼Œä½†çº¦æŸä¸å…è®¸è¿™ä¸ªå€¼
3. **çº¦æŸå®šä¹‰ç¼ºå¤±**: åŸæœ‰çº¦æŸå¯èƒ½åªå…è®¸'Pending', 'Approved', 'Rejected'ç­‰çŠ¶æ€

### å—å½±å“çš„å‡½æ•°
- `void_invoice_request` - ä½œåºŸå¼€ç¥¨ç”³è¯·å•å‡½æ•°

## ğŸ› ï¸ **ä¿®å¤æ–¹æ¡ˆ**

### 1. æ›´æ–°æ•°æ®åº“çº¦æŸ
**æ–‡ä»¶**: `supabase/migrations/20250116_fix_invoice_status_constraint.sql`

#### åˆ é™¤æ—§çº¦æŸ
```sql
ALTER TABLE public.invoice_requests 
DROP CONSTRAINT IF EXISTS invoice_requests_status_check;
```

#### æ·»åŠ æ–°çº¦æŸ
```sql
ALTER TABLE public.invoice_requests 
ADD CONSTRAINT invoice_requests_status_check 
CHECK (status IN (
    'Pending',      -- å¾…å®¡æ ¸
    'Approved',     -- å·²æ‰¹å‡†
    'Rejected',     -- å·²æ‹’ç»
    'Processing',   -- å¤„ç†ä¸­
    'Completed',    -- å·²å®Œæˆ
    'Voided',       -- å·²ä½œåºŸ
    'Cancelled'     -- å·²å–æ¶ˆ
));
```

### 2. æ›´æ–°ä½œåºŸå‡½æ•°
ä½¿ç”¨`'Cancelled'`çŠ¶æ€ä»£æ›¿`'Voided'`ï¼Œé¿å…ä¸`is_voided`å­—æ®µæ··æ·†ï¼š

```sql
UPDATE public.invoice_requests
SET 
    is_voided = true,
    voided_at = NOW(),
    voided_by = auth.uid(),
    void_reason = p_void_reason,
    status = 'Cancelled'  -- ä½¿ç”¨Cancelledè€Œä¸æ˜¯Voided
WHERE id = p_request_id;
```

## ğŸ“Š **çŠ¶æ€å­—æ®µè®¾è®¡**

### invoice_requestsè¡¨çŠ¶æ€ç®¡ç†
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `status` | TEXT | ç”³è¯·å•å¤„ç†çŠ¶æ€ |
| `is_voided` | BOOLEAN | æ˜¯å¦å·²ä½œåºŸï¼ˆé€»è¾‘åˆ é™¤æ ‡è®°ï¼‰|
| `voided_at` | TIMESTAMP | ä½œåºŸæ—¶é—´ |
| `voided_by` | UUID | ä½œåºŸæ“ä½œäºº |
| `void_reason` | TEXT | ä½œåºŸåŸå›  |

### çŠ¶æ€å€¼å®šä¹‰
| çŠ¶æ€å€¼ | ä¸­æ–‡åç§° | è¯´æ˜ |
|--------|----------|------|
| `Pending` | å¾…å®¡æ ¸ | æ–°å»ºçš„ç”³è¯·å• |
| `Approved` | å·²æ‰¹å‡† | å®¡æ ¸é€šè¿‡ |
| `Rejected` | å·²æ‹’ç» | å®¡æ ¸æ‹’ç» |
| `Processing` | å¤„ç†ä¸­ | æ­£åœ¨å¤„ç† |
| `Completed` | å·²å®Œæˆ | å¼€ç¥¨å®Œæˆ |
| `Voided` | å·²ä½œåºŸ | å·²ä½œåºŸï¼ˆé€šè¿‡is_voidedæ ‡è®°ï¼‰|
| `Cancelled` | å·²å–æ¶ˆ | å·²å–æ¶ˆï¼ˆä½œåºŸæ—¶ä½¿ç”¨ï¼‰|

## ğŸ”§ **æŠ€æœ¯å®ç°**

### ä½œåºŸé€»è¾‘
1. **æ£€æŸ¥æƒé™**: åªæœ‰è´¢åŠ¡äººå‘˜æˆ–ç®¡ç†å‘˜å¯ä»¥ä½œåºŸ
2. **æ£€æŸ¥çŠ¶æ€**: å·²ä½œåºŸçš„ç”³è¯·å•ä¸èƒ½å†æ¬¡ä½œåºŸ
3. **æ›´æ–°ç”³è¯·å•**: 
   - è®¾ç½®`is_voided = true`
   - è®¾ç½®`status = 'Cancelled'`
   - è®°å½•ä½œåºŸæ—¶é—´ã€æ“ä½œäººã€åŸå› 
4. **å›æ»šè¿å•çŠ¶æ€**:
   - æ›´æ–°`logistics_partner_costs.invoice_status = 'Uninvoiced'`
   - æ¸…é™¤`invoice_request_id`å’Œ`invoice_applied_at`
5. **åˆ é™¤ç”³è¯·æ˜ç»†**: åˆ é™¤`invoice_request_details`è®°å½•

### æ•°æ®ä¸€è‡´æ€§ä¿éšœ
- âœ… ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- âœ… çº§è”æ›´æ–°ç›¸å…³è¡¨
- âœ… é”™è¯¯å¤„ç†å’Œå›æ»š
- âœ… æ“ä½œæ—¥å¿—è®°å½•

## ğŸ“ **ä¿®å¤çš„æ–‡ä»¶**

| æ–‡ä»¶ | ä¿®å¤å†…å®¹ | çŠ¶æ€ |
|------|----------|------|
| `supabase/migrations/20250116_fix_invoice_status_constraint.sql` | æ›´æ–°statusçº¦æŸï¼Œä¿®å¤voidå‡½æ•° | âœ… å·²åˆ›å»º |

## âœ… **éªŒè¯æ­¥éª¤**

### 1. åº”ç”¨æ•°æ®åº“è¿ç§»
```bash
supabase db push
```

### 2. æµ‹è¯•ä½œåºŸåŠŸèƒ½
1. åˆ›å»ºä¸€ä¸ªå¼€ç¥¨ç”³è¯·å•
2. å°è¯•ä½œåºŸè¯¥ç”³è¯·å•
3. éªŒè¯ï¼š
   - ç”³è¯·å•çŠ¶æ€å˜ä¸º'Cancelled'
   - is_voidedå­—æ®µä¸ºtrue
   - ç›¸å…³è¿å•çŠ¶æ€å›æ»šä¸º'Uninvoiced'
   - ç”³è¯·æ˜ç»†è¢«åˆ é™¤

### 3. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
```sql
-- æ£€æŸ¥ä½œåºŸçš„ç”³è¯·å•
SELECT id, request_number, status, is_voided, voided_at, void_reason
FROM invoice_requests
WHERE is_voided = true;

-- æ£€æŸ¥ç›¸å…³è¿å•çŠ¶æ€
SELECT id, invoice_status, invoice_request_id
FROM logistics_partner_costs
WHERE invoice_request_id IS NULL 
AND invoice_status = 'Uninvoiced';
```

## ğŸš€ **ä¼˜åŠ¿æ€»ç»“**

1. **çº¦æŸå®Œæ•´**: statuså­—æ®µåŒ…å«æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€å€¼
2. **é€»è¾‘æ¸…æ™°**: statuså’Œis_voidedå­—æ®µå„å¸å…¶èŒ
3. **æ•°æ®ä¸€è‡´**: ä½œåºŸæ“ä½œä¿è¯æ•°æ®ä¸€è‡´æ€§
4. **å¯è¿½æº¯**: è®°å½•ä½œåºŸæ—¶é—´ã€æ“ä½œäººã€åŸå› 
5. **æ˜“å›æ»š**: è¿å•çŠ¶æ€å¯ä»¥å›æ»šåˆ°æœªå¼€ç¥¨çŠ¶æ€

ç°åœ¨ä½œåºŸå¼€ç¥¨ç”³è¯·å•åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼ğŸ‰
