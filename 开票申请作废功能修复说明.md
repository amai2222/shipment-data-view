# 开票申请作废功能修复说明

## 🐛 **问题描述**

用户在作废开票申请单时遇到数据库约束错误：
```
作废失败: new row for relation "invoice_requests" violates check constraint "invoice_requests_status_check"
```

## 🔍 **问题分析**

### 错误原因
1. **CHECK约束冲突**: `invoice_requests`表的`status`字段有CHECK约束
2. **状态值不匹配**: 作废函数尝试设置`status = 'Voided'`，但约束不允许这个值
3. **约束定义缺失**: 原有约束可能只允许'Pending', 'Approved', 'Rejected'等状态

### 受影响的函数
- `void_invoice_request` - 作废开票申请单函数

## 🛠️ **修复方案**

### 1. 更新数据库约束
**文件**: `supabase/migrations/20250116_fix_invoice_status_constraint.sql`

#### 删除旧约束
```sql
ALTER TABLE public.invoice_requests 
DROP CONSTRAINT IF EXISTS invoice_requests_status_check;
```

#### 添加新约束
```sql
ALTER TABLE public.invoice_requests 
ADD CONSTRAINT invoice_requests_status_check 
CHECK (status IN (
    'Pending',      -- 待审核
    'Approved',     -- 已批准
    'Rejected',     -- 已拒绝
    'Processing',   -- 处理中
    'Completed',    -- 已完成
    'Voided',       -- 已作废
    'Cancelled'     -- 已取消
));
```

### 2. 更新作废函数
使用`'Cancelled'`状态代替`'Voided'`，避免与`is_voided`字段混淆：

```sql
UPDATE public.invoice_requests
SET 
    is_voided = true,
    voided_at = NOW(),
    voided_by = auth.uid(),
    void_reason = p_void_reason,
    status = 'Cancelled'  -- 使用Cancelled而不是Voided
WHERE id = p_request_id;
```

## 📊 **状态字段设计**

### invoice_requests表状态管理
| 字段 | 类型 | 说明 |
|------|------|------|
| `status` | TEXT | 申请单处理状态 |
| `is_voided` | BOOLEAN | 是否已作废（逻辑删除标记）|
| `voided_at` | TIMESTAMP | 作废时间 |
| `voided_by` | UUID | 作废操作人 |
| `void_reason` | TEXT | 作废原因 |

### 状态值定义
| 状态值 | 中文名称 | 说明 |
|--------|----------|------|
| `Pending` | 待审核 | 新建的申请单 |
| `Approved` | 已批准 | 审核通过 |
| `Rejected` | 已拒绝 | 审核拒绝 |
| `Processing` | 处理中 | 正在处理 |
| `Completed` | 已完成 | 开票完成 |
| `Voided` | 已作废 | 已作废（通过is_voided标记）|
| `Cancelled` | 已取消 | 已取消（作废时使用）|

## 🔧 **技术实现**

### 作废逻辑
1. **检查权限**: 只有财务人员或管理员可以作废
2. **检查状态**: 已作废的申请单不能再次作废
3. **更新申请单**: 
   - 设置`is_voided = true`
   - 设置`status = 'Cancelled'`
   - 记录作废时间、操作人、原因
4. **回滚运单状态**:
   - 更新`logistics_partner_costs.invoice_status = 'Uninvoiced'`
   - 清除`invoice_request_id`和`invoice_applied_at`
5. **删除申请明细**: 删除`invoice_request_details`记录

### 数据一致性保障
- ✅ 使用事务确保数据一致性
- ✅ 级联更新相关表
- ✅ 错误处理和回滚
- ✅ 操作日志记录

## 📁 **修复的文件**

| 文件 | 修复内容 | 状态 |
|------|----------|------|
| `supabase/migrations/20250116_fix_invoice_status_constraint.sql` | 更新status约束，修复void函数 | ✅ 已创建 |

## ✅ **验证步骤**

### 1. 应用数据库迁移
```bash
supabase db push
```

### 2. 测试作废功能
1. 创建一个开票申请单
2. 尝试作废该申请单
3. 验证：
   - 申请单状态变为'Cancelled'
   - is_voided字段为true
   - 相关运单状态回滚为'Uninvoiced'
   - 申请明细被删除

### 3. 检查数据一致性
```sql
-- 检查作废的申请单
SELECT id, request_number, status, is_voided, voided_at, void_reason
FROM invoice_requests
WHERE is_voided = true;

-- 检查相关运单状态
SELECT id, invoice_status, invoice_request_id
FROM logistics_partner_costs
WHERE invoice_request_id IS NULL 
AND invoice_status = 'Uninvoiced';
```

## 🚀 **优势总结**

1. **约束完整**: status字段包含所有可能的状态值
2. **逻辑清晰**: status和is_voided字段各司其职
3. **数据一致**: 作废操作保证数据一致性
4. **可追溯**: 记录作废时间、操作人、原因
5. **易回滚**: 运单状态可以回滚到未开票状态

现在作废开票申请单功能应该可以正常工作了！🎉
