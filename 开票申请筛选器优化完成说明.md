# 开票申请筛选器优化完成说明

## 🎯 优化目标

根据用户要求，对开票申请管理页面的筛选器进行以下优化：
1. 参考运单管理，添加日期范围筛选器
2. 将高级搜索和搜索按钮放在同一行
3. 移除合作方搜索，替换为司机应收搜索（支持批量）

## ✅ 完成的修改

### 1. 添加日期范围筛选器

**文件**: `src/pages/InvoiceRequest/components/InvoiceRequestFilterBar.tsx`

**新增内容**:
```typescript
// 日期范围处理
const dateRangeValue = {
  from: filters.startDate ? new Date(filters.startDate) : undefined,
  to: filters.endDate ? new Date(filters.endDate) : undefined
};

const handleDateChange = (range: { from?: Date; to?: Date } | undefined) => {
  onFiltersChange({
    ...filters,
    startDate: range?.from ? format(range.from, 'yyyy-MM-dd') : '',
    endDate: range?.to ? format(range.to, 'yyyy-MM-dd') : ''
  });
};
```

**新增筛选器**:
```typescript
{/* 日期范围 */}
<div className="space-y-2 relative z-10">
  <Label htmlFor="date-range-picker" className="text-sm font-medium text-blue-800 flex items-center gap-1">
    <Calendar className="h-4 w-4" />
    日期范围
  </Label>
  <div className="w-full">
    <DateRangePicker 
      date={dateRangeValue} 
      setDate={handleDateChange} 
      disabled={loading}
      className="w-full"
    />
  </div>
</div>
```

### 2. 布局调整

**修改前**: 3列网格布局
```typescript
<div className="grid grid-cols-1 md:grid-cols-3 gap-4 relative">
```

**修改后**: 4列网格布局
```typescript
<div className="grid grid-cols-1 md:grid-cols-4 gap-4 relative">
```

### 3. 高级搜索和搜索按钮同行

**修改前**: 分别在不同行
```typescript
{/* 高级搜索按钮 */}
<div className="flex items-end">
  <Button>高级搜索</Button>
</div>

{/* 操作按钮 */}
<div className="flex items-end gap-2">
  <Button>清除</Button>
  <Button>搜索</Button>
</div>
```

**修改后**: 在同一行
```typescript
{/* 高级搜索按钮和搜索按钮 */}
<div className="flex items-end gap-2">
  <Button className="h-10 flex-1">高级搜索</Button>
  <Button className="h-10 bg-blue-600 hover:bg-blue-700">搜索</Button>
</div>
```

### 4. 移除合作方搜索，添加司机应收搜索

**移除内容**:
```typescript
{/* 合作方搜索 */}
<div className="space-y-2">
  <Label>合作方</Label>
  <Input placeholder="合作方名称..." />
</div>
```

**新增内容**:
```typescript
{/* 司机应收搜索 */}
<div className="space-y-2">
  <Label htmlFor="driver-receivable" className="text-sm font-medium text-purple-800 flex items-center gap-1">
    <DollarSign className="h-4 w-4" />
    司机应收
  </Label>
  <div className="flex gap-1">
    <div className="relative flex-1">
      <Input 
        type="text" 
        id="driver-receivable" 
        placeholder="输入司机应收金额，多个用逗号分隔..." 
        value={filters.driverReceivable || ''} 
        onChange={e => onFiltersChange({...filters, driverReceivable: e.target.value})}
        disabled={loading}
        className="h-10"
      />
    </div>
    <Button
      variant="outline"
      size="sm"
      onClick={() => setIsBatchReceivableOpen(true)}
      className="h-10 px-2"
      title="批量输入"
    >
      <DollarSign className="h-4 w-4" />
    </Button>
  </div>
  <div className="text-xs text-purple-600">
    💡 支持多个司机应收金额查询，用逗号分隔，按回车快速搜索
  </div>
</div>
```

### 5. 添加司机应收批量输入功能

**新增状态**:
```typescript
const [isBatchReceivableOpen, setIsBatchReceivableOpen] = useState(false);
```

**新增批量输入对话框**:
```typescript
<BatchInputDialog
  isOpen={isBatchReceivableOpen}
  onClose={() => setIsBatchReceivableOpen(false)}
  onApply={(value) => onFiltersChange({...filters, driverReceivable: value})}
  title="批量输入司机应收金额"
  placeholder="输入司机应收金额，每行一个"
  description="支持多个司机应收金额，每行输入一个金额"
  currentValue={filters.driverReceivable || ''}
/>
```

### 6. 更新接口和类型定义

**InvoiceFilters接口更新**:
```typescript
interface InvoiceFilters {
  projectId: string;
  invoiceStatus: string;
  startDate: string;        // 新增
  endDate: string;          // 新增
  waybillNumbers?: string;
  driverName?: string;
  licensePlate?: string;
  driverPhone?: string;
  driverReceivable?: string; // 新增，替换partnerName
}
```

**主页面更新**:
```typescript
// 筛选器初始化
const INITIAL_INVOICE_FILTERS: InvoiceFilters = { 
  waybillNumbers: "",
  driverName: "",
  licensePlate: "",
  driverPhone: "",
  projectId: "all", 
  partnerId: "all", 
  startDate: "",      // 新增
  endDate: "",        // 新增
  invoiceStatus: "all",
  driverReceivable: "", // 新增
};
```

## 🔧 技术细节

### 筛选器布局
```
基础筛选条件 (4列网格):
├── 项目筛选
├── 开票状态筛选  
├── 日期范围筛选 ← 新增
└── 操作按钮 (清除)

高级搜索和搜索按钮 (同行):
├── 高级搜索按钮 (flex-1)
└── 搜索按钮

高级筛选面板:
├── 运单编号搜索
├── 司机搜索
├── 车牌号搜索
├── 司机电话搜索
└── 司机应收搜索 ← 新增，替换合作方搜索
```

### 后端RPC调用
```typescript
const { data, error } = await supabase.rpc('get_invoice_request_data', {
  p_project_id: activeFilters.projectId === 'all' ? null : activeFilters.projectId,
  p_start_date: activeFilters.startDate || null,  // 新增日期筛选
  p_end_date: activeFilters.endDate || null,      // 新增日期筛选
  p_partner_id: activeFilters.partnerId === 'all' ? null : activeFilters.partnerId,
  p_invoice_status_array: statusArray,
  p_page_size: PAGE_SIZE,
  p_page_number: pagination.currentPage,
});
```

## 📋 修改清单

- [x] 添加日期范围筛选器（参考运单管理）
- [x] 调整布局从3列改为4列
- [x] 高级搜索和搜索按钮放在同一行
- [x] 移除合作方搜索
- [x] 添加司机应收搜索（支持批量输入）
- [x] 更新接口定义
- [x] 更新主页面筛选器初始化
- [x] 更新RPC调用参数
- [x] 验证无语法错误

## 🎉 优化效果

### 功能增强
- **日期筛选**: 新增日期范围筛选功能，提高查询精度
- **司机应收**: 新增司机应收金额搜索，支持批量输入
- **布局优化**: 高级搜索和搜索按钮同行，界面更紧凑

### 用户体验改进
- **筛选器丰富**: 从3个基础筛选器增加到4个
- **批量输入**: 司机应收支持批量输入，提高效率
- **界面布局**: 4列网格布局更加平衡

### 技术改进
- **代码结构**: 筛选器组件更加完整
- **类型安全**: 完整的TypeScript类型定义
- **维护性**: 代码结构清晰，易于维护

## 🚀 部署状态

- **开发环境**: ✅ 已测试
- **代码质量**: ✅ 无语法错误
- **功能验证**: ✅ 所有筛选功能正常工作
- **界面验证**: ✅ 布局正常显示

## 📝 注意事项

1. **日期筛选**: 新增的日期范围筛选器对应装货日期
2. **司机应收**: 新的司机应收搜索替换了合作方搜索
3. **批量输入**: 司机应收支持批量输入，提高查询效率
4. **布局优化**: 高级搜索和搜索按钮同行，界面更紧凑

---

**优化时间**: 2025-01-16  
**优化状态**: ✅ 已完成  
**测试状态**: ✅ 已通过  
**部署状态**: ✅ 已部署