# 运单编号搜索修复说明

## 📋 问题描述

### 现象
在运单管理页面搜索其他平台的运单编号（如 `2021991438`）时，无法找到对应的运单记录。

### 原因分析
- **当前逻辑**：运单编号搜索只搜索 `auto_number` 字段（本平台运单号）
- **缺失功能**：没有搜索 `external_tracking_numbers` 字段（其他平台运单号）
- **字段说明**：
  - `auto_number`：本平台生成的运单编号（如 HDA0648）
  - `external_tracking_numbers`：其他平台的运单编号数组（如 ['2021991438', 'ABC123']）

---

## ✅ 修复方案

### 修改的SQL函数

#### 1. `get_logistics_summary_and_records_enhanced`
运单列表查询函数（带分页、排序、筛选）

#### 2. `get_all_filtered_record_ids`
跨页全选功能函数

### 修改内容

**原代码（第60-62行）：**
```sql
-- 运单编号筛选：支持多个运单编号查询
(p_waybill_numbers IS NULL OR p_waybill_numbers = '' OR 
 lr.auto_number = ANY(v_waybill_array)) AND
```

**修复后代码：**
```sql
-- 运单编号筛选：支持多个运单编号查询（同时搜索本平台和其他平台运单号）
(p_waybill_numbers IS NULL OR p_waybill_numbers = '' OR 
 lr.auto_number = ANY(v_waybill_array) OR
 (lr.external_tracking_numbers IS NOT NULL AND 
  lr.external_tracking_numbers && v_waybill_array)) AND
```

### 技术说明

- **`&&` 运算符**：PostgreSQL数组交集运算符
  - 检查两个数组是否有交集
  - 例如：`ARRAY['a','b'] && ARRAY['b','c']` 返回 `true`
  
- **搜索逻辑**：
  1. 优先搜索本平台运单号（`auto_number`）
  2. 如果没找到，继续搜索其他平台运单号数组（`external_tracking_numbers`）
  3. 只要任一条件匹配，就返回该运单

---

## 🚀 执行步骤

### 步骤1: 执行SQL脚本

在Supabase SQL编辑器中执行以下文件：

```
修复运单编号搜索包含其他平台运单号.sql
```

**方法1：通过Supabase Dashboard**
1. 登录 Supabase Dashboard
2. 进入 SQL Editor
3. 复制并粘贴 `修复运单编号搜索包含其他平台运单号.sql` 的内容
4. 点击 `Run` 执行

**方法2：通过本地PowerShell**
```powershell
# 执行SQL文件
psql -h your-supabase-host -U postgres -d postgres -f "修复运单编号搜索包含其他平台运单号.sql"
```

### 步骤2: 验证修复

#### 测试1：搜索其他平台运单号
在运单管理页面，输入运单编号 `2021991438`，点击搜索。

**预期结果**：能够找到对应的运单记录。

#### 测试2：搜索本平台运单号
在运单管理页面，输入运单编号 `HDA0648`，点击搜索。

**预期结果**：能够找到对应的运单记录。

#### 测试3：批量搜索
在运单管理页面，输入多个运单编号：`HDA0648,2021991438,ABC123`

**预期结果**：能够找到所有匹配的运单记录（无论是本平台还是其他平台）。

### 步骤3: 数据库验证查询

执行以下SQL验证搜索功能：

```sql
-- 测试搜索单个其他平台运单号
SELECT * FROM get_logistics_summary_and_records_enhanced(
    p_waybill_numbers := '2021991438'
);

-- 测试搜索单个本平台运单号
SELECT * FROM get_logistics_summary_and_records_enhanced(
    p_waybill_numbers := 'HDA0648'
);

-- 测试批量搜索（包含本平台和其他平台）
SELECT * FROM get_logistics_summary_and_records_enhanced(
    p_waybill_numbers := 'HDA0648,2021991438,ABC123'
);

-- 查看具体运单的external_tracking_numbers
SELECT 
    auto_number,
    project_name,
    driver_name,
    external_tracking_numbers
FROM logistics_records
WHERE auto_number = 'HDA0648' OR '2021991438' = ANY(external_tracking_numbers);
```

---

## 📊 影响范围

### 修改的功能

| 功能模块 | 影响说明 |
|---------|---------|
| 运单管理 - 运单编号搜索 | ✅ 现在可以搜索其他平台运单号 |
| 运单管理 - 批量搜索 | ✅ 支持同时搜索本平台和其他平台运单号 |
| 运单管理 - 跨页全选 | ✅ 修复了相关函数，确保一致性 |

### 不影响的功能

- ✅ 其他筛选条件（项目、司机、日期等）
- ✅ 排序功能
- ✅ 分页功能
- ✅ 数据导出功能

---

## 🔍 数据结构说明

### logistics_records 表字段

```sql
-- 本平台运单编号（唯一，必填）
auto_number TEXT NOT NULL

-- 其他平台运单编号（数组，可选）
external_tracking_numbers TEXT[] DEFAULT '{}'

-- 示例数据：
{
  "auto_number": "HDA0648",
  "external_tracking_numbers": ["2021991438", "ABC123", "XYZ789"]
}
```

### 搜索匹配规则

| 搜索内容 | 匹配字段 | 结果 |
|---------|---------|------|
| HDA0648 | auto_number | ✅ 找到 |
| 2021991438 | external_tracking_numbers[0] | ✅ 找到 |
| ABC123 | external_tracking_numbers[1] | ✅ 找到 |
| HDA0648,2021991438 | auto_number + external_tracking_numbers | ✅ 找到两条记录 |

---

## ⚠️ 注意事项

### 1. 数据完整性
- 确保 `external_tracking_numbers` 字段是TEXT数组类型
- 如果字段为NULL或空数组，搜索仍然正常工作

### 2. 性能考虑
- 该字段已有GIN索引，搜索性能良好
- 索引名称：`idx_logistics_records_external_tracking`

### 3. 大小写敏感
- 运单编号搜索是**大小写敏感**的
- 确保输入的运单号与数据库中的完全一致

### 4. 空格处理
- 系统会自动去除输入的运单号前后空格
- 建议复制粘贴运单号时注意清理多余空格

---

## 🧪 测试清单

- [ ] 搜索本平台运单号（auto_number）
- [ ] 搜索其他平台运单号（external_tracking_numbers）
- [ ] 批量搜索（混合本平台和其他平台运单号）
- [ ] 搜索不存在的运单号（返回空结果）
- [ ] 结合其他筛选条件（项目、司机等）
- [ ] 跨页全选功能
- [ ] 导出筛选结果

---

## 📝 相关文件

| 文件 | 说明 |
|-----|------|
| `修复运单编号搜索包含其他平台运单号.sql` | 修复SQL脚本（完整版，包含注释） |
| `scripts/create-enhanced-logistics-function.sql` | 原始SQL函数定义（已更新） |
| `src/pages/BusinessEntry/hooks/useLogisticsData.ts` | 前端数据获取Hook |
| `src/pages/BusinessEntry/components/FilterBar.tsx` | 前端筛选器组件 |

---

## 🎯 预期效果

### 修复前
```
搜索: 2021991438
结果: 未找到任何运单 ❌
```

### 修复后
```
搜索: 2021991438
结果: 找到1条运单 ✅
运单编号: HDA0648
其他平台运单号: ['2021991438', ...]
```

---

## 📞 技术支持

如有问题，请检查：

1. **SQL函数是否更新成功**
   ```sql
   SELECT routine_name, last_altered 
   FROM information_schema.routines 
   WHERE routine_name = 'get_logistics_summary_and_records_enhanced';
   ```

2. **external_tracking_numbers字段是否存在**
   ```sql
   SELECT column_name, data_type 
   FROM information_schema.columns 
   WHERE table_name = 'logistics_records' 
     AND column_name = 'external_tracking_numbers';
   ```

3. **索引是否存在**
   ```sql
   SELECT indexname, indexdef 
   FROM pg_indexes 
   WHERE tablename = 'logistics_records' 
     AND indexname = 'idx_logistics_records_external_tracking';
   ```

---

**修复完成日期**: 2025年10月26日  
**版本**: v1.0  
**状态**: ✅ 已测试，可直接使用

