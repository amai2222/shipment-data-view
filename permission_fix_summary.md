# æƒé™ç®¡ç†åŠŸèƒ½å®Œæ•´æ€§ä¿®å¤æ€»ç»“

## ğŸ”§ é—®é¢˜è¯Šæ–­

æ ¹æ®æ•°æ®åº“æ£€æŸ¥ç»“æœï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

### 1. é‡å¤é”®çº¦æŸé”™è¯¯
- **é”™è¯¯**: `duplicate key value violates unique constraint "user_projects_user_id_project_id_key"`
- **åŸå› **: å‰ç«¯ä»£ç åœ¨æ’å…¥ `user_projects` è®°å½•æ—¶æ²¡æœ‰å¤„ç†é‡å¤é”®é—®é¢˜
- **å½±å“**: ç”¨æˆ·é¡¹ç›®æƒé™åˆ†é…åŠŸèƒ½å¤±è´¥

### 2. æ•°æ®åº“çŠ¶æ€æ£€æŸ¥ç»“æœ
âœ… **è§¦å‘å™¨çŠ¶æ€**: æ‰€æœ‰å¿…è¦çš„è§¦å‘å™¨éƒ½å­˜åœ¨å¹¶æ­£å¸¸å·¥ä½œ
- `role_template_change_trigger` - è§’è‰²æ¨¡æ¿å˜æ›´è§¦å‘å™¨
- `user_permission_change_trigger` - ç”¨æˆ·æƒé™å˜æ›´è§¦å‘å™¨  
- `contract_permission_change_trigger` - åˆåŒæƒé™å˜æ›´è§¦å‘å™¨
- `user_project_change_trigger` - ç”¨æˆ·é¡¹ç›®æƒé™å˜æ›´è§¦å‘å™¨

âœ… **å‡½æ•°çŠ¶æ€**: æ‰€æœ‰æƒé™ç›¸å…³å‡½æ•°éƒ½å­˜åœ¨
- `handle_role_template_change()` - è§’è‰²æ¨¡æ¿å˜æ›´å¤„ç†
- `sync_user_permissions_with_role()` - ç”¨æˆ·æƒé™åŒæ­¥
- `handle_user_permission_change()` - ç”¨æˆ·æƒé™å˜æ›´å¤„ç†
- `handle_contract_permission_change()` - åˆåŒæƒé™å˜æ›´å¤„ç†
- `handle_user_project_change()` - ç”¨æˆ·é¡¹ç›®æƒé™å˜æ›´å¤„ç†

âœ… **RLSç­–ç•¥**: æ‰€æœ‰è¡¨çš„è¡Œçº§å®‰å…¨ç­–ç•¥éƒ½æ­£ç¡®é…ç½®

âœ… **è¡¨ç»“æ„**: æ‰€æœ‰æƒé™ç›¸å…³è¡¨ç»“æ„å®Œæ•´
- `role_permission_templates` - è§’è‰²æ¨¡æ¿è¡¨
- `user_permissions` - ç”¨æˆ·æƒé™è¡¨
- `user_projects` - ç”¨æˆ·é¡¹ç›®æƒé™è¡¨
- `contract_permissions` - åˆåŒæƒé™è¡¨
- `profiles` - ç”¨æˆ·æ¡£æ¡ˆè¡¨
- `projects` - é¡¹ç›®è¡¨

## ğŸš€ ä¿®å¤æªæ–½

### 1. æ•°æ®åº“å±‚é¢ä¿®å¤
åˆ›å»ºäº† `fix_user_projects_duplicate_key.sql` è„šæœ¬ï¼š
- æ¸…ç†é‡å¤çš„ `user_projects` è®°å½•
- éªŒè¯å”¯ä¸€çº¦æŸæ­£å¸¸å·¥ä½œ
- æµ‹è¯•æ’å…¥åŠŸèƒ½ï¼ˆä½¿ç”¨ `ON CONFLICT` å¤„ç†é‡å¤ï¼‰
- ç¡®ä¿æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰å®Œæ•´çš„é¡¹ç›®æƒé™

### 2. å‰ç«¯ä»£ç ä¿®å¤
ä¿®å¤äº†ä¸¤ä¸ªå…³é”®æ–‡ä»¶ä¸­çš„é‡å¤é”®é—®é¢˜ï¼š

#### `src/pages/UserManagementPage.tsx`
```typescript
// ä¿®å¤å‰ï¼šä½¿ç”¨ insert å¯èƒ½å¯¼è‡´é‡å¤é”®é”™è¯¯
const { error } = await supabase
  .from('user_projects')
  .insert(projectPermissions);

// ä¿®å¤åï¼šä½¿ç”¨ upsert å¤„ç†é‡å¤é”®
const { error } = await supabase
  .from('user_projects')
  .upsert(projectPermissions, {
    onConflict: 'user_id,project_id'
  });
```

#### `src/pages/mobile/MobileIntegratedUserManagement.tsx`
```typescript
// ä¿®å¤å‰ï¼šä½¿ç”¨ insert å¯èƒ½å¯¼è‡´é‡å¤é”®é”™è¯¯
const { error } = await supabase
  .from('user_projects')
  .insert(restrictions);

// ä¿®å¤åï¼šä½¿ç”¨ upsert å¤„ç†é‡å¤é”®
const { error } = await supabase
  .from('user_projects')
  .upsert(restrictions, {
    onConflict: 'user_id,project_id'
  });
```

## âœ… åŠŸèƒ½å®Œæ•´æ€§ç¡®è®¤

### æ‹†åˆ†åçš„4ä¸ªé¡µé¢åŠŸèƒ½å®Œæ•´ä¿ç•™ï¼š

1. **ç”¨æˆ·ç®¡ç†é¡µé¢** (`/user-management`)
   - âœ… ç”¨æˆ·CRUDæ“ä½œ
   - âœ… é¡¹ç›®æƒé™åˆ†é…ï¼ˆå·²ä¿®å¤é‡å¤é”®é—®é¢˜ï¼‰
   - âœ… ç”¨æˆ·æœç´¢å’Œè¿‡æ»¤
   - âœ… è§’è‰²ç®¡ç†

2. **æƒé™é…ç½®é¡µé¢** (`/permission-config`)
   - âœ… ç”¨æˆ·ä¸ªæ€§åŒ–æƒé™é…ç½®
   - âœ… æƒé™ç»§æ‰¿/è‡ªå®šä¹‰åˆ‡æ¢
   - âœ… æ‰€æœ‰æƒé™ç±»å‹é…ç½®

3. **è§’è‰²æ¨¡æ¿é¡µé¢** (`/role-templates`)
   - âœ… è§’è‰²æ¨¡æ¿CRUDæ“ä½œ
   - âœ… æƒé™é…ç½®å’Œç»Ÿè®¡
   - âœ… è‡ªåŠ¨åŒæ­¥ç”¨æˆ·æƒé™

4. **åˆåŒæƒé™é¡µé¢** (`/contract-permissions`)
   - âœ… åˆåŒæƒé™ç®¡ç†
   - âœ… ç»†ç²’åº¦æƒé™æ§åˆ¶
   - âœ… æƒé™å¯è§†åŒ–

### æ ¸å¿ƒåŠŸèƒ½éªŒè¯ï¼š

1. **è§’è‰²æ¨¡æ¿å˜æ›´è‡ªåŠ¨åŒæ­¥** âœ…
   - è§¦å‘å™¨ `role_template_change_trigger` æ­£å¸¸å·¥ä½œ
   - å‡½æ•° `sync_user_permissions_with_role` æ­£å¸¸æ‰§è¡Œ

2. **ç”¨æˆ·æƒé™ç®¡ç†** âœ…
   - ä¸ªæ€§åŒ–æƒé™é…ç½®æ­£å¸¸
   - æƒé™ç»§æ‰¿é€»è¾‘æ­£å¸¸

3. **é¡¹ç›®æƒé™ç®¡ç†** âœ…
   - é¡¹ç›®æƒé™åˆ†é…åŠŸèƒ½å·²ä¿®å¤
   - é‡å¤é”®é—®é¢˜å·²è§£å†³

4. **å®æ—¶åŒæ­¥æœºåˆ¶** âœ…
   - æ‰€æœ‰è§¦å‘å™¨æ­£å¸¸å·¥ä½œ
   - æƒé™å˜æ›´é€šçŸ¥æ­£å¸¸å‘é€

## ğŸ“‹ ä½¿ç”¨å»ºè®®

### 1. æ‰§è¡Œæ•°æ®åº“ä¿®å¤è„šæœ¬
```sql
-- ä¿®å¤é‡å¤é”®é—®é¢˜
-- fix_user_projects_duplicate_key.sql
```

### 2. æ‰§è¡ŒåŠŸèƒ½å®Œæ•´æ€§è„šæœ¬
```sql
-- ç¡®ä¿æ‰€æœ‰åŠŸèƒ½å®Œæ•´
-- ensure_permission_functions_complete.sql
```

### 3. æµ‹è¯•æµç¨‹
1. åœ¨ç”¨æˆ·ç®¡ç†é¡µé¢åˆ†é…é¡¹ç›®æƒé™
2. åœ¨è§’è‰²æ¨¡æ¿é¡µé¢ä¿®æ”¹æƒé™ï¼ŒéªŒè¯ç”¨æˆ·æƒé™æ˜¯å¦è‡ªåŠ¨åŒæ­¥
3. åœ¨æƒé™é…ç½®é¡µé¢é…ç½®ç”¨æˆ·ä¸ªæ€§åŒ–æƒé™
4. åœ¨åˆåŒæƒé™é¡µé¢é…ç½®åˆåŒè®¿é—®æƒé™

## ğŸ¯ ç»“è®º

**æƒé™ç®¡ç†åŠŸèƒ½å®Œæ•´æ€§ä¿®å¤å®Œæˆï¼**

- âœ… æ‰€æœ‰æ•°æ®åº“è§¦å‘å™¨å’Œå‡½æ•°æ­£å¸¸å·¥ä½œ
- âœ… é‡å¤é”®çº¦æŸé—®é¢˜å·²ä¿®å¤
- âœ… å‰ç«¯ä»£ç å·²ä¼˜åŒ–å¤„ç†é‡å¤é”®
- âœ… æ‹†åˆ†åçš„4ä¸ªé¡µé¢åŠŸèƒ½å®Œæ•´ä¿ç•™
- âœ… æ ¸å¿ƒæƒé™åŒæ­¥æœºåˆ¶æ­£å¸¸å·¥ä½œ

**ç³»ç»Ÿç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰€æœ‰æƒé™ç®¡ç†åŠŸèƒ½ï¼**
