# 合作方类型字段添加说明

## 修改概述

为 `partners` 表添加了 `partner_type` 字段，用于区分"货主"和"合作商"两种类型的合作方。

## 修改日期

2025-01-22

## 修改内容

### 1. 数据库迁移 (SQL)

**文件**: `supabase/migrations/20250122_add_partner_type.sql`

#### 主要变更：

1. **创建枚举类型**
   ```sql
   CREATE TYPE partner_type_enum AS ENUM ('货主', '合作商', '资方', '本公司');
   ```

2. **添加字段**
   ```sql
   ALTER TABLE public.partners 
       ADD COLUMN IF NOT EXISTS partner_type partner_type_enum DEFAULT '货主';
   ```

3. **创建索引**
   - `idx_partners_partner_type`: 单字段索引
   - `idx_partners_type_created`: 复合索引（类型 + 创建时间）

4. **数据迁移**
   - 所有现有记录默认设置为"货主"类型

### 2. TypeScript 类型定义

#### 更新文件：

**`src/types/index.ts`**
```typescript
export interface Partner {
  id: string;
  name: string;
  fullName?: string;
  bankAccount?: string;
  bankName?: string;
  branchName?: string;
  taxNumber?: string;
  companyAddress?: string;
  taxRate: number;
  partnerType?: '货主' | '合作商' | '资方' | '本公司'; // 新增字段
  createdAt: string;
}
```

**`src/integrations/supabase/types.ts`**
- 在 `partners.Row` 中添加: `partner_type: '货主' | '合作商' | '资方' | '本公司'`
- 在 `partners.Insert` 中添加: `partner_type?: '货主' | '合作商' | '资方' | '本公司'`
- 在 `partners.Update` 中添加: `partner_type?: '货主' | '合作商' | '资方' | '本公司'`

## 使用说明

### 1. 执行数据库迁移

```bash
# 如果使用 Supabase CLI
supabase db push

# 或者在 Supabase Dashboard 中执行 SQL 编辑器
# 复制并执行 supabase/migrations/20250122_add_partner_type.sql 的内容
```

### 2. 前端使用示例

#### 创建合作方时指定类型

```typescript
const { data, error } = await supabase
  .from('partners')
  .insert({
    name: '示例合作方',
    partner_type: '货主', // 或 '合作商'
    tax_rate: 0.13,
    // ... 其他字段
  });
```

#### 查询特定类型的合作方

```typescript
// 查询所有货主
const { data: owners } = await supabase
  .from('partners')
  .select('*')
  .eq('partner_type', '货主');

// 查询所有合作商
const { data: partners } = await supabase
  .from('partners')
  .select('*')
  .eq('partner_type', '合作商');
```

#### 更新合作方类型

```typescript
const { data, error } = await supabase
  .from('partners')
  .update({ partner_type: '货主' })
  .eq('id', partnerId);
```

### 3. 在组件中使用

```typescript
import { Partner } from '@/types';

function PartnerForm() {
  const [partnerType, setPartnerType] = useState<'货主' | '合作商' | '资方' | '本公司'>('货主');
  
  return (
    <select 
      value={partnerType} 
      onChange={(e) => setPartnerType(e.target.value as '货主' | '合作商' | '资方' | '本公司')}
    >
      <option value="货主">货主</option>
      <option value="合作商">合作商</option>
      <option value="资方">资方</option>
      <option value="本公司">本公司</option>
    </select>
  );
}
```

## 数据结构

### 字段详情

| 字段名 | 类型 | 默认值 | 必填 | 说明 |
|--------|------|--------|------|------|
| partner_type | partner_type_enum | '货主' | 否 | 合作方类型：货主或合作商 |

### 可选值

- `货主`: 货物的拥有者，委托运输的一方（**默认**）
- `合作商`: 提供运输服务的合作方
- `资方`: 提供资金支持的合作方
- `本公司`: 本公司自身记录

## 影响范围

### 已修改的文件

1. `supabase/migrations/20250122_add_partner_type.sql` - 数据库迁移文件
2. `src/types/index.ts` - 前端类型定义
3. `src/integrations/supabase/types.ts` - Supabase 类型定义

### 建议后续修改的文件

以下文件可能需要根据业务需求进行调整：

1. **`src/pages/Partners.tsx`** - 合作方列表页面
   - 添加类型筛选器
   - 在表格中显示类型列
   - 在创建/编辑表单中添加类型选择

2. **`src/components/partners/PartnerForm.tsx`** - 合作方表单（如果存在）
   - 添加类型选择下拉框

3. **相关查询和筛选器**
   - 更新合作方查询以支持按类型筛选
   - 在需要区分货主和合作商的业务逻辑中使用此字段

## 注意事项

1. **默认值**: 所有现有记录和新记录默认为"货主"类型
2. **索引优化**: 已创建索引以提升按类型查询的性能
3. **枚举类型**: 使用 PostgreSQL 枚举类型确保数据一致性
4. **兼容性**: 字段为可选字段，不会影响现有功能
5. **数据迁移**: 现有数据已自动设置为默认类型，无需手动处理

## 验证方法

### 1. 验证字段是否成功添加

```sql
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'partners' AND column_name = 'partner_type';
```

### 2. 查看枚举类型定义

```sql
SELECT enum_range(NULL::partner_type_enum);
```

### 3. 统计各类型合作方数量

```sql
SELECT partner_type, COUNT(*) as count
FROM public.partners
GROUP BY partner_type;
```

### 4. 测试查询性能

```sql
EXPLAIN ANALYZE
SELECT * FROM public.partners
WHERE partner_type = '货主'
ORDER BY created_at DESC;
```

## 回滚方案

如需回滚此修改，执行以下 SQL：

```sql
BEGIN;

-- 删除索引
DROP INDEX IF EXISTS idx_partners_type_created;
DROP INDEX IF EXISTS idx_partners_partner_type;

-- 删除字段
ALTER TABLE public.partners DROP COLUMN IF EXISTS partner_type;

-- 删除枚举类型
DROP TYPE IF EXISTS partner_type_enum;

COMMIT;
```

## 相关文档

- [合作方层级管理-使用说明.md](./合作方层级管理-使用说明.md)
- [合作方-项目关系逻辑说明](./docs/合作方-项目关系逻辑说明.md)
- [数据库结构文档](./docs/database-structure.md)

