# 合作方付款申请增量更新实现说明

## 📅 完成日期
2025-10-25

## ✨ 功能更新

根据增量更新逻辑，修改了两个核心功能的实现方式：

---

## 🔵 功能1：修改合作方运费（增量更新）

### 实现逻辑

**只更新最高级合作方的运费金额**

### 核心代码

```typescript
const handleSavePartnerCost = async () => {
  // 1. 找出最高级合作方
  const maxLevel = Math.max(...tempPartnerCosts.map(c => c.level));
  const highestLevelPartner = tempPartnerCosts.find(c => c.level === maxLevel);
  
  // 2. 只更新最高级合作方的金额
  await supabase
    .from('logistics_partner_costs')
    .update({
      payable_amount: highestLevelPartner.payable_amount,
      updated_at: new Date().toISOString()
    })
    .eq('logistics_record_id', editPartnerCostData.recordId)
    .eq('partner_id', highestLevelPartner.partner_id)
    .eq('level', maxLevel);
};
```

### 数据库操作

- ✅ **UPDATE** `logistics_partner_costs` 表
- ✅ 只更新 `payable_amount` 和 `updated_at` 字段
- ✅ 条件：`logistics_record_id` + `partner_id` + `level = maxLevel`
- ❌ **不删除** 其他层级的记录
- ❌ **不重新插入** 记录

### UI交互

**对话框显示规则**：
- **最高级合作方**：
  - 蓝色左边框
  - 浅蓝色背景
  - 输入框可编辑
  - 标签显示"(最高级)"
  
- **其他层级合作方**：
  - 灰色左边框
  - 灰色背景
  - 只读显示（不可编辑）
  - 提示：💡 低层级合作方金额由系统自动计算，不可手动修改

**排序规则**：从高到低（最高级在最上面）

### 保存流程

```
1. 点击蓝色编辑按钮
   ↓
2. 打开对话框，显示所有合作方（最高级可编辑）
   ↓
3. 修改最高级合作方的金额
   ↓
4. 点击"保存修改"
   ↓
5. 只更新最高级合作方的记录
   ↓
6. 显示成功提示："已更新最高级合作方"XX"的运费"
   ↓
7. 刷新页面数据
```

---

## 🟣 功能2：修改合作链路（完全重算）

### 实现逻辑

**删除所有旧记录 + 根据新链路重新计算所有合作方成本**

### 新建RPC函数

创建了新的数据库函数 `modify_logistics_record_chain_with_recalc`

#### 函数功能

1. **权限检查** - 只允许财务、操作员、管理员
2. **删除旧成本记录** - 删除该运单的所有 `logistics_partner_costs` 记录
3. **更新链路信息** - 更新 `logistics_records` 的 `chain_id` 和 `chain_name`
4. **重新计算成本** - 根据新链路的 `project_partners` 配置重新计算
5. **插入新记录** - 插入所有合作方的新成本记录

#### SQL文件

`supabase/migrations/20251025_fix_modify_chain_with_recalculation.sql`

### 核心逻辑

```sql
-- 1. 删除旧记录
DELETE FROM logistics_partner_costs
WHERE logistics_record_id = p_record_id;

-- 2. 更新链路
UPDATE logistics_records
SET chain_id = v_chain_id,
    chain_name = p_chain_name
WHERE id = p_record_id;

-- 3. 遍历新链路的所有合作方
FOR v_partner IN
  SELECT * FROM project_partners
  WHERE project_id = v_project_id
  AND chain_id = v_chain_id
LOOP
  -- 根据计算方法重新计算金额
  IF v_partner.calculation_method = '税点法' THEN
    v_payable_amount := v_base_amount / (1 - tax_rate);
  ELSIF v_partner.calculation_method = '利润法' THEN
    v_payable_amount := v_base_amount + (profit_rate × 有效重量);
  END IF;
  
  -- 插入新记录
  INSERT INTO logistics_partner_costs (...) VALUES (...);
  
  -- 更新基础金额供下一层级使用
  v_base_amount := v_payable_amount;
END LOOP;
```

### 前端调用

```typescript
const handleSaveChain = async (newChainId: string) => {
  // 调用新的RPC函数
  const { data, error } = await supabase.rpc(
    'modify_logistics_record_chain_with_recalc', 
    {
      p_record_id: editChainData.recordId,
      p_chain_name: selectedChain.chain_name
    }
  );
  
  // 显示重算结果
  toast({ 
    description: `已重新计算${result?.recalculated_partners || 0}个合作方的成本` 
  });
};
```

### 保存流程

```
1. 点击紫色链路按钮
   ↓
2. 打开对话框，自动加载可用链路
   ↓
3. 从下拉框选择新链路
   ↓
4. 立即触发保存（无需额外按钮）
   ↓
5. RPC函数执行：
   - 删除该运单的所有 logistics_partner_costs
   - 更新 logistics_records.chain_id 和 chain_name
   - 根据新链路的 project_partners 重新计算
   - 插入新的 logistics_partner_costs 记录
   ↓
6. 显示成功提示："已重新计算N个合作方的成本"
   ↓
7. 刷新页面数据
```

---

## 📊 两种方式对比

| 特性 | 修改合作方运费 | 修改合作链路 |
|------|--------------|-------------|
| **触发按钮** | ✏️ 蓝色编辑图标 | 🔗 紫色链路图标 |
| **更新方式** | 增量更新 | 完全重算 |
| **影响范围** | 只影响最高级 | 影响所有层级 |
| **数据库操作** | UPDATE 1条记录 | DELETE ALL + INSERT ALL |
| **是否重算** | ❌ 否 | ✅ 是 |
| **手动控制** | ✅ 精确控制金额 | ❌ 系统自动计算 |
| **适用场景** | 微调最高级运费 | 切换合作方组合 |

---

## 🔐 权限要求

两个功能都需要：
- ✅ 财务角色
- ✅ 操作员角色  
- ✅ 管理员角色

权限检查通过 `is_finance_operator_or_admin()` 函数执行

---

## ⚠️ 重要说明

### 修改合作方运费
1. **只能修改最高级合作方**的运费
2. 其他层级金额由系统根据利润率/税点自动计算
3. 这是**增量更新**，不影响其他层级
4. 适用于需要精确控制最高级运费的场景

### 修改合作链路
1. **会删除所有旧的成本记录**
2. **会重新计算所有合作方的成本**
3. 之前手动调整的金额会被覆盖
4. 这是**完全重算**，确保数据一致性
5. 适用于需要切换合作链路的场景

---

## 🎨 UI优化

### 按钮图标
- 修改运费：✏️ 编辑图标（蓝色）
- 修改链路：🔗 链路图标（紫色）

### 对话框样式
- 标题图标带彩色背景圆角框
- 运单编号使用等宽字体
- 最高级合作方突出显示
- 低层级合作方灰显不可编辑

### 提示信息
- 修改运费：显示更新的合作方名称
- 修改链路：显示重新计算的合作方数量

---

## 📁 相关文件

### 前端
- `src/pages/PaymentRequest.tsx` - 主要功能实现

### 数据库
- `supabase/migrations/20251025_fix_modify_chain_with_recalculation.sql` - 新建RPC函数

### 文档
- `合作方付款申请增量更新实现说明.md` - 本文档

---

## ✅ 测试建议

### 修改合作方运费
1. ✅ 打开对话框，确认只有最高级可编辑
2. ✅ 修改金额并保存
3. ✅ 确认只更新了最高级，其他层级未变
4. ✅ 验证 UI 显示正确

### 修改合作链路
1. ✅ 选择新链路
2. ✅ 确认删除了所有旧记录
3. ✅ 确认重新计算了所有合作方
4. ✅ 验证金额计算正确（税点法/利润法）
5. ✅ 验证层级顺序正确

### 权限测试
1. ✅ 使用不同角色测试权限限制
2. ✅ 确认无权用户看到错误提示

---

## 🚀 部署清单

在部署前确认：
- ✅ 执行 SQL 迁移文件创建新RPC函数
- ✅ RPC函数 `modify_logistics_record_chain_with_recalc` 已创建
- ✅ 权限函数 `is_finance_operator_or_admin` 存在
- ✅ 前端代码无 TypeScript 错误
- ✅ 前端代码无 Linter 错误

---

## 📝 总结

本次更新实现了正确的增量更新逻辑：

1. **修改合作方运费**：采用增量更新，只更新最高级合作方的金额，保持其他层级不变
2. **修改合作链路**：采用完全重算，删除所有旧记录并根据新链路重新计算所有合作方成本

这样的设计确保了：
- ✅ 数据一致性
- ✅ 操作的可预测性
- ✅ 灵活性（两种方式满足不同需求）
- ✅ 用户体验（UI清晰提示）

**所有功能已完成，可立即部署使用！** 🎉

