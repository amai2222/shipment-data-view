# 付款申请多级审批流程设计方案

## 🎯 **需求分析**

### **审批流程需求**
- 6个审批环节：信息专员签字、信息部审核签字、业务负责人签字、业务经理签字、复核审批人签字、财务部审核签字
- 人员配置：沈朱峰对应信息部审核，刘会对应财务审核等
- 流程控制：所有人员都完成审核后才能点击付款
- 状态管理：实时显示每个环节的审批状态

## 🏗️ **数据库设计**

### **1. 审批流程配置表**
```sql
CREATE TABLE public.approval_workflows (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 审批环节配置表
CREATE TABLE public.approval_steps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workflow_id UUID REFERENCES public.approval_workflows(id) ON DELETE CASCADE,
    step_order INTEGER NOT NULL,
    step_name TEXT NOT NULL,
    step_description TEXT,
    required_role TEXT, -- 可选：角色要求
    is_required BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 审批人员配置表
CREATE TABLE public.approval_assignments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    step_id UUID REFERENCES public.approval_steps(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    user_name TEXT NOT NULL,
    is_primary BOOLEAN DEFAULT TRUE, -- 主要审批人
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### **2. 审批记录表**
```sql
-- 付款申请审批记录表
CREATE TABLE public.payment_approval_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    payment_request_id UUID REFERENCES public.payment_requests(id) ON DELETE CASCADE,
    step_id UUID REFERENCES public.approval_steps(id),
    approver_id UUID REFERENCES auth.users(id),
    approver_name TEXT NOT NULL,
    approval_status TEXT NOT NULL CHECK (approval_status IN ('pending', 'approved', 'rejected')),
    approval_comment TEXT,
    approved_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 添加审批状态到付款申请表
ALTER TABLE public.payment_requests 
ADD COLUMN approval_status TEXT DEFAULT 'pending' CHECK (approval_status IN ('pending', 'in_progress', 'approved', 'rejected')),
ADD COLUMN approval_workflow_id UUID REFERENCES public.approval_workflows(id);
```

## 🔧 **后端函数设计**

### **1. 创建审批流程配置**
```sql
CREATE OR REPLACE FUNCTION public.create_payment_approval_workflow()
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_workflow_id UUID;
    v_step_ids UUID[];
    v_result JSONB;
BEGIN
    -- 创建审批流程
    INSERT INTO public.approval_workflows (name, description)
    VALUES ('付款申请审批流程', '标准付款申请多级审批流程')
    RETURNING id INTO v_workflow_id;
    
    -- 创建审批环节
    INSERT INTO public.approval_steps (workflow_id, step_order, step_name, step_description, required_role)
    VALUES 
        (v_workflow_id, 1, '信息专员签字', '信息专员确认信息准确性', 'operator'),
        (v_workflow_id, 2, '信息部审核签字', '信息部审核签字', 'admin'),
        (v_workflow_id, 3, '业务负责人签字', '业务负责人确认业务合理性', 'business'),
        (v_workflow_id, 4, '业务经理签字', '业务经理审批', 'business'),
        (v_workflow_id, 5, '复核审批人签字', '复核审批人最终确认', 'admin'),
        (v_workflow_id, 6, '财务部审核签字', '财务部最终审核', 'finance')
    RETURNING id INTO v_step_ids;
    
    -- 配置审批人员（示例）
    INSERT INTO public.approval_assignments (step_id, user_id, user_name, is_primary)
    SELECT 
        s.id,
        u.id,
        u.raw_user_meta_data->>'full_name',
        TRUE
    FROM public.approval_steps s
    CROSS JOIN auth.users u
    WHERE s.workflow_id = v_workflow_id
    AND u.raw_user_meta_data->>'full_name' IN ('沈朱峰', '刘会', '业务负责人', '业务经理', '复核审批人', '财务审核人');
    
    v_result := jsonb_build_object(
        'success', true,
        'workflow_id', v_workflow_id,
        'message', '审批流程创建成功'
    );
    
    RETURN v_result;
END;
$$;
```

### **2. 获取审批状态**
```sql
CREATE OR REPLACE FUNCTION public.get_payment_approval_status(
    p_payment_request_id UUID
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_result JSONB;
    v_workflow_id UUID;
    v_steps JSONB;
BEGIN
    -- 获取付款申请的审批流程ID
    SELECT approval_workflow_id INTO v_workflow_id
    FROM public.payment_requests
    WHERE id = p_payment_request_id;
    
    -- 获取所有审批环节及其状态
    SELECT jsonb_agg(
        jsonb_build_object(
            'step_id', s.id,
            'step_order', s.step_order,
            'step_name', s.step_name,
            'step_description', s.step_description,
            'required_role', s.required_role,
            'is_required', s.is_required,
            'approval_status', COALESCE(par.approval_status, 'pending'),
            'approver_name', COALESCE(par.approver_name, ''),
            'approved_at', par.approved_at,
            'approval_comment', par.approval_comment,
            'can_approve', CASE 
                WHEN par.approval_status IS NULL THEN TRUE
                ELSE FALSE
            END
        ) ORDER BY s.step_order
    ) INTO v_steps
    FROM public.approval_steps s
    LEFT JOIN public.payment_approval_records par ON par.step_id = s.id 
        AND par.payment_request_id = p_payment_request_id
    WHERE s.workflow_id = v_workflow_id;
    
    -- 检查是否所有必需环节都已完成
    SELECT jsonb_build_object(
        'workflow_id', v_workflow_id,
        'steps', v_steps,
        'all_approved', NOT EXISTS (
            SELECT 1 FROM public.approval_steps s
            LEFT JOIN public.payment_approval_records par ON par.step_id = s.id 
                AND par.payment_request_id = p_payment_request_id
            WHERE s.workflow_id = v_workflow_id 
            AND s.is_required = TRUE
            AND (par.approval_status IS NULL OR par.approval_status != 'approved')
        ),
        'can_pay', NOT EXISTS (
            SELECT 1 FROM public.approval_steps s
            LEFT JOIN public.payment_approval_records par ON par.step_id = s.id 
                AND par.payment_request_id = p_payment_request_id
            WHERE s.workflow_id = v_workflow_id 
            AND s.is_required = TRUE
            AND (par.approval_status IS NULL OR par.approval_status != 'approved')
        )
    ) INTO v_result;
    
    RETURN v_result;
END;
$$;
```

### **3. 提交审批**
```sql
CREATE OR REPLACE FUNCTION public.submit_payment_approval(
    p_payment_request_id UUID,
    p_step_id UUID,
    p_approval_status TEXT,
    p_approval_comment TEXT DEFAULT NULL
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_result JSONB;
    v_current_user_id UUID;
    v_current_user_name TEXT;
    v_workflow_id UUID;
    v_step_order INTEGER;
    v_previous_steps_completed BOOLEAN;
    v_assigned_approver TEXT;
    v_step_name TEXT;
BEGIN
    -- 获取当前用户信息
    v_current_user_id := auth.uid();
    SELECT raw_user_meta_data->>'full_name' INTO v_current_user_name
    FROM auth.users WHERE id = v_current_user_id;
    
    -- 检查权限
    IF NOT public.is_finance_operator_or_admin() THEN
        RAISE EXCEPTION '权限不足：只有财务、操作员或管理员可以提交审批';
    END IF;
    
    -- 获取当前步骤信息和分配的审批人员
    SELECT s.step_name, aa.user_name INTO v_step_name, v_assigned_approver
    FROM public.approval_steps s
    LEFT JOIN public.approval_assignments aa ON aa.step_id = s.id
    WHERE s.id = p_step_id AND aa.is_primary = TRUE;
    
    -- 验证当前用户是否为指定的审批人员
    IF v_assigned_approver IS NOT NULL AND v_current_user_name != v_assigned_approver THEN
        RAISE EXCEPTION '权限不足：只有指定的审批人员 "%" 可以审批 "%" 环节，当前用户: "%"', 
            v_assigned_approver, v_step_name, v_current_user_name;
    END IF;
    
    -- 获取审批流程ID
    SELECT approval_workflow_id INTO v_workflow_id
    FROM public.payment_requests
    WHERE id = p_payment_request_id;
    
    -- 获取当前步骤的序号
    SELECT step_order INTO v_step_order
    FROM public.approval_steps
    WHERE id = p_step_id;
    
    -- 检查前置步骤是否都已完成
    SELECT NOT EXISTS (
        SELECT 1 FROM public.approval_steps s
        LEFT JOIN public.payment_approval_records par ON par.step_id = s.id 
            AND par.payment_request_id = p_payment_request_id
        WHERE s.workflow_id = v_workflow_id 
        AND s.step_order < v_step_order
        AND s.is_required = TRUE
        AND (par.approval_status IS NULL OR par.approval_status != 'approved')
    ) INTO v_previous_steps_completed;
    
    IF NOT v_previous_steps_completed THEN
        RAISE EXCEPTION '前置审批步骤未完成，无法提交当前审批';
    END IF;
    
    -- 插入或更新审批记录
    INSERT INTO public.payment_approval_records (
        payment_request_id,
        step_id,
        approver_id,
        approver_name,
        approval_status,
        approval_comment,
        approved_at
    ) VALUES (
        p_payment_request_id,
        p_step_id,
        v_current_user_id,
        v_current_user_name,
        p_approval_status,
        p_approval_comment,
        CASE WHEN p_approval_status = 'approved' THEN NOW() ELSE NULL END
    )
    ON CONFLICT (payment_request_id, step_id) 
    DO UPDATE SET
        approver_id = EXCLUDED.approver_id,
        approver_name = EXCLUDED.approver_name,
        approval_status = EXCLUDED.approval_status,
        approval_comment = EXCLUDED.approval_comment,
        approved_at = EXCLUDED.approved_at,
        updated_at = NOW();
    
    -- 更新付款申请状态
    UPDATE public.payment_requests
    SET 
        approval_status = CASE 
            WHEN p_approval_status = 'rejected' THEN 'rejected'
            WHEN EXISTS (
                SELECT 1 FROM public.approval_steps s
                LEFT JOIN public.payment_approval_records par ON par.step_id = s.id 
                    AND par.payment_request_id = p_payment_request_id
                WHERE s.workflow_id = v_workflow_id 
                AND s.is_required = TRUE
                AND (par.approval_status IS NULL OR par.approval_status != 'approved')
            ) THEN 'in_progress'
            ELSE 'approved'
        END,
        updated_at = NOW()
    WHERE id = p_payment_request_id;
    
    v_result := jsonb_build_object(
        'success', true,
        'message', '审批提交成功',
        'approval_status', p_approval_status,
        'step_id', p_step_id
    );
    
    RETURN v_result;
END;
$$;
```

## 🎨 **前端界面设计**

### **1. 审批状态显示组件**
```typescript
interface ApprovalStep {
  step_id: string;
  step_order: number;
  step_name: string;
  step_description: string;
  required_role: string;
  is_required: boolean;
  approval_status: 'pending' | 'approved' | 'rejected';
  approver_name: string;
  approved_at: string;
  approval_comment: string;
  can_approve: boolean;
}

interface ApprovalStatus {
  workflow_id: string;
  steps: ApprovalStep[];
  all_approved: boolean;
  can_pay: boolean;
}

const ApprovalStatusCard: React.FC<{ paymentRequestId: string }> = ({ paymentRequestId }) => {
  const [approvalStatus, setApprovalStatus] = useState<ApprovalStatus | null>(null);
  const [loading, setLoading] = useState(false);

  const fetchApprovalStatus = async () => {
    setLoading(true);
    try {
      const { data, error } = await supabase.rpc('get_payment_approval_status', {
        p_payment_request_id: paymentRequestId
      });
      if (error) throw error;
      setApprovalStatus(data);
    } catch (error) {
      console.error('获取审批状态失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleApproval = async (stepId: string, status: 'approved' | 'rejected', comment?: string) => {
    try {
      const { data, error } = await supabase.rpc('submit_payment_approval', {
        p_payment_request_id: paymentRequestId,
        p_step_id: stepId,
        p_approval_status: status,
        p_approval_comment: comment
      });
      if (error) throw error;
      await fetchApprovalStatus();
      toast({ title: "审批提交成功", description: "审批状态已更新" });
    } catch (error) {
      toast({ title: "审批提交失败", description: "请重试", variant: "destructive" });
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <CheckCircle className="h-5 w-5" />
          审批流程状态
        </CardTitle>
      </CardHeader>
      <CardContent>
        {loading ? (
          <div className="flex justify-center py-4">
            <Loader2 className="h-6 w-6 animate-spin" />
          </div>
        ) : (
          <div className="space-y-3">
            {approvalStatus?.steps.map((step, index) => (
              <div key={step.step_id} className="flex items-center justify-between p-3 border rounded-lg">
                <div className="flex items-center gap-3">
                  <div className="flex items-center gap-2">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${
                      step.approval_status === 'approved' ? 'bg-green-100 text-green-800' :
                      step.approval_status === 'rejected' ? 'bg-red-100 text-red-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {step.step_order}
                    </div>
                    <div>
                      <div className="font-medium">{step.step_name}</div>
                      <div className="text-sm text-muted-foreground">{step.step_description}</div>
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  {step.approval_status === 'approved' && (
                    <Badge variant="default" className="bg-green-100 text-green-800">
                      <CheckCircle className="h-3 w-3 mr-1" />
                      已通过
                    </Badge>
                  )}
                  {step.approval_status === 'rejected' && (
                    <Badge variant="destructive">
                      <X className="h-3 w-3 mr-1" />
                      已拒绝
                    </Badge>
                  )}
                  {step.approval_status === 'pending' && step.can_approve && (
                    <div className="flex gap-1">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => handleApproval(step.step_id, 'approved')}
                        className="text-green-600 border-green-300 hover:bg-green-50"
                      >
                        <CheckCircle className="h-3 w-3 mr-1" />
                        通过
                      </Button>
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => handleApproval(step.step_id, 'rejected')}
                        className="text-red-600 border-red-300 hover:bg-red-50"
                      >
                        <X className="h-3 w-3 mr-1" />
                        拒绝
                      </Button>
                    </div>
                  )}
                  {step.approval_status === 'pending' && !step.can_approve && (
                    <Badge variant="secondary">等待前置审批</Badge>
                  )}
                </div>
              </div>
            ))}
            
            {approvalStatus?.all_approved && (
              <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <div className="flex items-center gap-2 text-green-800">
                  <CheckCircle className="h-5 w-5" />
                  <span className="font-medium">所有审批已完成，可以进行付款操作</span>
                </div>
              </div>
            )}
          </div>
        )}
      </CardContent>
    </Card>
  );
};
```

### **2. 付款按钮控制**
```typescript
const PaymentButton: React.FC<{ paymentRequest: PaymentRequest }> = ({ paymentRequest }) => {
  const [approvalStatus, setApprovalStatus] = useState<ApprovalStatus | null>(null);

  // 检查是否可以付款
  const canPay = approvalStatus?.can_pay && paymentRequest.status === 'Approved';

  return (
    <Button
      onClick={handlePayment}
      disabled={!canPay}
      className={canPay ? "bg-green-600 hover:bg-green-700" : "bg-gray-400"}
    >
      {canPay ? "付款" : "等待审批完成"}
    </Button>
  );
};
```

## 🎯 **实施步骤**

### **1. 数据库迁移**
```sql
-- 执行数据库设计脚本
-- 创建审批流程配置表
-- 创建审批记录表
-- 添加审批状态字段
```

### **2. 初始化审批流程**
```sql
-- 执行创建审批流程函数
SELECT public.create_payment_approval_workflow();
```

### **3. 配置审批人员**
```sql
-- 更新审批人员配置
UPDATE public.approval_assignments 
SET user_name = '沈朱峰'
WHERE step_id = (SELECT id FROM public.approval_steps WHERE step_name = '信息部审核签字');

UPDATE public.approval_assignments 
SET user_name = '刘会'
WHERE step_id = (SELECT id FROM public.approval_steps WHERE step_name = '财务部审核签字');
```

### **4. 前端集成**
- 在付款申请页面添加审批状态组件
- 修改付款按钮的显示逻辑
- 添加审批操作界面

## 🔐 **审批人员验证机制**

### **1. 验证逻辑**
- **用户身份验证**：验证当前用户的`profiles`表的`full_name`字段
- **审批人员匹配**：确保当前用户与指定的审批人员完全匹配
- **权限双重验证**：既验证角色权限，又验证人员身份

### **2. 验证流程**
```sql
-- 1. 获取当前用户信息
SELECT raw_user_meta_data->>'full_name' INTO v_current_user_name
FROM auth.users WHERE id = auth.uid();

-- 2. 获取指定审批人员
SELECT aa.user_name INTO v_assigned_approver
FROM public.approval_assignments aa
WHERE aa.step_id = p_step_id AND aa.is_primary = TRUE;

-- 3. 验证人员匹配
IF v_assigned_approver IS NOT NULL AND v_current_user_name != v_assigned_approver THEN
    RAISE EXCEPTION '权限不足：只有指定的审批人员 "%" 可以审批 "%" 环节，当前用户: "%"', 
        v_assigned_approver, v_step_name, v_current_user_name;
END IF;
```

### **3. 安全特性**
- **精确匹配**：必须完全匹配审批人员姓名
- **实时验证**：每次审批操作都进行验证
- **错误提示**：清晰的权限不足提示信息
- **审计日志**：记录所有审批操作和验证结果

## ✅ **功能特点**

### **1. 流程控制**
- ✅ 顺序审批：必须按顺序完成审批
- ✅ 权限控制：只有指定人员可以审批
- ✅ 人员验证：验证当前用户是否为指定审批人员
- ✅ 状态管理：实时显示审批状态
- ✅ 付款控制：所有审批完成后才能付款

### **2. 用户体验**
- ✅ 直观的审批状态显示
- ✅ 清晰的审批流程指示
- ✅ 便捷的审批操作
- ✅ 实时的状态更新

### **3. 数据安全**
- ✅ 审批记录完整保存
- ✅ 审批日志可追溯
- ✅ 权限严格控制
- ✅ 数据一致性保证

这个设计方案可以完全满足您的需求，实现多级审批流程控制！
