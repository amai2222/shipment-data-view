# 权限系统改造进度

> **更新日期**: 2025-11-02  
> **当前状态**: ✅ 统一权限检查函数已创建，不影响原有功能

---

## ✅ 已完成

### 1. 统一权限检查函数（已完成）

**Migration 文件**: `supabase/migrations/20251102_unified_permission_check_functions.sql`

**创建的函数：**
- ✅ `has_menu_permission(menu_key TEXT)` - 检查菜单权限
- ✅ `has_function_permission(function_key TEXT)` - 检查功能权限
- ✅ `has_data_permission(data_scope TEXT)` - 检查数据权限
- ✅ `has_project_permission(project_scope TEXT)` - 检查项目权限
- ✅ `is_admin()` - 检查是否为管理员（保持向后兼容）

**功能特性：**
- ✅ 支持用户自定义权限优先
- ✅ 支持角色模板权限回退
- ✅ admin 角色自动拥有所有权限（兼容性）
- ✅ 性能优化（STABLE 标记，使用 EXISTS）

---

## 🔒 兼容性保证

### 不会影响原有功能 ✅

**原因：**

1. **`is_admin()` 函数保持兼容**
   - ✅ 接口相同：`is_admin()` 无参数，返回 `BOOLEAN`
   - ✅ 行为相同：检查当前用户角色是否为 `admin`
   - ✅ 所有现有的 RLS 策略和函数调用继续工作

2. **新函数未被使用**
   - ✅ `has_menu_permission()` - 新增函数，还未被调用
   - ✅ `has_function_permission()` - 新增函数，还未被调用
   - ✅ `has_data_permission()` - 新增函数，还未被调用
   - ✅ `has_project_permission()` - 新增函数，还未被调用

3. **旧函数仍然使用原有逻辑**
   - ✅ `is_finance_operator_or_admin()` - 仍然使用硬编码角色判断
   - ✅ `can_view_partner()` - 仍然使用硬编码角色判断
   - ✅ RLS 策略 - 仍然使用 `is_admin()` 和硬编码角色判断

---

## 📋 将来需要改造的地方

### 高优先级 ⚠️

#### 1. 替换 `is_finance_operator_or_admin()` 函数

**当前状态：**
```sql
-- 硬编码：只有这三个角色
RETURN user_role IN ('admin', 'finance', 'operator');
```

**改造为：**
```sql
-- 使用权限系统
RETURN (
    v_user_role = 'admin'  -- admin 自动拥有
    OR
    public.has_function_permission('logistics.modify_chain')
);
```

**需要修改的文件：**
- `supabase/migrations/20251025_fix_modify_chain_with_recalculation.sql`
- `supabase/migrations/20251025004324_80141603-56fa-4652-9d78-408447d05eb8.sql`

**影响的函数：**
- `modify_logistics_record_chain_with_recalc()` - 修改合作链路
- `get_project_available_chains()` - 获取项目合作链路
- `validate_chain_modification_permission()` - 验证链路修改权限

---

#### 2. 替换 `can_view_partner()` 函数

**当前状态：**
```sql
-- 硬编码：管理员和财务可以查看所有
IF current_user_role IN ('admin', 'finance') THEN
    RETURN TRUE;
END IF;
```

**改造为：**
```sql
-- 使用权限系统
IF current_user_role = 'admin' THEN
    RETURN TRUE;  -- admin 保持查看所有
END IF;

IF public.has_data_permission('partner.view_all') THEN
    RETURN TRUE;  -- 有权限配置时可以查看所有
END IF;
```

**需要修改的文件：**
- `supabase/migrations/20250122_update_hierarchy_to_owner_only.sql`
- `supabase/migrations/20250121_add_partner_unlimited_hierarchy.sql`

---

#### 3. 更新 RLS 策略

**当前状态：**
```sql
-- logistics_records 表
USING (
    public.is_admin()  -- ✅ 这个已经使用函数，没问题
    OR
    project_id IN (...)
);
```

```sql
-- projects 表
USING (
    EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin')  -- ❌ 硬编码
    OR
    EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'finance')  -- ❌ 硬编码
    OR
    ...
);
```

**改造为：**
```sql
-- projects 表
USING (
    public.is_admin()  -- ✅ 使用函数
    OR
    public.has_data_permission('project.view_all')  -- ✅ 使用权限系统
    OR
    id IN (SELECT project_id FROM public.user_projects WHERE user_id = auth.uid())
);
```

**需要修改的文件：**
- `supabase/migrations/20251028_fix_projects_rls_for_mobile.sql`

---

### 中优先级 📝

#### 4. 其他使用硬编码角色判断的函数

**需要查找和替换的函数：**
- `is_finance_or_admin()` - 可能存在于多个文件
- 其他权限检查函数

**查找方法：**
```sql
-- 查找所有包含硬编码角色判断的函数
SELECT 
    proname,
    prosrc
FROM pg_proc
WHERE pronamespace = 'public'::regnamespace
  AND (
      prosrc LIKE '%role%IN%(''admin%'
      OR prosrc LIKE '%role%=''admin%'
      OR prosrc LIKE '%role%=''finance%'
  );
```

---

## 📊 改造清单

### 需要修改的文件（共约 28 个文件，90+ 处）

#### SQL 函数文件
- [ ] `20251025_fix_modify_chain_with_recalculation.sql` - `is_finance_operator_or_admin()`
- [ ] `20251025004324_80141603-56fa-4652-9d78-408447d05eb8.sql` - `is_finance_operator_or_admin()`
- [ ] `20250122_update_hierarchy_to_owner_only.sql` - `can_view_partner()`
- [ ] `20250121_add_partner_unlimited_hierarchy.sql` - `can_view_partner()`
- [ ] 其他包含硬编码角色判断的函数...

#### RLS 策略文件
- [ ] `20251028_fix_projects_rls_for_mobile.sql` - projects 表策略
- [ ] `20250116_update_database_schema_comprehensive.sql` - 其他表的策略
- [ ] 其他包含硬编码角色判断的策略...

---

## 🎯 改造步骤建议

### 阶段1：测试新函数（当前阶段）✅
- [x] 创建统一权限检查函数
- [ ] 测试新函数是否正常工作
- [ ] 验证不影响现有功能

### 阶段2：逐步替换（将来）
- [ ] 先替换简单的函数（如 `is_finance_operator_or_admin()`）
- [ ] 测试替换后的功能
- [ ] 再替换复杂的函数（如 `can_view_partner()`）
- [ ] 最后更新 RLS 策略（注意性能）

### 阶段3：完全统一（长期）
- [ ] 所有函数都使用权限系统
- [ ] 移除所有硬编码角色判断
- [ ] 性能优化和测试

---

## 📝 使用新函数的示例

### 示例1：检查菜单权限

```sql
-- 在 RLS 策略中使用
CREATE POLICY "users_can_view_own_menu"
ON public.menu_items
FOR SELECT
USING (
    public.has_menu_permission('settings.users')
);
```

### 示例2：检查功能权限

```sql
-- 在函数中使用
CREATE OR REPLACE FUNCTION modify_chain(...)
AS $$
BEGIN
    IF NOT public.has_function_permission('logistics.modify_chain') THEN
        RAISE EXCEPTION '权限不足';
    END IF;
    ...
END;
$$;
```

### 示例3：检查数据权限

```sql
-- 在 RLS 策略中使用
CREATE POLICY "users_can_view_data"
ON public.partners
FOR SELECT
USING (
    public.is_admin()
    OR
    public.has_data_permission('partner.view_all')
    OR
    user_id = auth.uid()
);
```

---

## ✅ 总结

**当前状态：**
- ✅ 统一权限检查函数已创建
- ✅ 不影响原有功能（新函数未被使用）
- ✅ `is_admin()` 保持向后兼容

**下一步：**
- 📋 将来逐步替换硬编码角色判断
- 📋 使用新的权限检查函数
- 📋 完成权限系统统一改造

**备份文件：**
- ✅ `scripts/backup_is_admin_function.sql` - 函数备份
- ✅ `scripts/export_is_admin_function.sql` - 导出脚本
- ✅ `scripts/restore_is_admin_function.sql` - 恢复脚本

---

**改造可以按需逐步进行，不影响现有功能！** ✅

