<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>物流业务跟踪系统</title>
    <meta name="description" content="高效的物流业务跟踪与统计分析系统" />
    <meta name="author" content="物流业务跟踪系统" />
    
    <!-- 内容安全策略 (CSP) - 开发环境放宽限制，允许浏览器扩展 -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.gpteng.co https://static.cloudflareinsights.com chrome-extension: moz-extension: safari-extension:; 
                   style-src 'self' 'unsafe-inline' chrome-extension: moz-extension: safari-extension:; 
                   img-src 'self' data: https: blob: chrome-extension: moz-extension: safari-extension:; 
                   font-src 'self' data: chrome-extension: moz-extension: safari-extension:; 
                   connect-src 'self' https://mnwzvtvyauyxwowjjsmf.supabase.co wss://mnwzvtvyauyxwowjjsmf.supabase.co https://static.cloudflareinsights.com https: chrome-extension: moz-extension: safari-extension:; 
                   frame-src 'self' chrome-extension: moz-extension: safari-extension:; 
                   object-src 'none'; 
                   base-uri 'self';">
    
    <!-- 缓存控制 - 强制刷新HTML -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- 版本标识 - 用于强制刷新 -->
    <meta name="version" content="2025.11.11.001">

    <meta property="og:title" content="物流业务跟踪系统" />
    <meta property="og:description" content="高效的物流业务跟踪与统计分析系统" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@lovable_dev" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
  </head>

  <body>
    <div id="root"></div>
    <!-- 提前注册错误处理器，在页面加载前捕获错误 -->
    <script>
      // 提前注册错误处理器（在React加载前）
      (function() {
        // 忽略的错误模式（浏览器扩展、Cloudflare Insights、懒加载缓存错误等非关键错误）
        const ignoredPatterns = [
          'ERR_ADDRESS_INVALID',
          'net::ERR_ADDRESS_INVALID',
          'ERR_NAME_NOT_RESOLVED',
          'ERR_CONNECTION_REFUSED',
          'ERR_FAILED',
          'cloudflareinsights',
          'beacon.min.js',
          'static.cloudflareinsights.com',
          'cloudflare',
          'chrome-extension://',
          'moz-extension://',
          'safari-extension://',
          'extension://',
          'Content Security Policy',
          'CSP',
          'violates the following Content Security Policy directive',
          'Executing inline script violates',
          'Either the \'unsafe-inline\' keyword',
          'The action has been blocked',
          'tab.js', // 浏览器扩展脚本
          'content.js',
          'background.js',
          'wasm-unsafe-eval',
          'inline-speculation-rules',
          'fleet manager projects',
          'internal driver vehicle change',
          'supabase.co/rest/v1/',
          // 懒加载缓存错误
          'SyntaxError: Unexpected token \'<\'',
          'Unexpected token \'<\'',
          '懒加载错误',
          'Lazy load error',
          'ChunkLoadError',
          'Failed to fetch dynamically imported module',
          'Loading chunk',
          // 浏览器扩展异步消息错误
          'A listener indicated an asynchronous response',
          'message channel closed',
          'asynchronous response by returning true',
          // 网络相关
          'NetworkError',
          'Failed to fetch',
          'Load failed'
        ];
        
        // 检查是否应该忽略错误
        function shouldIgnoreError(message, source) {
          const fullMessage = (message || '') + ' ' + (source || '');
          return ignoredPatterns.some(pattern => 
            fullMessage.includes(pattern)
          );
        }
        
        // 拦截console.error（包括网络错误）
        const originalError = console.error;
        console.error = function(...args) {
          const message = args.join(' ');
          if (!shouldIgnoreError(message, '')) {
            originalError.apply(console, args);
          }
        };
        
        // 拦截console.warn（网络错误有时也会显示为警告）
        const originalWarn = console.warn;
        console.warn = function(...args) {
          const message = args.join(' ');
          if (!shouldIgnoreError(message, '')) {
            originalWarn.apply(console, args);
          }
        };
        
        // 拦截window.error事件（包括资源加载错误）
        window.addEventListener('error', function(event) {
          const errorMessage = event.message || '';
          const errorSource = event.filename || event.target?.src || event.target?.href || '';
          const errorTarget = event.target;
          
          // 检查是否是资源加载错误（script、link、img等）
          if (errorTarget && (errorTarget.tagName === 'SCRIPT' || errorTarget.tagName === 'LINK' || errorTarget.tagName === 'IMG')) {
            const src = errorTarget.src || errorTarget.href || '';
            if (shouldIgnoreError(errorMessage, src)) {
              event.preventDefault();
              event.stopPropagation();
              event.stopImmediatePropagation();
              // 阻止错误冒泡到控制台
              if (errorTarget.onerror) {
                errorTarget.onerror = null;
              }
              return false;
            }
          }
          
          // 检查普通JavaScript错误
          if (shouldIgnoreError(errorMessage, errorSource)) {
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            return false;
          }
        }, true); // 使用捕获阶段，更早拦截
        
        // 额外拦截：监听资源加载错误（更早阶段）
        document.addEventListener('error', function(event) {
          const target = event.target;
          if (target && (target.tagName === 'SCRIPT' || target.tagName === 'LINK' || target.tagName === 'IMG')) {
            const src = target.src || target.href || '';
            if (shouldIgnoreError('', src)) {
              event.preventDefault();
              event.stopPropagation();
              event.stopImmediatePropagation();
              return false;
            }
          }
        }, true);
        
        // 拦截unhandledrejection
        window.addEventListener('unhandledrejection', function(event) {
          const reason = event.reason?.message || event.reason?.toString() || '';
          if (shouldIgnoreError(reason, '')) {
            event.preventDefault();
            event.stopPropagation();
            return false;
          }
        }, true);
        
        // 拦截XMLHttpRequest（更早拦截网络请求）
        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
          this._url = url;
          if (shouldIgnoreError('', url)) {
            // 标记为忽略的请求
            this._shouldIgnore = true;
          }
          return originalXHROpen.apply(this, [method, url, ...rest]);
        };
        XMLHttpRequest.prototype.send = function(...args) {
          if (this._shouldIgnore) {
            // 对于应该忽略的请求，静默处理错误
            this.addEventListener('error', function(e) {
              e.stopPropagation();
              e.preventDefault();
            }, true);
            this.addEventListener('loadend', function() {
              // 静默处理
            }, true);
          }
          return originalXHRSend.apply(this, args);
        };
        
        // 拦截fetch请求（阻止网络错误显示在控制台）
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
          const url = args[0]?.toString() || '';
          
          // 如果是应该忽略的URL，静默处理
          if (shouldIgnoreError('', url)) {
            return originalFetch.apply(this, args).catch(error => {
              // 完全静默忽略错误，不抛出，不记录
              // 返回一个已拒绝但被忽略的Promise
              return Promise.resolve(new Response(null, { 
                status: 0, 
                statusText: 'Ignored',
                ok: false 
              }));
            });
          }
          
          return originalFetch.apply(this, args);
        };
        
        // XMLHttpRequest 拦截已在上面完成，这里不再重复
      })();
    </script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
