# 付款申请单管理筛选器和分页同步完成

## 🎯 **修改内容**

根据用户要求，将付款审核页面的筛选器和分页样式完全同步到付款申请单管理页面：

### **1. 筛选器功能同步**
- **项目筛选**：新增项目筛选功能，支持按项目筛选付款申请
- **筛选器布局**：采用与付款审核相同的单行布局
- **筛选器按钮**：移到页面标题右侧，与付款审核保持一致
- **手动搜索**：移除自动搜索，改为手动搜索模式

### **2. 分页样式同步**
- **分页布局**：采用与付款审核相同的水平布局
- **分页元素**：每页显示、上一页、页码信息、下一页
- **分页样式**：与付款审核完全一致的样式

## 🔧 **技术实现**

### **新增项目筛选功能**
```typescript
// 筛选器状态增加项目ID
const [filters, setFilters] = useState({
  requestId: '',
  waybillNumber: '',
  driverName: '',
  loadingDate: null as Date | null,
  status: '',
  projectId: '' // 新增项目筛选
});

// 项目列表状态
const [projects, setProjects] = useState<Array<{id: string, name: string}>>([]);
const [loadingProjects, setLoadingProjects] = useState(false);

// 获取项目列表
const fetchProjects = useCallback(async () => {
  setLoadingProjects(true);
  try {
    const { data, error } = await supabase
      .from('projects')
      .select('id, name')
      .order('name');
    
    if (error) throw error;
    setProjects(data || []);
  } catch (error) {
    console.error('获取项目列表失败:', error);
    toast({ title: "错误", description: `获取项目列表失败: ${(error as any).message}`, variant: "destructive" });
  } finally {
    setLoadingProjects(false);
  }
}, [toast]);
```

### **RPC调用增加项目参数**
```typescript
const { data, error } = await supabase.rpc('get_payment_requests_filtered', {
  p_request_id: filters.requestId || null,
  p_waybill_number: filters.waybillNumber || null,
  p_driver_name: filters.driverName || null,
  p_loading_date: filters.loadingDate ? format(filters.loadingDate, 'yyyy-MM-dd') : null,
  p_status: filters.status || null,
  p_project_id: filters.projectId || null, // 新增项目参数
  p_limit: pageSize,
  p_offset: (currentPage - 1) * pageSize
});
```

### **筛选器处理函数优化**
```typescript
// 筛选器处理函数
const handleFilterChange = (key: string, value: any) => {
  setFilters(prev => ({ ...prev, [key]: value }));
  setCurrentPage(1); // 筛选条件变化时重置到第一页
};

const clearFilters = () => {
  setFilters({
    requestId: '',
    waybillNumber: '',
    driverName: '',
    loadingDate: null,
    status: '',
    projectId: '' // 包含项目筛选
  });
  setCurrentPage(1);
  fetchPaymentRequests(); // 清除筛选后自动搜索
};

const hasActiveFilters = filters.requestId || filters.waybillNumber || filters.driverName || filters.loadingDate || filters.status || filters.projectId;
```

### **PageHeader添加actions属性**
```typescript
<PageHeader 
  title="申请单管理" 
  description="查看和管理所有已生成的付款申请批次"
  icon={ClipboardList}
  iconColor="text-green-600"
  actions={
    <div className="flex items-center gap-2">
      {showFilters && (
        <>
          {hasActiveFilters && (
            <Button variant="outline" size="sm" onClick={clearFilters}>
              <X className="h-4 w-4 mr-1" />
              清除筛选
            </Button>
          )}
          <Button onClick={fetchPaymentRequests} size="sm">
            <Search className="h-4 w-4 mr-1" />
            搜索
          </Button>
        </>
      )}
      <Button
        variant="outline"
        size="sm"
        onClick={() => setShowFilters(!showFilters)}
        className="flex items-center gap-2"
      >
        <Search className="h-4 w-4" />
        {showFilters ? '隐藏筛选' : '显示筛选'}
        {hasActiveFilters && <Badge variant="secondary">已筛选</Badge>}
      </Button>
    </div>
  }
/>
```

### **筛选器布局同步**
```typescript
{/* 筛选器 */}
<Card>
  <CardHeader>
    <div className="flex items-center justify-between">
      <div></div>
    </div>
  </CardHeader>
  {showFilters && (
    <CardContent>
      <div className="flex flex-wrap gap-4 items-end">
        {/* 申请单号筛选 */}
        <div className="flex-1 min-w-[200px]">
          <Label htmlFor="requestId" className="text-sm font-medium">申请单号</Label>
          <Input
            id="requestId"
            placeholder="输入申请单号"
            value={filters.requestId}
            onChange={(e) => handleFilterChange('requestId', e.target.value)}
            className="mt-1"
          />
        </div>

        {/* 项目筛选 */}
        <div className="flex-1 min-w-[150px]">
          <Label htmlFor="projectId" className="text-sm font-medium flex items-center gap-1">
            <Building className="h-4 w-4" />
            项目
          </Label>
          <select
            id="projectId"
            value={filters.projectId}
            onChange={(e) => handleFilterChange('projectId', e.target.value)}
            disabled={loadingProjects}
            className="w-full px-3 py-2 border border-input bg-background rounded-md text-sm disabled:opacity-50 mt-1"
          >
            <option value="">{loadingProjects ? "加载中..." : "全部项目"}</option>
            {projects.map((project) => (
              <option key={project.id} value={project.id}>
                {project.name}
              </option>
            ))}
          </select>
        </div>

        {/* 运单号筛选 */}
        <div className="flex-1 min-w-[200px]">
          <Label htmlFor="waybillNumber" className="text-sm font-medium flex items-center gap-1">
            <FileText className="h-4 w-4" />
            运单号
          </Label>
          <Input
            id="waybillNumber"
            placeholder="输入运单编号,多个用逗号分隔..."
            value={filters.waybillNumber}
            onChange={(e) => handleFilterChange('waybillNumber', e.target.value)}
            onKeyDown={(e) => {
              if (e.key === 'Enter') {
                fetchPaymentRequests();
              }
            }}
            className="mt-1"
          />
        </div>

        {/* 司机筛选 */}
        <div className="flex-1 min-w-[150px]">
          <Label htmlFor="driverName" className="text-sm font-medium flex items-center gap-1">
            <Users className="h-4 w-4" />
            司机
          </Label>
          <Input
            id="driverName"
            placeholder="司机姓名..."
            value={filters.driverName}
            onChange={(e) => handleFilterChange('driverName', e.target.value)}
            onKeyDown={(e) => {
              if (e.key === 'Enter') {
                fetchPaymentRequests();
              }
            }}
            className="mt-1"
          />
        </div>

        {/* 装货日期筛选 */}
        <div className="flex-1 min-w-[150px]">
          <Label htmlFor="loadingDate" className="text-sm font-medium flex items-center gap-1">
            <CalendarIcon className="h-4 w-4" />
            装货日期
          </Label>
          <Popover>
            <PopoverTrigger asChild>
              <Button
                id="loadingDate"
                variant="outline"
                className={cn(
                  "w-full justify-start text-left font-normal mt-1",
                  !filters.loadingDate && "text-muted-foreground"
                )}
              >
                <CalendarIcon className="mr-2 h-4 w-4" />
                {filters.loadingDate ? format(filters.loadingDate, "yyyy-MM-dd", { locale: zhCN }) : "选择日期"}
              </Button>
            </PopoverTrigger>
            <PopoverContent className="w-auto p-0" align="start">
              <Calendar
                mode="single"
                selected={filters.loadingDate || undefined}
                onSelect={(date) => handleFilterChange('loadingDate', date)}
                initialFocus
              />
            </PopoverContent>
          </Popover>
        </div>

        {/* 状态筛选 */}
        <div className="flex-1 min-w-[150px]">
          <Label htmlFor="status" className="text-sm font-medium">申请单状态</Label>
          <select
            id="status"
            value={filters.status}
            onChange={(e) => handleFilterChange('status', e.target.value)}
            className="w-full px-3 py-2 border border-input bg-background rounded-md text-sm mt-1"
          >
            <option value="">全部状态</option>
            <option value="Pending">待审批</option>
            <option value="Approved">已审批</option>
            <option value="Paid">已付款</option>
            <option value="Rejected">已驳回</option>
          </select>
        </div>
      </div>
    </CardContent>
  )}
</Card>
```

### **分页组件样式同步**
```typescript
{/* 分页组件 */}
{totalPages > 0 && (
  <div className="flex items-center justify-center gap-4 py-4">
    {/* 每页显示 */}
    <div className="flex items-center gap-2">
      <span className="text-sm text-muted-foreground">每页显示</span>
      <select
        value={pageSize}
        onChange={(e) => handlePageSizeChange(parseInt(e.target.value))}
        className="px-2 py-1 border border-gray-300 rounded text-sm bg-white"
      >
        <option value={10}>10</option>
        <option value={20}>20</option>
        <option value={50}>50</option>
        <option value={100}>100</option>
      </select>
      <span className="text-sm text-muted-foreground">条</span>
    </div>

    {/* 上一页 */}
    <Button
      variant="outline"
      size="sm"
      onClick={() => handlePageChange(currentPage - 1)}
      disabled={currentPage <= 1}
      className="h-8 px-3"
    >
      上一页
    </Button>

    {/* 页码信息 */}
    <div className="flex items-center gap-2">
      <span className="text-sm text-muted-foreground">第</span>
      <Input
        type="number"
        value={currentPage}
        onChange={(e) => {
          const page = parseInt(e.target.value);
          if (page >= 1 && page <= totalPages) {
            handlePageChange(page);
          }
        }}
        className="w-12 h-8 text-center"
        min={1}
        max={totalPages}
      />
      <span className="text-sm text-muted-foreground">页,共{totalPages}页</span>
    </div>

    {/* 下一页 */}
    <Button
      variant="outline"
      size="sm"
      onClick={() => handlePageChange(currentPage + 1)}
      disabled={currentPage >= totalPages}
      className="h-8 px-3"
    >
      下一页
    </Button>
  </div>
)}
```

## 📋 **功能同步对比**

### **筛选器功能**
| 功能 | 付款审核 | 付款申请单管理 | 状态 |
|------|----------|----------------|------|
| 申请单号筛选 | ✅ | ✅ | 已同步 |
| 项目筛选 | ✅ | ✅ | 已同步 |
| 运单号筛选 | ✅ | ✅ | 已同步 |
| 司机筛选 | ✅ | ✅ | 已同步 |
| 装货日期筛选 | ✅ | ✅ | 已同步 |
| 状态筛选 | ✅ | ✅ | 已同步 |
| 手动搜索 | ✅ | ✅ | 已同步 |
| 清除筛选 | ✅ | ✅ | 已同步 |

### **分页功能**
| 功能 | 付款审核 | 付款申请单管理 | 状态 |
|------|----------|----------------|------|
| 每页显示 | ✅ | ✅ | 已同步 |
| 上一页按钮 | ✅ | ✅ | 已同步 |
| 页码信息 | ✅ | ✅ | 已同步 |
| 下一页按钮 | ✅ | ✅ | 已同步 |
| 水平布局 | ✅ | ✅ | 已同步 |

### **界面布局**
| 功能 | 付款审核 | 付款申请单管理 | 状态 |
|------|----------|----------------|------|
| 筛选按钮位置 | 页面标题右侧 | 页面标题右侧 | 已同步 |
| 筛选器布局 | 单行布局 | 单行布局 | 已同步 |
| 分页样式 | 水平布局 | 水平布局 | 已同步 |
| 按钮样式 | 统一样式 | 统一样式 | 已同步 |

## 🎨 **用户体验改善**

### **筛选器功能**
- ✅ **项目筛选**：新增项目筛选功能，支持按项目筛选付款申请
- ✅ **手动搜索**：移除自动搜索，改为手动搜索模式
- ✅ **按钮位置**：筛选按钮移到页面标题右侧，操作更便捷
- ✅ **布局统一**：与付款审核页面保持完全一致的布局

### **分页功能**
- ✅ **样式统一**：与付款审核页面保持完全一致的分页样式
- ✅ **操作便捷**：水平布局，操作更加直观
- ✅ **功能完整**：支持每页显示、上一页、下一页、页码跳转

### **界面一致性**
- ✅ **布局统一**：两个页面的筛选器和分页布局完全一致
- ✅ **功能统一**：两个页面的筛选和分页功能完全一致
- ✅ **样式统一**：两个页面的按钮和组件样式完全一致

## 🚀 **功能保持**

### **原有功能**
- ✅ **批量操作**：批量审批和付款功能正常
- ✅ **导出功能**：Excel导出和PDF生成功能正常
- ✅ **审批流程**：审批、付款、取消审批功能正常
- ✅ **数据刷新**：操作完成后自动刷新数据

### **新增功能**
- ✅ **项目筛选**：支持按项目筛选付款申请
- ✅ **手动搜索**：用户完全控制搜索时机
- ✅ **按钮优化**：筛选按钮移到页面标题右侧
- ✅ **布局优化**：筛选器和分页采用更简洁的布局

## 🎉 **完成状态**

### **已完成的同步**
- ✅ 项目筛选功能完全同步
- ✅ 筛选器布局完全同步
- ✅ 分页样式完全同步
- ✅ 按钮位置完全同步
- ✅ 手动搜索模式完全同步

### **用户体验**
- ✅ 两个页面功能完全一致
- ✅ 两个页面布局完全一致
- ✅ 两个页面样式完全一致
- ✅ 操作体验完全一致

**付款申请单管理筛选器和分页同步完成！现在两个页面的筛选器和分页功能完全一致，用户体验保持统一。** 🎯
