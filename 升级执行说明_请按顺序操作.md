# ä»˜æ¬¾å®¡æ ¸ç­›é€‰å™¨å‡çº§ - æ‰§è¡Œè¯´æ˜

## ğŸ“‹ æ¶‰åŠçš„å‡½æ•°

æœ¬æ¬¡å‡çº§åªä¿®æ”¹ **1ä¸ªå‡½æ•°**ï¼š

| å‡½æ•°å | è¯´æ˜ | ä¿®æ”¹ç±»å‹ |
|--------|------|---------|
| `get_payment_requests_filtered` | ä»˜æ¬¾ç”³è¯·ç­›é€‰å‡½æ•° | å‡çº§ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰ |

---

## ğŸš€ æ‰§è¡Œé¡ºåºï¼ˆé‡è¦ï¼ï¼‰

### âš ï¸ å¿…é¡»æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

```
æ­¥éª¤1: å¤‡ä»½_å‡çº§å‰è¯·å…ˆæ‰§è¡Œæ­¤æ–‡ä»¶.sql  ğŸ‘ˆ å…ˆæ‰§è¡Œå¤‡ä»½
              â†“
æ­¥éª¤2: å‡çº§ä»˜æ¬¾å®¡æ ¸ç­›é€‰å™¨_åç«¯å‡½æ•°.sql  ğŸ‘ˆ å†æ‰§è¡Œå‡çº§
              â†“
æ­¥éª¤3: æµ‹è¯•éªŒè¯æ–°åŠŸèƒ½
```

---

## ğŸ“ è¯¦ç»†æ­¥éª¤

### æ­¥éª¤1ï¸âƒ£ï¼šæ‰§è¡Œå¤‡ä»½è„šæœ¬

**æ–‡ä»¶**ï¼š`å¤‡ä»½_å‡çº§å‰è¯·å…ˆæ‰§è¡Œæ­¤æ–‡ä»¶.sql`

**æ“ä½œ**ï¼š
1. åœ¨ Supabase SQL Editor ä¸­æ‰“å¼€æ­¤æ–‡ä»¶
2. ç‚¹å‡» Run æ‰§è¡Œ
3. çœ‹åˆ° "âœ… å¤‡ä»½å®Œæˆï¼" æç¤ºå³å¯

**å¤‡ä»½å†…å®¹**ï¼š
- åˆ›å»ºå¤‡ä»½å‡½æ•°ï¼š`get_payment_requests_filtered_backup_20251026`
- ä¿å­˜å½“å‰ç‰ˆæœ¬çš„å®Œæ•´åŠŸèƒ½

**éªŒè¯å¤‡ä»½**ï¼š
```sql
-- æŸ¥çœ‹å¤‡ä»½å‡½æ•°æ˜¯å¦å­˜åœ¨
SELECT proname 
FROM pg_proc 
WHERE proname = 'get_payment_requests_filtered_backup_20251026';

-- æµ‹è¯•å¤‡ä»½å‡½æ•°æ˜¯å¦æ­£å¸¸å·¥ä½œ
SELECT * FROM get_payment_requests_filtered_backup_20251026(
    p_status := 'Pending',
    p_limit := 5
);
```

---

### æ­¥éª¤2ï¸âƒ£ï¼šæ‰§è¡Œå‡çº§è„šæœ¬

**æ–‡ä»¶**ï¼š`å‡çº§ä»˜æ¬¾å®¡æ ¸ç­›é€‰å™¨_åç«¯å‡½æ•°.sql`

**æ“ä½œ**ï¼š
1. ç¡®è®¤æ­¥éª¤1çš„å¤‡ä»½å·²æˆåŠŸ
2. åœ¨ Supabase SQL Editor ä¸­æ‰“å¼€å‡çº§è„šæœ¬
3. ç‚¹å‡» Run æ‰§è¡Œ
4. çœ‹åˆ° "âœ… get_payment_requests_filtered å‡½æ•°å‡çº§å®Œæˆ" æç¤ºå³å¯

**å‡çº§å†…å®¹**ï¼š
- åˆ é™¤æ—§ç‰ˆæœ¬å‡½æ•°
- åˆ›å»ºæ–°ç‰ˆæœ¬å‡½æ•°ï¼ˆæ”¯æŒæ‰¹é‡æœç´¢ã€æ—¥æœŸèŒƒå›´ã€å¹³å°ç­›é€‰ç­‰ï¼‰

---

### æ­¥éª¤3ï¸âƒ£ï¼šæµ‹è¯•éªŒè¯

**æµ‹è¯•ç”¨ä¾‹**ï¼ˆå·²åŒ…å«åœ¨å‡çº§è„šæœ¬ä¸­ï¼‰ï¼š

```sql
-- 1. æµ‹è¯•æ‰¹é‡è¿å•å·æœç´¢
SELECT * FROM get_payment_requests_filtered(
    p_waybill_numbers := 'HDA0648,2021991438,ABC123',
    p_limit := 10
);

-- 2. æµ‹è¯•æ‰¹é‡å¸æœºæœç´¢
SELECT * FROM get_payment_requests_filtered(
    p_driver_name := 'å¼ ä¸‰,æå››,ç‹äº”',
    p_limit := 10
);

-- 3. æµ‹è¯•æ‰¹é‡è½¦ç‰Œæœç´¢
SELECT * FROM get_payment_requests_filtered(
    p_license_plate := 'äº¬A,äº¬B,æ²ªC',
    p_limit := 10
);

-- 4. æµ‹è¯•æ—¥æœŸèŒƒå›´
SELECT * FROM get_payment_requests_filtered(
    p_start_date := '2025-01-01',
    p_end_date := '2025-10-26',
    p_limit := 10
);

-- 5. æµ‹è¯•ç»¼åˆç­›é€‰
SELECT * FROM get_payment_requests_filtered(
    p_status := 'Pending',
    p_driver_name := 'å¼ ä¸‰,æå››',
    p_waybill_numbers := 'HDA0648,2021991438',
    p_limit := 10
);
```

---

## ğŸ”„ å¦‚æœéœ€è¦å›æ»š

å¦‚æœå‡çº§åå‘ç°é—®é¢˜ï¼Œå¯ä»¥ç«‹å³å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬ï¼š

### æ–¹æ³•1ï¼šå¿«é€Ÿå›æ»šï¼ˆæ¨èï¼‰

```sql
BEGIN;

-- åˆ é™¤æ–°ç‰ˆæœ¬
DROP FUNCTION IF EXISTS public.get_payment_requests_filtered;

-- æ¢å¤ä¸ºå¤‡ä»½ç‰ˆæœ¬ï¼ˆé€šè¿‡è°ƒç”¨å¤‡ä»½å‡½æ•°ï¼‰
CREATE OR REPLACE FUNCTION public.get_payment_requests_filtered(
    p_request_id TEXT DEFAULT NULL,
    p_waybill_number TEXT DEFAULT NULL,
    p_driver_name TEXT DEFAULT NULL,
    p_loading_date DATE DEFAULT NULL,
    p_status TEXT DEFAULT NULL,
    p_project_id TEXT DEFAULT NULL,
    p_limit INTEGER DEFAULT 50,
    p_offset INTEGER DEFAULT 0
)
RETURNS TABLE (
    id UUID,
    created_at TIMESTAMP WITH TIME ZONE,
    request_id TEXT,
    status TEXT,
    notes TEXT,
    logistics_record_ids UUID[],
    record_count INTEGER,
    total_count BIGINT
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
AS $$
BEGIN
    RETURN QUERY 
    SELECT * FROM get_payment_requests_filtered_backup_20251026(
        p_request_id, p_waybill_number, p_driver_name, 
        p_loading_date, p_status, p_project_id, p_limit, p_offset
    );
END;
$$;

COMMIT;

SELECT 'âœ… å›æ»šå®Œæˆï¼' as çŠ¶æ€;
```

### æ–¹æ³•2ï¼šå‰ç«¯ä¸´æ—¶å›æ»š

å¦‚æœåç«¯æš‚æ—¶ä¸èƒ½å›æ»šï¼Œå¯ä»¥å…ˆä¿®æ”¹å‰ç«¯ä»£ç ï¼Œä½¿ç”¨å¤‡ä»½å‡½æ•°ï¼š

```typescript
// ä¸´æ—¶ä¿®æ”¹ RPC è°ƒç”¨
const { data, error } = await supabase.rpc('get_payment_requests_filtered_backup_20251026', {
  p_request_id: filters.requestId || null,
  p_waybill_number: filters.waybillNumber || null,  // æ³¨æ„ï¼šæ”¹å›å•æ•°
  p_driver_name: filters.driverName || null,
  p_loading_date: filters.loadingDate || null,      // æ³¨æ„ï¼šæ”¹å›å•ä¸ªæ—¥æœŸ
  p_status: filters.status || null,
  p_project_id: filters.projectId || null,
  p_limit: pageSize,
  p_offset: (currentPage - 1) * pageSize
});
```

---

## ğŸ“Š å‚æ•°å¯¹æ¯”

### æ—§ç‰ˆæœ¬ï¼ˆ8ä¸ªå‚æ•°ï¼‰
```sql
get_payment_requests_filtered(
    p_request_id TEXT,        -- ç”³è¯·å•å·
    p_waybill_number TEXT,    -- è¿å•å·ï¼ˆå•ä¸ªï¼‰
    p_driver_name TEXT,       -- å¸æœºï¼ˆå•ä¸ªï¼‰
    p_loading_date DATE,      -- è£…è´§æ—¥æœŸï¼ˆå•ä¸ªï¼‰
    p_status TEXT,            -- çŠ¶æ€
    p_project_id TEXT,        -- é¡¹ç›®ID
    p_limit INTEGER,          -- åˆ†é¡µé™åˆ¶
    p_offset INTEGER          -- åˆ†é¡µåç§»
)
```

### æ–°ç‰ˆæœ¬ï¼ˆ11ä¸ªå‚æ•°ï¼‰
```sql
get_payment_requests_filtered(
    p_request_id TEXT,           -- ç”³è¯·å•å·
    p_start_date TEXT,           -- ğŸ†• å¼€å§‹æ—¥æœŸ
    p_end_date TEXT,             -- ğŸ†• ç»“æŸæ—¥æœŸ
    p_status TEXT,               -- çŠ¶æ€
    p_project_id TEXT,           -- é¡¹ç›®ID
    p_waybill_numbers TEXT,      -- è¿å•å·ï¼ˆæ‰¹é‡ï¼Œæ”¹ä¸ºå¤æ•°ï¼‰
    p_driver_name TEXT,          -- å¸æœºï¼ˆæ‰¹é‡ï¼‰
    p_license_plate TEXT,        -- ğŸ†• è½¦ç‰Œå·ï¼ˆæ‰¹é‡ï¼‰
    p_driver_phone TEXT,         -- ğŸ†• ç”µè¯ï¼ˆæ‰¹é‡ï¼‰
    p_other_platform_name TEXT,  -- ğŸ†• å¹³å°åç§°
    p_limit INTEGER,             -- åˆ†é¡µé™åˆ¶
    p_offset INTEGER             -- åˆ†é¡µåç§»
)
```

---

## âœ… æ‰§è¡Œæ£€æŸ¥æ¸…å•

åœ¨æ‰§è¡Œå‡çº§å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²é˜…è¯»æœ¬æ–‡æ¡£
- [ ] å·²ç†è§£å‡çº§æ¶‰åŠçš„å‡½æ•°
- [ ] å‡†å¤‡å¥½åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
- [ ] ç¡®è®¤æœ‰æ•°æ®åº“æ“ä½œæƒé™

**æ‰§è¡Œå¤‡ä»½ï¼š**
- [ ] æ‰§è¡Œ `å¤‡ä»½_å‡çº§å‰è¯·å…ˆæ‰§è¡Œæ­¤æ–‡ä»¶.sql`
- [ ] çœ‹åˆ° "âœ… å¤‡ä»½å®Œæˆï¼" æç¤º
- [ ] éªŒè¯å¤‡ä»½å‡½æ•°å­˜åœ¨

**æ‰§è¡Œå‡çº§ï¼š**
- [ ] æ‰§è¡Œ `å‡çº§ä»˜æ¬¾å®¡æ ¸ç­›é€‰å™¨_åç«¯å‡½æ•°.sql`
- [ ] çœ‹åˆ° "âœ… å‡½æ•°å‡çº§å®Œæˆ" æç¤º
- [ ] è¿è¡Œæµ‹è¯•ç”¨ä¾‹éªŒè¯

**å‰ç«¯æµ‹è¯•ï¼š**
- [ ] æ‰“å¼€ä»˜æ¬¾å®¡æ ¸é¡µé¢
- [ ] æµ‹è¯•å¸¸è§„ç­›é€‰åŠŸèƒ½
- [ ] æµ‹è¯•é«˜çº§ç­›é€‰åŠŸèƒ½
- [ ] æµ‹è¯•æ‰¹é‡è¾“å…¥åŠŸèƒ½

---

## ğŸ†˜ é‡åˆ°é—®é¢˜ï¼Ÿ

### å¸¸è§é—®é¢˜

**Q1: æ‰§è¡Œå¤‡ä»½è„šæœ¬æŠ¥é”™ï¼Ÿ**
- A: æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®åº“ç®¡ç†å‘˜æƒé™
- A: ç¡®è®¤å½“å‰å‡½æ•°æ˜¯å¦å­˜åœ¨

**Q2: å‡çº§åå‰ç«¯æŠ¥é”™ï¼Ÿ**
- A: æ£€æŸ¥å‰ç«¯ä»£ç æ˜¯å¦å·²æ›´æ–°ï¼ˆå‚æ•°åç§°å˜åŒ–ï¼‰
- A: æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„å…·ä½“é”™è¯¯ä¿¡æ¯
- A: è€ƒè™‘å…ˆå›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬

**Q3: å¦‚ä½•éªŒè¯å‡çº§æ˜¯å¦æˆåŠŸï¼Ÿ**
- A: æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼ŒæŸ¥çœ‹è¿”å›ç»“æœ
- A: åœ¨å‰ç«¯æµ‹è¯•æ‰¹é‡æœç´¢åŠŸèƒ½
- A: æ£€æŸ¥æ•°æ®åº“æ—¥å¿—

**Q4: å¤‡ä»½å‡½æ•°ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ**
- A: ä¸ä¼šï¼Œå¤‡ä»½å‡½æ•°åªæ˜¯ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œä¸ä¼šè‡ªåŠ¨æ‰§è¡Œ

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Supabase æ—¥å¿—
2. æµè§ˆå™¨æ§åˆ¶å°
3. å‰ç«¯ä»£ç æ˜¯å¦å·²æ›´æ–°

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿç°åœ¨å¯ä»¥å¼€å§‹æ‰§è¡Œäº†ï¼** ğŸš€

