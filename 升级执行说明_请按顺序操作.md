# 付款审核筛选器升级 - 执行说明

## 📋 涉及的函数

本次升级只修改 **1个函数**：

| 函数名 | 说明 | 修改类型 |
|--------|------|---------|
| `get_payment_requests_filtered` | 付款申请筛选函数 | 升级（增强功能） |

---

## 🚀 执行顺序（重要！）

### ⚠️ 必须按照以下顺序执行：

```
步骤1: 备份_升级前请先执行此文件.sql  👈 先执行备份
              ↓
步骤2: 升级付款审核筛选器_后端函数.sql  👈 再执行升级
              ↓
步骤3: 测试验证新功能
```

---

## 📝 详细步骤

### 步骤1️⃣：执行备份脚本

**文件**：`备份_升级前请先执行此文件.sql`

**操作**：
1. 在 Supabase SQL Editor 中打开此文件
2. 点击 Run 执行
3. 看到 "✅ 备份完成！" 提示即可

**备份内容**：
- 创建备份函数：`get_payment_requests_filtered_backup_20251026`
- 保存当前版本的完整功能

**验证备份**：
```sql
-- 查看备份函数是否存在
SELECT proname 
FROM pg_proc 
WHERE proname = 'get_payment_requests_filtered_backup_20251026';

-- 测试备份函数是否正常工作
SELECT * FROM get_payment_requests_filtered_backup_20251026(
    p_status := 'Pending',
    p_limit := 5
);
```

---

### 步骤2️⃣：执行升级脚本

**文件**：`升级付款审核筛选器_后端函数.sql`

**操作**：
1. 确认步骤1的备份已成功
2. 在 Supabase SQL Editor 中打开升级脚本
3. 点击 Run 执行
4. 看到 "✅ get_payment_requests_filtered 函数升级完成" 提示即可

**升级内容**：
- 删除旧版本函数
- 创建新版本函数（支持批量搜索、日期范围、平台筛选等）

---

### 步骤3️⃣：测试验证

**测试用例**（已包含在升级脚本中）：

```sql
-- 1. 测试批量运单号搜索
SELECT * FROM get_payment_requests_filtered(
    p_waybill_numbers := 'HDA0648,2021991438,ABC123',
    p_limit := 10
);

-- 2. 测试批量司机搜索
SELECT * FROM get_payment_requests_filtered(
    p_driver_name := '张三,李四,王五',
    p_limit := 10
);

-- 3. 测试批量车牌搜索
SELECT * FROM get_payment_requests_filtered(
    p_license_plate := '京A,京B,沪C',
    p_limit := 10
);

-- 4. 测试日期范围
SELECT * FROM get_payment_requests_filtered(
    p_start_date := '2025-01-01',
    p_end_date := '2025-10-26',
    p_limit := 10
);

-- 5. 测试综合筛选
SELECT * FROM get_payment_requests_filtered(
    p_status := 'Pending',
    p_driver_name := '张三,李四',
    p_waybill_numbers := 'HDA0648,2021991438',
    p_limit := 10
);
```

---

## 🔄 如果需要回滚

如果升级后发现问题，可以立即回滚到备份版本：

### 方法1：快速回滚（推荐）

```sql
BEGIN;

-- 删除新版本
DROP FUNCTION IF EXISTS public.get_payment_requests_filtered;

-- 恢复为备份版本（通过调用备份函数）
CREATE OR REPLACE FUNCTION public.get_payment_requests_filtered(
    p_request_id TEXT DEFAULT NULL,
    p_waybill_number TEXT DEFAULT NULL,
    p_driver_name TEXT DEFAULT NULL,
    p_loading_date DATE DEFAULT NULL,
    p_status TEXT DEFAULT NULL,
    p_project_id TEXT DEFAULT NULL,
    p_limit INTEGER DEFAULT 50,
    p_offset INTEGER DEFAULT 0
)
RETURNS TABLE (
    id UUID,
    created_at TIMESTAMP WITH TIME ZONE,
    request_id TEXT,
    status TEXT,
    notes TEXT,
    logistics_record_ids UUID[],
    record_count INTEGER,
    total_count BIGINT
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path TO 'public'
AS $$
BEGIN
    RETURN QUERY 
    SELECT * FROM get_payment_requests_filtered_backup_20251026(
        p_request_id, p_waybill_number, p_driver_name, 
        p_loading_date, p_status, p_project_id, p_limit, p_offset
    );
END;
$$;

COMMIT;

SELECT '✅ 回滚完成！' as 状态;
```

### 方法2：前端临时回滚

如果后端暂时不能回滚，可以先修改前端代码，使用备份函数：

```typescript
// 临时修改 RPC 调用
const { data, error } = await supabase.rpc('get_payment_requests_filtered_backup_20251026', {
  p_request_id: filters.requestId || null,
  p_waybill_number: filters.waybillNumber || null,  // 注意：改回单数
  p_driver_name: filters.driverName || null,
  p_loading_date: filters.loadingDate || null,      // 注意：改回单个日期
  p_status: filters.status || null,
  p_project_id: filters.projectId || null,
  p_limit: pageSize,
  p_offset: (currentPage - 1) * pageSize
});
```

---

## 📊 参数对比

### 旧版本（8个参数）
```sql
get_payment_requests_filtered(
    p_request_id TEXT,        -- 申请单号
    p_waybill_number TEXT,    -- 运单号（单个）
    p_driver_name TEXT,       -- 司机（单个）
    p_loading_date DATE,      -- 装货日期（单个）
    p_status TEXT,            -- 状态
    p_project_id TEXT,        -- 项目ID
    p_limit INTEGER,          -- 分页限制
    p_offset INTEGER          -- 分页偏移
)
```

### 新版本（11个参数）
```sql
get_payment_requests_filtered(
    p_request_id TEXT,           -- 申请单号
    p_start_date TEXT,           -- 🆕 开始日期
    p_end_date TEXT,             -- 🆕 结束日期
    p_status TEXT,               -- 状态
    p_project_id TEXT,           -- 项目ID
    p_waybill_numbers TEXT,      -- 运单号（批量，改为复数）
    p_driver_name TEXT,          -- 司机（批量）
    p_license_plate TEXT,        -- 🆕 车牌号（批量）
    p_driver_phone TEXT,         -- 🆕 电话（批量）
    p_other_platform_name TEXT,  -- 🆕 平台名称
    p_limit INTEGER,             -- 分页限制
    p_offset INTEGER             -- 分页偏移
)
```

---

## ✅ 执行检查清单

在执行升级前，请确认：

- [ ] 已阅读本文档
- [ ] 已理解升级涉及的函数
- [ ] 准备好在 Supabase SQL Editor 中执行
- [ ] 确认有数据库操作权限

**执行备份：**
- [ ] 执行 `备份_升级前请先执行此文件.sql`
- [ ] 看到 "✅ 备份完成！" 提示
- [ ] 验证备份函数存在

**执行升级：**
- [ ] 执行 `升级付款审核筛选器_后端函数.sql`
- [ ] 看到 "✅ 函数升级完成" 提示
- [ ] 运行测试用例验证

**前端测试：**
- [ ] 打开付款审核页面
- [ ] 测试常规筛选功能
- [ ] 测试高级筛选功能
- [ ] 测试批量输入功能

---

## 🆘 遇到问题？

### 常见问题

**Q1: 执行备份脚本报错？**
- A: 检查是否有数据库管理员权限
- A: 确认当前函数是否存在

**Q2: 升级后前端报错？**
- A: 检查前端代码是否已更新（参数名称变化）
- A: 查看浏览器控制台的具体错误信息
- A: 考虑先回滚到备份版本

**Q3: 如何验证升级是否成功？**
- A: 执行测试用例，查看返回结果
- A: 在前端测试批量搜索功能
- A: 检查数据库日志

**Q4: 备份函数会影响性能吗？**
- A: 不会，备份函数只是保存在数据库中，不会自动执行

---

## 📞 支持

如有问题，请检查：
1. Supabase 日志
2. 浏览器控制台
3. 前端代码是否已更新

---

**准备好了吗？现在可以开始执行了！** 🚀

