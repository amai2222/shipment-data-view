# 审核管理权限问题修复指南

## 🚨 **问题说明**
执行权限更新SQL脚本时出现错误：`relation "role_templates" does not exist`

## 🔍 **问题分析**
- 实际的表名是 `role_permission_templates`，不是 `role_templates`
- 用户表是 `profiles`，不是 `users`
- 需要先检查表结构，再执行更新

## ✅ **解决方案**

### 1. **先检查表结构**
执行 `检查权限表结构.sql` 脚本，确认：
- 表名是否正确
- 字段是否存在
- 数据是否正常

### 2. **使用安全版更新脚本**
执行 `审核管理权限更新_安全版.sql` 脚本：
- 自动检查表是否存在
- 安全执行权限更新
- 提供详细的执行日志

### 3. **手动权限配置（备选方案）**
如果SQL脚本仍有问题，可以通过前端界面配置：

#### 步骤：
1. **登录管理员账户**
2. **进入设置 → 权限配置**
3. **选择需要配置的用户**
4. **在菜单权限中勾选"审核管理"相关权限**
5. **保存配置**

## 🔧 **技术细节**

### 实际数据库表结构：
```sql
-- 角色权限模板表
role_permission_templates (
  id uuid,
  role app_role,
  menu_permissions text[],
  function_permissions text[],
  project_permissions text[],
  data_permissions text[],
  updated_at timestamp
)

-- 用户权限表
user_permissions (
  id uuid,
  user_id uuid,
  menu_permissions text[],
  function_permissions text[],
  project_permissions text[],
  data_permissions text[]
)

-- 用户信息表
profiles (
  id uuid,
  email text,
  role app_role
)
```

### 权限更新逻辑：
1. **角色模板权限**：更新 `role_permission_templates` 表
2. **用户权限继承**：用户权限 = 用户自定义权限 || 角色模板权限
3. **菜单显示**：根据用户权限动态显示菜单

## 📋 **执行步骤**

### 步骤1：检查表结构
```sql
-- 执行检查权限表结构.sql
-- 确认表名和字段正确
```

### 步骤2：更新权限
```sql
-- 执行审核管理权限更新_安全版.sql
-- 安全更新角色模板权限
```

### 步骤3：验证结果
```sql
-- 检查更新结果
SELECT role, menu_permissions 
FROM role_permission_templates 
WHERE role IN ('admin', 'finance', 'operator');
```

### 步骤4：测试前端
1. 刷新浏览器页面
2. 检查左侧菜单是否显示"审核管理"
3. 测试访问付款审核和开票审核页面

## ⚠️ **注意事项**

### 1. **表名错误**
- ❌ `role_templates` （不存在）
- ✅ `role_permission_templates` （正确）

### 2. **用户表错误**
- ❌ `users` （不存在）
- ✅ `profiles` （正确）

### 3. **权限继承**
- 用户自定义权限 > 角色模板权限
- 如果用户有自定义权限，需要单独更新

## 🎯 **预期结果**

执行成功后，应该看到：
1. **角色模板权限**：包含 `audit`, `audit.invoice`, `audit.payment`
2. **菜单显示**：管理员、财务、操作员能看到"审核管理"菜单
3. **功能访问**：可以正常访问付款审核和开票审核页面

## 🚀 **快速修复**

如果SQL脚本仍有问题，最快的解决方案：

1. **通过前端界面配置**：
   - 设置 → 权限配置
   - 选择用户 → 勾选审核管理权限
   - 保存配置

2. **重启应用**：
   - 清除浏览器缓存
   - 重新登录系统

**现在使用修复后的SQL脚本，应该可以成功更新权限配置！** 🎉
