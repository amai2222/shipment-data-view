# 批量修改应收和链路功能使用说明

## ✨ 新增功能

为付款审核页面添加了两个批量操作功能：
1. **批量修改应收** - 批量修改最高级合作方的应付金额
2. **批量修改合作链路** - 批量修改运单的合作链路并自动重算成本

---

## 📋 部署步骤

### 步骤1：部署后端函数

在 **Supabase Dashboard → SQL Editor** 中**按顺序**执行以下两个SQL文件：

#### 1.1 先执行链路修改函数修复
```
合作链路修改-使用正确重算逻辑.sql
```

#### 1.2 再执行批量操作函数
```
supabase/migrations/20251025_add_batch_modify_functions.sql
```

### 步骤2：前端已自动更新
前端代码已更新，无需额外操作。

### 步骤3：刷新浏览器
按 `Ctrl + Shift + R` 强制刷新浏览器

---

## 🎯 功能使用说明

### 功能1：批量修改应收

#### 适用场景
- 需要统一调整多个运单的最高级合作方应付金额
- 例如：批量将应收改为3000元

#### 操作步骤
1. 进入**合作方付款申请**页面
2. 使用筛选条件找到需要修改的运单
3. 勾选要修改的运单（可多选）
4. 点击**"批量修改应收"**按钮
5. 输入新的金额（例如：3000）
6. 点击**"确认修改"**
7. 系统会显示成功/失败的数量

#### 限制条件
- ✅ 只能修改"未支付"状态的运单
- ✅ 只能修改"未开票"状态的运单
- ✅ 只会修改最高级合作方的金额
- ⚠️ 已申请付款或已开票的运单会被自动跳过

#### 返回信息
```
成功更新 5 条运单，失败 2 条
```
- 失败的运单会在控制台输出详细信息（F12查看）

---

### 功能2：批量修改合作链路

#### 适用场景
- 需要批量更换运单的合作链路
- 例如：从"成丰6"批量改为"线下张海宽"

#### 操作步骤
1. 进入**合作方付款申请**页面
2. 使用筛选条件找到需要修改的运单
3. 勾选要修改的运单（必须属于同一个项目）
4. 点击**"批量修改链路"**按钮
5. 从下拉列表选择新的合作链路
6. 点击**"确认修改"**
7. 系统会自动重新计算所有合作方成本

#### 限制条件
- ✅ 所选运单必须属于同一个项目
- ✅ 只能修改"未支付"状态的运单
- ✅ 只能修改"未开票"状态的运单
- ✅ 目标链路必须已配置合作方
- ⚠️ 已申请付款或已开票的运单会被自动跳过

#### 返回信息
```
成功更新 5 条运单，重新计算 15 个合作方成本，失败 2 条
```
- 失败的运单会在控制台输出详细原因（F12查看）

---

## 🖥️ UI位置

### 批量操作按钮位置
当选择了运单后，会在筛选器下方显示选择提示栏：

```
┌─────────────────────────────────────────────────────────────┐
│ 已选择 3 条记录  [清除选择]  [批量修改应收] [批量修改链路] │
└─────────────────────────────────────────────────────────────┘
```

### 单个操作按钮位置
在运单列表的每一行的最右侧"操作"列：
- ✏️ 修改应收（单个）
- 🔗 修改链路（单个）

---

## 🔧 后端函数说明

### 函数1：batch_modify_partner_cost
**参数：**
- `p_record_ids`: UUID[] - 运单ID数组
- `p_new_amount`: NUMERIC - 新的应付金额

**返回：**
```json
{
  "success": true,
  "updated_count": 5,
  "failed_count": 2,
  "failed_records": ["YDN001(已付款)", "YDN002(已开票)"],
  "message": "成功更新 5 条运单，失败 2 条"
}
```

**处理逻辑：**
1. 检查权限（必须是财务/操作员/管理员）
2. 遍历每个运单ID
3. 检查运单状态（未支付、未开票）
4. 查找最高级合作方
5. 更新最高级合作方的 `payable_amount`
6. 统计成功/失败数量

### 函数2：batch_modify_chain
**参数：**
- `p_record_ids`: UUID[] - 运单ID数组
- `p_chain_name`: TEXT - 新的链路名称

**返回：**
```json
{
  "success": true,
  "updated_count": 5,
  "failed_count": 2,
  "total_partners": 15,
  "failed_records": ["YDN001(已付款)", "YDN002(指定的合作链路不存在)"],
  "message": "成功更新 5 条运单，重新计算 15 个合作方成本，失败 2 条"
}
```

**处理逻辑：**
1. 检查权限（必须是财务/操作员/管理员）
2. 遍历每个运单ID
3. 调用 `modify_logistics_record_chain_with_recalc` 处理单个运单
4. 累计成功/失败数量和重算的合作方数量

---

## 🔍 故障排除

### 问题1：批量修改按钮不显示
**原因**：没有选择运单  
**解决**：先勾选至少一条运单

### 问题2：批量修改链路时提示"所选运单必须属于同一个项目"
**原因**：选择了不同项目的运单  
**解决**：使用项目筛选器，只选择同一项目的运单

### 问题3：所有运单都修改失败
**原因**：可能是权限问题或运单状态问题  
**解决**：
1. 检查当前用户角色是否为财务/操作员/管理员
2. 确认运单状态为"未支付"且"未开票"
3. 按F12查看控制台的详细错误信息

### 问题4：批量修改链路后显示"重新计算0个合作方"
**原因**：目标链路没有配置合作方  
**解决**：在项目管理页面为该链路添加合作方配置

---

## 🎨 UI改进

### 批量操作提示栏
- 🎨 渐变背景（蓝色系）
- 📊 实时显示选中数量
- 🔘 两个批量操作按钮横向排列
- ❌ 清除选择按钮

### 对话框设计
- 🎨 带图标的标题（绿色编辑图标 / 紫色链路图标）
- 📝 清晰的输入区域
- ⚠️ 黄色/蓝色提示框说明注意事项
- 🔄 加载状态显示

---

## 📂 相关文件

### 后端
- `supabase/migrations/20251025_add_batch_modify_functions.sql` - 批量操作函数
- `supabase/migrations/20251025_fix_modify_chain_with_recalculation.sql` - 链路修改函数（已修复）
- `合作链路修改-使用正确重算逻辑.sql` - 可执行的修复SQL

### 前端
- `src/pages/PaymentRequest.tsx` - 付款审核页面（已更新）

### 文档
- `链路修改成本重算逻辑修复总结.md` - 重算逻辑说明
- `执行指南-最终版.md` - 执行指南

---

## ⚡ 权限要求

所有修改操作（单个或批量）都需要以下角色之一：
- ✅ 管理员 (admin)
- ✅ 财务 (finance)
- ✅ 操作员 (operator)

其他角色无法执行修改操作。

---

## 🚀 快速开始

1. ✅ 执行 `合作链路修改-使用正确重算逻辑.sql`
2. ✅ 执行 `supabase/migrations/20251025_add_batch_modify_functions.sql`
3. ✅ 刷新浏览器
4. ✅ 开始使用批量修改功能！

