# 项目看板司机应收总额功能部署指南

## 部署概述

本指南说明如何安全地部署新的项目看板功能，将"平均单位成本"改为"司机应收总额"，同时保持原有功能的完整性以便回滚。

## 部署步骤

### 第一步：执行数据库脚本

1. **执行新函数创建脚本**：
   ```sql
   -- 在Supabase SQL Editor中执行
   \i 新建项目看板RPC函数-添加司机应收总额.sql
   ```

2. **执行项目概览函数创建脚本**：
   ```sql
   -- 在Supabase SQL Editor中执行
   \i 新建项目概览RPC函数-添加司机应收总额.sql
   ```

3. **验证函数创建成功**：
   ```sql
   -- 检查新函数是否存在
   SELECT proname FROM pg_proc 
   WHERE proname IN (
     'get_projects_overview_with_driver_receivable',
     'get_all_projects_overview_data_with_driver_receivable'
   );
   ```

### 第二步：测试新函数

1. **测试项目看板函数**：
   ```sql
   SELECT get_projects_overview_with_driver_receivable('2025-01-15', NULL, NULL);
   ```

2. **测试项目概览函数**：
   ```sql
   SELECT get_all_projects_overview_data_with_driver_receivable(CURRENT_DATE, NULL);
   ```

3. **验证返回数据包含司机应收总额字段**：
   检查返回的JSON中是否包含 `total_driver_receivable` 字段。

### 第三步：部署前端代码

前端代码已经更新完成，包括：
- ✅ `src/services/DashboardDataService.ts` - 使用新函数
- ✅ `src/pages/ProjectsOverview.tsx` - 使用新函数
- ✅ 所有相关类型定义已更新
- ✅ 桌面端和移动端显示已更新

### 第四步：验证功能

1. **访问项目看板页面**
2. **检查显示内容**：
   - 确认显示"司机应收总额"而不是"平均单位成本"
   - 确认数值正确显示
   - 确认单位显示为"元"

3. **测试不同项目**：
   - 切换不同项目
   - 检查数据是否正确更新

4. **测试移动端**：
   - 在移动设备上访问
   - 确认显示一致

## 回滚方案

如果发现新功能有问题，可以快速回滚：

### 方法一：使用回滚脚本

```sql
-- 在Supabase SQL Editor中执行
\i 回滚项目看板函数-恢复原函数.sql
```

### 方法二：手动回滚前端代码

1. **恢复DashboardDataService.ts**：
   ```typescript
   const { data, error } = await supabase.rpc('get_all_projects_overview_data' as any, params);
   ```

2. **恢复ProjectsOverview.tsx**：
   ```typescript
   const { data, error } = await supabase.rpc('get_all_projects_overview_data' as any, params);
   ```

3. **恢复显示内容**：
   - 将"司机应收总额"改回"平均单位成本"
   - 将 `total_driver_receivable` 改回 `avg_cost`
   - 将单位从"元"改回"元/吨"

## 验证清单

### 数据库验证
- [ ] 新函数 `get_projects_overview_with_driver_receivable` 创建成功
- [ ] 新函数 `get_all_projects_overview_data_with_driver_receivable` 创建成功
- [ ] 原函数 `get_all_projects_overview_data` 仍然存在
- [ ] 新函数返回数据包含 `total_driver_receivable` 字段

### 前端验证
- [ ] 项目看板显示"司机应收总额"
- [ ] 数值正确显示
- [ ] 单位显示为"元"
- [ ] 桌面端和移动端显示一致
- [ ] 切换项目时数据正确更新

### 功能验证
- [ ] 司机应收总额与实际的司机费用记录一致
- [ ] 不同项目的司机应收总额正确计算
- [ ] 日期筛选功能正常
- [ ] 项目筛选功能正常

## 注意事项

1. **数据一致性**：确保司机应收总额的计算逻辑正确
2. **性能影响**：新函数可能对性能有轻微影响，需要监控
3. **缓存清理**：部署后可能需要清理浏览器缓存
4. **用户培训**：通知用户界面变化

## 故障排除

### 常见问题

1. **函数不存在错误**：
   - 检查函数是否正确创建
   - 确认函数名称拼写正确

2. **数据显示错误**：
   - 检查 `logistics_partner_costs` 表数据
   - 确认 `level = 1` 的记录存在

3. **前端显示问题**：
   - 检查浏览器控制台错误
   - 确认类型定义正确

### 联系支持

如果遇到问题，请提供：
- 错误信息截图
- 浏览器控制台日志
- 数据库查询结果
- 具体的操作步骤

## 总结

本次部署采用了新建函数的方式，确保了原有功能的完整性。如果出现问题，可以快速回滚到原来的状态。部署完成后，项目看板将显示更直观的司机应收总额信息。
