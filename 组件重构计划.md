# 组件重构计划 - 减少重复代码

## 重构目标

在不修改后端函数的前提下，提取可复用组件，减少前端重复代码，提高代码质量和可维护性。

---

## 一、重复代码分析

### 1. 分页组件（重复度：⭐⭐⭐⭐⭐）

**重复页面**:
- `InvoiceRequestManagement.tsx` (财务开票)
- `InvoiceAudit.tsx` (开票审核)  
- `PaymentRequestsList.tsx` (财务付款)
- `PaymentAudit.tsx` (付款审核)

**重复代码**（每个页面约50行）:
```tsx
<div className="flex items-center justify-center gap-4 py-2">
  {/* 每页显示下拉框 */}
  {/* 上一页按钮 */}
  {/* 页码输入框 */}
  {/* 下一页按钮 */}
</div>
```

**重构方案**: ✅ 已创建 `PaginationControl` 组件

---

### 2. 状态徽章（重复度：⭐⭐⭐⭐⭐）

**重复页面**: 所有申请单和运单相关页面

**重复代码**（每个页面约30-50行）:
```typescript
const getStatusBadgeVariant = (status: string) => {
  switch (status) {
    case 'Pending': return 'secondary';
    case 'Approved': return 'default';
    // ...
  }
};

const getStatusText = (status: string) => {
  switch (status) {
    case 'Pending': return '待审核';
    case 'Approved': return '已通过';
    // ...
  }
};

<Badge variant={getStatusBadgeVariant(status)}>
  {getStatusText(status)}
</Badge>
```

**重构方案**: ✅ 已创建 `StatusBadge` 组件

---

### 3. 批量操作栏（重复度：⭐⭐⭐⭐）

**重复页面**:
- 财务开票
- 开票审核
- 财务付款
- 付款审核

**重复代码**:
```tsx
{selection.selectedIds.size > 0 && (
  <div className="flex items-center gap-2">
    <span>已选择 {selectionCount} 个申请单</span>
    <ConfirmDialog title="..." onConfirm={...}>
      <Button>批量操作</Button>
    </ConfirmDialog>
  </div>
)}
```

**重构方案**: ✅ 已创建 `BulkActionBar` 组件

---

### 4. 表格头部（重复度：⭐⭐⭐⭐）

**重复代码**:
```tsx
<TableHeader>
  <TableRow>
    <TableHead className="w-12">
      <Checkbox checked={...} onCheckedChange={...} />
    </TableHead>
    <TableHead>申请单号</TableHead>
    <TableHead>合作方</TableHead>
    // ...
  </TableRow>
</TableHeader>
```

**重构方案**: ✅ 已创建 `RequestTableHeader` 组件

---

### 5. 筛选器组件（重复度：⭐⭐⭐⭐）

**重复元素**:
- 申请单号输入框（带批量输入按钮）
- 运单号输入框（带批量输入按钮）
- 状态下拉框
- 项目下拉框
- 日期选择器
- 搜索/清除按钮

**重构方案**: 待创建 `FilterPanel` 组件

---

### 6. 批量输入对话框（重复度：⭐⭐⭐）

**当前状态**: 已有 `BatchInputDialog` 组件
**使用页面**: 多个页面都在使用
**状态**: ✅ 无需重构

---

### 7. 确认对话框（重复度：⭐⭐⭐）

**当前状态**: 已有 `ConfirmDialog` 组件
**使用页面**: 多个页面都在使用
**状态**: ✅ 无需重构

---

## 二、已创建的可复用组件

### 1. PaginationControl（分页控制）

**文件**: `src/components/common/PaginationControl.tsx`

**Props**:
```typescript
interface PaginationControlProps {
  currentPage: number;
  pageSize: number;
  totalPages: number;
  totalCount?: number;
  onPageChange: (page: number) => void;
  onPageSizeChange: (size: number) => void;
  pageSizeOptions?: number[];
  className?: string;
}
```

**使用示例**:
```tsx
<PaginationControl
  currentPage={currentPage}
  pageSize={pageSize}
  totalPages={totalPages}
  totalCount={totalRequestsCount}
  onPageChange={setCurrentPage}
  onPageSizeChange={handlePageSizeChange}
/>
```

**优势**:
- ✅ 统一的UI样式
- ✅ 灵活的配置选项
- ✅ 自动隐藏（totalPages=0时）
- ✅ 可选显示总记录数

---

### 2. StatusBadge（状态徽章）

**文件**: `src/components/common/StatusBadge.tsx`

**Props**:
```typescript
interface StatusBadgeProps {
  status: string;
  customConfig?: Record<string, { label: string; variant: string }>;
  className?: string;
}
```

**使用示例**:
```tsx
// 使用预置配置
<StatusBadge status="Pending" />

// 使用自定义配置
<StatusBadge 
  status="CustomStatus" 
  customConfig={{
    CustomStatus: { label: '自定义状态', variant: 'default' }
  }}
/>
```

**预置状态**: 
- Pending, Processing, Approved, Completed
- Rejected, Voided, Cancelled
- Paid, Unpaid
- Invoiced, Uninvoiced
- Merged

**优势**:
- ✅ 统一的状态显示
- ✅ 支持自定义状态
- ✅ 颜色编码一致
- ✅ 减少重复的switch语句

---

### 3. BulkActionBar（批量操作栏）

**文件**: `src/components/common/BulkActionBar.tsx`

**Props**:
```typescript
interface BulkAction {
  key: string;
  label: string;
  icon?: ReactNode;
  variant?: 'default' | 'outline' | 'destructive';
  className?: string;
  confirmTitle?: string;
  confirmDescription?: string;
  onClick: () => void | Promise<void>;
  disabled?: boolean;
  needConfirm?: boolean;
}

interface BulkActionBarProps {
  selectedCount: number;
  actions: BulkAction[];
  isProcessing?: boolean;
  className?: string;
}
```

**使用示例**:
```tsx
<BulkActionBar
  selectedCount={selection.selectedIds.size}
  isProcessing={isBatchProcessing}
  actions={[
    {
      key: 'invoice',
      label: '批量开票',
      icon: <CheckCircle className="mr-2 h-4 w-4" />,
      variant: 'default',
      className: 'bg-green-600 hover:bg-green-700 text-white',
      needConfirm: true,
      confirmTitle: '确认批量开票',
      confirmDescription: '此操作将完成选中申请单的开票...',
      onClick: handleBatchInvoice
    },
    {
      key: 'void',
      label: '一键作废',
      icon: <Trash2 className="mr-2 h-4 w-4" />,
      variant: 'destructive',
      needConfirm: true,
      confirmTitle: '确认作废',
      confirmDescription: '此操作不可逆...',
      onClick: handleBatchVoid
    }
  ]}
/>
```

**优势**:
- ✅ 统一的批量操作UI
- ✅ 自动集成确认对话框
- ✅ 配置式定义操作
- ✅ 自动隐藏（selectedCount=0时）

---

### 4. RequestTableHeader（表格头部）

**文件**: `src/components/common/RequestTableHeader.tsx`

**Props**:
```typescript
interface TableColumn {
  key: string;
  label: string;
  className?: string;
  align?: 'left' | 'center' | 'right';
}

interface RequestTableHeaderProps {
  columns: TableColumn[];
  showCheckbox?: boolean;
  allSelected?: boolean;
  onSelectAll?: (checked: boolean) => void;
}
```

**使用示例**:
```tsx
<RequestTableHeader
  showCheckbox={true}
  allSelected={isAllOnPageSelected}
  onSelectAll={handleSelectAllOnPage}
  columns={[
    { key: 'request_number', label: '申请单号' },
    { key: 'partner', label: '合作方' },
    { key: 'amount', label: '开票金额', align: 'right' },
    { key: 'count', label: '运单数量', align: 'right' },
    { key: 'status', label: '状态' },
    { key: 'time', label: '创建时间' },
    { key: 'actions', label: '操作', align: 'center' }
  ]}
/>
```

**优势**:
- ✅ 统一的表头样式
- ✅ 自动处理全选复选框
- ✅ 灵活的列配置
- ✅ 支持对齐方式

---

## 三、待创建的组件

### 5. FilterPanel（筛选器面板）

**目标**: 统一的筛选器UI

**Props设计**:
```typescript
interface FilterField {
  key: string;
  label: string;
  type: 'input' | 'select' | 'date' | 'batch-input';
  placeholder?: string;
  options?: Array<{ value: string; label: string }>;
  icon?: ReactNode;
  enableBatchInput?: boolean;
}

interface FilterPanelProps {
  fields: FilterField[];
  values: Record<string, any>;
  onChange: (key: string, value: any) => void;
  onSearch: () => void;
  onClear: () => void;
  showAdvanced?: boolean;
  onToggleAdvanced?: () => void;
  advancedFields?: FilterField[];
}
```

---

### 6. RequestListCard（申请单列表卡片）

**目标**: 统一的列表卡片容器

**功能**:
- 表格容器
- 加载状态
- 空数据提示
- 批量操作栏集成

---

### 7. ActionButtons（操作按钮组）

**目标**: 统一的操作按钮组

**功能**:
- 查看按钮
- 编辑按钮
- 删除按钮
- 自定义操作按钮
- 自动布局

---

## 四、重构执行计划

### Phase 1: 基础组件创建 ✅

- [x] PaginationControl
- [x] StatusBadge
- [x] BulkActionBar
- [x] RequestTableHeader

### Phase 2: 高级组件创建

- [ ] FilterPanel
- [ ] RequestListCard
- [ ] ActionButtons

### Phase 3: 页面重构

#### 优先级1（核心页面）:
- [ ] InvoiceRequestManagement.tsx (财务开票)
- [ ] InvoiceAudit.tsx (开票审核)

#### 优先级2（财务页面）:
- [ ] PaymentRequestsList.tsx (财务付款)
- [ ] PaymentAudit.tsx (付款审核)

#### 优先级3（其他页面）:
- [ ] PaymentRequest.tsx
- [ ] InvoiceRequest.tsx
- [ ] 其他需要的页面

---

## 五、重构收益预估

### 代码减少量

| 组件 | 每个页面减少行数 | 使用页面数 | 总减少行数 |
|------|----------------|-----------|-----------|
| PaginationControl | 50行 | 4页面 | 200行 |
| StatusBadge | 40行 | 10页面 | 400行 |
| BulkActionBar | 30行 | 4页面 | 120行 |
| RequestTableHeader | 20行 | 6页面 | 120行 |
| **预计总计** | - | - | **~840行** |

### 质量提升

- ✅ 减少40%重复代码
- ✅ 统一UI/UX体验
- ✅ 提高可维护性
- ✅ 降低bug率
- ✅ 加快新功能开发

---

## 六、重构原则

### 1. 不破坏现有功能
- 所有重构必须保证功能完全一致
- 测试每个重构后的页面
- 保留现有的业务逻辑

### 2. 渐进式重构
- 一次重构一个组件
- 先创建新组件
- 再逐步替换旧代码
- 保留旧代码作为备份

### 3. 向下兼容
- 新组件支持灵活配置
- 兼容不同页面的特殊需求
- 提供默认值

### 4. 文档完整
- 每个组件都有JSDoc注释
- 提供使用示例
- 记录Props说明

---

## 七、使用示例

### 重构前的代码（InvoiceRequestManagement.tsx）

```tsx
// 150行的分页、状态、批量操作代码
const [currentPage, setCurrentPage] = useState(1);
const [pageSize, setPageSize] = useState(20);
// ...

const getStatusBadgeVariant = (status) => { /* 30行 */ };
const getStatusText = (status) => { /* 30行 */ };

// JSX中
{totalPages > 0 && (
  <div className="flex items-center justify-center gap-4 py-2">
    {/* 50行分页代码 */}
  </div>
)}

{selection.selectedIds.size > 0 && (
  <div className="flex items-center gap-2">
    {/* 40行批量操作代码 */}
  </div>
)}

<Badge variant={getStatusBadgeVariant(request.status)}>
  {getStatusText(request.status)}
</Badge>
```

### 重构后的代码

```tsx
// 导入可复用组件
import { PaginationControl } from '@/components/common/PaginationControl';
import { StatusBadge } from '@/components/common/StatusBadge';
import { BulkActionBar } from '@/components/common/BulkActionBar';

// JSX中（只需要几行）
<PaginationControl
  currentPage={currentPage}
  pageSize={pageSize}
  totalPages={totalPages}
  onPageChange={setCurrentPage}
  onPageSizeChange={handlePageSizeChange}
/>

<BulkActionBar
  selectedCount={selection.selectedIds.size}
  actions={bulkActions}
/>

<StatusBadge status={request.status} />
```

**代码减少**: ~120行 → ~10行（减少90%）

---

## 八、下一步行动

### 立即执行

1. **测试已创建的组件**
   - PaginationControl
   - StatusBadge
   - BulkActionBar
   - RequestTableHeader

2. **重构第一个页面（财务开票）**
   - 替换分页组件
   - 替换状态徽章
   - 替换批量操作栏
   - 测试功能完整性

3. **创建剩余组件**
   - FilterPanel
   - RequestListCard
   - ActionButtons

4. **逐步重构其他页面**
   - 开票审核
   - 财务付款
   - 付款审核
   - 其他页面

---

## 九、风险控制

### 风险识别

1. **功能破坏**: 重构可能导致功能异常
2. **样式不一致**: 新组件样式可能不匹配
3. **性能问题**: 组件抽象可能影响性能

### 风险缓解

1. **备份代码**: 重构前备份原文件
2. **增量测试**: 每次重构后立即测试
3. **回滚机制**: 保留原代码，出问题可快速回滚
4. **对比测试**: 新旧版本对比确认一致

---

## 十、预期成果

### 短期成果（1周内）
- ✅ 4个基础组件创建完成
- ✅ 2个核心页面完成重构
- ✅ 减少约400行重复代码

### 中期成果（1个月内）
- ✅ 7个可复用组件完成
- ✅ 所有核心页面完成重构
- ✅ 减少约800行重复代码
- ✅ 统一UI/UX体验

### 长期成果（持续优化）
- ✅ 建立组件库文档
- ✅ 新功能开发效率提升50%
- ✅ Bug率降低30%
- ✅ 代码可维护性大幅提升

---

**创建日期**: 2025-10-27  
**状态**: ✅ Phase 1 完成，准备开始 Phase 2

