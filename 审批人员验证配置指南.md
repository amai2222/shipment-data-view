# 审批人员验证配置指南

## 🎯 **验证目标**

确保付款申请审批流程中的审批人员验证机制正常工作，通过验证当前用户的`profiles`表的`full_name`字段与指定的审批人员完全匹配。

## 🔐 **验证机制**

### **1. 验证原理**
- **身份验证**：系统验证当前用户的`auth.users.raw_user_meta_data->>'full_name'`字段
- **人员匹配**：确保当前用户与`approval_assignments.user_name`完全匹配
- **权限控制**：只有匹配的审批人员才能进行审批操作

### **2. 验证流程**
```
用户登录 → 获取用户full_name → 查询审批人员配置 → 验证匹配 → 允许/拒绝审批
```

## 📋 **配置步骤**

### **第一步：检查用户配置**

#### **1. 查看所有用户的full_name配置**
```sql
-- 查看所有用户的full_name配置
SELECT 
    id,
    email,
    raw_user_meta_data->>'full_name' as full_name,
    created_at
FROM auth.users 
ORDER BY created_at DESC;
```

#### **2. 检查审批人员用户是否存在**
```sql
-- 检查审批人员用户是否存在
SELECT 
    id,
    email,
    raw_user_meta_data->>'full_name' as full_name
FROM auth.users 
WHERE raw_user_meta_data->>'full_name' IN (
    '沈朱峰', '刘会', '信息专员', '业务负责人', '业务经理', '复核审批人'
);
```

### **第二步：配置审批人员**

#### **1. 更新用户full_name（如果需要）**
```sql
-- 更新用户的full_name字段
UPDATE auth.users 
SET raw_user_meta_data = raw_user_meta_data || '{"full_name": "沈朱峰"}'::jsonb
WHERE email = 'shenzhufeng@example.com';

UPDATE auth.users 
SET raw_user_meta_data = raw_user_meta_data || '{"full_name": "刘会"}'::jsonb
WHERE email = 'liuhui@example.com';
```

#### **2. 配置审批人员分配**
```sql
-- 配置审批人员分配
SELECT public.assign_approval_users(
    (SELECT id FROM public.approval_workflows WHERE name = '付款申请审批流程'),
    '[
        {"step_name": "信息专员签字", "user_name": "信息专员"},
        {"step_name": "信息部审核签字", "user_name": "沈朱峰"},
        {"step_name": "业务负责人签字", "user_name": "业务负责人"},
        {"step_name": "业务经理签字", "user_name": "业务经理"},
        {"step_name": "复核审批人签字", "user_name": "复核审批人"},
        {"step_name": "财务部审核签字", "user_name": "刘会"}
    ]'::jsonb
);
```

### **第三步：验证配置**

#### **1. 验证审批人员配置**
```sql
-- 验证审批人员配置
SELECT 
    s.step_name,
    aa.user_name as assigned_approver,
    CASE 
        WHEN EXISTS (
            SELECT 1 FROM auth.users u 
            WHERE u.raw_user_meta_data->>'full_name' = aa.user_name
        ) THEN '✅ 用户存在'
        ELSE '❌ 用户不存在'
    END as user_exists
FROM public.approval_assignments aa
JOIN public.approval_steps s ON s.id = aa.step_id
WHERE aa.is_primary = TRUE
ORDER BY s.step_order;
```

#### **2. 验证用户匹配**
```sql
-- 验证用户匹配情况
SELECT 
    s.step_name,
    aa.user_name as assigned_approver,
    u.raw_user_meta_data->>'full_name' as current_user_name,
    CASE 
        WHEN u.raw_user_meta_data->>'full_name' = aa.user_name THEN '✅ 匹配'
        WHEN u.raw_user_meta_data->>'full_name' IS NULL THEN '❌ 用户未配置full_name'
        ELSE '❌ 不匹配'
    END as verification_result
FROM public.approval_assignments aa
JOIN public.approval_steps s ON s.id = aa.step_id
LEFT JOIN auth.users u ON u.raw_user_meta_data->>'full_name' = aa.user_name
WHERE aa.is_primary = TRUE
ORDER BY s.step_order;
```

## 🧪 **测试验证**

### **1. 功能测试**
```sql
-- 测试审批人员验证功能
-- 1. 使用沈朱峰账户登录，尝试审批"信息部审核签字"环节
-- 2. 使用刘会账户登录，尝试审批"财务部审核签字"环节
-- 3. 使用其他用户登录，尝试审批，应该被拒绝
```

### **2. 权限测试**
```sql
-- 测试权限验证
-- 1. 测试正确的审批人员可以审批
-- 2. 测试错误的审批人员被拒绝
-- 3. 测试未配置full_name的用户被拒绝
```

## 🚨 **常见问题解决**

### **问题1：用户full_name字段为空**
**症状**：审批时提示"用户未配置full_name"
**解决**：
```sql
-- 更新用户的full_name字段
UPDATE auth.users 
SET raw_user_meta_data = raw_user_meta_data || '{"full_name": "正确的姓名"}'::jsonb
WHERE id = '用户ID';
```

### **问题2：姓名不匹配**
**症状**：审批时提示"只有指定的审批人员可以审批"
**解决**：
1. 检查审批人员配置是否正确
2. 检查用户full_name是否与配置一致
3. 确保大小写完全匹配

### **问题3：权限不足**
**症状**：审批时提示"权限不足：只有财务、操作员或管理员可以提交审批"
**解决**：
```sql
-- 更新用户角色
UPDATE public.user_profiles 
SET role = 'finance' 
WHERE user_id = '用户ID';
```

## 📊 **配置检查清单**

### **✅ 用户配置检查**
- [ ] 所有审批人员用户都存在
- [ ] 所有审批人员都配置了正确的full_name
- [ ] 所有审批人员都有正确的角色权限

### **✅ 审批人员配置检查**
- [ ] 审批人员分配配置正确
- [ ] 审批人员姓名与用户full_name完全匹配
- [ ] 审批流程配置完整

### **✅ 功能测试检查**
- [ ] 正确的审批人员可以审批
- [ ] 错误的审批人员被拒绝
- [ ] 审批顺序控制正常
- [ ] 付款控制正常

## 🎯 **最佳实践**

### **1. 用户管理**
- 确保所有审批人员都有正确的full_name配置
- 定期检查用户配置的一致性
- 使用统一的命名规范

### **2. 权限管理**
- 确保审批人员有正确的角色权限
- 定期检查权限配置
- 记录权限变更日志

### **3. 测试验证**
- 定期测试审批流程
- 验证权限控制
- 检查数据一致性

## 📝 **总结**

审批人员验证机制是付款申请审批流程的重要安全特性，确保只有指定的审批人员才能进行审批操作。通过正确的配置和测试，可以确保系统的安全性和可靠性。

**关键要点**：
1. 用户full_name配置必须正确
2. 审批人员分配必须准确
3. 权限验证必须严格
4. 测试验证必须完整
