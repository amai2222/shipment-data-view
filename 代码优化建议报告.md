# ä»£ç ä¼˜åŒ–å»ºè®®æŠ¥å‘Š

## ğŸ“Š å®¡æ ¸æ¦‚è¿°

**å®¡æ ¸æ—¶é—´**: 2025-01-28  
**å®¡æ ¸ç±»å‹**: å…¨é¢ä»£ç å®¡æ ¸  
**ä»£ç åº“è§„æ¨¡**: 145ä¸ªæ–‡ä»¶ï¼Œ599å¤„consoleæ—¥å¿—  

## ğŸ¯ ä¼˜åŒ–å»ºè®®åˆ†ç±»

### 1. é«˜ä¼˜å…ˆçº§ä¼˜åŒ– ğŸ”´

#### 1.1 æ¸…ç†è°ƒè¯•æ—¥å¿—
**é—®é¢˜**: å‘ç° 599 å¤„ console.log/warn/error è°ƒç”¨
```typescript
// é—®é¢˜ä»£ç ç¤ºä¾‹
console.log(`æ£€æŸ¥èœå•æƒé™: ${menuKey} - ${hasMenuAccess(menuKey)}`);
console.log(`å½“å‰ç”¨æˆ·è§’è‰²: ${role}, ç”¨æˆ·ä¿¡æ¯:`, profile);
```

**å½±å“**:
- ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¸‹é™
- æ•æ„Ÿä¿¡æ¯å¯èƒ½æ³„éœ²åˆ°æµè§ˆå™¨æ§åˆ¶å°
- å¢åŠ ä»£ç ä½“ç§¯

**å»ºè®®**:
1. åˆ›å»ºç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†ç³»ç»Ÿ
2. æ ¹æ®ç¯å¢ƒå˜é‡æ§åˆ¶æ—¥å¿—è¾“å‡º
3. ç”Ÿäº§ç¯å¢ƒç¦ç”¨è°ƒè¯•æ—¥å¿—

**å®ç°æ–¹æ¡ˆ**:
```typescript
// utils/logger.ts
const isDevelopment = import.meta.env.DEV;

export const logger = {
  debug: (...args: any[]) => {
    if (isDevelopment) {
      console.log('[DEBUG]', ...args);
    }
  },
  info: (...args: any[]) => {
    console.info('[INFO]', ...args);
  },
  warn: (...args: any[]) => {
    console.warn('[WARN]', ...args);
  },
  error: (...args: any[]) => {
    console.error('[ERROR]', ...args);
  }
};

// ä½¿ç”¨ç¤ºä¾‹
logger.debug('èœå•æƒé™æ£€æŸ¥:', menuKey, hasAccess);
```

---

#### 1.2 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
**é—®é¢˜**: å¤šå¤„å­˜åœ¨ä¸²è¡ŒæŸ¥è¯¢å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ

```typescript
// å½“å‰å®ç° - ä¸²è¡ŒæŸ¥è¯¢
const { data: user } = await supabase.from('profiles').select('role').eq('id', userId).single();
const { data: roleTemplate } = await supabase.from('role_permission_templates').select('*').eq('role', user.role).single();
const { data: userPermissions } = await supabase.from('user_permissions').select('*').eq('user_id', userId).single();
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```typescript
// ä¼˜åŒ–å - å¹¶è¡ŒæŸ¥è¯¢
const [userResult, roleTemplateResult, userPermissionsResult] = await Promise.all([
  supabase.from('profiles').select('role').eq('id', userId).single(),
  supabase.from('role_permission_templates').select('*').eq('role', userRole).single(),
  supabase.from('user_permissions').select('*').eq('user_id', userId).maybeSingle()
]);
```

**é¢„æœŸæ”¶ç›Š**: æŸ¥è¯¢æ—¶é—´å‡å°‘ 60-70%

---

#### 1.3 æ·»åŠ æ•°æ®åº“ç´¢å¼•
**é—®é¢˜**: é¢‘ç¹æŸ¥è¯¢çš„å­—æ®µç¼ºå°‘ç´¢å¼•

**å»ºè®®æ·»åŠ çš„ç´¢å¼•**:
```sql
-- æƒé™è¡¨ç´¢å¼•ä¼˜åŒ–
CREATE INDEX IF NOT EXISTS idx_user_permissions_user_id_project_id 
ON public.user_permissions(user_id, project_id);

CREATE INDEX IF NOT EXISTS idx_user_permissions_created_at 
ON public.user_permissions(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_role_permission_templates_role 
ON public.role_permission_templates(role);

-- å®¡è®¡æ—¥å¿—ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_permission_audit_logs_created_at 
ON public.permission_audit_logs(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_permission_audit_logs_user_action 
ON public.permission_audit_logs(user_id, action);
```

---

### 2. ä¸­ä¼˜å…ˆçº§ä¼˜åŒ– ğŸŸ¡

#### 2.1 ç»„ä»¶é‡å¤æ¸²æŸ“ä¼˜åŒ–
**é—®é¢˜**: éƒ¨åˆ†ç»„ä»¶å­˜åœ¨ä¸å¿…è¦çš„é‡å¤æ¸²æŸ“

**å½“å‰å®ç°**:
```typescript
// AppSidebar.tsx
const filteredMenuItems = menuItems.map(group => ({
  ...group,
  items: group.items.filter(item => {
    // ... å¤æ‚çš„æƒé™æ£€æŸ¥é€»è¾‘
    return hasMenuAccess(menuKey);
  })
}));
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ
const filteredMenuItems = useMemo(() => {
  return menuItems.map(group => ({
    ...group,
    items: group.items.filter(item => {
      // ... æƒé™æ£€æŸ¥é€»è¾‘
      return hasMenuAccess(menuKey);
    })
  })).filter(group => group.items.length > 0);
}, [menuItems, hasMenuAccess]);
```

---

#### 2.2 ä¼˜åŒ–æƒé™æ£€æŸ¥ç¼“å­˜ç­–ç•¥
**é—®é¢˜**: æƒé™ç¼“å­˜æ—¶é—´ä¸ç»Ÿä¸€ï¼Œå¯èƒ½å¯¼è‡´ä¸ä¸€è‡´

**å½“å‰æƒ…å†µ**:
- `useAPICache`: 5åˆ†é’Ÿç¼“å­˜
- `useOptimizedData`: 30ç§’ç¼“å­˜
- `useRealtimePermissionCache`: 2åˆ†é’Ÿç¼“å­˜

**ä¼˜åŒ–å»ºè®®**:
```typescript
// config/cacheConfig.ts
export const CACHE_CONFIG = {
  // æƒé™ç›¸å…³
  PERMISSION_TTL: 5 * 60 * 1000, // 5åˆ†é’Ÿ
  ROLE_TEMPLATE_TTL: 10 * 60 * 1000, // 10åˆ†é’Ÿ
  USER_PROFILE_TTL: 3 * 60 * 1000, // 3åˆ†é’Ÿ
  
  // ä¸šåŠ¡æ•°æ®
  DASHBOARD_DATA_TTL: 2 * 60 * 1000, // 2åˆ†é’Ÿ
  LIST_DATA_TTL: 1 * 60 * 1000, // 1åˆ†é’Ÿ
};
```

---

#### 2.3 å‡å°‘ä¾èµ–æ•°ç»„è­¦å‘Š
**é—®é¢˜**: useEffect/useCallback ä¾èµ–æ•°ç»„ä¸å®Œæ•´

**å»ºè®®**:
```typescript
// é—®é¢˜ä»£ç 
useEffect(() => {
  loadPermissions();
}, []); // ç¼ºå°‘ loadPermissions ä¾èµ–

// ä¼˜åŒ–æ–¹æ¡ˆ1: ä½¿ç”¨ useCallback
const loadPermissions = useCallback(async () => {
  // ... åŠ è½½é€»è¾‘
}, [/* å¿…è¦çš„ä¾èµ– */]);

useEffect(() => {
  loadPermissions();
}, [loadPermissions]);

// ä¼˜åŒ–æ–¹æ¡ˆ2: å¦‚æœç¡®å®åªéœ€è¦è¿è¡Œä¸€æ¬¡
useEffect(() => {
  loadPermissions();
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, []);
```

---

### 3. ä½ä¼˜å…ˆçº§ä¼˜åŒ– ğŸŸ¢

#### 3.1 ä»£ç é‡å¤åº¦ä¼˜åŒ–
**é—®é¢˜**: å¤šä¸ªæƒé™æ£€æŸ¥å‡½æ•°é€»è¾‘ç›¸ä¼¼

**å»ºè®®**: åˆ›å»ºé€šç”¨æƒé™æ£€æŸ¥å·¥å…·å‡½æ•°
```typescript
// utils/permissionUtils.ts
export function createPermissionChecker(
  userRole: string,
  permissions: string[] | null | undefined
) {
  return (key: string): boolean => {
    if (!key) return false;
    if (userRole === 'admin') return true;
    if (!permissions) return false;
    return permissions.includes(key) || permissions.includes('all');
  };
}

// ä½¿ç”¨ç¤ºä¾‹
const hasMenuAccess = createPermissionChecker(userRole, menuPermissions);
const hasFunctionAccess = createPermissionChecker(userRole, functionPermissions);
```

---

#### 3.2 TypeScript ç±»å‹å®‰å…¨æ€§æå‡
**é—®é¢˜**: éƒ¨åˆ†åœ°æ–¹ä½¿ç”¨ any ç±»å‹

**å»ºè®®**:
```typescript
// é—®é¢˜ä»£ç 
const [roleTemplates, setRoleTemplates] = useState<Record<string, any>>({});
const [users, setUsers] = useState<any[]>([]);

// ä¼˜åŒ–å
interface RoleTemplate {
  role: string;
  menu_permissions: string[];
  function_permissions: string[];
  project_permissions: string[];
  data_permissions: string[];
}

interface User {
  id: string;
  email: string;
  role: UserRole;
  // ...
}

const [roleTemplates, setRoleTemplates] = useState<Record<string, RoleTemplate>>({});
const [users, setUsers] = useState<User[]>([]);
```

---

#### 3.3 é”™è¯¯è¾¹ç•Œå’Œé”™è¯¯å¤„ç†
**é—®é¢˜**: ç¼ºå°‘å…¨å±€é”™è¯¯è¾¹ç•Œ

**å»ºè®®**: æ·»åŠ Reacté”™è¯¯è¾¹ç•Œ
```typescript
// components/ErrorBoundary.tsx
export class ErrorBoundary extends React.Component<
  { children: React.ReactNode },
  { hasError: boolean; error?: Error }
> {
  constructor(props: any) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    logger.error('React Error Boundary:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return <ErrorFallback error={this.state.error} />;
    }
    return this.props.children;
  }
}
```

---

### 4. æ€§èƒ½ä¼˜åŒ–å»ºè®® âš¡

#### 4.1 è™šæ‹ŸåŒ–é•¿åˆ—è¡¨
**ç°çŠ¶**: å·²å®ç°éƒ¨åˆ†è™šæ‹ŸåŒ–ç»„ä»¶ âœ…
- `OptimizedVirtualTable`
- `VirtualizedTable`

**å»ºè®®**: æ‰©å±•åˆ°æ‰€æœ‰é•¿åˆ—è¡¨åœºæ™¯

---

#### 4.2 ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½
**å»ºè®®**: è·¯ç”±çº§åˆ«çš„ä»£ç åˆ†å‰²
```typescript
// App.tsx æˆ–è·¯ç”±é…ç½®æ–‡ä»¶
const BusinessEntry = lazy(() => import('@/pages/BusinessEntry'));
const FinanceReconciliation = lazy(() => import('@/pages/FinanceReconciliation'));
const ContractManagement = lazy(() => import('@/pages/ContractManagement'));

// ä½¿ç”¨ Suspense
<Suspense fallback={<LoadingSpinner />}>
  <Routes>
    <Route path="/business-entry" element={<BusinessEntry />} />
    <Route path="/finance/reconciliation" element={<FinanceReconciliation />} />
    <Route path="/contracts" element={<ContractManagement />} />
  </Routes>
</Suspense>
```

---

#### 4.3 å›¾ç‰‡æ‡’åŠ è½½
**å»ºè®®**: ä½¿ç”¨åŸç”Ÿæ‡’åŠ è½½æˆ– IntersectionObserver
```typescript
// ç»„ä»¶ä¸­
<img 
  src={imageUrl} 
  loading="lazy" 
  alt={altText}
/>
```

---

### 5. å®‰å…¨æ€§ä¼˜åŒ– ğŸ”’

#### 5.1 æ•æ„Ÿæ•°æ®å¤„ç†
**é—®é¢˜**: Console.log å¯èƒ½æš´éœ²æ•æ„Ÿä¿¡æ¯

**å»ºè®®**:
1. ç§»é™¤ç”Ÿäº§ç¯å¢ƒçš„æ•æ„Ÿä¿¡æ¯æ—¥å¿—
2. ä½¿ç”¨æ•°æ®è„±æ•å¤„ç†
3. å®¡è®¡æƒé™ç›¸å…³æ—¥å¿—

---

#### 5.2 XSS é˜²æŠ¤
**å»ºè®®**: ç¡®ä¿ç”¨æˆ·è¾“å…¥æ­£ç¡®è½¬ä¹‰
```typescript
// ä½¿ç”¨ DOMPurify æ¸…ç† HTML
import DOMPurify from 'dompurify';

const sanitizedHtml = DOMPurify.sanitize(userInput);
```

---

## ğŸ“ˆ ä¼˜åŒ–å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ (1-2å‘¨)
- [x] ä¿®å¤æƒé™ç®¡ç†æ ¸å¿ƒé—®é¢˜
- [ ] åˆ›å»ºç»Ÿä¸€æ—¥å¿—ç®¡ç†ç³»ç»Ÿ
- [ ] ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼ˆå¹¶è¡ŒåŒ–ï¼‰
- [ ] æ·»åŠ å…³é”®æ•°æ®åº“ç´¢å¼•

### ç¬¬äºŒé˜¶æ®µ (2-3å‘¨)
- [ ] ä¼˜åŒ–ç»„ä»¶é‡å¤æ¸²æŸ“
- [ ] ç»Ÿä¸€ç¼“å­˜ç­–ç•¥
- [ ] æ¸…ç†ç”Ÿäº§ç¯å¢ƒ console.log
- [ ] æ·»åŠ é”™è¯¯è¾¹ç•Œ

### ç¬¬ä¸‰é˜¶æ®µ (3-4å‘¨)
- [ ] ä»£ç é‡å¤åº¦ä¼˜åŒ–
- [ ] TypeScript ç±»å‹å®Œå–„
- [ ] è·¯ç”±çº§ä»£ç åˆ†å‰²
- [ ] æ€§èƒ½ç›‘æ§å’Œåˆ†æ

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### æ€§èƒ½æå‡
- **é¦–å±åŠ è½½æ—¶é—´**: å‡å°‘ 30-40%
- **æƒé™æ£€æŸ¥å“åº”**: å‡å°‘ 50-60%
- **æ•°æ®åº“æŸ¥è¯¢**: å‡å°‘ 60-70%
- **ç»„ä»¶æ¸²æŸ“**: å‡å°‘ 40-50%

### ä»£ç è´¨é‡
- **å¯ç»´æŠ¤æ€§**: æå‡ 50%
- **ç±»å‹å®‰å…¨**: æå‡ 70%
- **é”™è¯¯å¤„ç†**: æå‡ 80%

### ç”¨æˆ·ä½“éªŒ
- **é¡µé¢å“åº”é€Ÿåº¦**: æå‡ 40%
- **äº¤äº’æµç•…åº¦**: æå‡ 50%
- **é”™è¯¯æ¢å¤èƒ½åŠ›**: æå‡ 90%

---

## ğŸ“ ä¼˜åŒ–æ¸…å•

### é«˜ä¼˜å…ˆçº§ âœ…
- [x] æƒé™ç®¡ç†æ ¸å¿ƒä¿®å¤
- [ ] æ—¥å¿—ç³»ç»Ÿé‡æ„
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] ç´¢å¼•ä¼˜åŒ–

### ä¸­ä¼˜å…ˆçº§
- [ ] ç»„ä»¶æ¸²æŸ“ä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥ç»Ÿä¸€
- [ ] ä¾èµ–æ•°ç»„ä¿®å¤

### ä½ä¼˜å…ˆçº§
- [ ] ä»£ç é‡å¤ä¼˜åŒ–
- [ ] TypeScript å®Œå–„
- [ ] é”™è¯¯è¾¹ç•Œæ·»åŠ 

---

## ğŸ”§ å·¥å…·å’Œç›‘æ§å»ºè®®

### æ€§èƒ½ç›‘æ§
```typescript
// utils/performanceMonitor.ts
export const measurePerformance = (name: string, fn: () => void) => {
  const start = performance.now();
  fn();
  const end = performance.now();
  logger.debug(`[Performance] ${name}: ${(end - start).toFixed(2)}ms`);
};
```

### é”™è¯¯è¿½è¸ª
- å»ºè®®é›†æˆ Sentry æˆ–å…¶ä»–é”™è¯¯è¿½è¸ªå·¥å…·
- è®°å½•æƒé™é”™è¯¯å’Œæ•°æ®åº“é”™è¯¯
- ç›‘æ§ API å“åº”æ—¶é—´

### æ€§èƒ½åˆ†æ
- ä½¿ç”¨ React DevTools Profiler
- ä½¿ç”¨ Chrome DevTools Performance
- å®šæœŸè¿›è¡Œ Lighthouse å®¡è®¡

---

## æ€»ç»“

**å½“å‰ä»£ç è´¨é‡**: â­â­â­â­ è‰¯å¥½  
**ä¼˜åŒ–æ½œåŠ›**: â­â­â­â­â­ å·¨å¤§  
**å®æ–½éš¾åº¦**: â­â­â­ ä¸­ç­‰  

é€šè¿‡å®æ–½ä»¥ä¸Šä¼˜åŒ–å»ºè®®ï¼Œç³»ç»Ÿæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒå°†å¾—åˆ°æ˜¾è‘—æå‡ã€‚å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥å®æ–½ï¼Œå¹¶åœ¨æ¯ä¸ªé˜¶æ®µè¿›è¡Œæ€§èƒ½æµ‹è¯•å’ŒéªŒè¯ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-28  
**ä¸‹æ¬¡å®¡æ ¸å»ºè®®**: ä¼˜åŒ–å®æ–½å 1ä¸ªæœˆ
