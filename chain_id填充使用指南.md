# chain_id 填充使用指南

## 📋 背景

系统中很多运单的 `chain_id` 字段为 NULL，这导致：
- 修改项目配置后，自动重算功能无法找到这些运单
- 运费对账数据不准确
- 无法正确关联合作方成本

## 🎯 解决方案

使用项目的**默认链路**（最早创建的链路）来填充缺失的 `chain_id`。

## 📊 执行步骤

### 第一步：检查当前情况

在 Supabase Dashboard SQL Editor 中执行：

```sql
-- 执行 检查chain_id缺失情况.sql
```

**查看结果**：
- 有多少运单缺失 chain_id
- 哪些项目受影响
- 每个项目有几条链路

### 第二步：执行填充

```sql
-- 执行 填充缺失的chain_id.sql
```

**脚本会自动**：
1. 查找所有 `chain_id = NULL` 的运单
2. 使用运单所属项目的默认链路（最早创建的）
3. 更新 `chain_id` 字段
4. 显示更新统计和详情

**预期输出**：
```
========================================
chain_id 填充完成
========================================

更新统计：
  ✓ 更新运单数：XXX 条
  ✓ 涉及项目：XX 个

项目名称    | 更新数量 | 使用的链路
-----------|---------|----------
可口可乐    | 150     | 成丰6
中粮项目    | 80      | 链路1
...
```

### 第三步：验证结果

```sql
-- 执行 验证chain_id填充结果.sql
```

**检查**：
- chain_id 填充比例
- 是否还有 NULL 的情况
- 填充的 chain_id 是否正确

## ⚠️ 注意事项

### 1. 默认链路规则

脚本使用**最早创建的链路**作为默认链路：

```sql
SELECT DISTINCT ON (project_id)
    project_id,
    id as chain_id
FROM partner_chains
ORDER BY project_id, created_at ASC  -- ⭐ 最早创建的
```

**如果项目有多条链路**：
- 脚本会选择最早创建的那条
- 这可能不是业务上的"主链路"

### 2. 特殊情况

**项目没有链路**：
- 这些运单的 chain_id 仍为 NULL
- 需要先在项目管理中创建链路

**项目ID为空**：
- 这些运单无法填充
- 需要先修复项目关联

### 3. 事务安全

脚本使用 `BEGIN...COMMIT`：
- 如果出错，会自动回滚
- 不会造成部分更新

## 🔧 填充后的操作

### 立即重算成本

填充 chain_id 后，建议重新计算这些运单的成本：

```sql
-- 方法1：批量重算整个项目
SELECT public.recalculate_costs_for_project('项目ID');

-- 方法2：使用前端批量重算功能
-- 在运费对账页面：
--   1. 筛选：项目 = 可口可乐
--   2. 全选 → 批量重新计算
```

### 验证自动重算

填充完成后，测试自动重算功能：

```
1. 项目管理 → 选择一个项目
2. 修改链路的合作方
3. 保存
4. 查看运费对账
   → 应该自动更新为新合作方 ✅
```

## 📈 示例场景

### 场景：可口可乐项目

**现状**：
- 150条运单的 chain_id 为 NULL
- 项目有3条链路：成丰6、成丰5.7、线下

**执行填充后**：
```
所有150条运单的 chain_id = "成丰6的ID"
（因为成丰6是最早创建的链路）
```

**如果业务上应该用其他链路**：
- 可以在运单维护页面手动修改
- 或者执行自定义SQL批量更新

```sql
-- 示例：将特定时间段的运单改为其他链路
UPDATE logistics_records
SET chain_id = '线下链路的UUID'
WHERE project_name = '可口可乐'
  AND loading_date BETWEEN '2024-01-01' AND '2024-06-30'
  AND chain_id = '成丰6的UUID';
```

## ✅ 执行清单

- [ ] 执行 `检查chain_id缺失情况.sql` - 了解现状
- [ ] 备份数据（可选但推荐）
- [ ] 执行 `填充缺失的chain_id.sql` - 填充数据
- [ ] 执行 `验证chain_id填充结果.sql` - 验证结果
- [ ] 批量重算成本 - 更新运费对账
- [ ] 测试自动重算功能 - 验证触发器

## 🎉 完成后的效果

- ✅ 所有运单都有正确的 chain_id
- ✅ 修改项目配置后，自动更新所有运单
- ✅ 运费对账数据准确
- ✅ 合作方成本正确关联

---

**创建时间**: 2025-01-22  
**相关脚本**: 3个SQL文件  
**预计耗时**: 5-10分钟

